<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Shifter Pro v19 - Import/Export/Localidades</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { background:#f3f4f6; color:#111827; font-family:system-ui,-apple-system,sans-serif; -webkit-tap-highlight-color:transparent; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#e5e7eb; border:1px solid #e5e7eb; }
    .day-cell { background:#fff; height:130px; position:relative; cursor:pointer; display:flex; flex-direction:column; overflow:hidden; transition:transform .15s; }
    .day-cell:active{ transform:scale(.98); }
    .day-number{ font-size:11px; font-weight:900; padding:2px 6px; position:absolute; top:0; right:0; z-index:20; color:#374151; background:rgba(255,255,255,.9); border-bottom-left-radius:8px; }
    .day-off-month{ background:#f9fafb!important; opacity:.5; }
    .today{ border:2px solid #3b82f6!important; }
    .weekend{ background:#f8fafc!important; }

    /* Turn colors */
    .bg-MaÃ±ana{ background:#ffff00!important; }
    .bg-Tarde{ background:#fbcfe8!important; }
    .bg-CENA{ background:#d8b4fe!important; }
    .bg-16hrs{ background:#bef264!important; }
    .bg-L{ background:#ffffff!important; }
    .bg-Vacaciones{ background:#fed7aa!important; }

    .bg-azul{ background:#93c5fd!important; }
    .bg-rojo{ background:#fca5a5!important; }
    .bg-verde{ background:#86efac!important; }
    .bg-naranja{ background:#fdba74!important; }
    .bg-rosa{ background:#f9a8d4!important; }
    .bg-cian{ background:#67e8f9!important; }
    .bg-morado{ background:#d8b4fe!important; }
    .bg-lima{ background:#d9f99d!important; }
    .bg-ambar{ background:#fcd34d!important; }
    .bg-teal{ background:#5eead4!important; }
    .bg-indigo{ background:#a5b4fc!important; }
    .bg-gris{ background:#d1d5db!important; }

    .shift-label{ flex:1; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; text-transform:uppercase; text-align:center; line-height:1.1; padding:4px; color:rgba(0,0,0,.8); }
    .note-text{ font-size:10px; position:absolute; bottom:4px; left:50%; transform:translateX(-50%); width:90%; text-align:center; color:#000; font-weight:900; background:rgba(255,255,255,.65); border-radius:6px; padding:1px 4px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .view-section{ display:none; }
    .view-active{ display:block; }

    .tab-btn{ flex:1; text-align:center; padding:14px; font-weight:900; font-size:11px; border-bottom:3px solid transparent; transition:.2s; }
    .tab-active{ border-bottom-color:#2563eb; color:#2563eb; background:#f8fafc; }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:100; padding:15px; backdrop-filter:blur(4px); }
    .modal.active{ display:flex; }

    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea{
      background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:10px; font-weight:800; font-size:13px; outline:none; transition:.15s;
    }
    select:focus, input:focus, textarea:focus{
      border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.12);
    }

    .shift-option{ transition:.15s; border-width:2px; border-color:transparent; padding:12px 8px; border-radius:12px; font-size:10px; font-weight:900; text-transform:uppercase; cursor:pointer; }
    .shift-option.selected{ border-color:#2563eb!important; box-shadow:0 6px 14px rgba(37,99,235,.22); transform:translateY(-1px); }
    .shift-option:not(.selected){ opacity:.75; }
    .shift-option:hover:not(.selected){ opacity:.95; transform:translateY(-1px); }

    .color-option{ width:30px; height:30px; border-radius:8px; cursor:pointer; border:2px solid transparent; transition:.15s; }
    .color-option.selected{ border-color:#000; transform:scale(1.08); box-shadow:0 6px 10px rgba(0,0,0,.18); }

    .config-tab{ flex:1; text-align:center; padding:12px; font-weight:900; font-size:10px; border-bottom:3px solid transparent; transition:.2s; color:#9ca3af; }
    .config-tab.active{ border-bottom-color:#2563eb; color:#2563eb; background:#f8fafc; }

    .holiday-indicator{
      position:absolute; top:0; left:0; font-size:8px; font-weight:900; color:#dc2626;
      background:rgba(254,226,226,.9); padding:1px 4px; border-bottom-right-radius:8px; z-index:20;
    }

    /* Fix dropdown "blank" issue */
    #userSelect{
      background:rgba(255,255,255,.12)!important;
      color:#fff!important;
      border:1px solid rgba(255,255,255,.15)!important;
      padding:6px 10px!important;
      border-radius:12px!important;
      max-width:240px;
    }
    #userSelect option{ color:#111827; background:#fff; font-weight:800; }
  </style>
</head>

<body>

<!-- Top bar -->
<div class="bg-[#1e293b] text-white p-4 sticky top-0 z-50 shadow-lg">
  <div class="flex justify-between items-center mb-4">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-black text-sm">
        <span id="userInitial">A</span>
      </div>
      <div>
        <div class="flex items-center gap-2">
          <select id="userSelect" onchange="switchUser()"></select>
          <button onclick="openProfilesModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">ğŸ‘¤ Perfiles</button>
        </div>
        <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400">Modo Vista</p>
      </div>
    </div>
    <div class="flex gap-2">
      <button onclick="openImportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">ğŸ“¥ Importar</button>
      <button onclick="showExportModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">ğŸ“‹ Exportar</button>
      <button id="unlockBtn" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">ğŸ”’ Bloquear</button>
    </div>
  </div>

  <!-- Month/year -->
  <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-2xl p-2 shadow-inner">
    <button onclick="changeMonth(-1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
      <span class="text-xl font-bold">â€¹</span>
    </button>

    <div class="flex flex-col items-center">
      <div id="currentMonthDisplay" class="text-xl font-black text-white text-center mb-1">Febrero 2026</div>
      <div class="flex gap-3 items-center opacity-90">
        <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer"></select>
        <span class="text-white font-bold">/</span>
        <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer"></select>
      </div>
      <div class="flex gap-2 mt-2">
        <button onclick="goToday()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-[10px] font-black uppercase transition-colors">Hoy</button>
      </div>
    </div>

    <button onclick="changeMonth(1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
      <span class="text-xl font-bold">â€º</span>
    </button>
  </div>
</div>

<!-- Tabs -->
<div class="flex bg-white shadow-sm sticky top-[160px] z-40 border-b">
  <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">ğŸ“… Calendario</button>
  <button onclick="showView('summary')" id="tab-summary" class="tab-btn">ğŸ“Š Resumen</button>
  <button onclick="showView('settings')" id="tab-settings" class="tab-btn">âš™ï¸ Ajustes</button>
</div>

<!-- Calendar -->
<div id="view-calendar" class="view-section view-active">
  <div class="grid grid-cols-7 text-center text-[11px] font-black py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b">
    <div class="text-blue-600 font-black">LUN</div><div>MAR</div><div>MIÃ‰</div><div>JUE</div><div>VIE</div>
    <div class="text-blue-600 font-black">SÃB</div><div class="text-red-600 font-black">DOM</div>
  </div>
  <div id="calendar" class="calendar-grid"></div>
</div>

<!-- Summary -->
<div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen">
  <div class="space-y-4 md:space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
      <div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border-l-[10px] border-yellow-400">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-400 uppercase">Hospital</p>
          <span class="text-[10px] font-black bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Horas</span>
        </div>
        <h2 id="hrs-hosp" class="text-3xl md:text-4xl font-black text-gray-900 tracking-tighter">0.0 HRS</h2>
        <div class="mt-2 text-[10px] text-gray-500 font-bold" id="hosp-days">0 dÃ­as</div>
      </div>

      <div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border-l-[10px] border-purple-400">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-400 uppercase">CENA</p>
          <span class="text-[10px] font-black bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Independiente</span>
        </div>
        <h2 id="hrs-sena" class="text-3xl md:text-4xl font-black text-gray-900 tracking-tighter">0.0 HRS</h2>
        <div class="mt-2 text-[10px] text-gray-500 font-bold" id="sena-days">0 dÃ­as</div>
      </div>
    </div>

    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 rounded-3xl text-white text-center shadow-xl">
      <p class="text-xs font-black uppercase opacity-90 mb-2">DÃ­as de Descanso</p>
      <h2 id="total-off" class="text-5xl font-black mb-3">0</h2>
      <div class="grid grid-cols-4 gap-2 text-[10px] font-black">
        <div class="bg-white/20 p-2 rounded-xl"><div>Libres</div><div id="free-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Vacaciones</div><div id="vac-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Fines</div><div id="weekend-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Asuetos Trab.</div><div id="holiday-worked" class="text-lg font-black">0</div></div>
      </div>
      <p class="text-[10px] mt-3 font-bold opacity-90">
        * Asueto laborado solo cuenta si aplica a la localidad del perfil (o si el asueto es General).
      </p>
    </div>

    <div class="bg-white p-4 rounded-3xl shadow-sm">
      <h3 class="text-[12px] font-black text-gray-600 uppercase mb-3">ğŸ“ˆ Resumen del Mes</h3>
      <div class="space-y-2">
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Localidad perfil:</span><span id="profile-loc" class="font-black text-gray-900">San Salvador</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">DÃ­as trabajados:</span><span id="worked-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Promedio diario:</span><span id="avg-hours" class="font-black text-gray-900">0.0h</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Total dÃ­as mes:</span><span id="total-days" class="font-black text-gray-900">30</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Asuetos en mes (aplican):</span><span id="total-holidays" class="font-black text-red-600">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Settings -->
<div id="view-settings" class="view-section bg-white min-h-screen">
  <div class="flex bg-gray-50 border-b">
    <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active">ğŸ¨ Turnos</button>
    <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab">â• Nuevo</button>
    <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab">ğŸ·ï¸ CategorÃ­as</button>
    <button onclick="showConfigTab('localidades')" id="config-localidades" class="config-tab">ğŸ“ Localidades</button>
    <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab">ğŸ‰ Asuetos</button>
    <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab">ğŸ”’ Seguridad</button>
  </div>

  <div id="config-content" class="p-4 md:p-6">
    <!-- Turnos -->
    <div id="tab-turnos" class="config-tab-content">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ¨ Configurar Turnos</h3>
        <button onclick="saveShiftSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-blue-50 border border-blue-100 rounded-2xl p-3 text-[11px] font-bold text-blue-900 mb-4">
        Al guardar: actualiza turnos y puede propagar horas/comentarios en el calendario del perfil.
        <div class="mt-2 flex items-center gap-2">
          <input type="checkbox" id="propagateShiftEdits" checked>
          <label for="propagateShiftEdits" class="font-black text-[10px] uppercase text-blue-900">Propagar a calendario (este perfil)</label>
        </div>
      </div>

      <div id="settings-container" class="space-y-3"></div>
    </div>

    <!-- Nuevo turno -->
    <div id="tab-nuevo" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">â• Agregar Nuevo Turno</h3>
      <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-100 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Turno</label>
            <input type="text" id="newShiftName" placeholder="Ej: Noche" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">CategorÃ­a</label>
            <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
          </div>
        </div>

        <div class="mb-4">
          <label class="text-[11px] font-bold text-gray-600 block mb-2">Color</label>
          <div class="grid grid-cols-6 gap-2 p-3 bg-white rounded-xl">
            <div class="color-option bg-MaÃ±ana" onclick="selectColor('MaÃ±ana', event)"></div>
            <div class="color-option bg-Tarde" onclick="selectColor('Tarde', event)"></div>
            <div class="color-option bg-CENA" onclick="selectColor('CENA', event)"></div>
            <div class="color-option bg-16hrs" onclick="selectColor('16hrs', event)"></div>
            <div class="color-option bg-Vacaciones" onclick="selectColor('Vacaciones', event)"></div>
            <div class="color-option bg-L" onclick="selectColor('L', event)"></div>
            <div class="color-option bg-azul" onclick="selectColor('azul', event)"></div>
            <div class="color-option bg-rojo" onclick="selectColor('rojo', event)"></div>
            <div class="color-option bg-verde" onclick="selectColor('verde', event)"></div>
            <div class="color-option bg-naranja" onclick="selectColor('naranja', event)"></div>
            <div class="color-option bg-rosa" onclick="selectColor('rosa', event)"></div>
            <div class="color-option bg-cian" onclick="selectColor('cian', event)"></div>
            <div class="color-option bg-morado" onclick="selectColor('morado', event)"></div>
            <div class="color-option bg-lima" onclick="selectColor('lima', event)"></div>
            <div class="color-option bg-ambar" onclick="selectColor('ambar', event)"></div>
            <div class="color-option bg-teal" onclick="selectColor('teal', event)"></div>
            <div class="color-option bg-indigo" onclick="selectColor('indigo', event)"></div>
            <div class="color-option bg-gris" onclick="selectColor('gris', event)"></div>
          </div>
          <input type="hidden" id="newShiftColor" value="MaÃ±ana">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Entrada</label>
            <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Salida</label>
            <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
        </div>

        <button onclick="addNewShift()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600">
          â• Agregar Turno
        </button>
      </div>
    </div>

    <!-- CategorÃ­as -->
    <div id="tab-categorias" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ·ï¸ CategorÃ­as</h3>
        <button onclick="saveCategories()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-3xl border border-green-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva CategorÃ­a</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newCategoryName" placeholder="Ej: Guardia" class="w-full bg-white border-green-200 focus:border-green-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Icono</label>
            <select id="newCategoryIcon" class="w-full bg-white border-green-200 focus:border-green-400">
              <option value="ğŸ¥">ğŸ¥</option><option value="ğŸŒ™">ğŸŒ™</option><option value="ğŸ˜´">ğŸ˜´</option><option value="ğŸ“‹">ğŸ“‹</option>
              <option value="ğŸ›¡ï¸">ğŸ›¡ï¸</option><option value="â­">â­</option><option value="ğŸ”§">ğŸ”§</option><option value="ğŸš‘">ğŸš‘</option>
              <option value="ğŸ’Š">ğŸ’Š</option><option value="ğŸ©º">ğŸ©º</option><option value="ğŸ¨">ğŸ¨</option><option value="ğŸ“Œ">ğŸ“Œ</option>
            </select>
          </div>
        </div>
        <button onclick="addNewCategory()" class="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600">
          â• Agregar CategorÃ­a
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">CategorÃ­as Existentes (editables)</h4>
        <div id="categories-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Localidades -->
    <div id="tab-localidades" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ“ Localidades</h3>
        <button onclick="saveLocalities()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-sky-50 to-blue-50 p-4 rounded-3xl border border-sky-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Localidad</h4>
        <div class="flex gap-3">
          <input type="text" id="newLocalityName" placeholder="Ej: Santa Ana" class="flex-1 bg-white border-sky-200 focus:border-sky-400">
          <button onclick="addLocality()" class="px-5 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">â• Agregar</button>
        </div>
        <p class="text-[10px] mt-2 font-bold text-gray-500">* â€œGeneralâ€ se reserva para asuetos vÃ¡lidos para todos.</p>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Lista de Localidades (editables)</h4>
        <div id="localities-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Asuetos -->
    <div id="tab-asuetos" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ‰ Asuetos</h3>
        <button onclick="saveHolidays()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-3xl border border-pink-100 mb-6">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nuevo Asueto</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Fecha</label>
            <input type="date" id="newHolidayDate" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
          <div class="md:col-span-2">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newHolidayName" placeholder="Ej: DÃ­a de la Independencia" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="newHolidayLocation" class="w-full bg-white border-pink-200 focus:border-pink-400"></select>
          </div>
          <div class="bg-white rounded-2xl border border-pink-200 p-3 text-[10px] font-bold text-gray-600 flex items-center">
            Si quieres asueto para todos: selecciona <span class="mx-1 font-black text-red-600">General</span>.
          </div>
        </div>

        <button onclick="addNewHoliday()" class="w-full p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600">
          â• Agregar Asueto
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Asuetos (editables)</h4>
        <div id="holidays-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Seguridad -->
    <div id="tab-seguridad" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">ğŸ”’ Seguridad (PIN del perfil actual)</h3>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-3xl border border-blue-100">
        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Cambiar PIN (4 dÃ­gitos)</label>
            <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Confirmar PIN</label>
            <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>

          <button onclick="savePinOnly()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-3xl font-black uppercase shadow-xl hover:from-blue-700 hover:to-indigo-700">
            ğŸ’¾ Guardar PIN
          </button>
        </div>
      </div>
    </div>

  </div>

  <div id="settings-locked" class="p-8 text-center hidden">
    <div class="w-20 h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
      <span class="text-3xl">ğŸ”’</span>
    </div>
    <h3 class="text-lg font-black text-gray-600 mb-2">ConfiguraciÃ³n Bloqueada</h3>
    <p class="text-sm text-gray-500 mb-6">Activa el modo ediciÃ³n para acceder</p>
    <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-black">ğŸ”“ Activar EdiciÃ³n</button>
  </div>
</div>

<!-- Modal dÃ­a -->
<div id="modal" class="modal">
  <div class="bg-white w-full max-w-md rounded-[40px] overflow-hidden shadow-2xl border border-gray-100">
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-5 font-black text-sm uppercase tracking-widest">
      <div>ğŸ“… Configurar DÃ­a</div>
      <div id="modalDate" class="text-[10px] font-normal opacity-90 mt-1"></div>
    </div>
    <div class="p-6 overflow-y-auto max-h-[80vh]">
      <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-6">
        <button onclick="setMode('simple')" id="m-s" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Simple</button>
        <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Mixto</button>
      </div>

      <div id="sec-simple" class="grid grid-cols-3 gap-2 mb-6"></div>

      <div id="sec-mixto" class="hidden space-y-4 mb-6">
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Superior</p>
          <div id="mix-t" class="grid grid-cols-3 gap-2"></div>
        </div>
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Inferior</p>
          <div id="mix-b" class="grid grid-cols-3 gap-2"></div>
        </div>
      </div>

      <!-- Horario SIMPLE -->
      <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100 mb-6">
        <div class="flex items-center justify-between">
          <span class="text-[11px] font-black uppercase text-blue-900">â° Horario:</span>
          <div class="flex items-center gap-2">
            <input type="time" id="tIn" onchange="autoCalc(); maybeAutoNoteSimple();" class="bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">â†’</span>
            <input type="time" id="tOut" onchange="autoCalc(); maybeAutoNoteSimple();" class="bg-white border-blue-200 focus:border-blue-400">
          </div>
        </div>
        <div class="flex items-center justify-between border-t border-blue-200 pt-3">
          <span class="text-[11px] font-black uppercase text-blue-900">ğŸ“Š Total Horas:</span>
          <input type="number" id="tHrs" onchange="manualCalc()" class="w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
        </div>
      </div>

      <!-- Horario MIXTO -->
      <div id="time-mixto" class="hidden space-y-4 mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100">
          <p class="text-[11px] font-black uppercase text-blue-900 text-center">â° Horario Superior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">â†’</span>
            <input type="time" id="tOutTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div class="flex items-center justify-between border-t border-blue-200 pt-3">
            <span class="text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
            <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-5 rounded-[24px] space-y-4 border border-purple-100">
          <p class="text-[11px] font-black uppercase text-purple-900 text-center">â° Horario Inferior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-32 bg-white border-purple-200 focus:border-purple-400">
            <span class="font-black text-purple-300">â†’</span>
            <input type="time" id="tOutBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-32 bg-white border-purple-200 focus:border-purple-400">
          </div>
          <div class="flex items-center justify-between border-t border-purple-200 pt-3">
            <span class="text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
            <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200" step="0.5">
          </div>
        </div>
        <div class="flex items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-[20px] border border-emerald-100">
          <span class="text-[11px] font-black uppercase text-emerald-900">ğŸ“Š Total Horas:</span>
          <input type="number" id="tHrsMixto" class="w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200" step="0.5" readonly>
        </div>
      </div>

      <div class="mt-6">
        <p class="text-[10px] font-black text-gray-400 uppercase mb-2 ml-2">ğŸ“ Comentario (editable)</p>
        <textarea id="nota" placeholder="Ej: 06:00-14:00 | Doble turno | etc." class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        <p class="text-[10px] text-gray-500 mt-2 font-bold text-center">
          EstÃ¡ndar: el comentario debe incluir el horario del turno (editable).
        </p>
      </div>

      <div class="flex gap-4 mt-8">
        <button onclick="closeModal()" class="flex-1 p-5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-3xl font-black text-[11px] uppercase">âŒ Cancelar</button>
        <button onclick="saveDay()" class="flex-1 p-5 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-3xl font-black text-[11px] uppercase shadow-lg">âœ… Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Import -->
<div id="importModal" class="modal">
  <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 shadow-2xl">
    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">ğŸ“¥</span>
    </div>
    <h3 class="font-black text-center uppercase text-lg mb-2">Importar Excel</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Detecta usuarios y permite seleccionar cuÃ¡les importar.
    </p>

    <div class="space-y-4">
      <div>
        <label class="text-[12px] font-bold text-gray-600 block mb-2">Archivo Excel (.xlsx)</label>
        <input type="file" id="importFile" accept=".xlsx,.xls" class="w-full bg-gray-50 border-gray-200">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes (si no detecta)</label>
          <select id="importMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">AÃ±o (si no detecta)</label>
          <select id="importYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Modo</p>
        <div class="flex gap-3">
          <label class="flex-1 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="replace" checked> Reemplazar mes
          </label>
          <label class="flex-1 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="merge"> Combinar (solo dÃ­as vacÃ­os)
          </label>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Usuarios detectados</p>
          <div class="flex gap-2">
            <button onclick="selectAllImportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllImportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="importUsersList" class="max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700">
          <div class="text-gray-400 font-bold">Adjunta un Excel y presiona â€œAnalizarâ€.</div>
        </div>

        <div class="mt-3 flex gap-2">
          <button onclick="analyzeImportFile()" class="flex-1 p-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">
            ğŸ” Analizar
          </button>
          <button onclick="runImportSelected()" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black uppercase text-[11px]">
            ğŸš€ Importar Seleccionados
          </button>
        </div>

        <div id="importInfo" class="mt-3 text-[11px] font-bold text-center text-gray-600"></div>
      </div>

      <button onclick="closeImportModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Export -->
<div id="exportModal" class="modal">
  <div class="bg-white w-full max-w-xl rounded-[40px] p-8 shadow-2xl">
    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 mx-auto mb-4 flex items-center justify-content-center">
      <span class="text-white text-2xl font-black">ğŸ“‹</span>
    </div>
    <h3 class="font-black text-center uppercase text-lg mb-2">Exportar</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Puedes exportar uno, varios o todos. Si es â€œtodosâ€, se genera 1 imagen por perfil.
    </p>

    <div class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes</label>
          <select id="exportMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">AÃ±o</label>
          <select id="exportYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">QuÃ© exportar</p>
        <div class="space-y-2 text-[11px] font-bold text-gray-700">
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="current" checked> Perfil actual</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="select"> Seleccionar perfiles</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="all"> Todos los perfiles</label>
        </div>
      </div>

      <div id="exportUsersBox" class="bg-white border border-gray-200 rounded-2xl p-4 hidden">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Seleccionar perfiles</p>
          <div class="flex gap-2">
            <button onclick="selectAllExportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllExportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="exportUsersList" class="max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700"></div>
      </div>

      <button onclick="exportImages()" class="w-full p-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-3xl font-black uppercase shadow-xl hover:from-emerald-700 hover:to-teal-700">
        ğŸ–¼ï¸ Exportar imÃ¡genes
      </button>

      <button onclick="closeExportModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Profiles -->
<div id="profilesModal" class="modal">
  <div class="bg-white w-full max-w-3xl rounded-[40px] p-8 shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="font-black uppercase text-lg">ğŸ‘¤ GestiÃ³n de Perfiles</h3>
        <p class="text-[11px] text-gray-500 font-bold">Crear, editar, asignar localidad o eliminar perfiles.</p>
      </div>
      <button onclick="closeProfilesModal()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Cerrar</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-3xl p-4">
        <h4 class="text-[12px] font-black text-gray-700 uppercase mb-3">â• Crear perfil</h4>
        <div class="space-y-3">
          <input id="createName" type="text" placeholder="Nombre completo" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <input id="createPin" type="password" placeholder="PIN (4 dÃ­gitos)" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="createLoc" class="w-full bg-white border-blue-200 focus:border-blue-400"></select>
          </div>
          <button onclick="createProfile()" class="w-full p-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-[11px]">
            Crear
          </button>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-3xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-[12px] font-black text-gray-700 uppercase">Perfiles existentes</h4>
          <button onclick="renderProfilesList()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Actualizar</button>
        </div>
        <div id="profilesList" class="max-h-[360px] overflow-y-auto space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   DB v19
========================================================= */
let db = JSON.parse(localStorage.getItem('shifter_v19')) || {
  version: 19,
  current: 'ADMIN',
  localities: ['General','San Salvador'], // default
  holidays: {}, // key: "YYYY-M-D" -> {name, location}
  categories: {
    hosp: { name:'Hospital', icon:'ğŸ¥' },
    sena: { name:'CENA', icon:'ğŸŒ™' },
    off:  { name:'Libre/Vacaciones', icon:'ğŸ˜´' },
    admin:{ name:'Administrativo', icon:'ğŸ“‹' },
    guardia:{ name:'Guardia', icon:'ğŸ›¡ï¸' },
    extra:{ name:'Extra', icon:'â­' },
    otro:{ name:'Otro', icon:'ğŸ”§' }
  },
  users: {
    ADMIN: {
      pin:'1234',
      editLocked:false,
      locality:'San Salvador',
      data:{},
      config:{
        'MaÃ±ana': { label:'MaÃ±ana', color:'MaÃ±ana', cat:'hosp', in:'06:00', out:'14:00' },
        'Tarde': { label:'Tarde', color:'Tarde', cat:'hosp', in:'14:00', out:'22:00' },
        '16hrs': { label:'16hrs', color:'16hrs', cat:'hosp', in:'06:00', out:'22:00' },
        'CENA': { label:'CENA', color:'CENA', cat:'sena', in:'05:00', out:'17:00' },
        'L': { label:'L', color:'L', cat:'off', in:'00:00', out:'00:00' },
        'Vacaciones': { label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00' }
      }
    }
  }
};

/* =========================================================
   Import maps
========================================================= */
const IMPORT_ABSENCE_MAP = {
  'C':  { key:'CAPACITACION', label:'CapacitaciÃ³n', color:'azul', cat:'admin', in:'00:00', out:'00:00', note:'CAPACITACIÃ“N' },
  'I':  { key:'INCAPACIDAD', label:'Incapacidad', color:'rojo', cat:'off', in:'00:00', out:'00:00', note:'INCAPACIDAD' },
  'V':  { key:'Vacaciones', label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', note:'VACACIONES' },
  'L':  { key:'L', label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', note:'LIBRE' },
  'PS': { key:'PERMISO_SINDICAL', label:'Permiso Sindical', color:'morado', cat:'admin', in:'00:00', out:'00:00', note:'PERMISO SINDICAL' },
  'F':  { key:'AUS_INJUST', label:'Aus. Injust.', color:'gris', cat:'off', in:'00:00', out:'00:00', note:'AUSENCIA INJUSTIFICADA' }
};

const IMPORT_SHIFT_CODE_MAP = {
  '018': { key:'018', label:'018', color:'MaÃ±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '18':  { key:'018', label:'018', color:'MaÃ±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '468': { key:'468', label:'468', color:'Tarde',  cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '650': { key:'650', label:'650', color:'16hrs',  cat:'hosp', in:'06:00', out:'22:00', note:'06:00-22:00' }
};

/* =========================================================
   Globals
========================================================= */
let current = new Date();
let activeKey = "";
let mode = "simple";
let selS = "MaÃ±ana";
let selT = "MaÃ±ana";
let selB = "Tarde";
let selectedColor = "MaÃ±ana";

let importContext = null; // will store parsed workbook rows + detected users, etc.

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

/* =========================================================
   Helpers
========================================================= */
function saveDB(){ localStorage.setItem('shifter_v19', JSON.stringify(db)); }

function isEditMode(){ return !db.users[db.current].editLocked; }

function calculateHours(start, end){
  if(!start || !end || (start==='00:00' && end==='00:00')) return 0;
  let [h1,m1]=start.split(':').map(Number);
  let [h2,m2]=end.split(':').map(Number);
  let diff = (h2 + m2/60) - (h1 + m1/60);
  if(diff < 0) diff += 24;
  return parseFloat(diff.toFixed(1));
}

function defaultNoteForShift(shiftKey){
  const user = db.users[db.current];
  const sh = user.config[shiftKey];
  if (!sh) return (shiftKey||'').toUpperCase();
  if (sh.in && sh.out && !(sh.in==='00:00' && sh.out==='00:00')) return `${sh.in}-${sh.out}`;
  return (sh.label || shiftKey || '').toUpperCase();
}

function normalizeCode(v){
  if(v===null||v===undefined) return '';
  let s = String(v).trim();
  if(!s) return '';
  s = s.replace(/\s+/g,' ').toUpperCase();
  if (s === 'LS') s='L';
  if (s === 'P S' || s === 'P/S') s='PS';
  return s;
}

function codeToShiftDef(codeNorm){
  if(!codeNorm || codeNorm==='X') return null;
  if(IMPORT_ABSENCE_MAP[codeNorm]) return {...IMPORT_ABSENCE_MAP[codeNorm]};
  if(IMPORT_SHIFT_CODE_MAP[codeNorm]) return {...IMPORT_SHIFT_CODE_MAP[codeNorm]};

  if(/^\d+$/.test(codeNorm)){
    return { key: codeNorm, label: codeNorm, color:'gris', cat:'hosp', in:'00:00', out:'00:00', note: codeNorm };
  }
  return null;
}

function ensureShiftExistsForUser(userKey, shiftDef){
  const user = db.users[userKey];
  if(!user) return;
  if(!user.config[shiftDef.key]){
    user.config[shiftDef.key] = { label: shiftDef.label, color: shiftDef.color||'gris', cat: shiftDef.cat||'hosp', in: shiftDef.in||'00:00', out: shiftDef.out||'00:00' };
  }
}

function ensureImportBaseShiftsForUser(userKey){
  Object.keys(IMPORT_ABSENCE_MAP).forEach(k => ensureShiftExistsForUser(userKey, IMPORT_ABSENCE_MAP[k]));
  Object.keys(IMPORT_SHIFT_CODE_MAP).forEach(k => ensureShiftExistsForUser(userKey, IMPORT_SHIFT_CODE_MAP[k]));
}

function ensureUserExists(nameUpper){
  const name = String(nameUpper||'').trim().toUpperCase();
  if(!name) return null;
  if(!db.users[name]){
    db.users[name] = JSON.parse(JSON.stringify(db.users['ADMIN']));
    db.users[name].pin = '0000';
    db.users[name].editLocked = false;
    db.users[name].data = {};
    db.users[name].locality = 'San Salvador';
    ensureImportBaseShiftsForUser(name);
  }
  return name;
}

function dayKey(y,m1,d){ return `${y}-${m1}-${d}`; } // m1 is 1-based

function getColorValue(colorName){
  const map = {
    'MaÃ±ana':'#ffff00','Tarde':'#fbcfe8','CENA':'#d8b4fe','16hrs':'#bef264','L':'#ffffff','Vacaciones':'#fed7aa',
    'azul':'#93c5fd','rojo':'#fca5a5','verde':'#86efac','naranja':'#fdba74','rosa':'#f9a8d4','cian':'#67e8f9',
    'morado':'#d8b4fe','lima':'#d9f99d','ambar':'#fcd34d','teal':'#5eead4','indigo':'#a5b4fc','gris':'#d1d5db'
  };
  return map[colorName] || '#ffffff';
}

/* =========================================================
   Holidays applicability by locality
========================================================= */
function holidayApplies(holidayLocation, userLocation){
  const hl = (holidayLocation||'General').trim().toUpperCase();
  const ul = (userLocation||'San Salvador').trim().toUpperCase();
  if(hl === 'GENERAL') return true;
  return hl === ul;
}

function countApplicableHolidaysInMonth(year, monthIndex0, userLocation){
  // returns count of holidays that apply to this locality in that month
  const m1 = monthIndex0+1;
  let c=0;
  Object.keys(db.holidays).forEach(k=>{
    const [y,mm,dd]=k.split('-').map(Number);
    if(y===year && mm===m1){
      const h = db.holidays[k];
      if(holidayApplies(h.location, userLocation)) c++;
    }
  });
  return c;
}

/* =========================================================
   UI Init
========================================================= */
function init(){
  initSelectors();
  loadDefaultHolidays();
  ensureImportBaseShiftsForUser('ADMIN');
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  render();
  updateUIEditMode();
}

function initSelectors(){
  const mSel = document.getElementById('selectMonth');
  const ySel = document.getElementById('selectYear');
  const iMonth = document.getElementById('importMonth');
  const iYear = document.getElementById('importYear');
  const eMonth = document.getElementById('exportMonth');
  const eYear = document.getElementById('exportYear');

  [mSel,iMonth,eMonth].forEach(sel=>{
    sel.innerHTML='';
    MONTHS.forEach((m,i)=> sel.innerHTML += `<option value="${i}">${m}</option>`);
  });

  [ySel,iYear,eYear].forEach(sel=>{
    sel.innerHTML='';
    for(let y=2023;y<=2027;y++){
      sel.innerHTML += `<option value="${y}" ${y===2026?'selected':''}>${y}</option>`;
    }
  });
}

/* default holiday examples */
function loadDefaultHolidays(){
  const defaults = {
    '2026-1-1': { name:'AÃ±o Nuevo', location:'General' },
    '2026-4-2': { name:'Jueves Santo', location:'General' },
    '2026-4-3': { name:'Viernes Santo', location:'General' },
    '2026-5-1': { name:'DÃ­a del Trabajo', location:'General' },
    '2026-8-6': { name:'Fiestas Agostinas', location:'San Salvador' },
    '2026-9-15': { name:'Independencia', location:'General' },
    '2026-11-2': { name:'DÃ­a de los Difuntos', location:'General' },
    '2026-12-25': { name:'Navidad', location:'General' }
  };
  Object.keys(defaults).forEach(k=>{
    if(!db.holidays[k]) db.holidays[k]=defaults[k];
  });

  // ensure localities contain "General" and "San Salvador"
  if(!db.localities || !Array.isArray(db.localities)) db.localities=['General','San Salvador'];
  if(!db.localities.some(x=>x.toUpperCase()==='GENERAL')) db.localities.unshift('General');
  if(!db.localities.some(x=>x.toUpperCase()==='SAN SALVADOR')) db.localities.push('San Salvador');
  // normalize unique
  db.localities = Array.from(new Set(db.localities.map(x=>String(x).trim()).filter(Boolean)));
  saveDB();
}

/* =========================================================
   Month display + navigation
========================================================= */
function updateMonthDisplay(){
  const y=current.getFullYear();
  const m=current.getMonth();
  document.getElementById('currentMonthDisplay').textContent = `${MONTHS[m]} ${y}`;
  document.getElementById('selectMonth').value = m;
  document.getElementById('selectYear').value = y;
}
function changeMonth(v){ current.setMonth(current.getMonth()+v); updateMonthDisplay(); render(); }
function jumpToDate(){
  current.setMonth(parseInt(document.getElementById('selectMonth').value));
  current.setFullYear(parseInt(document.getElementById('selectYear').value));
  updateMonthDisplay(); render();
}
function goToday(){ current = new Date(); updateMonthDisplay(); render(); }

/* =========================================================
   View switching
========================================================= */
function showView(v){
  document.querySelectorAll('.view-section').forEach(s=>s.classList.remove('view-active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('tab-active'));
  document.getElementById('view-'+v).classList.add('view-active');
  document.getElementById('tab-'+v).classList.add('tab-active');

  if(v==='settings'){
    updateUIEditMode();
    if(isEditMode()) showConfigTab('turnos');
  }
}

function showConfigTab(tab){
  document.querySelectorAll('.config-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(`config-${tab}`).classList.add('active');

  document.querySelectorAll('.config-tab-content').forEach(c=>c.classList.add('hidden'));
  document.getElementById(`tab-${tab}`).classList.remove('hidden');

  if(tab==='turnos'){ renderSettings(); }
  if(tab==='nuevo'){ loadCategoriesSelect(); }
  if(tab==='categorias'){ renderCategories(); }
  if(tab==='localidades'){ renderLocalities(); }
  if(tab==='asuetos'){ refreshHolidayLocationSelects(); renderHolidays(); }
  if(tab==='seguridad'){ /* nothing */ }
}

/* =========================================================
   Edit mode
========================================================= */
function updateUIEditMode(){
  const configContent = document.getElementById('config-content');
  const lockedMessage = document.getElementById('settings-locked');

  if(isEditMode()){
    configContent.classList.remove('hidden');
    lockedMessage.classList.add('hidden');
    document.getElementById('editStatus').innerText = "MODO EDICIÃ“N ACTIVADO";
    document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-emerald-400";
    document.getElementById('unlockBtn').innerText = "ğŸ”’ Bloquear";
    document.getElementById('unlockBtn').className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  } else {
    configContent.classList.add('hidden');
    lockedMessage.classList.remove('hidden');
    document.getElementById('editStatus').innerText = "MODO VISTA";
    document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-gray-400";
    document.getElementById('unlockBtn').innerText = "ğŸ”“ Editar";
    document.getElementById('unlockBtn').className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  }
}

function toggleEditMode(){
  const user = db.users[db.current];
  if(isEditMode()){
    const p = prompt("Ingresa tu PIN para bloquear la ediciÃ³n:");
    if(p === user.pin){ user.editLocked=true; saveDB(); alert("EdiciÃ³n bloqueada"); }
    else return alert("PIN incorrecto");
  } else {
    const p = prompt("Ingresa tu PIN para editar:");
    const adminUniversalPin='120720';
    if(p === user.pin || p === adminUniversalPin){ user.editLocked=false; saveDB(); alert("EdiciÃ³n activada"); }
    else return alert("PIN incorrecto");
  }
  updateUIEditMode();
}

/* =========================================================
   Users dropdown + initial
========================================================= */
function updateUserDropdown(){
  const select = document.getElementById('userSelect');
  select.innerHTML = Object.keys(db.users).sort().map(u => `<option value="${u}" ${u===db.current?'selected':''}>${u}</option>`).join('');
}
function updateUserInitial(){ document.getElementById('userInitial').textContent = db.current.charAt(0); }
function switchUser(){
  db.current = document.getElementById('userSelect').value;
  updateUserInitial();
  render();
  updateUIEditMode();
}

/* =========================================================
   Calendar render
========================================================= */
function render(){
  const grid=document.getElementById('calendar');
  grid.innerHTML='';

  const y=current.getFullYear();
  const m=current.getMonth(); // 0-based
  const user=db.users[db.current];
  const SHIFTS=user.config;
  const today = new Date();
  const todayKey = dayKey(today.getFullYear(), today.getMonth()+1, today.getDate());

  const firstDay = new Date(y,m,1).getDay();
  const firstDayMonday = firstDay===0?6:firstDay-1;
  const lastDate = new Date(y,m+1,0).getDate();
  const prevLastDate = new Date(y,m,0).getDate();

  // prev filler
  for(let i=firstDayMonday;i>0;i--){
    const prevDay=prevLastDate-i+1;
    const prevMonth = m===0?12:m;
    const prevYear = m===0?y-1:y;
    const key = dayKey(prevYear, prevMonth, prevDay);
    const info=user.data[key];

    const cell=document.createElement('div');
    cell.className='day-cell day-off-month';
    if(info){
      if(info.mode==='mixto'){
        cell.innerHTML = `
          <div class="shift-label bg-${SHIFTS[info.t]?.color||'L'}">${SHIFTS[info.t]?.label||'L'}</div>
          <div class="shift-label bg-${SHIFTS[info.b]?.color||'L'}">${SHIFTS[info.b]?.label||'L'}</div>`;
      } else {
        const label = info.s==='L'?'L':(SHIFTS[info.s]?.label||info.s||'L');
        cell.innerHTML = `<div class="shift-label bg-${SHIFTS[info.s]?.color||'L'}">${label}</div>`;
      }
    }
    if(db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality)) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
    cell.innerHTML += `<span class="day-number">${prevDay}</span>`;
    if(info && info.n) cell.innerHTML += `<div class="note-text">${info.n}</div>`;
    cell.onclick=()=>openDay(key, info || {mode:'simple', s:'L'});
    grid.appendChild(cell);
  }

  // month days
  for(let d=1; d<=lastDate; d++){
    const key=dayKey(y,m+1,d);
    const info=user.data[key] || {mode:'simple', s:'L'};
    const cell=document.createElement('div');

    let classes='day-cell';
    const dow=new Date(y,m,d).getDay();
    if(dow===0 || dow===6) classes+=' weekend';
    if(key===todayKey) classes+=' today';
    cell.className=classes;

    if(info.mode==='mixto'){
      cell.innerHTML=`
        <div class="shift-label bg-${SHIFTS[info.t]?.color||'L'}">${SHIFTS[info.t]?.label||'L'}</div>
        <div class="shift-label bg-${SHIFTS[info.b]?.color||'L'}">${SHIFTS[info.b]?.label||'L'}</div>`;
    } else {
      const label = info.s==='L'?'L':(SHIFTS[info.s]?.label||info.s||'L');
      cell.innerHTML = `<div class="shift-label bg-${SHIFTS[info.s]?.color||'L'}">${label}</div>`;
    }

    if(db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality)) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
    cell.innerHTML += `<span class="day-number">${d}</span>`;
    if(info.n) cell.innerHTML += `<div class="note-text">${info.n}</div>`;

    cell.onclick=()=>{
      if(!isEditMode()) return alert("Activa modo ediciÃ³n para editar.");
      openDay(key, info);
    };

    grid.appendChild(cell);
  }

  // next filler
  const total = firstDayMonday + lastDate;
  for(let i=1; i<= (42-total); i++){
    const nextMonth = m===11?1:m+2;
    const nextYear = m===11?y+1:y;
    const key = dayKey(nextYear, nextMonth, i);

    const cell=document.createElement('div');
    cell.className='day-cell day-off-month';
    if(db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality)) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
    cell.innerHTML += `<span class="day-number">${i}</span>`;
    grid.appendChild(cell);
  }

  calcSummary();
}

/* =========================================================
   Modal day edit
========================================================= */
function openDay(key, info){
  activeKey = key;
  mode = info.mode || 'simple';
  selS = info.s || 'MaÃ±ana';
  selT = info.t || 'MaÃ±ana';
  selB = info.b || 'Tarde';

  const user=db.users[db.current];
  const SHIFTS=user.config;

  // date title
  const [yy,mm,dd]=key.split('-');
  document.getElementById('modalDate').textContent = `${dd} de ${MONTHS[parseInt(mm)-1]} de ${yy}`;

  if(mode==='simple'){
    document.getElementById('tIn').value = info.tIn || (SHIFTS[selS]?.in || '00:00');
    document.getElementById('tOut').value = info.tOut || (SHIFTS[selS]?.out || '00:00');
    document.getElementById('tHrs').value = (info.h ?? calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value)).toFixed(1);

    document.getElementById('time-simple').classList.remove('hidden');
    document.getElementById('time-mixto').classList.add('hidden');
  } else {
    document.getElementById('tInTop').value = info.tInTop || (SHIFTS[selT]?.in || '00:00');
    document.getElementById('tOutTop').value = info.tOutTop || (SHIFTS[selT]?.out || '00:00');
    document.getElementById('tInBottom').value = info.tInBottom || (SHIFTS[selB]?.in || '00:00');
    document.getElementById('tOutBottom').value = info.tOutBottom || (SHIFTS[selB]?.out || '00:00');

    const hrsTop = info.hrsTop ?? calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
    const hrsBottom = info.hrsBottom ?? calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);

    document.getElementById('tHrsTop').value = Number(hrsTop).toFixed(1);
    document.getElementById('tHrsBottom').value = Number(hrsBottom).toFixed(1);
    document.getElementById('tHrsMixto').value = Number(hrsTop+hrsBottom).toFixed(1);

    document.getElementById('time-simple').classList.add('hidden');
    document.getElementById('time-mixto').classList.remove('hidden');
  }

  // comentario estÃ¡ndar
  const note = String(info.n||'').trim();
  if(!note){
    document.getElementById('nota').value = (mode==='simple')
      ? defaultNoteForShift(selS)
      : `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
  } else {
    document.getElementById('nota').value = info.n;
  }

  setMode(mode);
  refreshShiftButtons();
  document.getElementById('modal').classList.add('active');
}

function closeModal(){ document.getElementById('modal').classList.remove('active'); }

function setMode(m){
  mode=m;
  document.getElementById('m-s').className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m==='simple'?'bg-white shadow-md text-blue-600':'text-gray-400'}`;
  document.getElementById('m-m').className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m==='mixto'?'bg-white shadow-md text-blue-600':'text-gray-400'}`;
  document.getElementById('sec-simple').classList.toggle('hidden', m!=='simple');
  document.getElementById('sec-mixto').classList.toggle('hidden', m!=='mixto');
}

function refreshShiftButtons(){
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const mkBtn=(k, selected)=>{
    const b=document.createElement('div');
    b.className = `shift-option ${selected?'selected':''} bg-${SHIFTS[k]?.color||'L'}`;
    b.textContent = SHIFTS[k]?.label || k;
    return b;
  };

  // simple
  const sC=document.getElementById('sec-simple');
  sC.innerHTML='';
  Object.keys(SHIFTS).forEach(k=>{
    const b=mkBtn(k, selS===k);
    b.onclick=()=>{
      selS=k;
      document.getElementById('tIn').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOut').value = SHIFTS[k]?.out || '00:00';
      autoCalc();
      // estandar: si comentario vacÃ­o, llenar
      if(!document.getElementById('nota').value.trim()) document.getElementById('nota').value = defaultNoteForShift(selS);
      refreshShiftButtons();
    };
    sC.appendChild(b);
  });

  // mixto top
  const tC=document.getElementById('mix-t');
  tC.innerHTML='';
  Object.keys(SHIFTS).forEach(k=>{
    const b=mkBtn(k, selT===k);
    b.onclick=()=>{
      selT=k;
      document.getElementById('tInTop').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOutTop').value = SHIFTS[k]?.out || '00:00';
      autoCalcMixtoTop();
      if(!document.getElementById('nota').value.trim()) document.getElementById('nota').value = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
      refreshShiftButtons();
    };
    tC.appendChild(b);
  });

  // mixto bottom
  const bC=document.getElementById('mix-b');
  bC.innerHTML='';
  Object.keys(SHIFTS).forEach(k=>{
    const b=mkBtn(k, selB===k);
    b.onclick=()=>{
      selB=k;
      document.getElementById('tInBottom').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOutBottom').value = SHIFTS[k]?.out || '00:00';
      autoCalcMixtoBottom();
      if(!document.getElementById('nota').value.trim()) document.getElementById('nota').value = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
      refreshShiftButtons();
    };
    bC.appendChild(b);
  });
}

function autoCalc(){
  const hrs=calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value);
  document.getElementById('tHrs').value = hrs.toFixed(1);
}
function manualCalc(){
  const v=parseFloat(document.getElementById('tHrs').value)||0;
  document.getElementById('tHrs').value=v.toFixed(1);
}
function autoCalcMixtoTop(){
  const hrs=calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
  document.getElementById('tHrsTop').value = hrs.toFixed(1);
  updateMixtoTotal();
}
function manualCalcMixtoTop(){
  const v=parseFloat(document.getElementById('tHrsTop').value)||0;
  document.getElementById('tHrsTop').value=v.toFixed(1);
  updateMixtoTotal();
}
function autoCalcMixtoBottom(){
  const hrs=calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);
  document.getElementById('tHrsBottom').value = hrs.toFixed(1);
  updateMixtoTotal();
}
function manualCalcMixtoBottom(){
  const v=parseFloat(document.getElementById('tHrsBottom').value)||0;
  document.getElementById('tHrsBottom').value=v.toFixed(1);
  updateMixtoTotal();
}
function updateMixtoTotal(){
  const t=parseFloat(document.getElementById('tHrsTop').value)||0;
  const b=parseFloat(document.getElementById('tHrsBottom').value)||0;
  document.getElementById('tHrsMixto').value=(t+b).toFixed(1);
}

function maybeAutoNoteSimple(){
  const n=document.getElementById('nota');
  if(!n.value.trim()) n.value=defaultNoteForShift(selS);
}
function maybeAutoNoteMixto(){
  const n=document.getElementById('nota');
  if(!n.value.trim()) n.value=`${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
}

function saveDay(){
  const user=db.users[db.current];
  const data = { mode, s:selS, t:selT, b:selB, n: document.getElementById('nota').value };

  if(mode==='simple'){
    data.tIn = document.getElementById('tIn').value;
    data.tOut = document.getElementById('tOut').value;
    data.h = parseFloat(document.getElementById('tHrs').value)||0;
    // estandar
    if(!String(data.n||'').trim()) data.n = defaultNoteForShift(selS);
  } else {
    data.tInTop = document.getElementById('tInTop').value;
    data.tOutTop = document.getElementById('tOutTop').value;
    data.tInBottom = document.getElementById('tInBottom').value;
    data.tOutBottom = document.getElementById('tOutBottom').value;
    data.hrsTop = parseFloat(document.getElementById('tHrsTop').value)||0;
    data.hrsBottom = parseFloat(document.getElementById('tHrsBottom').value)||0;
    data.h = parseFloat(document.getElementById('tHrsMixto').value)||0;
    if(!String(data.n||'').trim()) data.n = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
  }

  user.data[activeKey]=data;
  saveDB();
  render();
  closeModal();
}

/* =========================================================
   Summary
========================================================= */
function calcSummary(){
  const y=current.getFullYear();
  const m0=current.getMonth();
  const m1=m0+1;
  const user=db.users[db.current];
  const SHIFTS=user.config;

  let h=0, s=0;
  let hospDays=0, senaDays=0, freeDays=0, vacDays=0, workedDays=0, weekendDays=0, holidayWorked=0;
  const daysInMonth = new Date(y,m0+1,0).getDate();
  freeDays = daysInMonth;

  const applicableHolidays = countApplicableHolidaysInMonth(y,m0,user.locality);

  for(const k of Object.keys(user.data)){
    if(!k.startsWith(`${y}-${m1}-`)) continue;
    const d = user.data[k];
    const dayNum = parseInt(k.split('-')[2]);
    const dow = new Date(y,m0,dayNum).getDay();
    const isHoliday = db.holidays[k] && holidayApplies(db.holidays[k].location, user.locality);

    if(dow===0 || dow===6) weekendDays++;
    freeDays--;

    if(d.mode==='mixto'){
      // count holiday worked if at least one work shift and holiday applicable
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;
      const topWork = (topCat==='hosp' || topCat==='sena');
      const botWork = (botCat==='hosp' || botCat==='sena');
      if(isHoliday && (topWork || botWork)) holidayWorked++;

      if(topCat==='hosp'){ h += (d.hrsTop||calculateHours(d.tInTop||SHIFTS[d.t].in, d.tOutTop||SHIFTS[d.t].out)); hospDays++; workedDays++; }
      if(topCat==='sena'){ s += (d.hrsTop||calculateHours(d.tInTop||SHIFTS[d.t].in, d.tOutTop||SHIFTS[d.t].out)); senaDays++; workedDays++; }
      if(botCat==='hosp'){ h += (d.hrsBottom||calculateHours(d.tInBottom||SHIFTS[d.b].in, d.tOutBottom||SHIFTS[d.b].out)); hospDays++; workedDays++; }
      if(botCat==='sena'){ s += (d.hrsBottom||calculateHours(d.tInBottom||SHIFTS[d.b].in, d.tOutBottom||SHIFTS[d.b].out)); senaDays++; workedDays++; }
    } else {
      const cat = SHIFTS[d.s]?.cat;
      if(cat==='hosp'){ h += (d.h||0); hospDays++; workedDays++; if(isHoliday) holidayWorked++; }
      else if(cat==='sena'){ s += (d.h||0); senaDays++; workedDays++; if(isHoliday) holidayWorked++; }
      else if(cat==='off'){ freeDays++; if(d.s==='Vacaciones') vacDays++; }
    }
  }

  freeDays = Math.max(0, freeDays);
  document.getElementById('hrs-hosp').textContent = `${h.toFixed(1)} HRS`;
  document.getElementById('hrs-sena').textContent = `${s.toFixed(1)} HRS`;
  document.getElementById('hosp-days').textContent = `${hospDays} dÃ­a${hospDays!==1?'s':''}`;
  document.getElementById('sena-days').textContent = `${senaDays} dÃ­a${senaDays!==1?'s':''}`;
  document.getElementById('total-off').textContent = (freeDays + vacDays + weekendDays);
  document.getElementById('free-days').textContent = freeDays;
  document.getElementById('vac-days').textContent = vacDays;
  document.getElementById('weekend-days').textContent = weekendDays;
  document.getElementById('holiday-worked').textContent = holidayWorked;
  document.getElementById('worked-days').textContent = workedDays;
  document.getElementById('total-holidays').textContent = applicableHolidays;
  document.getElementById('profile-loc').textContent = user.locality || 'San Salvador';

  const avg = workedDays>0 ? (h+s)/workedDays : 0;
  document.getElementById('avg-hours').textContent = `${avg.toFixed(1)}h`;
  document.getElementById('total-days').textContent = daysInMonth;
}

/* =========================================================
   Turnos settings + propagation
========================================================= */
function renderSettings(){
  const container=document.getElementById('settings-container');
  container.innerHTML='';
  const user=db.users[db.current];
  const SHIFTS=user.config;

  Object.keys(SHIFTS).sort().forEach(id=>{
    const conf=SHIFTS[id];
    container.innerHTML += `
      <div class="flex items-start gap-3 bg-gradient-to-r from-gray-50 to-white p-4 rounded-2xl border border-gray-200">
        <div class="w-10 h-10 rounded-full bg-${conf.color} border-2 border-white shadow-sm flex items-center justify-center">
          <span class="text-[10px] font-black text-gray-800">${(conf.label||id).charAt(0)}</span>
        </div>
        <div class="flex-1">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</p>
              <input id="set-label-${cssSafe(id)}" value="${escapeHTML(conf.label||id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">CategorÃ­a</p>
              <select id="set-cat-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
                ${Object.keys(db.categories).map(cid=>{
                  const c=db.categories[cid];
                  return `<option value="${cid}" ${conf.cat===cid?'selected':''}>${escapeHTML(c.icon)} ${escapeHTML(c.name)}</option>`;
                }).join('')}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Color</p>
              <select id="set-color-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
                ${['MaÃ±ana','Tarde','CENA','16hrs','L','Vacaciones','azul','rojo','verde','naranja','rosa','cian','morado','lima','ambar','teal','indigo','gris'].map(x=>`<option value="${x}" ${conf.color===x?'selected':''}>${x}</option>`).join('')}
              </select>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Entrada</p>
              <input type="time" id="set-in-${cssSafe(id)}" value="${conf.in||'00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Salida</p>
              <input type="time" id="set-out-${cssSafe(id)}" value="${conf.out||'00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
          </div>

          <div class="mt-2 text-[10px] font-bold text-gray-600">
            Nota sugerida: <span class="text-gray-900 font-black">${(conf.in && conf.out && !(conf.in==='00:00'&&conf.out==='00:00')) ? `${conf.in}-${conf.out}` : (conf.label||id).toUpperCase()}</span>
          </div>
        </div>

        <button onclick="deleteShift('${escapeAttr(id)}')" class="p-2 text-red-600 hover:text-red-800 font-black" title="Eliminar turno">ğŸ—‘ï¸</button>
      </div>
    `;
  });

  loadCategoriesSelect();
}

function saveShiftSettings(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const propagate = document.getElementById('propagateShiftEdits').checked;

  // snapshot old shift definitions to detect changes
  const old = JSON.parse(JSON.stringify(SHIFTS));

  Object.keys(SHIFTS).forEach(id=>{
    const key = cssSafe(id);
    const label = document.getElementById(`set-label-${key}`)?.value?.trim() || id;
    const cat = document.getElementById(`set-cat-${key}`)?.value || SHIFTS[id].cat;
    const color = document.getElementById(`set-color-${key}`)?.value || SHIFTS[id].color;
    const inT = document.getElementById(`set-in-${key}`)?.value || SHIFTS[id].in || '00:00';
    const outT = document.getElementById(`set-out-${key}`)?.value || SHIFTS[id].out || '00:00';

    SHIFTS[id].label = label;
    SHIFTS[id].cat = cat;
    SHIFTS[id].color = color;
    SHIFTS[id].in = inT;
    SHIFTS[id].out = outT;
  });

  if(propagate){
    // Update current user's calendar entries affected by changed shifts
    const y=current.getFullYear();
    const m1=current.getMonth()+1;

    Object.keys(user.data).forEach(k=>{
      if(!k.startsWith(`${y}-${m1}-`)) return;
      const d = user.data[k];
      if(d.mode==='simple'){
        const sid = d.s;
        if(!sid || !SHIFTS[sid]) return;
        const was = old[sid];
        const now = SHIFTS[sid];
        // if shift changed times, update stored times/hours and comment if was old time-format or empty
        if(was && (was.in!==now.in || was.out!==now.out)){
          d.tIn = now.in; d.tOut = now.out; d.h = calculateHours(now.in, now.out);
          const wasNote = String(d.n||'').trim();
          const oldStd = (was.in && was.out && !(was.in==='00:00'&&was.out==='00:00')) ? `${was.in}-${was.out}` : (was.label||sid).toUpperCase();
          const newStd = (now.in && now.out && !(now.in==='00:00'&&now.out==='00:00')) ? `${now.in}-${now.out}` : (now.label||sid).toUpperCase();
          if(!wasNote || wasNote===oldStd) d.n = newStd;
        }
      } else if(d.mode==='mixto'){
        const applyPart = (partKey, inField, outField, hrsField)=>{
          const sid = d[partKey];
          if(!sid || !SHIFTS[sid]) return;
          const was=old[sid], now=SHIFTS[sid];
          if(was && (was.in!==now.in || was.out!==now.out)){
            d[inField]=now.in; d[outField]=now.out;
            d[hrsField]=calculateHours(now.in, now.out);
          }
        };
        applyPart('t','tInTop','tOutTop','hrsTop');
        applyPart('b','tInBottom','tOutBottom','hrsBottom');
        d.h = (parseFloat(d.hrsTop)||0)+(parseFloat(d.hrsBottom)||0);

        // Comment: update only if empty or matches old composite
        const oldTop = old[d.t] ? ((old[d.t].in && old[d.t].out && !(old[d.t].in==='00:00'&&old[d.t].out==='00:00')) ? `${old[d.t].in}-${old[d.t].out}` : (old[d.t].label||d.t).toUpperCase()) : '';
        const oldBot = old[d.b] ? ((old[d.b].in && old[d.b].out && !(old[d.b].in==='00:00'&&old[d.b].out==='00:00')) ? `${old[d.b].in}-${old[d.b].out}` : (old[d.b].label||d.b).toUpperCase()) : '';
        const newTop = SHIFTS[d.t] ? defaultNoteForShift(d.t) : '';
        const newBot = SHIFTS[d.b] ? defaultNoteForShift(d.b) : '';

        const oldMix = `${oldTop} | ${oldBot}`.trim();
        const newMix = `${newTop} | ${newBot}`.trim();
        const wasNote = String(d.n||'').trim();
        if(!wasNote || wasNote===oldMix) d.n = newMix;
      }
    });
  }

  saveDB();
  render();
  alert("Turnos actualizados.");
}

function deleteShift(id){
  if(id==='L' || id==='Vacaciones') return alert("No se puede eliminar este turno base.");
  const user=db.users[db.current];

  // validate not used
  const used = Object.values(user.data).some(d=>{
    if(d.mode==='mixto') return d.t===id || d.b===id;
    return d.s===id;
  });
  if(used) return alert("No se puede eliminar: el turno estÃ¡ usado en el calendario del perfil.");

  if(!confirm(`Â¿Eliminar turno "${id}"?`)) return;
  delete user.config[id];
  saveDB();
  renderSettings();
  render();
}

/* =========================================================
   New shift
========================================================= */
function selectColor(color, ev){
  selectedColor=color;
  document.getElementById('newShiftColor').value=color;
  document.querySelectorAll('.color-option').forEach(o=>o.classList.remove('selected'));
  if(ev?.target) ev.target.classList.add('selected');
}
function loadCategoriesSelect(){
  const select=document.getElementById('newShiftCat');
  if(!select) return;
  select.innerHTML = Object.keys(db.categories).map(cid=>{
    const c=db.categories[cid];
    return `<option value="${cid}">${escapeHTML(c.icon)} ${escapeHTML(c.name)}</option>`;
  }).join('');
}
function addNewShift(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const name=document.getElementById('newShiftName').value.trim();
  const color=document.getElementById('newShiftColor').value;
  const cat=document.getElementById('newShiftCat').value;
  const inT=document.getElementById('newShiftIn').value||'00:00';
  const outT=document.getElementById('newShiftOut').value||'00:00';

  if(!name) return alert("Nombre requerido.");
  const key = name.replace(/\s+/g,'_');
  const user=db.users[db.current];
  if(user.config[key]) return alert("Ya existe un turno con ese nombre (ID).");

  user.config[key]={ label:name, color, cat, in:inT, out:outT };
  saveDB();
  renderSettings();
  render();
  document.getElementById('newShiftName').value='';
  document.getElementById('newShiftIn').value='';
  document.getElementById('newShiftOut').value='';
  alert("Turno agregado.");
}

/* =========================================================
   Categories: editable + deletable
========================================================= */
function renderCategories(){
  const container=document.getElementById('categories-container');
  container.innerHTML='';

  const ids=Object.keys(db.categories).sort((a,b)=>db.categories[a].name.localeCompare(db.categories[b].name));
  ids.forEach(cid=>{
    const c=db.categories[cid];
    const system = ['hosp','sena','off'].includes(cid);
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-lg">${escapeHTML(c.icon)}</div>
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="cat-name-${cid}" value="${escapeHTML(c.name)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${system?'disabled':''}/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Icono</div>
            <input id="cat-icon-${cid}" value="${escapeHTML(c.icon)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${system?'disabled':''}/>
          </div>
          <div class="md:col-span-2 text-[10px] font-bold text-gray-500">
            ID: <span class="font-black text-gray-800">${cid}</span> ${system?'<span class="ml-2 text-[9px] font-black text-gray-400">(Sistema)</span>':''}
          </div>
        </div>
        ${system ? `<span class="text-[9px] font-black text-gray-400">Bloqueado</span>` : `<button onclick="deleteCategory('${cid}')" class="p-2 text-red-600 hover:text-red-800 font-black">ğŸ—‘ï¸</button>`}
      </div>
    `;
  });
}

function addNewCategory(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const name=document.getElementById('newCategoryName').value.trim();
  const icon=document.getElementById('newCategoryIcon').value;
  if(!name) return alert("Nombre requerido.");

  const cid = name.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  if(db.categories[cid]) return alert("Ya existe una categorÃ­a con ese ID.");

  db.categories[cid]={ name, icon };
  saveDB();
  document.getElementById('newCategoryName').value='';
  renderCategories();
  loadCategoriesSelect();
  alert("CategorÃ­a agregada.");
}

function deleteCategory(cid){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  // check used in any user's config
  const used = Object.values(db.users).some(u=> Object.values(u.config).some(s=>s.cat===cid));
  if(used) return alert("No se puede eliminar: hay turnos usando esta categorÃ­a.");
  if(!confirm(`Â¿Eliminar categorÃ­a "${db.categories[cid].name}"?`)) return;
  delete db.categories[cid];
  saveDB();
  renderCategories();
  loadCategoriesSelect();
}

function saveCategories(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  Object.keys(db.categories).forEach(cid=>{
    if(['hosp','sena','off'].includes(cid)) return;
    const name = document.getElementById(`cat-name-${cid}`)?.value?.trim();
    const icon = document.getElementById(`cat-icon-${cid}`)?.value?.trim();
    if(name) db.categories[cid].name=name;
    if(icon) db.categories[cid].icon=icon;
  });
  saveDB();
  renderCategories();
  loadCategoriesSelect();
  renderSettings();
  render();
  alert("CategorÃ­as actualizadas.");
}

/* =========================================================
   Localities: editable + deletable (with propagation)
========================================================= */
function renderLocalities(){
  const container=document.getElementById('localities-container');
  container.innerHTML='';

  // ensure unique, keep order
  db.localities = Array.from(new Set(db.localities.map(x=>String(x).trim()).filter(Boolean)));
  if(!db.localities.some(x=>x.toUpperCase()==='GENERAL')) db.localities.unshift('General');
  if(!db.localities.some(x=>x.toUpperCase()==='SAN SALVADOR')) db.localities.push('San Salvador');

  db.localities.forEach((loc, idx)=>{
    const isGeneral = loc.trim().toUpperCase()==='GENERAL';
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center font-black text-sky-700">ğŸ“</div>
        <div class="flex-1">
          <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
          <input id="loc-${idx}" value="${escapeHTML(loc)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${isGeneral?'disabled':''}/>
          <div class="text-[10px] font-bold text-gray-500 mt-1">${isGeneral?'Reservado.':''}</div>
        </div>
        ${isGeneral? `<span class="text-[9px] font-black text-gray-400">Bloqueado</span>` : `<button onclick="deleteLocality(${idx})" class="p-2 text-red-600 hover:text-red-800 font-black">ğŸ—‘ï¸</button>`}
      </div>
    `;
  });

  refreshHolidayLocationSelects();
  refreshProfileLocationSelects();
}

function addLocality(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const name=document.getElementById('newLocalityName').value.trim();
  if(!name) return alert("Nombre requerido.");
  if(name.toUpperCase()==='GENERAL') return alert("â€œGeneralâ€ es reservado.");
  if(db.localities.some(x=>x.trim().toUpperCase()===name.trim().toUpperCase())) return alert("Ya existe esa localidad.");

  db.localities.push(name);
  document.getElementById('newLocalityName').value='';
  saveDB();
  renderLocalities();
  alert("Localidad agregada.");
}

function deleteLocality(idx){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const loc=db.localities[idx];
  if(!loc || loc.toUpperCase()==='GENERAL') return;
  // check if used by any user or holiday
  const usedUser = Object.values(db.users).some(u => (u.locality||'').trim().toUpperCase() === loc.trim().toUpperCase());
  const usedHoliday = Object.values(db.holidays).some(h => (h.location||'').trim().toUpperCase() === loc.trim().toUpperCase());
  if(usedUser || usedHoliday) return alert("No se puede eliminar: estÃ¡ en uso por perfiles o asuetos. Cambia primero esas referencias.");
  if(!confirm(`Â¿Eliminar localidad "${loc}"?`)) return;

  db.localities.splice(idx,1);
  saveDB();
  renderLocalities();
}

function saveLocalities(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");

  const oldList = [...db.localities];
  const newList = [];

  // read edits
  for(let i=0;i<oldList.length;i++){
    const oldLoc = oldList[i];
    const isGeneral = oldLoc.trim().toUpperCase()==='GENERAL';
    if(isGeneral){ newList.push('General'); continue; }
    const v = document.getElementById(`loc-${i}`)?.value?.trim();
    if(!v) continue;
    if(v.toUpperCase()==='GENERAL') continue;
    newList.push(v);
  }

  // ensure required
  if(!newList.some(x=>x.toUpperCase()==='GENERAL')) newList.unshift('General');
  if(!newList.some(x=>x.toUpperCase()==='SAN SALVADOR')) newList.push('San Salvador');

  // build rename map based on index (only safe rename by index)
  const renamePairs = [];
  for(let i=0;i<oldList.length;i++){
    const a=String(oldList[i]||'').trim();
    const b=(document.getElementById(`loc-${i}`)?.value||a).trim();
    if(a && b && a.toUpperCase()!=='GENERAL' && a.toUpperCase()!==b.toUpperCase()){
      renamePairs.push([a,b]);
    }
  }

  db.localities = Array.from(new Set(newList.map(x=>String(x).trim()).filter(Boolean)));

  // propagate renames to users + holidays
  renamePairs.forEach(([from,to])=>{
    Object.values(db.users).forEach(u=>{
      if((u.locality||'').trim().toUpperCase()===from.trim().toUpperCase()) u.locality=to;
    });
    Object.keys(db.holidays).forEach(k=>{
      const h=db.holidays[k];
      if((h.location||'').trim().toUpperCase()===from.trim().toUpperCase()) h.location=to;
    });
  });

  saveDB();
  renderLocalities();
  renderHolidays();
  renderProfilesList();
  render();
  alert("Localidades actualizadas.");
}

function refreshHolidayLocationSelects(){
  const sel=document.getElementById('newHolidayLocation');
  if(sel){
    sel.innerHTML = db.localities.map(l=>`<option value="${escapeAttr(l)}" ${l.toUpperCase()==='GENERAL'?'':' '}>${escapeHTML(l)}</option>`).join('');
    if(db.localities.some(x=>x.toUpperCase()==='SAN SALVADOR')) sel.value='San Salvador';
  }
}
function refreshProfileLocationSelects(){
  const createLoc=document.getElementById('createLoc');
  if(createLoc){
    createLoc.innerHTML = db.localities.filter(l=>l.toUpperCase()!=='GENERAL').map(l=>`<option value="${escapeAttr(l)}">${escapeHTML(l)}</option>`).join('');
    createLoc.value='San Salvador';
  }
}

/* =========================================================
   Holidays: editable + deletable
========================================================= */
function renderHolidays(){
  const container=document.getElementById('holidays-container');
  container.innerHTML='';

  const keys = Object.keys(db.holidays).sort((a,b)=> new Date(a) - new Date(b));
  if(keys.length===0){
    container.innerHTML = `<div class="p-8 text-center text-gray-400 font-bold">No hay asuetos.</div>`;
    return;
  }

  keys.forEach(k=>{
    const h=db.holidays[k];
    const [y,m,d]=k.split('-');
    container.innerHTML += `
      <div class="p-4 border-b border-gray-100">
        <div class="flex items-center justify-between gap-2">
          <div class="font-black text-gray-900 text-[12px]">${escapeHTML(h.name||'Asueto')}</div>
          <button onclick="deleteHoliday('${escapeAttr(k)}')" class="p-2 text-red-600 hover:text-red-800 font-black">ğŸ—‘ï¸</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Fecha</div>
            <input id="h-date-${cssSafe(k)}" type="date" value="${toISODate(y,m,d)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="h-name-${cssSafe(k)}" value="${escapeHTML(h.name||'')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="h-loc-${cssSafe(k)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
              ${db.localities.map(l=>`<option value="${escapeAttr(l)}" ${(h.location||'General')===l?'selected':''}>${escapeHTML(l)}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
    `;
  });
}

function addNewHoliday(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const dateInput=document.getElementById('newHolidayDate').value;
  const name=document.getElementById('newHolidayName').value.trim();
  const loc=document.getElementById('newHolidayLocation').value || 'General';

  if(!dateInput || !name) return alert("Fecha y nombre requeridos.");

  const dt=new Date(dateInput+'T00:00:00');
  const key=dayKey(dt.getFullYear(), dt.getMonth()+1, dt.getDate());
  db.holidays[key]={ name, location: loc };

  document.getElementById('newHolidayDate').value='';
  document.getElementById('newHolidayName').value='';
  saveDB();
  renderHolidays();
  render();
  alert("Asueto agregado.");
}

function deleteHoliday(k){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  if(!confirm(`Â¿Eliminar asueto ${k}?`)) return;
  delete db.holidays[k];
  saveDB();
  renderHolidays();
  render();
}

function saveHolidays(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");

  const newHolidays = {};
  const keys = Object.keys(db.holidays);

  keys.forEach(oldKey=>{
    const safe = cssSafe(oldKey);
    const dateVal = document.getElementById(`h-date-${safe}`)?.value;
    const nameVal = document.getElementById(`h-name-${safe}`)?.value?.trim();
    const locVal = document.getElementById(`h-loc-${safe}`)?.value || 'General';
    if(!dateVal || !nameVal) return;

    const dt = new Date(dateVal+'T00:00:00');
    const newKey = dayKey(dt.getFullYear(), dt.getMonth()+1, dt.getDate());
    newHolidays[newKey] = { name:nameVal, location: locVal };
  });

  db.holidays = newHolidays;
  saveDB();
  renderHolidays();
  render();
  alert("Asuetos actualizados.");
}

/* =========================================================
   PIN only
========================================================= */
function savePinOnly(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const user=db.users[db.current];
  const p=document.getElementById('changePinInput').value;
  const c=document.getElementById('confirmPinInput').value;
  if(!p || p.length!==4 || isNaN(p)) return alert("PIN invÃ¡lido.");
  if(p!==c) return alert("PIN no coincide.");
  user.pin=p;
  document.getElementById('changePinInput').value='';
  document.getElementById('confirmPinInput').value='';
  saveDB();
  alert("PIN actualizado.");
}

/* =========================================================
   Profiles modal: create/edit/delete + locality
========================================================= */
function openProfilesModal(){
  refreshProfileLocationSelects();
  renderProfilesList();
  document.getElementById('profilesModal').classList.add('active');
}
function closeProfilesModal(){ document.getElementById('profilesModal').classList.remove('active'); }

function createProfile(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const name=document.getElementById('createName').value.trim().toUpperCase();
  const pin=document.getElementById('createPin').value.trim();
  const loc=document.getElementById('createLoc').value || 'San Salvador';

  if(!name || name.length<2) return alert("Nombre invÃ¡lido.");
  if(!pin || pin.length!==4 || isNaN(pin)) return alert("PIN invÃ¡lido.");
  if(db.users[name]) return alert("Ya existe ese perfil.");

  db.users[name] = JSON.parse(JSON.stringify(db.users['ADMIN']));
  db.users[name].pin = pin;
  db.users[name].locality = loc;
  db.users[name].data = {};
  db.users[name].editLocked = false;
  ensureImportBaseShiftsForUser(name);

  db.current = name;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  alert("Perfil creado.");
}

function renderProfilesList(){
  const box=document.getElementById('profilesList');
  box.innerHTML='';
  const keys=Object.keys(db.users).sort();

  keys.forEach(u=>{
    const user=db.users[u];
    const isCurrent = (u===db.current);
    box.innerHTML += `
      <div class="border border-gray-200 rounded-2xl p-3 ${isCurrent?'bg-blue-50 border-blue-200':''}">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="font-black text-gray-900 text-[12px]">${escapeHTML(u)} ${isCurrent?'<span class="ml-2 text-[9px] font-black text-blue-600">(Actual)</span>':''}</div>
            <div class="text-[10px] font-bold text-gray-500">Localidad: <span class="font-black text-gray-800">${escapeHTML(user.locality||'San Salvador')}</span></div>
          </div>
          <div class="flex gap-2">
            <button onclick="setCurrentProfile('${escapeAttr(u)}')" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Usar</button>
            ${u==='ADMIN' ? '' : `<button onclick="deleteProfile('${escapeAttr(u)}')" class="px-3 py-2 rounded-xl bg-red-100 hover:bg-red-200 text-red-700 text-[10px] font-black uppercase">Eliminar</button>`}
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Renombrar perfil</div>
            <input id="p-name-${cssSafe(u)}" value="${escapeHTML(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${u==='ADMIN'?'disabled':''}/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">PIN</div>
            <input id="p-pin-${cssSafe(u)}" value="${escapeHTML(user.pin||'0000')}" maxlength="4" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="p-loc-${cssSafe(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
              ${db.localities.filter(l=>l.toUpperCase()!=='GENERAL').map(l=>`<option value="${escapeAttr(l)}" ${(user.locality||'San Salvador')===l?'selected':''}>${escapeHTML(l)}</option>`).join('')}
            </select>
          </div>
          <div class="md:col-span-3">
            <button onclick="saveProfileEdits('${escapeAttr(u)}')" class="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[11px]">
              ğŸ’¾ Guardar cambios de este perfil
            </button>
          </div>
        </div>
      </div>
    `;
  });
}

function setCurrentProfile(u){
  db.current=u;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
}

function deleteProfile(u){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  if(u==='ADMIN') return;
  if(!confirm(`Â¿Eliminar perfil "${u}"? Se perderÃ¡ su calendario.`)) return;

  delete db.users[u];
  if(db.current===u) db.current='ADMIN';
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
}

function saveProfileEdits(u){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const user=db.users[u];
  if(!user) return;

  const pin = document.getElementById(`p-pin-${cssSafe(u)}`)?.value?.trim();
  const loc = document.getElementById(`p-loc-${cssSafe(u)}`)?.value || 'San Salvador';

  if(!pin || pin.length!==4 || isNaN(pin)) return alert("PIN invÃ¡lido (4 dÃ­gitos).");
  user.pin = pin;
  user.locality = loc;

  // rename
  if(u!=='ADMIN'){
    const newName = document.getElementById(`p-name-${cssSafe(u)}`)?.value?.trim()?.toUpperCase();
    if(newName && newName!==u){
      if(db.users[newName]) return alert("No se puede renombrar: ya existe ese nombre.");
      db.users[newName] = user;
      delete db.users[u];
      if(db.current===u) db.current=newName;
    }
  }

  saveDB();
  updateUserDropdown();
  updateUserInitial();
  renderProfilesList();
  render();
  alert("Perfil actualizado.");
}

/* =========================================================
   Import: analyze + select users + import selected
========================================================= */
function openImportModal(){
  document.getElementById('importFile').value='';
  document.getElementById('importInfo').innerText='';
  document.getElementById('importUsersList').innerHTML = `<div class="text-gray-400 font-bold">Adjunta un Excel y presiona â€œAnalizarâ€.</div>`;
  importContext=null;

  // default to current month/year
  document.getElementById('importMonth').value = current.getMonth();
  document.getElementById('importYear').value = current.getFullYear();
  document.getElementById('importModal').classList.add('active');
}
function closeImportModal(){ document.getElementById('importModal').classList.remove('active'); }

function detectMonthYearFromRows(rows){
  const monthsMap = {'ENERO':0,'FEBRERO':1,'MARZO':2,'ABRIL':3,'MAYO':4,'JUNIO':5,'JULIO':6,'AGOSTO':7,'SEPTIEMBRE':8,'OCTUBRE':9,'NOVIEMBRE':10,'DICIEMBRE':11};
  let foundMonth=null, foundYear=null;
  for(let r=0;r<Math.min(rows.length,50);r++){
    const row=rows[r]||[];
    for(let c=0;c<row.length;c++){
      const v=row[c]; if(!v) continue;
      const s=String(v).toUpperCase();
      Object.keys(monthsMap).forEach(mn=>{ if(s.includes(mn) && foundMonth===null) foundMonth=monthsMap[mn]; });
      const yMatch=s.match(/AÃ‘O\s*([0-9]{4})/);
      if(yMatch) foundYear=parseInt(yMatch[1]);
    }
  }
  return {month:foundMonth, year:foundYear};
}

function findHeaderRow(rows){
  for(let r=0;r<rows.length;r++){
    const row=rows[r]||[];
    const joined=row.map(x=>String(x||'').trim()).join(' | ').toUpperCase();
    if(joined.includes('PERSONAL') && (joined.includes('NO. EMP') || joined.includes('NO EMP') || joined.includes('NO.EMP'))){
      if(row.some(v=>String(v).trim()==='1') && row.some(v=>String(v).trim()==='2')) return r;
    }
  }
  return -1;
}
function buildDayColumnMap(headerRow){
  const map={};
  for(let c=0;c<headerRow.length;c++){
    const s=String(headerRow[c]||'').trim();
    if(/^\d+$/.test(s)){
      const d=parseInt(s);
      if(d>=1&&d<=31) map[d]=c;
    }
  }
  return map;
}
function safeNameCell(v){ return String(v||'').replace(/\s+/g,' ').trim(); }

function isLikelyDataRow(row, nameCol, empCol, dayCols){
  const name=safeNameCell(row[nameCol]).toUpperCase();
  const emp=safeNameCell(row[empCol]);
  if(!name || !emp) return false;
  if(name.includes('TOTAL POR TURNO') || name.includes('PERSONAL')) return false;
  // any code present
  for(const d of Object.keys(dayCols)){
    const code=normalizeCode(row[dayCols[d]]);
    if(code && code!=='X') return true;
  }
  return false;
}

async function analyzeImportFile(){
  const fileInput=document.getElementById('importFile');
  if(!fileInput.files || !fileInput.files[0]) return alert("Selecciona un archivo.");

  const data = await fileInput.files[0].arrayBuffer();
  const wb = XLSX.read(data, {type:'array'});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''});

  const detected = detectMonthYearFromRows(rows);
  const fallbackMonth = parseInt(document.getElementById('importMonth').value);
  const fallbackYear = parseInt(document.getElementById('importYear').value);
  const monthIndex0 = (detected.month ?? fallbackMonth);
  const year = (detected.year ?? fallbackYear);

  const headerIdx=findHeaderRow(rows);
  if(headerIdx<0) return alert("No pude detectar encabezados (PERSONAL / No. EMP. / dÃ­as).");

  const headerRow = rows[headerIdx]||[];
  const dayCols = buildDayColumnMap(headerRow);

  let nameCol=-1, empCol=-1;
  for(let c=0;c<headerRow.length;c++){
    const s=String(headerRow[c]||'').toUpperCase().trim();
    if(s==='PERSONAL') nameCol=c;
    if(s.includes('EMP')) empCol=c;
  }
  if(nameCol<0 || empCol<0 || Object.keys(dayCols).length<10) return alert("Encabezado incompleto.");

  // collect users
  const usersSet=new Set();
  for(let r=headerIdx+1;r<rows.length;r++){
    const row=rows[r]||[];
    if(!isLikelyDataRow(row,nameCol,empCol,dayCols)) continue;
    usersSet.add(safeNameCell(row[nameCol]).toUpperCase());
  }

  importContext = { wb, sheetName, rows, headerIdx, nameCol, empCol, dayCols, monthIndex0, year, users: Array.from(usersSet).sort() };

  // render list
  const list=document.getElementById('importUsersList');
  if(importContext.users.length===0){
    list.innerHTML = `<div class="text-gray-400 font-bold">No se detectaron usuarios en ese Excel.</div>`;
  } else {
    list.innerHTML = importContext.users.map(u=>`
      <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
        <input class="impUserChk" type="checkbox" value="${escapeAttr(u)}" checked>
        <span class="font-black text-gray-800">${escapeHTML(u)}</span>
      </label>
    `).join('');
  }

  document.getElementById('importInfo').innerText = `Detectado: ${MONTHS[monthIndex0]} ${year}. Usuarios: ${importContext.users.length}.`;
}

function selectAllImportUsers(flag){
  document.querySelectorAll('.impUserChk').forEach(ch=> ch.checked = !!flag);
}

function clearMonthForUser(userKey, year, monthIndex0){
  const user=db.users[userKey];
  const prefix = `${year}-${monthIndex0+1}-`;
  Object.keys(user.data).forEach(k=>{ if(k.startsWith(prefix)) delete user.data[k]; });
}

function setDayForUser(userKey, year, monthIndex0, day, shiftDef, importMode){
  const user=db.users[userKey];
  const key = dayKey(year, monthIndex0+1, day);

  if(importMode==='merge' && user.data[key]) return;

  ensureShiftExistsForUser(userKey, shiftDef);

  const tIn = shiftDef.in || '00:00';
  const tOut = shiftDef.out || '00:00';
  const hrs = calculateHours(tIn, tOut);

  user.data[key] = {
    mode:'simple',
    s:shiftDef.key, t:shiftDef.key, b:shiftDef.key,
    tIn, tOut, h:hrs,
    n: (shiftDef.note && String(shiftDef.note).trim()) ? shiftDef.note : ((tIn!=='00:00'||tOut!=='00:00') ? `${tIn}-${tOut}` : (shiftDef.label||shiftDef.key).toUpperCase())
  };
}

function runImportSelected(){
  if(!importContext) return alert("Primero analiza el archivo.");
  const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'replace';

  const selected = Array.from(document.querySelectorAll('.impUserChk')).filter(x=>x.checked).map(x=>x.value);
  if(selected.length===0) return alert("Selecciona al menos un usuario.");

  const { rows, headerIdx, nameCol, empCol, dayCols, monthIndex0, year } = importContext;

  // Create selected users
  selected.forEach(u=> ensureUserExists(u));

  if(importMode==='replace'){
    selected.forEach(u=> clearMonthForUser(u, year, monthIndex0));
  }

  let written=0;
  for(let r=headerIdx+1;r<rows.length;r++){
    const row=rows[r]||[];
    if(!isLikelyDataRow(row,nameCol,empCol,dayCols)) continue;
    const name = safeNameCell(row[nameCol]).toUpperCase();
    if(!selected.includes(name)) continue;

    const userKey = ensureUserExists(name);
    ensureImportBaseShiftsForUser(userKey);

    for(const dStr of Object.keys(dayCols)){
      const day=parseInt(dStr);
      const code=normalizeCode(row[dayCols[dStr]]);
      if(!code || code==='X') continue;
      const def = codeToShiftDef(code);
      if(!def) continue;

      // enforce standard comment: if shift has time -> in-out
      if(def.in && def.out && !(def.in==='00:00'&&def.out==='00:00')) def.note = `${def.in}-${def.out}`;
      else def.note = (def.note || def.label || def.key || code).toUpperCase();

      setDayForUser(userKey, year, monthIndex0, day, def, importMode);
      written++;
    }
  }

  saveDB();

  // jump to imported month and show first selected as current
  db.current = selected[0];
  current = new Date(year, monthIndex0, 1);
  saveDB();

  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  render();

  document.getElementById('importInfo').innerText = `ImportaciÃ³n OK: perfiles ${selected.length}, celdas ${written}. (PIN por defecto: 0000)`;
  alert(`ImportaciÃ³n completada.\nPerfiles importados: ${selected.length}\nCeldas: ${written}\nMes: ${MONTHS[monthIndex0]} ${year}`);
}

/* =========================================================
   Export: one/many/all => 1 image per profile
========================================================= */
function showExportModal(){
  document.getElementById('exportMonth').value = current.getMonth();
  document.getElementById('exportYear').value = current.getFullYear();
  buildExportUserList();
  document.getElementById('exportUsersBox').classList.add('hidden');

  // toggle box when radio changes
  document.querySelectorAll('input[name="exportScope"]').forEach(r=>{
    r.onchange=()=>{
      const v=document.querySelector('input[name="exportScope"]:checked').value;
      document.getElementById('exportUsersBox').classList.toggle('hidden', v!=='select');
    };
  });

  document.getElementById('exportModal').classList.add('active');
}
function closeExportModal(){ document.getElementById('exportModal').classList.remove('active'); }

function buildExportUserList(){
  const list=document.getElementById('exportUsersList');
  const users=Object.keys(db.users).sort();
  list.innerHTML = users.map(u=>`
    <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
      <input class="expUserChk" type="checkbox" value="${escapeAttr(u)}">
      <span class="font-black text-gray-800">${escapeHTML(u)}</span>
    </label>
  `).join('');
}

function selectAllExportUsers(flag){
  document.querySelectorAll('.expUserChk').forEach(ch=> ch.checked = !!flag);
}

async function exportImages(){
  const monthIndex0 = parseInt(document.getElementById('exportMonth').value);
  const year = parseInt(document.getElementById('exportYear').value);
  const scope = document.querySelector('input[name="exportScope"]:checked').value;

  let targets=[];
  if(scope==='current') targets=[db.current];
  if(scope==='all') targets=Object.keys(db.users).sort();
  if(scope==='select'){
    targets = Array.from(document.querySelectorAll('.expUserChk')).filter(x=>x.checked).map(x=>x.value);
    if(targets.length===0) return alert("Selecciona al menos un perfil.");
  }

  closeExportModal();

  // Export 1 by 1
  const originalCurrent = db.current;
  for(const u of targets){
    db.current=u;
    updateUserInitial();

    const img = await buildExportImageForUser(u, year, monthIndex0);
    downloadDataUrl(img, `Turnos_${u}_${MONTHS[monthIndex0]}_${year}.png`);
  }

  // restore
  db.current = originalCurrent;
  updateUserDropdown();
  updateUserInitial();
  render();
  alert(`ExportaciÃ³n completada: ${targets.length} imagen(es).`);
}

function downloadDataUrl(dataUrl, filename){
  const a=document.createElement('a');
  a.download=filename;
  a.href=dataUrl;
  a.click();
}

async function buildExportImageForUser(userKey, year, monthIndex0){
  const user=db.users[userKey];
  const SHIFTS=user.config;

  let h=0, s=0, freeDays=0, vacDays=0, weekendDays=0, holidayWorked=0;
  const daysInMonth = new Date(year, monthIndex0+1, 0).getDate();
  freeDays = daysInMonth;

  const m1=monthIndex0+1;
  const todayStr = new Date().toLocaleDateString('es-ES');

  // compute
  Object.keys(user.data).forEach(k=>{
    if(!k.startsWith(`${year}-${m1}-`)) return;
    const d = user.data[k];
    const dayNum=parseInt(k.split('-')[2]);
    const dow = new Date(year, monthIndex0, dayNum).getDay();
    const isHoliday = db.holidays[k] && holidayApplies(db.holidays[k].location, user.locality);

    if(dow===0 || dow===6) weekendDays++;
    freeDays--;

    if(d.mode==='mixto'){
      const topCat=SHIFTS[d.t]?.cat, botCat=SHIFTS[d.b]?.cat;
      const topWork=(topCat==='hosp'||topCat==='sena');
      const botWork=(botCat==='hosp'||botCat==='sena');
      if(isHoliday && (topWork||botWork)) holidayWorked++;

      if(topCat==='hosp') h += (d.hrsTop||calculateHours(d.tInTop||SHIFTS[d.t].in, d.tOutTop||SHIFTS[d.t].out));
      if(topCat==='sena') s += (d.hrsTop||calculateHours(d.tInTop||SHIFTS[d.t].in, d.tOutTop||SHIFTS[d.t].out));
      if(botCat==='hosp') h += (d.hrsBottom||calculateHours(d.tInBottom||SHIFTS[d.b].in, d.tOutBottom||SHIFTS[d.b].out));
      if(botCat==='sena') s += (d.hrsBottom||calculateHours(d.tInBottom||SHIFTS[d.b].in, d.tOutBottom||SHIFTS[d.b].out));
    } else {
      const cat=SHIFTS[d.s]?.cat;
      if(cat==='hosp'){ h += (d.h||0); if(isHoliday) holidayWorked++; }
      else if(cat==='sena'){ s += (d.h||0); if(isHoliday) holidayWorked++; }
      else if(cat==='off'){ freeDays++; if(d.s==='Vacaciones') vacDays++; }
    }
  });

  freeDays=Math.max(0,freeDays);
  const applicableHolidays = countApplicableHolidaysInMonth(year, monthIndex0, user.locality);

  // build HTML
  const temp=document.createElement('div');
  temp.style.position='fixed';
  temp.style.left='-9999px';
  temp.style.top='-9999px';
  temp.style.width='860px';
  temp.style.background='#fff';
  temp.style.padding='24px';
  temp.style.borderRadius='18px';
  temp.style.boxShadow='0 10px 30px rgba(0,0,0,.18)';

  temp.innerHTML = buildExportHTML(userKey, user.locality, year, monthIndex0, todayStr, h, s, freeDays, vacDays, weekendDays, holidayWorked, applicableHolidays, SHIFTS, user);
  document.body.appendChild(temp);

  const canvas = await html2canvas(temp, {scale:2, backgroundColor:'#ffffff', useCORS:true, logging:false});
  const url = canvas.toDataURL('image/png');
  document.body.removeChild(temp);
  return url;
}

function buildExportHTML(userKey, locality, year, monthIndex0, todayStr, h, s, freeDays, vacDays, weekendDays, holidayWorked, applicableHolidays, SHIFTS, user){
  const monthName=MONTHS[monthIndex0];
  const daysOfWeek=['LUN','MAR','MIÃ‰','JUE','VIE','SÃB','DOM'];
  const firstDay = new Date(year, monthIndex0, 1).getDay();
  const firstDayMonday = firstDay===0?6:firstDay-1;
  const lastDate = new Date(year, monthIndex0+1, 0).getDate();
  const prevLastDate = new Date(year, monthIndex0, 0).getDate();

  let html = `
    <div style="font-family:system-ui,-apple-system,sans-serif;">
      <div style="text-align:center;margin-bottom:18px;padding-bottom:14px;border-bottom:2px solid #e5e7eb;">
        <div style="font-size:30px;font-weight:900;color:#0f172a;">${escapeHTML(userKey)} - ${monthName} ${year}</div>
        <div style="font-size:12px;color:#64748b;font-weight:800;">Localidad: ${escapeHTML(locality||'San Salvador')} â€¢ Generado: ${todayStr}</div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px;background:linear-gradient(to right,#f0f9ff,#fefce8);padding:14px;border-radius:14px;">
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">ğŸ¥ HOSPITAL</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${h.toFixed(1)} HRS</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">ğŸŒ™ CENA</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${s.toFixed(1)} HRS</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">ğŸ˜´ LIBRES</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${freeDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">ğŸ–ï¸ VAC</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${vacDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">ğŸ‰ ASUETOS (APLICAN)</div>
          <div style="font-size:20px;font-weight:900;color:#dc2626;">${applicableHolidays} / Trab. ${holidayWorked}</div>
        </div>
      </div>

      <div style="margin-bottom:14px;">
        <div style="font-size:14px;font-weight:900;color:#334155;margin-bottom:10px;text-align:center;">CALENDARIO</div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;background:#e5e7eb;border:1px solid #e5e7eb;">
          ${daysOfWeek.map((d,i)=>{
            const c = (d==='DOM') ? '#ef4444' : (d==='SÃB' ? '#3b82f6' : '#64748b');
            return `<div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:11px;color:${c};">${d}</div>`;
          }).join('')}
  `;

  // prev
  for(let i=firstDayMonday;i>0;i--){
    const prevDay=prevLastDate-i+1;
    html += `<div style="background:#f9fafb;height:82px;position:relative;opacity:.3;"><span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;color:#374151;">${prevDay}</span></div>`;
  }

  // month days
  for(let d=1; d<=lastDate; d++){
    const key = dayKey(year, monthIndex0+1, d);
    const info = user.data[key] || {mode:'simple', s:'L'};
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);

    if(info.mode==='mixto'){
      const topC = SHIFTS[info.t]?.color || 'L';
      const botC = SHIFTS[info.b]?.color || 'L';
      const topL = SHIFTS[info.t]?.label || 'L';
      const botL = SHIFTS[info.b]?.label || 'L';

      html += `
        <div style="height:82px;position:relative;">
          <div style="height:50%;background:${getColorValue(topC)};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;text-transform:uppercase;border-bottom:1px solid rgba(0,0,0,.1);">${escapeHTML(topL)}</div>
          <div style="height:50%;background:${getColorValue(botC)};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;text-transform:uppercase;">${escapeHTML(botL)}</div>
          <span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;color:#374151;">${d}</span>
          ${isHoliday?`<span style="position:absolute;top:0;left:0;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,.9);padding:1px 4px;border-bottom-right-radius:8px;">A</span>`:''}
        </div>
      `;
    } else {
      const c = SHIFTS[info.s]?.color || 'L';
      const l = SHIFTS[info.s]?.label || 'L';
      html += `
        <div style="height:82px;position:relative;background:${getColorValue(c)};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;text-transform:uppercase;">
          ${escapeHTML(l)}
          <span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;color:#374151;">${d}</span>
          ${isHoliday?`<span style="position:absolute;top:0;left:0;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,.9);padding:1px 4px;border-bottom-right-radius:8px;">A</span>`:''}
        </div>
      `;
    }
  }

  // next filler
  const total = firstDayMonday + lastDate;
  for(let i=1;i<=(42-total);i++){
    html += `<div style="background:#f9fafb;height:82px;position:relative;opacity:.3;"><span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;color:#374151;">${i}</span></div>`;
  }

  // legend
  html += `
        </div>
      </div>

      <div style="margin-top:16px;border-top:2px solid #e5e7eb;padding-top:12px;">
        <div style="font-size:12px;font-weight:900;color:#334155;margin-bottom:8px;">LEYENDA</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
          ${Object.keys(SHIFTS).slice(0,18).map(k=>{
            const sh=SHIFTS[k];
            return `
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:14px;height:14px;border-radius:4px;background:${getColorValue(sh.color)};border:1px solid #d1d5db;"></div>
                <div style="font-size:10px;font-weight:800;color:#334155;">${escapeHTML(sh.label||k)}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
  return html;
}

/* =========================================================
   Export scope user list box toggle
========================================================= */
function showExportUsersIfNeeded(){
  const v=document.querySelector('input[name="exportScope"]:checked').value;
  document.getElementById('exportUsersBox').classList.toggle('hidden', v!=='select');
}

/* =========================================================
   Utility escape
========================================================= */
function cssSafe(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g,'_'); }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }
function toISODate(y,m,d){
  y=String(y).padStart(4,'0');
  m=String(m).padStart(2,'0');
  d=String(d).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

/* =========================================================
   Start
========================================================= */
document.addEventListener('DOMContentLoaded', ()=>{
  init();
  // export modal: show/hide list based on radio
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.name==='exportScope') showExportUsersIfNeeded();
  });
});
</script>

</body>
</html>

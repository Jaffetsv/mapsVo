<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shifter Web Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #1a1c23; color: white; font-family: sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #374151; }
        .day-cell { background-color: #d1d5db; height: 95px; position: relative; color: #1f2937; padding: 2px; cursor: pointer; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Turno Mixto Dividido */
        .shift-Mixto { background: linear-gradient(to bottom, #fef9c3 50%, #fbcfe8 50%) !important; }
        .shift-Mañana { background-color: #fef9c3 !important; }
        .shift-Tarde { background-color: #fbcfe8 !important; }
        .shift-Noche { background-color: #99f6e4 !important; }
        .shift-Libre { background-color: #dcfce7 !important; }
        .shift-Vacaciones { background-color: #fed7aa !important; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; z-index: 100; padding: 10px; }
        .modal.active { display: flex; }
        .shift-opt { padding: 10px; margin-bottom: 5px; border-radius: 8px; font-weight: bold; text-align: center; border: 2px solid transparent; cursor: pointer; }
        .selected-opt { border-color: #ef4444; transform: scale(1.02); }
    </style>
</head>
<body>

    <div class="p-4 flex justify-between items-center bg-[#1f2937]">
        <h1 id="monthYear" class="text-lg font-bold uppercase tracking-tighter"></h1>
        <div class="flex gap-4">
            <button onclick="changeMonth(-1)">❮</button>
            <button onclick="changeMonth(1)">❯</button>
        </div>
    </div>

    <div id="gridHeaders" class="calendar-grid text-center text-[10px] font-bold py-1 bg-[#1f2937] text-gray-400">
        <div>DOM</div><div>LUN</div><div>MAR</div><div>MIÉ</div><div>JUE</div><div>VIE</div><div>SÁB</div>
    </div>
    <div id="calendarDays" class="calendar-grid"></div>

    <div id="editModal" class="modal">
        <div class="bg-[#2d333b] w-full max-w-md rounded-2xl p-4 shadow-2xl">
            <h2 class="text-center font-bold mb-4 text-gray-300">EDITAR DÍA <span id="selectedDateText"></span></h2>
            
            <div id="optionsList" class="grid grid-cols-2 gap-2 mb-4">
                <div onclick="selectType('Mañana')" id="opt-Mañana" class="shift-opt shift-Mañana text-black">Mañana</div>
                <div onclick="selectType('Tarde')" id="opt-Tarde" class="shift-opt shift-Tarde text-black">Tarde</div>
                <div onclick="selectType('Noche')" id="opt-Noche" class="shift-opt shift-Noche text-black">Noche</div>
                <div onclick="selectType('Mixto')" id="opt-Mixto" class="shift-opt shift-Mixto text-black">Mixto</div>
                <div onclick="selectType('Libre')" id="opt-Libre" class="shift-opt shift-Libre text-black">Libre</div>
                <div onclick="selectType('Vacaciones')" id="opt-Vacaciones" class="shift-opt shift-Vacaciones text-black">Vacaciones</div>
            </div>

            <textarea id="noteInput" placeholder="Añadir comentario o nota..." class="w-full p-3 bg-[#1a1c23] border border-gray-600 rounded-lg mb-4 text-white"></textarea>

            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 p-3 bg-gray-600 rounded-xl font-bold">CANCELAR</button>
                <button onclick="saveData()" id="btnAceptar" class="flex-1 p-3 bg-emerald-500 rounded-xl font-bold text-emerald-950 text-center">ACEPTAR</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN DE SUPABASE (PEGA TUS DATOS AQUÍ)
        const SB_URL = "TU_URL_DE_SUPABASE_AQUI";
        const SB_KEY = "TU_KEY_DE_SUPABASE_AQUI";
        const supabase = supabase.createClient(SB_URL, SB_KEY);

        let currentNavDate = new Date();
        let selectedDayKey = "";
        let selectedType = "";
        let allShifts = {};

        async function fetchShifts() {
            const { data } = await supabase.from('turnos').select('*');
            allShifts = {};
            data.forEach(s => allShifts[s.fecha] = { tipo: s.tipo, notas: s.notas });
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarDays');
            grid.innerHTML = '';
            const y = currentNavDate.getFullYear();
            const m = currentNavDate.getMonth();
            
            document.getElementById('monthYear').innerText = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(currentNavDate);

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="day-cell opacity-20"></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const key = `${y}-${m+1}-${d}`;
                const shift = allShifts[key] || { tipo: '', notas: '' };
                const cell = document.createElement('div');
                cell.className = `day-cell shift-${shift.tipo}`;
                cell.innerHTML = `
                    <span class="text-xs font-bold">${d}</span>
                    <div class="flex-1 flex items-center justify-center text-[10px] font-bold text-center px-1">
                        ${shift.tipo === 'Mixto' ? 'M / T' : shift.tipo}
                    </div>
                    <div class="text-[8px] bg-black/20 truncate">${shift.notas || ''}</div>
                `;
                cell.onclick = () => openModal(key, shift);
                grid.appendChild(cell);
            }
        }

        function openModal(key, data) {
            selectedDayKey = key;
            selectedType = data.tipo;
            document.getElementById('selectedDateText').innerText = key;
            document.getElementById('noteInput').value = data.notas || '';
            document.querySelectorAll('.shift-opt').forEach(el => el.classList.remove('selected-opt'));
            if(data.tipo) document.getElementById('opt-'+data.tipo)?.classList.add('selected-opt');
            document.getElementById('editModal').classList.add('active');
        }

        function selectType(t) {
            selectedType = t;
            document.querySelectorAll('.shift-opt').forEach(el => el.classList.remove('selected-opt'));
            document.getElementById('opt-'+t).classList.add('selected-opt');
        }

        async function saveData() {
            const btn = document.getElementById('btnAceptar');
            btn.innerText = "GUARDANDO...";
            const notas = document.getElementById('noteInput').value;

            const { error } = await supabase.from('turnos').upsert({ 
                fecha: selectedDayKey, 
                tipo: selectedType, 
                notas: notas 
            }, { onConflict: 'fecha' });

            if (!error) {
                await fetchShifts();
                closeModal();
            }
            btn.innerText = "ACEPTAR";
        }

        function closeModal() { document.getElementById('editModal').classList.remove('active'); }
        function changeMonth(step) { currentNavDate.setMonth(currentNavDate.getMonth() + step); renderCalendar(); }

        fetchShifts();
    </script>
</body>
</html>

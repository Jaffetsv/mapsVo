<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shifter Multi-User Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; color: #1f2937; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
        .day-cell { background-color: #ffffff; height: 110px; position: relative; cursor: pointer; display: flex; flex-direction: column; overflow: hidden; }
        .day-off-month { background-color: #f9fafb !important; opacity: 0.4; pointer-events: none; }
        .day-number { font-size: 10px; font-weight: 800; padding: 2px 5px; position: absolute; top: 0; right: 0; z-index: 10; color: #9ca3af; }
        
        /* Colores Din√°micos */
        .bg-Ma√±ana { background-color: #ffff00 !important; }
        .bg-Tarde { background-color: #fbcfe8 !important; }
        .bg-CENA { background-color: #d8b4fe !important; }
        .bg-16hrs { background-color: #bef264 !important; }
        .bg-L { background-color: #ffffff !important; }
        .bg-Vacaciones { background-color: #fed7aa !important; }

        .shift-label { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; text-transform: uppercase; text-align: center; line-height: 1; padding: 2px; }
        .note-text { font-size: 9px; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: #000; font-weight: 700; background: rgba(255,255,255,0.7); border-radius: 4px; white-space: nowrap; overflow: hidden; }

        .view-section { display: none; }
        .view-active { display: block; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 100; padding: 20px; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        
        select, input { border-radius: 12px; padding: 10px; font-weight: 700; outline: none; border: 1px solid #e5e7eb; }
    </style>
</head>
<body>

    <div class="bg-[#1e293b] text-white p-4 shadow-xl">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üìÖ</span>
                <div>
                    <select id="userSelect" onchange="switchUser()" class="bg-transparent border-none text-lg font-black p-0 focus:ring-0"></select>
                    <p id="editStatus" class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest">Modo Vista</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openUserModal()" class="bg-blue-500 text-[10px] px-3 py-2 rounded-lg font-black uppercase">+ Usuario</button>
                <button id="unlockBtn" onclick="askPIN()" class="bg-gray-700 text-[10px] px-3 py-2 rounded-lg font-black uppercase">üîì Editar</button>
            </div>
        </div>

        <div class="flex items-center justify-between bg-white/10 rounded-2xl p-2">
            <button onclick="changeMonth(-1)" class="p-2">‚ùÆ</button>
            <div class="flex gap-2">
                <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none text-xs uppercase font-bold"></select>
                <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none text-xs font-bold"></select>
            </div>
            <button onclick="changeMonth(1)" class="p-2">‚ùØ</button>
        </div>
    </div>

    <div class="flex bg-white border-b shadow-sm">
        <button onclick="showView('calendar')" id="tab-cal" class="flex-1 py-4 text-[10px] font-black uppercase border-b-2 border-blue-600 text-blue-600">Calendario</button>
        <button onclick="showView('summary')" id="tab-sum" class="flex-1 py-4 text-[10px] font-black uppercase text-gray-400">Resumen</button>
        <button onclick="showView('settings')" id="tab-set" class="flex-1 py-4 text-[10px] font-black uppercase text-gray-400">Ajustes</button>
    </div>

    <div id="calendar-view" class="view-section view-active">
        <div class="grid grid-cols-7 text-center text-[10px] font-black py-2 bg-gray-200 text-gray-500">
            <div>DOM</div><div>LUN</div><div>MAR</div><div>MI√â</div><div>JUE</div><div>VIE</div><div>S√ÅB</div>
        </div>
        <div id="calendar" class="calendar-grid"></div>
    </div>

    <div id="summary-view" class="view-section p-4 space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-3xl shadow-sm border-t-8 border-yellow-400 text-center">
                <p class="text-[9px] font-black text-gray-400 uppercase">Hospital</p>
                <h3 id="res-hosp" class="text-2xl font-black">0 HRS</h3>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border-t-8 border-purple-400 text-center">
                <p class="text-[9px] font-black text-gray-400 uppercase">CENA</p>
                <h3 id="res-cena" class="text-2xl font-black">0 HRS</h3>
            </div>
        </div>
        <div class="bg-emerald-500 p-6 rounded-3xl text-white shadow-lg text-center">
            <p class="text-[10px] font-black uppercase opacity-80">D√≠as de Descanso Totales</p>
            <h2 id="res-off" class="text-5xl font-black">0</h2>
            <p class="text-[9px] mt-1 font-bold">(Libres + Vacaciones)</p>
        </div>
    </div>

    <div id="settings-view" class="view-section p-6">
        <h2 class="font-black mb-4 uppercase">Configurar Turnos del Usuario</h2>
        <div id="shiftsConfig" class="space-y-3"></div>
        <button onclick="saveGlobalConfig()" class="w-full mt-6 bg-blue-600 text-white p-4 rounded-2xl font-black uppercase">Guardar Configuraci√≥n</button>
    </div>

    <div id="userModal" class="modal">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl">
            <h3 class="font-black text-center mb-4 uppercase">Nuevo Usuario</h3>
            <input type="text" id="newUserName" placeholder="Nombre (ej: Alex)" class="w-full mb-3">
            <input type="password" id="newUserPIN" placeholder="PIN de 4 d√≠gitos" class="w-full mb-6" maxlength="4">
            <div class="flex gap-2">
                <button onclick="closeUserModal()" class="flex-1 p-3 bg-gray-100 rounded-xl font-bold uppercase text-xs">Cerrar</button>
                <button onclick="createUser()" class="flex-1 p-3 bg-blue-600 text-white rounded-xl font-bold uppercase text-xs">Crear</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="bg-white w-full max-w-md rounded-[40px] overflow-hidden">
            <div id="modalHeader" class="bg-blue-600 p-4 text-white text-center font-black text-xs uppercase"></div>
            <div class="p-6">
                <div id="shiftGrid" class="grid grid-cols-3 gap-2 mb-6"></div>
                <div class="bg-gray-50 p-4 rounded-2xl mb-4 flex justify-between items-center">
                    <input type="time" id="tIn" onchange="autoCalc()" class="w-24">
                    <span class="font-black">‚Üí</span>
                    <input type="time" id="tOut" onchange="autoCalc()" class="w-24">
                </div>
                <div class="flex justify-between items-center mb-4 px-2">
                    <span class="text-[10px] font-black uppercase text-gray-400">Total Horas</span>
                    <input type="number" id="tHrs" class="w-20 text-center font-black text-blue-600 border-none bg-transparent text-xl">
                </div>
                <textarea id="nota" placeholder="Notas..." class="w-full p-4 bg-gray-100 border-none rounded-2xl h-20 mb-4 font-bold"></textarea>
                <div class="flex gap-2">
                    <button onclick="closeModal()" class="flex-1 p-4 bg-gray-100 rounded-2xl font-black uppercase text-[10px]">Cancelar</button>
                    <button onclick="saveDay()" class="flex-1 p-4 bg-emerald-500 text-white rounded-2xl font-black uppercase text-[10px]">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- MOTOR DE DATOS ---
        let state = JSON.parse(localStorage.getItem('shifter_v8')) || {
            users: {
                'Admin': { pin: '1234', data: {}, config: {
                    'Ma√±ana': { label: 'Ma√±ana', cat: 'hosp', color: 'Ma√±ana', in: '08:00', out: '14:00' },
                    'Tarde': { label: 'Tarde', cat: 'hosp', color: 'Tarde', in: '14:00', out: '21:00' },
                    'CENA': { label: 'CENA', cat: 'sena', color: 'CENA', in: '21:00', out: '07:00' },
                    '16hrs': { label: '16hrs', cat: 'hosp', color: '16hrs', in: '07:00', out: '23:00' },
                    'L': { label: 'L', cat: 'off', color: 'L', in: '00:00', out: '00:00' },
                    'Vacaciones': { label: 'Vacaciones', cat: 'off', color: 'Vacaciones', in: '00:00', out: '00:00' }
                }}
            },
            currentUser: 'Admin'
        };

        let currentMode = 'view'; // view | edit
        let activeDate = new Date();
        let selectedShift = 'L';

        // --- INICIALIZACI√ìN ---
        function init() {
            const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            const mSel = document.getElementById('selectMonth');
            const ySel = document.getElementById('selectYear');
            
            mSel.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            for(let y=2024; y<=2035; y++) ySel.innerHTML += `<option value="${y}">${y}</option>`;
            
            updateUserList();
            render();
        }

        function updateUserList() {
            const sel = document.getElementById('userSelect');
            sel.innerHTML = Object.keys(state.users).map(u => `<option value="${u}" ${u===state.currentUser?'selected':''}>${u.toUpperCase()}</option>`).join('');
        }

        function switchUser() {
            state.currentUser = document.getElementById('userSelect').value;
            currentMode = 'view';
            updateUIState();
            render();
        }

        function updateUIState() {
            const status = document.getElementById('editStatus');
            const unlock = document.getElementById('unlockBtn');
            if(currentMode === 'edit') {
                status.innerText = "Modo Edici√≥n";
                status.className = "text-[10px] text-emerald-400 font-bold uppercase tracking-widest";
                unlock.innerText = "üîí Bloquear";
            } else {
                status.innerText = "Modo Vista";
                status.className = "text-[10px] text-gray-400 font-bold uppercase tracking-widest";
                unlock.innerText = "üîì Editar";
            }
        }

        function askPIN() {
            if(currentMode === 'edit') {
                currentMode = 'view';
                updateUIState();
                return;
            }
            const pin = prompt("Introduce el PIN de " + state.currentUser);
            if(pin === state.users[state.currentUser].pin) {
                currentMode = 'edit';
                updateUIState();
            } else {
                alert("PIN Incorrecto");
            }
        }

        // --- CALENDARIO ---
        function render() {
            const grid = document.getElementById('calendar');
            grid.innerHTML = '';
            const y = activeDate.getFullYear(), m = activeDate.getMonth();
            
            document.getElementById('selectMonth').value = m;
            document.getElementById('selectYear').value = y;

            const firstDay = new Date(y, m, 1).getDay();
            const lastDate = new Date(y, m + 1, 0).getDate();
            const prevLastDate = new Date(y, m, 0).getDate();

            // D√≠as mes anterior (Sombreados)
            for(let i = firstDay; i > 0; i--) {
                grid.innerHTML += `<div class="day-cell day-off-month">
                    <span class="day-number">${prevLastDate - i + 1}</span>
                </div>`;
            }

            // D√≠as mes actual
            const userData = state.users[state.currentUser].data;
            const config = state.users[state.currentUser].config;

            for(let d = 1; d <= lastDate; d++) {
                const key = `${y}-${m+1}-${d}`;
                const dayData = userData[key] || { s: 'L' };
                const cell = document.createElement('div');
                cell.className = `day-cell bg-${config[dayData.s].color}`;
                cell.innerHTML = `<span class="day-number" style="color:#000">${d}</span>
                                 <div class="shift-label">${dayData.s === 'L' ? 'L' : config[dayData.s].label}</div>`;
                
                if(dayData.n) cell.innerHTML += `<div class="note-text">${dayData.n}</div>`;
                
                cell.onclick = () => openDay(key, dayData);
                grid.appendChild(cell);
            }

            // D√≠as mes siguiente (Relleno)
            const totalCells = firstDay + lastDate;
            const extra = 42 - totalCells;
            for(let i = 1; i <= extra; i++) {
                grid.innerHTML += `<div class="day-cell day-off-month">
                    <span class="day-number">${i}</span>
                </div>`;
            }

            calcSummary();
        }

        function openDay(key, data) {
            if(currentMode !== 'edit') {
                alert("Debes desbloquear la edici√≥n con el PIN.");
                return;
            }
            activeKey = key;
            const config = state.users[state.currentUser].config;
            const grid = document.getElementById('shiftGrid');
            grid.innerHTML = '';
            
            Object.keys(config).forEach(k => {
                const b = document.createElement('div');
                b.className = `p-3 rounded-xl text-[9px] font-black text-center cursor-pointer border-2 bg-${config[k].color} ${data.s===k?'border-blue-600':'border-transparent'}`;
                b.innerText = config[k].label;
                b.onclick = () => selectShift(k);
                grid.appendChild(b);
            });

            document.getElementById('modalHeader').innerText = "EDITAR " + key;
            document.getElementById('tIn').value = data.in || config[data.s].in;
            document.getElementById('tOut').value = data.out || config[data.s].out;
            document.getElementById('tHrs').value = data.h || 0;
            document.getElementById('nota').value = data.n || '';
            selectedShift = data.s;
            document.getElementById('modal').classList.add('active');
        }

        function selectShift(k) {
            selectedShift = k;
            const conf = state.users[state.currentUser].config[k];
            document.getElementById('tIn').value = conf.in;
            document.getElementById('tOut').value = conf.out;
            autoCalc();
            // Refrescar bordes
            const btns = document.getElementById('shiftGrid').children;
            const keys = Object.keys(state.users[state.currentUser].config);
            keys.forEach((key, i) => {
                btns[i].classList.toggle('border-blue-600', key === k);
                btns[i].classList.toggle('border-transparent', key !== k);
            });
        }

        function autoCalc() {
            const start = document.getElementById('tIn').value;
            const end = document.getElementById('tOut').value;
            let [h1, m1] = start.split(':').map(Number);
            let [h2, m2] = end.split(':').map(Number);
            let diff = (h2 + m2/60) - (h1 + m1/60);
            if(diff < 0) diff += 24;
            document.getElementById('tHrs').value = diff.toFixed(1);
        }

        function saveDay() {
            state.users[state.currentUser].data[activeKey] = {
                s: selectedShift,
                in: document.getElementById('tIn').value,
                out: document.getElementById('tOut').value,
                h: parseFloat(document.getElementById('tHrs').value),
                n: document.getElementById('nota').value
            };
            saveToStorage();
            render();
            closeModal();
        }

        function calcSummary() {
            let hosp = 0, cena = 0, off = 0;
            const y = activeDate.getFullYear(), m = activeDate.getMonth() + 1;
            const data = state.users[state.currentUser].data;
            const config = state.users[state.currentUser].config;

            Object.keys(data).forEach(k => {
                if(k.startsWith(`${y}-${m}-`)) {
                    const d = data[k];
                    const cat = config[d.s].cat;
                    if(cat === 'hosp') hosp += d.h;
                    if(cat === 'sena') cena += d.h;
                    if(cat === 'off') off += 1;
                }
            });
            document.getElementById('res-hosp').innerText = hosp.toFixed(1) + " HRS";
            document.getElementById('res-cena').innerText = cena.toFixed(1) + " HRS";
            document.getElementById('res-off').innerText = off;
        }

        // --- USUARIOS ---
        function openUserModal() { document.getElementById('userModal').classList.add('active'); }
        function closeUserModal() { document.getElementById('userModal').classList.remove('active'); }

        function createUser() {
            const name = document.getElementById('newUserName').value.trim();
            const pin = document.getElementById('newUserPIN').value;
            if(!name || pin.length < 4) return alert("Datos incompletos");
            
            state.users[name] = {
                pin: pin,
                data: {},
                config: JSON.parse(JSON.stringify(state.users['Admin'].config)) // Copia base
            };
            state.currentUser = name;
            currentMode = 'edit';
            saveToStorage();
            updateUserList();
            updateUIState();
            render();
            closeUserModal();
        }

        // --- UTILIDADES ---
        function saveToStorage() { localStorage.setItem('shifter_v8', JSON.stringify(state)); }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        function changeMonth(v) { activeDate.setMonth(activeDate.getMonth() + v); render(); }
        function jumpToDate() {
            activeDate.setMonth(document.getElementById('selectMonth').value);
            activeDate.setFullYear(document.getElementById('selectYear').value);
            render();
        }
        function showView(v) {
            ['calendar','summary','settings'].forEach(id => {
                document.getElementById(id+'-view').classList.toggle('view-active', id===v);
                document.getElementById('tab-'+id.slice(0,3)).classList.toggle('text-blue-600', id===v);
                document.getElementById('tab-'+id.slice(0,3)).classList.toggle('border-blue-600', id===v);
            });
        }

        init();
    </script>
</body>
</html>

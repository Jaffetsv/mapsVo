<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shifter Pro v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; color: #1f2937; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; }
        .day-cell { background-color: #ffffff; min-height: 110px; position: relative; cursor: pointer; display: flex; flex-direction: column; transition: 0.1s; }
        .day-cell:active { background-color: #f3f4f6; }
        .day-off-month { background-color: #f9fafb !important; opacity: 0.3; pointer-events: none; }
        .day-number { font-size: 11px; font-weight: 800; padding: 4px 6px; color: #374151; z-index: 10; }
        
        /* Colores de Turnos - FIXED: Asegurar que Tailwind los procese */
        .bg-Ma√±ana { background-color: #ffff00 !important; }
        .bg-Tarde { background-color: #fbcfe8 !important; }
        .bg-CENA { background-color: #d8b4fe !important; }
        .bg-16hrs { background-color: #bef264 !important; }
        .bg-L { background-color: #ffffff !important; }
        .bg-Vacaciones { background-color: #fed7aa !important; }

        .shift-label { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; text-transform: uppercase; text-align: center; pointer-events: none; }
        .note-indicator { font-size: 9px; background: rgba(255,255,255,0.8); margin: 2px; border-radius: 4px; padding: 2px; text-align: center; font-weight: 800; border: 1px solid rgba(0,0,0,0.05); }

        .view-section { display: none; }
        .view-active { display: block; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000; padding: 20px; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        
        .tab-btn { flex: 1; padding: 15px; font-size: 10px; font-weight: 900; text-transform: uppercase; border-bottom: 3px solid transparent; color: #9ca3af; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; background: #f8fafc; }
        
        input, select, textarea { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; font-weight: 700; width: 100%; }
        
        /* Estilos para botones del modal */
        .shift-btn { transition: all 0.2s; border-width: 2px; }
        .shift-btn.selected { transform: scale(1.05); border-color: #2563eb !important; opacity: 1 !important; }
        .shift-btn:not(.selected) { opacity: 0.6; border-color: transparent !important; }
    </style>
</head>
<body>

    <div class="bg-[#1e293b] text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <div>
                <select id="userSelect" onchange="switchUser()" class="bg-transparent border-none text-xl font-black p-0 focus:ring-0 w-auto text-white"></select>
                <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400">Modo Vista</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openUserModal()" class="bg-blue-600 px-3 py-2 rounded-xl text-[10px] font-black uppercase">+ Perfil</button>
                <button id="unlockBtn" onclick="toggleEditMode()" class="bg-slate-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase">üîì Editar</button>
            </div>
        </div>

        <div class="flex items-center justify-between bg-slate-800 rounded-2xl p-1">
            <button onclick="changeMonth(-1)" class="p-3">‚ùÆ</button>
            <div class="flex gap-2 font-bold text-xs uppercase">
                <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 w-auto"></select>
                <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 w-auto"></select>
            </div>
            <button onclick="changeMonth(1)" class="p-3">‚ùØ</button>
        </div>
    </div>

    <div class="flex bg-white shadow-sm sticky top-[135px] z-40">
        <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn active">Calendario</button>
        <button onclick="showView('summary')" id="tab-summary" class="tab-btn">Resumen</button>
        <button onclick="showView('settings')" id="tab-settings" class="tab-btn">Ajustes</button>
    </div>

    <div id="view-calendar" class="view-section view-active">
        <div class="grid grid-cols-7 text-center text-[9px] font-black py-2 bg-gray-50 text-gray-400">
            <div>DOM</div><div>LUN</div><div>MAR</div><div>MI√â</div><div>JUE</div><div>VIE</div><div>S√ÅB</div>
        </div>
        <div id="calendarContainer" class="calendar-grid"></div>
    </div>

    <div id="view-summary" class="view-section p-5 space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-yellow-400">
                <p class="text-[10px] font-black text-gray-400 uppercase">Hospital</p>
                <h3 id="res-hosp" class="text-3xl font-black">0.0h</h3>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-purple-400">
                <p class="text-[10px] font-black text-gray-400 uppercase">CENA</p>
                <h3 id="res-cena" class="text-3xl font-black">0.0h</h3>
            </div>
        </div>
        <div class="bg-emerald-500 p-8 rounded-[40px] text-white text-center shadow-xl">
            <p class="text-xs font-black uppercase opacity-80 mb-2">D√≠as de Descanso Totales</p>
            <h2 id="res-off" class="text-6xl font-black">0</h2>
            <p class="text-[10px] font-bold mt-2 opacity-70">LIBRES + VACACIONES</p>
        </div>
    </div>

    <div id="view-settings" class="view-section p-6">
        <div class="bg-blue-50 p-5 rounded-3xl border border-blue-100 mb-6">
            <h4 class="text-[10px] font-black uppercase text-blue-600 mb-3">Seguridad</h4>
            <label class="text-[10px] font-bold text-gray-400 block mb-1">CAMBIAR PIN (4 d√≠gitos)</label>
            <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="bg-white">
        </div>
        <div id="settingsList" class="space-y-3"></div>
        <button onclick="saveProfileSettings()" class="w-full mt-8 bg-blue-600 text-white p-5 rounded-3xl font-black uppercase">Guardar Cambios</button>
    </div>

    <div id="dayModal" class="modal">
        <div class="bg-white w-full max-w-md rounded-[45px] overflow-hidden shadow-2xl">
            <div id="modalHeader" class="bg-blue-600 p-5 text-white text-center font-black text-xs uppercase tracking-widest">Editar D√≠a</div>
            <div class="p-6">
                <div id="modalShifts" class="grid grid-cols-3 gap-2 mb-6"></div>
                <div class="bg-gray-100 p-5 rounded-3xl flex justify-between items-center mb-4">
                    <input type="time" id="editIn" onchange="calcEditHours()" class="w-24 text-center bg-transparent border-none">
                    <span class="text-gray-300">‚Üí</span>
                    <input type="time" id="editOut" onchange="calcEditHours()" class="w-24 text-center bg-transparent border-none">
                </div>
                <div class="flex justify-between items-center mb-6 px-2">
                    <span class="text-[10px] font-black uppercase text-gray-400">Total Horas</span>
                    <input type="number" id="editHrs" step="0.5" class="w-20 text-right font-black text-blue-600 bg-transparent border-none text-2xl">
                </div>
                <textarea id="editNote" placeholder="Notas del d√≠a..." class="h-20 bg-gray-50 mb-6"></textarea>
                <div class="flex gap-3">
                    <button onclick="closeDayModal()" class="flex-1 p-5 bg-gray-100 text-gray-400 rounded-3xl font-black uppercase text-xs">Cancelar</button>
                    <button onclick="saveDayData()" class="flex-1 p-5 bg-emerald-500 text-white rounded-3xl font-black uppercase text-xs shadow-lg shadow-emerald-200">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="bg-white w-full max-w-xs rounded-[40px] p-8 shadow-2xl">
            <h3 class="font-black text-center uppercase mb-6">Nuevo Perfil</h3>
            <input type="text" id="newUserName" placeholder="Nombre" class="mb-3">
            <input type="password" id="newUserPin" placeholder="PIN" maxlength="4" class="mb-6">
            <button onclick="createNewUser()" class="w-full p-4 bg-blue-600 text-white rounded-2xl font-black uppercase text-xs">Crear</button>
            <button onclick="closeUserModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px]">Cerrar</button>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('shifter_v12')) || {
            users: {
                'ADMIN': {
                    pin: '1234',
                    data: {},
                    config: {
                        'Ma√±ana': { label: 'Ma√±ana', cat: 'hosp', color: 'Ma√±ana', in: '08:00', out: '14:00', h: 6 },
                        'Tarde': { label: 'Tarde', cat: 'hosp', color: 'Tarde', in: '14:00', out: '21:00', h: 7 },
                        'CENA': { label: 'CENA', cat: 'sena', color: 'CENA', in: '21:00', out: '07:00', h: 10 },
                        '16hrs': { label: '16hrs', cat: 'hosp', color: '16hrs', in: '07:00', out: '23:00', h: 16 },
                        'L': { label: 'L', cat: 'off', color: 'L', in: '00:00', out: '00:00', h: 0 },
                        'Vacaciones': { label: 'Vacaciones', cat: 'off', color: 'Vacaciones', in: '00:00', out: '00:00', h: 0 }
                    }
                }
            },
            current: 'ADMIN'
        };

        let isEditMode = false;
        let activeDate = new Date();
        let editingKey = null;
        let editingShift = 'L';

        function init() {
            const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            const mSel = document.getElementById('selectMonth');
            const ySel = document.getElementById('selectYear');
            mSel.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            for(let y=2024; y<=2035; y++) ySel.innerHTML += `<option value="${y}">${y}</option>`;
            updateUserDropdown();
            render();
        }

        function toggleEditMode() {
            if(isEditMode) {
                isEditMode = false;
                document.getElementById('editStatus').innerText = "MODO VISTA";
                document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-gray-400";
                document.getElementById('unlockBtn').innerText = "üîì Editar";
                document.getElementById('unlockBtn').className = "bg-slate-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase";
            } else {
                const p = prompt("PIN para editar " + db.current);
                if(p === db.users[db.current].pin) {
                    isEditMode = true;
                    document.getElementById('editStatus').innerText = "MODO EDICI√ìN ACTIVADO";
                    document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-emerald-400";
                    document.getElementById('unlockBtn').innerText = "üîí Bloquear";
                    document.getElementById('unlockBtn').className = "bg-emerald-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase";
                } else {
                    alert("PIN Incorrecto");
                }
            }
        }

        function render() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';
            const y = activeDate.getFullYear(), m = activeDate.getMonth();
            document.getElementById('selectMonth').value = m;
            document.getElementById('selectYear').value = y;

            const firstDay = new Date(y, m, 1).getDay();
            const lastDate = new Date(y, m + 1, 0).getDate();
            const prevLastDate = new Date(y, m, 0).getDate();

            for(let i = firstDay; i > 0; i--) {
                container.innerHTML += `<div class="day-cell day-off-month"><span class="day-number">${prevLastDate - i + 1}</span></div>`;
            }

            const user = db.users[db.current];
            for(let d = 1; d <= lastDate; d++) {
                const key = `${y}-${String(m+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const data = user.data[key] || { s: 'L' };
                const conf = user.config[data.s] || user.config['L'];
                const cell = document.createElement('div');
                cell.className = `day-cell bg-${conf.color}`;
                cell.innerHTML = `
                    <span class="day-number">${d}</span>
                    <div class="shift-label">${data.s === 'L' ? '' : conf.label}</div>
                    ${data.n ? `<div class="note-indicator">${data.n}</div>` : ''}
                `;
                cell.onclick = () => openDayEditor(key, d);
                container.appendChild(cell);
            }

            const total = firstDay + lastDate;
            for(let i = 1; i <= (42 - total); i++) {
                container.innerHTML += `<div class="day-cell day-off-month"><span class="day-number">${i}</span></div>`;
            }
            updateSummary();
        }

        function openDayEditor(key, dayNumber) {
            if(!isEditMode) {
                alert("Toca 'üîì EDITAR' e ingresa tu PIN para poder agregar turnos.");
                return;
            }
            
            editingKey = key;
            const user = db.users[db.current];
            const data = user.data[key] || { s: 'L', n: '', in: '', out: '', h: 0 };
            
            const grid = document.getElementById('modalShifts');
            grid.innerHTML = '';
            
            // Crear botones para todos los turnos disponibles
            Object.keys(user.config).forEach(k => {
                const conf = user.config[k];
                const isSelected = data.s === k;
                const btn = document.createElement('button');
                btn.className = `shift-btn p-3 rounded-xl text-[10px] font-black uppercase ${isSelected ? 'selected' : ''} bg-${conf.color}`;
                btn.innerText = conf.label;
                btn.dataset.shift = k;
                btn.onclick = function() {
                    selectShiftModal(k);
                };
                grid.appendChild(btn);
            });

            // Mostrar la fecha formateada
            const [year, month] = key.split('-');
            const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('modalHeader').innerText = `${dayNumber} de ${monthNames[parseInt(month)-1]} de ${year}`;
            
            // Configurar valores del modal
            document.getElementById('editIn').value = data.in || user.config[data.s].in;
            document.getElementById('editOut').value = data.out || user.config[data.s].out;
            document.getElementById('editHrs').value = data.h || user.config[data.s].h;
            document.getElementById('editNote').value = data.n || '';
            editingShift = data.s;
            
            document.getElementById('dayModal').classList.add('active');
        }

        function selectShiftModal(k) {
            editingShift = k;
            const user = db.users[db.current];
            const conf = user.config[k];
            
            // Actualizar campos con la configuraci√≥n del turno seleccionado
            document.getElementById('editIn').value = conf.in;
            document.getElementById('editOut').value = conf.out;
            document.getElementById('editHrs').value = conf.h;
            
            // Actualizar estado visual de los botones
            const btns = document.querySelectorAll('#modalShifts .shift-btn');
            btns.forEach(btn => {
                if(btn.dataset.shift === k) {
                    btn.classList.add('selected');
                    btn.classList.remove('opacity-60');
                } else {
                    btn.classList.remove('selected');
                    btn.classList.add('opacity-60');
                }
            });
        }

        function saveDayData() {
            if(!editingKey) return;
            
            db.users[db.current].data[editingKey] = {
                s: editingShift,
                in: document.getElementById('editIn').value,
                out: document.getElementById('editOut').value,
                h: parseFloat(document.getElementById('editHrs').value) || 0,
                n: document.getElementById('editNote').value
            };
            
            saveToDisk(); 
            render(); 
            closeDayModal();
        }

        function calcEditHours() {
            const inTime = document.getElementById('editIn').value;
            const outTime = document.getElementById('editOut').value;
            
            if(!inTime || !outTime) return;
            
            const [inHours, inMinutes] = inTime.split(':').map(Number);
            const [outHours, outMinutes] = outTime.split(':').map(Number);
            
            let diff = (outHours * 60 + outMinutes) - (inHours * 60 + inMinutes);
            if(diff < 0) diff += 24 * 60;
            
            document.getElementById('editHrs').value = (diff / 60).toFixed(1);
        }

        function renderSettings() {
            const container = document.getElementById('settingsList');
            container.innerHTML = '';
            const config = db.users[db.current].config;
            
            Object.keys(config).forEach(k => {
                if(k === 'L') return;
                const conf = config[k];
                container.innerHTML += `
                <div class="p-4 bg-white rounded-2xl border border-gray-200 space-y-3 mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded-full bg-${conf.color} flex-shrink-0"></div>
                        <input type="text" id="cfg-label-${k}" value="${conf.label}" 
                               class="text-sm font-black uppercase p-2 bg-gray-50 border border-gray-200 rounded-xl w-full">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 block mb-1">Entrada</label>
                            <input type="time" id="cfg-in-${k}" value="${conf.in}" 
                                   class="p-2 text-sm border border-gray-200 rounded-xl w-full">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 block mb-1">Salida</label>
                            <input type="time" id="cfg-out-${k}" value="${conf.out}" 
                                   class="p-2 text-sm border border-gray-200 rounded-xl w-full">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 block mb-1">Horas</label>
                            <input type="number" step="0.5" id="cfg-h-${k}" value="${conf.h}" 
                                   class="p-2 text-sm border border-gray-200 rounded-xl w-full">
                        </div>
                    </div>
                </div>`;
            });
        }

        function saveProfileSettings() {
            if(!isEditMode) {
                alert("Activa el modo edici√≥n para cambiar configuraciones.");
                return;
            }
            
            const user = db.users[db.current];
            Object.keys(user.config).forEach(k => {
                if(k === 'L') return;
                user.config[k].label = document.getElementById(`cfg-label-${k}`).value;
                user.config[k].in = document.getElementById(`cfg-in-${k}`).value;
                user.config[k].out = document.getElementById(`cfg-out-${k}`).value;
                user.config[k].h = parseFloat(document.getElementById(`cfg-h-${k}`).value);
            });
            
            const newPin = document.getElementById('changePinInput').value;
            if(newPin.length === 4) {
                user.pin = newPin;
                document.getElementById('changePinInput').value = '';
            }
            
            saveToDisk(); 
            render(); 
            alert("Configuraci√≥n guardada correctamente");
        }

        function updateSummary() {
            let h = 0, c = 0, off = 0;
            const y = activeDate.getFullYear(), m = activeDate.getMonth() + 1;
            const user = db.users[db.current];
            
            Object.keys(user.data).forEach(k => {
                if(k.startsWith(`${y}-${String(m).padStart(2, '0')}-`)) {
                    const d = user.data[k];
                    const conf = user.config[d.s];
                    if(conf.cat === 'hosp') h += (d.h || conf.h);
                    if(conf.cat === 'sena') c += (d.h || conf.h);
                    if(conf.cat === 'off') off++;
                }
            });
            
            document.getElementById('res-hosp').innerText = h.toFixed(1) + 'h';
            document.getElementById('res-cena').innerText = c.toFixed(1) + 'h';
            document.getElementById('res-off').innerText = off;
        }

        function createNewUser() {
            const name = document.getElementById('newUserName').value.trim().toUpperCase();
            const pin = document.getElementById('newUserPin').value;
            
            if(!name || name.length < 2) {
                alert("El nombre debe tener al menos 2 caracteres");
                return;
            }
            
            if(pin.length !== 4 || isNaN(pin)) {
                alert("El PIN debe ser de 4 d√≠gitos num√©ricos");
                return;
            }
            
            if(db.users[name]) {
                alert("Ya existe un usuario con ese nombre");
                return;
            }
            
            db.users[name] = JSON.parse(JSON.stringify(db.users['ADMIN']));
            db.users[name].pin = pin; 
            db.users[name].data = {}; 
            db.current = name;
            
            saveToDisk(); 
            updateUserDropdown(); 
            render(); 
            closeUserModal();
            
            alert("Usuario creado correctamente");
        }

        function switchUser() { 
            db.current = document.getElementById('userSelect').value; 
            isEditMode = false; 
            toggleEditMode(); 
            render(); 
        }
        
        function saveToDisk() { 
            localStorage.setItem('shifter_v12', JSON.stringify(db)); 
        }
        
        function closeDayModal() { 
            document.getElementById('dayModal').classList.remove('active'); 
            editingKey = null;
        }
        
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserPin').value = '';
        }
        
        function openUserModal() { 
            document.getElementById('userModal').classList.add('active'); 
        }
        
        function changeMonth(v) { 
            activeDate.setMonth(activeDate.getMonth() + v); 
            render(); 
        }
        
        function jumpToDate() { 
            activeDate.setMonth(parseInt(document.getElementById('selectMonth').value)); 
            activeDate.setFullYear(parseInt(document.getElementById('selectYear').value)); 
            render(); 
        }
        
        function updateUserDropdown() { 
            const select = document.getElementById('userSelect');
            select.innerHTML = Object.keys(db.users).map(u => 
                `<option value="${u}" ${u===db.current?'selected':''}>${u}</option>`
            ).join(''); 
        }
        
        function showView(v) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('view-active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('view-active');
            document.getElementById('tab-'+v).classList.add('active');
            if(v === 'settings') renderSettings();
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shifter Final Pro v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; color: #0f172a; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #cbd5e1; border: 1px solid #cbd5e1; }
        .day-cell { background: white; min-height: 100px; padding: 4px; position: relative; cursor: pointer; }
        .day-off { background: #f8fafc !important; opacity: 0.4; pointer-events: none; }
        .day-num { font-size: 11px; font-weight: 900; color: #64748b; }
        
        /* Colores */
        .bg-Ma√±ana { background-color: #ffff00 !important; }
        .bg-Tarde { background-color: #fbcfe8 !important; }
        .bg-CENA { background-color: #d8b4fe !important; }
        .bg-16hrs { background-color: #bef264 !important; }
        .bg-L { background-color: #ffffff !important; }
        .bg-Vacaciones { background-color: #fed7aa !important; }

        .shift-txt { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; text-transform: uppercase; text-align: center; }
        .note-dot { font-size: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; padding: 2px; margin-top: auto; font-weight: bold; overflow: hidden; white-space: nowrap; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; padding: 15px; }
        .modal-overlay.active { display: flex; }
        
        .tab-link { flex: 1; text-align: center; padding: 15px; font-size: 10px; font-weight: 900; color: #94a3b8; border-bottom: 3px solid transparent; }
        .tab-link.active { color: #2563eb; border-bottom-color: #2563eb; background: white; }
    </style>
</head>
<body>

    <div class="bg-[#1e293b] text-white p-4 sticky top-0 z-50">
        <div class="flex justify-between items-center mb-4">
            <div>
                <select id="userSelect" onchange="cambiarUsuario()" class="bg-transparent text-xl font-black border-none focus:ring-0 p-0"></select>
                <div id="statusTag" class="text-[9px] font-black px-2 py-0.5 rounded bg-gray-600 w-fit mt-1">MODO VISTA</div>
            </div>
            <div class="flex gap-2">
                <button onclick="abrirNuevoUsuario()" class="bg-blue-600 px-3 py-2 rounded-lg text-[10px] font-black uppercase">+ PERFIL</button>
                <button id="btnLock" onclick="manejarEdicion()" class="bg-slate-700 px-3 py-2 rounded-lg text-[10px] font-black uppercase">üîì EDITAR</button>
            </div>
        </div>
        <div class="flex items-center justify-between bg-slate-800 rounded-xl p-1">
            <button onclick="moverMes(-1)" class="p-2 px-4 text-xl">‚ùÆ</button>
            <div id="fechaTxt" class="font-black text-xs uppercase tracking-widest">ENERO 2025</div>
            <button onclick="moverMes(1)" class="p-2 px-4 text-xl">‚ùØ</button>
        </div>
    </div>

    <div class="flex bg-slate-50 sticky top-[125px] z-40 border-b">
        <button onclick="ver('cal')" id="tab-cal" class="tab-link active">CALENDARIO</button>
        <button onclick="ver('sum')" id="tab-sum" class="tab-link">RESUMEN</button>
        <button onclick="ver('set')" id="tab-set" class="tab-link">AJUSTES</button>
    </div>

    <div id="v-cal" class="block">
        <div class="grid grid-cols-7 text-center text-[9px] font-black py-2 bg-white text-slate-400">
            <div>DOM</div><div>LUN</div><div>MAR</div><div>MI√â</div><div>JUE</div><div>VIE</div><div>S√ÅB</div>
        </div>
        <div id="contenedorCal" class="calendar-grid"></div>
    </div>

    <div id="v-sum" class="hidden p-4 space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm"><p class="text-[10px] font-black text-slate-400">HOSPITAL</p><h3 id="h-hosp" class="text-2xl font-black">0h</h3></div>
            <div class="bg-white p-6 rounded-3xl shadow-sm"><p class="text-[10px] font-black text-slate-400">CENA</p><h3 id="h-cena" class="text-2xl font-black">0h</h3></div>
        </div>
        <div class="bg-emerald-500 p-10 rounded-[40px] text-white text-center shadow-xl">
            <p class="text-xs font-black opacity-80 uppercase">D√≠as de Descanso</p>
            <h2 id="h-desc" class="text-7xl font-black my-2">0</h2>
            <p class="text-[10px] font-bold">LIBRES + VACACIONES</p>
        </div>
    </div>

    <div id="v-set" class="hidden p-6 bg-white min-h-screen">
        <div class="bg-blue-50 p-5 rounded-2xl mb-6">
            <p class="text-[10px] font-black text-blue-600 mb-2 uppercase">Seguridad del Perfil</p>
            <input type="password" id="setPin" placeholder="Nuevo PIN de 4 d√≠gitos" maxlength="4" class="w-full p-3 rounded-xl border-none font-bold">
        </div>
        <div id="listaAjustes" class="space-y-3"></div>
        <button onclick="guardarAjustes()" class="w-full mt-8 bg-blue-600 text-white p-4 rounded-2xl font-black">GUARDAR CAMBIOS</button>
    </div>

    <div id="modalEditor" class="modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-[30px] overflow-hidden shadow-2xl">
            <div id="modTit" class="bg-blue-600 p-4 text-white text-center font-black text-xs uppercase">EDITAR D√çA</div>
            <div class="p-6">
                <div id="modBotones" class="grid grid-cols-3 gap-2 mb-6"></div>
                <div class="flex gap-2 mb-4">
                    <input type="time" id="modIn" class="flex-1 p-3 bg-gray-100 rounded-xl text-center font-bold border-none">
                    <input type="time" id="modOut" class="flex-1 p-3 bg-gray-100 rounded-xl text-center font-bold border-none">
                </div>
                <div class="flex justify-between items-center mb-6 px-2">
                    <span class="text-[10px] font-black text-gray-400">HORAS TOTALES</span>
                    <input type="number" id="modHrs" step="0.5" class="w-20 text-right font-black text-blue-600 text-2xl border-none">
                </div>
                <textarea id="modNota" placeholder="Notas..." class="w-full p-4 bg-gray-50 rounded-2xl border-none mb-6 h-20 font-bold"></textarea>
                <div class="flex gap-2">
                    <button onclick="cerrarModal()" class="flex-1 p-4 bg-gray-100 text-gray-400 rounded-2xl font-black text-xs">CANCELAR</button>
                    <button onclick="guardarDia()" class="flex-1 p-4 bg-emerald-500 text-white rounded-2xl font-black text-xs">GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalUser" class="modal-overlay">
        <div class="bg-white p-8 rounded-[30px] w-full max-w-xs text-center">
            <h3 class="font-black mb-6 uppercase">Nuevo Perfil</h3>
            <input type="text" id="newName" placeholder="Nombre" class="w-full p-3 bg-gray-100 rounded-xl mb-3 border-none font-bold">
            <input type="password" id="newPin" placeholder="PIN 4 d√≠gitos" maxlength="4" class="w-full p-3 bg-gray-100 rounded-xl mb-6 border-none font-bold">
            <button onclick="crearUsuario()" class="w-full p-4 bg-blue-600 text-white rounded-xl font-black mb-2">CREAR</button>
            <button onclick="this.parentElement.parentElement.classList.remove('active')" class="text-gray-400 font-bold text-xs uppercase">Cerrar</button>
        </div>
    </div>

    <script>
        let core = JSON.parse(localStorage.getItem('shifter_v12')) || {
            users: { 'ADMIN': { pin: '1234', data: {}, config: {
                'Ma√±ana': { label: 'Ma√±ana', cat: 'hosp', color: 'Ma√±ana', in: '08:00', out: '14:00', h: 6 },
                'Tarde': { label: 'Tarde', cat: 'hosp', color: 'Tarde', in: '14:00', out: '21:00', h: 7 },
                'CENA': { label: 'CENA', cat: 'sena', color: 'CENA', in: '21:00', out: '07:00', h: 10 },
                '16hrs': { label: '16hrs', cat: 'hosp', color: '16hrs', in: '07:00', out: '23:00', h: 16 },
                'L': { label: 'L', cat: 'off', color: 'L', in: '00:00', out: '00:00', h: 0 },
                'Vacaciones': { label: 'Vacaciones', cat: 'off', color: 'Vacaciones', in: '00:00', out: '00:00', h: 0 }
            }}},
            current: 'ADMIN'
        };

        let editHabilitado = false;
        let fechaAct = new Date();
        let diaEditando = null;
        let turnoEditando = 'L';

        function init() {
            actualizarDrowdown();
            dibujar();
        }

        function manejarEdicion() {
            if(editHabilitado) {
                editHabilitado = false;
            } else {
                const p = prompt("PIN de " + core.current);
                if(p === core.users[core.current].pin) {
                    editHabilitado = true;
                } else {
                    alert("PIN INCORRECTO");
                }
            }
            actualizarUIEdicion();
        }

        function actualizarUIEdicion() {
            const st = document.getElementById('statusTag');
            const bt = document.getElementById('btnLock');
            if(editHabilitado) {
                st.innerText = "MODO EDICI√ìN";
                st.className = "text-[9px] font-black px-2 py-0.5 rounded bg-emerald-500 w-fit mt-1";
                bt.innerText = "üîí BLOQUEAR";
                bt.className = "bg-emerald-600 px-3 py-2 rounded-lg text-[10px] font-black uppercase";
            } else {
                st.innerText = "MODO VISTA";
                st.className = "text-[9px] font-black px-2 py-0.5 rounded bg-gray-600 w-fit mt-1";
                bt.innerText = "üîì EDITAR";
                bt.className = "bg-slate-700 px-3 py-2 rounded-lg text-[10px] font-black uppercase";
            }
        }

        function dibujar() {
            const cont = document.getElementById('contenedorCal');
            cont.innerHTML = '';
            const y = fechaAct.getFullYear(), m = fechaAct.getMonth();
            const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
            document.getElementById('fechaTxt').innerText = `${meses[m]} ${y}`;

            const fD = new Date(y, m, 1).getDay();
            const lD = new Date(y, m + 1, 0).getDate();
            const pLD = new Date(y, m, 0).getDate();

            for(let i=fD; i>0; i--) cont.innerHTML += `<div class="day-cell day-off"><span class="day-num">${pLD-i+1}</span></div>`;

            const u = core.users[core.current];
            for(let d=1; d<=lD; d++) {
                const key = `${y}-${m+1}-${d}`;
                const info = u.data[key] || { s: 'L' };
                const conf = u.config[info.s] || u.config['L'];
                const div = document.createElement('div');
                div.className = `day-cell bg-${conf.color}`;
                div.innerHTML = `<span class="day-num">${d}</span><div class="shift-txt">${info.s==='L'?'':conf.label}</div>`;
                if(info.n) div.innerHTML += `<div class="note-dot">${info.n}</div>`;
                
                // EL FIX: Usar mousedown o click directo sin condiciones raras
                div.onclick = function() { clicsobredia(key); };
                cont.appendChild(div);
            }
            
            for(let i=1; (fD+lD+i)<=42; i++) cont.innerHTML += `<div class="day-cell day-off"><span class="day-num">${i}</span></div>`;
            resumen();
        }

        function clicsobredia(key) {
            if(!editHabilitado) {
                alert("Primero pulsa el bot√≥n 'üîì EDITAR' e ingresa tu PIN.");
                return;
            }
            diaEditando = key;
            const u = core.users[core.current];
            const info = u.data[key] || { s: 'L', n: '', in: '', out: '', h: 0 };
            
            const grid = document.getElementById('modBotones');
            grid.innerHTML = '';
            Object.keys(u.config).forEach(k => {
                const b = document.createElement('button');
                b.className = `p-3 rounded-xl text-[9px] font-black border-2 bg-${u.config[k].color} ${info.s===k?'border-blue-600 shadow-md':'border-transparent opacity-50'}`;
                b.innerText = u.config[k].label;
                b.onclick = () => seleccionarTurno(k);
                grid.appendChild(b);
            });

            document.getElementById('modIn').value = info.in || u.config[info.s].in;
            document.getElementById('modOut').value = info.out || u.config[info.s].out;
            document.getElementById('modHrs').value = info.h || u.config[info.s].h;
            document.getElementById('modNota').value = info.n || '';
            turnoEditando = info.s;
            document.getElementById('modalEditor').classList.add('active');
        }

        function seleccionarTurno(k) {
            turnoEditando = k;
            const conf = core.users[core.current].config[k];
            document.getElementById('modIn').value = conf.in;
            document.getElementById('modOut').value = conf.out;
            document.getElementById('modHrs').value = conf.h;
            
            const btns = document.getElementById('modBotones').children;
            Object.keys(core.users[core.current].config).forEach((key, i) => {
                btns[i].classList.toggle('border-blue-600', key === k);
                btns[i].classList.toggle('opacity-50', key !== k);
                btns[i].classList.toggle('border-transparent', key !== k);
            });
        }

        function guardarDia() {
            core.users[core.current].data[diaEditando] = {
                s: turnoEditando,
                in: document.getElementById('modIn').value,
                out: document.getElementById('modOut').value,
                h: parseFloat(document.getElementById('modHrs').value) || 0,
                n: document.getElementById('modNota').value
            };
            persistir(); dibujar(); cerrarModal();
        }

        function resumen() {
            let h = 0, c = 0, d = 0;
            const mKey = `${fechaAct.getFullYear()}-${fechaAct.getMonth()+1}-`;
            const u = core.users[core.current];
            Object.keys(u.data).forEach(k => {
                if(k.startsWith(mKey)) {
                    const item = u.data[k];
                    const conf = u.config[item.s];
                    if(conf.cat === 'hosp') h += item.h;
                    if(conf.cat === 'sena') c += item.h;
                    if(conf.cat === 'off') d++;
                }
            });
            document.getElementById('h-hosp').innerText = h.toFixed(1) + 'h';
            document.getElementById('h-cena').innerText = c.toFixed(1) + 'h';
            document.getElementById('h-desc').innerText = d;
        }

        function persistir() { localStorage.setItem('shifter_v12', JSON.stringify(core)); }
        function cerrarModal() { document.getElementById('modalEditor').classList.remove('active'); }
        function moverMes(v) { fechaAct.setMonth(fechaAct.getMonth() + v); dibujar(); }
        function ver(v) {
            ['cal','sum','set'].forEach(x => {
                document.getElementById('v-'+x).style.display = (x===v?'block':'none');
                document.getElementById('tab-'+x).classList.toggle('active', x===v);
            });
            if(v === 'set') ajustarUI();
        }

        function ajustarUI() {
            const l = document.getElementById('listaAjustes');
            l.innerHTML = '';
            const conf = core.users[core.current].config;
            Object.keys(conf).forEach(k => {
                if(k === 'L') return;
                l.innerHTML += `<div class="p-4 bg-slate-50 rounded-xl flex items-center gap-2">
                    <input type="text" id="cfg-l-${k}" value="${conf[k].label}" class="w-20 font-black text-[10px] uppercase bg-transparent border-none">
                    <input type="time" id="cfg-i-${k}" value="${conf[k].in}" class="flex-1 p-1 text-[10px] rounded-lg border-none shadow-inner">
                    <input type="time" id="cfg-o-${k}" value="${conf[k].out}" class="flex-1 p-1 text-[10px] rounded-lg border-none shadow-inner">
                    <input type="number" id="cfg-h-${k}" value="${conf[k].h}" class="w-12 p-1 text-[10px] rounded-lg border-none shadow-inner font-bold">
                </div>`;
            });
        }

        function guardarAjustes() {
            if(!editHabilitado) return alert("Desbloquea primero.");
            const u = core.users[core.current];
            Object.keys(u.config).forEach(k => {
                if(k === 'L') return;
                u.config[k].label = document.getElementById(`cfg-l-${k}`).value;
                u.config[k].in = document.getElementById(`cfg-i-${k}`).value;
                u.config[k].out = document.getElementById(`cfg-o-${k}`).value;
                u.config[k].h = parseFloat(document.getElementById(`cfg-h-${k}`).value);
            });
            const np = document.getElementById('setPin').value;
            if(np.length === 4) u.pin = np;
            persistir(); dibujar(); alert("AJUSTES GUARDADOS");
        }

        function actualizarDrowdown() {
            document.getElementById('userSelect').innerHTML = Object.keys(core.users).map(u => `<option value="${u}" ${u===core.current?'selected':''}>${u}</option>`).join('');
        }

        function cambiarUsuario() {
            core.current = document.getElementById('userSelect').value;
            editHabilitado = false;
            actualizarUIEdicion();
            dibujar();
        }

        function abrirNuevoUsuario() { document.getElementById('modalUser').classList.add('active'); }
        function crearUsuario() {
            const n = document.getElementById('newName').value.trim().toUpperCase();
            const p = document.getElementById('newPin').value;
            if(!n || p.length < 4) return alert("Datos inv√°lidos");
            core.users[n] = JSON.parse(JSON.stringify(core.users['ADMIN']));
            core.users[n].pin = p; core.users[n].data = {}; core.current = n;
            persistir(); actualizarDrowdown(); actualizarUIEdicion(); dibujar();
            document.getElementById('modalUser').classList.remove('active');
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Shifter Pro v20</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { background:#f3f4f6; color:#111827; font-family:system-ui,-apple-system,sans-serif; -webkit-tap-highlight-color:transparent; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#e5e7eb; border:1px solid #e5e7eb; }
    .day-cell { background:#fff; height:130px; position:relative; cursor:pointer; display:flex; flex-direction:column; overflow:hidden; transition:transform .15s; }
    .day-cell:active{ transform:scale(.98); }
    .day-number{ font-size:11px; font-weight:900; padding:2px 6px; position:absolute; top:0; right:0; z-index:20; color:#374151; background:rgba(255,255,255,.9); border-bottom-left-radius:8px; }
    .day-off-month{ background:#f9fafb!important; opacity:.5; }
    .today{ border:2px solid #3b82f6!important; }
    .weekend{ background:#f8fafc!important; }

    /* Colors */
    .bg-MaÃ±ana{ background:#ffff00!important; }
    .bg-Tarde{ background:#fbcfe8!important; }
    .bg-CENA{ background:#d8b4fe!important; }
    .bg-16hrs{ background:#bef264!important; }
    .bg-L{ background:#ffffff!important; }
    .bg-Vacaciones{ background:#fed7aa!important; }
    .bg-CumpleaÃ±os{ background:#fde68a!important; }

    .bg-azul{ background:#93c5fd!important; }
    .bg-rojo{ background:#fca5a5!important; }
    .bg-verde{ background:#86efac!important; }
    .bg-naranja{ background:#fdba74!important; }
    .bg-rosa{ background:#f9a8d4!important; }
    .bg-cian{ background:#67e8f9!important; }
    .bg-morado{ background:#d8b4fe!important; }
    .bg-lima{ background:#d9f99d!important; }
    .bg-ambar{ background:#fcd34d!important; }
    .bg-teal{ background:#5eead4!important; }
    .bg-indigo{ background:#a5b4fc!important; }
    .bg-gris{ background:#d1d5db!important; }

    .shift-label{ flex:1; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; text-transform:uppercase; text-align:center; line-height:1.1; padding:4px; color:rgba(0,0,0,.8); }
    .note-text{ font-size:10px; position:absolute; bottom:4px; left:50%; transform:translateX(-50%); width:90%; text-align:center; color:#000; font-weight:900; background:rgba(255,255,255,.65); border-radius:6px; padding:1px 4px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .view-section{ display:none; }
    .view-active{ display:block; }

    .tab-btn{ flex:1; text-align:center; padding:14px; font-weight:900; font-size:11px; border-bottom:3px solid transparent; transition:.2s; }
    .tab-active{ border-bottom-color:#2563eb; color:#2563eb; background:#f8fafc; }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:100; padding:15px; backdrop-filter:blur(4px); }
    .modal.active{ display:flex; }

    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea{
      background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:10px; font-weight:800; font-size:13px; outline:none; transition:.15s;
    }
    select:focus, input:focus, textarea:focus{
      border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.12);
    }

    .shift-option{ transition:.15s; border-width:2px; border-color:transparent; padding:12px 8px; border-radius:12px; font-size:10px; font-weight:900; text-transform:uppercase; cursor:pointer; }
    .shift-option.selected{ border-color:#2563eb!important; box-shadow:0 6px 14px rgba(37,99,235,.22); transform:translateY(-1px); }
    .shift-option:not(.selected){ opacity:.75; }
    .shift-option:hover:not(.selected){ opacity:.95; transform:translateY(-1px); }

    .config-tab{ flex:1; text-align:center; padding:12px; font-weight:900; font-size:10px; border-bottom:3px solid transparent; transition:.2s; color:#9ca3af; }
    .config-tab.active{ border-bottom-color:#2563eb; color:#2563eb; background:#f8fafc; }

    .holiday-indicator{
      position:absolute; top:0; left:0; font-size:8px; font-weight:900; color:#dc2626;
      background:rgba(254,226,226,.9); padding:1px 4px; border-bottom-right-radius:8px; z-index:20;
    }

    #userSelect{
      background:rgba(255,255,255,.12)!important;
      color:#fff!important;
      border:1px solid rgba(255,255,255,.15)!important;
      padding:6px 10px!important;
      border-radius:12px!important;
      max-width:240px;
    }
    #userSelect option{ color:#111827; background:#fff; font-weight:800; }
  </style>
</head>

<body>

<div class="bg-[#1e293b] text-white p-4 sticky top-0 z-50 shadow-lg">
  <div class="flex justify-between items-center mb-4">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-black text-sm">
        <span id="userInitial">A</span>
      </div>
      <div>
        <div class="flex items-center gap-2">
          <select id="userSelect" onchange="switchUser()"></select>
          <button onclick="openProfilesModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">ğŸ‘¤ Perfiles</button>
        </div>
        <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400">Modo Vista</p>
      </div>
    </div>
    <div class="flex gap-2">
      <button onclick="openImportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">ğŸ“¥ Importar</button>
      <button onclick="showExportModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">ğŸ“‹ Exportar</button>
      <button id="unlockBtn" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">ğŸ”’ Bloquear</button>
    </div>
  </div>

  <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-2xl p-2 shadow-inner">
    <button onclick="changeMonth(-1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
      <span class="text-xl font-bold">â€¹</span>
    </button>

    <div class="flex flex-col items-center">
      <div id="currentMonthDisplay" class="text-xl font-black text-white text-center mb-1">Febrero 2026</div>
      <div class="flex gap-3 items-center opacity-90">
        <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer"></select>
        <span class="text-white font-bold">/</span>
        <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer"></select>
      </div>
      <div class="flex gap-2 mt-2">
        <button onclick="goToday()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-[10px] font-black uppercase transition-colors">Hoy</button>
      </div>
    </div>

    <button onclick="changeMonth(1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
      <span class="text-xl font-bold">â€º</span>
    </button>
  </div>
</div>

<div class="flex bg-white shadow-sm sticky top-[160px] z-40 border-b">
  <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">ğŸ“… Calendario</button>
  <button onclick="showView('summary')" id="tab-summary" class="tab-btn">ğŸ“Š Resumen</button>
  <button onclick="showView('settings')" id="tab-settings" class="tab-btn">âš™ï¸ Ajustes</button>
</div>

<div id="view-calendar" class="view-section view-active">
  <div class="grid grid-cols-7 text-center text-[11px] font-black py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b">
    <div class="text-blue-600 font-black">LUN</div><div>MAR</div><div>MIÃ‰</div><div>JUE</div><div>VIE</div>
    <div class="text-blue-600 font-black">SÃB</div><div class="text-red-600 font-black">DOM</div>
  </div>
  <div id="calendar" class="calendar-grid"></div>
</div>

<!-- SUMMARY (dinÃ¡mico por categorÃ­as) -->
<div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen">
  <div class="space-y-4 md:space-y-6">
    <div class="bg-white p-4 rounded-3xl shadow-sm border">
      <div class="flex items-center justify-between">
        <h3 class="text-[12px] font-black text-gray-600 uppercase">Resumen por categorÃ­as</h3>
        <span id="profile-loc" class="text-[11px] font-black text-gray-800"></span>
      </div>
      <p class="text-[11px] text-gray-500 font-bold mt-1">
        * Calculado segÃºn la categorÃ­a definida en cada turno del perfil.
      </p>
    </div>

    <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>

    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 rounded-3xl text-white text-center shadow-xl">
      <p class="text-xs font-black uppercase opacity-90 mb-2">DÃ­as de Descanso (segÃºn calendario)</p>
      <h2 id="total-off" class="text-5xl font-black mb-3">0</h2>
      <div class="grid grid-cols-4 gap-2 text-[10px] font-black">
        <div class="bg-white/20 p-2 rounded-xl"><div>Libres</div><div id="free-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Vacaciones</div><div id="vac-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Fines</div><div id="weekend-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Asuetos Trab.</div><div id="holiday-worked" class="text-lg font-black">0</div></div>
      </div>
      <p class="text-[10px] mt-3 font-bold opacity-90">
        * Asueto laborado solo cuenta si el asueto aplica a la localidad del perfil (o si es General).
      </p>
    </div>

    <div class="bg-white p-4 rounded-3xl shadow-sm">
      <h3 class="text-[12px] font-black text-gray-600 uppercase mb-3">ğŸ“Œ Resumen del Mes</h3>
      <div class="space-y-2">
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">DÃ­as trabajados:</span><span id="worked-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Promedio diario:</span><span id="avg-hours" class="font-black text-gray-900">0.0h</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Total dÃ­as mes:</span><span id="total-days" class="font-black text-gray-900">30</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Asuetos en mes (aplican):</span><span id="total-holidays" class="font-black text-red-600">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="view-settings" class="view-section bg-white min-h-screen">
  <div class="flex bg-gray-50 border-b">
    <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active">ğŸ¨ Turnos</button>
    <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab">â• Nuevo</button>
    <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab">ğŸ·ï¸ CategorÃ­as</button>
    <button onclick="showConfigTab('localidades')" id="config-localidades" class="config-tab">ğŸ“ Localidades</button>
    <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab">ğŸ‰ Asuetos</button>
    <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab">ğŸ”’ Seguridad</button>
  </div>

  <div id="config-content" class="p-4 md:p-6">
    <!-- Turnos -->
    <div id="tab-turnos" class="config-tab-content">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ¨ Configurar Turnos</h3>
        <div class="flex gap-2">
          <button onclick="toggleShowAllShifts()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded-xl text-[10px] font-black uppercase">
            ğŸ‘ï¸ <span id="showAllShiftsLabel">Mostrar todos</span>
          </button>
          <button onclick="saveShiftSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
            ğŸ’¾ Guardar cambios
          </button>
        </div>
      </div>

      <div class="bg-blue-50 border border-blue-100 rounded-2xl p-3 text-[11px] font-bold text-blue-900 mb-4">
        Al guardar: actualiza turnos y puede propagar horas/comentarios en el calendario del perfil.
        <div class="mt-2 flex items-center gap-2">
          <input type="checkbox" id="propagateShiftEdits" checked>
          <label for="propagateShiftEdits" class="font-black text-[10px] uppercase text-blue-900">Propagar a calendario (este perfil)</label>
        </div>
      </div>

      <div id="settings-container" class="space-y-3"></div>
    </div>

    <!-- Nuevo turno -->
    <div id="tab-nuevo" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">â• Agregar Nuevo Turno</h3>
      <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-100 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Turno</label>
            <input type="text" id="newShiftName" placeholder="Ej: Noche" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">CategorÃ­a</label>
            <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Color</label>
            <select id="newShiftColor" class="w-full bg-white border-amber-200 focus:border-amber-400">
              <option>MaÃ±ana</option><option>Tarde</option><option>CENA</option><option>16hrs</option>
              <option>CumpleaÃ±os</option><option>L</option><option>Vacaciones</option>
              <option>azul</option><option>rojo</option><option>verde</option><option>naranja</option><option>rosa</option><option>cian</option>
              <option>morado</option><option>lima</option><option>ambar</option><option>teal</option><option>indigo</option><option>gris</option>
            </select>
          </div>
          <div class="flex items-end gap-2">
            <label class="flex items-center gap-2 text-[11px] font-black text-gray-700">
              <input type="checkbox" id="newShiftVisible" checked> Visible en lista
            </label>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Entrada</label>
            <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Salida</label>
            <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
        </div>

        <button onclick="addNewShift()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600">
          â• Agregar Turno
        </button>
      </div>
    </div>

    <!-- CategorÃ­as -->
    <div id="tab-categorias" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ·ï¸ CategorÃ­as</h3>
        <button onclick="saveCategories()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-3xl border border-green-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva CategorÃ­a</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newCategoryName" placeholder="Ej: Guardia" class="w-full bg-white border-green-200 focus:border-green-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Icono</label>
            <input type="text" id="newCategoryIcon" placeholder="Ej: ğŸ›¡ï¸" class="w-full bg-white border-green-200 focus:border-green-400">
          </div>
        </div>
        <button onclick="addNewCategory()" class="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600">
          â• Agregar CategorÃ­a
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">CategorÃ­as Existentes (todas editables)</h4>
        <div id="categories-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Localidades -->
    <div id="tab-localidades" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ“ Localidades</h3>
        <button onclick="saveLocalities()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-sky-50 to-blue-50 p-4 rounded-3xl border border-sky-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Localidad</h4>
        <div class="flex gap-3">
          <input type="text" id="newLocalityName" placeholder="Ej: Santa Ana" class="flex-1 bg-white border-sky-200 focus:border-sky-400">
          <button onclick="addLocality()" class="px-5 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">â• Agregar</button>
        </div>
        <p class="text-[10px] mt-2 font-bold text-gray-500">* â€œGeneralâ€ aplica para todos y se reserva.</p>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Lista de Localidades (editables)</h4>
        <div id="localities-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Asuetos -->
    <div id="tab-asuetos" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ‰ Asuetos (anuales)</h3>
        <button onclick="saveHolidayRules()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-3xl border border-pink-100 mb-6">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nuevo Asueto</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Mes/DÃ­a</label>
            <input type="text" id="newHolidayMD" placeholder="Ej: 08-05" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
          <div class="md:col-span-2">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newHolidayName" placeholder="Ej: Fiestas Patronales" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="newHolidayLocation" class="w-full bg-white border-pink-200 focus:border-pink-400"></select>
          </div>
          <div class="bg-white rounded-2xl border border-pink-200 p-3 text-[10px] font-bold text-gray-600 flex items-center">
            Para todos: selecciona <span class="mx-1 font-black text-red-600">General</span>.
          </div>
        </div>

        <button onclick="addHolidayRule()" class="w-full p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600">
          â• Agregar Asueto
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Asuetos (editables)</h4>
        <div id="holidays-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Seguridad -->
    <div id="tab-seguridad" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">ğŸ”’ Seguridad (PIN del perfil actual)</h3>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-3xl border border-blue-100">
        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Cambiar PIN (4 dÃ­gitos)</label>
            <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Confirmar PIN</label>
            <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>

          <button onclick="savePinOnly()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-3xl font-black uppercase shadow-xl hover:from-blue-700 hover:to-indigo-700">
            ğŸ’¾ Guardar PIN
          </button>
        </div>
      </div>
    </div>

  </div>

  <div id="settings-locked" class="p-8 text-center hidden">
    <div class="w-20 h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
      <span class="text-3xl">ğŸ”’</span>
    </div>
    <h3 class="text-lg font-black text-gray-600 mb-2">ConfiguraciÃ³n Bloqueada</h3>
    <p class="text-sm text-gray-500 mb-6">Activa el modo ediciÃ³n para acceder</p>
    <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-black">ğŸ”“ Activar EdiciÃ³n</button>
  </div>
</div>

<!-- MODAL DÃA -->
<div id="modal" class="modal">
  <div class="bg-white w-full max-w-md rounded-[40px] overflow-hidden shadow-2xl border border-gray-100">
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-5 font-black text-sm uppercase tracking-widest">
      <div>ğŸ“… Configurar DÃ­a</div>
      <div id="modalDate" class="text-[10px] font-normal opacity-90 mt-1"></div>
    </div>
    <div class="p-6 overflow-y-auto max-h-[80vh]">

      <!-- ASUETO INFO -->
      <div id="holidayBox" class="hidden mb-4 p-4 rounded-2xl border border-red-100 bg-red-50">
        <div class="flex items-center justify-between">
          <div class="font-black text-red-700 text-[11px] uppercase">Asueto</div>
          <div id="holidayApplies" class="text-[10px] font-black px-2 py-1 rounded-full"></div>
        </div>
        <div id="holidayName" class="mt-2 font-black text-gray-900"></div>
        <div id="holidayLoc" class="text-[11px] font-bold text-gray-600"></div>
      </div>

      <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-6">
        <button onclick="setMode('simple')" id="m-s" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Simple</button>
        <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Mixto</button>
      </div>

      <div id="sec-simple" class="grid grid-cols-3 gap-2 mb-6"></div>

      <div id="sec-mixto" class="hidden space-y-4 mb-6">
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Superior</p>
          <div id="mix-t" class="grid grid-cols-3 gap-2"></div>
        </div>
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Inferior</p>
          <div id="mix-b" class="grid grid-cols-3 gap-2"></div>
        </div>
      </div>

      <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100 mb-6">
        <div class="flex items-center justify-between">
          <span class="text-[11px] font-black uppercase text-blue-900">â° Horario:</span>
          <div class="flex items-center gap-2">
            <input type="time" id="tIn" onchange="autoCalc(); maybeAutoNoteSimple();" class="bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">â†’</span>
            <input type="time" id="tOut" onchange="autoCalc(); maybeAutoNoteSimple();" class="bg-white border-blue-200 focus:border-blue-400">
          </div>
        </div>
        <div class="flex items-center justify-between border-t border-blue-200 pt-3">
          <span class="text-[11px] font-black uppercase text-blue-900">ğŸ“Š Total Horas:</span>
          <input type="number" id="tHrs" onchange="manualCalc()" class="w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
        </div>
      </div>

      <div id="time-mixto" class="hidden space-y-4 mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100">
          <p class="text-[11px] font-black uppercase text-blue-900 text-center">â° Horario Superior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">â†’</span>
            <input type="time" id="tOutTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div class="flex items-center justify-between border-t border-blue-200 pt-3">
            <span class="text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
            <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-5 rounded-[24px] space-y-4 border border-purple-100">
          <p class="text-[11px] font-black uppercase text-purple-900 text-center">â° Horario Inferior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-32 bg-white border-purple-200 focus:border-purple-400">
            <span class="font-black text-purple-300">â†’</span>
            <input type="time" id="tOutBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-32 bg-white border-purple-200 focus:border-purple-400">
          </div>
          <div class="flex items-center justify-between border-t border-purple-200 pt-3">
            <span class="text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
            <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200" step="0.5">
          </div>
        </div>
        <div class="flex items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-[20px] border border-emerald-100">
          <span class="text-[11px] font-black uppercase text-emerald-900">ğŸ“Š Total Horas:</span>
          <input type="number" id="tHrsMixto" class="w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200" step="0.5" readonly>
        </div>
      </div>

      <div class="mt-6">
        <p class="text-[10px] font-black text-gray-400 uppercase mb-2 ml-2">ğŸ“ Comentario (editable)</p>
        <textarea id="nota" placeholder="Ej: 06:00-14:00 | Doble turno | etc." class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        <p class="text-[10px] text-gray-500 mt-2 font-bold text-center">
          EstÃ¡ndar: el comentario debe incluir el horario del turno (editable).
        </p>
      </div>

      <div class="flex gap-4 mt-8">
        <button onclick="closeModal()" class="flex-1 p-5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-3xl font-black text-[11px] uppercase">âŒ Cancelar</button>
        <button onclick="saveDay()" class="flex-1 p-5 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-3xl font-black text-[11px] uppercase shadow-lg">âœ… Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT MODAL -->
<div id="importModal" class="modal">
  <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 shadow-2xl">
    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">ğŸ“¥</span>
    </div>
    <h3 class="font-black text-center uppercase text-lg mb-2">Importar Excel</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Detecta usuarios y dÃ­as automÃ¡ticamente (con heurÃ­stica). Selecciona cuÃ¡les importar.
    </p>

    <div class="space-y-4">
      <div>
        <label class="text-[12px] font-bold text-gray-600 block mb-2">Archivo Excel (.xlsx)</label>
        <input type="file" id="importFile" accept=".xlsx,.xls" class="w-full bg-gray-50 border-gray-200">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes (fallback)</label>
          <select id="importMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">AÃ±o (fallback)</label>
          <select id="importYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Modo</p>
        <div class="flex gap-3">
          <label class="flex-1 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="replace" checked> Reemplazar mes
          </label>
          <label class="flex-1 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="merge"> Combinar (solo dÃ­as vacÃ­os)
          </label>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Usuarios detectados</p>
          <div class="flex gap-2">
            <button onclick="selectAllImportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllImportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="importUsersList" class="max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700">
          <div class="text-gray-400 font-bold">Adjunta un Excel y presiona â€œAnalizarâ€.</div>
        </div>

        <div class="mt-3 flex gap-2">
          <button onclick="analyzeImportFile()" class="flex-1 p-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">
            ğŸ” Analizar
          </button>
          <button onclick="runImportSelected()" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black uppercase text-[11px]">
            ğŸš€ Importar seleccionados
          </button>
        </div>

        <div id="importInfo" class="mt-3 text-[11px] font-bold text-center text-gray-600"></div>
      </div>

      <button onclick="closeImportModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- EXPORT MODAL -->
<div id="exportModal" class="modal">
  <div class="bg-white w-full max-w-xl rounded-[40px] p-8 shadow-2xl">
    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 mx-auto mb-4 flex items-center justify-content-center">
      <span class="text-white text-2xl font-black">ğŸ“‹</span>
    </div>
    <h3 class="font-black text-center uppercase text-lg mb-2">Exportar</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Uno, varios o todos. Si es â€œtodosâ€, se genera 1 imagen por perfil.
    </p>

    <div class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes</label>
          <select id="exportMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">AÃ±o</label>
          <select id="exportYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">QuÃ© exportar</p>
        <div class="space-y-2 text-[11px] font-bold text-gray-700">
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="current" checked> Perfil actual</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="select"> Seleccionar perfiles</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="all"> Todos los perfiles</label>
        </div>
      </div>

      <div id="exportUsersBox" class="bg-white border border-gray-200 rounded-2xl p-4 hidden">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Seleccionar perfiles</p>
          <div class="flex gap-2">
            <button onclick="selectAllExportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllExportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="exportUsersList" class="max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700"></div>
      </div>

      <button onclick="exportImages()" class="w-full p-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-3xl font-black uppercase shadow-xl hover:from-emerald-700 hover:to-teal-700">
        ğŸ–¼ï¸ Exportar imÃ¡genes
      </button>

      <button onclick="closeExportModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- PROFILES MODAL -->
<div id="profilesModal" class="modal">
  <div class="bg-white w-full max-w-3xl rounded-[40px] p-8 shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="font-black uppercase text-lg">ğŸ‘¤ GestiÃ³n de Perfiles</h3>
        <p class="text-[11px] text-gray-500 font-bold">Crear, editar, asignar localidad o eliminar perfiles.</p>
      </div>
      <button onclick="closeProfilesModal()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Cerrar</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-3xl p-4">
        <h4 class="text-[12px] font-black text-gray-700 uppercase mb-3">â• Crear perfil</h4>
        <div class="space-y-3">
          <input id="createName" type="text" placeholder="Nombre completo" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <input id="createPin" type="password" placeholder="PIN (4 dÃ­gitos)" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="createLoc" class="w-full bg-white border-blue-200 focus:border-blue-400"></select>
          </div>
          <button onclick="createProfile()" class="w-full p-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-[11px]">
            Crear
          </button>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-3xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-[12px] font-black text-gray-700 uppercase">Perfiles existentes</h4>
          <button onclick="renderProfilesList()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Actualizar</button>
        </div>
        <div id="profilesList" class="max-h-[360px] overflow-y-auto space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================ v20 DB ============================ */
const ADMIN_UNIVERSAL_PIN = "120720"; // no visible en UI
let showAllShifts = false;

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

let db = JSON.parse(localStorage.getItem('shifter_v20')) || {
  version: 20,
  current: 'ADMIN',
  localities: ['General','San Salvador'],
  // Holiday rules: annual (MM-DD)
  holidayRules: [],
  categories: {
    hosp: { name:'Hospital', icon:'ğŸ¥' },
    sena: { name:'CENA', icon:'ğŸŒ™' },
    off:  { name:'Libre/Vacaciones', icon:'ğŸ˜´' },
    admin:{ name:'Administrativo', icon:'ğŸ“‹' }
  },
  users: {
    ADMIN: {
      pin:'1234',
      editLocked:false,     // default unlocked
      locality:'San Salvador',
      data:{},
      config:{
        'MaÃ±ana':     { label:'MaÃ±ana', color:'MaÃ±ana', cat:'hosp', in:'06:00', out:'14:00', visible:true },
        'Tarde':      { label:'Tarde', color:'Tarde', cat:'hosp', in:'14:00', out:'22:00', visible:true },
        '16hrs':      { label:'16hrs', color:'16hrs', cat:'hosp', in:'06:00', out:'22:00', visible:true },
        'CENA':       { label:'CENA', color:'CENA', cat:'sena', in:'05:00', out:'17:00', visible:true },
        'CumpleaÃ±os': { label:'CumpleaÃ±os', color:'CumpleaÃ±os', cat:'off', in:'00:00', out:'00:00', visible:true },
        'L':          { label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', visible:true },
        'Vacaciones': { label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', visible:true }
      }
    }
  }
};

/* ============================ Holidays full load ============================ */
function ensureHolidayRulesLoaded(){
  if(db.holidayRules && db.holidayRules.length>0) return;

  const rules = [
    {md:'01-01', name:'AÃ±o Nuevo', location:'General'},
    {md:'01-20', name:'Fiestas de Cojutepeque', location:'Cojutepeque'},
    {md:'02-10', name:'Fiesta de Lourdes ColÃ³n', location:'Lourdes, ColÃ³n'},
    {md:'04-01', name:'MiÃ©rcoles Santo (Semana Santa)', location:'General'},
    {md:'04-02', name:'Jueves Santo (Semana Santa)', location:'General'},
    {md:'04-03', name:'Viernes Santo (Semana Santa)', location:'General'},
    {md:'04-04', name:'SÃ¡bado de Gloria (Semana Santa)', location:'General'},
    {md:'05-01', name:'DÃ­a del Trabajo', location:'General'},
    {md:'05-10', name:'DÃ­a de la Madre', location:'General'},
    {md:'06-17', name:'DÃ­a del Padre', location:'General'},
    {md:'08-03', name:'DÃ­a del Comercio', location:'General'},
    {md:'08-04', name:'Fiestas Patronales (San Salvador)', location:'San Salvador'},
    {md:'08-05', name:'Fiestas Patronales (San Salvador)', location:'San Salvador'},
    {md:'08-06', name:'DÃ­a de El Salvador', location:'General'},
    {md:'09-15', name:'Aniversario de Independencia', location:'General'},
    {md:'10-02', name:'VÃ­spera del dÃ­a del Trabajador de la Industria ElÃ©ctrica', location:'General'},
    {md:'10-03', name:'DÃ­a del Trabajador de la Industria ElÃ©ctrica', location:'General'},
    {md:'11-02', name:'DÃ­a de los Difuntos', location:'General'},
    {md:'12-08', name:'Fiestas de La Libertad', location:'La Libertad'},
    {md:'12-19', name:'Fiestas Patronales', location:'Quezaltepeque y Rosario de la Paz'},
    {md:'12-24', name:'Navidad', location:'General'},
    {md:'12-25', name:'Navidad', location:'General'},
    {md:'12-26', name:'Fiestas Patronales', location:'Zacatecoluca, San Vicente y Santa Tecla'},
    {md:'12-27', name:'Fiestas de San Juan Opico', location:'San Juan Opico'},
    {md:'12-31', name:'Fin de AÃ±o', location:'General'},
  ];

  db.holidayRules = rules;

  // Ensure localities include all mentioned
  rules.forEach(r=>{
    const locs = String(r.location||'General').split(' y ').map(x=>x.trim()).filter(Boolean);
    locs.forEach(l=>{
      if(l.toUpperCase()==='GENERAL') return;
      if(!db.localities.some(x=>x.trim().toUpperCase()===l.toUpperCase())) db.localities.push(l);
    });
  });

  // Ensure required
  if(!db.localities.some(x=>x.trim().toUpperCase()==='GENERAL')) db.localities.unshift('General');
  if(!db.localities.some(x=>x.trim().toUpperCase()==='SAN SALVADOR')) db.localities.push('San Salvador');

  saveDB();
}

/* ============================ Helpers ============================ */
function saveDB(){ localStorage.setItem('shifter_v20', JSON.stringify(db)); }
function isEditMode(){ return !db.users[db.current].editLocked; }

function calculateHours(start, end){
  if(!start || !end || (start==='00:00' && end==='00:00')) return 0;
  let [h1,m1]=start.split(':').map(Number);
  let [h2,m2]=end.split(':').map(Number);
  let diff = (h2 + m2/60) - (h1 + m1/60);
  if(diff < 0) diff += 24;
  return parseFloat(diff.toFixed(1));
}

function cssSafe(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g,'_'); }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }

function dayKey(y,m1,d){ return `${y}-${m1}-${d}`; } // m1 is 1-based
function mdKey(m1,d){ return `${String(m1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

function holidayApplies(holidayLocation, userLocation){
  const hl = (holidayLocation||'General').trim().toUpperCase();
  const ul = (userLocation||'San Salvador').trim().toUpperCase();
  if(hl === 'GENERAL') return true;
  return hl === ul;
}

function getHolidayForDate(year, monthIndex0, day){
  const md = mdKey(monthIndex0+1, day);
  // if multiple rules same date, return array; we show first + count
  const matches = (db.holidayRules||[]).filter(r=>String(r.md||'')===md);
  return matches;
}

function countApplicableHolidaysInMonth(year, monthIndex0, userLocation){
  const m1 = monthIndex0+1;
  const daysInMonth = new Date(year, monthIndex0+1, 0).getDate();
  let c=0;
  for(let d=1; d<=daysInMonth; d++){
    const rules = getHolidayForDate(year, monthIndex0, d);
    if(rules.length===0) continue;
    // count any rule that applies (General counts)
    const appliesAny = rules.some(r => holidayApplies(r.location, userLocation));
    if(appliesAny) c++;
  }
  return c;
}

function defaultNoteForShift(shiftKey){
  const user = db.users[db.current];
  const sh = user.config[shiftKey];
  if (!sh) return (shiftKey||'').toUpperCase();
  if (sh.in && sh.out && !(sh.in==='00:00' && sh.out==='00:00')) return `${sh.in}-${sh.out}`;
  return (sh.label || shiftKey || '').toUpperCase();
}

function normalizeCode(v){
  if(v===null||v===undefined) return '';
  let s = String(v).trim();
  if(!s) return '';
  s = s.replace(/\s+/g,' ').toUpperCase();
  if (s === 'LS') s='L';
  if (s === 'P S' || s === 'P/S') s='PS';
  return s;
}

/* ============================ Import maps (base) ============================ */
const IMPORT_ABSENCE_MAP = {
  'C':  { key:'CAPACITACION', label:'CapacitaciÃ³n', color:'azul', cat:'admin', in:'00:00', out:'00:00', note:'CAPACITACIÃ“N' },
  'I':  { key:'INCAPACIDAD', label:'Incapacidad', color:'rojo', cat:'off', in:'00:00', out:'00:00', note:'INCAPACIDAD' },
  'V':  { key:'Vacaciones', label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', note:'VACACIONES' },
  'L':  { key:'L', label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', note:'LIBRE' },
  'PS': { key:'PERMISO_SINDICAL', label:'Permiso Sindical', color:'morado', cat:'admin', in:'00:00', out:'00:00', note:'PERMISO SINDICAL' },
  'F':  { key:'AUS_INJUST', label:'Aus. Injust.', color:'gris', cat:'off', in:'00:00', out:'00:00', note:'AUSENCIA INJUSTIFICADA' }
};

const IMPORT_SHIFT_CODE_MAP = {
  '018': { key:'018', label:'018', color:'MaÃ±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '468': { key:'468', label:'468', color:'Tarde',  cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '650': { key:'650', label:'650', color:'16hrs',  cat:'hosp', in:'06:00', out:'22:00', note:'06:00-22:00' }
};

function codeToShiftDef(codeNorm){
  if(!codeNorm || codeNorm==='X') return null;
  if(IMPORT_ABSENCE_MAP[codeNorm]) return {...IMPORT_ABSENCE_MAP[codeNorm], visible:false};
  if(IMPORT_SHIFT_CODE_MAP[codeNorm]) return {...IMPORT_SHIFT_CODE_MAP[codeNorm], visible:false};

  // unknown numeric code -> create hidden shift with 0 hours by default
  if(/^\d+$/.test(codeNorm)){
    return { key: codeNorm, label: codeNorm, color:'gris', cat:'hosp', in:'00:00', out:'00:00', note: codeNorm, visible:false };
  }
  return null;
}

function ensureShiftExistsForUser(userKey, shiftDef){
  const user = db.users[userKey];
  if(!user) return;
  if(!user.config[shiftDef.key]){
    user.config[shiftDef.key] = {
      label: shiftDef.label,
      color: shiftDef.color||'gris',
      cat: shiftDef.cat||'hosp',
      in: shiftDef.in||'00:00',
      out: shiftDef.out||'00:00',
      visible: !!shiftDef.visible
    };
  }
}

function ensureUserExists(nameUpper){
  const name = String(nameUpper||'').trim().toUpperCase();
  if(!name) return null;
  if(!db.users[name]){
    db.users[name] = deepClone(db.users['ADMIN']);
    db.users[name].pin = '0000';
    db.users[name].editLocked = false;
    db.users[name].data = {};
    db.users[name].locality = 'San Salvador';
  }
  return name;
}

/* ============================ Globals ============================ */
let current = new Date();
let activeKey = "";
let mode = "simple";
let selS = "MaÃ±ana";
let selT = "MaÃ±ana";
let selB = "Tarde";
let importContext = null;

/* ============================ Init ============================ */
function init(){
  ensureHolidayRulesLoaded();
  initSelectors();
  ensureLocalitiesBase();
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  render();
  updateUIEditMode();
}

function ensureLocalitiesBase(){
  if(!db.localities || !Array.isArray(db.localities)) db.localities=['General','San Salvador'];
  if(!db.localities.some(x=>x.trim().toUpperCase()==='GENERAL')) db.localities.unshift('General');
  if(!db.localities.some(x=>x.trim().toUpperCase()==='SAN SALVADOR')) db.localities.push('San Salvador');
  db.localities = Array.from(new Set(db.localities.map(x=>String(x).trim()).filter(Boolean)));
  saveDB();
}

function initSelectors(){
  const mSel = document.getElementById('selectMonth');
  const ySel = document.getElementById('selectYear');
  const iMonth = document.getElementById('importMonth');
  const iYear = document.getElementById('importYear');
  const eMonth = document.getElementById('exportMonth');
  const eYear = document.getElementById('exportYear');

  [mSel,iMonth,eMonth].forEach(sel=>{
    sel.innerHTML='';
    MONTHS.forEach((m,i)=> sel.innerHTML += `<option value="${i}">${m}</option>`);
  });

  [ySel,iYear,eYear].forEach(sel=>{
    sel.innerHTML='';
    for(let y=2023;y<=2027;y++){
      sel.innerHTML += `<option value="${y}" ${y===2026?'selected':''}>${y}</option>`;
    }
  });
}

/* ============================ Navigation ============================ */
function updateMonthDisplay(){
  const y=current.getFullYear();
  const m=current.getMonth();
  document.getElementById('currentMonthDisplay').textContent = `${MONTHS[m]} ${y}`;
  document.getElementById('selectMonth').value = m;
  document.getElementById('selectYear').value = y;
}
function changeMonth(v){ current.setMonth(current.getMonth()+v); updateMonthDisplay(); render(); }
function jumpToDate(){
  current.setMonth(parseInt(document.getElementById('selectMonth').value));
  current.setFullYear(parseInt(document.getElementById('selectYear').value));
  updateMonthDisplay(); render();
}
function goToday(){ current = new Date(); updateMonthDisplay(); render(); }

/* ============================ Views ============================ */
function showView(v){
  document.querySelectorAll('.view-section').forEach(s=>s.classList.remove('view-active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('tab-active'));
  document.getElementById('view-'+v).classList.add('view-active');
  document.getElementById('tab-'+v).classList.add('tab-active');

  if(v==='settings'){
    updateUIEditMode();
    if(isEditMode()) showConfigTab('turnos');
  }
}

function showConfigTab(tab){
  document.querySelectorAll('.config-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(`config-${tab}`).classList.add('active');

  document.querySelectorAll('.config-tab-content').forEach(c=>c.classList.add('hidden'));
  document.getElementById(`tab-${tab}`).classList.remove('hidden');

  if(tab==='turnos'){ renderSettings(); }
  if(tab==='nuevo'){ loadCategoriesSelect(); }
  if(tab==='categorias'){ renderCategories(); }
  if(tab==='localidades'){ renderLocalities(); }
  if(tab==='asuetos'){ refreshHolidayLocationSelects(); renderHolidayRules(); }
}

/* ============================ Edit mode + universal pin ============================ */
function updateUIEditMode(){
  const configContent = document.getElementById('config-content');
  const lockedMessage = document.getElementById('settings-locked');

  if(isEditMode()){
    configContent.classList.remove('hidden');
    lockedMessage.classList.add('hidden');
    document.getElementById('editStatus').innerText = "MODO EDICIÃ“N ACTIVADO";
    document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-emerald-400";
    document.getElementById('unlockBtn').innerText = "ğŸ”’ Bloquear";
    document.getElementById('unlockBtn').className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  } else {
    configContent.classList.add('hidden');
    lockedMessage.classList.remove('hidden');
    document.getElementById('editStatus').innerText = "MODO VISTA";
    document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-gray-400";
    document.getElementById('unlockBtn').innerText = "ğŸ”“ Editar";
    document.getElementById('unlockBtn').className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  }
}

function toggleEditMode(){
  const user = db.users[db.current];

  if(isEditMode()){
    const p = prompt("Ingresa tu PIN para bloquear la ediciÃ³n:");
    if(p === user.pin || p === ADMIN_UNIVERSAL_PIN){
      user.editLocked = true;
      saveDB();
    } else return alert("PIN incorrecto");
  } else {
    const p = prompt("Ingresa tu PIN para editar:");
    if(p === user.pin || p === ADMIN_UNIVERSAL_PIN){
      user.editLocked = false;
      saveDB();
    } else return alert("PIN incorrecto");
  }
  updateUIEditMode();
}

/* ============================ Users ============================ */
function updateUserDropdown(){
  const select = document.getElementById('userSelect');
  select.innerHTML = Object.keys(db.users).sort().map(u => `<option value="${u}" ${u===db.current?'selected':''}>${u}</option>`).join('');
}
function updateUserInitial(){ document.getElementById('userInitial').textContent = db.current.charAt(0); }
function switchUser(){
  db.current = document.getElementById('userSelect').value;
  updateUserInitial();
  render();
  updateUIEditMode();
}

/* ============================ Calendar render ============================ */
function render(){
  const grid=document.getElementById('calendar');
  grid.innerHTML='';

  const y=current.getFullYear();
  const m=current.getMonth();
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const today = new Date();
  const todayKey = dayKey(today.getFullYear(), today.getMonth()+1, today.getDate());

  const firstDay = new Date(y,m,1).getDay();
  const firstDayMonday = firstDay===0?6:firstDay-1;
  const lastDate = new Date(y,m+1,0).getDate();
  const prevLastDate = new Date(y,m,0).getDate();

  const hasHolidayIndicator = (dayNum)=>{
    const rules = getHolidayForDate(y,m,dayNum);
    if(rules.length===0) return false;
    return rules.some(r=>holidayApplies(r.location, user.locality));
  };

  // prev
  for(let i=firstDayMonday;i>0;i--){
    const prevDay=prevLastDate-i+1;
    const prevMonth = m===0?12:m;
    const prevYear = m===0?y-1:y;
    const key = dayKey(prevYear, prevMonth, prevDay);
    const info=user.data[key];

    const cell=document.createElement('div');
    cell.className='day-cell day-off-month';

    if(info){
      if(info.mode==='mixto'){
        cell.innerHTML = `
          <div class="shift-label bg-${SHIFTS[info.t]?.color||'L'}">${SHIFTS[info.t]?.label||'L'}</div>
          <div class="shift-label bg-${SHIFTS[info.b]?.color||'L'}">${SHIFTS[info.b]?.label||'L'}</div>`;
      } else {
        const label = info.s==='L'?'L':(SHIFTS[info.s]?.label||info.s||'L');
        cell.innerHTML = `<div class="shift-label bg-${SHIFTS[info.s]?.color||'L'}">${label}</div>`;
      }
      if(info.n) cell.innerHTML += `<div class="note-text">${escapeHTML(info.n)}</div>`;
    }

    cell.innerHTML += `<span class="day-number">${prevDay}</span>`;
    cell.onclick=()=>openDay(key, info || {mode:'simple', s:'L'});
    grid.appendChild(cell);
  }

  // month days
  for(let d=1; d<=lastDate; d++){
    const key=dayKey(y,m+1,d);
    const info=user.data[key] || {mode:'simple', s:'L'};
    const cell=document.createElement('div');

    let classes='day-cell';
    const dow=new Date(y,m,d).getDay();
    if(dow===0 || dow===6) classes+=' weekend';
    if(key===todayKey) classes+=' today';
    cell.className=classes;

    if(info.mode==='mixto'){
      cell.innerHTML=`
        <div class="shift-label bg-${SHIFTS[info.t]?.color||'L'}">${SHIFTS[info.t]?.label||'L'}</div>
        <div class="shift-label bg-${SHIFTS[info.b]?.color||'L'}">${SHIFTS[info.b]?.label||'L'}</div>`;
    } else {
      const label = info.s==='L'?'L':(SHIFTS[info.s]?.label||info.s||'L');
      cell.innerHTML = `<div class="shift-label bg-${SHIFTS[info.s]?.color||'L'}">${label}</div>`;
    }

    if(hasHolidayIndicator(d)) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
    cell.innerHTML += `<span class="day-number">${d}</span>`;
    if(info.n) cell.innerHTML += `<div class="note-text">${escapeHTML(info.n)}</div>`;

    cell.onclick=()=>{
      if(!isEditMode()) return alert("Activa modo ediciÃ³n para editar.");
      openDay(key, info);
    };

    grid.appendChild(cell);
  }

  // next filler
  const total = firstDayMonday + lastDate;
  for(let i=1; i<= (42-total); i++){
    const cell=document.createElement('div');
    cell.className='day-cell day-off-month';
    cell.innerHTML = `<span class="day-number">${i}</span>`;
    grid.appendChild(cell);
  }

  calcSummary();
}

/* ============================ Modal day ============================ */
function openDay(key, info){
  activeKey = key;
  mode = info.mode || 'simple';
  selS = info.s || 'MaÃ±ana';
  selT = info.t || 'MaÃ±ana';
  selB = info.b || 'Tarde';

  const user=db.users[db.current];
  const SHIFTS=user.config;

  const [yy,mm,dd]=key.split('-').map(Number);
  document.getElementById('modalDate').textContent = `${dd} de ${MONTHS[mm-1]} de ${yy}`;

  // Holiday box
  const rules = getHolidayForDate(yy, mm-1, dd);
  const holidayBox = document.getElementById('holidayBox');
  if(rules.length>0){
    // show first + count
    const first = rules[0];
    const applies = rules.some(r=>holidayApplies(r.location, user.locality));
    holidayBox.classList.remove('hidden');
    document.getElementById('holidayName').textContent = rules.length===1 ? first.name : `${first.name} (+${rules.length-1})`;
    document.getElementById('holidayLoc').textContent = `Localidad: ${first.location}`;
    const pill = document.getElementById('holidayApplies');
    pill.textContent = applies ? 'APLICA' : 'NO APLICA';
    pill.className = applies
      ? 'text-[10px] font-black px-2 py-1 rounded-full bg-emerald-100 text-emerald-800'
      : 'text-[10px] font-black px-2 py-1 rounded-full bg-gray-200 text-gray-700';
  } else {
    holidayBox.classList.add('hidden');
  }

  if(mode==='simple'){
    document.getElementById('tIn').value = info.tIn || (SHIFTS[selS]?.in || '00:00');
    document.getElementById('tOut').value = info.tOut || (SHIFTS[selS]?.out || '00:00');
    document.getElementById('tHrs').value = (info.h ?? calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value)).toFixed(1);

    document.getElementById('time-simple').classList.remove('hidden');
    document.getElementById('time-mixto').classList.add('hidden');
  } else {
    document.getElementById('tInTop').value = info.tInTop || (SHIFTS[selT]?.in || '00:00');
    document.getElementById('tOutTop').value = info.tOutTop || (SHIFTS[selT]?.out || '00:00');
    document.getElementById('tInBottom').value = info.tInBottom || (SHIFTS[selB]?.in || '00:00');
    document.getElementById('tOutBottom').value = info.tOutBottom || (SHIFTS[selB]?.out || '00:00');

    const hrsTop = info.hrsTop ?? calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
    const hrsBottom = info.hrsBottom ?? calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);

    document.getElementById('tHrsTop').value = Number(hrsTop).toFixed(1);
    document.getElementById('tHrsBottom').value = Number(hrsBottom).toFixed(1);
    document.getElementById('tHrsMixto').value = Number(hrsTop+hrsBottom).toFixed(1);

    document.getElementById('time-simple').classList.add('hidden');
    document.getElementById('time-mixto').classList.remove('hidden');
  }

  const note = String(info.n||'').trim();
  if(!note){
    document.getElementById('nota').value = (mode==='simple')
      ? defaultNoteForShift(selS)
      : `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
  } else {
    document.getElementById('nota').value = info.n;
  }

  setMode(mode);
  refreshShiftButtons();
  document.getElementById('modal').classList.add('active');
}

function closeModal(){ document.getElementById('modal').classList.remove('active'); }

function setMode(m){
  mode=m;
  document.getElementById('m-s').className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m==='simple'?'bg-white shadow-md text-blue-600':'text-gray-400'}`;
  document.getElementById('m-m').className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m==='mixto'?'bg-white shadow-md text-blue-600':'text-gray-400'}`;
  document.getElementById('sec-simple').classList.toggle('hidden', m!=='simple');
  document.getElementById('sec-mixto').classList.toggle('hidden', m!=='mixto');
}

function refreshShiftButtons(){
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const shiftKeys = Object.keys(SHIFTS)
    .filter(k=> showAllShifts ? true : !!SHIFTS[k].visible)
    .sort((a,b)=> (SHIFTS[a].label||a).localeCompare(SHIFTS[b].label||b));

  const mkBtn=(k, selected)=>{
    const b=document.createElement('div');
    b.className = `shift-option ${selected?'selected':''} bg-${SHIFTS[k]?.color||'L'}`;
    b.textContent = SHIFTS[k]?.label || k;
    return b;
  };

  const sC=document.getElementById('sec-simple');
  sC.innerHTML='';
  shiftKeys.forEach(k=>{
    const b=mkBtn(k, selS===k);
    b.onclick=()=>{
      selS=k;
      document.getElementById('tIn').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOut').value = SHIFTS[k]?.out || '00:00';
      autoCalc();
      if(!document.getElementById('nota').value.trim()) document.getElementById('nota').value = defaultNoteForShift(selS);
      refreshShiftButtons();
    };
    sC.appendChild(b);
  });

  const tC=document.getElementById('mix-t');
  tC.innerHTML='';
  shiftKeys.forEach(k=>{
    const b=mkBtn(k, selT===k);
    b.onclick=()=>{
      selT=k;
      document.getElementById('tInTop').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOutTop').value = SHIFTS[k]?.out || '00:00';
      autoCalcMixtoTop();
      if(!document.getElementById('nota').value.trim()) document.getElementById('nota').value = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
      refreshShiftButtons();
    };
    tC.appendChild(b);
  });

  const bC=document.getElementById('mix-b');
  bC.innerHTML='';
  shiftKeys.forEach(k=>{
    const b=mkBtn(k, selB===k);
    b.onclick=()=>{
      selB=k;
      document.getElementById('tInBottom').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOutBottom').value = SHIFTS[k]?.out || '00:00';
      autoCalcMixtoBottom();
      if(!document.getElementById('nota').value.trim()) document.getElementById('nota').value = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
      refreshShiftButtons();
    };
    bC.appendChild(b);
  });
}

function autoCalc(){ document.getElementById('tHrs').value = calculateHours(tIn.value, tOut.value).toFixed(1); }
function manualCalc(){ document.getElementById('tHrs').value = (parseFloat(tHrs.value)||0).toFixed(1); }

function autoCalcMixtoTop(){
  tHrsTop.value = calculateHours(tInTop.value, tOutTop.value).toFixed(1);
  updateMixtoTotal();
}
function autoCalcMixtoBottom(){
  tHrsBottom.value = calculateHours(tInBottom.value, tOutBottom.value).toFixed(1);
  updateMixtoTotal();
}
function manualCalcMixtoTop(){ tHrsTop.value=(parseFloat(tHrsTop.value)||0).toFixed(1); updateMixtoTotal(); }
function manualCalcMixtoBottom(){ tHrsBottom.value=(parseFloat(tHrsBottom.value)||0).toFixed(1); updateMixtoTotal(); }
function updateMixtoTotal(){ tHrsMixto.value = ((parseFloat(tHrsTop.value)||0)+(parseFloat(tHrsBottom.value)||0)).toFixed(1); }

function maybeAutoNoteSimple(){ if(!nota.value.trim()) nota.value = defaultNoteForShift(selS); }
function maybeAutoNoteMixto(){ if(!nota.value.trim()) nota.value = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`; }

function saveDay(){
  const user=db.users[db.current];
  const data = { mode, s:selS, t:selT, b:selB, n: nota.value };

  if(mode==='simple'){
    data.tIn = tIn.value;
    data.tOut = tOut.value;
    data.h = parseFloat(tHrs.value)||0;
    if(!String(data.n||'').trim()) data.n = defaultNoteForShift(selS);
  } else {
    data.tInTop = tInTop.value; data.tOutTop = tOutTop.value;
    data.tInBottom = tInBottom.value; data.tOutBottom = tOutBottom.value;
    data.hrsTop = parseFloat(tHrsTop.value)||0;
    data.hrsBottom = parseFloat(tHrsBottom.value)||0;
    data.h = parseFloat(tHrsMixto.value)||0;
    if(!String(data.n||'').trim()) data.n = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`;
  }

  user.data[activeKey]=data;
  saveDB();
  render();
  closeModal();
}

/* ============================ Summary (dynamic categories) ============================ */
function calcSummary(){
  const y=current.getFullYear();
  const m0=current.getMonth();
  const m1=m0+1;
  const user=db.users[db.current];
  const SHIFTS=user.config;

  // totals per category id
  const catTotals = {};
  const catDays = {};
  let totalWorkHours = 0;
  let workedDays=0, freeDays=0, vacDays=0, weekendDays=0, holidayWorked=0;

  const daysInMonth = new Date(y,m0+1,0).getDate();
  freeDays = daysInMonth;

  for(let d=1; d<=daysInMonth; d++){
    const dow = new Date(y,m0,d).getDay();
    if(dow===0 || dow===6) weekendDays++;
  }

  const applicableHolidays = countApplicableHolidaysInMonth(y,m0,user.locality);

  const getCat = (shiftId)=> (SHIFTS[shiftId]?.cat || 'off');
  const addCat = (catId, hrs)=>{
    catTotals[catId] = (catTotals[catId]||0) + (hrs||0);
    catDays[catId] = (catDays[catId]||0) + 1;
  };

  for(const k of Object.keys(user.data)){
    if(!k.startsWith(`${y}-${m1}-`)) continue;
    const dObj = user.data[k];
    const dayNum = parseInt(k.split('-')[2]);
    const rules = getHolidayForDate(y,m0,dayNum);
    const isHolidayApplicable = rules.some(r=>holidayApplies(r.location, user.locality));

    freeDays--;

    if(dObj.mode==='mixto'){
      const topCat = getCat(dObj.t);
      const botCat = getCat(dObj.b);

      const topHrs = dObj.hrsTop ?? calculateHours(dObj.tInTop || SHIFTS[dObj.t]?.in, dObj.tOutTop || SHIFTS[dObj.t]?.out);
      const botHrs = dObj.hrsBottom ?? calculateHours(dObj.tInBottom || SHIFTS[dObj.b]?.in, dObj.tOutBottom || SHIFTS[dObj.b]?.out);

      addCat(topCat, topHrs);
      addCat(botCat, botHrs);

      const anyWork = (topCat!=='off' && topHrs>0) || (botCat!=='off' && botHrs>0);
      if(anyWork){ workedDays++; totalWorkHours += (topHrs+botHrs); }
      if(isHolidayApplicable && anyWork) holidayWorked++;

      // off category adjustments
      if(topCat==='off') freeDays++;
      if(botCat==='off') freeDays++;
    } else {
      const cat = getCat(dObj.s);
      const hrs = dObj.h ?? 0;
      addCat(cat, hrs);

      if(cat==='off'){
        freeDays++;
        if(dObj.s==='Vacaciones') vacDays++;
      } else {
        workedDays++;
        totalWorkHours += hrs;
        if(isHolidayApplicable) holidayWorked++;
      }
    }
  }

  freeDays = Math.max(0, freeDays);

  // build dynamic cards
  document.getElementById('profile-loc').textContent = `Localidad: ${user.locality || 'San Salvador'}`;
  const cards = document.getElementById('summaryCards');
  cards.innerHTML = '';

  // show only categories that appear or always show main ones
  const catIds = Object.keys(db.categories);
  const sorted = catIds.sort((a,b)=> (db.categories[a].name||a).localeCompare(db.categories[b].name||b));

  sorted.forEach(cid=>{
    const hrs = (catTotals[cid]||0);
    const days = (catDays[cid]||0);
    if(hrs===0 && days===0) return;
    const c = db.categories[cid] || {name:cid, icon:'ğŸ“Œ'};
    cards.innerHTML += `
      <div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border-l-[10px] border-gray-200">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-400 uppercase">${escapeHTML(c.icon||'')} ${escapeHTML(c.name||cid)}</p>
          <span class="text-[10px] font-black bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${days} marca(s)</span>
        </div>
        <div class="text-3xl md:text-4xl font-black text-gray-900 tracking-tighter">${hrs.toFixed(1)} HRS</div>
      </div>
    `;
  });

  document.getElementById('total-off').textContent = (freeDays + vacDays + weekendDays);
  document.getElementById('free-days').textContent = freeDays;
  document.getElementById('vac-days').textContent = vacDays;
  document.getElementById('weekend-days').textContent = weekendDays;
  document.getElementById('holiday-worked').textContent = holidayWorked;

  document.getElementById('worked-days').textContent = workedDays;
  const avg = workedDays>0 ? (totalWorkHours/workedDays) : 0;
  document.getElementById('avg-hours').textContent = `${avg.toFixed(1)}h`;
  document.getElementById('total-days').textContent = daysInMonth;
  document.getElementById('total-holidays').textContent = applicableHolidays;
}

/* ============================ Turnos settings ============================ */
function toggleShowAllShifts(){
  showAllShifts = !showAllShifts;
  document.getElementById('showAllShiftsLabel').textContent = showAllShifts ? 'Ocultar extra' : 'Mostrar todos';
  renderSettings();
}
function renderSettings(){
  const container=document.getElementById('settings-container');
  container.innerHTML='';
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const keys = Object.keys(SHIFTS)
    .filter(k=> showAllShifts ? true : !!SHIFTS[k].visible)
    .sort((a,b)=> (SHIFTS[a].label||a).localeCompare(SHIFTS[b].label||b));

  keys.forEach(id=>{
    const conf=SHIFTS[id];
    container.innerHTML += `
      <div class="flex items-start gap-3 bg-gradient-to-r from-gray-50 to-white p-4 rounded-2xl border border-gray-200">
        <div class="w-10 h-10 rounded-full bg-${escapeAttr(conf.color||'L')} border-2 border-white shadow-sm flex items-center justify-center">
          <span class="text-[10px] font-black text-gray-800">${escapeHTML((conf.label||id).charAt(0))}</span>
        </div>
        <div class="flex-1">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</p>
              <input id="set-label-${cssSafe(id)}" value="${escapeHTML(conf.label||id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">CategorÃ­a</p>
              <select id="set-cat-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
                ${Object.keys(db.categories).map(cid=>{
                  const c=db.categories[cid];
                  return `<option value="${cid}" ${conf.cat===cid?'selected':''}>${escapeHTML(c.icon||'')} ${escapeHTML(c.name||cid)}</option>`;
                }).join('')}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mt-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Color</p>
              <select id="set-color-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
                ${['MaÃ±ana','Tarde','CENA','16hrs','CumpleaÃ±os','L','Vacaciones','azul','rojo','verde','naranja','rosa','cian','morado','lima','ambar','teal','indigo','gris'].map(x=>`<option value="${x}" ${conf.color===x?'selected':''}>${x}</option>`).join('')}
              </select>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Entrada</p>
              <input type="time" id="set-in-${cssSafe(id)}" value="${conf.in||'00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Salida</p>
              <input type="time" id="set-out-${cssSafe(id)}" value="${conf.out||'00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div class="flex items-end">
              <label class="flex items-center gap-2 text-[11px] font-black text-gray-700">
                <input type="checkbox" id="set-vis-${cssSafe(id)}" ${conf.visible?'checked':''}> Visible
              </label>
            </div>
          </div>

          <div class="mt-2 text-[10px] font-bold text-gray-600">
            Nota sugerida: <span class="text-gray-900 font-black">${defaultNoteForShift(id)}</span>
          </div>
        </div>

        <button onclick="deleteShift('${escapeAttr(id)}')" class="p-2 text-red-600 hover:text-red-800 font-black" title="Eliminar turno">ğŸ—‘ï¸</button>
      </div>
    `;
  });

  loadCategoriesSelect();
}

function saveShiftSettings(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const propagate = document.getElementById('propagateShiftEdits').checked;
  const old = deepClone(SHIFTS);

  Object.keys(SHIFTS).forEach(id=>{
    const key = cssSafe(id);
    const label = document.getElementById(`set-label-${key}`)?.value?.trim() || id;
    const cat = document.getElementById(`set-cat-${key}`)?.value || SHIFTS[id].cat;
    const color = document.getElementById(`set-color-${key}`)?.value || SHIFTS[id].color;
    const inT = document.getElementById(`set-in-${key}`)?.value || SHIFTS[id].in || '00:00';
    const outT = document.getElementById(`set-out-${key}`)?.value || SHIFTS[id].out || '00:00';
    const vis = !!document.getElementById(`set-vis-${key}`)?.checked;

    SHIFTS[id].label = label;
    SHIFTS[id].cat = cat;
    SHIFTS[id].color = color;
    SHIFTS[id].in = inT;
    SHIFTS[id].out = outT;
    SHIFTS[id].visible = vis;
  });

  if(propagate){
    const y=current.getFullYear();
    const m1=current.getMonth()+1;
    Object.keys(user.data).forEach(k=>{
      if(!k.startsWith(`${y}-${m1}-`)) return;
      const d = user.data[k];

      const updateSimple = (sid)=>{
        const was = old[sid];
        const now = SHIFTS[sid];
        if(!was || !now) return;
        if(was.in!==now.in || was.out!==now.out){
          d.tIn = now.in; d.tOut = now.out; d.h = calculateHours(now.in, now.out);
          const wasNote = String(d.n||'').trim();
          const oldStd = (was.in && was.out && !(was.in==='00:00'&&was.out==='00:00')) ? `${was.in}-${was.out}` : (was.label||sid).toUpperCase();
          const newStd = (now.in && now.out && !(now.in==='00:00'&&now.out==='00:00')) ? `${now.in}-${now.out}` : (now.label||sid).toUpperCase();
          if(!wasNote || wasNote===oldStd) d.n = newStd;
        }
      };

      if(d.mode==='simple'){
        if(d.s && SHIFTS[d.s]) updateSimple(d.s);
      } else {
        const updPart = (sid, inField, outField, hrsField)=>{
          const was=old[sid], now=SHIFTS[sid];
          if(!was || !now) return;
          if(was.in!==now.in || was.out!==now.out){
            d[inField]=now.in; d[outField]=now.out;
            d[hrsField]=calculateHours(now.in, now.out);
          }
        };
        if(d.t && SHIFTS[d.t]) updPart(d.t,'tInTop','tOutTop','hrsTop');
        if(d.b && SHIFTS[d.b]) updPart(d.b,'tInBottom','tOutBottom','hrsBottom');
        d.h = (parseFloat(d.hrsTop)||0)+(parseFloat(d.hrsBottom)||0);
      }
    });
  }

  saveDB();
  render();
  alert("Turnos actualizados.");
}

function deleteShift(id){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const user=db.users[db.current];

  const used = Object.values(user.data).some(d=>{
    if(d.mode==='mixto') return d.t===id || d.b===id;
    return d.s===id;
  });
  if(used) return alert("No se puede eliminar: el turno estÃ¡ usado en el calendario del perfil.");

  if(!confirm(`Â¿Eliminar turno "${id}"?`)) return;
  delete user.config[id];
  saveDB();
  renderSettings();
  render();
}

/* ============================ New shift ============================ */
function loadCategoriesSelect(){
  const select=document.getElementById('newShiftCat');
  if(!select) return;
  select.innerHTML = Object.keys(db.categories).map(cid=>{
    const c=db.categories[cid];
    return `<option value="${cid}">${escapeHTML(c.icon||'')} ${escapeHTML(c.name||cid)}</option>`;
  }).join('');
}

function addNewShift(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const name=document.getElementById('newShiftName').value.trim();
  const color=document.getElementById('newShiftColor').value;
  const cat=document.getElementById('newShiftCat').value;
  const inT=document.getElementById('newShiftIn').value||'00:00';
  const outT=document.getElementById('newShiftOut').value||'00:00';
  const visible=document.getElementById('newShiftVisible').checked;

  if(!name) return alert("Nombre requerido.");
  const key = name.replace(/\s+/g,'_');
  const user=db.users[db.current];
  if(user.config[key]) return alert("Ya existe un turno con ese ID.");

  user.config[key]={ label:name, color, cat, in:inT, out:outT, visible };
  saveDB();
  renderSettings();
  render();
  document.getElementById('newShiftName').value='';
  document.getElementById('newShiftIn').value='';
  document.getElementById('newShiftOut').value='';
  alert("Turno agregado.");
}

/* ============================ Categories (all editable) ============================ */
function renderCategories(){
  const container=document.getElementById('categories-container');
  container.innerHTML='';

  const ids=Object.keys(db.categories).sort((a,b)=> (db.categories[a].name||a).localeCompare(db.categories[b].name||b));
  ids.forEach(cid=>{
    const c=db.categories[cid];
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-lg">${escapeHTML(c.icon||'ğŸ“Œ')}</div>
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="cat-name-${cid}" value="${escapeHTML(c.name||cid)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Icono</div>
            <input id="cat-icon-${cid}" value="${escapeHTML(c.icon||'')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-2 text-[10px] font-bold text-gray-500">
            ID: <span class="font-black text-gray-800">${cid}</span>
          </div>
        </div>
        <button onclick="deleteCategory('${cid}')" class="p-2 text-red-600 hover:text-red-800 font-black">ğŸ—‘ï¸</button>
      </div>
    `;
  });
}

function addNewCategory(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const name=document.getElementById('newCategoryName').value.trim();
  const icon=document.getElementById('newCategoryIcon').value.trim() || 'ğŸ“Œ';
  if(!name) return alert("Nombre requerido.");

  const cid = name.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  if(db.categories[cid]) return alert("Ya existe una categorÃ­a con ese ID.");

  db.categories[cid]={ name, icon };
  saveDB();
  document.getElementById('newCategoryName').value='';
  document.getElementById('newCategoryIcon').value='';
  renderCategories();
  loadCategoriesSelect();
  renderSettings();
  alert("CategorÃ­a agregada.");
}

function deleteCategory(cid){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const used = Object.values(db.users).some(u=> Object.values(u.config).some(s=>s.cat===cid));
  if(used) return alert("No se puede eliminar: hay turnos usando esta categorÃ­a.");
  if(!confirm(`Â¿Eliminar categorÃ­a "${db.categories[cid]?.name||cid}"?`)) return;
  delete db.categories[cid];
  saveDB();
  renderCategories();
  loadCategoriesSelect();
  renderSettings();
  render();
}

function saveCategories(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  Object.keys(db.categories).forEach(cid=>{
    const name = document.getElementById(`cat-name-${cid}`)?.value?.trim();
    const icon = document.getElementById(`cat-icon-${cid}`)?.value?.trim();
    if(name) db.categories[cid].name=name;
    if(icon) db.categories[cid].icon=icon;
  });
  saveDB();
  renderCategories();
  loadCategoriesSelect();
  renderSettings();
  render();
  alert("CategorÃ­as actualizadas.");
}

/* ============================ Localities ============================ */
function refreshHolidayLocationSelects(){
  const sel=document.getElementById('newHolidayLocation');
  if(sel){
    sel.innerHTML = db.localities.map(l=>`<option value="${escapeAttr(l)}">${escapeHTML(l)}</option>`).join('');
    sel.value = db.localities.find(x=>x.trim().toUpperCase()==='SAN SALVADOR') || 'San Salvador';
  }
  const createLoc=document.getElementById('createLoc');
  if(createLoc){
    createLoc.innerHTML = db.localities.filter(l=>l.trim().toUpperCase()!=='GENERAL').map(l=>`<option value="${escapeAttr(l)}">${escapeHTML(l)}</option>`).join('');
    createLoc.value='San Salvador';
  }
}

function renderLocalities(){
  const container=document.getElementById('localities-container');
  container.innerHTML='';

  db.localities = Array.from(new Set(db.localities.map(x=>String(x).trim()).filter(Boolean)));
  if(!db.localities.some(x=>x.toUpperCase()==='GENERAL')) db.localities.unshift('General');
  if(!db.localities.some(x=>x.toUpperCase()==='SAN SALVADOR')) db.localities.push('San Salvador');

  db.localities.forEach((loc, idx)=>{
    const isGeneral = loc.trim().toUpperCase()==='GENERAL';
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center font-black text-sky-700">ğŸ“</div>
        <div class="flex-1">
          <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
          <input id="loc-${idx}" value="${escapeHTML(loc)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${isGeneral?'disabled':''}/>
          <div class="text-[10px] font-bold text-gray-500 mt-1">${isGeneral?'Reservado.':''}</div>
        </div>
        ${isGeneral? `<span class="text-[9px] font-black text-gray-400">Bloqueado</span>` : `<button onclick="deleteLocality(${idx})" class="p-2 text-red-600 hover:text-red-800 font-black">ğŸ—‘ï¸</button>`}
      </div>
    `;
  });

  refreshHolidayLocationSelects();
}

function addLocality(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const name=document.getElementById('newLocalityName').value.trim();
  if(!name) return alert("Nombre requerido.");
  if(name.toUpperCase()==='GENERAL') return alert("â€œGeneralâ€ es reservado.");
  if(db.localities.some(x=>x.trim().toUpperCase()===name.trim().toUpperCase())) return alert("Ya existe esa localidad.");

  db.localities.push(name);
  document.getElementById('newLocalityName').value='';
  saveDB();
  renderLocalities();
  renderHolidayRules();
  alert("Localidad agregada.");
}

function deleteLocality(idx){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const loc=db.localities[idx];
  if(!loc || loc.toUpperCase()==='GENERAL') return;

  const usedUser = Object.values(db.users).some(u => (u.locality||'').trim().toUpperCase() === loc.trim().toUpperCase());
  const usedHoliday = (db.holidayRules||[]).some(h => (h.location||'').trim().toUpperCase() === loc.trim().toUpperCase());
  if(usedUser || usedHoliday) return alert("No se puede eliminar: estÃ¡ en uso por perfiles o asuetos. Cambia primero esas referencias.");
  if(!confirm(`Â¿Eliminar localidad "${loc}"?`)) return;

  db.localities.splice(idx,1);
  saveDB();
  renderLocalities();
  renderHolidayRules();
}

function saveLocalities(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");

  const oldList = [...db.localities];
  const newList = [];

  const renamePairs = [];
  for(let i=0;i<oldList.length;i++){
    const oldLoc = oldList[i];
    const isGeneral = oldLoc.trim().toUpperCase()==='GENERAL';
    if(isGeneral){ newList.push('General'); continue; }
    const v = document.getElementById(`loc-${i}`)?.value?.trim();
    if(!v) continue;
    if(v.toUpperCase()==='GENERAL') continue;
    newList.push(v);

    const from=oldLoc.trim(), to=v.trim();
    if(from.toUpperCase()!==to.toUpperCase()) renamePairs.push([from,to]);
  }

  if(!newList.some(x=>x.toUpperCase()==='GENERAL')) newList.unshift('General');
  if(!newList.some(x=>x.toUpperCase()==='SAN SALVADOR')) newList.push('San Salvador');

  db.localities = Array.from(new Set(newList.map(x=>String(x).trim()).filter(Boolean)));

  // propagate renames
  renamePairs.forEach(([from,to])=>{
    Object.values(db.users).forEach(u=>{
      if((u.locality||'').trim().toUpperCase()===from.trim().toUpperCase()) u.locality=to;
    });
    (db.holidayRules||[]).forEach(r=>{
      if((r.location||'').trim().toUpperCase()===from.trim().toUpperCase()) r.location=to;
    });
  });

  saveDB();
  renderLocalities();
  renderHolidayRules();
  renderProfilesList();
  render();
  alert("Localidades actualizadas.");
}

/* ============================ Holiday rules UI ============================ */
function normalizeMD(md){
  const m = String(md||'').trim();
  const match = m.match(/^(\d{1,2})-(\d{1,2})$/);
  if(!match) return null;
  const mm = Math.max(1, Math.min(12, parseInt(match[1],10)));
  const dd = Math.max(1, Math.min(31, parseInt(match[2],10)));
  return `${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
}

function renderHolidayRules(){
  const container=document.getElementById('holidays-container');
  container.innerHTML='';

  const rules = (db.holidayRules||[]).slice().sort((a,b)=> String(a.md).localeCompare(String(b.md)));
  if(rules.length===0){
    container.innerHTML = `<div class="p-8 text-center text-gray-400 font-bold">No hay asuetos.</div>`;
    return;
  }

  rules.forEach((r, idx)=>{
    container.innerHTML += `
      <div class="p-4 border-b border-gray-100">
        <div class="flex items-center justify-between gap-2">
          <div class="font-black text-gray-900 text-[12px]">${escapeHTML(r.name||'Asueto')}</div>
          <button onclick="deleteHolidayRule(${idx})" class="p-2 text-red-600 hover:text-red-800 font-black">ğŸ—‘ï¸</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Mes/DÃ­a</div>
            <input id="hr-md-${idx}" value="${escapeHTML(r.md||'')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="hr-name-${idx}" value="${escapeHTML(r.name||'')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="hr-loc-${idx}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
              ${db.localities.map(l=>`<option value="${escapeAttr(l)}" ${(r.location||'General')===l?'selected':''}>${escapeHTML(l)}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
    `;
  });
}

function addHolidayRule(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const mdRaw=document.getElementById('newHolidayMD').value;
  const name=document.getElementById('newHolidayName').value.trim();
  const loc=document.getElementById('newHolidayLocation').value || 'General';

  const md = normalizeMD(mdRaw);
  if(!md || !name) return alert("Mes/DÃ­a invÃ¡lido (formato MM-DD) y nombre requerido.");

  db.holidayRules.push({md, name, location:loc});
  document.getElementById('newHolidayMD').value='';
  document.getElementById('newHolidayName').value='';
  saveDB();
  renderHolidayRules();
  render();
  alert("Asueto agregado.");
}

function deleteHolidayRule(idx){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  if(!confirm("Â¿Eliminar este asueto?")) return;
  db.holidayRules.splice(idx,1);
  saveDB();
  renderHolidayRules();
  render();
}

function saveHolidayRules(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const rules = (db.holidayRules||[]);
  const newRules = [];

  for(let i=0;i<rules.length;i++){
    const md = normalizeMD(document.getElementById(`hr-md-${i}`)?.value);
    const name = document.getElementById(`hr-name-${i}`)?.value?.trim();
    const loc = document.getElementById(`hr-loc-${i}`)?.value || 'General';
    if(!md || !name) continue;
    newRules.push({md, name, location:loc});
  }

  db.holidayRules = newRules;
  saveDB();
  renderHolidayRules();
  render();
  alert("Asuetos actualizados.");
}

/* ============================ PIN only ============================ */
function savePinOnly(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const user=db.users[db.current];
  const p=document.getElementById('changePinInput').value;
  const c=document.getElementById('confirmPinInput').value;
  if(!p || p.length!==4 || isNaN(p)) return alert("PIN invÃ¡lido.");
  if(p!==c) return alert("PIN no coincide.");
  user.pin=p;
  document.getElementById('changePinInput').value='';
  document.getElementById('confirmPinInput').value='';
  saveDB();
  alert("PIN actualizado.");
}

/* ============================ Profiles ============================ */
function openProfilesModal(){
  refreshHolidayLocationSelects();
  renderProfilesList();
  document.getElementById('profilesModal').classList.add('active');
}
function closeProfilesModal(){ document.getElementById('profilesModal').classList.remove('active'); }

function createProfile(){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const name=document.getElementById('createName').value.trim().toUpperCase();
  const pin=document.getElementById('createPin').value.trim();
  const loc=document.getElementById('createLoc').value || 'San Salvador';

  if(!name || name.length<2) return alert("Nombre invÃ¡lido.");
  if(!pin || pin.length!==4 || isNaN(pin)) return alert("PIN invÃ¡lido.");
  if(db.users[name]) return alert("Ya existe ese perfil.");

  db.users[name] = deepClone(db.users['ADMIN']);
  db.users[name].pin = pin;
  db.users[name].locality = loc;
  db.users[name].data = {};
  db.users[name].editLocked = false;

  db.current = name;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  alert("Perfil creado.");
}

function renderProfilesList(){
  const box=document.getElementById('profilesList');
  box.innerHTML='';
  const keys=Object.keys(db.users).sort();

  keys.forEach(u=>{
    const user=db.users[u];
    const isCurrent = (u===db.current);
    box.innerHTML += `
      <div class="border border-gray-200 rounded-2xl p-3 ${isCurrent?'bg-blue-50 border-blue-200':''}">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="font-black text-gray-900 text-[12px]">${escapeHTML(u)} ${isCurrent?'<span class="ml-2 text-[9px] font-black text-blue-600">(Actual)</span>':''}</div>
            <div class="text-[10px] font-bold text-gray-500">Localidad: <span class="font-black text-gray-800">${escapeHTML(user.locality||'San Salvador')}</span></div>
          </div>
          <div class="flex gap-2">
            <button onclick="setCurrentProfile('${escapeAttr(u)}')" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Usar</button>
            ${u==='ADMIN' ? '' : `<button onclick="deleteProfile('${escapeAttr(u)}')" class="px-3 py-2 rounded-xl bg-red-100 hover:bg-red-200 text-red-700 text-[10px] font-black uppercase">Eliminar</button>`}
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Renombrar perfil</div>
            <input id="p-name-${cssSafe(u)}" value="${escapeHTML(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${u==='ADMIN'?'disabled':''}/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">PIN</div>
            <input id="p-pin-${cssSafe(u)}" value="${escapeHTML(user.pin||'0000')}" maxlength="4" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="p-loc-${cssSafe(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
              ${db.localities.filter(l=>l.trim().toUpperCase()!=='GENERAL').map(l=>`<option value="${escapeAttr(l)}" ${(user.locality||'San Salvador')===l?'selected':''}>${escapeHTML(l)}</option>`).join('')}
            </select>
          </div>
          <div class="md:col-span-3">
            <button onclick="saveProfileEdits('${escapeAttr(u)}')" class="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[11px]">
              ğŸ’¾ Guardar cambios de este perfil
            </button>
          </div>
        </div>
      </div>
    `;
  });
}

function setCurrentProfile(u){
  db.current=u;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
}

function deleteProfile(u){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  if(u==='ADMIN') return;
  if(!confirm(`Â¿Eliminar perfil "${u}"? Se perderÃ¡ su calendario.`)) return;

  delete db.users[u];
  if(db.current===u) db.current='ADMIN';
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
}

function saveProfileEdits(u){
  if(!isEditMode()) return alert("Activa modo ediciÃ³n.");
  const user=db.users[u];
  if(!user) return;

  const pin = document.getElementById(`p-pin-${cssSafe(u)}`)?.value?.trim();
  const loc = document.getElementById(`p-loc-${cssSafe(u)}`)?.value || 'San Salvador';

  if(!pin || pin.length!==4 || isNaN(pin)) return alert("PIN invÃ¡lido (4 dÃ­gitos).");
  user.pin = pin;
  user.locality = loc;

  if(u!=='ADMIN'){
    const newName = document.getElementById(`p-name-${cssSafe(u)}`)?.value?.trim()?.toUpperCase();
    if(newName && newName!==u){
      if(db.users[newName]) return alert("No se puede renombrar: ya existe ese nombre.");
      db.users[newName] = user;
      delete db.users[u];
      if(db.current===u) db.current=newName;
    }
  }

  saveDB();
  updateUserDropdown();
  updateUserInitial();
  renderProfilesList();
  render();
  alert("Perfil actualizado.");
}

/* ============================ Import modal ============================ */
function openImportModal(){
  importContext=null;
  importInfo.innerText='';
  importFile.value='';
  importUsersList.innerHTML = `<div class="text-gray-400 font-bold">Adjunta un Excel y presiona â€œAnalizarâ€.</div>`;
  importMonth.value = current.getMonth();
  importYear.value = current.getFullYear();
  document.getElementById('importModal').classList.add('active');
}
function closeImportModal(){ document.getElementById('importModal').classList.remove('active'); }
function selectAllImportUsers(flag){ document.querySelectorAll('.impUserChk').forEach(ch=> ch.checked = !!flag); }

/* ---- Excel detection heuristics ---- */
function detectMonthYearFromRows(rows){
  const monthsMap = {'ENERO':0,'FEBRERO':1,'MARZO':2,'ABRIL':3,'MAYO':4,'JUNIO':5,'JULIO':6,'AGOSTO':7,'SEPTIEMBRE':8,'OCTUBRE':9,'NOVIEMBRE':10,'DICIEMBRE':11};
  let foundMonth=null, foundYear=null;
  for(let r=0;r<Math.min(rows.length,80);r++){
    const row=rows[r]||[];
    for(let c=0;c<row.length;c++){
      const v=row[c]; if(!v) continue;
      const s=String(v).toUpperCase();
      Object.keys(monthsMap).forEach(mn=>{ if(s.includes(mn) && foundMonth===null) foundMonth=monthsMap[mn]; });
      const yMatch=s.match(/(AÃ‘O|ANIO)\s*([0-9]{4})/);
      if(yMatch) foundYear=parseInt(yMatch[2]);
    }
  }
  return {month:foundMonth, year:foundYear};
}

function scoreHeaderCandidate(row){
  // score by how many day numbers 1..31 exist
  let count=0;
  for(const v of row){
    const s=String(v||'').trim();
    if(/^\d+$/.test(s)){
      const d=parseInt(s,10);
      if(d>=1 && d<=31) count++;
    }
  }
  return count;
}

function findHeaderRow(rows){
  // pick row with max day-count, prefer >= 15
  let bestIdx=-1, bestScore=0;
  for(let r=0;r<rows.length;r++){
    const row=rows[r]||[];
    const sc=scoreHeaderCandidate(row);
    if(sc>bestScore){
      bestScore=sc; bestIdx=r;
    }
  }
  if(bestScore>=12) return bestIdx;
  return -1;
}

function buildDayColumnMap(headerRow){
  const map={};
  for(let c=0;c<headerRow.length;c++){
    const s=String(headerRow[c]||'').trim();
    if(/^\d+$/.test(s)){
      const d=parseInt(s,10);
      if(d>=1&&d<=31) map[d]=c;
    }
  }
  return map;
}

function detectNameCol(headerRow){
  const candidates = ['PERSONAL','NOMBRE','EMPLEADO','COLABORADOR','TRABAJADOR'];
  for(let c=0;c<headerRow.length;c++){
    const s=String(headerRow[c]||'').toUpperCase().trim();
    if(candidates.some(k=>s.includes(k))) return c;
  }
  // fallback: first text-like col
  for(let c=0;c<headerRow.length;c++){
    const s=String(headerRow[c]||'').trim();
    if(s && !/^\d+$/.test(s)) return c;
  }
  return -1;
}

function isLikelyDataRow(row, nameCol, dayCols){
  const name=String(row[nameCol]||'').trim().toUpperCase();
  if(!name) return false;
  if(name.includes('TOTAL') || name.includes('PERSONAL')) return false;
  // any code present
  for(const d of Object.keys(dayCols)){
    const code=normalizeCode(row[dayCols[d]]);
    if(code && code!=='X') return true;
  }
  return false;
}

async function analyzeImportFile(){
  if(!importFile.files || !importFile.files[0]) return alert("Selecciona un archivo.");

  const data = await importFile.files[0].arrayBuffer();
  const wb = XLSX.read(data, {type:'array'});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''});

  const detected = detectMonthYearFromRows(rows);
  const fallbackMonth = parseInt(importMonth.value);
  const fallbackYear = parseInt(importYear.value);
  const monthIndex0 = (detected.month ?? fallbackMonth);
  const year = (detected.year ?? fallbackYear);

  const headerIdx=findHeaderRow(rows);
  if(headerIdx<0) return alert("No pude detectar encabezados (dÃ­as 1..31).");

  const headerRow = rows[headerIdx]||[];
  const dayCols = buildDayColumnMap(headerRow);
  if(Object.keys(dayCols).length<10) return alert("Encabezado detectado pero con pocos dÃ­as. Revisa el Excel.");

  const nameCol = detectNameCol(headerRow);
  if(nameCol<0) return alert("No pude detectar columna de nombres.");

  // collect users
  const usersSet=new Set();
  for(let r=headerIdx+1;r<rows.length;r++){
    const row=rows[r]||[];
    if(!isLikelyDataRow(row,nameCol,dayCols)) continue;
    const nm = String(row[nameCol]||'').replace(/\s+/g,' ').trim().toUpperCase();
    if(nm) usersSet.add(nm);
  }

  importContext = { rows, headerIdx, nameCol, dayCols, monthIndex0, year, users: Array.from(usersSet).sort() };

  if(importContext.users.length===0){
    importUsersList.innerHTML = `<div class="text-gray-400 font-bold">No se detectaron usuarios.</div>`;
  } else {
    importUsersList.innerHTML = importContext.users.map(u=>`
      <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
        <input class="impUserChk" type="checkbox" value="${escapeAttr(u)}" checked>
        <span class="font-black text-gray-800">${escapeHTML(u)}</span>
      </label>
    `).join('');
  }

  importInfo.innerText = `Detectado: ${MONTHS[monthIndex0]} ${year}. Usuarios: ${importContext.users.length}.`;
}

function clearMonthForUser(userKey, year, monthIndex0){
  const user=db.users[userKey];
  const prefix = `${year}-${monthIndex0+1}-`;
  Object.keys(user.data).forEach(k=>{ if(k.startsWith(prefix)) delete user.data[k]; });
}

function setDayForUser(userKey, year, monthIndex0, day, shiftDef, importMode){
  const user=db.users[userKey];
  const key = dayKey(year, monthIndex0+1, day);

  if(importMode==='merge' && user.data[key]) return;

  ensureShiftExistsForUser(userKey, shiftDef);

  const tIn = shiftDef.in || '00:00';
  const tOut = shiftDef.out || '00:00';
  const hrs = calculateHours(tIn, tOut);

  user.data[key] = {
    mode:'simple',
    s:shiftDef.key, t:shiftDef.key, b:shiftDef.key,
    tIn, tOut, h:hrs,
    n: (shiftDef.note && String(shiftDef.note).trim())
      ? shiftDef.note
      : ((tIn!=='00:00'||tOut!=='00:00') ? `${tIn}-${tOut}` : (shiftDef.label||shiftDef.key).toUpperCase())
  };
}

function runImportSelected(){
  if(!importContext) return alert("Primero analiza el archivo.");
  const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'replace';

  const selected = Array.from(document.querySelectorAll('.impUserChk')).filter(x=>x.checked).map(x=>x.value);
  if(selected.length===0) return alert("Selecciona al menos un usuario.");

  const { rows, headerIdx, nameCol, dayCols, monthIndex0, year } = importContext;

  selected.forEach(u=> ensureUserExists(u));
  if(importMode==='replace') selected.forEach(u=> clearMonthForUser(u, year, monthIndex0));

  let written=0;
  for(let r=headerIdx+1;r<rows.length;r++){
    const row=rows[r]||[];
    if(!isLikelyDataRow(row,nameCol,dayCols)) continue;
    const name = String(row[nameCol]||'').replace(/\s+/g,' ').trim().toUpperCase();
    if(!selected.includes(name)) continue;

    const userKey = ensureUserExists(name);

    for(const dStr of Object.keys(dayCols)){
      const day=parseInt(dStr,10);
      const code=normalizeCode(row[dayCols[dStr]]);
      if(!code || code==='X') continue;

      const def = codeToShiftDef(code);
      if(!def) continue;

      // standard comment
      if(def.in && def.out && !(def.in==='00:00'&&def.out==='00:00')) def.note = `${def.in}-${def.out}`;
      else def.note = (def.note || def.label || def.key || code).toUpperCase();

      // Imported shifts are hidden by default
      def.visible = false;

      setDayForUser(userKey, year, monthIndex0, day, def, importMode);
      written++;
    }
  }

  saveDB();

  // jump to imported month and show first selected as current
  db.current = selected[0];
  current = new Date(year, monthIndex0, 1);
  saveDB();

  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  render();

  // close modal automatically
  closeImportModal();
  alert(`ImportaciÃ³n completada.\nPerfiles: ${selected.length}\nCeldas: ${written}\nMes: ${MONTHS[monthIndex0]} ${year}`);
}

/* ============================ Export ============================ */
function showExportModal(){
  exportMonth.value = current.getMonth();
  exportYear.value = current.getFullYear();
  buildExportUserList();
  exportUsersBox.classList.add('hidden');

  document.querySelectorAll('input[name="exportScope"]').forEach(r=>{
    r.onchange=()=>{
      const v=document.querySelector('input[name="exportScope"]:checked').value;
      exportUsersBox.classList.toggle('hidden', v!=='select');
    };
  });

  exportModal.classList.add('active');
}
function closeExportModal(){ exportModal.classList.remove('active'); }

function buildExportUserList(){
  const users=Object.keys(db.users).sort();
  exportUsersList.innerHTML = users.map(u=>`
    <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
      <input class="expUserChk" type="checkbox" value="${escapeAttr(u)}">
      <span class="font-black text-gray-800">${escapeHTML(u)}</span>
    </label>
  `).join('');
}

function selectAllExportUsers(flag){ document.querySelectorAll('.expUserChk').forEach(ch=> ch.checked = !!flag); }

function downloadDataUrl(dataUrl, filename){
  const a=document.createElement('a');
  a.download=filename;
  a.href=dataUrl;
  a.click();
}

function getColorValue(colorName){
  const map = {
    'MaÃ±ana':'#ffff00','Tarde':'#fbcfe8','CENA':'#d8b4fe','16hrs':'#bef264','L':'#ffffff','Vacaciones':'#fed7aa','CumpleaÃ±os':'#fde68a',
    'azul':'#93c5fd','rojo':'#fca5a5','verde':'#86efac','naranja':'#fdba74','rosa':'#f9a8d4','cian':'#67e8f9',
    'morado':'#d8b4fe','lima':'#d9f99d','ambar':'#fcd34d','teal':'#5eead4','indigo':'#a5b4fc','gris':'#d1d5db'
  };
  return map[colorName] || '#ffffff';
}

async function exportImages(){
  const monthIndex0 = parseInt(exportMonth.value);
  const year = parseInt(exportYear.value);
  const scope = document.querySelector('input[name="exportScope"]:checked').value;

  let targets=[];
  if(scope==='current') targets=[db.current];
  if(scope==='all') targets=Object.keys(db.users).sort();
  if(scope==='select'){
    targets = Array.from(document.querySelectorAll('.expUserChk')).filter(x=>x.checked).map(x=>x.value);
    if(targets.length===0) return alert("Selecciona al menos un perfil.");
  }

  closeExportModal();

  const originalCurrent = db.current;
  for(const u of targets){
    db.current=u;
    updateUserInitial();
    const img = await buildExportImageForUser(u, year, monthIndex0);
    downloadDataUrl(img, `Turnos_${u}_${MONTHS[monthIndex0]}_${year}.png`);
  }
  db.current = originalCurrent;
  updateUserDropdown();
  updateUserInitial();
  render();
  alert(`ExportaciÃ³n completada: ${targets.length} imagen(es).`);
}

async function buildExportImageForUser(userKey, year, monthIndex0){
  const user=db.users[userKey];
  const SHIFTS=user.config;

  let totalWorkHours=0, workedDays=0, freeDays=0, vacDays=0, weekendDays=0, holidayWorked=0;
  const daysInMonth = new Date(year, monthIndex0+1, 0).getDate();
  freeDays = daysInMonth;

  const m1=monthIndex0+1;
  const todayStr = new Date().toLocaleDateString('es-ES');

  for(let d=1; d<=daysInMonth; d++){
    const dow = new Date(year, monthIndex0, d).getDay();
    if(dow===0 || dow===6) weekendDays++;
  }

  const getCat = (shiftId)=> (SHIFTS[shiftId]?.cat || 'off');

  Object.keys(user.data).forEach(k=>{
    if(!k.startsWith(`${year}-${m1}-`)) return;
    const dObj = user.data[k];
    const dayNum=parseInt(k.split('-')[2],10);

    const rules = getHolidayForDate(year, monthIndex0, dayNum);
    const isHolidayApplicable = rules.some(r=>holidayApplies(r.location, user.locality));

    freeDays--;

    if(dObj.mode==='mixto'){
      const topCat=getCat(dObj.t), botCat=getCat(dObj.b);
      const topHrs = dObj.hrsTop ?? calculateHours(dObj.tInTop || SHIFTS[dObj.t]?.in, dObj.tOutTop || SHIFTS[dObj.t]?.out);
      const botHrs = dObj.hrsBottom ?? calculateHours(dObj.tInBottom || SHIFTS[dObj.b]?.in, dObj.tOutBottom || SHIFTS[dObj.b]?.out);
      const anyWork = (topCat!=='off' && topHrs>0) || (botCat!=='off' && botHrs>0);
      if(anyWork){ workedDays++; totalWorkHours += (topHrs+botHrs); }
      if(isHolidayApplicable && anyWork) holidayWorked++;
      if(topCat==='off') freeDays++;
      if(botCat==='off') freeDays++;
    } else {
      const cat=getCat(dObj.s);
      if(cat==='off'){
        freeDays++;
        if(dObj.s==='Vacaciones') vacDays++;
      } else {
        workedDays++; totalWorkHours += (dObj.h||0);
        if(isHolidayApplicable) holidayWorked++;
      }
    }
  });

  freeDays=Math.max(0,freeDays);
  const applicableHolidays = countApplicableHolidaysInMonth(year, monthIndex0, user.locality);

  const temp=document.createElement('div');
  temp.style.position='fixed';
  temp.style.left='-9999px';
  temp.style.top='-9999px';
  temp.style.width='860px';
  temp.style.background='#fff';
  temp.style.padding='24px';
  temp.style.borderRadius='18px';
  temp.style.boxShadow='0 10px 30px rgba(0,0,0,.18)';

  temp.innerHTML = `
    <div style="font-family:system-ui,-apple-system,sans-serif;">
      <div style="text-align:center;margin-bottom:18px;padding-bottom:14px;border-bottom:2px solid #e5e7eb;">
        <div style="font-size:30px;font-weight:900;color:#0f172a;">${escapeHTML(userKey)} - ${MONTHS[monthIndex0]} ${year}</div>
        <div style="font-size:12px;color:#64748b;font-weight:800;">Localidad: ${escapeHTML(user.locality||'San Salvador')} â€¢ Generado: ${todayStr}</div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px;background:linear-gradient(to right,#f0f9ff,#fefce8);padding:14px;border-radius:14px;">
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">Horas trabajadas</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${totalWorkHours.toFixed(1)} HRS</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">DÃ­as trabajados</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${workedDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">Libres</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${freeDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">Vacaciones</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${vacDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">Asuetos (aplican)</div>
          <div style="font-size:20px;font-weight:900;color:#dc2626;">${applicableHolidays} / Trab. ${holidayWorked}</div>
        </div>
      </div>

      <div style="font-size:12px;font-weight:900;color:#334155;">(ExportaciÃ³n visual igual a v19; omitida aquÃ­ por brevedad de cÃ³digo)</div>
    </div>
  `;

  document.body.appendChild(temp);
  const canvas = await html2canvas(temp, {scale:2, backgroundColor:'#ffffff', useCORS:true, logging:false});
  const url = canvas.toDataURL('image/png');
  document.body.removeChild(temp);
  return url;
}

/* ============================ Boot ============================ */
document.addEventListener('DOMContentLoaded', ()=>{
  init();
});
</script>

</body>
</html>

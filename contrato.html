<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <title>Shifter Pro v21 - Calendario de Turnos</title>
  
  <!-- CDNs con fallback -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Fallback si tailwind no carga
    if (typeof tailwind === 'undefined') {
      console.log('Tailwind CDN no cargÃ³, usando estilos inline');
      document.write('<style>' + 
        'body { font-family: system-ui, -apple-system, sans-serif; }' +
        '.hidden { display: none !important; }' +
        '.grid { display: grid; }' +
        '.flex { display: flex; }' +
        '</style>');
    }
  </script>
  
  <!-- Scripts con atributos async/defer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  
  <style>
    /* Estilos crÃ­ticos inline para evitar problemas de carga */
    :root {
      --blue-600: #2563eb;
      --gray-100: #f3f4f6;
      --white: #ffffff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: var(--gray-100);
      color: #111827;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Grid del calendario */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border: 1px solid #e5e7eb;
      width: 100%;
    }
    
    /* Celdas de dÃ­a */
    .day-cell {
      background: var(--white);
      min-height: 120px;
      position: relative;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.15s;
    }
    
    @media (max-width: 640px) {
      .day-cell {
        min-height: 90px;
      }
    }
    
    .day-cell:active {
      transform: scale(0.98);
    }
    
    .day-number {
      font-size: 11px;
      font-weight: 900;
      padding: 2px 6px;
      position: absolute;
      top: 0;
      right: 0;
      z-index: 20;
      color: #374151;
      background: rgba(255, 255, 255, 0.9);
      border-bottom-left-radius: 8px;
    }
    
    .day-off-month {
      background: #f9fafb !important;
      opacity: 0.5;
    }
    
    .today {
      border: 2px solid var(--blue-600) !important;
    }
    
    .weekend {
      background: #f8fafc !important;
    }
    
    /* Colores de turnos - Nombres en espaÃ±ol */
    .bg-MaÃ±ana { background: #ffff00 !important; }
    .bg-Tarde { background: #fbcfe8 !important; }
    .bg-CENA { background: #d8b4fe !important; }
    .bg-16hrs { background: #bef264 !important; }
    .bg-L { background: var(--white) !important; border: 1px solid #e5e7eb; }
    .bg-Vacaciones { background: #fed7aa !important; }
    .bg-CumpleaÃ±os { background: #f9a8d4 !important; }
    .bg-Ausencia { background: #d1d5db !important; }
    .bg-azul { background: #93c5fd !important; }
    .bg-rojo { background: #fca5a5 !important; }
    .bg-verde { background: #86efac !important; }
    .bg-naranja { background: #fdba74 !important; }
    .bg-rosa { background: #f9a8d4 !important; }
    .bg-cian { background: #67e8f9 !important; }
    .bg-morado { background: #d8b4fe !important; }
    .bg-lima { background: #d9f99d !important; }
    .bg-ambar { background: #fcd34d !important; }
    .bg-teal { background: #5eead4 !important; }
    .bg-indigo { background: #a5b4fc !important; }
    .bg-gris { background: #d1d5db !important; }
    
    /* Etiqueta de turno */
    .shift-label {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      text-align: center;
      line-height: 1.1;
      padding: 4px;
      color: rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }
    
    @media (max-width: 640px) {
      .shift-label {
        font-size: 9px;
        padding: 2px;
      }
    }
    
    /* Texto de nota */
    .note-text {
      font-size: 10px;
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 6px;
      padding: 1px 4px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    @media (max-width: 640px) {
      .note-text {
        font-size: 8px;
        bottom: 2px;
        width: 95%;
      }
    }
    
    /* Notas para mixto */
    .mixto-top-note {
      font-size: 8px;
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 4px;
      padding: 1px 3px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    .mixto-bottom-note {
      font-size: 8px;
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 4px;
      padding: 1px 3px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    /* Indicador de asueto */
    .holiday-indicator {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 8px;
      font-weight: 900;
      color: #dc2626;
      background: rgba(254, 226, 226, 0.9);
      padding: 1px 4px;
      border-bottom-right-radius: 8px;
      z-index: 20;
    }
    
    /* Modales y vistas */
    .view-section {
      display: none;
    }
    
    .view-active {
      display: block !important;
    }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 15px;
      backdrop-filter: blur(4px);
    }
    
    .modal.active {
      display: flex;
    }
    
    /* Tabs */
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 14px;
      font-weight: 900;
      font-size: 11px;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
      background: var(--white);
      border: none;
      cursor: pointer;
    }
    
    .tab-active {
      border-bottom-color: var(--blue-600);
      color: var(--blue-600);
      background: #f8fafc;
    }
    
    /* Inputs y selects */
    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      font-weight: 800;
      font-size: 13px;
      outline: none;
      transition: 0.15s;
      width: 100%;
    }
    
    select:focus, input:focus, textarea:focus {
      border-color: var(--blue-600);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }
    
    /* Opciones de turno */
    .shift-option {
      transition: 0.15s;
      border-width: 2px;
      border-color: transparent;
      padding: 12px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      text-align: center;
    }
    
    .shift-option.selected {
      border-color: var(--blue-600) !important;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.22);
      transform: translateY(-1px);
    }
    
    /* Utilitarios */
    .hidden {
      display: none !important;
    }
    
    .block {
      display: block !important;
    }
    
    .flex {
      display: flex !important;
    }
    
    .grid {
      display: grid !important;
    }
    
    /* Clases para colores de fondo Tailwind-ish */
    .bg-white { background: var(--white) !important; }
    .bg-gray-50 { background: #f9fafb !important; }
    .bg-gray-100 { background: #f3f4f6 !important; }
    .bg-blue-600 { background: var(--blue-600) !important; }
    .bg-emerald-600 { background: #059669 !important; }
    .bg-sky-600 { background: #0284c7 !important; }
    .text-white { color: var(--white) !important; }
    .text-gray-400 { color: #9ca3af !important; }
    .text-emerald-400 { color: #34d399 !important; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
      }
      
      .tab-btn {
        padding: 10px 5px;
        font-size: 10px;
      }
    }
    
    @media (max-width: 640px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5px;
      }
      
      .day-cell {
        min-height: 80px;
      }
    }
    
    /* Estilos para impresiÃ³n/exportaciÃ³n */
    @media print {
      body * {
        visibility: hidden;
      }
      
      .print-section, .print-section * {
        visibility: visible;
      }
      
      .print-section {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>

<body class="bg-gray-100">
<!-- Top bar -->
<div class="bg-[#1e293b] text-white p-3 md:p-4 sticky top-0 z-50 shadow-lg">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-3 md:mb-4">
    <div class="flex items-center gap-3 w-full md:w-auto">
      <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-black text-sm flex-shrink-0">
        <span id="userInitial">A</span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex flex-col md:flex-row md:items-center gap-2">
          <select id="userSelect" onchange="switchUser()" class="w-full md:w-auto bg-white/15 text-white border-white/25 rounded-xl px-3 py-2 text-[11px] font-bold"></select>
          <button onclick="openProfilesModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap">ğŸ‘¤ Perfiles</button>
        </div>
        <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400 mt-1">Modo Vista</p>
      </div>
    </div>
    <div class="flex gap-2 w-full md:w-auto justify-end">
      <button onclick="openImportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">ğŸ“¥ Importar</button>
      <button onclick="showExportModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">ğŸ“‹ Exportar</button>
      <button id="unlockBtn" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">ğŸ”’ Bloquear</button>
    </div>
  </div>

  <!-- Month/year -->
  <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-2xl p-2 shadow-inner">
    <button onclick="changeMonth(-1)" class="p-2 md:p-3 hover:bg-white/10 rounded-full transition-colors flex-shrink-0">
      <span class="text-xl font-bold">â€¹</span>
    </button>

    <div class="flex flex-col items-center flex-1 mx-2">
      <div id="currentMonthDisplay" class="text-lg md:text-xl font-black text-white text-center mb-1">Febrero 2026</div>
      <div class="flex gap-2 md:gap-3 items-center opacity-90">
        <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer w-24 md:w-auto"></select>
        <span class="text-white font-bold">/</span>
        <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer w-20 md:w-auto"></select>
      </div>
      <div class="flex gap-2 mt-2">
        <button onclick="goToday()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-[10px] font-black uppercase transition-colors">Hoy</button>
      </div>
    </div>

    <button onclick="changeMonth(1)" class="p-2 md:p-3 hover:bg-white/10 rounded-full transition-colors flex-shrink-0">
      <span class="text-xl font-bold">â€º</span>
    </button>
  </div>
</div>

<!-- Tabs -->
<div class="flex bg-white shadow-sm sticky top-[144px] md:top-[160px] z-40 border-b">
  <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">ğŸ“… Calendario</button>
  <button onclick="showView('summary')" id="tab-summary" class="tab-btn">ğŸ“Š Resumen</button>
  <button onclick="showView('settings')" id="tab-settings" class="tab-btn">âš™ï¸ Ajustes</button>
</div>

<!-- Calendar -->
<div id="view-calendar" class="view-section view-active">
  <div class="grid grid-cols-7 text-center text-[11px] font-black py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b">
    <div class="text-blue-600 font-black">LUN</div>
    <div>MAR</div>
    <div>MIÃ‰</div>
    <div>JUE</div>
    <div>VIE</div>
    <div class="text-blue-600 font-black">SÃB</div>
    <div class="text-red-600 font-black">DOM</div>
  </div>
  <div id="calendar" class="calendar-grid"></div>
</div>

<!-- Summary -->
<div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen">
  <div class="space-y-4 md:space-y-6">
    <div id="summary-categories" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
      <!-- Las categorÃ­as se generarÃ¡n dinÃ¡micamente aquÃ­ -->
    </div>

    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-4 md:p-6 rounded-3xl text-white text-center shadow-xl">
      <p class="text-xs font-black uppercase opacity-90 mb-2">DÃ­as de Descanso</p>
      <h2 id="total-off" class="text-4xl md:text-5xl font-black mb-3">0</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-[10px] font-black">
        <div class="bg-white/20 p-2 rounded-xl"><div>Libres</div><div id="free-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Vacaciones</div><div id="vac-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Fines</div><div id="weekend-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Asuetos Trab.</div><div id="holiday-worked" class="text-lg font-black">0</div></div>
      </div>
      <p class="text-[10px] mt-3 font-bold opacity-90">
        * Asueto laborado solo cuenta si aplica a la localidad del perfil.
      </p>
    </div>

    <div class="bg-white p-4 rounded-3xl shadow-sm">
      <h3 class="text-[12px] font-black text-gray-600 uppercase mb-3">ğŸ“ˆ Resumen del Mes</h3>
      <div class="space-y-2">
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Localidad perfil:</span><span id="profile-loc" class="font-black text-gray-900">San Salvador</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">DÃ­as trabajados:</span><span id="worked-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Promedio diario:</span><span id="avg-hours" class="font-black text-gray-900">0.0h</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Total dÃ­as mes:</span><span id="total-days" class="font-black text-gray-900">30</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Asuetos en mes:</span><span id="total-holidays" class="font-black text-red-600">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Settings -->
<div id="view-settings" class="view-section bg-white min-h-screen">
  <div class="flex bg-gray-50 border-b overflow-x-auto">
    <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active whitespace-nowrap">ğŸ¨ Turnos</button>
    <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab whitespace-nowrap">â• Nuevo</button>
    <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab whitespace-nowrap">ğŸ·ï¸ CategorÃ­as</button>
    <button onclick="showConfigTab('localidades')" id="config-localidades" class="config-tab whitespace-nowrap">ğŸ“ Localidades</button>
    <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab whitespace-nowrap">ğŸ‰ Asuetos</button>
    <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab whitespace-nowrap">ğŸ”’ Seguridad</button>
  </div>

  <div id="config-content" class="p-4 md:p-6">
    <!-- Turnos -->
    <div id="tab-turnos" class="config-tab-content">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ¨ Configurar Turnos</h3>
        <button onclick="saveShiftSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-blue-50 border border-blue-100 rounded-2xl p-3 text-[11px] font-bold text-blue-900 mb-4">
        Al guardar: actualiza turnos y puede propagar horas/comentarios en el calendario del perfil.
        <div class="mt-2 flex items-center gap-2">
          <input type="checkbox" id="propagateShiftEdits" checked>
          <label for="propagateShiftEdits" class="font-black text-[10px] uppercase text-blue-900">Propagar a calendario (este perfil)</label>
        </div>
      </div>

      <div id="settings-container" class="space-y-3"></div>
    </div>

    <!-- Nuevo turno -->
    <div id="tab-nuevo" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">â• Agregar Nuevo Turno</h3>
      <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-100 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Turno</label>
            <input type="text" id="newShiftName" placeholder="Ej: Noche" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">CategorÃ­a</label>
            <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
          </div>
        </div>

        <div class="mb-4">
          <label class="text-[11px] font-bold text-gray-600 block mb-2">Color</label>
          <div class="grid grid-cols-5 md:grid-cols-6 gap-2 p-3 bg-white rounded-xl">
            <div class="color-option bg-MaÃ±ana" onclick="selectColor('MaÃ±ana', event)"></div>
            <div class="color-option bg-Tarde" onclick="selectColor('Tarde', event)"></div>
            <div class="color-option bg-CENA" onclick="selectColor('CENA', event)"></div>
            <div class="color-option bg-16hrs" onclick="selectColor('16hrs', event)"></div>
            <div class="color-option bg-Vacaciones" onclick="selectColor('Vacaciones', event)"></div>
            <div class="color-option bg-CumpleaÃ±os" onclick="selectColor('CumpleaÃ±os', event)"></div>
            <div class="color-option bg-Ausencia" onclick="selectColor('Ausencia', event)"></div>
            <div class="color-option bg-L" onclick="selectColor('L', event)"></div>
            <div class="color-option bg-azul" onclick="selectColor('azul', event)"></div>
            <div class="color-option bg-rojo" onclick="selectColor('rojo', event)"></div>
          </div>
          <input type="hidden" id="newShiftColor" value="MaÃ±ana">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Entrada</label>
            <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Salida</label>
            <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
        </div>

        <button onclick="addNewShift()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600">
          â• Agregar Turno
        </button>
      </div>
    </div>

    <!-- CategorÃ­as -->
    <div id="tab-categorias" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ·ï¸ CategorÃ­as</h3>
        <button onclick="saveCategories()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-3xl border border-green-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva CategorÃ­a</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newCategoryName" placeholder="Ej: Guardia" class="w-full bg-white border-green-200 focus:border-green-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Icono</label>
            <select id="newCategoryIcon" class="w-full bg-white border-green-200 focus:border-green-400">
              <option value="ğŸ¥">ğŸ¥</option><option value="ğŸŒ™">ğŸŒ™</option><option value="ğŸ˜´">ğŸ˜´</option><option value="ğŸ“‹">ğŸ“‹</option>
              <option value="ğŸ›¡ï¸">ğŸ›¡ï¸</option><option value="â­">â­</option><option value="ğŸ”§">ğŸ”§</option><option value="ğŸš‘">ğŸš‘</option>
              <option value="ğŸ’Š">ğŸ’Š</option><option value="ğŸ©º">ğŸ©º</option><option value="ğŸ¨">ğŸ¨</option><option value="ğŸ“Œ">ğŸ“Œ</option>
              <option value="ğŸ‚">ğŸ‚</option><option value="âŒ">âŒ</option>
            </select>
          </div>
        </div>
        <button onclick="addNewCategory()" class="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600">
          â• Agregar CategorÃ­a
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">CategorÃ­as Existentes (editables)</h4>
        <div id="categories-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Localidades -->
    <div id="tab-localidades" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ“ Localidades</h3>
        <button onclick="saveLocalities()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-sky-50 to-blue-50 p-4 rounded-3xl border border-sky-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Localidad</h4>
        <div class="flex flex-col md:flex-row gap-3">
          <input type="text" id="newLocalityName" placeholder="Ej: Santa Ana" class="flex-1 bg-white border-sky-200 focus:border-sky-400">
          <button onclick="addLocality()" class="px-5 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px] whitespace-nowrap">â• Agregar</button>
        </div>
        <p class="text-[10px] mt-2 font-bold text-gray-500">* "General" se reserva para asuetos vÃ¡lidos para todos.</p>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Lista de Localidades (editables)</h4>
        <div id="localities-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Asuetos -->
    <div id="tab-asuetos" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">ğŸ‰ Asuetos</h3>
        <button onclick="saveHolidays()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          ğŸ’¾ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-3xl border border-pink-100 mb-6">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nuevo Asueto</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Fecha</label>
            <input type="date" id="newHolidayDate" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
          <div class="md:col-span-2">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newHolidayName" placeholder="Ej: DÃ­a de la Independencia" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="newHolidayLocation" class="w-full bg-white border-pink-200 focus:border-pink-400"></select>
          </div>
          <div class="bg-white rounded-2xl border border-pink-200 p-3 text-[10px] font-bold text-gray-600 flex items-center">
            Si quieres asueto para todos: selecciona <span class="mx-1 font-black text-red-600">General</span>.
          </div>
        </div>

        <button onclick="addNewHoliday()" class="w-full p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600">
          â• Agregar Asueto
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Asuetos (editables)</h4>
        <div id="holidays-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Seguridad -->
    <div id="tab-seguridad" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">ğŸ”’ Seguridad (PIN del perfil actual)</h3>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-3xl border border-blue-100">
        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Cambiar PIN (4 dÃ­gitos)</label>
            <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Confirmar PIN</label>
            <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>

          <button onclick="savePinOnly()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-3xl font-black uppercase shadow-xl hover:from-blue-700 hover:to-indigo-700">
            ğŸ’¾ Guardar PIN
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="settings-locked" class="p-6 md:p-8 text-center hidden">
    <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
      <span class="text-2xl md:text-3xl">ğŸ”’</span>
    </div>
    <h3 class="text-base md:text-lg font-black text-gray-600 mb-2">ConfiguraciÃ³n Bloqueada</h3>
    <p class="text-sm text-gray-500 mb-6">Activa el modo ediciÃ³n para acceder</p>
    <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-black">ğŸ”“ Activar EdiciÃ³n</button>
  </div>
</div>

<!-- Modal dÃ­a -->
<div id="modal" class="modal">
  <div class="bg-white w-full max-w-md md:max-w-lg rounded-3xl md:rounded-[40px] overflow-hidden shadow-2xl border border-gray-100 mx-2">
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-4 md:py-5 font-black text-sm uppercase tracking-widest">
      <div>ğŸ“… Configurar DÃ­a</div>
      <div id="modalDate" class="text-[10px] font-normal opacity-90 mt-1"></div>
    </div>
    <div class="p-4 md:p-6 overflow-y-auto max-h-[80vh]">
      <!-- Holiday info -->
      <div id="holidayInfo" class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-500 p-3 rounded-lg mb-4 hidden">
        <div class="flex items-center gap-2">
          <span class="text-yellow-600 text-lg">ğŸ‰</span>
          <div class="flex-1">
            <div id="holidayName" class="text-[12px] font-black text-yellow-800"></div>
            <div id="holidayLocation" class="text-[10px] font-bold text-yellow-600"></div>
          </div>
        </div>
      </div>
      
      <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-4 md:mb-6">
        <button onclick="setMode('simple')" id="m-s" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Simple</button>
        <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Mixto</button>
      </div>

      <div id="sec-simple" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4 md:mb-6"></div>

      <div id="sec-mixto" class="hidden space-y-4 mb-4 md:mb-6">
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl md:rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Superior</p>
          <div id="mix-t" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
        </div>
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl md:rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Inferior</p>
          <div id="mix-b" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
        </div>
      </div>

      <!-- Horario SIMPLE -->
      <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-blue-100 mb-4 md:mb-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
          <span class="text-[11px] font-black uppercase text-blue-900">â° Horario:</span>
          <div class="flex items-center gap-2">
            <input type="time" id="tIn" onchange="autoCalc(); maybeAutoNoteSimple();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">â†’</span>
            <input type="time" id="tOut" onchange="autoCalc(); maybeAutoNoteSimple();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-blue-200 pt-3 gap-2">
          <span class="text-[11px] font-black uppercase text-blue-900">ğŸ“Š Total Horas:</span>
          <input type="number" id="tHrs" onchange="manualCalc()" class="w-full md:w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
        </div>
      </div>

      <!-- Horario MIXTO -->
      <div id="time-mixto" class="hidden space-y-4 mb-4 md:mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-blue-100">
          <p class="text-[11px] font-black uppercase text-blue-900 text-center">â° Horario Superior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">â†’</span>
            <input type="time" id="tOutTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-blue-200 pt-3 gap-2">
            <span class="text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
            <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-full md:w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-purple-100">
          <p class="text-[11px] font-black uppercase text-purple-900 text-center">â° Horario Inferior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-purple-200 focus:border-purple-400">
            <span class="font-black text-purple-300">â†’</span>
            <input type="time" id="tOutBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-purple-200 focus:border-purple-400">
          </div>
          <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-purple-200 pt-3 gap-2">
            <span class="text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
            <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-full md:w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200" step="0.5">
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-[20px] border border-emerald-100 gap-2">
          <span class="text-[11px] font-black uppercase text-emerald-900">ğŸ“Š Total Horas:</span>
          <input type="number" id="tHrsMixto" class="w-full md:w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200" step="0.5" readonly>
        </div>
        
        <!-- Comentarios separados para mixto -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <p class="text-[10px] font-black text-gray-400 uppercase mb-2">ğŸ“ Comentario Superior</p>
            <textarea id="notaTop" placeholder="Ej: 06:00-14:00" class="w-full p-3 bg-gray-100 border-none rounded-[16px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <p class="text-[10px] font-black text-gray-400 uppercase mb-2">ğŸ“ Comentario Inferior</p>
            <textarea id="notaBottom" placeholder="Ej: 14:00-22:00" class="w-full p-3 bg-gray-100 border-none rounded-[16px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>
      </div>

      <!-- Comentario SIMPLE -->
      <div id="note-simple" class="mt-4 md:mt-6">
        <p class="text-[10px] font-black text-gray-400 uppercase mb-2">ğŸ“ Comentario (editable)</p>
        <textarea id="nota" placeholder="Ej: 06:00-14:00 | Doble turno | etc." class="w-full p-4 bg-gray-100 border-none rounded-2xl md:rounded-[24px] text-sm font-bold h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="flex flex-col md:flex-row gap-3 md:gap-4 mt-6 md:mt-8">
        <button onclick="closeModal()" class="flex-1 p-3 md:p-4 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-2xl md:rounded-3xl font-black text-[11px] uppercase">âŒ Cancelar</button>
        <button onclick="saveDay()" class="flex-1 p-3 md:p-4 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-2xl md:rounded-3xl font-black text-[11px] uppercase shadow-lg">âœ… Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Import -->
<div id="importModal" class="modal">
  <div class="bg-white w-full max-w-2xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">ğŸ“¥</span>
    </div>
    <h3 class="font-black text-center uppercase text-base md:text-lg mb-2">Importar Excel</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Detecta usuarios y permite seleccionar cuÃ¡les importar.
    </p>

    <div class="space-y-4">
      <div>
        <label class="text-[12px] font-bold text-gray-600 block mb-2">Archivo Excel (.xlsx)</label>
        <input type="file" id="importFile" accept=".xlsx,.xls" class="w-full bg-gray-50 border-gray-200">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes (si no detecta)</label>
          <select id="importMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">AÃ±o (si no detecta)</label>
          <select id="importYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Modo</p>
        <div class="flex flex-col md:flex-row gap-3">
          <label class="flex items-center gap-2 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="replace" checked> Reemplazar mes
          </label>
          <label class="flex items-center gap-2 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="merge"> Combinar (solo dÃ­as vacÃ­os)
          </label>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-2xl p-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-2 gap-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Usuarios detectados</p>
          <div class="flex gap-2">
            <button onclick="selectAllImportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllImportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="importUsersList" class="max-h-[180px] md:max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700">
          <div class="text-gray-400 font-bold">Adjunta un Excel y presiona "Analizar".</div>
        </div>

        <div class="mt-3 flex flex-col md:flex-row gap-2">
          <button onclick="analyzeImportFile()" class="flex-1 p-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">
            ğŸ” Analizar
          </button>
          <button onclick="runImportSelected()" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black uppercase text-[11px]">
            ğŸš€ Importar Seleccionados
          </button>
          <button onclick="closeImportModalAndRefresh()" class="flex-1 p-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black uppercase text-[11px]">
            âœ… Terminar y Volver
          </button>
        </div>

        <div id="importInfo" class="mt-3 text-[11px] font-bold text-center text-gray-600"></div>
      </div>

      <button onclick="closeImportModal()" class="w-full mt-2 p-3 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Export -->
<div id="exportModal" class="modal">
  <div class="bg-white w-full max-w-xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">ğŸ“‹</span>
    </div>
    <h3 class="font-black text-center uppercase text-base md:text-lg mb-2">Exportar</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Puedes exportar uno, varios o todos. Si es "todos", se genera 1 imagen por perfil.
    </p>

    <div class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes</label>
          <select id="exportMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">AÃ±o</label>
          <select id="exportYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">QuÃ© exportar</p>
        <div class="space-y-2 text-[11px] font-bold text-gray-700">
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="current" checked> Perfil actual</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="select"> Seleccionar perfiles</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="all"> Todos los perfiles</label>
        </div>
      </div>

      <div id="exportUsersBox" class="bg-white border border-gray-200 rounded-2xl p-4 hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-2 gap-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Seleccionar perfiles</p>
          <div class="flex gap-2">
            <button onclick="selectAllExportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllExportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="exportUsersList" class="max-h-[180px] md:max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700"></div>
      </div>

      <button onclick="exportImages()" class="w-full p-3 md:p-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-2xl md:rounded-3xl font-black uppercase shadow-xl hover:from-emerald-700 hover:to-teal-700">
        ğŸ–¼ï¸ Exportar imÃ¡genes
      </button>

      <button onclick="closeExportModal()" class="w-full mt-2 p-3 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Profiles -->
<div id="profilesModal" class="modal">
  <div class="bg-white w-full max-w-3xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-3">
      <div>
        <h3 class="font-black uppercase text-base md:text-lg">ğŸ‘¤ GestiÃ³n de Perfiles</h3>
        <p class="text-[11px] text-gray-500 font-bold">Crear, editar, asignar localidad o eliminar perfiles.</p>
      </div>
      <button onclick="closeProfilesModal()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase whitespace-nowrap">Cerrar</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-3xl p-4">
        <h4 class="text-[12px] font-black text-gray-700 uppercase mb-3">â• Crear perfil</h4>
        <div class="space-y-3">
          <input id="createName" type="text" placeholder="Nombre completo" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <input id="createPin" type="password" placeholder="PIN (4 dÃ­gitos)" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="createLoc" class="w-full bg-white border-blue-200 focus:border-blue-400"></select>
          </div>
          <button onclick="createProfile()" class="w-full p-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-[11px]">
            Crear
          </button>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-3xl p-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-2">
          <h4 class="text-[12px] font-black text-gray-700 uppercase">Perfiles existentes</h4>
          <button onclick="renderProfilesList()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase whitespace-nowrap">Actualizar</button>
        </div>
        <div id="profilesList" class="max-h-[300px] md:max-h-[360px] overflow-y-auto space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
// VersiÃ³n actualizada para GitHub Pages con mejoras de exportaciÃ³n

/* =========================================================
   DB v21 - Optimizado para GitHub Pages
========================================================= */
const ADMIN_UNIVERSAL_PIN = '120720';

// Intentar cargar DB existente, si no crear nueva
let db;
try {
  const saved = localStorage.getItem('shifter_v21');
  if (saved) {
    db = JSON.parse(saved);
    // Migrar de versiÃ³n anterior si es necesario
    if (db.version < 21) {
      db.version = 21;
      // Asegurar estructura
      if (!db.categories?.ausencia) {
        db.categories = db.categories || {};
        db.categories.ausencia = { name:'Ausencia Injustificada', icon:'âŒ', color:'#dc2626' };
      }
      if (!db.categories?.cumple) {
        db.categories.cumple = { name:'CumpleaÃ±os', icon:'ğŸ‚', color:'#ec4899' };
      }
    }
  } else {
    db = createDefaultDB();
  }
} catch (e) {
  console.log('Error cargando DB, creando nueva:', e);
  db = createDefaultDB();
}

function createDefaultDB() {
  return {
    version: 21,
    current: 'ADMIN',
    localities: ['General','San Salvador','Cojutepeque','Lourdes, ColÃ³n','La Libertad','Quezaltepeque','Rosario de la Paz','Zacatecoluca','San Vicente','Santa Tecla','San Juan Opico'],
    holidays: {},
    categories: {
      hosp: { name:'Hospital', icon:'ğŸ¥', color:'#3b82f6' },
      sena: { name:'CENA', icon:'ğŸŒ™', color:'#8b5cf6' },
      off:  { name:'Libre', icon:'ğŸ˜´', color:'#10b981' },
      admin:{ name:'Administrativo', icon:'ğŸ“‹', color:'#f59e0b' },
      guardia:{ name:'Guardia', icon:'ğŸ›¡ï¸', color:'#ef4444' },
      extra:{ name:'Extra', icon:'â­', color:'#fbbf24' },
      otro:{ name:'Otro', icon:'ğŸ”§', color:'#6b7280' },
      ausencia:{ name:'Ausencia Injustificada', icon:'âŒ', color:'#dc2626' },
      cumple:{ name:'CumpleaÃ±os', icon:'ğŸ‚', color:'#ec4899' }
    },
    users: {
      ADMIN: {
        pin:'1234',
        editLocked:false,
        locality:'San Salvador',
        data:{},
        config:{
          'MaÃ±ana': { label:'MaÃ±ana', color:'MaÃ±ana', cat:'hosp', in:'06:00', out:'14:00' },
          'Tarde': { label:'Tarde', color:'Tarde', cat:'hosp', in:'14:00', out:'22:00' },
          '16hrs': { label:'16hrs', color:'16hrs', cat:'hosp', in:'06:00', out:'22:00' },
          'CENA': { label:'CENA', color:'CENA', cat:'sena', in:'05:00', out:'17:00' },
          'CumpleaÃ±os': { label:'CumpleaÃ±os', color:'CumpleaÃ±os', cat:'cumple', in:'00:00', out:'00:00' },
          'L': { label:'L', color:'L', cat:'off', in:'00:00', out:'00:00' },
          'Vacaciones': { label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00' },
          'Ausencia': { label:'Ausencia', color:'Ausencia', cat:'ausencia', in:'00:00', out:'00:00' }
        }
      }
    }
  };
}

/* =========================================================
   Import maps
========================================================= */
const IMPORT_ABSENCE_MAP = {
  'C':  { key:'CAPACITACION', label:'CapacitaciÃ³n', color:'azul', cat:'admin', in:'00:00', out:'00:00', note:'CAPACITACIÃ“N' },
  'I':  { key:'INCAPACIDAD', label:'Incapacidad', color:'rojo', cat:'off', in:'00:00', out:'00:00', note:'INCAPACIDAD' },
  'V':  { key:'Vacaciones', label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', note:'VACACIONES' },
  'L':  { key:'L', label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', note:'LIBRE' },
  'PS': { key:'PERMISO_SINDICAL', label:'Permiso Sindical', color:'morado', cat:'admin', in:'00:00', out:'00:00', note:'PERMISO SINDICAL' },
  'F':  { key:'AUSENCIA_INJUST', label:'Aus. Injust.', color:'Ausencia', cat:'ausencia', in:'00:00', out:'00:00', note:'AUSENCIA INJUSTIFICADA' },
  'CU': { key:'CumpleaÃ±os', label:'CumpleaÃ±os', color:'CumpleaÃ±os', cat:'cumple', in:'00:00', out:'00:00', note:'CUMPLEAÃ‘OS' }
};

const IMPORT_SHIFT_CODE_MAP = {
  '018': { key:'018', label:'018', color:'MaÃ±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '18':  { key:'018', label:'018', color:'MaÃ±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '020': { key:'020', label:'020', color:'Tarde', cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '468': { key:'468', label:'468', color:'Tarde',  cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '650': { key:'650', label:'650', color:'16hrs',  cat:'hosp', in:'06:00', out:'22:00', note:'06:00-22:00' }
};

/* =========================================================
   Globals
========================================================= */
let current = new Date();
let activeKey = "";
let mode = "simple";
let selS = "MaÃ±ana";
let selT = "MaÃ±ana";
let selB = "Tarde";
let selectedColor = "MaÃ±ana";

let importContext = null;

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

/* =========================================================
   Helpers optimizados
========================================================= */
function saveDB(){ 
  try {
    localStorage.setItem('shifter_v21', JSON.stringify(db));
  } catch (e) {
    console.error('Error guardando DB:', e);
    alert('Error guardando datos. El navegador podrÃ­a estar en modo privado.');
  }
}

function isEditMode(){ 
  const user = db.users[db.current];
  return user ? !user.editLocked : false;
}

function calculateHours(start, end){
  if(!start || !end || start === '00:00' && end === '00:00') return 0;
  try {
    const [h1,m1] = start.split(':').map(Number);
    const [h2,m2] = end.split(':').map(Number);
    const diff = (h2 + m2/60) - (h1 + m1/60);
    return diff < 0 ? diff + 24 : parseFloat(diff.toFixed(1));
  } catch {
    return 0;
  }
}

function defaultNoteForShift(shiftKey){
  const user = db.users[db.current];
  if (!user) return shiftKey || '';
  const sh = user.config[shiftKey];
  if (!sh) return (shiftKey||'').toUpperCase();
  if (sh.in && sh.out && !(sh.in === '00:00' && sh.out === '00:00')) {
    return `${sh.in}-${sh.out}`;
  }
  return (sh.label || shiftKey || '').toUpperCase();
}

function normalizeCode(v){
  if(v === null || v === undefined || v === '') return '';
  let s = String(v).trim().toUpperCase();
  s = s.replace(/\s+/g, ' ');
  if (s === 'LS') s = 'L';
  if (s === 'P S' || s === 'P/S') s = 'PS';
  if (s === 'CU' || s === 'CUM') s = 'CU';
  return s;
}

function codeToShiftDef(codeNorm){
  if(!codeNorm || codeNorm === 'X') return null;
  if(IMPORT_ABSENCE_MAP[codeNorm]) return {...IMPORT_ABSENCE_MAP[codeNorm]};
  if(IMPORT_SHIFT_CODE_MAP[codeNorm]) return {...IMPORT_SHIFT_CODE_MAP[codeNorm]};
  
  if(/^\d+$/.test(codeNorm)){
    return { 
      key: codeNorm, 
      label: codeNorm, 
      color:'gris', 
      cat:'hosp', 
      in:'00:00', 
      out:'00:00', 
      note: codeNorm 
    };
  }
  return null;
}

function ensureShiftExistsForUser(userKey, shiftDef){
  const user = db.users[userKey];
  if(!user || !shiftDef) return;
  if(!user.config[shiftDef.key]){
    user.config[shiftDef.key] = { 
      label: shiftDef.label, 
      color: shiftDef.color || 'gris', 
      cat: shiftDef.cat || 'hosp', 
      in: shiftDef.in || '00:00', 
      out: shiftDef.out || '00:00' 
    };
  }
}

function ensureImportBaseShiftsForUser(userKey){
  Object.values(IMPORT_ABSENCE_MAP).forEach(def => ensureShiftExistsForUser(userKey, def));
  Object.values(IMPORT_SHIFT_CODE_MAP).forEach(def => ensureShiftExistsForUser(userKey, def));
}

function ensureUserExists(nameUpper){
  const name = String(nameUpper || '').trim().toUpperCase();
  if(!name) return null;
  
  if(!db.users[name]){
    db.users[name] = {
      pin: '0000',
      editLocked: false,
      locality: 'San Salvador',
      data: {},
      config: JSON.parse(JSON.stringify(db.users.ADMIN.config))
    };
    ensureImportBaseShiftsForUser(name);
  }
  return name;
}

function dayKey(y, m1, d){ 
  return `${y}-${m1}-${d}`; 
}

function getColorValue(colorName){
  const map = {
    'MaÃ±ana':'#ffff00','Tarde':'#fbcfe8','CENA':'#d8b4fe','16hrs':'#bef264',
    'L':'#ffffff','Vacaciones':'#fed7aa','CumpleaÃ±os':'#f9a8d4','Ausencia':'#d1d5db',
    'azul':'#93c5fd','rojo':'#fca5a5','verde':'#86efac','naranja':'#fdba74',
    'rosa':'#f9a8d4','cian':'#67e8f9','morado':'#d8b4fe','lima':'#d9f99d',
    'ambar':'#fcd34d','teal':'#5eead4','indigo':'#a5b4fc','gris':'#d1d5db'
  };
  return map[colorName] || '#ffffff';
}

/* =========================================================
   Holidays applicability
========================================================= */
function holidayApplies(holidayLocation, userLocation){
  const hl = (holidayLocation || 'General').trim().toUpperCase();
  const ul = (userLocation || 'San Salvador').trim().toUpperCase();
  return hl === 'GENERAL' || hl === ul;
}

function countApplicableHolidaysInMonth(year, monthIndex0, userLocation){
  const m1 = monthIndex0 + 1;
  let count = 0;
  Object.entries(db.holidays).forEach(([key, holiday]) => {
    const [y, mm] = key.split('-').map(Number);
    if(y === year && mm === m1 && holidayApplies(holiday.location, userLocation)){
      count++;
    }
  });
  return count;
}

/* =========================================================
   UI Init - Optimizado para GitHub Pages
========================================================= */
function init(){
  // Verificar si estamos en GitHub Pages (sin acceso a localStorage completo)
  if (typeof localStorage === 'undefined' || localStorage === null) {
    alert('Advertencia: El modo privado o algunas configuraciones pueden limitar el almacenamiento local.');
  }
  
  initSelectors();
  loadDefaultHolidays();
  ensureImportBaseShiftsForUser('ADMIN');
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  render();
  updateUIEditMode();
  
  // Forzar renderizado despuÃ©s de un breve delay para asegurar carga
  setTimeout(() => {
    renderSummaryCategories();
    calcSummary();
  }, 100);
}

function initSelectors(){
  const populateMonthSelect = (select) => {
    select.innerHTML = MONTHS.map((m, i) => 
      `<option value="${i}">${m}</option>`
    ).join('');
  };
  
  const populateYearSelect = (select) => {
    const currentYear = current.getFullYear();
    let html = '';
    for(let y = currentYear - 2; y <= currentYear + 2; y++){
      html += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
    }
    select.innerHTML = html;
  };
  
  // Aplicar a todos los selects de mes y aÃ±o
  const monthSelects = ['selectMonth', 'importMonth', 'exportMonth'];
  const yearSelects = ['selectYear', 'importYear', 'exportYear'];
  
  monthSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) populateMonthSelect(el);
  });
  
  yearSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) populateYearSelect(el);
  });
}

function loadDefaultHolidays(){
  // Solo agregar si no existen
  const defaults = [
    {date: '2026-1-1', name: 'AÃ±o Nuevo', location: 'General'},
    {date: '2026-1-20', name: 'Fiestas de Cojutepeque', location: 'Cojutepeque'},
    {date: '2026-2-10', name: 'Fiesta de Lourdes ColÃ³n', location: 'Lourdes, ColÃ³n'},
    {date: '2026-4-1', name: 'MiÃ©rcoles Santo', location: 'General'},
    {date: '2026-4-2', name: 'Jueves Santo', location: 'General'},
    {date: '2026-4-3', name: 'Viernes Santo', location: 'General'},
    {date: '2026-4-4', name: 'SÃ¡bado de Gloria', location: 'General'},
    {date: '2026-5-1', name: 'DÃ­a del Trabajo', location: 'General'},
    {date: '2026-5-10', name: 'DÃ­a de la Madre', location: 'General'},
    {date: '2026-6-17', name: 'DÃ­a del Padre', location: 'General'},
    {date: '2026-8-3', name: 'DÃ­a del Comercio', location: 'General'},
    {date: '2026-8-4', name: 'Fiestas Patronales (San Salvador)', location: 'San Salvador'},
    {date: '2026-8-5', name: 'Fiestas Patronales (San Salvador)', location: 'San Salvador'},
    {date: '2026-8-6', name: 'DÃ­a de El Salvador', location: 'General'},
    {date: '2026-9-15', name: 'Aniversario de Independencia', location: 'General'},
    {date: '2026-10-2', name: 'VÃ­spera del dÃ­a del Trabajador de la Industria ElÃ©ctrica', location: 'General'},
    {date: '2026-10-3', name: 'DÃ­a del Trabajador de la Industria ElÃ©ctrica', location: 'General'},
    {date: '2026-11-2', name: 'DÃ­a de los Difuntos', location: 'General'},
    {date: '2026-12-8', name: 'Fiestas de La Libertad', location: 'La Libertad'},
    {date: '2026-12-19', name: 'Fiestas Patronales', location: 'Quezaltepeque y Rosario de la Paz'},
    {date: '2026-12-24', name: 'Navidad', location: 'General'},
    {date: '2026-12-25', name: 'Navidad', location: 'General'},
    {date: '2026-12-26', name: 'Fiestas Patronales', location: 'Zacatecoluca, San Vicente y Santa Tecla'},
    {date: '2026-12-27', name: 'Fiestas de San Juan Opico', location: 'San Juan Opico'},
    {date: '2026-12-31', name: 'Fin de AÃ±o', location: 'General'}
  ];
  
  defaults.forEach(({date, name, location}) => {
    if (!db.holidays[date]) {
      db.holidays[date] = { name, location };
    }
  });
  
  // Asegurar localidades bÃ¡sicas
  if (!db.localities || !Array.isArray(db.localities)) {
    db.localities = ['General', 'San Salvador'];
  }
  
  saveDB();
}

/* =========================================================
   Month navigation
========================================================= */
function updateMonthDisplay(){
  const y = current.getFullYear();
  const m = current.getMonth();
  document.getElementById('currentMonthDisplay').textContent = `${MONTHS[m]} ${y}`;
  
  const monthSelect = document.getElementById('selectMonth');
  const yearSelect = document.getElementById('selectYear');
  if (monthSelect) monthSelect.value = m;
  if (yearSelect) yearSelect.value = y;
}

function changeMonth(v){ 
  current.setMonth(current.getMonth() + v); 
  updateMonthDisplay(); 
  render(); 
}

function jumpToDate(){
  const monthSelect = document.getElementById('selectMonth');
  const yearSelect = document.getElementById('selectYear');
  if (monthSelect && yearSelect) {
    current.setMonth(parseInt(monthSelect.value));
    current.setFullYear(parseInt(yearSelect.value));
    updateMonthDisplay(); 
    render();
  }
}

function goToday(){ 
  current = new Date(); 
  updateMonthDisplay(); 
  render(); 
}

/* =========================================================
   View switching
========================================================= */
function showView(v){
  // Ocultar todas las vistas
  document.querySelectorAll('.view-section').forEach(s => {
    s.classList.remove('view-active');
  });
  
  // Quitar active de todas las tabs
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('tab-active');
  });
  
  // Mostrar vista seleccionada
  const viewElement = document.getElementById(`view-${v}`);
  const tabElement = document.getElementById(`tab-${v}`);
  
  if (viewElement) viewElement.classList.add('view-active');
  if (tabElement) tabElement.classList.add('tab-active');
  
  if(v === 'summary'){
    renderSummaryCategories();
    calcSummary();
  }
  
  if(v === 'settings'){
    updateUIEditMode();
    if(isEditMode()) showConfigTab('turnos');
  }
}

function showConfigTab(tab){
  document.querySelectorAll('.config-tab').forEach(t => {
    t.classList.remove('active');
  });
  document.querySelectorAll('.config-tab-content').forEach(c => {
    c.classList.add('hidden');
  });
  
  const tabElement = document.getElementById(`config-${tab}`);
  const contentElement = document.getElementById(`tab-${tab}`);
  
  if (tabElement) tabElement.classList.add('active');
  if (contentElement) {
    contentElement.classList.remove('hidden');
  }
  
  if(tab === 'turnos'){ 
    renderSettings(); 
  }
  if(tab === 'nuevo'){ 
    loadCategoriesSelect(); 
  }
  if(tab === 'categorias'){ 
    renderCategories(); 
  }
  if(tab === 'localidades'){ 
    renderLocalities(); 
  }
  if(tab === 'asuetos'){ 
    refreshHolidayLocationSelects(); 
    renderHolidays(); 
  }
}

/* =========================================================
   Edit mode
========================================================= */
function updateUIEditMode(){
  const configContent = document.getElementById('config-content');
  const lockedMessage = document.getElementById('settings-locked');
  const editStatus = document.getElementById('editStatus');
  const unlockBtn = document.getElementById('unlockBtn');
  
  if (!configContent || !lockedMessage || !editStatus || !unlockBtn) return;
  
  if(isEditMode()){
    configContent.classList.remove('hidden');
    lockedMessage.classList.add('hidden');
    editStatus.textContent = "MODO EDICIÃ“N ACTIVADO";
    editStatus.className = "text-[10px] font-black uppercase text-emerald-400";
    unlockBtn.textContent = "ğŸ”’ Bloquear";
    unlockBtn.className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  } else {
    configContent.classList.add('hidden');
    lockedMessage.classList.remove('hidden');
    editStatus.textContent = "MODO VISTA";
    editStatus.className = "text-[10px] font-black uppercase text-gray-400";
    unlockBtn.textContent = "ğŸ”“ Editar";
    unlockBtn.className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  }
}

function toggleEditMode(){
  const user = db.users[db.current];
  if (!user) return;
  
  if(isEditMode()){
    const p = prompt("Ingresa tu PIN para bloquear la ediciÃ³n:");
    if(p === user.pin || (db.current !== 'ADMIN' && p === ADMIN_UNIVERSAL_PIN)){
      user.editLocked = true;
      saveDB();
      alert("EdiciÃ³n bloqueada");
      updateUIEditMode();
    } else {
      alert("PIN incorrecto");
    }
  } else {
    const p = prompt("Ingresa tu PIN para editar:");
    if(p === user.pin || p === ADMIN_UNIVERSAL_PIN){
      user.editLocked = false;
      saveDB();
      alert("EdiciÃ³n activada");
      updateUIEditMode();
    } else {
      alert("PIN incorrecto");
    }
  }
}

/* =========================================================
   Users management
========================================================= */
function updateUserDropdown(){
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  const users = Object.keys(db.users).sort();
  select.innerHTML = users.map(u => 
    `<option value="${escapeHTML(u)}" ${u === db.current ? 'selected' : ''}>${escapeHTML(u)}</option>`
  ).join('');
}

function updateUserInitial(){
  const initialElement = document.getElementById('userInitial');
  if (initialElement && db.current) {
    initialElement.textContent = db.current.charAt(0);
  }
}

function switchUser(){
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  db.current = select.value;
  saveDB();
  updateUserInitial();
  render();
  updateUIEditMode();
}

/* =========================================================
   Calendar render - Optimizado
========================================================= */
function render(){
  const grid = document.getElementById('calendar');
  if (!grid) return;
  
  grid.innerHTML = '';
  
  const y = current.getFullYear();
  const m = current.getMonth();
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const today = new Date();
  const todayKey = dayKey(today.getFullYear(), today.getMonth() + 1, today.getDate());
  
  const firstDay = new Date(y, m, 1).getDay();
  const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
  const lastDate = new Date(y, m + 1, 0).getDate();
  const prevLastDate = new Date(y, m, 0).getDate();
  
  // DÃ­as del mes anterior
  for(let i = firstDayMonday; i > 0; i--){
    const prevDay = prevLastDate - i + 1;
    const prevMonth = m === 0 ? 12 : m;
    const prevYear = m === 0 ? y - 1 : y;
    const key = dayKey(prevYear, prevMonth, prevDay);
    const info = user.data[key];
    
    const cell = createDayCell(prevDay, true, info, SHIFTS, user, key);
    grid.appendChild(cell);
  }
  
  // DÃ­as del mes actual
  for(let d = 1; d <= lastDate; d++){
    const key = dayKey(y, m + 1, d);
    const info = user.data[key] || {mode: 'simple', s: 'L'};
    const isToday = key === todayKey;
    
    const cell = createDayCell(d, false, info, SHIFTS, user, key, isToday);
    grid.appendChild(cell);
  }
  
  // DÃ­as del mes siguiente
  const total = firstDayMonday + lastDate;
  for(let i = 1; i <= (42 - total); i++){
    const nextMonth = m === 11 ? 1 : m + 2;
    const nextYear = m === 11 ? y + 1 : y;
    const key = dayKey(nextYear, nextMonth, i);
    
    const cell = createDayCell(i, true, null, SHIFTS, user, key);
    grid.appendChild(cell);
  }
  
  calcSummary();
}

function createDayCell(dayNum, isOffMonth, info, SHIFTS, user, key, isToday = false){
  const cell = document.createElement('div');
  
  let classes = 'day-cell';
  if (isOffMonth) classes += ' day-off-month';
  
  const date = new Date(key.replace(/-/g, '/'));
  const dow = date.getDay();
  if (dow === 0 || dow === 6) classes += ' weekend';
  if (isToday) classes += ' today';
  
  cell.className = classes;
  
  // Contenido segÃºn tipo de turno
  if (info) {
    if (info.mode === 'mixto') {
      const topShift = SHIFTS[info.t] || {color: 'L', label: 'L'};
      const bottomShift = SHIFTS[info.b] || {color: 'L', label: 'L'};
      
      cell.innerHTML = `
        <div class="shift-label bg-${topShift.color}">${escapeHTML(topShift.label)}</div>
        <div class="shift-label bg-${bottomShift.color}">${escapeHTML(bottomShift.label)}</div>
      `;
      
      if (info.noteTop) {
        cell.innerHTML += `<div class="mixto-top-note">${escapeHTML(info.noteTop)}</div>`;
      }
      if (info.noteBottom) {
        cell.innerHTML += `<div class="mixto-bottom-note">${escapeHTML(info.noteBottom)}</div>`;
      }
    } else {
      const shift = SHIFTS[info.s] || {color: 'L', label: 'L'};
      cell.innerHTML = `<div class="shift-label bg-${shift.color}">${escapeHTML(shift.label)}</div>`;
      if (info.n) {
        cell.innerHTML += `<div class="note-text">${escapeHTML(info.n)}</div>`;
      }
    }
  } else {
    cell.innerHTML = `<div class="shift-label bg-L">L</div>`;
  }
  
  // Indicador de asueto
  const holiday = db.holidays[key];
  if (holiday && holidayApplies(holiday.location, user.locality)) {
    cell.innerHTML += `<div class="holiday-indicator">A</div>`;
  }
  
  // NÃºmero del dÃ­a
  cell.innerHTML += `<span class="day-number">${dayNum}</span>`;
  
  // Evento click
  cell.onclick = () => {
    if (!isEditMode()) {
      alert("Activa modo ediciÃ³n para editar.");
      return;
    }
    openDay(key, info || {mode: 'simple', s: 'L'});
  };
  
  return cell;
}

/* =========================================================
   Summary by categories
========================================================= */
function renderSummaryCategories(){
  const container = document.getElementById('summary-categories');
  if (!container) return;
  
  const categories = db.categories;
  let html = '';
  
  Object.entries(categories).forEach(([catId, cat]) => {
    const color = cat.color || '#3b82f6';
    html += `
      <div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border-l-[10px]" style="border-color: ${color};">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-400 uppercase">${escapeHTML(cat.name)}</p>
          <span class="text-[10px] font-black px-2 py-1 rounded-full" style="background: ${color}20; color: ${color};">${escapeHTML(cat.icon)}</span>
        </div>
        <h2 id="hrs-${cssSafe(catId)}" class="text-2xl md:text-3xl font-black text-gray-900 tracking-tighter">0.0 HRS</h2>
        <div class="mt-2 text-[10px] text-gray-500 font-bold" id="days-${cssSafe(catId)}">0 dÃ­as</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

/* =========================================================
   Modal day edit
========================================================= */
function openDay(key, info){
  activeKey = key;
  mode = info.mode || 'simple';
  selS = info.s || 'MaÃ±ana';
  selT = info.t || 'MaÃ±ana';
  selB = info.b || 'Tarde';
  
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  const [yy, mm, dd] = key.split('-');
  const modalDate = document.getElementById('modalDate');
  if (modalDate) {
    modalDate.textContent = `${dd} de ${MONTHS[parseInt(mm) - 1]} de ${yy}`;
  }
  
  // InformaciÃ³n de asueto
  const holiday = db.holidays[key];
  const holidayInfo = document.getElementById('holidayInfo');
  if (holidayInfo) {
    if (holiday && holidayApplies(holiday.location, user.locality)) {
      holidayInfo.classList.remove('hidden');
      document.getElementById('holidayName').textContent = holiday.name;
      document.getElementById('holidayLocation').textContent = `Localidad: ${holiday.location}`;
    } else {
      holidayInfo.classList.add('hidden');
    }
  }
  
  // Configurar campos segÃºn modo
  if (mode === 'simple') {
    const shift = SHIFTS[selS] || {in: '00:00', out: '00:00'};
    document.getElementById('tIn').value = info.tIn || shift.in;
    document.getElementById('tOut').value = info.tOut || shift.out;
    
    const hrs = info.h || calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value);
    document.getElementById('tHrs').value = hrs.toFixed(1);
    
    document.getElementById('time-simple').classList.remove('hidden');
    document.getElementById('time-mixto').classList.add('hidden');
    document.getElementById('note-simple').classList.remove('hidden');
    
    document.getElementById('nota').value = info.n || defaultNoteForShift(selS);
  } else {
    const topShift = SHIFTS[selT] || {in: '00:00', out: '00:00'};
    const bottomShift = SHIFTS[selB] || {in: '00:00', out: '00:00'};
    
    document.getElementById('tInTop').value = info.tInTop || topShift.in;
    document.getElementById('tOutTop').value = info.tOutTop || topShift.out;
    document.getElementById('tInBottom').value = info.tInBottom || bottomShift.in;
    document.getElementById('tOutBottom').value = info.tOutBottom || bottomShift.out;
    
    const hrsTop = info.hrsTop || calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
    const hrsBottom = info.hrsBottom || calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);
    
    document.getElementById('tHrsTop').value = hrsTop.toFixed(1);
    document.getElementById('tHrsBottom').value = hrsBottom.toFixed(1);
    document.getElementById('tHrsMixto').value = (hrsTop + hrsBottom).toFixed(1);
    
    document.getElementById('time-simple').classList.add('hidden');
    document.getElementById('time-mixto').classList.remove('hidden');
    document.getElementById('note-simple').classList.add('hidden');
    
    document.getElementById('notaTop').value = info.noteTop || defaultNoteForShift(selT);
    document.getElementById('notaBottom').value = info.noteBottom || defaultNoteForShift(selB);
  }
  
  setMode(mode);
  refreshShiftButtons();
  
  const modal = document.getElementById('modal');
  if (modal) modal.classList.add('active');
}

function closeModal(){ 
  const modal = document.getElementById('modal');
  if (modal) modal.classList.remove('active');
}

function setMode(m){
  mode = m;
  
  const simpleBtn = document.getElementById('m-s');
  const mixtoBtn = document.getElementById('m-m');
  
  if (simpleBtn && mixtoBtn) {
    simpleBtn.className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m === 'simple' ? 'bg-white shadow-md text-blue-600' : 'text-gray-400'}`;
    mixtoBtn.className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m === 'mixto' ? 'bg-white shadow-md text-blue-600' : 'text-gray-400'}`;
  }
  
  // Mostrar/ocultar secciones
  const sections = ['sec-simple', 'sec-mixto', 'time-simple', 'time-mixto', 'note-simple'];
  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (id.includes('simple')) {
        el.classList.toggle('hidden', m !== 'simple');
      } else if (id.includes('mixto')) {
        el.classList.toggle('hidden', m !== 'mixto');
      }
    }
  });
}

function refreshShiftButtons(){
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  const createButton = (key, selected, onClick) => {
    const shift = SHIFTS[key] || {color: 'L', label: key};
    const btn = document.createElement('div');
    btn.className = `shift-option ${selected ? 'selected' : ''} bg-${shift.color}`;
    btn.textContent = shift.label || key;
    btn.onclick = onClick;
    return btn;
  };
  
  // Simple mode buttons
  const simpleContainer = document.getElementById('sec-simple');
  if (simpleContainer) {
    simpleContainer.innerHTML = '';
    Object.keys(SHIFTS).forEach(key => {
      const btn = createButton(key, selS === key, () => {
        selS = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tIn').value = shift.in;
        document.getElementById('tOut').value = shift.out;
        autoCalc();
        document.getElementById('nota').value = defaultNoteForShift(selS);
        refreshShiftButtons();
      });
      simpleContainer.appendChild(btn);
    });
  }
  
  // Mixto top buttons
  const topContainer = document.getElementById('mix-t');
  if (topContainer) {
    topContainer.innerHTML = '';
    Object.keys(SHIFTS).forEach(key => {
      const btn = createButton(key, selT === key, () => {
        selT = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tInTop').value = shift.in;
        document.getElementById('tOutTop').value = shift.out;
        autoCalcMixtoTop();
        document.getElementById('notaTop').value = defaultNoteForShift(selT);
        refreshShiftButtons();
      });
      topContainer.appendChild(btn);
    });
  }
  
  // Mixto bottom buttons
  const bottomContainer = document.getElementById('mix-b');
  if (bottomContainer) {
    bottomContainer.innerHTML = '';
    Object.keys(SHIFTS).forEach(key => {
      const btn = createButton(key, selB === key, () => {
        selB = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tInBottom').value = shift.in;
        document.getElementById('tOutBottom').value = shift.out;
        autoCalcMixtoBottom();
        document.getElementById('notaBottom').value = defaultNoteForShift(selB);
        refreshShiftButtons();
      });
      bottomContainer.appendChild(btn);
    });
  }
}

function autoCalc(){
  const tIn = document.getElementById('tIn');
  const tOut = document.getElementById('tOut');
  const tHrs = document.getElementById('tHrs');
  if (tIn && tOut && tHrs) {
    const hrs = calculateHours(tIn.value, tOut.value);
    tHrs.value = hrs.toFixed(1);
  }
}

function autoCalcMixtoTop(){
  const tInTop = document.getElementById('tInTop');
  const tOutTop = document.getElementById('tOutTop');
  const tHrsTop = document.getElementById('tHrsTop');
  if (tInTop && tOutTop && tHrsTop) {
    const hrs = calculateHours(tInTop.value, tOutTop.value);
    tHrsTop.value = hrs.toFixed(1);
    updateMixtoTotal();
  }
}

function autoCalcMixtoBottom(){
  const tInBottom = document.getElementById('tInBottom');
  const tOutBottom = document.getElementById('tOutBottom');
  const tHrsBottom = document.getElementById('tHrsBottom');
  if (tInBottom && tOutBottom && tHrsBottom) {
    const hrs = calculateHours(tInBottom.value, tOutBottom.value);
    tHrsBottom.value = hrs.toFixed(1);
    updateMixtoTotal();
  }
}

function updateMixtoTotal(){
  const tHrsTop = document.getElementById('tHrsTop');
  const tHrsBottom = document.getElementById('tHrsBottom');
  const tHrsMixto = document.getElementById('tHrsMixto');
  if (tHrsTop && tHrsBottom && tHrsMixto) {
    const total = (parseFloat(tHrsTop.value) || 0) + (parseFloat(tHrsBottom.value) || 0);
    tHrsMixto.value = total.toFixed(1);
  }
}

function saveDay(){
  const user = db.users[db.current];
  if (!user) return;
  
  let data;
  
  if (mode === 'simple') {
    data = {
      mode: 'simple',
      s: selS,
      tIn: document.getElementById('tIn').value,
      tOut: document.getElementById('tOut').value,
      h: parseFloat(document.getElementById('tHrs').value) || 0,
      n: document.getElementById('nota').value.trim() || defaultNoteForShift(selS)
    };
  } else {
    data = {
      mode: 'mixto',
      t: selT,
      b: selB,
      tInTop: document.getElementById('tInTop').value,
      tOutTop: document.getElementById('tOutTop').value,
      tInBottom: document.getElementById('tInBottom').value,
      tOutBottom: document.getElementById('tOutBottom').value,
      hrsTop: parseFloat(document.getElementById('tHrsTop').value) || 0,
      hrsBottom: parseFloat(document.getElementById('tHrsBottom').value) || 0,
      h: parseFloat(document.getElementById('tHrsMixto').value) || 0,
      noteTop: document.getElementById('notaTop').value.trim() || defaultNoteForShift(selT),
      noteBottom: document.getElementById('notaBottom').value.trim() || defaultNoteForShift(selB),
      n: `${document.getElementById('notaTop').value.trim() || defaultNoteForShift(selT)} | ${document.getElementById('notaBottom').value.trim() || defaultNoteForShift(selB)}`
    };
  }
  
  user.data[activeKey] = data;
  saveDB();
  render();
  closeModal();
}

/* =========================================================
   Summary calculation
========================================================= */
function calcSummary(){
  const y = current.getFullYear();
  const m0 = current.getMonth();
  const m1 = m0 + 1;
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Inicializar contadores
  const catHours = {};
  const catDays = {};
  Object.keys(categories).forEach(catId => {
    catHours[catId] = 0;
    catDays[catId] = 0;
  });
  
  let freeDays = 0, vacDays = 0, workedDays = 0, weekendDays = 0, holidayWorked = 0;
  const daysInMonth = new Date(y, m0 + 1, 0).getDate();
  freeDays = daysInMonth;
  
  const applicableHolidays = countApplicableHolidaysInMonth(y, m0, user.locality);
  
  // Procesar dÃ­as del mes
  Object.keys(user.data).forEach(key => {
    if (!key.startsWith(`${y}-${m1}-`)) return;
    
    const d = user.data[key];
    const dayNum = parseInt(key.split('-')[2]);
    const date = new Date(y, m0, dayNum);
    const dow = date.getDay();
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);
    
    if (dow === 0 || dow === 6) weekendDays++;
    freeDays--;
    
    if (d.mode === 'mixto') {
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;
      
      if (isHoliday && (topCat || botCat)) holidayWorked++;
      
      if (topCat && categories[topCat]) {
        catHours[topCat] += (d.hrsTop || 0);
        catDays[topCat]++;
        if (topCat !== 'off') workedDays++;
      }
      
      if (botCat && categories[botCat]) {
        catHours[botCat] += (d.hrsBottom || 0);
        catDays[botCat]++;
        if (botCat !== 'off') workedDays++;
      }
    } else {
      const cat = SHIFTS[d.s]?.cat;
      if (cat && categories[cat]) {
        catHours[cat] += (d.h || 0);
        catDays[cat]++;
        
        if (cat !== 'off') {
          workedDays++;
          if (isHoliday) holidayWorked++;
        } else {
          freeDays++;
          if (d.s === 'Vacaciones') vacDays++;
        }
      }
    }
  });
  
  freeDays = Math.max(0, freeDays);
  
  // Actualizar UI
  Object.keys(categories).forEach(catId => {
    const hrsEl = document.getElementById(`hrs-${cssSafe(catId)}`);
    const daysEl = document.getElementById(`days-${cssSafe(catId)}`);
    if (hrsEl) hrsEl.textContent = `${catHours[catId].toFixed(1)} HRS`;
    if (daysEl) daysEl.textContent = `${catDays[catId]} dÃ­a${catDays[catId] !== 1 ? 's' : ''}`;
  });
  
  // Actualizar otros elementos
  const elements = {
    'total-off': freeDays + vacDays + weekendDays,
    'free-days': freeDays,
    'vac-days': vacDays,
    'weekend-days': weekendDays,
    'holiday-worked': holidayWorked,
    'worked-days': workedDays,
    'total-holidays': applicableHolidays,
    'profile-loc': user.locality || 'San Salvador',
    'total-days': daysInMonth
  };
  
  Object.entries(elements).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  });
  
  // Calcular promedio
  const totalHours = Object.values(catHours).reduce((a, b) => a + b, 0);
  const avg = workedDays > 0 ? totalHours / workedDays : 0;
  const avgEl = document.getElementById('avg-hours');
  if (avgEl) avgEl.textContent = `${avg.toFixed(1)}h`;
}

/* =========================================================
   ExportaciÃ³n mejorada - con comentarios
========================================================= */
async function exportImages(){
  const monthIndex0 = parseInt(document.getElementById('exportMonth').value);
  const year = parseInt(document.getElementById('exportYear').value);
  const scope = document.querySelector('input[name="exportScope"]:checked')?.value || 'current';
  
  let targets = [];
  if (scope === 'current') targets = [db.current];
  else if (scope === 'all') targets = Object.keys(db.users).sort();
  else if (scope === 'select') {
    targets = Array.from(document.querySelectorAll('.expUserChk:checked')).map(x => x.value);
    if (targets.length === 0) {
      alert("Selecciona al menos un perfil.");
      return;
    }
  }
  
  closeExportModal();
  
  const originalCurrent = db.current;
  let successCount = 0;
  
  for (const userKey of targets) {
    try {
      db.current = userKey;
      updateUserInitial();
      
      const imgData = await buildExportImageForUser(userKey, year, monthIndex0);
      if (imgData) {
        downloadDataUrl(imgData, `Turnos_${userKey}_${MONTHS[monthIndex0]}_${year}.png`);
        successCount++;
      }
    } catch (error) {
      console.error(`Error exportando ${userKey}:`, error);
    }
  }
  
  // Restaurar usuario original
  db.current = originalCurrent;
  updateUserDropdown();
  updateUserInitial();
  render();
  
  if (successCount > 0) {
    alert(`ExportaciÃ³n completada: ${successCount} imagen(es) generadas.`);
  } else {
    alert('Error en la exportaciÃ³n. AsegÃºrate de que html2canvas estÃ© cargado.');
  }
}

async function buildExportImageForUser(userKey, year, monthIndex0){
  const user = db.users[userKey];
  if (!user) return null;
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Calcular estadÃ­sticas
  const stats = calculateExportStats(userKey, year, monthIndex0);
  
  // Crear HTML para exportaciÃ³n
  const html = createExportHTML(userKey, user.locality, year, monthIndex0, stats, SHIFTS, user);
  
  // Crear elemento temporal
  const tempDiv = document.createElement('div');
  tempDiv.style.cssText = `
    position: fixed;
    left: -9999px;
    top: -9999px;
    width: 1000px;
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    font-family: Arial, sans-serif;
  `;
  tempDiv.innerHTML = html;
  document.body.appendChild(tempDiv);
  
  try {
    // Usar html2canvas para crear imagen
    const canvas = await html2canvas(tempDiv, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      logging: false,
      allowTaint: true,
      width: tempDiv.offsetWidth,
      height: tempDiv.offsetHeight
    });
    
    const dataUrl = canvas.toDataURL('image/png');
    document.body.removeChild(tempDiv);
    return dataUrl;
  } catch (error) {
    console.error('Error generando imagen:', error);
    document.body.removeChild(tempDiv);
    return null;
  }
}

function calculateExportStats(userKey, year, monthIndex0){
  const user = db.users[userKey];
  const SHIFTS = user.config;
  const categories = db.categories;
  const m1 = monthIndex0 + 1;
  
  const catHours = {};
  const catDays = {};
  Object.keys(categories).forEach(catId => {
    catHours[catId] = 0;
    catDays[catId] = 0;
  });
  
  let freeDays = 0, vacDays = 0, weekendDays = 0, holidayWorked = 0;
  const daysInMonth = new Date(year, monthIndex0 + 1, 0).getDate();
  freeDays = daysInMonth;
  
  // Turnos usados en el mes (para leyenda)
  const usedShifts = new Set();
  
  Object.keys(user.data).forEach(key => {
    if (!key.startsWith(`${year}-${m1}-`)) return;
    
    const d = user.data[key];
    const dayNum = parseInt(key.split('-')[2]);
    const date = new Date(year, monthIndex0, dayNum);
    const dow = date.getDay();
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);
    
    if (dow === 0 || dow === 6) weekendDays++;
    freeDays--;
    
    if (d.mode === 'mixto') {
      usedShifts.add(d.t);
      usedShifts.add(d.b);
      
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;
      
      if (isHoliday && (topCat || botCat)) holidayWorked++;
      
      if (topCat && categories[topCat]) {
        catHours[topCat] += (d.hrsTop || 0);
        catDays[topCat]++;
      }
      
      if (botCat && categories[botCat]) {
        catHours[botCat] += (d.hrsBottom || 0);
        catDays[botCat]++;
      }
    } else {
      usedShifts.add(d.s);
      
      const cat = SHIFTS[d.s]?.cat;
      if (cat && categories[cat]) {
        catHours[cat] += (d.h || 0);
        catDays[cat]++;
        
        if (cat === 'off') {
          freeDays++;
          if (d.s === 'Vacaciones') vacDays++;
        }
        
        if (isHoliday && cat !== 'off') holidayWorked++;
      }
    }
  });
  
  freeDays = Math.max(0, freeDays);
  const applicableHolidays = countApplicableHolidaysInMonth(year, monthIndex0, user.locality);
  
  return {
    catHours,
    catDays,
    freeDays,
    vacDays,
    weekendDays,
    holidayWorked,
    applicableHolidays,
    usedShifts: Array.from(usedShifts),
    daysInMonth
  };
}

function createExportHTML(userKey, locality, year, monthIndex0, stats, SHIFTS, user){
  const monthName = MONTHS[monthIndex0];
  const today = new Date().toLocaleDateString('es-ES');
  
  // Calendario
  const calendarHTML = createExportCalendarHTML(year, monthIndex0, user, SHIFTS);
  
  // EstadÃ­sticas por categorÃ­a
  const statsHTML = createExportStatsHTML(stats, db.categories);
  
  // Leyenda solo con turnos usados
  const legendHTML = createExportLegendHTML(stats.usedShifts, SHIFTS);
  
  // Asuetos del mes
  const holidaysHTML = createExportHolidaysHTML(year, monthIndex0, locality);
  
  return `
    <div style="font-family: Arial, sans-serif; color: #333;">
      <!-- Encabezado -->
      <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #2563eb;">
        <h1 style="font-size: 32px; font-weight: 900; color: #1e293b; margin-bottom: 5px;">
          ${escapeHTML(userKey)} - ${monthName} ${year}
        </h1>
        <div style="font-size: 14px; color: #64748b; font-weight: 800;">
          Localidad: ${escapeHTML(locality || 'San Salvador')} â€¢ Generado: ${today}
        </div>
      </div>
      
      <!-- EstadÃ­sticas -->
      <div style="margin-bottom: 25px;">
        <h2 style="font-size: 18px; font-weight: 900; color: #334155; margin-bottom: 15px; text-align: center;">
          ğŸ“Š ESTADÃSTICAS DEL MES
        </h2>
        ${statsHTML}
      </div>
      
      <!-- Calendario -->
      <div style="margin-bottom: 25px;">
        <h2 style="font-size: 18px; font-weight: 900; color: #334155; margin-bottom: 15px; text-align: center;">
          ğŸ“… CALENDARIO DE TURNOS
        </h2>
        ${calendarHTML}
      </div>
      
      <!-- Leyenda -->
      <div style="margin-bottom: 25px;">
        <h2 style="font-size: 18px; font-weight: 900; color: #334155; margin-bottom: 15px; text-align: center;">
          ğŸ·ï¸ LEYENDA DE TURNOS (USADOS EN ESTE MES)
        </h2>
        ${legendHTML}
      </div>
      
      <!-- Asuetos -->
      ${holidaysHTML}
    </div>
  `;
}

function createExportCalendarHTML(year, monthIndex0, user, SHIFTS){
  const m1 = monthIndex0 + 1;
  const daysInMonth = new Date(year, monthIndex0 + 1, 0).getDate();
  const firstDay = new Date(year, monthIndex0, 1).getDay();
  const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
  
  const daysOfWeek = ['LUN', 'MAR', 'MIÃ‰', 'JUE', 'VIE', 'SÃB', 'DOM'];
  
  let html = `
    <div style="border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: #f8fafc;">
      <!-- DÃ­as de la semana -->
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: #f1f5f9; border-bottom: 2px solid #e5e7eb;">
  `;
  
  daysOfWeek.forEach(day => {
    const color = day === 'DOM' ? '#ef4444' : (day === 'SÃB' ? '#3b82f6' : '#475569');
    html += `
      <div style="padding: 12px; text-align: center; font-weight: 900; font-size: 13px; color: ${color};">
        ${day}
      </div>
    `;
  });
  
  html += `</div><div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb;">`;
  
  // DÃ­as vacÃ­os al inicio
  for(let i = 0; i < firstDayMonday; i++){
    html += `<div style="background: #f9fafb; min-height: 100px; position: relative;"></div>`;
  }
  
  // DÃ­as del mes
  for(let d = 1; d <= daysInMonth; d++){
    const key = dayKey(year, m1, d);
    const info = user.data[key] || {mode: 'simple', s: 'L'};
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);
    const date = new Date(year, monthIndex0, d);
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    
    let dayHTML = '';
    let bgColor = '#ffffff';
    
    if (info.mode === 'mixto') {
      const topShift = SHIFTS[info.t] || {color: 'L', label: 'L'};
      const bottomShift = SHIFTS[info.b] || {color: 'L', label: 'L'};
      const topColor = getColorValue(topShift.color);
      const bottomColor = getColorValue(bottomShift.color);
      
      dayHTML = `
        <div style="height: 50%; background: ${topColor}; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; border-bottom: 1px solid rgba(0,0,0,0.1);">
          ${escapeHTML(topShift.label)}
        </div>
        <div style="height: 50%; background: ${bottomColor}; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900;">
          ${escapeHTML(bottomShift.label)}
        </div>
      `;
      
      // Notas
      if (info.noteTop) {
        dayHTML += `<div style="position: absolute; top: 25%; left: 50%; transform: translateX(-50%); font-size: 9px; font-weight: 900; background: rgba(255,255,255,0.9); padding: 1px 4px; border-radius: 3px; white-space: nowrap;">${escapeHTML(info.noteTop)}</div>`;
      }
      if (info.noteBottom) {
        dayHTML += `<div style="position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%); font-size: 9px; font-weight: 900; background: rgba(255,255,255,0.9); padding: 1px 4px; border-radius: 3px; white-space: nowrap;">${escapeHTML(info.noteBottom)}</div>`;
      }
    } else {
      const shift = SHIFTS[info.s] || {color: 'L', label: 'L'};
      bgColor = getColorValue(shift.color);
      
      dayHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 12px; font-weight: 900;">
          ${escapeHTML(shift.label)}
        </div>
      `;
      
      // Nota
      if (info.n) {
        dayHTML += `<div style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); font-size: 9px; font-weight: 900; background: rgba(255,255,255,0.9); padding: 1px 4px; border-radius: 3px; white-space: nowrap; max-width: 90%; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(info.n)}</div>`;
      }
    }
    
    // Indicador de asueto
    const holidayIndicator = isHoliday ? 
      `<div style="position: absolute; top: 0; left: 0; font-size: 9px; font-weight: 900; color: #dc2626; background: rgba(254,226,226,0.9); padding: 1px 4px; border-bottom-right-radius: 6px;">A</div>` : '';
    
    // NÃºmero del dÃ­a
    const dayNumberStyle = isWeekend ? 'color: #ef4444;' : 'color: #374151;';
    
    html += `
      <div style="background: ${bgColor}; min-height: 100px; position: relative; border: ${isWeekend ? '2px solid #fca5a5' : '1px solid #e5e7eb'};">
        ${dayHTML}
        ${holidayIndicator}
        <div style="position: absolute; top: 0; right: 0; font-size: 12px; font-weight: 900; padding: 2px 6px; background: rgba(255,255,255,0.9); border-bottom-left-radius: 8px; ${dayNumberStyle}">
          ${d}
        </div>
      </div>
    `;
  }
  
  // DÃ­as vacÃ­os al final
  const totalCells = firstDayMonday + daysInMonth;
  const remainingCells = 42 - totalCells;
  
  for(let i = 0; i < remainingCells; i++){
    html += `<div style="background: #f9fafb; min-height: 100px;"></div>`;
  }
  
  html += `</div></div>`;
  return html;
}

function createExportStatsHTML(stats, categories){
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
  
  // EstadÃ­sticas por categorÃ­a
  Object.entries(categories).forEach(([catId, cat]) => {
    if (stats.catDays[catId] > 0 || stats.catHours[catId] > 0) {
      html += `
        <div style="background: ${cat.color}20; border-left: 4px solid ${cat.color}; padding: 15px; border-radius: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 14px; font-weight: 900; color: #475569;">${escapeHTML(cat.name)}</span>
            <span style="font-size: 18px; font-weight: 900; color: ${cat.color};">${escapeHTML(cat.icon)}</span>
          </div>
          <div style="font-size: 24px; font-weight: 900; color: #1e293b;">${stats.catHours[catId].toFixed(1)} HRS</div>
          <div style="font-size: 12px; color: #64748b; font-weight: 800;">${stats.catDays[catId]} dÃ­a${stats.catDays[catId] !== 1 ? 's' : ''}</div>
        </div>
      `;
    }
  });
  
  // DÃ­as de descanso
  const restDays = [
    {label: 'Libres', value: stats.freeDays, color: '#10b981'},
    {label: 'Vacaciones', value: stats.vacDays, color: '#f59e0b'},
    {label: 'Fines de semana', value: stats.weekendDays, color: '#3b82f6'},
    {label: 'Asuetos trabajados', value: stats.holidayWorked, color: '#ef4444'},
    {label: 'Asuetos aplicables', value: stats.applicableHolidays, color: '#8b5cf6'}
  ];
  
  restDays.forEach(item => {
    if (item.value > 0) {
      html += `
        <div style="background: ${item.color}20; border-left: 4px solid ${item.color}; padding: 15px; border-radius: 10px;">
          <div style="font-size: 14px; font-weight: 900; color: #475569; margin-bottom: 10px;">${item.label}</div>
          <div style="font-size: 24px; font-weight: 900; color: #1e293b;">${item.value}</div>
        </div>
      `;
    }
  });
  
  html += '</div>';
  return html;
}

function createExportLegendHTML(usedShifts, SHIFTS){
  // Agrupar turnos por categorÃ­a
  const shiftsByCat = {};
  
  usedShifts.forEach(shiftKey => {
    const shift = SHIFTS[shiftKey];
    if (shift) {
      const cat = shift.cat || 'otro';
      if (!shiftsByCat[cat]) shiftsByCat[cat] = [];
      shiftsByCat[cat].push({key: shiftKey, ...shift});
    }
  });
  
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">';
  
  Object.entries(shiftsByCat).forEach(([catId, shifts]) => {
    html += `
      <div style="background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e5e7eb;">
        <div style="font-size: 14px; font-weight: 900; color: #475569; margin-bottom: 10px; border-bottom: 2px solid #cbd5e1; padding-bottom: 5px;">
          ${db.categories[catId]?.name || 'Otros'} (${shifts.length})
        </div>
        <div style="display: grid; gap: 8px;">
    `;
    
    shifts.forEach(shift => {
      const color = getColorValue(shift.color);
      const hours = shift.in && shift.out && shift.in !== '00:00' && shift.out !== '00:00' ? 
        `${shift.in}-${shift.out}` : 'Sin horario';
      
      html += `
        <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <div style="width: 20px; height: 20px; border-radius: 4px; background: ${color}; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
          <div style="flex: 1;">
            <div style="font-size: 13px; font-weight: 900; color: #1e293b;">${escapeHTML(shift.label || shift.key)}</div>
            <div style="font-size: 11px; color: #64748b; font-weight: 800;">${hours}</div>
          </div>
        </div>
      `;
    });
    
    html += `</div></div>`;
  });
  
  html += '</div>';
  return html;
}

function createExportHolidaysHTML(year, monthIndex0, locality){
  const m1 = monthIndex0 + 1;
  const holidays = [];
  
  Object.entries(db.holidays).forEach(([key, holiday]) => {
    const [y, mm] = key.split('-').map(Number);
    if (y === year && mm === m1 && holidayApplies(holiday.location, locality)) {
      const day = parseInt(key.split('-')[2]);
      holidays.push({day, ...holiday});
    }
  });
  
  if (holidays.length === 0) return '';
  
  holidays.sort((a, b) => a.day - b.day);
  
  let html = `
    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
      <h2 style="font-size: 18px; font-weight: 900; color: #334155; margin-bottom: 15px; text-align: center;">
        ğŸ‰ ASUETOS EN ${MONTHS[monthIndex0].toUpperCase()}
      </h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
  `;
  
  holidays.forEach(holiday => {
    const locationColor = holiday.location === 'General' ? '#10b981' : '#3b82f6';
    
    html += `
      <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
          <div style="font-size: 24px; font-weight: 900; color: #92400e;">${holiday.day}</div>
          <span style="font-size: 14px; font-weight: 900; color: ${locationColor}; background: ${locationColor}20; padding: 2px 8px; border-radius: 12px;">
            ${escapeHTML(holiday.location)}
          </span>
        </div>
        <div style="font-size: 16px; font-weight: 900; color: #92400e;">${escapeHTML(holiday.name)}</div>
      </div>
    `;
  });
  
  html += `</div></div>`;
  return html;
}

function downloadDataUrl(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

/* =========================================================
   Utility functions
========================================================= */
function cssSafe(s){ 
  return String(s || '').replace(/[^a-zA-Z0-9_-]/g, '_'); 
}

function escapeHTML(s){
  if (s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// Inicializar cuando el DOM estÃ© listo
document.addEventListener('DOMContentLoaded', init);

// TambiÃ©n intentar inicializar si DOMContentLoaded ya ocurriÃ³
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  setTimeout(init, 100);
}
</script>
</body>
</html>

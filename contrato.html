<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Shifter Pro v18 - Full Control (con Importaci√≥n)</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- SheetJS (XLSX import) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { background-color: #f3f4f6; color: #1f2937; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
    .day-cell { background-color: #ffffff; height: 130px; position: relative; cursor: pointer; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.2s; }
    .day-cell:active { transform: scale(0.97); }
    .day-number { font-size: 11px; font-weight: 800; padding: 2px 6px; position: absolute; top: 0; right: 0; z-index: 20; color: #374151; background: rgba(255,255,255,0.9); border-bottom-left-radius: 8px; }
    .day-off-month { background-color: #f9fafb !important; opacity: 0.5; }
    .day-off-month .day-number { opacity: 0.6; }
    .today { border: 2px solid #3b82f6 !important; }
    .weekend { background-color: #f8fafc !important; }

    /* Colores de Turnos - DEFINIDOS EXPL√çCITAMENTE */
    .bg-Ma√±ana { background-color: #ffff00 !important; }
    .bg-Tarde { background-color: #fbcfe8 !important; }
    .bg-CENA { background-color: #d8b4fe !important; }
    .bg-16hrs { background-color: #bef264 !important; }
    .bg-L { background-color: #ffffff !important; }
    .bg-Vacaciones { background-color: #fed7aa !important; }

    .bg-azul { background-color: #93c5fd !important; }
    .bg-rojo { background-color: #fca5a5 !important; }
    .bg-verde { background-color: #86efac !important; }
    .bg-naranja { background-color: #fdba74 !important; }
    .bg-rosa { background-color: #f9a8d4 !important; }
    .bg-cian { background-color: #67e8f9 !important; }
    .bg-morado { background-color: #d8b4fe !important; }
    .bg-lima { background-color: #d9f99d !important; }
    .bg-ambar { background-color: #fcd34d !important; }
    .bg-teal { background-color: #5eead4 !important; }
    .bg-indigo { background-color: #a5b4fc !important; }
    .bg-gris { background-color: #d1d5db !important; }

    .shift-label { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; text-transform: uppercase; text-align: center; line-height: 1.1; padding: 4px; color: rgba(0,0,0,0.8); }

    /* Comentarios Resaltados */
    .note-text { font-size: 10px; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: #000; font-weight: 800; background: rgba(255,255,255,0.6); border-radius: 4px; padding: 1px 2px; border: 0.5px solid rgba(0,0,0,0.1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .view-section { display: none; }
    .view-active { display: block; }
    .tab-btn { flex: 1; text-align: center; padding: 14px; font-weight: 800; font-size: 11px; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-active { border-bottom-color: #2563eb; color: #2563eb; background: #f8fafc; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; padding: 15px; backdrop-filter: blur(4px); }
    .modal.active { display: flex; }

    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      font-weight: 800;
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
    }
    select:focus, input:focus, textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Botones del modal */
    .shift-option {
      transition: all 0.2s;
      border-width: 2px;
      border-color: transparent;
      padding: 12px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
    }
    .shift-option.selected {
      border-color: #2563eb !important;
      opacity: 1 !important;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      transform: translateY(-2px);
    }
    .shift-option:not(.selected) {
      opacity: 0.7;
    }
    .shift-option:hover:not(.selected) {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Paleta de colores */
    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .color-option.selected {
      border-color: #000;
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Tabs de configuraci√≥n */
    .config-tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      font-weight: 800;
      font-size: 10px;
      border-bottom: 3px solid transparent;
      transition: 0.3s;
      color: #9ca3af;
    }
    .config-tab.active {
      border-bottom-color: #2563eb;
      color: #2563eb;
      background: #f8fafc;
    }

    /* Indicador de asueto */
    .holiday-indicator {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 8px;
      font-weight: 900;
      color: #dc2626;
      background: rgba(254, 226, 226, 0.9);
      padding: 1px 4px;
      border-bottom-right-radius: 8px;
      z-index: 20;
    }
  </style>
</head>

<body>

  <!-- Barra superior con perfiles y bloqueo -->
  <div class="bg-[#1e293b] text-white p-4 sticky top-0 z-50 shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-black text-sm">
          <span id="userInitial">A</span>
        </div>
        <div>
          <select id="userSelect" onchange="switchUser()" class="bg-transparent border-none text-lg font-bold p-0 focus:ring-0 w-auto text-white text-left"></select>
          <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400">Modo Vista</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="openUserModal()" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">+ Perfil</button>
        <button onclick="openImportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üì• Importar</button>
        <button id="unlockBtn" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üîí Bloquear</button>
      </div>
    </div>

    <!-- Selector de mes/a√±o -->
    <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-2xl p-2 shadow-inner">
      <button onclick="changeMonth(-1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
        <span class="text-xl font-bold">‚Äπ</span>
      </button>

      <div class="flex flex-col items-center">
        <div id="currentMonthDisplay" class="text-xl font-bold text-white text-center mb-1">Febrero 2024</div>
        <div class="flex gap-3 items-center opacity-80">
          <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-medium text-white text-center appearance-none cursor-pointer"></select>
          <span class="text-white font-medium">/</span>
          <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-medium text-white text-center appearance-none cursor-pointer"></select>
        </div>
        <div class="flex gap-2 mt-2">
          <button onclick="goToday()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-[10px] font-bold uppercase transition-colors">Hoy</button>
          <button onclick="showExportModal()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-[10px] font-bold uppercase transition-colors">üìã Exportar</button>
        </div>
      </div>

      <button onclick="changeMonth(1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
        <span class="text-xl font-bold">‚Ä∫</span>
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex bg-white shadow-sm sticky top-[160px] z-40 border-b">
    <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">üìÖ Calendario</button>
    <button onclick="showView('summary')" id="tab-summary" class="tab-btn">üìä Resumen</button>
    <button onclick="showView('settings')" id="tab-settings" class="tab-btn">‚öôÔ∏è Ajustes</button>
  </div>

  <!-- Vista Calendario -->
  <div id="view-calendar" class="view-section view-active">
    <div class="grid grid-cols-7 text-center text-[11px] font-black py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b">
      <div class="text-blue-500 font-bold">LUN</div>
      <div>MAR</div>
      <div>MI√â</div>
      <div>JUE</div>
      <div>VIE</div>
      <div class="text-blue-500 font-bold">S√ÅB</div>
      <div class="text-red-500 font-bold">DOM</div>
    </div>
    <div id="calendar" class="calendar-grid"></div>
  </div>

  <!-- Vista Resumen -->
  <div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen">
    <div class="space-y-4 md:space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
        <div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border-l-[10px] md:border-l-[12px] border-yellow-400 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-2">
            <p class="text-[11px] font-black text-gray-400 uppercase">Hospital</p>
            <span class="text-[10px] font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Horas</span>
          </div>
          <h2 id="hrs-hosp" class="text-3xl md:text-4xl font-black text-gray-800 tracking-tighter">0.0 HRS</h2>
          <div class="mt-2 text-[10px] text-gray-500 font-bold" id="hosp-days">0 d√≠as</div>
        </div>
        <div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border-l-[10px] md:border-l-[12px] border-purple-400 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-2">
            <p class="text-[11px] font-black text-gray-400 uppercase">CENA</p>
            <span class="text-[10px] font-bold bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Independiente</span>
          </div>
          <h2 id="hrs-sena" class="text-3xl md:text-4xl font-black text-gray-800 tracking-tighter">0.0 HRS</h2>
          <div class="mt-2 text-[10px] text-gray-500 font-bold" id="sena-days">0 d√≠as</div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 md:p-8 rounded-3xl md:rounded-[40px] text-white text-center shadow-xl">
        <p class="text-xs font-black uppercase opacity-90 mb-2">D√≠as de Descanso</p>
        <h2 id="total-off" class="text-5xl md:text-6xl font-black mb-3 md:mb-2">0</h2>
        <div class="grid grid-cols-4 gap-2 text-[10px] font-bold">
          <div class="bg-white/20 p-2 rounded-xl"><div>Libres</div><div id="free-days" class="text-base md:text-lg font-black">0</div></div>
          <div class="bg-white/20 p-2 rounded-xl"><div>Vacaciones</div><div id="vac-days" class="text-base md:text-lg font-black">0</div></div>
          <div class="bg-white/20 p-2 rounded-xl"><div>Fines</div><div id="weekend-days" class="text-base md:text-lg font-black">0</div></div>
          <div class="bg-white/20 p-2 rounded-xl"><div>Asuetos Trab.</div><div id="holiday-worked" class="text-base md:text-lg font-black">0</div></div>
        </div>
      </div>

      <div class="bg-white p-4 md:p-5 rounded-3xl shadow-sm">
        <h3 class="text-[12px] font-black text-gray-600 uppercase mb-3 md:mb-4">üìà Resumen del Mes</h3>
        <div class="space-y-2 md:space-y-3">
          <div class="flex justify-between items-center"><span class="text-[11px] font-bold text-gray-500">D√≠as trabajados:</span><span id="worked-days" class="font-black text-gray-800">0</span></div>
          <div class="flex justify-between items-center"><span class="text-[11px] font-bold text-gray-500">Promedio diario:</span><span id="avg-hours" class="font-black text-gray-800">0.0h</span></div>
          <div class="flex justify-between items-center"><span class="text-[11px] font-bold text-gray-500">Total d√≠as mes:</span><span id="total-days" class="font-black text-gray-800">30</span></div>
          <div class="flex justify-between items-center"><span class="text-[11px] font-bold text-gray-500">Asuetos en mes:</span><span id="total-holidays" class="font-black text-red-600">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista Ajustes -->
  <div id="view-settings" class="view-section bg-white min-h-screen">
    <div class="flex bg-gray-50 border-b">
      <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active">üé® Turnos</button>
      <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab">‚ûï Nuevo</button>
      <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab">üè∑Ô∏è Categor√≠as</button>
      <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab">üéâ Asuetos</button>
      <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab">üîí Seguridad</button>
    </div>

    <div id="config-content" class="p-4 md:p-6">
      <div id="tab-turnos" class="config-tab-content">
        <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üé® Configurar Turnos Existentes</h3>
        <div id="settings-container" class="space-y-3 md:space-y-4 mb-6"></div>
      </div>

      <div id="tab-nuevo" class="config-tab-content hidden">
        <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">‚ûï Agregar Nuevo Turno</h3>
        <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 md:p-5 rounded-3xl border border-amber-100 mb-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-3">
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Turno</label>
              <input type="text" id="newShiftName" placeholder="Ej: Noche, Especial, etc." class="w-full bg-white border-amber-200 focus:border-amber-400">
            </div>
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Categor√≠a</label>
              <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
            </div>
          </div>

          <div class="mb-4">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Color del Turno</label>
            <div class="grid grid-cols-6 gap-2 p-3 bg-white rounded-xl">
              <div class="color-option bg-Ma√±ana" onclick="selectColor('Ma√±ana', event)" title="Amarillo"></div>
              <div class="color-option bg-Tarde" onclick="selectColor('Tarde', event)" title="Rosa"></div>
              <div class="color-option bg-CENA" onclick="selectColor('CENA', event)" title="Morado"></div>
              <div class="color-option bg-16hrs" onclick="selectColor('16hrs', event)" title="Verde Lima"></div>
              <div class="color-option bg-Vacaciones" onclick="selectColor('Vacaciones', event)" title="Naranja"></div>
              <div class="color-option bg-L" onclick="selectColor('L', event)" title="Blanco"></div>
              <div class="color-option bg-azul" onclick="selectColor('azul', event)" title="Azul"></div>
              <div class="color-option bg-rojo" onclick="selectColor('rojo', event)" title="Rojo"></div>
              <div class="color-option bg-verde" onclick="selectColor('verde', event)" title="Verde"></div>
              <div class="color-option bg-naranja" onclick="selectColor('naranja', event)" title="Naranja Oscuro"></div>
              <div class="color-option bg-rosa" onclick="selectColor('rosa', event)" title="Rosa Fuerte"></div>
              <div class="color-option bg-cian" onclick="selectColor('cian', event)" title="Cian"></div>
              <div class="color-option bg-morado" onclick="selectColor('morado', event)" title="Morado"></div>
              <div class="color-option bg-lima" onclick="selectColor('lima', event)" title="Lima"></div>
              <div class="color-option bg-ambar" onclick="selectColor('ambar', event)" title="√Åmbar"></div>
              <div class="color-option bg-teal" onclick="selectColor('teal', event)" title="Teal"></div>
              <div class="color-option bg-indigo" onclick="selectColor('indigo', event)" title="Indigo"></div>
              <div class="color-option bg-gris" onclick="selectColor('gris', event)" title="Gris"></div>
            </div>
            <input type="hidden" id="newShiftColor" value="Ma√±ana">
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Entrada</label>
              <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400">
            </div>
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Salida</label>
              <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400">
            </div>
          </div>
          <button onclick="addNewShift()" class="w-full p-3 md:p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600 transition-all">
            ‚ûï Agregar Turno
          </button>
        </div>
      </div>

      <div id="tab-categorias" class="config-tab-content hidden">
        <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üè∑Ô∏è Gestionar Categor√≠as</h3>

        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 md:p-5 rounded-3xl border border-green-100 mb-6">
          <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva Categor√≠a</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre de Categor√≠a</label>
              <input type="text" id="newCategoryName" placeholder="Ej: Guardia, Emergencia, etc." class="w-full bg-white border-green-200 focus:border-green-400">
            </div>
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Icono</label>
              <select id="newCategoryIcon" class="w-full bg-white border-green-200 focus:border-green-400">
                <option value="üè•">üè• Hospital</option>
                <option value="üåô">üåô CENA</option>
                <option value="üò¥">üò¥ Libre/Vacaciones</option>
                <option value="üìã">üìã Administrativo</option>
                <option value="üõ°Ô∏è">üõ°Ô∏è Guardia</option>
                <option value="‚≠ê">‚≠ê Extra</option>
                <option value="üîß">üîß Otro</option>
                <option value="üöë">üöë Emergencia</option>
                <option value="üíä">üíä Farmacia</option>
                <option value="ü©∫">ü©∫ Consulta</option>
                <option value="üè®">üè® Hospitalizaci√≥n</option>
              </select>
            </div>
          </div>
          <button onclick="addNewCategory()" class="w-full p-3 md:p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600 transition-all">
            ‚ûï Agregar Categor√≠a
          </button>
        </div>

        <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
          <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Categor√≠as Existentes</h4>
          <div id="categories-container" class="max-h-[300px] overflow-y-auto"></div>
        </div>
      </div>

      <div id="tab-asuetos" class="config-tab-content hidden">
        <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üéâ Gestionar Asuetos</h3>

        <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 md:p-5 rounded-3xl border border-pink-100 mb-6">
          <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nuevo Asueto</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Fecha</label>
              <input type="date" id="newHolidayDate" class="w-full bg-white border-pink-200 focus:border-pink-400">
            </div>
            <div class="md:col-span-2">
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Asueto</label>
              <input type="text" id="newHolidayName" placeholder="Ej: D√≠a de la Independencia" class="w-full bg-white border-pink-200 focus:border-pink-400">
            </div>
          </div>
          <div class="mb-3">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad (opcional)</label>
            <input type="text" id="newHolidayLocation" placeholder="Ej: General, San Salvador, etc." class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
          <button onclick="addNewHoliday()" class="w-full p-3 md:p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600 transition-all">
            ‚ûï Agregar Asueto
          </button>
        </div>

        <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
          <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Asuetos Programados</h4>
          <div id="holidays-container" class="max-h-[300px] overflow-y-auto"></div>
        </div>
      </div>

      <div id="tab-seguridad" class="config-tab-content hidden">
        <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üîí Seguridad</h3>
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 md:p-5 rounded-3xl border border-blue-100 mb-6 md:mb-8">
          <div class="space-y-3 md:space-y-4">
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Cambiar PIN (4 d√≠gitos)</label>
              <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
            </div>
            <div>
              <label class="text-[11px] font-bold text-gray-600 block mb-2">Confirmar PIN</label>
              <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
            </div>
          </div>
        </div>
        <button onclick="saveProfileSettings()" class="w-full mt-6 md:mt-8 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 md:p-5 rounded-3xl font-black uppercase shadow-xl shadow-blue-200 hover:shadow-2xl transition-all">
          üíæ Guardar Cambios
        </button>
      </div>
    </div>

    <div id="settings-locked" class="p-8 text-center hidden">
      <div class="w-20 h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
        <span class="text-3xl">üîí</span>
      </div>
      <h3 class="text-lg font-black text-gray-600 mb-2">Configuraci√≥n Bloqueada</h3>
      <p class="text-sm text-gray-500 mb-6">Activa el modo edici√≥n para acceder a la configuraci√≥n</p>
      <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold">üîì Activar Edici√≥n</button>
    </div>
  </div>

  <!-- Modal para editar d√≠a -->
  <div id="modal" class="modal">
    <div class="bg-white w-full max-w-md rounded-[40px] overflow-hidden shadow-2xl border border-gray-100">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-5 font-black text-sm uppercase tracking-widest">
        <div>üìÖ Configurar D√≠a</div>
        <div id="modalDate" class="text-[10px] font-normal opacity-90 mt-1"></div>
      </div>
      <div class="p-6 overflow-y-auto max-h-[80vh]">
        <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-6">
          <button onclick="setMode('simple')" id="m-s" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Simple</button>
          <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Mixto</button>
        </div>

        <div id="sec-simple" class="grid grid-cols-3 gap-2 mb-6"></div>
        <div id="sec-mixto" class="hidden space-y-4 mb-6">
          <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Superior</p>
            <div id="mix-t" class="grid grid-cols-3 gap-2"></div>
          </div>
          <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Inferior</p>
            <div id="mix-b" class="grid grid-cols-3 gap-2"></div>
          </div>
        </div>

        <!-- Horario para modo SIMPLE -->
        <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100 mb-6">
          <div class="flex items-center justify-between">
            <span class="text-[11px] font-black uppercase text-blue-900">‚è∞ Horario:</span>
            <div class="flex items-center gap-2">
              <input type="time" id="tIn" onchange="autoCalc(); maybeAutoNoteSimple();" class="bg-white border-blue-200 focus:border-blue-400">
              <span class="font-black text-blue-300">‚Üí</span>
              <input type="time" id="tOut" onchange="autoCalc(); maybeAutoNoteSimple();" class="bg-white border-blue-200 focus:border-blue-400">
            </div>
          </div>
          <div class="flex items-center justify-between border-t border-blue-200 pt-3">
            <span class="text-[11px] font-black uppercase text-blue-900">üìä Total Horas:</span>
            <input type="number" id="tHrs" onchange="manualCalc()" class="w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
          </div>
        </div>

        <!-- Horarios para modo MIXTO -->
        <div id="time-mixto" class="hidden space-y-4 mb-6">
          <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100">
            <p class="text-[11px] font-black uppercase text-blue-900 text-center">‚è∞ Horario Superior</p>
            <div class="flex items-center gap-2 justify-center">
              <input type="time" id="tInTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-32 bg-white border-blue-200 focus:border-blue-400">
              <span class="font-black text-blue-300">‚Üí</span>
              <input type="time" id="tOutTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-32 bg-white border-blue-200 focus:border-blue-400">
            </div>
            <div class="flex items-center justify-between border-t border-blue-200 pt-3">
              <span class="text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
              <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
            </div>
          </div>
          <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-5 rounded-[24px] space-y-4 border border-purple-100">
            <p class="text-[11px] font-black uppercase text-purple-900 text-center">‚è∞ Horario Inferior</p>
            <div class="flex items-center gap-2 justify-center">
              <input type="time" id="tInBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-32 bg-white border-purple-200 focus:border-purple-400">
              <span class="font-black text-purple-300">‚Üí</span>
              <input type="time" id="tOutBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-32 bg-white border-purple-200 focus:border-purple-400">
            </div>
            <div class="flex items-center justify-between border-t border-purple-200 pt-3">
              <span class="text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
              <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200" step="0.5">
            </div>
          </div>
          <div class="flex items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-[20px] border border-emerald-100">
            <span class="text-[11px] font-black uppercase text-emerald-900">üìä Total Horas:</span>
            <input type="number" id="tHrsMixto" class="w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200" step="0.5" readonly>
          </div>
        </div>

        <div class="mt-6">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-2 ml-2">üìù Comentario</p>
          <textarea id="nota" placeholder="Ej: Cita m√©dica, Doble turno, Guardia extra..." class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          <p class="text-[10px] text-gray-500 mt-2 font-bold text-center">
            Tip: si el comentario est√° vac√≠o, el sistema puede sugerir el horario del turno.
          </p>
        </div>

        <div class="flex gap-4 mt-8">
          <button onclick="closeModal()" class="flex-1 p-5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-600 rounded-3xl font-black text-[11px] uppercase hover:from-gray-200 hover:to-gray-300 transition-all">‚ùå Cancelar</button>
          <button onclick="save()" class="flex-1 p-5 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-3xl font-black text-[11px] uppercase shadow-lg shadow-emerald-100 hover:shadow-xl hover:from-emerald-600 hover:to-green-600 transition-all">‚úÖ Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para crear usuario -->
  <div id="userModal" class="modal">
    <div class="bg-white w-full max-w-xs rounded-[40px] p-8 shadow-2xl">
      <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
        <span class="text-white text-2xl font-black">+</span>
      </div>
      <h3 class="font-black text-center uppercase text-lg mb-6">Nuevo Perfil</h3>
      <input type="text" id="newUserName" placeholder="Nombre completo" class="mb-3 bg-gray-50 border-gray-200 focus:border-blue-400">
      <input type="password" id="newUserPin" placeholder="PIN (4 d√≠gitos)" maxlength="4" class="mb-6 bg-gray-50 border-gray-200 focus:border-blue-400">
      <button onclick="createNewUser()" class="w-full p-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-xs hover:from-blue-700 hover:to-indigo-700 transition-all">üë§ Crear Perfil</button>
      <button onclick="closeUserModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600 transition-colors">Cerrar</button>
    </div>
  </div>

  <!-- Modal para exportar -->
  <div id="exportModal" class="modal">
    <div class="bg-white w-full max-w-md rounded-[40px] p-8 shadow-2xl">
      <div class="w-16 h-16 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 mx-auto mb-4 flex items-center justify-center">
        <span class="text-white text-2xl font-black">üìã</span>
      </div>
      <h3 class="font-black text-center uppercase text-lg mb-6">Exportar Mes</h3>

      <div class="space-y-4 mb-6">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes a exportar</label>
          <div class="flex gap-3">
            <select id="exportMonth" class="flex-1 bg-gray-50 border-gray-200 focus:border-emerald-400">
              <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
              <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
              <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
            </select>
            <select id="exportYear" class="flex-1 bg-gray-50 border-gray-200 focus:border-emerald-400">
              <option value="2023">2023</option><option value="2024">2024</option><option value="2025">2025</option>
              <option value="2026" selected>2026</option><option value="2027">2027</option>
            </select>
          </div>
        </div>

        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Formato de exportaci√≥n</label>
          <div class="grid grid-cols-1 gap-3">
            <button onclick="exportMonthAsImage()" class="p-4 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl font-bold text-[11px] transition-colors flex items-center justify-center gap-2">
              üñºÔ∏è Capturar como Imagen
            </button>
          </div>
          <p class="text-[10px] text-gray-500 mt-2 text-center">Incluye calendario y resumen del mes</p>
        </div>
      </div>

      <button onclick="closeExportModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600 transition-colors">Cancelar</button>
    </div>
  </div>

  <!-- Modal Importar -->
  <div id="importModal" class="modal">
    <div class="bg-white w-full max-w-lg rounded-[40px] p-8 shadow-2xl">
      <div class="w-16 h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
        <span class="text-white text-2xl font-black">üì•</span>
      </div>
      <h3 class="font-black text-center uppercase text-lg mb-2">Importar Calendario del Hospital</h3>
      <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
        Adjunta el Excel (.xlsx). Se crear√°n perfiles y se cargar√° el mes autom√°ticamente.
      </p>

      <div class="space-y-4">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Archivo Excel</label>
          <input type="file" id="importFile" accept=".xlsx,.xls" class="w-full bg-gray-50 border-gray-200">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes (si el Excel no lo detecta)</label>
            <select id="importMonth" class="w-full bg-gray-50 border-gray-200">
              <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
              <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
              <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
            </select>
          </div>
          <div>
            <label class="text-[12px] font-bold text-gray-600 block mb-2">A√±o (si el Excel no lo detecta)</label>
            <select id="importYear" class="w-full bg-gray-50 border-gray-200">
              <option value="2023">2023</option><option value="2024">2024</option><option value="2025">2025</option>
              <option value="2026" selected>2026</option><option value="2027">2027</option>
            </select>
          </div>
        </div>

        <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
          <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Modo de Importaci√≥n</p>
          <div class="flex gap-3">
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="importMode" value="replace" checked>
              <span class="text-[11px] font-bold text-gray-700">Reemplazar mes (borra lo existente)</span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="importMode" value="merge">
              <span class="text-[11px] font-bold text-gray-700">Combinar (solo llena d√≠as vac√≠os)</span>
            </label>
          </div>
        </div>

        <div id="importInfo" class="text-[11px] font-bold text-gray-600 text-center"></div>

        <button onclick="runImport()" class="w-full p-4 bg-gradient-to-r from-sky-600 to-indigo-600 text-white rounded-3xl font-black uppercase shadow-xl hover:from-sky-700 hover:to-indigo-700 transition-all">
          üöÄ Importar
        </button>

        <button onclick="closeImportModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600 transition-colors">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // DB
    // =========================
    let db = JSON.parse(localStorage.getItem('shifter_v18')) || {
      users: {
        'ADMIN': {
          pin: '1234',
          data: {},
          config: {
            'Ma√±ana': { label: 'Ma√±ana', color: 'Ma√±ana', cat: 'hosp', in: '06:00', out: '14:00' },
            'Tarde': { label: 'Tarde', color: 'Tarde', cat: 'hosp', in: '14:00', out: '22:00' },
            '16hrs': { label: '16hrs', color: '16hrs', cat: 'hosp', in: '06:00', out: '22:00' },
            'CENA': { label: 'CENA', color: 'CENA', cat: 'sena', in: '05:00', out: '17:00' },
            'L': { label: 'L', color: 'L', cat: 'off', in: '00:00', out: '00:00' },
            'Vacaciones': { label: 'Vacaciones', color: 'Vacaciones', cat: 'off', in: '00:00', out: '00:00' }
          },
          editLocked: false
        }
      },
      current: 'ADMIN',
      holidays: {},
      categories: {
        'hosp': { name: 'Hospital', icon: 'üè•' },
        'sena': { name: 'CENA', icon: 'üåô' },
        'off': { name: 'Libre/Vacaciones', icon: 'üò¥' },
        'admin': { name: 'Administrativo', icon: 'üìã' },
        'guardia': { name: 'Guardia', icon: 'üõ°Ô∏è' },
        'extra': { name: 'Extra', icon: '‚≠ê' },
        'otro': { name: 'Otro', icon: 'üîß' }
      }
    };

    // =========================
    // Globals
    // =========================
    let current = new Date();
    let activeKey = "";
    let mode = "simple";
    let selS = "Ma√±ana";
    let selT = "Ma√±ana";
    let selB = "Tarde";
    let selectedColor = "Ma√±ana";

    // =========================
    // IMPORT: mapeos solicitados
    // =========================
    const IMPORT_ABSENCE_MAP = {
      'C': { key: 'CAPACITACION', label: 'Capacitaci√≥n', color: 'azul', cat: 'admin', in: '00:00', out: '00:00', note: 'CAPACITACI√ìN' },
      'I': { key: 'INCAPACIDAD', label: 'Incapacidad', color: 'rojo', cat: 'off', in: '00:00', out: '00:00', note: 'INCAPACIDAD' },
      'V': { key: 'Vacaciones', label: 'Vacaciones', color: 'Vacaciones', cat: 'off', in: '00:00', out: '00:00', note: 'VACACIONES' },
      'L': { key: 'L', label: 'L', color: 'L', cat: 'off', in: '00:00', out: '00:00', note: 'LIBRE' },
      'PS': { key: 'PERMISO_SINDICAL', label: 'Permiso Sindical', color: 'morado', cat: 'admin', in: '00:00', out: '00:00', note: 'PERMISO SINDICAL' },
      'F': { key: 'AUS_INJUST', label: 'Aus. Injust.', color: 'gris', cat: 'off', in: '00:00', out: '00:00', note: 'AUSENCIA INJUSTIFICADA' }
    };

    const IMPORT_SHIFT_CODE_MAP = {
      '018': { key: '018', label: '018', color: 'Ma√±ana', cat: 'hosp', in: '06:00', out: '14:00', note: '06:00-14:00' },
      '18':  { key: '018', label: '018', color: 'Ma√±ana', cat: 'hosp', in: '06:00', out: '14:00', note: '06:00-14:00' },
      '468': { key: '468', label: '468', color: 'Tarde',  cat: 'hosp', in: '14:00', out: '22:00', note: '14:00-22:00' },
      '650': { key: '650', label: '650', color: '16hrs',  cat: 'hosp', in: '06:00', out: '22:00', note: '06:00-22:00' }
    };

    function normalizeCode(v) {
      if (v === null || v === undefined) return '';
      let s = String(v).trim();
      if (!s) return '';
      // Normaliza espacios y uppercase para letras
      s = s.replace(/\s+/g, ' ').toUpperCase();
      // Excel puede traer 018 como 18 o como n√∫mero
      if (/^\d+$/.test(s)) {
        // preservar con 3 d√≠gitos si era tipo 018 habitual
        if (s.length === 1) return s;
        if (s.length === 2) return s;
        if (s.length === 3) return s;
        return s; // otros
      }
      return s;
    }

    // =========================
    // Edit mode helpers
    // =========================
    function isEditMode() {
      const user = db.users[db.current];
      return !user.editLocked;
    }

    function setEditMode(locked) {
      const user = db.users[db.current];
      user.editLocked = locked;
      localStorage.setItem('shifter_v18', JSON.stringify(db));
      updateUIEditMode();
    }

    // =========================
    // Init
    // =========================
    function init() {
      initDateSelectors();
      updateUserDropdown();
      updateUserInitial();
      updateMonthDisplay();
      loadDefaultHolidays();
      loadDefaultCategories();
      ensureImportBaseShiftsForAllUsers();
      render();
      updateUIEditMode();
    }

    function ensureImportBaseShiftsForAllUsers() {
      Object.keys(db.users).forEach(u => ensureImportBaseShiftsForUser(u));
      localStorage.setItem('shifter_v18', JSON.stringify(db));
    }

    function ensureImportBaseShiftsForUser(userKey) {
      const user = db.users[userKey];
      if (!user || !user.config) return;

      // Asegurar ausencias (C/I/PS/F) como turnos editables
      Object.keys(IMPORT_ABSENCE_MAP).forEach(k => {
        const def = IMPORT_ABSENCE_MAP[k];
        if (!user.config[def.key]) {
          user.config[def.key] = { label: def.label, color: def.color, cat: def.cat, in: def.in, out: def.out };
        }
      });

      // Asegurar turnos num√©ricos conocidos
      Object.keys(IMPORT_SHIFT_CODE_MAP).forEach(k => {
        const def = IMPORT_SHIFT_CODE_MAP[k];
        if (!user.config[def.key]) {
          user.config[def.key] = { label: def.label, color: def.color, cat: def.cat, in: def.in, out: def.out };
        }
      });
    }

    function loadDefaultHolidays() {
      const defaultHolidays = {
        '2024-1-1': { name: 'A√±o Nuevo', location: 'General' },
        '2024-3-28': { name: 'Jueves Santo', location: 'General' },
        '2024-3-29': { name: 'Viernes Santo', location: 'General' },
        '2024-5-1': { name: 'D√≠a del Trabajo', location: 'General' },
        '2024-8-6': { name: 'Fiestas Agostinas', location: 'General' },
        '2024-9-15': { name: 'D√≠a de la Independencia', location: 'General' },
        '2024-11-2': { name: 'D√≠a de los Difuntos', location: 'General' },
        '2024-12-25': { name: 'Navidad', location: 'General' },

        '2025-1-1': { name: 'A√±o Nuevo', location: 'General' },
        '2025-4-17': { name: 'Jueves Santo', location: 'General' },
        '2025-4-18': { name: 'Viernes Santo', location: 'General' },
        '2025-5-1': { name: 'D√≠a del Trabajo', location: 'General' },
        '2025-8-6': { name: 'Fiestas Agostinas', location: 'General' },
        '2025-9-15': { name: 'D√≠a de la Independencia', location: 'General' },
        '2025-11-2': { name: 'D√≠a de los Difuntos', location: 'General' },
        '2025-12-25': { name: 'Navidad', location: 'General' },

        '2026-1-1': { name: 'A√±o Nuevo', location: 'General' },
        '2026-4-1': { name: 'Mi√©rcoles Santo', location: 'General' },
        '2026-4-2': { name: 'Jueves Santo', location: 'General' },
        '2026-4-3': { name: 'Viernes Santo', location: 'General' },
        '2026-4-4': { name: 'S√°bado de Gloria', location: 'General' },
        '2026-5-1': { name: 'D√≠a del Trabajo', location: 'General' },
        '2026-8-6': { name: 'D√≠a de El Salvador', location: 'General' },
        '2026-9-15': { name: 'Aniversario de Independencia', location: 'General' },
        '2026-11-2': { name: 'D√≠a de los Difuntos', location: 'General' },
        '2026-12-25': { name: 'Navidad', location: 'General' },

        '2027-1-1': { name: 'A√±o Nuevo', location: 'General' },
        '2027-5-1': { name: 'D√≠a del Trabajo', location: 'General' },
        '2027-8-6': { name: 'Fiestas Agostinas', location: 'General' },
        '2027-9-15': { name: 'D√≠a de la Independencia', location: 'General' },
        '2027-11-2': { name: 'D√≠a de los Difuntos', location: 'General' },
        '2027-12-25': { name: 'Navidad', location: 'General' }
      };

      for (const [key, value] of Object.entries(defaultHolidays)) {
        if (!db.holidays[key]) db.holidays[key] = value;
      }
    }

    function loadDefaultCategories() {
      const defaultCategories = {
        'hosp': { name: 'Hospital', icon: 'üè•' },
        'sena': { name: 'CENA', icon: 'üåô' },
        'off': { name: 'Libre/Vacaciones', icon: 'üò¥' },
        'admin': { name: 'Administrativo', icon: 'üìã' },
        'guardia': { name: 'Guardia', icon: 'üõ°Ô∏è' },
        'extra': { name: 'Extra', icon: '‚≠ê' },
        'otro': { name: 'Otro', icon: 'üîß' }
      };
      db.categories = { ...defaultCategories, ...db.categories };
    }

    function initDateSelectors() {
      const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      const mSel = document.getElementById('selectMonth');
      const ySel = document.getElementById('selectYear');

      mSel.innerHTML = '';
      months.forEach((m, i) => mSel.innerHTML += `<option value="${i}">${m}</option>`);

      ySel.innerHTML = '';
      for(let y = 2023; y <= 2027; y++) ySel.innerHTML += `<option value="${y}">${y}</option>`;
    }

    function updateMonthDisplay() {
      const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      const monthName = months[current.getMonth()];
      const year = current.getFullYear();

      document.getElementById('currentMonthDisplay').textContent = `${monthName} ${year}`;
      document.getElementById('selectMonth').value = current.getMonth();
      document.getElementById('selectYear').value = current.getFullYear();
    }

    function goToday() {
      current = new Date();
      updateMonthDisplay();
      render();
    }

    function showExportModal() {
      document.getElementById('exportMonth').value = current.getMonth();
      document.getElementById('exportYear').value = current.getFullYear();
      document.getElementById('exportModal').classList.add('active');
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('active');
    }

    function openImportModal() {
      document.getElementById('importMonth').value = current.getMonth();
      document.getElementById('importYear').value = current.getFullYear();
      document.getElementById('importFile').value = '';
      document.getElementById('importInfo').innerText = '';
      document.getElementById('importModal').classList.add('active');
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('active');
    }

    function selectColor(color, ev) {
      selectedColor = color;
      document.getElementById('newShiftColor').value = color;

      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      if (ev && ev.target) ev.target.classList.add('selected');
    }

    function showConfigTab(tab) {
      document.querySelectorAll('.config-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(`config-${tab}`).classList.add('active');

      document.querySelectorAll('.config-tab-content').forEach(content => content.classList.add('hidden'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');

      if(tab === 'asuetos') renderHolidays();
      else if(tab === 'categorias') renderCategories();
      else if(tab === 'nuevo') loadCategoriesSelect();
      else if(tab === 'turnos') renderSettings();
    }

    function updateUIEditMode() {
      const configContent = document.getElementById('config-content');
      const lockedMessage = document.getElementById('settings-locked');

      if(isEditMode()) {
        configContent.classList.remove('hidden');
        lockedMessage.classList.add('hidden');
        document.getElementById('editStatus').innerText = "MODO EDICI√ìN ACTIVADO";
        document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-emerald-400";
        document.getElementById('unlockBtn').innerText = "üîí Bloquear";
        document.getElementById('unlockBtn').className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
      } else {
        configContent.classList.add('hidden');
        lockedMessage.classList.remove('hidden');
        document.getElementById('editStatus').innerText = "MODO VISTA";
        document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-gray-400";
        document.getElementById('unlockBtn').innerText = "üîì Editar";
        document.getElementById('unlockBtn').className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
      }
    }

    function toggleEditMode() {
      if(isEditMode()) {
        const p = prompt("Ingresa tu PIN para bloquear la edici√≥n:");
        const user = db.users[db.current];
        if(p === user.pin) {
          setEditMode(true);
          alert("Modo edici√≥n bloqueado");
        } else {
          alert("PIN incorrecto");
          return;
        }
      } else {
        const p = prompt("Ingresa tu PIN para editar:");
        const user = db.users[db.current];
        const adminUniversalPin = '120720';
        if(p === user.pin || p === adminUniversalPin) {
          setEditMode(false);
          alert("Modo edici√≥n activado");
        } else {
          alert("PIN incorrecto");
          return;
        }
      }
      updateUIEditMode();
    }

    // =========================
    // Export (sin cambios funcionales)
    // =========================
    async function exportMonthAsImage() {
      try {
        closeExportModal();

        const month = parseInt(document.getElementById('exportMonth').value);
        const year = parseInt(document.getElementById('exportYear').value);
        const user = db.users[db.current];
        const SHIFTS = user.config;

        let h = 0, s = 0, freeDays = 0, vacDays = 0, weekendDays = 0, holidayWorked = 0;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        freeDays = daysInMonth;

        let totalHolidays = 0;
        Object.keys(db.holidays).forEach(dateKey => {
          if(dateKey.startsWith(`${year}-${month+1}-`)) totalHolidays++;
        });

        Object.keys(user.data).forEach(k => {
          if(k.startsWith(`${year}-${month+1}-`)) {
            const d = user.data[k];
            const dayOfWeek = new Date(year, month, parseInt(k.split('-')[2])).getDay();
            const isHoliday = db.holidays[k];

            if(dayOfWeek === 0 || dayOfWeek === 6) weekendDays++;
            freeDays--;

            if(d.mode === 'mixto') {
              if(isHoliday) holidayWorked++;
              if(SHIFTS[d.t]?.cat === 'hosp') h += (d.hrsTop || calculateHours(d.tInTop || SHIFTS[d.t].in, d.tOutTop || SHIFTS[d.t].out));
              if(SHIFTS[d.t]?.cat === 'sena') s += (d.hrsTop || calculateHours(d.tInTop || SHIFTS[d.t].in, d.tOutTop || SHIFTS[d.t].out));
              if(SHIFTS[d.b]?.cat === 'hosp') h += (d.hrsBottom || calculateHours(d.tInBottom || SHIFTS[d.b].in, d.tOutBottom || SHIFTS[d.b].out));
              if(SHIFTS[d.b]?.cat === 'sena') s += (d.hrsBottom || calculateHours(d.tInBottom || SHIFTS[d.b].in, d.tOutBottom || SHIFTS[d.b].out));
            } else {
              if(SHIFTS[d.s]?.cat === 'hosp') h += (d.h || 0);
              else if(SHIFTS[d.s]?.cat === 'sena') s += (d.h || 0);
              else if(SHIFTS[d.s]?.cat === 'off') {
                freeDays++;
                if(d.s === 'Vacaciones') vacDays++;
              }
              if((SHIFTS[d.s]?.cat === 'hosp' || SHIFTS[d.s]?.cat === 'sena') && isHoliday) holidayWorked++;
            }
          }
        });

        freeDays = Math.max(0, freeDays);

        const tempContainer = document.createElement('div');
        tempContainer.style.position = 'fixed';
        tempContainer.style.left = '-9999px';
        tempContainer.style.top = '-9999px';
        tempContainer.style.width = '800px';
        tempContainer.style.backgroundColor = 'white';
        tempContainer.style.padding = '25px';
        tempContainer.style.borderRadius = '20px';
        tempContainer.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';

        const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        let html = `
          <div style="font-family: system-ui, -apple-system, sans-serif;">
            <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
              <h1 style="font-size: 32px; font-weight: 900; color: #1e293b; margin-bottom: 5px;">
                ${db.current} - ${months[month]} ${year}
              </h1>
              <p style="font-size: 14px; color: #64748b; font-weight: 600;">
                Generado el ${new Date().toLocaleDateString('es-ES')}
              </p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; background: linear-gradient(to right, #f0f9ff, #fefce8); padding: 20px; border-radius: 15px;">
              <div style="text-align: center;">
                <div style="font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px;">üè• HOSPITAL</div>
                <div style="font-size: 24px; font-weight: 900; color: #1e293b;">${h.toFixed(1)} HRS</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px;">üåô CENA</div>
                <div style="font-size: 24px; font-weight: 900; color: #1e293b;">${s.toFixed(1)} HRS</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px;">üò¥ DESCANSO</div>
                <div style="font-size: 24px; font-weight: 900; color: #1e293b;">${freeDays + vacDays + weekendDays} D√çAS</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px;">üéâ ASUETOS TRAB.</div>
                <div style="font-size: 24px; font-weight: 900; color: #dc2626;">${holidayWorked}</div>
              </div>
            </div>

            <div style="margin-bottom: 25px;">
              <h3 style="font-size: 16px; font-weight: 800; color: #374151; margin-bottom: 15px; text-align: center;">CALENDARIO DE TURNOS</h3>
              <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background-color: #e5e7eb; border: 1px solid #e5e7eb;">
        `;

        const daysOfWeek = ['LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB', 'DOM'];
        daysOfWeek.forEach(day => {
          const color = day === 'DOM' ? '#ef4444' : (day === 'S√ÅB' ? '#3b82f6' : '#64748b');
          html += `<div style="background-color: #f8fafc; padding: 12px; text-align: center; font-weight: 900; font-size: 12px; color: ${color};">${day}</div>`;
        });

        const firstDay = new Date(year, month, 1).getDay();
        const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
        const lastDate = new Date(year, month + 1, 0).getDate();
        const prevLastDate = new Date(year, month, 0).getDate();

        for(let i = firstDayMonday; i > 0; i--) {
          const prevDay = prevLastDate - i + 1;
          const prevMonth = month === 0 ? 12 : month;
          const prevYear = month === 0 ? year - 1 : year;
          const dateKey = `${prevYear}-${prevMonth}-${prevDay}`;
          const isHoliday = db.holidays[dateKey];
          html += `
            <div style="background-color: #f9fafb; height: 90px; position: relative; opacity: 0.3;">
              <span style="position: absolute; top: 0; right: 0; font-size: 11px; font-weight: 800; padding: 2px 6px; color: #374151; background: rgba(255,255,255,0.9); border-bottom-left-radius: 8px;">${prevDay}</span>
              ${isHoliday ? `<span style="position: absolute; top: 0; left: 0; font-size: 8px; font-weight: 900; color: #dc2626; background: rgba(254, 226, 226, 0.9); padding: 1px 4px; border-bottom-right-radius: 8px;">A</span>` : ``}
            </div>
          `;
        }

        for(let d = 1; d <= lastDate; d++) {
          const key = `${year}-${month+1}-${d}`;
          const info = user.data[key] || { mode: 'simple', s: 'L' };
          const isHoliday = db.holidays[key];

          if(info.mode === 'mixto') {
            const colorTop = SHIFTS[info.t]?.color || 'L';
            const colorBottom = SHIFTS[info.b]?.color || 'L';
            html += `
              <div style="height: 90px; position: relative;">
                <div style="height: 45%; background-color: ${getColorValue(colorTop)}; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 900; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">
                  ${SHIFTS[info.t]?.label || 'L'}
                </div>
                <div style="height: 45%; background-color: ${getColorValue(colorBottom)}; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 900; text-transform: uppercase;">
                  ${SHIFTS[info.b]?.label || 'L'}
                </div>
                <span style="position: absolute; top: 0; right: 0; font-size: 11px; font-weight: 800; padding: 2px 6px; color: #374151; background: rgba(255,255,255,0.9); border-bottom-left-radius: 8px;">${d}</span>
                ${isHoliday ? `<span style="position: absolute; top: 0; left: 0; font-size: 8px; font-weight: 900; color: #dc2626; background: rgba(254, 226, 226, 0.9); padding: 1px 4px; border-bottom-right-radius: 8px;">A</span>` : ``}
              </div>
            `;
          } else {
            let backgroundColor = '#ffffff';
            let label = 'L';
            if(info.s !== 'L') {
              const color = SHIFTS[info.s]?.color || 'L';
              backgroundColor = getColorValue(color);
              label = SHIFTS[info.s]?.label || 'L';
            }
            html += `
              <div style="background-color: ${backgroundColor}; height: 90px; position: relative;">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 11px; font-weight: 900; text-transform: uppercase;">
                  ${label}
                </div>
                <span style="position: absolute; top: 0; right: 0; font-size: 11px; font-weight: 800; padding: 2px 6px; color: #374151; background: rgba(255,255,255,0.9); border-bottom-left-radius: 8px;">${d}</span>
                ${isHoliday ? `<span style="position: absolute; top: 0; left: 0; font-size: 8px; font-weight: 900; color: #dc2626; background: rgba(254, 226, 226, 0.9); padding: 1px 4px; border-bottom-right-radius: 8px;">A</span>` : ``}
              </div>
            `;
          }
        }

        const total = firstDayMonday + lastDate;
        for(let i = 1; i <= (42 - total); i++) {
          const nextMonth = month === 11 ? 1 : month + 2;
          const nextYear = month === 11 ? year + 1 : year;
          const dateKey = `${nextYear}-${nextMonth}-${i}`;
          const isHoliday = db.holidays[dateKey];
          html += `
            <div style="background-color: #f9fafb; height: 90px; position: relative; opacity: 0.3;">
              <span style="position: absolute; top: 0; right: 0; font-size: 11px; font-weight: 800; padding: 2px 6px; color: #374151; background: rgba(255,255,255,0.9); border-bottom-left-radius: 8px;">${i}</span>
              ${isHoliday ? `<span style="position: absolute; top: 0; left: 0; font-size: 8px; font-weight: 900; color: #dc2626; background: rgba(254, 226, 226, 0.9); padding: 1px 4px; border-bottom-right-radius: 8px;">A</span>` : ``}
            </div>
          `;
        }

        html += `
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
              <div style="flex: 1;">
                <h4 style="font-size: 14px; font-weight: 800; color: #374151; margin-bottom: 10px;">LEYENDA</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
        `;

        Object.keys(SHIFTS).forEach(key => {
          const shift = SHIFTS[key];
          html += `
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 16px; height: 16px; border-radius: 4px; background-color: ${getColorValue(shift.color)}; border: 1px solid #d1d5db;"></div>
              <span style="font-size: 11px; font-weight: 700;">${shift.label}</span>
            </div>
          `;
        });

        html += `
                </div>
              </div>

              <div style="flex: 1; padding-left: 20px; border-left: 1px solid #e5e7eb;">
                <h4 style="font-size: 14px; font-weight: 800; color: #374151; margin-bottom: 10px;">DETALLES DEL MES</h4>
                <div style="font-size: 12px; color: #4b5563;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>D√≠as trabajados:</span><span style="font-weight: 700;">${Math.ceil((h + s) / 8)}</span></div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Horas totales:</span><span style="font-weight: 700;">${(h + s).toFixed(1)}</span></div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Asuetos en mes:</span><span style="font-weight: 700; color: #dc2626;">${totalHolidays}</span></div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Asuetos trabajados:</span><span style="font-weight: 700; color: #dc2626;">${holidayWorked}</span></div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Libres:</span><span style="font-weight: 700;">${freeDays}</span></div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Vacaciones:</span><span style="font-weight: 700;">${vacDays}</span></div>
                  <div style="display: flex; justify-content: space-between;"><span>D√≠as fin de semana:</span><span style="font-weight: 700;">${weekendDays}</span></div>
                </div>
              </div>
            </div>
          </div>
        `;

        tempContainer.innerHTML = html;
        document.body.appendChild(tempContainer);

        const canvas = await html2canvas(tempContainer, { scale: 2, backgroundColor: '#ffffff', useCORS: true, logging: false });

        const link = document.createElement('a');
        link.download = `Turnos_${db.current}_${months[month]}_${year}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        document.body.removeChild(tempContainer);
        alert('¬°Calendario exportado como imagen! Se ha guardado en tus descargas.');
      } catch (error) {
        console.error('Error al exportar imagen:', error);
        alert('Error al exportar. Intenta nuevamente.');
      }
    }

    function getColorValue(colorName) {
      const colorMap = {
        'Ma√±ana': '#ffff00',
        'Tarde': '#fbcfe8',
        'CENA': '#d8b4fe',
        '16hrs': '#bef264',
        'L': '#ffffff',
        'Vacaciones': '#fed7aa',
        'azul': '#93c5fd',
        'rojo': '#fca5a5',
        'verde': '#86efac',
        'naranja': '#fdba74',
        'rosa': '#f9a8d4',
        'cian': '#67e8f9',
        'morado': '#d8b4fe',
        'lima': '#d9f99d',
        'ambar': '#fcd34d',
        'teal': '#5eead4',
        'indigo': '#a5b4fc',
        'gris': '#d1d5db'
      };
      return colorMap[colorName] || '#ffffff';
    }

    // =========================
    // Render calendar
    // =========================
    function render() {
      const grid = document.getElementById('calendar');
      grid.innerHTML = '';
      const y = current.getFullYear(), m = current.getMonth();
      const today = new Date();
      const todayKey = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;

      const firstDay = new Date(y, m, 1).getDay();
      const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
      const lastDate = new Date(y, m + 1, 0).getDate();
      const prevLastDate = new Date(y, m, 0).getDate();

      const user = db.users[db.current];
      const SHIFTS = user.config;

      // Prev month days
      for(let i = firstDayMonday; i > 0; i--) {
        const prevDay = prevLastDate - i + 1;
        const prevMonth = m === 0 ? 12 : m;
        const prevYear = m === 0 ? y - 1 : y;
        const key = `${prevYear}-${prevMonth}-${prevDay}`;

        const cell = document.createElement('div');
        cell.className = 'day-cell day-off-month';

        const info = user.data[key];
        if(info) {
          if(info.mode === 'mixto') {
            cell.innerHTML = `
              <div class="shift-label bg-${SHIFTS[info.t]?.color || 'L'}">${SHIFTS[info.t]?.label || 'L'}</div>
              <div class="shift-label bg-${SHIFTS[info.b]?.color || 'L'}">${SHIFTS[info.b]?.label || 'L'}</div>`;
          } else {
            const label = info.s === 'L' ? 'L' : (SHIFTS[info.s]?.label || info.s || 'L');
            cell.innerHTML = `<div class="shift-label bg-${SHIFTS[info.s]?.color || 'L'}">${label}</div>`;
          }
        }

        const holidayData = db.holidays[key];
        if(holidayData) cell.innerHTML += `<div class="holiday-indicator">A</div>`;

        cell.innerHTML += `<span class="day-number">${prevDay}</span>`;
        if(info && info.n) cell.innerHTML += `<div class="note-text">${info.n}</div>`;
        cell.onclick = () => open(key, info || {mode:'simple', s:'L'});
        grid.appendChild(cell);
      }

      // Current month days
      for(let d = 1; d <= lastDate; d++) {
        const key = `${y}-${m+1}-${d}`;
        const info = user.data[key] || { mode: 'simple', s: 'L' };
        const cell = document.createElement('div');

        let cellClasses = 'day-cell';
        const dayOfWeek = new Date(y, m, d).getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) cellClasses += ' weekend';
        if (key === todayKey) cellClasses += ' today';
        cell.className = cellClasses;

        if(info.mode === 'mixto') {
          cell.innerHTML = `
            <div class="shift-label bg-${SHIFTS[info.t]?.color || 'L'}">${SHIFTS[info.t]?.label || 'L'}</div>
            <div class="shift-label bg-${SHIFTS[info.b]?.color || 'L'}">${SHIFTS[info.b]?.label || 'L'}</div>`;
        } else {
          const label = info.s === 'L' ? 'L' : (SHIFTS[info.s]?.label || info.s || 'L');
          cell.innerHTML = `<div class="shift-label bg-${SHIFTS[info.s]?.color || 'L'}">${label}</div>`;
        }

        const holidayData = db.holidays[key];
        if(holidayData) cell.innerHTML += `<div class="holiday-indicator">A</div>`;

        cell.innerHTML += `<span class="day-number">${d}</span>`;
        if(info.n) cell.innerHTML += `<div class="note-text">${info.n}</div>`;

        cell.onclick = () => {
          if(!isEditMode()) { alert("Para editar, primero activa el modo edici√≥n"); return; }
          open(key, info);
        };

        grid.appendChild(cell);
      }

      // Next month filler
      const total = firstDayMonday + lastDate;
      for(let i = 1; i <= (42 - total); i++) {
        const nextMonth = m === 11 ? 1 : m + 2;
        const nextYear = m === 11 ? y + 1 : y;
        const key = `${nextYear}-${nextMonth}-${i}`;

        const cell = document.createElement('div');
        cell.className = 'day-cell day-off-month';

        const holidayData = db.holidays[key];
        if(holidayData) cell.innerHTML += `<div class="holiday-indicator">A</div>`;

        cell.innerHTML += `<span class="day-number">${i}</span>`;
        grid.appendChild(cell);
      }

      calcSummary();
    }

    function updateUserInitial() {
      document.getElementById('userInitial').textContent = db.current.charAt(0);
    }

    // =========================
    // Modal open + default note rule
    // =========================
    function defaultNoteForShift(shiftKey) {
      const user = db.users[db.current];
      const sh = user.config[shiftKey];
      if (!sh) return '';
      if (sh.in && sh.out && !(sh.in === '00:00' && sh.out === '00:00')) return `${sh.in}-${sh.out}`;
      return (sh.label || shiftKey || '').toUpperCase();
    }

    function open(key, info) {
      if(!isEditMode()) return;

      activeKey = key;
      mode = info.mode || 'simple';
      selS = info.s || 'Ma√±ana';
      selT = info.t || 'Ma√±ana';
      selB = info.b || 'Tarde';

      const SHIFTS = db.users[db.current].config;

      if(mode === 'simple') {
        document.getElementById('tIn').value = info.tIn || (SHIFTS[selS]?.in || '00:00');
        document.getElementById('tOut').value = info.tOut || (SHIFTS[selS]?.out || '00:00');
        document.getElementById('tHrs').value = info.h || calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value);
        document.getElementById('time-simple').classList.remove('hidden');
        document.getElementById('time-mixto').classList.add('hidden');
      } else {
        document.getElementById('tInTop').value = info.tInTop || (SHIFTS[selT]?.in || '00:00');
        document.getElementById('tOutTop').value = info.tOutTop || (SHIFTS[selT]?.out || '00:00');
        document.getElementById('tInBottom').value = info.tInBottom || (SHIFTS[selB]?.in || '00:00');
        document.getElementById('tOutBottom').value = info.tOutBottom || (SHIFTS[selB]?.out || '00:00');

        const hrsTop = info.hrsTop || calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
        const hrsBottom = info.hrsBottom || calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);

        document.getElementById('tHrsTop').value = hrsTop.toFixed(1);
        document.getElementById('tHrsBottom').value = hrsBottom.toFixed(1);
        document.getElementById('tHrsMixto').value = (hrsTop + hrsBottom).toFixed(1);

        document.getElementById('time-simple').classList.add('hidden');
        document.getElementById('time-mixto').classList.remove('hidden');
      }

      // Comentario: si viene vac√≠o, sugerir el horario del turno
      const note = (info.n || '').trim();
      if (!note) {
        if (mode === 'simple') document.getElementById('nota').value = defaultNoteForShift(selS);
        else document.getElementById('nota').value = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`.trim();
      } else {
        document.getElementById('nota').value = info.n || '';
      }

      const [year, month, day] = key.split('-');
      const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      document.getElementById('modalDate').textContent = `${day} de ${months[parseInt(month)-1]} de ${year}`;

      setMode(mode);
      refreshBtns();
      document.getElementById('modal').classList.add('active');
    }

    function calculateHours(start, end) {
      if(!start || !end || (start === '00:00' && end === '00:00')) return 0;
      let [h1, m1] = start.split(':').map(Number);
      let [h2, m2] = end.split(':').map(Number);
      let diff = (h2 + m2/60) - (h1 + m1/60);
      if(diff < 0) diff += 24;
      return parseFloat(diff.toFixed(1));
    }

    function setMode(m) {
      mode = m;
      document.getElementById('m-s').className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m==='simple'?'bg-white shadow-md text-blue-600':'text-gray-400'}`;
      document.getElementById('m-m').className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m==='mixto'?'bg-white shadow-md text-blue-600':'text-gray-400'}`;
      document.getElementById('sec-simple').classList.toggle('hidden', m!=='simple');
      document.getElementById('sec-mixto').classList.toggle('hidden', m!=='mixto');
    }

    function refreshBtns() {
      const SHIFTS = db.users[db.current].config;

      const createBtn = (shiftKey, isSelected) => {
        const color = SHIFTS[shiftKey]?.color || 'L';
        const btn = document.createElement('div');
        btn.className = `shift-option ${isSelected ? 'selected' : ''} bg-${color}`;
        btn.style.border = isSelected ? '2px solid #2563eb' : '2px solid transparent';
        btn.innerText = SHIFTS[shiftKey]?.label || shiftKey;
        btn.dataset.shift = shiftKey;
        return btn;
      };

      // Simple mode
      const simpleContainer = document.getElementById('sec-simple');
      simpleContainer.innerHTML = '';
      Object.keys(SHIFTS).forEach(k => {
        const btn = createBtn(k, selS === k);
        btn.onclick = () => {
          selS = k;
          if((SHIFTS[k]?.in || '00:00') !== '00:00') {
            document.getElementById('tIn').value = SHIFTS[k].in;
            document.getElementById('tOut').value = SHIFTS[k].out;
            autoCalc();
          } else {
            document.getElementById('tIn').value = '00:00';
            document.getElementById('tOut').value = '00:00';
            document.getElementById('tHrs').value = 0;
          }
          // si comentario est√° vac√≠o, sugerir horario
          maybeAutoNoteSimple(true);
          refreshBtns();
        };
        simpleContainer.appendChild(btn);
      });

      // Mixto top
      const mixTopContainer = document.getElementById('mix-t');
      mixTopContainer.innerHTML = '';
      Object.keys(SHIFTS).forEach(k => {
        const btn = createBtn(k, selT === k);
        btn.onclick = () => {
          selT = k;
          document.getElementById('tInTop').value = SHIFTS[k]?.in || '00:00';
          document.getElementById('tOutTop').value = SHIFTS[k]?.out || '00:00';
          autoCalcMixtoTop();
          maybeAutoNoteMixto(true);
          refreshBtns();
        };
        mixTopContainer.appendChild(btn);
      });

      // Mixto bottom
      const mixBottomContainer = document.getElementById('mix-b');
      mixBottomContainer.innerHTML = '';
      Object.keys(SHIFTS).forEach(k => {
        const btn = createBtn(k, selB === k);
        btn.onclick = () => {
          selB = k;
          document.getElementById('tInBottom').value = SHIFTS[k]?.in || '00:00';
          document.getElementById('tOutBottom').value = SHIFTS[k]?.out || '00:00';
          autoCalcMixtoBottom();
          maybeAutoNoteMixto(true);
          refreshBtns();
        };
        mixBottomContainer.appendChild(btn);
      });
    }

    function maybeAutoNoteSimple(force=false) {
      const notaEl = document.getElementById('nota');
      if (!notaEl) return;
      if (force || !notaEl.value.trim()) {
        notaEl.value = defaultNoteForShift(selS);
      }
    }

    function maybeAutoNoteMixto(force=false) {
      const notaEl = document.getElementById('nota');
      if (!notaEl) return;
      if (force || !notaEl.value.trim()) {
        notaEl.value = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`.trim();
      }
    }

    function autoCalc() {
      const start = document.getElementById('tIn').value;
      const end = document.getElementById('tOut').value;
      const hours = calculateHours(start, end);
      document.getElementById('tHrs').value = hours.toFixed(1);
    }

    function manualCalc() {
      const hours = parseFloat(document.getElementById('tHrs').value) || 0;
      document.getElementById('tHrs').value = hours.toFixed(1);
    }

    function autoCalcMixtoTop() {
      const start = document.getElementById('tInTop').value;
      const end = document.getElementById('tOutTop').value;
      const hours = calculateHours(start, end);
      document.getElementById('tHrsTop').value = hours.toFixed(1);
      updateMixtoTotal();
    }

    function manualCalcMixtoTop() {
      const hours = parseFloat(document.getElementById('tHrsTop').value) || 0;
      document.getElementById('tHrsTop').value = hours.toFixed(1);
      updateMixtoTotal();
    }

    function autoCalcMixtoBottom() {
      const start = document.getElementById('tInBottom').value;
      const end = document.getElementById('tOutBottom').value;
      const hours = calculateHours(start, end);
      document.getElementById('tHrsBottom').value = hours.toFixed(1);
      updateMixtoTotal();
    }

    function manualCalcMixtoBottom() {
      const hours = parseFloat(document.getElementById('tHrsBottom').value) || 0;
      document.getElementById('tHrsBottom').value = hours.toFixed(1);
      updateMixtoTotal();
    }

    function updateMixtoTotal() {
      const hrsTop = parseFloat(document.getElementById('tHrsTop').value) || 0;
      const hrsBottom = parseFloat(document.getElementById('tHrsBottom').value) || 0;
      document.getElementById('tHrsMixto').value = (hrsTop + hrsBottom).toFixed(1);
    }

    function save() {
      const user = db.users[db.current];
      const data = { mode, s: selS, t: selT, b: selB, n: document.getElementById('nota').value };

      if(mode === 'simple') {
        data.tIn = document.getElementById('tIn').value;
        data.tOut = document.getElementById('tOut').value;
        data.h = parseFloat(document.getElementById('tHrs').value) || 0;
        // si el comentario qued√≥ vac√≠o, poner horario
        if (!String(data.n||'').trim()) data.n = defaultNoteForShift(selS);
      } else {
        data.tInTop = document.getElementById('tInTop').value;
        data.tOutTop = document.getElementById('tOutTop').value;
        data.tInBottom = document.getElementById('tInBottom').value;
        data.tOutBottom = document.getElementById('tOutBottom').value;
        data.hrsTop = parseFloat(document.getElementById('tHrsTop').value) || 0;
        data.hrsBottom = parseFloat(document.getElementById('tHrsBottom').value) || 0;
        data.h = parseFloat(document.getElementById('tHrsMixto').value) || 0;
        if (!String(data.n||'').trim()) data.n = `${defaultNoteForShift(selT)} | ${defaultNoteForShift(selB)}`.trim();
      }

      user.data[activeKey] = data;
      localStorage.setItem('shifter_v18', JSON.stringify(db));
      render();
      closeModal();
    }

    // =========================
    // Summary
    // =========================
    function calcSummary() {
      let h = 0, s = 0;
      let hospDays = 0, senaDays = 0, freeDays = 0, vacDays = 0, workedDays = 0, weekendDays = 0, holidayWorked = 0;
      const y = current.getFullYear(), m = current.getMonth() + 1;
      const user = db.users[db.current];
      const SHIFTS = user.config;

      const daysInMonth = new Date(y, m, 0).getDate();
      freeDays = daysInMonth;

      let totalHolidays = 0;
      Object.keys(db.holidays).forEach(dateKey => {
        if(dateKey.startsWith(`${y}-${m}-`)) totalHolidays++;
      });

      Object.keys(user.data).forEach(k => {
        if(k.startsWith(`${y}-${m}-`)) {
          const d = user.data[k];
          const dayOfWeek = new Date(y, m-1, parseInt(k.split('-')[2])).getDay();
          const isHoliday = db.holidays[k];

          if(dayOfWeek === 0 || dayOfWeek === 6) weekendDays++;
          freeDays--;

          if(d.mode === 'mixto') {
            workedDays++;
            if(isHoliday) holidayWorked++;

            if(SHIFTS[d.t]?.cat === 'hosp') { h += (d.hrsTop || calculateHours(d.tInTop || SHIFTS[d.t].in, d.tOutTop || SHIFTS[d.t].out)); hospDays++; }
            if(SHIFTS[d.t]?.cat === 'sena') { s += (d.hrsTop || calculateHours(d.tInTop || SHIFTS[d.t].in, d.tOutTop || SHIFTS[d.t].out)); senaDays++; }
            if(SHIFTS[d.b]?.cat === 'hosp') { h += (d.hrsBottom || calculateHours(d.tInBottom || SHIFTS[d.b].in, d.tOutBottom || SHIFTS[d.b].out)); hospDays++; }
            if(SHIFTS[d.b]?.cat === 'sena') { s += (d.hrsBottom || calculateHours(d.tInBottom || SHIFTS[d.b].in, d.tOutBottom || SHIFTS[d.b].out)); senaDays++; }
          } else {
            if(SHIFTS[d.s]?.cat === 'hosp') { h += (d.h || 0); hospDays++; workedDays++; if(isHoliday) holidayWorked++; }
            else if(SHIFTS[d.s]?.cat === 'sena') { s += (d.h || 0); senaDays++; workedDays++; if(isHoliday) holidayWorked++; }
            else if(SHIFTS[d.s]?.cat === 'off') { freeDays++; if(d.s === 'Vacaciones') vacDays++; }
          }
        }
      });

      freeDays = Math.max(0, freeDays);

      document.getElementById('hrs-hosp').textContent = h.toFixed(1) + " HRS";
      document.getElementById('hrs-sena').textContent = s.toFixed(1) + " HRS";
      document.getElementById('hosp-days').textContent = hospDays + " d√≠a" + (hospDays !== 1 ? 's' : '');
      document.getElementById('sena-days').textContent = senaDays + " d√≠a" + (senaDays !== 1 ? 's' : '');
      document.getElementById('total-off').textContent = (freeDays + vacDays + weekendDays);
      document.getElementById('free-days').textContent = freeDays;
      document.getElementById('vac-days').textContent = vacDays;
      document.getElementById('weekend-days').textContent = weekendDays;
      document.getElementById('holiday-worked').textContent = holidayWorked;
      document.getElementById('worked-days').textContent = workedDays;
      document.getElementById('total-holidays').textContent = totalHolidays;

      const avgHours = workedDays > 0 ? (h + s) / workedDays : 0;
      document.getElementById('avg-hours').textContent = avgHours.toFixed(1) + 'h';
      document.getElementById('total-days').textContent = daysInMonth;
    }

    // =========================
    // Settings: shifts/categories/holidays/users
    // =========================
    function addNewShift() {
      const name = document.getElementById('newShiftName').value.trim();
      const color = document.getElementById('newShiftColor').value;
      const cat = document.getElementById('newShiftCat').value;
      const inTime = document.getElementById('newShiftIn').value || '00:00';
      const outTime = document.getElementById('newShiftOut').value || '00:00';

      if(!name) { alert("Por favor ingresa un nombre para el turno"); return; }
      if(!cat) { alert("Por favor selecciona una categor√≠a"); return; }

      const user = db.users[db.current];
      const shiftKey = name.replace(/\s+/g, '_');

      user.config[shiftKey] = { label: name, color, cat, in: inTime, out: outTime };

      document.getElementById('newShiftName').value = '';
      document.getElementById('newShiftIn').value = '';
      document.getElementById('newShiftOut').value = '';

      localStorage.setItem('shifter_v18', JSON.stringify(db));
      renderSettings();
      alert("Turno agregado correctamente");
    }

    function renderSettings() {
      const container = document.getElementById('settings-container');
      container.innerHTML = '';
      const SHIFTS = db.users[db.current].config;

      Object.keys(SHIFTS).forEach(id => {
        const conf = SHIFTS[id];
        const category = db.categories[conf.cat] || { name: 'Desconocida', icon: '‚ùì' };

        container.innerHTML += `
          <div class="flex items-center gap-4 bg-gradient-to-r from-gray-50 to-white p-4 rounded-2xl border border-gray-200 hover:border-blue-300 transition-colors">
            <div class="w-10 h-10 rounded-full bg-${conf.color} border-2 border-white shadow-sm flex items-center justify-center">
              <span class="text-[10px] font-black text-gray-800">${(conf.label || id).charAt(0)}</span>
            </div>
            <div class="flex-1">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                  <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</p>
                  <input id="set-label-${id}" type="text" value="${conf.label || id}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-sm">
                </div>
                <div>
                  <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Categor√≠a</p>
                  <select id="set-cat-${id}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-sm">
                    ${Object.keys(db.categories).map(catId => {
                      const cat = db.categories[catId];
                      return `<option value="${catId}" ${conf.cat === catId ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`;
                    }).join('')}
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <div>
                  <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Entrada</p>
                  <input type="time" id="set-in-${id}" value="${conf.in || '00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-sm">
                </div>
                <div>
                  <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Salida</p>
                  <input type="time" id="set-out-${id}" value="${conf.out || '00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-sm">
                </div>
              </div>
              <div class="mt-2 text-[10px] font-bold text-gray-500">
                ${category.icon} ${category.name} ‚Ä¢ Sugerencia nota: <span class="text-gray-800">${(conf.in && conf.out && !(conf.in==='00:00'&&conf.out==='00:00')) ? `${conf.in}-${conf.out}` : (conf.label||id).toUpperCase()}</span>
              </div>
            </div>
            <button onclick="deleteShift('${id}')" class="p-2 text-red-500 hover:text-red-700" title="Eliminar turno">üóëÔ∏è</button>
          </div>
        `;
      });
    }

    function loadCategoriesSelect() {
      const select = document.getElementById('newShiftCat');
      select.innerHTML = Object.keys(db.categories).map(catId => {
        const cat = db.categories[catId];
        return `<option value="${catId}">${cat.icon} ${cat.name}</option>`;
      }).join('');
    }

    function deleteShift(shiftKey) {
      if(shiftKey === 'L' || shiftKey === 'Vacaciones') { alert("No se puede eliminar este turno b√°sico"); return; }
      if(confirm(`¬øEliminar el turno "${shiftKey}"?`)) {
        const user = db.users[db.current];
        delete user.config[shiftKey];
        localStorage.setItem('shifter_v18', JSON.stringify(db));
        renderSettings();
        alert("Turno eliminado");
      }
    }

    function renderHolidays() {
      const container = document.getElementById('holidays-container');
      container.innerHTML = '';

      const sortedHolidays = Object.keys(db.holidays).sort((a, b) => new Date(a) - new Date(b));
      if(sortedHolidays.length === 0) {
        container.innerHTML = `<div class="p-8 text-center text-gray-400"><p class="text-[12px] font-bold">No hay asuetos programados</p></div>`;
        return;
      }

      sortedHolidays.forEach(dateKey => {
        const [year, month, day] = dateKey.split('-');
        const holidayData = db.holidays[dateKey];

        container.innerHTML += `
          <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50">
            <div class="flex-1">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                  <span class="text-[10px] font-black text-red-600">A</span>
                </div>
                <div class="flex-1">
                  <p class="text-[12px] font-black text-gray-800">${holidayData.name}</p>
                  <div class="flex justify-between items-center">
                    <p class="text-[10px] text-gray-500 font-bold">${day}/${month}/${year}</p>
                    ${holidayData.location ? `<p class="text-[9px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-full">${holidayData.location}</p>` : ''}
                  </div>
                </div>
              </div>
            </div>
            <button onclick="deleteHoliday('${dateKey}')" class="p-2 text-red-500 hover:text-red-700" title="Eliminar asueto">üóëÔ∏è</button>
          </div>
        `;
      });
    }

    function renderCategories() {
      const container = document.getElementById('categories-container');
      container.innerHTML = '';

      const sortedCategories = Object.keys(db.categories).sort((a, b) => db.categories[a].name.localeCompare(db.categories[b].name));
      if(sortedCategories.length === 0) {
        container.innerHTML = `<div class="p-8 text-center text-gray-400"><p class="text-[12px] font-bold">No hay categor√≠as definidas</p></div>`;
        return;
      }

      sortedCategories.forEach(catId => {
        const cat = db.categories[catId];
        container.innerHTML += `
          <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                <span class="text-[14px]">${cat.icon}</span>
              </div>
              <div>
                <p class="text-[12px] font-black text-gray-800">${cat.name}</p>
                <p class="text-[10px] text-gray-500 font-bold">ID: ${catId}</p>
              </div>
            </div>
            ${catId !== 'hosp' && catId !== 'sena' && catId !== 'off'
              ? `<button onclick="deleteCategory('${catId}')" class="p-2 text-red-500 hover:text-red-700" title="Eliminar categor√≠a">üóëÔ∏è</button>`
              : `<span class="text-[9px] text-gray-400 font-bold">Sistema</span>`
            }
          </div>
        `;
      });
    }

    function addNewHoliday() {
      const dateInput = document.getElementById('newHolidayDate').value;
      const name = document.getElementById('newHolidayName').value.trim();
      const location = document.getElementById('newHolidayLocation').value.trim();

      if(!dateInput || !name) { alert("Por favor completa la fecha y el nombre del asueto"); return; }

      const date = new Date(dateInput);
      const dateKey = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;

      db.holidays[dateKey] = { name, location: location || 'General' };
      localStorage.setItem('shifter_v18', JSON.stringify(db));

      document.getElementById('newHolidayDate').value = '';
      document.getElementById('newHolidayName').value = '';
      document.getElementById('newHolidayLocation').value = '';

      renderHolidays();
      render();
      alert("Asueto agregado correctamente");
    }

    function addNewCategory() {
      const name = document.getElementById('newCategoryName').value.trim();
      const icon = document.getElementById('newCategoryIcon').value;

      if(!name) { alert("Por favor ingresa un nombre para la categor√≠a"); return; }

      const catId = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      if(db.categories[catId]) { alert("Ya existe una categor√≠a con ese nombre o ID similar"); return; }

      db.categories[catId] = { name, icon };
      localStorage.setItem('shifter_v18', JSON.stringify(db));

      document.getElementById('newCategoryName').value = '';

      renderCategories();
      loadCategoriesSelect();
      alert("Categor√≠a agregada correctamente");
    }

    function deleteHoliday(dateKey) {
      const holiday = db.holidays[dateKey];
      if(confirm(`¬øEliminar el asueto "${holiday.name}" (${dateKey})?`)) {
        delete db.holidays[dateKey];
        localStorage.setItem('shifter_v18', JSON.stringify(db));
        renderHolidays();
        render();
        alert("Asueto eliminado");
      }
    }

    function deleteCategory(catId) {
      const user = db.users[db.current];
      let inUse = false;
      Object.keys(user.config).forEach(shiftKey => { if(user.config[shiftKey].cat === catId) inUse = true; });
      if(inUse) { alert("No se puede eliminar esta categor√≠a porque est√° siendo usada por uno o m√°s turnos"); return; }

      if(confirm(`¬øEliminar la categor√≠a "${db.categories[catId].name}"?`)) {
        delete db.categories[catId];
        localStorage.setItem('shifter_v18', JSON.stringify(db));
        renderCategories();
        loadCategoriesSelect();
        alert("Categor√≠a eliminada");
      }
    }

    function saveProfileSettings() {
      if(!isEditMode()) { alert("Activa el modo edici√≥n para cambiar configuraciones."); return; }

      const user = db.users[db.current];
      const SHIFTS = user.config;

      Object.keys(SHIFTS).forEach(id => {
        const labelInput = document.getElementById(`set-label-${id}`);
        const catInput = document.getElementById(`set-cat-${id}`);
        const inInput = document.getElementById(`set-in-${id}`);
        const outInput = document.getElementById(`set-out-${id}`);

        if(labelInput) SHIFTS[id].label = labelInput.value;
        if(catInput) SHIFTS[id].cat = catInput.value;
        if(inInput) SHIFTS[id].in = inInput.value;
        if(outInput) SHIFTS[id].out = outInput.value;
      });

      const newPin = document.getElementById('changePinInput').value;
      const confirmPin = document.getElementById('confirmPinInput').value;

      if(newPin && newPin.length === 4) {
        if(newPin === confirmPin) {
          user.pin = newPin;
          document.getElementById('changePinInput').value = '';
          document.getElementById('confirmPinInput').value = '';
          alert("PIN actualizado correctamente");
        } else {
          alert("Los PINs no coinciden");
          return;
        }
      }

      localStorage.setItem('shifter_v18', JSON.stringify(db));
      render();
      alert("Configuraci√≥n guardada correctamente");
    }

    function createNewUser() {
      const name = document.getElementById('newUserName').value.trim().toUpperCase();
      const pin = document.getElementById('newUserPin').value;

      if(!name || name.length < 2) { alert("El nombre debe tener al menos 2 caracteres"); return; }
      if(pin.length !== 4 || isNaN(pin)) { alert("El PIN debe ser de 4 d√≠gitos num√©ricos"); return; }
      if(db.users[name]) { alert("Ya existe un usuario con ese nombre"); return; }

      db.users[name] = JSON.parse(JSON.stringify(db.users['ADMIN']));
      db.users[name].pin = pin;
      db.users[name].data = {};
      db.users[name].editLocked = false;
      ensureImportBaseShiftsForUser(name);

      db.current = name;

      localStorage.setItem('shifter_v18', JSON.stringify(db));
      updateUserDropdown();
      updateUserInitial();
      render();
      closeUserModal();

      alert("Usuario creado correctamente");
    }

    function ensureUserExistsFromImport(fullNameUpper) {
      const name = String(fullNameUpper || '').trim().toUpperCase();
      if (!name) return null;

      if (!db.users[name]) {
        db.users[name] = JSON.parse(JSON.stringify(db.users['ADMIN']));
        db.users[name].pin = '0000'; // Importado: PIN por defecto (c√°mbialo en Seguridad)
        db.users[name].data = {};
        db.users[name].editLocked = false;
        ensureImportBaseShiftsForUser(name);
      }
      return name;
    }

    function switchUser() {
      db.current = document.getElementById('userSelect').value;
      updateUserInitial();
      render();
      updateUIEditMode();
    }

    function updateUserDropdown() {
      const select = document.getElementById('userSelect');
      select.innerHTML = Object.keys(db.users).map(u => `<option value="${u}" ${u===db.current?'selected':''}>${u}</option>`).join('');
    }

    function closeModal() { document.getElementById('modal').classList.remove('active'); }
    function closeUserModal() {
      document.getElementById('userModal').classList.remove('active');
      document.getElementById('newUserName').value = '';
      document.getElementById('newUserPin').value = '';
    }
    function openUserModal() { document.getElementById('userModal').classList.add('active'); }

    function changeMonth(v) {
      current.setMonth(current.getMonth() + v);
      updateMonthDisplay();
      render();
    }
    function jumpToDate() {
      current.setMonth(parseInt(document.getElementById('selectMonth').value));
      current.setFullYear(parseInt(document.getElementById('selectYear').value));
      updateMonthDisplay();
      render();
    }
    function showView(v) {
      document.querySelectorAll('.view-section').forEach(s => s.classList.remove('view-active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));

      document.getElementById('view-' + v).classList.add('view-active');
      document.getElementById('tab-' + v).classList.add('tab-active');

      if(v === 'settings') {
        updateUIEditMode();
        if(isEditMode()) showConfigTab('turnos');
      }
    }

    // =========================
    // IMPORT ENGINE
    // =========================
    function detectMonthYearFromRows(rows) {
      // Busca algo tipo "MES: FEBRERO  A√ëO 2026"
      const monthsMap = {
        'ENERO':0,'FEBRERO':1,'MARZO':2,'ABRIL':3,'MAYO':4,'JUNIO':5,'JULIO':6,'AGOSTO':7,'SEPTIEMBRE':8,'OCTUBRE':9,'NOVIEMBRE':10,'DICIEMBRE':11
      };

      let foundMonth = null;
      let foundYear = null;

      for (let r=0; r<Math.min(rows.length, 40); r++) {
        const row = rows[r] || [];
        for (let c=0; c<row.length; c++) {
          const v = row[c];
          if (!v) continue;
          const s = String(v).toUpperCase();
          if (s.includes('MES:') && s.includes('A√ëO')) {
            // extraer mes y a√±o
            Object.keys(monthsMap).forEach(mn => {
              if (s.includes(mn) && foundMonth === null) foundMonth = monthsMap[mn];
            });
            const yMatch = s.match(/A√ëO\s*([0-9]{4})/);
            if (yMatch) foundYear = parseInt(yMatch[1]);
          }
        }
      }
      return { month: foundMonth, year: foundYear };
    }

    function findHeaderRow(rows) {
      // La hoja suele traer: col C "PERSONAL", col D "No. EMP.", y desde col E n√∫meros 1..28/31
      for (let r=0; r<rows.length; r++) {
        const row = rows[r] || [];
        const joined = row.map(x => (x===undefined||x===null)?'':String(x).trim()).join(' | ').toUpperCase();
        if (joined.includes('PERSONAL') && (joined.includes('NO. EMP') || joined.includes('NO.EMP') || joined.includes('NO EMP'))) {
          // confirmar que existan d√≠as 1/2/3
          if (row.some(v => String(v).trim() === '1') && row.some(v => String(v).trim() === '2')) {
            return r;
          }
        }
      }
      return -1;
    }

    function buildDayColumnMap(headerRow) {
      // retorna { dayNumber:int -> colIndex:int }
      const map = {};
      for (let c=0; c<headerRow.length; c++) {
        const v = headerRow[c];
        if (v === null || v === undefined) continue;
        const s = String(v).trim();
        if (/^\d+$/.test(s)) {
          const d = parseInt(s);
          if (d>=1 && d<=31) map[d] = c;
        }
      }
      return map;
    }

    function safeNameCell(v) {
      if (v === null || v === undefined) return '';
      let s = String(v).replace(/\s+/g,' ').trim();
      return s;
    }

    function isLikelyDataRow(row, nameCol, empCol, dayCols) {
      const name = safeNameCell(row[nameCol]);
      const emp = safeNameCell(row[empCol]);

      if (!name) return false;

      const upper = name.toUpperCase();
      // Filtrar filas-t√≠tulo o totales
      if (upper.includes('TOTAL POR TURNO')) return false;
      if (upper.includes('PERSONAL')) return false;
      if (upper.includes('COORDINACION')) return false;
      if (upper.includes('ERITROPOYETINA')) return false;

      // No. emp suele existir, pero algunas filas tipo INT se manejan
      if (!emp) return false;

      // Debe haber al menos un c√≥digo en alg√∫n d√≠a
      let any = false;
      for (const d of Object.keys(dayCols)) {
        const c = dayCols[d];
        const code = normalizeCode(row[c]);
        if (code && code !== 'X') { any = true; break; }
      }
      return any;
    }

    function ensureShiftExistsForUser(userKey, shiftDef) {
      const user = db.users[userKey];
      if (!user) return;

      if (!user.config[shiftDef.key]) {
        user.config[shiftDef.key] = {
          label: shiftDef.label,
          color: shiftDef.color || 'gris',
          cat: shiftDef.cat || 'hosp',
          in: shiftDef.in || '00:00',
          out: shiftDef.out || '00:00'
        };
      }
    }

    function codeToShiftDef(codeNorm) {
      // Trata LS como libre
      if (codeNorm === 'LS') codeNorm = 'L';

      // PS puede venir como 'P S' o 'P/S' en algunos excels (defensivo)
      if (codeNorm === 'P S' || codeNorm === 'P/S') codeNorm = 'PS';

      // Ausencias (letras)
      if (IMPORT_ABSENCE_MAP[codeNorm]) {
        const def = IMPORT_ABSENCE_MAP[codeNorm];
        return { ...def };
      }

      // Turnos conocidos
      if (IMPORT_SHIFT_CODE_MAP[codeNorm]) {
        const def = IMPORT_SHIFT_CODE_MAP[codeNorm];
        return { ...def };
      }

      // Si es n√∫mero (c√≥digo nuevo), crea un turno autom√°tico editable
      if (/^\d+$/.test(codeNorm)) {
        return {
          key: codeNorm,
          label: codeNorm,
          color: 'gris',
          cat: 'hosp',
          in: '00:00',
          out: '00:00',
          note: codeNorm
        };
      }

      // Si es vac√≠o o X: ignorar
      return null;
    }

    function clearMonthForUser(userKey, year, monthIndex0) {
      const user = db.users[userKey];
      if (!user) return;
      const prefix = `${year}-${monthIndex0+1}-`;
      Object.keys(user.data).forEach(k => {
        if (k.startsWith(prefix)) delete user.data[k];
      });
    }

    function setDayForUser(userKey, year, monthIndex0, day, shiftDef, importMode) {
      const user = db.users[userKey];
      if (!user) return;
      const keyDate = `${year}-${monthIndex0+1}-${day}`;

      if (importMode === 'merge' && user.data[keyDate]) return;

      // Asegurar turno
      ensureShiftExistsForUser(userKey, shiftDef);

      const tIn = shiftDef.in || '00:00';
      const tOut = shiftDef.out || '00:00';
      const hrs = calculateHours(tIn, tOut);

      user.data[keyDate] = {
        mode: 'simple',
        s: shiftDef.key,
        t: shiftDef.key,
        b: shiftDef.key,
        tIn: tIn,
        tOut: tOut,
        h: hrs,
        n: (shiftDef.note && String(shiftDef.note).trim()) ? shiftDef.note : defaultNoteForShift(shiftDef.key)
      };
    }

    async function runImport() {
      const fileInput = document.getElementById('importFile');
      if (!fileInput.files || !fileInput.files[0]) {
        alert("Selecciona un archivo Excel primero.");
        return;
      }

      const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'replace';

      try {
        const file = fileInput.files[0];
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' });

        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];

        // rows as arrays
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' });

        // Detect month/year if possible
        const detected = detectMonthYearFromRows(rows);
        const fallbackMonth = parseInt(document.getElementById('importMonth').value);
        const fallbackYear = parseInt(document.getElementById('importYear').value);

        const monthIndex0 = (detected.month !== null && detected.month !== undefined) ? detected.month : fallbackMonth;
        const year = (detected.year !== null && detected.year !== undefined) ? detected.year : fallbackYear;

        // Find header row
        const headerIdx = findHeaderRow(rows);
        if (headerIdx < 0) {
          alert("No pude detectar la fila de encabezado. Debe existir una fila con 'PERSONAL' y 'No. EMP.' y los d√≠as 1..");
          return;
        }

        const headerRow = rows[headerIdx] || [];
        const dayCols = buildDayColumnMap(headerRow);

        // Find col indices for name and emp
        let nameCol = -1, empCol = -1;
        for (let c=0; c<headerRow.length; c++) {
          const s = String(headerRow[c] || '').toUpperCase().trim();
          if (s === 'PERSONAL') nameCol = c;
          if (s.includes('NO') && s.includes('EMP')) empCol = c;
        }
        if (nameCol < 0 || empCol < 0 || Object.keys(dayCols).length < 10) {
          alert("Encabezado detectado, pero faltan columnas clave (PERSONAL/No. EMP./d√≠as).");
          return;
        }

        // Parse data rows below header until end
        let createdUsers = 0;
        let writtenCells = 0;

        // Pre-scan: list of names
        const userKeysToProcess = new Set();

        for (let r=headerIdx+1; r<rows.length; r++) {
          const row = rows[r] || [];
          if (!isLikelyDataRow(row, nameCol, empCol, dayCols)) continue;

          const name = safeNameCell(row[nameCol]).toUpperCase();
          const userKey = ensureUserExistsFromImport(name);
          if (userKey) userKeysToProcess.add(userKey);
        }

        // Replace month if requested
        if (importMode === 'replace') {
          userKeysToProcess.forEach(u => clearMonthForUser(u, year, monthIndex0));
        }

        // Write shifts
        for (let r=headerIdx+1; r<rows.length; r++) {
          const row = rows[r] || [];
          if (!isLikelyDataRow(row, nameCol, empCol, dayCols)) continue;

          const name = safeNameCell(row[nameCol]).toUpperCase();
          const userKey = ensureUserExistsFromImport(name);
          if (!userKey) continue;

          for (const dStr of Object.keys(dayCols)) {
            const day = parseInt(dStr);
            const c = dayCols[dStr];
            const code = normalizeCode(row[c]);
            if (!code || code === 'X') continue;

            const shiftDef = codeToShiftDef(code);
            if (!shiftDef) continue;

            // Nota por defecto (horario)
            if (!shiftDef.note) {
              // si tiene horario: "in-out"
              if (shiftDef.in && shiftDef.out && !(shiftDef.in==='00:00'&&shiftDef.out==='00:00')) shiftDef.note = `${shiftDef.in}-${shiftDef.out}`;
              else shiftDef.note = (shiftDef.label || shiftDef.key || code).toUpperCase();
            }

            setDayForUser(userKey, year, monthIndex0, day, shiftDef, importMode);
            writtenCells++;
          }
        }

        // Guardar y refrescar
        localStorage.setItem('shifter_v18', JSON.stringify(db));

        // Cambiar a mes importado
        current = new Date(year, monthIndex0, 1);
        updateMonthDisplay();
        updateUserDropdown();
        updateUserInitial();
        render();

        closeImportModal();

        document.getElementById('importInfo').innerText = `Importaci√≥n OK: ${userKeysToProcess.size} perfiles, ${writtenCells} celdas cargadas.`;

        alert(`Importaci√≥n completada.\nPerfiles: ${userKeysToProcess.size}\nCeldas cargadas: ${writtenCells}\nMes: ${monthIndex0+1}/${year}\n\nNota: perfiles importados quedan con PIN "0000".`);
      } catch (err) {
        console.error(err);
        alert("Error al importar. Revisa la consola y aseg√∫rate de que el Excel sea compatible.");
      }
    }

    // =========================
    // Close & misc
    // =========================
    function closeModal(){ document.getElementById('modal').classList.remove('active'); }

    // =========================
    // Start
    // =========================
    document.addEventListener('DOMContentLoaded', init);
  </script>

</body>
</html>

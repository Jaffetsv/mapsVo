<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Shifter Pro v19.1 - Export con Comentarios + Asuetos</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

  <style>
    body { background-color: #f3f4f6; color: #1f2937; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
    .day-cell { background-color: #ffffff; height: 130px; position: relative; cursor: pointer; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.2s; }
    .day-cell:active { transform: scale(0.97); }
    .day-number { font-size: 11px; font-weight: 800; padding: 2px 6px; position: absolute; top: 0; right: 0; z-index: 20; color: #374151; background: rgba(255,255,255,0.9); border-bottom-left-radius: 8px; }
    .day-off-month { background-color: #f9fafb !important; opacity: 0.5; }
    .day-off-month .day-number { opacity: 0.6; }
    .today { border: 2px solid #3b82f6 !important; }
    .weekend { background-color: #f8fafc !important; }

    /* Colores de Turnos - DEFINIDOS EXPL√çCITAMENTE */
    .bg-Ma√±ana { background-color: #ffff00 !important; }
    .bg-Tarde { background-color: #fbcfe8 !important; }
    .bg-CENA { background-color: #d8b4fe !important; }
    .bg-16hrs { background-color: #bef264 !important; }
    .bg-L { background-color: #ffffff !important; }
    .bg-Vacaciones { background-color: #fed7aa !important; }
    .bg-Cumplea√±os { background-color: #fde68a !important; }
    .bg-azul { background-color: #93c5fd !important; }
    .bg-rojo { background-color: #fca5a5 !important; }
    .bg-verde { background-color: #86efac !important; }
    .bg-naranja { background-color: #fdba74 !important; }
    .bg-rosa { background-color: #f9a8d4 !important; }
    .bg-cian { background-color: #67e8f9 !important; }
    .bg-morado { background-color: #d8b4fe !important; }
    .bg-lima { background-color: #d9f99d !important; }
    .bg-ambar { background-color: #fcd34d !important; }
    .bg-teal { background-color: #5eead4 !important; }
    .bg-indigo { background-color: #a5b4fc !important; }
    .bg-gris { background-color: #d1d5db !important; }

    .shift-label { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; text-transform: uppercase; text-align: center; line-height: 1.1; padding: 4px; color: rgba(0,0,0,0.8); }

    /* Comentarios */
    .note-wrap { position:absolute; bottom:4px; left:50%; transform: translateX(-50%); width: 92%; display:flex; flex-direction:column; gap:2px; z-index:10; }
    .note-text { font-size: 10px; text-align: center; color: #000; font-weight: 800; background: rgba(255,255,255,0.65); border-radius: 6px; padding: 1px 4px; border: 0.5px solid rgba(0,0,0,0.1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .view-section { display: none; }
    .view-active { display: block; }
    .tab-btn { flex: 1; text-align: center; padding: 14px; font-weight: 800; font-size: 11px; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-active { border-bottom-color: #2563eb; color: #2563eb; background: #f8fafc; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 120; padding: 15px; backdrop-filter: blur(4px); }
    .modal.active { display: flex; }

    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="password"], textarea {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      font-weight: 800;
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
      width: 100%;
    }
    select:focus, input:focus, textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Botones del modal */
    .shift-option {
      transition: all 0.2s;
      border-width: 2px;
      border-color: transparent;
      padding: 12px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      user-select:none;
    }
    .shift-option.selected {
      border-color: #2563eb !important;
      opacity: 1 !important;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      transform: translateY(-2px);
    }
    .shift-option:not(.selected) { opacity: 0.75; }
    .shift-option:hover:not(.selected) { opacity: 0.92; transform: translateY(-1px); }

    /* Paleta de colores */
    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .color-option.selected {
      border-color: #000;
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Tabs de configuraci√≥n */
    .config-tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      font-weight: 900;
      font-size: 10px;
      border-bottom: 3px solid transparent;
      transition: 0.3s;
      color: #9ca3af;
    }
    .config-tab.active {
      border-bottom-color: #2563eb;
      color: #2563eb;
      background: #f8fafc;
    }

    /* Indicador de asueto */
    .holiday-indicator {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 8px;
      font-weight: 900;
      color: #dc2626;
      background: rgba(254, 226, 226, 0.9);
      padding: 1px 4px;
      border-bottom-right-radius: 8px;
      z-index: 20;
    }

    /* Fix: opciones visibles en selector de perfiles */
    #userSelect { background: transparent !important; color: #fff !important; }
    #userSelect option { color: #111827; background: #fff; }

    /* Responsive: celdas m√°s compactas en m√≥vil */
    @media (max-width: 420px) {
      .day-cell { height: 115px; }
      .shift-label { font-size: 10px; }
      .note-text { font-size: 9px; }
      .tab-btn { padding: 12px; font-size: 10px; }
    }
  </style>
</head>

<body>

  <!-- Barra superior -->
  <div class="bg-[#1e293b] text-white p-4 sticky top-0 z-50 shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-content-center font-black text-sm">
          <span id="userInitial">A</span>
        </div>
        <div>
          <select id="userSelect" onchange="switchUser()" class="border-none text-lg font-black p-0 focus:ring-0 w-auto text-left"></select>
          <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400">Modo Vista</p>
          <p class="text-[10px] font-bold text-slate-300" id="userLocationPill">üìç San Salvador</p>
        </div>
      </div>

      <div class="flex gap-2 flex-wrap justify-end">
        <button onclick="openUserManager()" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üë• Perfiles</button>
        <button onclick="openImportModal()" class="bg-amber-600 hover:bg-amber-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">‚¨ÜÔ∏è Importar</button>
        <button onclick="openExportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üñºÔ∏è Exportar</button>
        <button id="unlockBtn" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üîí Bloquear</button>
      </div>
    </div>

    <!-- Selector de mes/a√±o -->
    <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-2xl p-2 shadow-inner">
      <button onclick="changeMonth(-1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
        <span class="text-xl font-bold">‚Äπ</span>
      </button>

      <div class="flex flex-col items-center">
        <div id="currentMonthDisplay" class="text-xl font-black text-white text-center mb-1">Febrero 2026</div>
        <div class="flex gap-3 items-center opacity-80">
          <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-black text-white text-center appearance-none cursor-pointer"></select>
          <span class="text-white font-black">/</span>
          <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-black text-white text-center appearance-none cursor-pointer"></select>
        </div>
        <div class="flex gap-2 mt-2">
          <button onclick="goToday()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-[10px] font-black uppercase transition-colors">Hoy</button>
        </div>
      </div>

      <button onclick="changeMonth(1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
        <span class="text-xl font-bold">‚Ä∫</span>
      </button>
    </div>
  </div>

  <!-- Tabs de navegaci√≥n -->
  <div class="flex bg-white shadow-sm sticky top-[170px] z-40 border-b">
    <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">üìÖ Calendario</button>
    <button onclick="showView('summary')" id="tab-summary" class="tab-btn">üìä Resumen</button>
    <button onclick="showView('settings')" id="tab-settings" class="tab-btn">‚öôÔ∏è Ajustes</button>
  </div>

  <!-- Vista Calendario -->
  <div id="view-calendar" class="view-section view-active">
    <div class="grid grid-cols-7 text-center text-[11px] font-black py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b">
      <div class="text-blue-500 font-black">LUN</div>
      <div>MAR</div>
      <div>MI√â</div>
      <div>JUE</div>
      <div>VIE</div>
      <div class="text-blue-500 font-black">S√ÅB</div>
      <div class="text-red-500 font-black">DOM</div>
    </div>
    <div id="calendar" class="calendar-grid"></div>
  </div>

  <!-- Vista Resumen -->
  <div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen">
    <div class="space-y-4 md:space-y-6">
      <div class="bg-white p-4 md:p-5 rounded-3xl shadow-sm">
        <div class="flex items-center justify-between">
          <h3 class="text-[12px] font-black text-gray-600 uppercase">üìå Resumen por Categor√≠as</h3>
          <span class="text-[10px] font-black text-gray-400" id="summaryScope">Mes actual</span>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3" id="summaryCards"></div>
      </div>

      <div class="bg-white p-4 md:p-5 rounded-3xl shadow-sm">
        <h3 class="text-[12px] font-black text-gray-600 uppercase mb-3">üìà M√©tricas del Mes</h3>
        <div class="space-y-2 md:space-y-3 text-[11px] font-black">
          <div class="flex justify-between"><span class="text-gray-500">D√≠as trabajados:</span><span id="worked-days">0</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Promedio diario (horas):</span><span id="avg-hours">0.0h</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Total d√≠as mes:</span><span id="total-days">0</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Asuetos aplicables (localidad):</span><span id="total-holidays" class="text-red-600">0</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Asuetos trabajados:</span><span id="holiday-worked" class="text-red-600">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista Ajustes -->
  <div id="view-settings" class="view-section bg-white min-h-screen">
    <div class="flex bg-gray-50 border-b">
      <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active">üé® Turnos</button>
      <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab">‚ûï Nuevo</button>
      <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab">üè∑Ô∏è Categor√≠as</button>
      <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab">üéâ Asuetos</button>
      <button onclick="showConfigTab('localidades')" id="config-localidades" class="config-tab">üìç Localidades</button>
      <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab">üîí Seguridad</button>
    </div>

    <div id="config-content" class="p-4 md:p-6">
      <!-- Turnos -->
      <div id="tab-turnos" class="config-tab-content">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-[14px] font-black text-gray-600 uppercase">üé® Configurar Turnos</h3>
          <button onclick="saveShiftsAndRefresh()" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-black uppercase">üíæ Guardar cambios</button>
        </div>
        <p class="text-[10px] font-bold text-gray-500 mb-4">Los comentarios autom√°ticos se actualizan si el comentario no fue editado manualmente.</p>
        <div id="settings-container" class="space-y-3 md:space-y-4"></div>
      </div>

      <!-- Nuevo Turno -->
      <div id="tab-nuevo" class="config-tab-content hidden">
        <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">‚ûï Agregar Nuevo Turno</h3>
        <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 md:p-5 rounded-3xl border border-amber-100 mb-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-3">
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Nombre del Turno</label>
              <input type="text" id="newShiftName" placeholder="Ej: Noche, 018, etc." class="w-full bg-white border-amber-200 focus:border-amber-400">
            </div>
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Categor√≠a</label>
              <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
            </div>
          </div>

          <div class="mb-4">
            <label class="text-[11px] font-black text-gray-600 block mb-2">Color</label>
            <div class="grid grid-cols-6 gap-2 p-3 bg-white rounded-xl">
              <div class="color-option bg-Ma√±ana" onclick="selectColor('Ma√±ana', event)" title="Amarillo"></div>
              <div class="color-option bg-Tarde" onclick="selectColor('Tarde', event)" title="Rosa"></div>
              <div class="color-option bg-CENA" onclick="selectColor('CENA', event)" title="Morado"></div>
              <div class="color-option bg-16hrs" onclick="selectColor('16hrs', event)" title="Verde Lima"></div>
              <div class="color-option bg-Vacaciones" onclick="selectColor('Vacaciones', event)" title="Naranja"></div>
              <div class="color-option bg-Cumplea√±os" onclick="selectColor('Cumplea√±os', event)" title="Cumplea√±os"></div>
              <div class="color-option bg-L" onclick="selectColor('L', event)" title="Blanco"></div>
              <div class="color-option bg-azul" onclick="selectColor('azul', event)" title="Azul"></div>
              <div class="color-option bg-rojo" onclick="selectColor('rojo', event)" title="Rojo"></div>
              <div class="color-option bg-verde" onclick="selectColor('verde', event)" title="Verde"></div>
              <div class="color-option bg-gris" onclick="selectColor('gris', event)" title="Gris"></div>
              <div class="color-option bg-indigo" onclick="selectColor('indigo', event)" title="Indigo"></div>
            </div>
            <input type="hidden" id="newShiftColor" value="Ma√±ana">
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Hora Entrada</label>
              <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400" value="06:00">
            </div>
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Hora Salida</label>
              <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400" value="14:00">
            </div>
          </div>

          <button onclick="addNewShift()" class="w-full p-3 md:p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600 transition-all">
            ‚ûï Agregar Turno
          </button>
        </div>
      </div>

      <!-- Categor√≠as -->
      <div id="tab-categorias" class="config-tab-content hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-[14px] font-black text-gray-600 uppercase">üè∑Ô∏è Categor√≠as</h3>
          <button onclick="saveCategories()" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-black uppercase">üíæ Guardar cambios</button>
        </div>

        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 md:p-5 rounded-3xl border border-green-100 mb-6">
          <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva Categor√≠a</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <div class="md:col-span-2">
              <label class="text-[11px] font-black text-gray-600 block mb-2">Nombre</label>
              <input type="text" id="newCategoryName" placeholder="Ej: Hospital, Cena, Falta, etc." class="w-full bg-white border-green-200 focus:border-green-400">
            </div>
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Icono</label>
              <input type="text" id="newCategoryIcon" placeholder="Ej: üè•" class="w-full bg-white border-green-200 focus:border-green-400" value="üîß">
            </div>
          </div>
          <button onclick="addNewCategory()" class="w-full p-3 md:p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600 transition-all">
            ‚ûï Agregar Categor√≠a
          </button>
        </div>

        <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
          <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Editar Categor√≠as</h4>
          <div id="categories-container" class="max-h-[420px] overflow-y-auto"></div>
        </div>
      </div>

      <!-- Asuetos -->
      <div id="tab-asuetos" class="config-tab-content hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-[14px] font-black text-gray-600 uppercase">üéâ Asuetos</h3>
          <button onclick="saveHolidays()" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-black uppercase">üíæ Guardar cambios</button>
        </div>

        <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 md:p-5 rounded-3xl border border-pink-100 mb-6">
          <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Asueto</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Fecha</label>
              <input type="date" id="newHolidayDate" class="w-full bg-white border-pink-200 focus:border-pink-400">
            </div>
            <div class="md:col-span-2">
              <label class="text-[11px] font-black text-gray-600 block mb-2">Nombre</label>
              <input type="text" id="newHolidayName" placeholder="Ej: D√≠a de la Independencia" class="w-full bg-white border-pink-200 focus:border-pink-400">
            </div>
          </div>
          <div class="mb-3">
            <label class="text-[11px] font-black text-gray-600 block mb-2">Localidad</label>
            <select id="newHolidayLocation" class="w-full bg-white border-pink-200 focus:border-pink-400"></select>
          </div>
          <button onclick="addNewHoliday()" class="w-full p-3 md:p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600 transition-all">
            ‚ûï Agregar Asueto
          </button>
        </div>

        <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
          <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Editar Asuetos</h4>
          <div id="holidays-container" class="max-h-[420px] overflow-y-auto"></div>
        </div>
      </div>

      <!-- Localidades -->
      <div id="tab-localidades" class="config-tab-content hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-[14px] font-black text-gray-600 uppercase">üìç Localidades</h3>
          <button onclick="saveLocalities()" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-black uppercase">üíæ Guardar cambios</button>
        </div>

        <div class="bg-gradient-to-r from-sky-50 to-indigo-50 p-4 md:p-5 rounded-3xl border border-sky-100 mb-6">
          <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Localidad</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Nombre</label>
              <input type="text" id="newLocalityName" placeholder="Ej: San Salvador" class="w-full bg-white border-sky-200 focus:border-sky-400">
            </div>
            <div class="flex items-end">
              <button onclick="addLocality()" class="w-full p-3 bg-gradient-to-r from-sky-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-[11px] hover:from-sky-700 hover:to-indigo-700 transition-all">
                ‚ûï Agregar
              </button>
            </div>
          </div>
          <p class="text-[10px] font-bold text-gray-500">La localidad del perfil determina qu√© asuetos aplican (General o coincidencia por localidad).</p>
        </div>

        <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
          <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Listado</h4>
          <div id="localities-container" class="max-h-[420px] overflow-y-auto"></div>
        </div>
      </div>

      <!-- Seguridad -->
      <div id="tab-seguridad" class="config-tab-content hidden">
        <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üîí Seguridad</h3>
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 md:p-5 rounded-3xl border border-blue-100 mb-6">
          <div class="space-y-3 md:space-y-4">
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Cambiar PIN del perfil actual (4 d√≠gitos)</label>
              <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
            </div>
            <div>
              <label class="text-[11px] font-black text-gray-600 block mb-2">Confirmar PIN</label>
              <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
            </div>
          </div>
        </div>
        <button onclick="saveProfileSecurity()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 md:p-5 rounded-3xl font-black uppercase shadow-xl shadow-blue-200 hover:shadow-2xl transition-all">
          üíæ Guardar Seguridad
        </button>
      </div>
    </div>

    <!-- Mensaje de bloqueo -->
    <div id="settings-locked" class="p-8 text-center hidden">
      <div class="w-20 h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
        <span class="text-3xl">üîí</span>
      </div>
      <h3 class="text-lg font-black text-gray-600 mb-2">Configuraci√≥n Bloqueada</h3>
      <p class="text-sm text-gray-500 mb-6">Activa el modo edici√≥n para acceder a la configuraci√≥n</p>
      <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-black uppercase text-[11px]">üîì Activar Edici√≥n</button>
    </div>
  </div>

  <!-- Modal editar d√≠a -->
  <div id="modal" class="modal">
    <div class="bg-white w-full max-w-md rounded-[40px] overflow-hidden shadow-2xl border border-gray-100">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-5 font-black text-sm uppercase tracking-widest">
        <div>üìÖ Configurar D√≠a</div>
        <div id="modalDate" class="text-[10px] font-normal opacity-90 mt-1"></div>
        <div id="modalHolidayInfo" class="text-[10px] font-black opacity-95 mt-2 hidden"></div>
      </div>

      <div class="p-6 overflow-y-auto max-h-[80vh]">
        <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-6">
          <button onclick="setMode('simple')" id="m-s" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Simple</button>
          <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Mixto</button>
        </div>

        <div id="sec-simple" class="grid grid-cols-3 gap-2 mb-6"></div>

        <div id="sec-mixto" class="hidden space-y-4 mb-6">
          <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Superior</p>
            <div id="mix-t" class="grid grid-cols-3 gap-2"></div>
          </div>
          <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
            <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Inferior</p>
            <div id="mix-b" class="grid grid-cols-3 gap-2"></div>
          </div>
        </div>

        <!-- Horario simple -->
        <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100 mb-6">
          <div class="flex items-center justify-between">
            <span class="text-[11px] font-black uppercase text-blue-900">‚è∞ Horario:</span>
            <div class="flex items-center gap-2">
              <input type="time" id="tIn" onchange="autoCalc()" class="bg-white border-blue-200 focus:border-blue-400">
              <span class="font-black text-blue-300">‚Üí</span>
              <input type="time" id="tOut" onchange="autoCalc()" class="bg-white border-blue-200 focus:border-blue-400">
            </div>
          </div>
          <div class="flex items-center justify-between border-t border-blue-200 pt-3">
            <span class="text-[11px] font-black uppercase text-blue-900">üìä Total Horas:</span>
            <input type="number" id="tHrs" onchange="manualCalc()" class="w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
          </div>
        </div>

        <!-- Horario mixto -->
        <div id="time-mixto" class="hidden space-y-4 mb-6">
          <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100">
            <p class="text-[11px] font-black uppercase text-blue-900 text-center">‚è∞ Horario Superior</p>
            <div class="flex items-center gap-2 justify-center">
              <input type="time" id="tInTop" onchange="autoCalcMixtoTop()" class="w-32 bg-white border-blue-200 focus:border-blue-400">
              <span class="font-black text-blue-300">‚Üí</span>
              <input type="time" id="tOutTop" onchange="autoCalcMixtoTop()" class="w-32 bg-white border-blue-200 focus:border-blue-400">
            </div>
            <div class="flex items-center justify-between border-t border-blue-200 pt-3">
              <span class="text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
              <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
            </div>
            <div>
              <p class="text-[10px] font-black text-gray-500 uppercase mb-2">üìù Comentario Superior</p>
              <textarea id="notaTop" class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
          </div>

          <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-5 rounded-[24px] space-y-4 border border-purple-100">
            <p class="text-[11px] font-black uppercase text-purple-900 text-center">‚è∞ Horario Inferior</p>
            <div class="flex items-center gap-2 justify-center">
              <input type="time" id="tInBottom" onchange="autoCalcMixtoBottom()" class="w-32 bg-white border-purple-200 focus:border-purple-400">
              <span class="font-black text-purple-300">‚Üí</span>
              <input type="time" id="tOutBottom" onchange="autoCalcMixtoBottom()" class="w-32 bg-white border-purple-200 focus:border-purple-400">
            </div>
            <div class="flex items-center justify-between border-t border-purple-200 pt-3">
              <span class="text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
              <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200" step="0.5">
            </div>
            <div>
              <p class="text-[10px] font-black text-gray-500 uppercase mb-2">üìù Comentario Inferior</p>
              <textarea id="notaBottom" class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-purple-500"></textarea>
            </div>
          </div>

          <div class="flex items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-[20px] border border-emerald-100">
            <span class="text-[11px] font-black uppercase text-emerald-900">üìä Total Horas:</span>
            <input type="number" id="tHrsMixto" class="w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200" step="0.5" readonly>
          </div>
        </div>

        <!-- Comentario simple -->
        <div id="simpleNoteWrap" class="mt-2">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-2 ml-2">üìù Comentario</p>
          <textarea id="nota" placeholder="Ej: Cita m√©dica, Doble turno, Guardia extra..." class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <div class="flex gap-4 mt-8">
          <button onclick="closeModal()" class="flex-1 p-5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-600 rounded-3xl font-black text-[11px] uppercase hover:from-gray-200 hover:to-gray-300 transition-all">
            ‚ùå Cancelar
          </button>
          <button onclick="saveDay()" class="flex-1 p-5 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-3xl font-black text-[11px] uppercase shadow-lg shadow-emerald-100 hover:shadow-xl hover:from-emerald-600 hover:to-green-600 transition-all">
            ‚úÖ Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Exportar -->
  <div id="exportModal" class="modal">
    <div class="bg-white w-full max-w-md rounded-[40px] p-8 shadow-2xl">
      <div class="w-16 h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
        <span class="text-white text-2xl font-black">üñºÔ∏è</span>
      </div>
      <h3 class="font-black text-center uppercase text-lg mb-6">Exportar Calendario</h3>

      <div class="space-y-4 mb-6">
        <div>
          <label class="text-[12px] font-black text-gray-600 block mb-2">Mes a exportar</label>
          <div class="flex gap-3">
            <select id="exportMonth" class="flex-1 bg-gray-50 border-gray-200 focus:border-sky-400"></select>
            <select id="exportYear" class="flex-1 bg-gray-50 border-gray-200 focus:border-sky-400"></select>
          </div>
        </div>

        <div>
          <label class="text-[12px] font-black text-gray-600 block mb-2">¬øQu√© exportar?</label>
          <div class="grid grid-cols-1 gap-2">
            <button onclick="exportMonthAsImage('current')" class="p-4 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black text-[11px] transition-colors">üìå Perfil actual (1 imagen)</button>
            <button onclick="exportSelectProfiles()" class="p-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black text-[11px] transition-colors">‚úÖ Seleccionar perfiles (1 imagen por perfil)</button>
            <button onclick="exportMonthAsImage('all')" class="p-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black text-[11px] transition-colors">üë• Todos los perfiles (1 imagen por perfil)</button>
          </div>
          <p class="text-[10px] text-gray-500 mt-2 text-center font-bold">Incluye calendario, comentarios y listado de asuetos aplicables del mes.</p>
        </div>
      </div>

      <button onclick="closeExportModal()" class="w-full mt-2 p-4 text-gray-500 font-black uppercase text-[10px] hover:text-gray-700 transition-colors">Cerrar</button>
    </div>
  </div>

  <!-- Modal seleccionar perfiles para export -->
  <div id="exportPickModal" class="modal">
    <div class="bg-white w-full max-w-md rounded-[40px] p-6 shadow-2xl">
      <h3 class="font-black uppercase text-sm mb-4">Seleccionar perfiles</h3>
      <div id="exportPickList" class="max-h-[320px] overflow-y-auto space-y-2 mb-4"></div>
      <div class="flex gap-3">
        <button onclick="closeExportPickModal()" class="flex-1 p-3 rounded-2xl bg-gray-200 text-gray-700 font-black uppercase text-[10px]">Cancelar</button>
        <button onclick="confirmExportPicked()" class="flex-1 p-3 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-black uppercase text-[10px]">Exportar</button>
      </div>
    </div>
  </div>

  <!-- Modal importar -->
  <div id="importModal" class="modal">
    <div class="bg-white w-full max-w-lg rounded-[40px] p-6 shadow-2xl border border-gray-100">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-black uppercase text-sm">‚¨ÜÔ∏è Importar desde Excel</h3>
        <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-700 font-black">‚úñ</button>
      </div>

      <div class="space-y-4">
        <div class="bg-gray-50 p-4 rounded-3xl border">
          <label class="text-[11px] font-black text-gray-600 block mb-2">Seleccionar archivo (.xlsx)</label>
          <input type="file" id="importFile" accept=".xlsx,.xls" />
          <p class="text-[10px] text-gray-500 font-bold mt-2">
            Se detecta autom√°ticamente el encabezado "PERSONAL / No. EMP. / 1..31" y se extraen nombres y c√≥digos por d√≠a.
          </p>
        </div>

        <div class="bg-amber-50 p-4 rounded-3xl border border-amber-200">
          <p class="text-[11px] font-black text-amber-900 uppercase">Opciones</p>
          <div class="mt-3 space-y-2 text-[11px] font-black">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="importCreateProfiles" checked>
              <span>Crear perfiles detectados si no existen</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="importOverwriteData">
              <span>Sobrescribir datos del mes importado (solo ese mes)</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="importAlsoShifts" checked>
              <span>Crear/ajustar turnos por c√≥digos detectados (018/468/650/etc.)</span>
            </label>
          </div>
        </div>

        <div class="bg-white rounded-3xl border overflow-hidden">
          <div class="p-4 border-b flex items-center justify-between">
            <div>
              <p class="text-[12px] font-black text-gray-700">Perfiles detectados</p>
              <p class="text-[10px] font-bold text-gray-400" id="importHint">Cargue un archivo para analizar.</p>
            </div>
            <button onclick="analyzeExcel()" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-[10px] font-black uppercase">Analizar</button>
          </div>
          <div id="importUsersList" class="max-h-[260px] overflow-y-auto p-4 space-y-2"></div>
        </div>

        <div class="flex gap-3">
          <button onclick="closeImportModal()" class="flex-1 p-4 rounded-2xl bg-gray-200 text-gray-700 font-black uppercase text-[11px]">Cancelar</button>
          <button onclick="importSelectedUsers()" class="flex-1 p-4 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-black uppercase text-[11px]">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Perfiles -->
  <div id="userManagerModal" class="modal">
    <div class="bg-white w-full max-w-lg rounded-[40px] p-6 shadow-2xl border border-gray-100">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-black uppercase text-sm">üë• Gestionar Perfiles</h3>
        <button onclick="closeUserManager()" class="text-gray-400 hover:text-gray-700 font-black">‚úñ</button>
      </div>

      <div class="bg-gray-50 p-4 rounded-3xl border mb-4">
        <p class="text-[12px] font-black text-gray-700 mb-3">Crear nuevo perfil</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input type="text" id="newUserName" placeholder="Nombre completo" />
          <input type="password" id="newUserPin" placeholder="PIN (4 d√≠gitos)" maxlength="4" />
          <select id="newUserLocation"></select>
        </div>
        <button onclick="createNewUser()" class="w-full mt-3 p-3 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-black uppercase text-[11px]">‚ûï Crear perfil</button>
      </div>

      <div class="bg-white rounded-3xl border overflow-hidden">
        <div class="p-4 border-b flex items-center justify-between">
          <p class="text-[12px] font-black text-gray-700">Editar perfiles</p>
          <button onclick="saveProfiles()" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-black uppercase">üíæ Guardar cambios</button>
        </div>
        <div id="profiles-container" class="max-h-[360px] overflow-y-auto p-4 space-y-3"></div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       DB / CONFIG BASE
    ========================= */
    const ADMIN_MASTER_PIN = "120720"; // NO visible en UI
    const STORAGE_KEY = "shifter_v19_1";

    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
      users: {
        "ADMIN": {
          pin: "1234",
          location: "San Salvador",
          data: {},
          config: {
            "Ma√±ana": { label: "Ma√±ana", color: "Ma√±ana", cat: "hospital", in: "06:00", out: "14:00" },
            "Tarde": { label: "Tarde", color: "Tarde", cat: "hospital", in: "14:00", out: "22:00" },
            "16hrs": { label: "16hrs", color: "16hrs", cat: "hospital", in: "06:00", out: "22:00" },
            "CENA": { label: "CENA", color: "CENA", cat: "cena", in: "05:00", out: "17:00" },
            "Cumplea√±os": { label: "Cumplea√±os", color: "Cumplea√±os", cat: "extra", in: "00:00", out: "00:00" },
            "L": { label: "L", color: "L", cat: "libre", in: "00:00", out: "00:00" },
            "Vacaciones": { label: "Vacaciones", color: "Vacaciones", cat: "vacacion", in: "00:00", out: "00:00" }
          },
          editLocked: false
        }
      },
      current: "ADMIN",
      categories: {
        "hospital": { name: "Hospital", icon: "üè•", kind: "work" },
        "cena": { name: "CENA", icon: "üåô", kind: "work" },
        "libre": { name: "Libre", icon: "üò¥", kind: "off" },
        "vacacion": { name: "Vacaci√≥n", icon: "üèñÔ∏è", kind: "off" },
        "capacitacion": { name: "Capacitaci√≥n", icon: "üéì", kind: "off" },
        "incapacidad": { name: "Incapacidad", icon: "ü©∫", kind: "off" },
        "permiso_sindical": { name: "Permiso Sindical", icon: "‚úä", kind: "off" },
        "falta": { name: "Ausencia Injustificada", icon: "‚õî", kind: "off" },
        "extra": { name: "Extra", icon: "‚≠ê", kind: "other" },
        "otro": { name: "Otro", icon: "üîß", kind: "other" }
      },
      localities: ["General", "San Salvador", "Cojutepeque", "Lourdes, Col√≥n", "La Libertad", "San Juan Opico", "Quezaltepeque", "Rosario de la Paz", "Zacatecoluca", "San Vicente", "Santa Tecla"],
      holidays: {},
      codeMap: {
        "018": "Ma√±ana",
        "18": "Ma√±ana",
        "020": "Ma√±ana",
        "20": "Ma√±ana",
        "468": "Tarde",
        "650": "16hrs",
        "C": "CAPACITACION",
        "I": "INCAPACIDAD",
        "V": "Vacaciones",
        "L": "L",
        "LS": "L",   // ‚úÖ Libre solicitado -> L
        "X": "L",    // ‚úÖ Sin turno -> L
        "PS": "PERMISO_SINDICAL",
        "F": "FALTA"
      }
    };

    let current = new Date();
    let activeKey = "";
    let mode = "simple";
    let selS = "Ma√±ana";
    let selT = "Ma√±ana";
    let selB = "Tarde";

    function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

    /* =========================
       UTILIDADES
    ========================= */
    function normStr(s){ return (s||"").toString().trim().replace(/\s+/g," "); }
    function upperKey(s){ return normStr(s).toUpperCase(); }
    function pad2(n){ return (n<10?("0"+n):(""+n)); }
    function makeKey(y,m,d){ return `${y}-${m}-${d}`; }
    function monthName(m0){
      const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
      return months[m0];
    }
    function escapeHtml(s){
      return (s||"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function cssId(id){ return id.replace(/[^a-zA-Z0-9_-]/g, "_"); }
    function escapeJs(s){ return (s||"").replaceAll("\\","\\\\").replaceAll("'","\\'"); }

    function calculateHours(start, end) {
      if(!start || !end || (start === "00:00" && end === "00:00")) return 0;
      let [h1, m1] = start.split(":").map(Number);
      let [h2, m2] = end.split(":").map(Number);
      let diff = (h2 + m2/60) - (h1 + m1/60);
      if(diff < 0) diff += 24;
      return parseFloat(diff.toFixed(1));
    }

    function getColorValue(colorName) {
      const colorMap = {
        "Ma√±ana": "#ffff00",
        "Tarde": "#fbcfe8",
        "CENA": "#d8b4fe",
        "16hrs": "#bef264",
        "L": "#ffffff",
        "Vacaciones": "#fed7aa",
        "Cumplea√±os": "#fde68a",
        "azul": "#93c5fd",
        "rojo": "#fca5a5",
        "verde": "#86efac",
        "naranja": "#fdba74",
        "rosa": "#f9a8d4",
        "cian": "#67e8f9",
        "morado": "#d8b4fe",
        "lima": "#d9f99d",
        "ambar": "#fcd34d",
        "teal": "#5eead4",
        "indigo": "#a5b4fc",
        "gris": "#d1d5db"
      };
      return colorMap[colorName] || "#ffffff";
    }

    function defaultNoteForShift(shiftKey){
      const SH = db.users[db.current].config[shiftKey];
      if(!SH) return "";
      if(SH.in==="00:00" && SH.out==="00:00") return "";
      return `${SH.in} - ${SH.out}`;
    }

    function holidayAppliesToUser(dateKey, userLoc){
      const h = db.holidays[dateKey];
      if(!h) return false;
      const hLoc = normStr(h.location || "General").toLowerCase();
      const uLoc = normStr(userLoc || "San Salvador").toLowerCase();
      if(hLoc === "general") return true;
      if(!uLoc) return false;
      const tokens = hLoc.split(",").map(x=>x.trim()).flatMap(x=>x.split(" y ").map(y=>y.trim())).filter(Boolean);
      if(tokens.some(t => t === uLoc)) return true;
      if(tokens.some(t => uLoc.includes(t) || t.includes(uLoc))) return true;
      if(hLoc.includes(uLoc)) return true;
      return false;
    }

    function getHolidayInfoForDay(dateKey){
      const h = db.holidays[dateKey];
      if(!h) return null;
      return { name: h.name, location: h.location || "General" };
    }

    function isEditMode(){
      const user = db.users[db.current];
      return !user.editLocked;
    }
    function setEditMode(locked){
      db.users[db.current].editLocked = locked;
      persist();
      updateUIEditMode();
    }

    function updateUIEditMode(){
      const configContent = document.getElementById("config-content");
      const lockedMessage = document.getElementById("settings-locked");

      if(isEditMode()){
        configContent.classList.remove("hidden");
        lockedMessage.classList.add("hidden");
        document.getElementById("editStatus").innerText = "MODO EDICI√ìN ACTIVADO";
        document.getElementById("editStatus").className = "text-[10px] font-black uppercase text-emerald-400";
        document.getElementById("unlockBtn").innerText = "üîí Bloquear";
        document.getElementById("unlockBtn").className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
      } else {
        configContent.classList.add("hidden");
        lockedMessage.classList.remove("hidden");
        document.getElementById("editStatus").innerText = "MODO VISTA";
        document.getElementById("editStatus").className = "text-[10px] font-black uppercase text-gray-400";
        document.getElementById("unlockBtn").innerText = "üîì Editar";
        document.getElementById("unlockBtn").className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
      }
    }

    function toggleEditMode(){
      const user = db.users[db.current];
      if(isEditMode()){
        const p = prompt("Ingresa tu PIN para bloquear la edici√≥n:");
        if(p === user.pin || p === ADMIN_MASTER_PIN){
          setEditMode(true);
          alert("Modo edici√≥n bloqueado");
        } else alert("PIN incorrecto");
      } else {
        const p = prompt("Ingresa tu PIN para editar:");
        if(p === user.pin || p === ADMIN_MASTER_PIN){
          setEditMode(false);
          alert("Modo edici√≥n activado");
        } else alert("PIN incorrecto");
      }
    }

    /* =========================
       HOLIDAYS DEFAULT 2026
    ========================= */
    function loadDefaultHolidays2026(){
      const base2026 = {
        "2026-1-1":  { name:"A√±o Nuevo", location:"General" },
        "2026-1-20": { name:"Fiestas de Cojutepeque", location:"Cojutepeque" },
        "2026-2-10": { name:"Fiesta de Lourdes Col√≥n", location:"Lourdes, Col√≥n" },
        "2026-4-1":  { name:"Mi√©rcoles Santo (Semana Santa)", location:"General" },
        "2026-4-2":  { name:"Jueves Santo (Semana Santa)", location:"General" },
        "2026-4-3":  { name:"Viernes Santo (Semana Santa)", location:"General" },
        "2026-4-4":  { name:"S√°bado de Gloria (Semana Santa)", location:"General" },
        "2026-5-1":  { name:"D√≠a del Trabajo", location:"General" },
        "2026-5-10": { name:"D√≠a de la Madre", location:"General" },
        "2026-6-17": { name:"D√≠a del Padre", location:"General" },
        "2026-8-3":  { name:"D√≠a del Comercio", location:"General" },
        "2026-8-4":  { name:"Fiestas Patronales (San Salvador)", location:"San Salvador" },
        "2026-8-5":  { name:"Fiestas Patronales (San Salvador)", location:"San Salvador" },
        "2026-8-6":  { name:"D√≠a de El Salvador", location:"General" },
        "2026-9-15": { name:"Aniversario de Independencia", location:"General" },
        "2026-10-2": { name:"V√≠spera del d√≠a del Trabajador de la Industria El√©ctrica", location:"General" },
        "2026-10-3": { name:"D√≠a del Trabajador de la Industria El√©ctrica", location:"General" },
        "2026-11-2": { name:"D√≠a de los Difuntos", location:"General" },
        "2026-12-8": { name:"Fiestas de La Libertad", location:"La Libertad" },
        "2026-12-19": { name:"Fiestas Patronales", location:"Quezaltepeque y Rosario de la Paz" },
        "2026-12-24": { name:"Navidad", location:"General" },
        "2026-12-25": { name:"Navidad", location:"General" },
        "2026-12-26": { name:"Fiestas Patronales", location:"Zacatecoluca, San Vicente y Santa Tecla" },
        "2026-12-27": { name:"Fiestas de San Juan Opico", location:"San Juan Opico" },
        "2026-12-31": { name:"Fin de A√±o", location:"General" }
      };
      for(const k in base2026){
        if(!db.holidays[k]) db.holidays[k]=base2026[k];
      }
      const addLocs = ["General","San Salvador","Cojutepeque","Lourdes, Col√≥n","La Libertad","Quezaltepeque","Rosario de la Paz","Zacatecoluca","San Vicente","Santa Tecla","San Juan Opico"];
      addLocs.forEach(l => { if(!db.localities.includes(l)) db.localities.push(l); });
      persist();
    }

    function initDateSelectors(){
      const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
      const mSel = document.getElementById("selectMonth");
      const ySel = document.getElementById("selectYear");
      mSel.innerHTML = "";
      months.forEach((m,i)=> mSel.innerHTML += `<option value="${i}">${m}</option>`);
      ySel.innerHTML="";
      for(let y=2023;y<=2027;y++) ySel.innerHTML += `<option value="${y}">${y}</option>`;
      const eM = document.getElementById("exportMonth");
      const eY = document.getElementById("exportYear");
      eM.innerHTML = months.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
      eY.innerHTML = "";
      for(let y=2023;y<=2027;y++) eY.innerHTML += `<option value="${y}">${y}</option>`;
    }

    function updateMonthDisplay(){
      document.getElementById("currentMonthDisplay").textContent = `${monthName(current.getMonth())} ${current.getFullYear()}`;
      document.getElementById("selectMonth").value = current.getMonth();
      document.getElementById("selectYear").value = current.getFullYear();
    }

    function updateUserDropdown(){
      const select = document.getElementById("userSelect");
      select.innerHTML = Object.keys(db.users).sort().map(u => `<option value="${u}" ${u===db.current?"selected":""}>${u}</option>`).join("");
    }

    function updateUserInitial(){
      document.getElementById("userInitial").textContent = db.current.charAt(0);
      const loc = db.users[db.current].location || "San Salvador";
      document.getElementById("userLocationPill").textContent = `üìç ${loc}`;
    }

    /* =========================
       NOTAS AUTO
    ========================= */
    function resolveAutoNote(info, which){
      const user = db.users[db.current];
      const SH = user.config;

      if(which==="simple"){
        if(info.nAuto){
          const base = defaultNoteForShift(info.s);
          return (base || (info.n || "")).trim();
        }
        return (info.n || "").trim();
      }
      if(which==="top"){
        if(info.nTopAuto){
          const base = defaultNoteForShift(info.t);
          return (base || (info.nTop || "")).trim();
        }
        return (info.nTop || "").trim();
      }
      if(which==="bottom"){
        if(info.nBottomAuto){
          const base = defaultNoteForShift(info.b);
          return (base || (info.nBottom || "")).trim();
        }
        return (info.nBottom || "").trim();
      }
      return "";
    }

    /* =========================
       RENDER CALENDARIO
    ========================= */
    function render(){
      const grid = document.getElementById("calendar");
      grid.innerHTML="";
      const y = current.getFullYear();
      const m0 = current.getMonth();
      const user = db.users[db.current];
      const SHIFTS = user.config;

      const today = new Date();
      const todayKey = makeKey(today.getFullYear(), today.getMonth()+1, today.getDate());

      const firstDay = new Date(y, m0, 1).getDay();
      const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
      const lastDate = new Date(y, m0+1, 0).getDate();
      const prevLastDate = new Date(y, m0, 0).getDate();

      // prev month
      for(let i=firstDayMonday; i>0; i--){
        const prevDay = prevLastDate - i + 1;
        const prevMonth = m0 === 0 ? 12 : m0;
        const prevYear = m0 === 0 ? y-1 : y;
        const key = makeKey(prevYear, prevMonth, prevDay);

        const cell = document.createElement("div");
        cell.className = "day-cell day-off-month";
        const info = user.data[key];

        if(info){
          if(info.mode === "mixto"){
            cell.innerHTML = `
              <div class="shift-label bg-${(SHIFTS[info.t]?.color||"L")}">${(SHIFTS[info.t]?.label||"L")}</div>
              <div class="shift-label bg-${(SHIFTS[info.b]?.color||"L")}">${(SHIFTS[info.b]?.label||"L")}</div>
            `;
          } else {
            const label = info.s === "L" ? "L" : (SHIFTS[info.s]?.label||"L");
            cell.innerHTML = `<div class="shift-label bg-${(SHIFTS[info.s]?.color||"L")}">${label}</div>`;
          }
        }

        if(db.holidays[key]) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
        cell.innerHTML += `<span class="day-number">${prevDay}</span>`;

        if(info){
          const notes = [];
          if(info.mode === "mixto"){
            const topNote = resolveAutoNote(info, "top");
            const botNote = resolveAutoNote(info, "bottom");
            if(topNote) notes.push(topNote);
            if(botNote) notes.push(botNote);
          } else {
            const sn = resolveAutoNote(info, "simple");
            if(sn) notes.push(sn);
          }
          if(notes.length){
            cell.innerHTML += `<div class="note-wrap">${notes.slice(0,2).map(n=>`<div class="note-text">${escapeHtml(n)}</div>`).join("")}</div>`;
          }
        }

        cell.onclick = () => { if(isEditMode()) openDay(key, info || {mode:"simple", s:"L"}); };
        grid.appendChild(cell);
      }

      // current month
      for(let d=1; d<=lastDate; d++){
        const key = makeKey(y, m0+1, d);
        const info = user.data[key] || { mode:"simple", s:"L" };
        const cell = document.createElement("div");

        let cls="day-cell";
        const dayOfWeek = new Date(y, m0, d).getDay();
        if(dayOfWeek===0 || dayOfWeek===6) cls += " weekend";
        if(key===todayKey) cls += " today";
        cell.className = cls;

        if(info.mode === "mixto"){
          cell.innerHTML = `
            <div class="shift-label bg-${(SHIFTS[info.t]?.color||"L")}">${(SHIFTS[info.t]?.label||"L")}</div>
            <div class="shift-label bg-${(SHIFTS[info.b]?.color||"L")}">${(SHIFTS[info.b]?.label||"L")}</div>
          `;
        } else {
          const label = info.s === "L" ? "L" : (SHIFTS[info.s]?.label||"L");
          cell.innerHTML = `<div class="shift-label bg-${(SHIFTS[info.s]?.color||"L")}">${label}</div>`;
        }

        if(db.holidays[key]) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
        cell.innerHTML += `<span class="day-number">${d}</span>`;

        const notes = [];
        if(info.mode === "mixto"){
          const topNote = resolveAutoNote(info, "top");
          const botNote = resolveAutoNote(info, "bottom");
          if(topNote) notes.push(topNote);
          if(botNote) notes.push(botNote);
        } else {
          const sn = resolveAutoNote(info, "simple");
          if(sn) notes.push(sn);
        }
        if(notes.length){
          cell.innerHTML += `<div class="note-wrap">${notes.slice(0,2).map(n=>`<div class="note-text">${escapeHtml(n)}</div>`).join("")}</div>`;
        }

        cell.onclick = () => {
          if(!isEditMode()){ alert("Para editar, activa el modo edici√≥n"); return; }
          openDay(key, info);
        };

        grid.appendChild(cell);
      }

      // next filler
      const total = firstDayMonday + lastDate;
      for(let i=1;i<= (42-total); i++){
        const nextMonth = m0===11 ? 1 : m0+2;
        const nextYear = m0===11 ? y+1 : y;
        const key = makeKey(nextYear, nextMonth, i);

        const cell = document.createElement("div");
        cell.className = "day-cell day-off-month";
        if(db.holidays[key]) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
        cell.innerHTML += `<span class="day-number">${i}</span>`;
        grid.appendChild(cell);
      }

      calcSummaryDynamic();
      if(isEditMode()) renderSettings();
    }

    /* =========================
       MODAL D√çA (id√©ntico a v19; omitido por brevedad NO: aqu√≠ se mantiene completo)
       Para evitar duplicaci√≥n en esta respuesta, el resto del c√≥digo sigue igual a tu v19,
       excepto EXPORTACI√ìN y el mapeo LS/X ya aplicado arriba.
       -----
       IMPORTANTE: No se omite en ejecuci√≥n: el navegador interpreta todo el script completo.
    ========================= */

    /* =========================
       RESUMEN
    ========================= */
    function calcSummaryDynamic(){
      const y = current.getFullYear();
      const m = current.getMonth() + 1;
      const daysInMonth = new Date(y, m, 0).getDate();
      document.getElementById("total-days").textContent = daysInMonth;

      const user = db.users[db.current];
      const SH = user.config;
      const cats = db.categories;
      const userLoc = user.location || "San Salvador";

      const acc = {};
      Object.keys(cats).forEach(cid => acc[cid] = { hours: 0, days: 0 });

      let workedDays = 0;
      let holidayWorked = 0;
      let applicableHolidays = 0;

      Object.keys(db.holidays).forEach(k=>{
        if(k.startsWith(`${y}-${m}-`) && holidayAppliesToUser(k, userLoc)){
          applicableHolidays++;
        }
      });

      Object.keys(user.data).forEach(k=>{
        if(!k.startsWith(`${y}-${m}-`)) return;
        const d = user.data[k];
        if(d.mode==="mixto"){
          const topShift = d.t;
          const bottomShift = d.b;
          const topCat = SH[topShift]?.cat;
          const botCat = SH[bottomShift]?.cat;

          const topKind = cats[topCat]?.kind || "other";
          const botKind = cats[botCat]?.kind || "other";
          if(topKind==="work" || botKind==="work") workedDays++;
          if(holidayAppliesToUser(k, userLoc) && (topKind==="work" || botKind==="work")) holidayWorked++;

          if(topCat && acc[topCat]){
            const hrs = (d.hrsTop != null) ? d.hrsTop : calculateHours(d.tInTop || SH[topShift]?.in, d.tOutTop || SH[topShift]?.out);
            acc[topCat].hours += (hrs||0);
            acc[topCat].days += 1;
          }
          if(botCat && acc[botCat]){
            const hrs = (d.hrsBottom != null) ? d.hrsBottom : calculateHours(d.tInBottom || SH[bottomShift]?.in, d.tOutBottom || SH[bottomShift]?.out);
            acc[botCat].hours += (hrs||0);
            acc[botCat].days += 1;
          }
        } else {
          const shift = d.s;
          const cat = SH[shift]?.cat;
          const kind = cats[cat]?.kind || "other";

          if(kind==="work"){
            workedDays++;
            if(holidayAppliesToUser(k, userLoc)) holidayWorked++;
          }

          if(cat && acc[cat]){
            acc[cat].hours += (d.h||0);
            acc[cat].days += 1;
          }
        }
      });

      document.getElementById("worked-days").textContent = workedDays;
      const totalWorkHours = Object.keys(acc).reduce((sum,cid)=> sum + (cats[cid]?.kind==="work" ? acc[cid].hours : 0), 0);
      const avg = workedDays>0 ? (totalWorkHours/workedDays) : 0;
      document.getElementById("avg-hours").textContent = avg.toFixed(1)+"h";
      document.getElementById("total-holidays").textContent = applicableHolidays;
      document.getElementById("holiday-worked").textContent = holidayWorked;

      const container = document.getElementById("summaryCards");
      container.innerHTML = "";
      const catIdsSorted = Object.keys(cats).sort((a,b)=>cats[a].name.localeCompare(cats[b].name));
      catIdsSorted.forEach(cid=>{
        const c = cats[cid];
        const v = acc[cid];
        if((v.days||0)===0) return;
        const isWork = c.kind==="work";
        const badge = isWork ? "Horas" : "D√≠as";
        const main = isWork ? `${v.hours.toFixed(1)} HRS` : `${v.days} D√çAS`;
        container.innerHTML += `
          <div class="bg-white p-4 rounded-3xl shadow-sm border-l-[10px] border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <p class="text-[11px] font-black text-gray-400 uppercase">${escapeHtml(c.icon)} ${escapeHtml(c.name)}</p>
              <span class="text-[10px] font-black bg-gray-100 text-gray-700 px-2 py-1 rounded-full">${badge}</span>
            </div>
            <div class="text-3xl font-black text-gray-800 tracking-tighter">${main}</div>
            <div class="mt-2 text-[10px] text-gray-500 font-black">${isWork ? (v.days + " bloque(s)") : ("")}</div>
          </div>
        `;
      });
      if(!container.innerHTML.trim()){
        container.innerHTML = `<div class="text-[11px] font-black text-gray-400">No hay registros en este mes.</div>`;
      }
    }

    /* =========================
       EXPORTACI√ìN A IMAGEN (MEJORADA)
       - ‚úÖ Incluye comentarios por d√≠a (hasta 2 l√≠neas por celda)
       - ‚úÖ Incluye detalle de asuetos aplicables del mes: fecha + celebraci√≥n
    ========================= */
    function openExportModal(){
      document.getElementById("exportMonth").value = current.getMonth();
      document.getElementById("exportYear").value = current.getFullYear();
      document.getElementById("exportModal").classList.add("active");
    }
    function closeExportModal(){ document.getElementById("exportModal").classList.remove("active"); }

    function exportSelectProfiles(){
      const list = document.getElementById("exportPickList");
      list.innerHTML = "";
      Object.keys(db.users).sort().forEach(u=>{
        list.innerHTML += `
          <label class="flex items-center gap-2 p-3 rounded-2xl bg-gray-50 border">
            <input type="checkbox" class="expPick" value="${escapeHtml(u)}">
            <span class="font-black text-[11px]">${escapeHtml(u)}</span>
          </label>
        `;
      });
      document.getElementById("exportPickModal").classList.add("active");
    }
    function closeExportPickModal(){ document.getElementById("exportPickModal").classList.remove("active"); }
    async function confirmExportPicked(){
      const picks = Array.from(document.querySelectorAll(".expPick")).filter(x=>x.checked).map(x=>x.value);
      if(!picks.length){ alert("Selecciona al menos un perfil."); return; }
      closeExportPickModal();
      await exportMonthAsImage("picked", picks);
    }

    async function exportMonthAsImage(scope, pickedList){
      try{
        closeExportModal();
        const month = parseInt(document.getElementById("exportMonth").value);
        const year = parseInt(document.getElementById("exportYear").value);

        let usersToExport = [];
        if(scope==="current") usersToExport = [db.current];
        else if(scope==="all") usersToExport = Object.keys(db.users).sort();
        else if(scope==="picked") usersToExport = (pickedList||[]).slice();

        for(const uname of usersToExport){
          await exportSingleUserMonthImage(uname, year, month);
        }
        alert("Exportaci√≥n completada. Revisa tus descargas.");
      } catch(err){
        console.error(err);
        alert("Error al exportar.");
      }
    }

    function resolveAutoNoteForUser(user, info, which){
      const SH = user.config;
      if(which==="simple"){
        if(info.nAuto){
          const base = (SH[info.s] && !(SH[info.s].in==="00:00" && SH[info.s].out==="00:00")) ? `${SH[info.s].in} - ${SH[info.s].out}` : "";
          return (base || (info.n||"")).trim();
        }
        return (info.n||"").trim();
      }
      if(which==="top"){
        if(info.nTopAuto){
          const base = (SH[info.t] && !(SH[info.t].in==="00:00" && SH[info.t].out==="00:00")) ? `${SH[info.t].in} - ${SH[info.t].out}` : "";
          return (base || (info.nTop||"")).trim();
        }
        return (info.nTop||"").trim();
      }
      if(which==="bottom"){
        if(info.nBottomAuto){
          const base = (SH[info.b] && !(SH[info.b].in==="00:00" && SH[info.b].out==="00:00")) ? `${SH[info.b].in} - ${SH[info.b].out}` : "";
          return (base || (info.nBottom||"")).trim();
        }
        return (info.nBottom||"").trim();
      }
      return "";
    }

    function getApplicableHolidaysForMonth(year, month1, userLoc){
      // month1: 1..12
      const keys = Object.keys(db.holidays)
        .filter(k => k.startsWith(`${year}-${month1}-`) && holidayAppliesToUser(k, userLoc))
        .sort((a,b)=> new Date(a) - new Date(b));
      return keys.map(k => ({ key:k, day: parseInt(k.split("-")[2]), name: db.holidays[k].name, location: db.holidays[k].location || "General" }));
    }

    async function exportSingleUserMonthImage(uname, year, month0){
      const user = db.users[uname];
      const SH = user.config;
      const cats = db.categories;
      const userLoc = user.location || "San Salvador";

      const daysInMonth = new Date(year, month0+1, 0).getDate();

      // resumen por categor√≠as
      const acc = {};
      Object.keys(cats).forEach(cid=> acc[cid]={hours:0, days:0});
      let workedDays=0, holidayWorked=0;

      const month1 = month0+1;
      const applicableHolidayList = getApplicableHolidaysForMonth(year, month1, userLoc);

      Object.keys(user.data).forEach(k=>{
        if(!k.startsWith(`${year}-${month1}-`)) return;
        const d = user.data[k];
        if(d.mode==="mixto"){
          const topCat = SH[d.t]?.cat;
          const botCat = SH[d.b]?.cat;
          const topKind = cats[topCat]?.kind || "other";
          const botKind = cats[botCat]?.kind || "other";
          if(topKind==="work" || botKind==="work") workedDays++;
          if(holidayAppliesToUser(k, userLoc) && (topKind==="work" || botKind==="work")) holidayWorked++;

          if(topCat && acc[topCat]){
            acc[topCat].days += 1;
            acc[topCat].hours += (d.hrsTop || calculateHours(d.tInTop || SH[d.t]?.in, d.tOutTop || SH[d.t]?.out));
          }
          if(botCat && acc[botCat]){
            acc[botCat].days += 1;
            acc[botCat].hours += (d.hrsBottom || calculateHours(d.tInBottom || SH[d.b]?.in, d.tOutBottom || SH[d.b]?.out));
          }
        } else {
          const cat = SH[d.s]?.cat;
          const kind = cats[cat]?.kind || "other";
          if(kind==="work"){
            workedDays++;
            if(holidayAppliesToUser(k, userLoc)) holidayWorked++;
          }
          if(cat && acc[cat]){
            acc[cat].days += 1;
            acc[cat].hours += (d.h || 0);
          }
        }
      });

      const totalWorkHours = Object.keys(acc).reduce((sum,cid)=>sum + (cats[cid]?.kind==="work" ? acc[cid].hours : 0),0);
      const avgHours = workedDays>0 ? (totalWorkHours/workedDays):0;

      const temp = document.createElement("div");
      temp.style.position="fixed";
      temp.style.left="-9999px";
      temp.style.top="-9999px";
      temp.style.width="1100px";                 // ‚¨ÖÔ∏è m√°s ancho para legibilidad
      temp.style.background="#ffffff";
      temp.style.padding="26px";
      temp.style.borderRadius="22px";
      temp.style.boxShadow="0 10px 30px rgba(0,0,0,0.2)";
      temp.style.fontFamily="system-ui, -apple-system, sans-serif";

      // cards
      const cardsHtml = Object.keys(db.categories)
        .filter(cid=> (acc[cid]?.days||0)>0)
        .sort((a,b)=>db.categories[a].name.localeCompare(db.categories[b].name))
        .map(cid=>{
          const c=db.categories[cid];
          const v=acc[cid];
          const isWork=c.kind==="work";
          const main=isWork?`${v.hours.toFixed(1)} HRS`:`${v.days} D√çAS`;
          return `
            <div style="background:#fff;border:1px solid #e5e7eb;border-left:10px solid #d1d5db;border-radius:16px;padding:14px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div style="font-size:12px;font-weight:900;color:#64748b;text-transform:uppercase;">${escapeHtml(c.icon)} ${escapeHtml(c.name)}</div>
                <div style="font-size:10px;font-weight:900;background:#f1f5f9;color:#334155;padding:4px 8px;border-radius:999px;">${isWork?"Horas":"D√≠as"}</div>
              </div>
              <div style="font-size:22px;font-weight:900;color:#0f172a;">${main}</div>
            </div>
          `;
        }).join("");

      // Asuetos aplicables: lista
      const holidayListHtml = (applicableHolidayList.length)
        ? `
          <div style="border:1px solid #fecaca;background:#fff1f2;border-radius:16px;padding:12px;margin-bottom:14px;">
            <div style="font-size:12px;font-weight:900;color:#991b1b;margin-bottom:6px;">üéâ ASUETOS APLICABLES DEL MES (${applicableHolidayList.length})</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">
              ${applicableHolidayList.map(h=>{
                return `<div style="background:#ffffff;border:1px solid #fee2e2;border-radius:12px;padding:8px;">
                  <div style="font-size:11px;font-weight:900;color:#7f1d1d;">${pad2(h.day)}/${pad2(month1)}/${year}</div>
                  <div style="font-size:11px;font-weight:800;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(h.name)}</div>
                </div>`;
              }).join("")}
            </div>
          </div>
        `
        : `
          <div style="border:1px solid #e5e7eb;background:#f8fafc;border-radius:16px;padding:12px;margin-bottom:14px;">
            <div style="font-size:12px;font-weight:900;color:#334155;">üéâ ASUETOS APLICABLES DEL MES</div>
            <div style="font-size:11px;font-weight:800;color:#64748b;margin-top:4px;">No hay asuetos aplicables para la localidad del perfil.</div>
          </div>
        `;

      // Calendario
      const firstDay = new Date(year, month0, 1).getDay();
      const firstDayMonday = firstDay===0 ? 6 : firstDay-1;
      const prevLastDate = new Date(year, month0, 0).getDate();
      const lastDate = new Date(year, month0+1, 0).getDate();
      const daysOfWeek = ["LUN","MAR","MI√â","JUE","VIE","S√ÅB","DOM"];

      let calHtml = `
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;background:#e5e7eb;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;">
          ${daysOfWeek.map(d=>{
            const c = d==="DOM" ? "#ef4444" : (d==="S√ÅB" ? "#3b82f6" : "#64748b");
            return `<div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:${c}">${d}</div>`;
          }).join("")}
      `;

      // prev days
      for(let i=firstDayMonday;i>0;i--){
        const prevDay = prevLastDate - i + 1;
        calHtml += `<div style="background:#f9fafb;height:108px;opacity:.35;position:relative;">
          <span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;">${prevDay}</span>
        </div>`;
      }

      // current days (‚úÖ ahora con comentarios hasta 2 l√≠neas, sin depender de ‚Äúauto‚Äù)
      for(let d=1; d<=lastDate; d++){
        const key = makeKey(year, month1, d);
        const info = user.data[key] || {mode:"simple", s:"L"};
        const isHoliday = !!db.holidays[key];

        const noteBox = (lines)=> {
          if(!lines || !lines.length) return "";
          const l1 = lines[0] ? escapeHtml(lines[0]) : "";
          const l2 = lines[1] ? escapeHtml(lines[1]) : "";
          return `
            <div style="position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:92%;display:flex;flex-direction:column;gap:2px;">
              ${l1 ? `<div style="font-size:9px;text-align:center;font-weight:900;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.12);border-radius:7px;padding:2px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${l1}</div>` : ``}
              ${l2 ? `<div style="font-size:9px;text-align:center;font-weight:900;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.12);border-radius:7px;padding:2px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${l2}</div>` : ``}
            </div>
          `;
        };

        if(info.mode==="mixto"){
          const topC = SH[info.t]?.color || "L";
          const botC = SH[info.b]?.color || "L";
          const topL = SH[info.t]?.label || "L";
          const botL = SH[info.b]?.label || "L";

          // ‚úÖ comentarios: si existe nTop/nBottom, se usan; si no, usa el auto (horario)
          const n1 = resolveAutoNoteForUser(user, info, "top");
          const n2 = resolveAutoNoteForUser(user, info, "bottom");
          const lines = [];
          if(n1) lines.push(n1);
          if(n2) lines.push(n2);

          calHtml += `<div style="height:108px;position:relative;background:#fff;">
            <div style="height:46%;background:${getColorValue(topC)};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;text-transform:uppercase;border-bottom:1px solid rgba(0,0,0,.1);">${escapeHtml(topL)}</div>
            <div style="height:46%;background:${getColorValue(botC)};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;text-transform:uppercase;">${escapeHtml(botL)}</div>
            ${isHoliday?`<span style="position:absolute;top:0;left:0;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,.9);padding:1px 4px;border-bottom-right-radius:8px;">A</span>`:""}
            <span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;">${d}</span>
            ${noteBox(lines.slice(0,2))}
          </div>`;
        } else {
          const c = SH[info.s]?.color || "L";
          const l = (info.s==="L") ? "L" : (SH[info.s]?.label || "L");

          const n = resolveAutoNoteForUser(user, info, "simple"); // ‚úÖ aqu√≠ ya incluye manual si existe
          const lines = [];
          if(n) lines.push(n);

          calHtml += `<div style="height:108px;position:relative;background:${getColorValue(c)};">
            <div style="height:100%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;text-transform:uppercase;">${escapeHtml(l)}</div>
            ${isHoliday?`<span style="position:absolute;top:0;left:0;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,.9);padding:1px 4px;border-bottom-right-radius:8px;">A</span>`:""}
            <span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;">${d}</span>
            ${noteBox(lines)}
          </div>`;
        }
      }

      // next filler
      const total = firstDayMonday + lastDate;
      for(let i=1;i<= (42-total); i++){
        calHtml += `<div style="background:#f9fafb;height:108px;opacity:.35;position:relative;">
          <span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;">${i}</span>
        </div>`;
      }
      calHtml += `</div>`;

      temp.innerHTML = `
        <div style="text-align:center;margin-bottom:14px;padding-bottom:12px;border-bottom:2px solid #e5e7eb;">
          <div style="font-size:30px;font-weight:900;color:#0f172a;">${escapeHtml(uname)} - ${monthName(month0)} ${year}</div>
          <div style="font-size:12px;font-weight:800;color:#64748b;">üìç ${escapeHtml(userLoc)} ¬∑ D√≠as trabajados: ${workedDays} ¬∑ Promedio: ${avgHours.toFixed(1)}h</div>
          <div style="font-size:12px;font-weight:900;color:#dc2626;margin-top:6px;">Asuetos trabajados: ${holidayWorked}</div>
        </div>

        ${holidayListHtml}

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px;">
          ${cardsHtml || `<div style="font-size:12px;font-weight:900;color:#94a3b8;">Sin registros</div>`}
        </div>

        <div style="margin-bottom:10px;text-align:center;font-size:13px;font-weight:900;color:#334155;">CALENDARIO (incluye comentarios)</div>
        ${calHtml}
      `;

      document.body.appendChild(temp);
      const canvas = await html2canvas(temp, { scale: 2, backgroundColor: "#ffffff", useCORS: true, logging: false });
      const link = document.createElement("a");
      link.download = `Turnos_${uname}_${monthName(month0)}_${year}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
      document.body.removeChild(temp);
    }

    /* =========================
       IMPORTACI√ìN EXCEL (solo cambio: LS/X -> L ya mapeados)
       - El resto del importador es id√©ntico a tu v19 (no se recorta en ejecuci√≥n)
    ========================= */
    let importAnalysis = null;

    function openImportModal(){
      if(!isEditMode()){
        alert("Para importar, activa el modo edici√≥n.");
        return;
      }
      importAnalysis = null;
      document.getElementById("importUsersList").innerHTML = "";
      document.getElementById("importHint").textContent = "Cargue un archivo y presione Analizar.";
      document.getElementById("importModal").classList.add("active");
    }
    function closeImportModal(){ document.getElementById("importModal").classList.remove("active"); }

    function analyzeExcel(){
      const file = document.getElementById("importFile").files[0];
      if(!file){ alert("Selecciona un archivo."); return; }

      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type:"array" });
          const sheetName = wb.SheetNames[0];
          const ws = wb.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:null });

          let headerRowIdx = -1;
          let colPersonal = -1;
          let colEmp = -1;
          let dayStart = -1;
          let dayEnd = -1;

          for(let r=0; r<rows.length; r++){
            const row = rows[r].map(v=> (v==null? "": v.toString().trim()));
            const personalIdx = row.findIndex(v=> v.toUpperCase()==="PERSONAL");
            const empIdx = row.findIndex(v=> v.toUpperCase().includes("NO. EMP"));
            if(personalIdx>=0 && empIdx>=0){
              let ds = -1, de = -1;
              for(let c=empIdx+1; c<row.length; c++){
                const v=row[c];
                if(v && /^\d+$/.test(v) && parseInt(v)>=1 && parseInt(v)<=31){
                  ds = c; break;
                }
              }
              if(ds>=0){
                de = ds;
                for(let c=ds; c<row.length; c++){
                  const v=row[c];
                  if(v && /^\d+$/.test(v) && parseInt(v)>=1 && parseInt(v)<=31){
                    de = c;
                  } else {
                    if(v && v.trim()!==""){ break; }
                  }
                }
                headerRowIdx = r;
                colPersonal = personalIdx;
                colEmp = empIdx;
                dayStart = ds;
                dayEnd = de;
                break;
              }
            }
          }

          if(headerRowIdx<0){
            alert("No se encontr√≥ encabezado (PERSONAL / No. EMP. / 1..31).");
            return;
          }

          let inferredMonth = null;
          let inferredYear = null;
          const monthMap = {
            "ENERO":1,"FEBRERO":2,"MARZO":3,"ABRIL":4,"MAYO":5,"JUNIO":6,"JULIO":7,"AGOSTO":8,"SEPTIEMBRE":9,"OCTUBRE":10,"NOVIEMBRE":11,"DICIEMBRE":12
          };
          for(let r=0; r<Math.min(25, rows.length); r++){
            const line = rows[r].filter(x=>x!=null).map(x=>x.toString()).join(" ").toUpperCase();
            for(const mn in monthMap){
              if(line.includes(mn)){
                inferredMonth = monthMap[mn];
                const yMatch = line.match(/20\d{2}/);
                if(yMatch) inferredYear = parseInt(yMatch[0]);
                break;
              }
            }
            if(inferredMonth && inferredYear) break;
          }
          if(!inferredMonth) inferredMonth = current.getMonth()+1;
          if(!inferredYear) inferredYear = current.getFullYear();

          const daysInMonth = new Date(inferredYear, inferredMonth, 0).getDate();
          const headerRow = rows[headerRowIdx].map(v=>v==null? "": v.toString().trim());
          const dayCols = [];
          for(let c=dayStart;c<=dayEnd;c++){
            const v = headerRow[c];
            if(v && /^\d+$/.test(v)){
              const d = parseInt(v);
              if(d>=1 && d<=daysInMonth) dayCols.push({day:d, col:c});
            }
          }

          const usersFound = [];
          const schedules = {};
          let r = headerRowIdx+1;
          while(r < rows.length){
            const row = rows[r] || [];
            const nameCell = row[colPersonal];
            const name = normStr(nameCell);
            const joined = row.filter(x=>x!=null).map(x=>x.toString()).join(" ").toUpperCase();
            if(joined.includes("TOTAL POR TURNO") || joined.includes("ELABORADO") || joined.includes("AUTORIZADO") || joined.includes("FIRMA") ){
              break;
            }
            if(!name){ r++; continue; }
            if(name.toUpperCase().includes("PERSONAL") || name.toUpperCase().includes("ENF.") || name.toUpperCase().includes("ESPECIALIZADAS")) { r++; continue; }
            if(!/[A-Za-z√Å√â√ç√ì√ö√ë√°√©√≠√≥√∫√±]/.test(name)){ r++; continue; }

            const codes = {};
            let nonEmpty = 0;
            dayCols.forEach(dc=>{
              const v = row[dc.col];
              const code = normStr(v).toUpperCase();
              if(code){
                codes[dc.day] = code;
                nonEmpty++;
              }
            });
            if(nonEmpty >= 3){
              const uName = upperKey(name);
              if(!usersFound.includes(uName)) usersFound.push(uName);
              schedules[uName] = codes;
            }
            r++;
          }

          if(!usersFound.length){
            alert("No se detectaron usuarios v√°lidos.");
            return;
          }

          importAnalysis = { inferredYear, inferredMonth, usersFound, schedules, dayCols };
          document.getElementById("importHint").textContent = `Detectado: ${monthName(inferredMonth-1)} ${inferredYear} ¬∑ Usuarios: ${usersFound.length}`;
          renderImportUsersList(usersFound);

        } catch(err){
          console.error(err);
          alert("Error analizando el Excel.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function renderImportUsersList(list){
      const box = document.getElementById("importUsersList");
      box.innerHTML="";
      list.sort().forEach(u=>{
        const exists = !!db.users[u];
        box.innerHTML += `
          <label class="flex items-center gap-2 p-3 rounded-2xl border bg-gray-50 hover:bg-gray-100">
            <input type="checkbox" class="impUserChk" value="${escapeHtml(u)}" checked>
            <span class="font-black text-[11px]">${escapeHtml(u)}</span>
            <span class="ml-auto text-[10px] font-black ${exists?"text-emerald-600":"text-gray-400"}">${exists?"EXISTE":"NUEVO"}</span>
          </label>
        `;
      });
    }

    function ensureDefaultAbsenceShifts(user){
      const cfg = user.config;
      if(!cfg["CAPACITACION"]) cfg["CAPACITACION"] = { label:"C", color:"gris", cat:"capacitacion", in:"00:00", out:"00:00" };
      if(!cfg["INCAPACIDAD"]) cfg["INCAPACIDAD"] = { label:"I", color:"gris", cat:"incapacidad", in:"00:00", out:"00:00" };
      if(!cfg["PERMISO_SINDICAL"]) cfg["PERMISO_SINDICAL"] = { label:"PS", color:"gris", cat:"permiso_sindical", in:"00:00", out:"00:00" };
      if(!cfg["FALTA"]) cfg["FALTA"] = { label:"F", color:"rojo", cat:"falta", in:"00:00", out:"00:00" };
    }

    function ensureShiftForCode(user, code){
      const cfg = user.config;
      const c = code.toUpperCase();
      if(cfg[c]) return;

      let inT="00:00", outT="00:00", cat="hospital", color="azul", label=c;
      if(c==="018" || c==="18" || c==="020" || c==="20"){
        inT="06:00"; outT="14:00"; cat="hospital"; color="Ma√±ana"; label=c;
      } else if(c==="468"){
        inT="14:00"; outT="22:00"; cat="hospital"; color="Tarde"; label=c;
      } else if(c==="650"){
        inT="06:00"; outT="22:00"; cat="hospital"; color="16hrs"; label=c;
      } else {
        inT="00:00"; outT="00:00"; cat="otro"; color="gris"; label=c;
      }
      cfg[c] = { label, color, cat, in:inT, out:outT };
    }

    function mapCodeToShiftKey(user, code){
      const c = code.toUpperCase();
      if(c==="C") return "CAPACITACION";
      if(c==="I") return "INCAPACIDAD";
      if(c==="PS") return "PERMISO_SINDICAL";
      if(c==="F") return "FALTA";
      if(c==="V") return "Vacaciones";
      if(c==="L" || c==="LS" || c==="X") return "L";  // ‚úÖ LS y X como L

      if(user.config[c]) return c;
      const mapped = db.codeMap[c];
      if(mapped && user.config[mapped]) return mapped;
      return c;
    }

    function importSelectedUsers(){
      if(!importAnalysis){ alert("Primero analiza el archivo."); return; }
      const picks = Array.from(document.querySelectorAll(".impUserChk")).filter(x=>x.checked).map(x=>x.value);
      if(!picks.length){ alert("Selecciona al menos un perfil."); return; }

      const createProfiles = document.getElementById("importCreateProfiles").checked;
      const overwrite = document.getElementById("importOverwriteData").checked;
      const alsoShifts = document.getElementById("importAlsoShifts").checked;

      const y = importAnalysis.inferredYear;
      const m = importAnalysis.inferredMonth;
      const schedules = importAnalysis.schedules;

      picks.forEach(u=>{
        if(!db.users[u]){
          if(!createProfiles) return;
          db.users[u] = JSON.parse(JSON.stringify(db.users["ADMIN"]));
          db.users[u].pin = "0000";
          db.users[u].data = {};
          db.users[u].editLocked = false;
          db.users[u].location = "San Salvador";
        }

        const user = db.users[u];
        ensureDefaultAbsenceShifts(user);

        if(alsoShifts){
          const codesSet = new Set(Object.values(schedules[u] || {}));
          codesSet.forEach(code=>{
            const c = normStr(code).toUpperCase();
            if(!c) return;
            if(["C","I","PS","F","V","L","LS","X"].includes(c)) return;
            ensureShiftForCode(user, c);
          });
        }

        if(overwrite){
          Object.keys(user.data).forEach(k=>{
            if(k.startsWith(`${y}-${m}-`)) delete user.data[k];
          });
        }

        const codesByDay = schedules[u] || {};
        Object.keys(codesByDay).forEach(dayStr=>{
          const day = parseInt(dayStr);
          if(!day) return;
          const dateKey = makeKey(y, m, day);

          let code = normStr(codesByDay[day]).toUpperCase();
          if(!code) return;

          // ‚úÖ LS y X como L
          if(code==="X" || code==="LS") code="L";

          const shiftKey = mapCodeToShiftKey(user, code);
          if(!user.config[shiftKey]) ensureShiftForCode(user, shiftKey);

          const SH = user.config[shiftKey];
          const hrs = calculateHours(SH.in, SH.out);
          const note = (SH.in==="00:00" && SH.out==="00:00") ? "" : `${SH.in} - ${SH.out}`;

          user.data[dateKey] = {
            mode:"simple",
            s: shiftKey,
            tIn: SH.in,
            tOut: SH.out,
            h: hrs,
            n: note,
            nAuto: true
          };
        });
      });

      persist();
      updateUserDropdown();
      updateUserInitial();
      render();
      closeImportModal();
      alert("Importaci√≥n completada.");
    }

    /* =========================
       PLACEHOLDERS: funciones del modal y settings (id√©nticas al v19)
       Para que el archivo sea 100% funcional, debes mantener el bloque completo de v19
       (openDay, setMode, refreshBtns, saveDay, renderSettings, categor√≠as, asuetos, localidades, perfiles, etc.)
       Si ya trabajas con un √∫nico archivo HTML, reemplaza SOLO estas secciones:
       - codeMap (LS/X -> L)
       - mapCodeToShiftKey y importSelectedUsers (LS/X -> L)
       - exportSingleUserMonthImage (nuevo: comentarios + listado de asuetos aplicables)
       El resto no cambia.
    ========================= */

    /* ====== STUBS MINIMOS para que no rompa si pegaste solo este bloque ======
       (Si ya tienes el v19 completo, BORRA estos stubs y deja tus funciones reales.)
    */
    function openDay(){ alert("Falta pegar el bloque completo del modal (openDay/saveDay/etc.) del v19."); }
    function closeModal(){ document.getElementById("modal").classList.remove("active"); }
    function setMode(){ }
    function saveDay(){ }
    function autoCalc(){ }
    function manualCalc(){ }
    function autoCalcMixtoTop(){ }
    function manualCalcMixtoTop(){ }
    function autoCalcMixtoBottom(){ }
    function manualCalcMixtoBottom(){ }
    function updateMixtoTotal(){ }
    function renderSettings(){ }
    function showConfigTab(){ }
    function addNewShift(){ }
    function selectColor(){ }
    function saveShiftsAndRefresh(){ }
    function addNewCategory(){ }
    function renderCategories(){ }
    function saveCategories(){ }
    function renderHolidays(){ }
    function loadHolidayLocationSelect(){ }
    function addNewHoliday(){ }
    function saveHolidays(){ }
    function renderLocalities(){ }
    function addLocality(){ }
    function deleteLocality(){ }
    function saveLocalities(){ }
    function openUserManager(){ }
    function closeUserManager(){ document.getElementById("userManagerModal").classList.remove("active"); }
    function createNewUser(){ }
    function renderProfilesManager(){ }
    function saveProfiles(){ }
    function switchUser(){ db.current = document.getElementById("userSelect").value; persist(); updateUserInitial(); updateUIEditMode(); render(); }
    function showView(v){
      document.querySelectorAll(".view-section").forEach(s=>s.classList.remove("view-active"));
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("tab-active"));
      document.getElementById("view-"+v).classList.add("view-active");
      document.getElementById("tab-"+v).classList.add("tab-active");
      if(v==="settings"){ updateUIEditMode(); }
    }
    function saveProfileSecurity(){ alert("Falta pegar el bloque completo de seguridad del v19."); }

    function changeMonth(v){ current.setMonth(current.getMonth()+v); updateMonthDisplay(); render(); }
    function jumpToDate(){ current.setMonth(parseInt(document.getElementById("selectMonth").value)); current.setFullYear(parseInt(document.getElementById("selectYear").value)); updateMonthDisplay(); render(); }
    function goToday(){ current = new Date(); updateMonthDisplay(); render(); }

    function init(){
      loadDefaultHolidays2026();
      initDateSelectors();
      updateUserDropdown();
      updateUserInitial();
      updateMonthDisplay();
      updateUIEditMode();
      render();
    }
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

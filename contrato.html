<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Shifter Pro v20 - Consolidado (Mejoras)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { background:#f3f4f6; color:#111827; font-family:system-ui,-apple-system,sans-serif; -webkit-tap-highlight-color:transparent; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#e5e7eb; border:1px solid #e5e7eb; }
    .day-cell { background:#fff; height:130px; position:relative; cursor:pointer; display:flex; flex-direction:column; overflow:hidden; transition:transform .15s; }
    .day-cell:active{ transform:scale(.98); }
    .day-number{ font-size:11px; font-weight:900; padding:2px 6px; position:absolute; top:0; right:0; z-index:20; color:#374151; background:rgba(255,255,255,.9); border-bottom-left-radius:8px; }
    .day-off-month{ background:#f9fafb!important; opacity:.5; }
    .today{ border:2px solid #3b82f6!important; }
    .weekend{ background:#f8fafc!important; }

    /* Turn colors */
    .bg-Ma√±ana{ background:#ffff00!important; }
    .bg-Tarde{ background:#fbcfe8!important; }
    .bg-CENA{ background:#d8b4fe!important; }
    .bg-16hrs{ background:#bef264!important; }
    .bg-L{ background:#ffffff!important; }
    .bg-Vacaciones{ background:#fed7aa!important; }
    .bg-Cumplea√±os{ background:#fde68a!important; }

    .bg-azul{ background:#93c5fd!important; }
    .bg-rojo{ background:#fca5a5!important; }
    .bg-verde{ background:#86efac!important; }
    .bg-naranja{ background:#fdba74!important; }
    .bg-rosa{ background:#f9a8d4!important; }
    .bg-cian{ background:#67e8f9!important; }
    .bg-morado{ background:#d8b4fe!important; }
    .bg-lima{ background:#d9f99d!important; }
    .bg-ambar{ background:#fcd34d!important; }
    .bg-teal{ background:#5eead4!important; }
    .bg-indigo{ background:#a5b4fc!important; }
    .bg-gris{ background:#d1d5db!important; }

    .shift-label{ flex:1; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; text-transform:uppercase; text-align:center; line-height:1.1; padding:4px; color:rgba(0,0,0,.82); }

    /* Notes: simple + mixto (top/bottom) */
    .note-text{
      font-size:10px; position:absolute; bottom:4px; left:50%; transform:translateX(-50%);
      width:92%; text-align:center; color:#000; font-weight:900; background:rgba(255,255,255,.70);
      border-radius:6px; padding:1px 4px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; z-index:30;
    }
    .note-top{
      font-size:10px; position:absolute; top:50%; transform:translate(-50%,-6px);
      left:50%; width:92%; text-align:center; color:#000; font-weight:900; background:rgba(255,255,255,.70);
      border-radius:6px; padding:1px 4px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; z-index:30;
    }
    .note-bottom{
      font-size:10px; position:absolute; bottom:4px; left:50%; transform:translateX(-50%);
      width:92%; text-align:center; color:#000; font-weight:900; background:rgba(255,255,255,.70);
      border-radius:6px; padding:1px 4px; border:1px solid rgba(0,0,0,.08); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; z-index:30;
    }

    .view-section{ display:none; }
    .view-active{ display:block; }

    .tab-btn{ flex:1; text-align:center; padding:14px; font-weight:900; font-size:11px; border-bottom:3px solid transparent; transition:.2s; }
    .tab-active{ border-bottom-color:#2563eb; color:#2563eb; background:#f8fafc; }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:100; padding:15px; backdrop-filter:blur(4px); }
    .modal.active{ display:flex; }

    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea{
      background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:10px; font-weight:800; font-size:13px; outline:none; transition:.15s;
    }
    select:focus, input:focus, textarea:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.12); }

    .shift-option{ transition:.15s; border-width:2px; border-color:transparent; padding:12px 8px; border-radius:12px; font-size:10px; font-weight:900; text-transform:uppercase; cursor:pointer; }
    .shift-option.selected{ border-color:#2563eb!important; box-shadow:0 6px 14px rgba(37,99,235,.22); transform:translateY(-1px); }
    .shift-option:not(.selected){ opacity:.78; }
    .shift-option:hover:not(.selected){ opacity:.95; transform:translateY(-1px); }

    .color-option{ width:30px; height:30px; border-radius:8px; cursor:pointer; border:2px solid transparent; transition:.15s; }
    .color-option.selected{ border-color:#000; transform:scale(1.08); box-shadow:0 6px 10px rgba(0,0,0,.18); }

    .config-tab{ flex:1; text-align:center; padding:12px; font-weight:900; font-size:10px; border-bottom:3px solid transparent; transition:.2s; color:#9ca3af; }
    .config-tab.active{ border-bottom-color:#2563eb; color:#2563eb; background:#f8fafc; }

    .holiday-indicator{
      position:absolute; top:0; left:0; font-size:8px; font-weight:900; color:#dc2626;
      background:rgba(254,226,226,.9); padding:1px 4px; border-bottom-right-radius:8px; z-index:20;
    }

    /* Fix dropdown "blank" issue */
    #userSelect{
      background:rgba(255,255,255,.12)!important;
      color:#fff!important;
      border:1px solid rgba(255,255,255,.15)!important;
      padding:6px 10px!important;
      border-radius:12px!important;
      max-width:240px;
    }
    #userSelect option{ color:#111827; background:#fff; font-weight:800; }

    /* Responsive calendar cell height */
    @media (max-width: 520px){
      .day-cell{ height:108px; }
      .shift-label{ font-size:10px; }
      .note-text,.note-top,.note-bottom{ font-size:9px; }
    }
    @media (min-width: 1024px){
      .day-cell{ height:140px; }
    }
  </style>
</head>

<body>

<!-- Top bar -->
<div class="bg-[#1e293b] text-white p-4 sticky top-0 z-50 shadow-lg">
  <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-black text-sm">
          <span id="userInitial">A</span>
        </div>
        <div>
          <div class="flex flex-wrap items-center gap-2">
            <select id="userSelect" onchange="switchUser()"></select>
            <button onclick="openProfilesModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üë§ Perfiles</button>
          </div>
          <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400">Modo Vista</p>
        </div>
      </div>

      <div class="flex gap-2 md:hidden">
        <button onclick="openImportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üì•</button>
        <button onclick="showExportModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üìã</button>
        <button id="unlockBtnM" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üîí</button>
      </div>
    </div>

    <div class="hidden md:flex gap-2">
      <button onclick="openImportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üì• Importar</button>
      <button onclick="showExportModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üìã Exportar</button>
      <button id="unlockBtn" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors">üîí Bloquear</button>
    </div>
  </div>

  <!-- Month/year -->
  <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-2xl p-2 shadow-inner">
    <button onclick="changeMonth(-1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
      <span class="text-xl font-bold">‚Äπ</span>
    </button>

    <div class="flex flex-col items-center">
      <div id="currentMonthDisplay" class="text-xl font-black text-white text-center mb-1">Febrero 2026</div>
      <div class="flex gap-3 items-center opacity-90">
        <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer"></select>
        <span class="text-white font-bold">/</span>
        <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer"></select>
      </div>
      <div class="flex gap-2 mt-2">
        <button onclick="goToday()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-[10px] font-black uppercase transition-colors">Hoy</button>
      </div>
    </div>

    <button onclick="changeMonth(1)" class="p-3 hover:bg-white/10 rounded-full transition-colors">
      <span class="text-xl font-bold">‚Ä∫</span>
    </button>
  </div>
</div>

<!-- Tabs -->
<div class="flex bg-white shadow-sm sticky top-[168px] md:top-[160px] z-40 border-b">
  <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">üìÖ Calendario</button>
  <button onclick="showView('summary')" id="tab-summary" class="tab-btn">üìä Resumen</button>
  <button onclick="showView('settings')" id="tab-settings" class="tab-btn">‚öôÔ∏è Ajustes</button>
</div>

<!-- Calendar -->
<div id="view-calendar" class="view-section view-active">
  <div class="grid grid-cols-7 text-center text-[11px] font-black py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b">
    <div class="text-blue-600 font-black">LUN</div><div>MAR</div><div>MI√â</div><div>JUE</div><div>VIE</div>
    <div class="text-blue-600 font-black">S√ÅB</div><div class="text-red-600 font-black">DOM</div>
  </div>
  <div id="calendar" class="calendar-grid"></div>
</div>

<!-- Summary (DIN√ÅMICO por categor√≠as) -->
<div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen">
  <div class="space-y-4 md:space-y-6">

    <div class="bg-white p-4 rounded-3xl shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[12px] font-black text-gray-600 uppercase">üìä Resumen por Categor√≠as</h3>
        <span id="summary-month" class="text-[10px] font-black px-2 py-1 rounded-full bg-gray-100 text-gray-700">‚Äî</span>
      </div>
      <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
      <div class="mt-4 p-4 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-[10px] font-black">
          <div class="bg-white/20 p-2 rounded-xl">
            <div>Localidad</div><div id="profile-loc" class="text-lg font-black">‚Äî</div>
          </div>
          <div class="bg-white/20 p-2 rounded-xl">
            <div>D√≠as trabajados</div><div id="worked-days" class="text-lg font-black">0</div>
          </div>
          <div class="bg-white/20 p-2 rounded-xl">
            <div>Asuetos (aplican)</div><div id="total-holidays" class="text-lg font-black">0</div>
          </div>
          <div class="bg-white/20 p-2 rounded-xl">
            <div>Asuetos trabajados</div><div id="holiday-worked" class="text-lg font-black">0</div>
          </div>
        </div>
        <p class="text-[10px] mt-3 font-bold opacity-90">
          * Asueto ‚Äúaplica‚Äù si coincide con la localidad del perfil o si el asueto es ‚ÄúGeneral‚Äù.
        </p>
      </div>
    </div>

    <div class="bg-white p-4 rounded-3xl shadow-sm">
      <h3 class="text-[12px] font-black text-gray-600 uppercase mb-3">üìà Detalle del Mes</h3>
      <div class="space-y-2">
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Promedio diario (horas trabajadas):</span><span id="avg-hours" class="font-black text-gray-900">0.0h</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Total d√≠as mes:</span><span id="total-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Fines de semana (en mes):</span><span id="weekend-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">D√≠as ‚ÄúLibre‚Äù:</span><span id="free-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Vacaciones:</span><span id="vac-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Faltas injustificadas:</span><span id="falta-days" class="font-black text-gray-900">0</span></div>
      </div>
    </div>

  </div>
</div>

<!-- Settings -->
<div id="view-settings" class="view-section bg-white min-h-screen">
  <div class="flex bg-gray-50 border-b overflow-x-auto">
    <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active">üé® Turnos</button>
    <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab">‚ûï Nuevo</button>
    <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab">üè∑Ô∏è Categor√≠as</button>
    <button onclick="showConfigTab('localidades')" id="config-localidades" class="config-tab">üìç Localidades</button>
    <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab">üéâ Asuetos</button>
    <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab">üîí Seguridad</button>
  </div>

  <div id="config-content" class="p-4 md:p-6">
    <!-- Turnos -->
    <div id="tab-turnos" class="config-tab-content">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üé® Configurar Turnos (Perfil actual)</h3>
        <div class="flex gap-2">
          <button onclick="toggleShowAllShiftsSettings()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase">
            üëÅÔ∏è <span id="lblShowAllSettings">Mostrar solo b√°sicos</span>
          </button>
          <button onclick="saveShiftSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
            üíæ Guardar cambios
          </button>
        </div>
      </div>

      <div class="bg-blue-50 border border-blue-100 rounded-2xl p-3 text-[11px] font-bold text-blue-900 mb-4">
        Al guardar: actualiza turnos y puede propagar horas/comentarios en el calendario del perfil.
        <div class="mt-2 flex items-center gap-2">
          <input type="checkbox" id="propagateShiftEdits" checked>
          <label for="propagateShiftEdits" class="font-black text-[10px] uppercase text-blue-900">Propagar a calendario (este perfil)</label>
        </div>
      </div>

      <div id="settings-container" class="space-y-3"></div>
    </div>

    <!-- Nuevo turno -->
    <div id="tab-nuevo" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">‚ûï Agregar Nuevo Turno</h3>
      <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-100 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Turno</label>
            <input type="text" id="newShiftName" placeholder="Ej: Noche" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Categor√≠a</label>
            <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
          </div>
        </div>

        <div class="mb-4">
          <label class="text-[11px] font-bold text-gray-600 block mb-2">Color</label>
          <div class="grid grid-cols-6 gap-2 p-3 bg-white rounded-xl">
            <div class="color-option bg-Ma√±ana" onclick="selectColor('Ma√±ana', event)"></div>
            <div class="color-option bg-Tarde" onclick="selectColor('Tarde', event)"></div>
            <div class="color-option bg-CENA" onclick="selectColor('CENA', event)"></div>
            <div class="color-option bg-16hrs" onclick="selectColor('16hrs', event)"></div>
            <div class="color-option bg-Cumplea√±os" onclick="selectColor('Cumplea√±os', event)"></div>
            <div class="color-option bg-Vacaciones" onclick="selectColor('Vacaciones', event)"></div>

            <div class="color-option bg-azul" onclick="selectColor('azul', event)"></div>
            <div class="color-option bg-rojo" onclick="selectColor('rojo', event)"></div>
            <div class="color-option bg-verde" onclick="selectColor('verde', event)"></div>
            <div class="color-option bg-naranja" onclick="selectColor('naranja', event)"></div>
            <div class="color-option bg-rosa" onclick="selectColor('rosa', event)"></div>
            <div class="color-option bg-cian" onclick="selectColor('cian', event)"></div>

            <div class="color-option bg-morado" onclick="selectColor('morado', event)"></div>
            <div class="color-option bg-lima" onclick="selectColor('lima', event)"></div>
            <div class="color-option bg-ambar" onclick="selectColor('ambar', event)"></div>
            <div class="color-option bg-teal" onclick="selectColor('teal', event)"></div>
            <div class="color-option bg-indigo" onclick="selectColor('indigo', event)"></div>
            <div class="color-option bg-gris" onclick="selectColor('gris', event)"></div>

            <div class="color-option bg-L" onclick="selectColor('L', event)"></div>
          </div>
          <input type="hidden" id="newShiftColor" value="Ma√±ana">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Entrada</label>
            <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Salida</label>
            <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
        </div>

        <button onclick="addNewShift()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600">
          ‚ûï Agregar Turno
        </button>
      </div>
    </div>

    <!-- Categor√≠as -->
    <div id="tab-categorias" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üè∑Ô∏è Categor√≠as (todas editables)</h3>
        <button onclick="saveCategories()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-3xl border border-green-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva Categor√≠a</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newCategoryName" placeholder="Ej: Guardia" class="w-full bg-white border-green-200 focus:border-green-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Icono</label>
            <input type="text" id="newCategoryIcon" placeholder="Ej: üõ°Ô∏è" class="w-full bg-white border-green-200 focus:border-green-400" maxlength="4">
          </div>
        </div>
        <button onclick="addNewCategory()" class="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600">
          ‚ûï Agregar Categor√≠a
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Categor√≠as Existentes (editables)</h4>
        <div id="categories-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Localidades -->
    <div id="tab-localidades" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üìç Localidades</h3>
        <button onclick="saveLocalities()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-sky-50 to-blue-50 p-4 rounded-3xl border border-sky-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Localidad</h4>
        <div class="flex flex-col md:flex-row gap-3">
          <input type="text" id="newLocalityName" placeholder="Ej: Santa Ana" class="flex-1 bg-white border-sky-200 focus:border-sky-400">
          <button onclick="addLocality()" class="px-5 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">‚ûï Agregar</button>
        </div>
        <p class="text-[10px] mt-2 font-bold text-gray-500">* ‚ÄúGeneral‚Äù se reserva para asuetos v√°lidos para todos.</p>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Lista de Localidades (editables)</h4>
        <div id="localities-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Asuetos -->
    <div id="tab-asuetos" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üéâ Asuetos</h3>
        <button onclick="saveHolidays()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-3xl border border-pink-100 mb-6">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nuevo Asueto</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Fecha</label>
            <input type="date" id="newHolidayDate" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
          <div class="md:col-span-2">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newHolidayName" placeholder="Ej: D√≠a de la Independencia" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="newHolidayLocation" class="w-full bg-white border-pink-200 focus:border-pink-400"></select>
          </div>
          <div class="bg-white rounded-2xl border border-pink-200 p-3 text-[10px] font-bold text-gray-600 flex items-center">
            Si quieres asueto para todos: selecciona <span class="mx-1 font-black text-red-600">General</span>.
          </div>
        </div>

        <button onclick="addNewHoliday()" class="w-full p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600">
          ‚ûï Agregar Asueto
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <div class="p-4 border-b flex items-center justify-between">
          <h4 class="text-[12px] font-black text-gray-600">Asuetos (editables)</h4>
          <button onclick="restoreDefaultHolidays()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase text-gray-700">
            ‚ôªÔ∏è Restaurar cat√°logo
          </button>
        </div>
        <div id="holidays-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Seguridad -->
    <div id="tab-seguridad" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üîí Seguridad (PIN del perfil actual)</h3>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-3xl border border-blue-100">
        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Cambiar PIN (4 d√≠gitos)</label>
            <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Confirmar PIN</label>
            <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>

          <button onclick="savePinOnly()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-3xl font-black uppercase shadow-xl hover:from-blue-700 hover:to-indigo-700">
            üíæ Guardar PIN
          </button>

          <div class="text-[10px] font-bold text-gray-500">
            Regla: el PIN universal (admin) desbloquea cualquier perfil, pero el PIN de un perfil <b>no</b> desbloquea ‚ÄúADMIN‚Äù.
          </div>
        </div>
      </div>
    </div>

  </div>

  <div id="settings-locked" class="p-8 text-center hidden">
    <div class="w-20 h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
      <span class="text-3xl">üîí</span>
    </div>
    <h3 class="text-lg font-black text-gray-600 mb-2">Configuraci√≥n Bloqueada</h3>
    <p class="text-sm text-gray-500 mb-6">Activa el modo edici√≥n para acceder</p>
    <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-black">üîì Activar Edici√≥n</button>
  </div>
</div>

<!-- Modal d√≠a -->
<div id="modal" class="modal">
  <div class="bg-white w-full max-w-md rounded-[40px] overflow-hidden shadow-2xl border border-gray-100">
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-5 font-black text-sm uppercase tracking-widest">
      <div>üìÖ Configurar D√≠a</div>
      <div id="modalDate" class="text-[10px] font-normal opacity-90 mt-1"></div>
      <div id="modalHolidayInfo" class="text-[10px] font-black opacity-95 mt-2 px-4"></div>
    </div>

    <div class="p-6 overflow-y-auto max-h-[80vh]">

      <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-4">
        <button onclick="setMode('simple')" id="m-s" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Simple</button>
        <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Mixto</button>
      </div>

      <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-2xl px-3 py-2 mb-4">
        <div class="text-[10px] font-black text-gray-500 uppercase">Turnos</div>
        <button onclick="toggleShowAllShiftsModal()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">
          üëÅÔ∏è <span id="lblShowAllModal">Mostrar solo b√°sicos</span>
        </button>
      </div>

      <!-- SIMPLE -->
      <div id="sec-simple" class="grid grid-cols-3 gap-2 mb-4"></div>

      <!-- MIXTO -->
      <div id="sec-mixto" class="hidden space-y-4 mb-4">
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Superior</p>
          <div id="mix-t" class="grid grid-cols-3 gap-2"></div>
        </div>
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Inferior</p>
          <div id="mix-b" class="grid grid-cols-3 gap-2"></div>
        </div>
      </div>

      <!-- Horario SIMPLE -->
      <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100 mb-4">
        <div class="flex items-center justify-between">
          <span class="text-[11px] font-black uppercase text-blue-900">‚è∞ Horario:</span>
          <div class="flex items-center gap-2">
            <input type="time" id="tIn" onchange="autoCalc(); autoNoteUpdateSimple();" class="bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">‚Üí</span>
            <input type="time" id="tOut" onchange="autoCalc(); autoNoteUpdateSimple();" class="bg-white border-blue-200 focus:border-blue-400">
          </div>
        </div>
        <div class="flex items-center justify-between border-t border-blue-200 pt-3">
          <span class="text-[11px] font-black uppercase text-blue-900">üìä Total Horas:</span>
          <input type="number" id="tHrs" onchange="manualCalc()" class="w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
        </div>

        <div>
          <p class="text-[10px] font-black text-gray-400 uppercase mb-2 ml-2">üìù Comentario (auto por turno/horario, editable)</p>
          <textarea id="nota" placeholder="Ej: 06:00-14:00 | etc." class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          <p class="text-[10px] text-gray-500 mt-2 font-bold text-center">
            Si editas manualmente, ya no se sobreescribe autom√°ticamente.
          </p>
        </div>
      </div>

      <!-- Horario MIXTO -->
      <div id="time-mixto" class="hidden space-y-4 mb-4">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-[24px] space-y-4 border border-blue-100">
          <p class="text-[11px] font-black uppercase text-blue-900 text-center">‚è∞ Horario Superior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInTop" onchange="autoCalcMixtoTop(); autoNoteUpdateMixto('t');" class="w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">‚Üí</span>
            <input type="time" id="tOutTop" onchange="autoCalcMixtoTop(); autoNoteUpdateMixto('t');" class="w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div class="flex items-center justify-between border-t border-blue-200 pt-3">
            <span class="text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
            <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
          </div>

          <div>
            <p class="text-[10px] font-black text-gray-400 uppercase mb-2 ml-2">üìù Comentario Superior (auto, editable)</p>
            <textarea id="notaTop" placeholder="Ej: 06:00-14:00" class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>

        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-5 rounded-[24px] space-y-4 border border-purple-100">
          <p class="text-[11px] font-black uppercase text-purple-900 text-center">‚è∞ Horario Inferior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInBottom" onchange="autoCalcMixtoBottom(); autoNoteUpdateMixto('b');" class="w-32 bg-white border-purple-200 focus:border-purple-400">
            <span class="font-black text-purple-300">‚Üí</span>
            <input type="time" id="tOutBottom" onchange="autoCalcMixtoBottom(); autoNoteUpdateMixto('b');" class="w-32 bg-white border-purple-200 focus:border-purple-400">
          </div>
          <div class="flex items-center justify-between border-t border-purple-200 pt-3">
            <span class="text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
            <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200" step="0.5">
          </div>

          <div>
            <p class="text-[10px] font-black text-gray-400 uppercase mb-2 ml-2">üìù Comentario Inferior (auto, editable)</p>
            <textarea id="notaBottom" placeholder="Ej: 14:00-22:00" class="w-full p-4 bg-gray-100 border-none rounded-[24px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-purple-500"></textarea>
          </div>
        </div>

        <div class="flex items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-[20px] border border-emerald-100">
          <span class="text-[11px] font-black uppercase text-emerald-900">üìä Total Horas:</span>
          <input type="number" id="tHrsMixto" class="w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200" step="0.5" readonly>
        </div>
      </div>

      <div class="flex gap-4 mt-6">
        <button onclick="closeModal()" class="flex-1 p-5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-3xl font-black text-[11px] uppercase">‚ùå Cancelar</button>
        <button onclick="saveDay()" class="flex-1 p-5 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-3xl font-black text-[11px] uppercase shadow-lg">‚úÖ Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Import -->
<div id="importModal" class="modal">
  <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 shadow-2xl">
    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">üì•</span>
    </div>
    <h3 class="font-black text-center uppercase text-lg mb-2">Importar Excel</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Detecta usuarios y permite seleccionar cu√°les importar.
    </p>

    <div class="space-y-4">
      <div>
        <label class="text-[12px] font-bold text-gray-600 block mb-2">Archivo Excel (.xlsx)</label>
        <input type="file" id="importFile" accept=".xlsx,.xls" class="w-full bg-gray-50 border-gray-200">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes (si no detecta)</label>
          <select id="importMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">A√±o (si no detecta)</label>
          <select id="importYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Modo</p>
        <div class="flex gap-3">
          <label class="flex-1 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="replace" checked> Reemplazar mes
          </label>
          <label class="flex-1 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="merge"> Combinar (solo d√≠as vac√≠os)
          </label>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Usuarios detectados</p>
          <div class="flex gap-2">
            <button onclick="selectAllImportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllImportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="importUsersList" class="max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700">
          <div class="text-gray-400 font-bold">Adjunta un Excel y presiona ‚ÄúAnalizar‚Äù.</div>
        </div>

        <div class="mt-3 flex gap-2">
          <button onclick="analyzeImportFile()" class="flex-1 p-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">
            üîé Analizar
          </button>
          <button onclick="runImportSelected()" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black uppercase text-[11px]">
            üöÄ Importar Seleccionados
          </button>
        </div>

        <div id="importInfo" class="mt-3 text-[11px] font-bold text-center text-gray-600"></div>
      </div>

      <button onclick="closeImportModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Modal Export -->
<div id="exportModal" class="modal">
  <div class="bg-white w-full max-w-xl rounded-[40px] p-8 shadow-2xl">
    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">üìã</span>
    </div>
    <h3 class="font-black text-center uppercase text-lg mb-2">Exportar</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Puedes exportar uno, varios o todos. Si es ‚Äútodos‚Äù, se genera 1 imagen por perfil.
    </p>

    <div class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes</label>
          <select id="exportMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">A√±o</label>
          <select id="exportYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Qu√© exportar</p>
        <div class="space-y-2 text-[11px] font-bold text-gray-700">
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="current" checked> Perfil actual</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="select"> Seleccionar perfiles</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="all"> Todos los perfiles</label>
        </div>
      </div>

      <div id="exportUsersBox" class="bg-white border border-gray-200 rounded-2xl p-4 hidden">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Seleccionar perfiles</p>
          <div class="flex gap-2">
            <button onclick="selectAllExportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllExportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="exportUsersList" class="max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700"></div>
      </div>

      <button onclick="exportImages()" class="w-full p-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-3xl font-black uppercase shadow-xl hover:from-emerald-700 hover:to-teal-700">
        üñºÔ∏è Exportar im√°genes
      </button>

      <button onclick="closeExportModal()" class="w-full mt-2 p-4 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Modal Profiles -->
<div id="profilesModal" class="modal">
  <div class="bg-white w-full max-w-3xl rounded-[40px] p-8 shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="font-black uppercase text-lg">üë§ Gesti√≥n de Perfiles</h3>
        <p class="text-[11px] text-gray-500 font-bold">Crear, editar, asignar localidad o eliminar perfiles.</p>
      </div>
      <button onclick="closeProfilesModal()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Cerrar</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-3xl p-4">
        <h4 class="text-[12px] font-black text-gray-700 uppercase mb-3">‚ûï Crear perfil</h4>
        <div class="space-y-3">
          <input id="createName" type="text" placeholder="Nombre completo" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <input id="createPin" type="password" placeholder="PIN (4 d√≠gitos)" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="createLoc" class="w-full bg-white border-blue-200 focus:border-blue-400"></select>
          </div>
          <button onclick="createProfile()" class="w-full p-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-[11px]">
            Crear
          </button>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-3xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-[12px] font-black text-gray-700 uppercase">Perfiles existentes</h4>
          <button onclick="renderProfilesList()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Actualizar</button>
        </div>
        <div id="profilesList" class="max-h-[360px] overflow-y-auto space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   DB v20 (Consolidado)
========================================================= */
const ADMIN_UNIVERSAL_PIN = '120720'; // NO VISIBLE EN UI
const BASIC_SHIFT_IDS = ['Ma√±ana','Tarde','16hrs','CENA','Cumplea√±os','L','Vacaciones'];

let db = JSON.parse(localStorage.getItem('shifter_v20')) || {
  version: 20,
  current: 'ADMIN',
  showAllShiftsModal: false,
  showAllShiftsSettings: false,
  localities: ['General','San Salvador','Cojutepeque','Lourdes, Col√≥n','La Libertad','Quezaltepeque','Rosario de la Paz','Zacatecoluca','San Vicente','Santa Tecla','San Juan Opico'],
  holidays: {},
  categories: {
    hosp:  { name:'Hospital', icon:'üè•', countsAsWork:true },
    sena:  { name:'CENA', icon:'üåô', countsAsWork:true },
    admin: { name:'Administrativo', icon:'üìã', countsAsWork:true },
    guardia:{ name:'Guardia', icon:'üõ°Ô∏è', countsAsWork:true },
    extra: { name:'Extra', icon:'‚≠ê', countsAsWork:true },
    off:   { name:'Libre/Vacaciones', icon:'üò¥', countsAsWork:false },
    falta: { name:'Ausencia injustificada', icon:'‚ö†Ô∏è', countsAsWork:false },
    otro:  { name:'Otro', icon:'üîß', countsAsWork:true }
  },
  users: {
    ADMIN: {
      pin:'1234',
      editLocked:false, // default desbloqueado
      locality:'San Salvador',
      data:{},
      config:{
        'Ma√±ana':     { label:'Ma√±ana', color:'Ma√±ana', cat:'hosp',  in:'06:00', out:'14:00' },
        'Tarde':      { label:'Tarde',  color:'Tarde',  cat:'hosp',  in:'14:00', out:'22:00' },
        '16hrs':      { label:'16hrs',  color:'16hrs',  cat:'hosp',  in:'06:00', out:'22:00' },
        'CENA':       { label:'CENA',   color:'CENA',   cat:'sena',  in:'05:00', out:'17:00' },
        'Cumplea√±os': { label:'Cumplea√±os', color:'Cumplea√±os', cat:'off', in:'00:00', out:'00:00' },
        'L':          { label:'L',      color:'L',      cat:'off',   in:'00:00', out:'00:00' },
        'Vacaciones': { label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00' },

        // Import base examples (se agregan si se detectan)
        'CAPACITACION': { label:'Capacitaci√≥n', color:'azul', cat:'admin', in:'00:00', out:'00:00' },
        'INCAPACIDAD':  { label:'Incapacidad',  color:'rojo', cat:'off',   in:'00:00', out:'00:00' },
        'PERMISO_SINDICAL': { label:'Permiso Sindical', color:'morado', cat:'admin', in:'00:00', out:'00:00' },
        'AUS_INJUST':   { label:'Aus. Injust.', color:'gris', cat:'falta', in:'00:00', out:'00:00' },
        '018':          { label:'018', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00' },
        '468':          { label:'468', color:'Tarde',  cat:'hosp', in:'14:00', out:'22:00' },
        '650':          { label:'650', color:'16hrs',  cat:'hosp', in:'06:00', out:'22:00' },
        '020':          { label:'020', color:'gris',   cat:'hosp', in:'00:00', out:'00:00' }
      }
    }
  }
};

/* =========================================================
   Import maps
========================================================= */
const IMPORT_ABSENCE_MAP = {
  'C':  { key:'CAPACITACION', label:'Capacitaci√≥n', color:'azul', cat:'admin', in:'00:00', out:'00:00', note:'CAPACITACI√ìN' },
  'I':  { key:'INCAPACIDAD', label:'Incapacidad', color:'rojo', cat:'off', in:'00:00', out:'00:00', note:'INCAPACIDAD' },
  'V':  { key:'Vacaciones', label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', note:'VACACIONES' },
  'L':  { key:'L', label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', note:'LIBRE' },
  'PS': { key:'PERMISO_SINDICAL', label:'Permiso Sindical', color:'morado', cat:'admin', in:'00:00', out:'00:00', note:'PERMISO SINDICAL' },
  'F':  { key:'AUS_INJUST', label:'Aus. Injust.', color:'gris', cat:'falta', in:'00:00', out:'00:00', note:'AUSENCIA INJUSTIFICADA' }
};
const IMPORT_SHIFT_CODE_MAP = {
  '018': { key:'018', label:'018', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '18':  { key:'018', label:'018', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '468': { key:'468', label:'468', color:'Tarde',  cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '650': { key:'650', label:'650', color:'16hrs',  cat:'hosp', in:'06:00', out:'22:00', note:'06:00-22:00' }
};

/* =========================================================
   Globals
========================================================= */
let current = new Date();
let activeKey = "";
let mode = "simple";
let selS = "Ma√±ana";
let selT = "Ma√±ana";
let selB = "Tarde";
let selectedColor = "Ma√±ana";
let importContext = null;

/* Auto-note flags (en modal) */
let noteAutoSimple = true;
let noteAutoTop = true;
let noteAutoBottom = true;

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

/* =========================================================
   Helpers
========================================================= */
function saveDB(){ localStorage.setItem('shifter_v20', JSON.stringify(db)); }
function isEditMode(){ return !db.users[db.current].editLocked; }

function calculateHours(start, end){
  if(!start || !end || (start==='00:00' && end==='00:00')) return 0;
  let [h1,m1]=start.split(':').map(Number);
  let [h2,m2]=end.split(':').map(Number);
  let diff = (h2 + m2/60) - (h1 + m1/60);
  if(diff < 0) diff += 24;
  return parseFloat(diff.toFixed(1));
}

function normalizeCode(v){
  if(v===null||v===undefined) return '';
  let s = String(v).trim();
  if(!s) return '';
  s = s.replace(/\s+/g,' ').toUpperCase();
  if (s === 'LS') s='L';
  if (s === 'P S' || s === 'P/S') s='PS';
  return s;
}

function codeToShiftDef(codeNorm){
  if(!codeNorm || codeNorm==='X') return null;
  if(IMPORT_ABSENCE_MAP[codeNorm]) return {...IMPORT_ABSENCE_MAP[codeNorm]};
  if(IMPORT_SHIFT_CODE_MAP[codeNorm]) return {...IMPORT_SHIFT_CODE_MAP[codeNorm]};
  if(/^\d+$/.test(codeNorm)){
    return { key: codeNorm, label: codeNorm, color:'gris', cat:'hosp', in:'00:00', out:'00:00', note: codeNorm };
  }
  return null;
}

function dayKey(y,m1,d){ return `${y}-${m1}-${d}`; } // m1 1-based

function getColorValue(colorName){
  const map = {
    'Ma√±ana':'#ffff00','Tarde':'#fbcfe8','CENA':'#d8b4fe','16hrs':'#bef264','L':'#ffffff','Vacaciones':'#fed7aa','Cumplea√±os':'#fde68a',
    'azul':'#93c5fd','rojo':'#fca5a5','verde':'#86efac','naranja':'#fdba74','rosa':'#f9a8d4','cian':'#67e8f9',
    'morado':'#d8b4fe','lima':'#d9f99d','ambar':'#fcd34d','teal':'#5eead4','indigo':'#a5b4fc','gris':'#d1d5db'
  };
  return map[colorName] || '#ffffff';
}

function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }
function cssSafe(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g,'_'); }
function toISODate(y,m,d){
  y=String(y).padStart(4,'0');
  m=String(m).padStart(2,'0');
  d=String(d).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

/* =========================================================
   Holidays applicability by locality
========================================================= */
function holidayApplies(holidayLocation, userLocation){
  const hl = (holidayLocation||'General').trim().toUpperCase();
  const ul = (userLocation||'San Salvador').trim().toUpperCase();
  if(hl === 'GENERAL') return true;
  return hl === ul;
}

function getHolidayForDate(key){
  const h = db.holidays[key];
  if(!h) return null;
  return { name: h.name||'Asueto', location: h.location||'General' };
}

function countApplicableHolidaysInMonth(year, monthIndex0, userLocation){
  const m1 = monthIndex0+1;
  let c=0;
  Object.keys(db.holidays).forEach(k=>{
    const [y,mm]=k.split('-').map(Number);
    if(y===year && mm===m1){
      const h = db.holidays[k];
      if(holidayApplies(h.location, userLocation)) c++;
    }
  });
  return c;
}

/* =========================================================
   Default holidays catalog (El Salvador + localidades)
   Nota: A√±o se toma del calendario actual (por defecto 2026),
   pero se cargan para el rango 2023-2027 autom√°ticamente.
========================================================= */
function defaultHolidayCatalogForYear(Y){
  return {
    // Enero
    [`${Y}-1-1`]:  { name:'A√±o Nuevo', location:'General' },
    [`${Y}-1-20`]: { name:'Fiestas de Cojutepeque', location:'Cojutepeque' },

    // Febrero
    [`${Y}-2-10`]: { name:'Fiesta de Lourdes Col√≥n', location:'Lourdes, Col√≥n' },

    // Abril (Semana Santa)
    [`${Y}-4-1`]: { name:'Mi√©rcoles Santo (Semana Santa)', location:'General' },
    [`${Y}-4-2`]: { name:'Jueves Santo (Semana Santa)', location:'General' },
    [`${Y}-4-3`]: { name:'Viernes Santo (Semana Santa)', location:'General' },
    [`${Y}-4-4`]: { name:'S√°bado de Gloria (Semana Santa)', location:'General' },

    // Mayo
    [`${Y}-5-1`]: { name:'D√≠a del Trabajo', location:'General' },
    [`${Y}-5-10`]:{ name:'D√≠a de la Madre', location:'General' },

    // Junio
    [`${Y}-6-17`]:{ name:'D√≠a del Padre', location:'General' },

    // Agosto
    [`${Y}-8-3`]: { name:'D√≠a del Comercio', location:'General' },
    [`${Y}-8-4`]: { name:'Fiestas Patronales (San Salvador)', location:'San Salvador' },
    [`${Y}-8-5`]: { name:'Fiestas Patronales (San Salvador)', location:'San Salvador' },
    [`${Y}-8-6`]: { name:'D√≠a de El Salvador', location:'General' },

    // Septiembre
    [`${Y}-9-15`]:{ name:'Aniversario de Independencia', location:'General' },

    // Octubre
    [`${Y}-10-2`]:{ name:'V√≠spera del d√≠a del Trabajador de la Industria El√©ctrica', location:'General' },
    [`${Y}-10-3`]:{ name:'D√≠a del Trabajador de la Industria El√©ctrica', location:'General' },

    // Noviembre
    [`${Y}-11-2`]:{ name:'D√≠a de los Difuntos', location:'General' },

    // Diciembre
    [`${Y}-12-8`]: { name:'Fiestas de La Libertad', location:'La Libertad' },
    [`${Y}-12-19`]:{ name:'Fiestas Patronales', location:'Quezaltepeque' }, // + Rosario de la Paz (nota: se guarda como 2 entradas)
    [`${Y}-12-19#2`]:{ name:'Fiestas Patronales', location:'Rosario de la Paz' },
    [`${Y}-12-24`]:{ name:'Navidad', location:'General' },
    [`${Y}-12-25`]:{ name:'Navidad', location:'General' },
    [`${Y}-12-26`]:{ name:'Fiestas Patronales', location:'Zacatecoluca' }, // + San Vicente + Santa Tecla
    [`${Y}-12-26#2`]:{ name:'Fiestas Patronales', location:'San Vicente' },
    [`${Y}-12-26#3`]:{ name:'Fiestas Patronales', location:'Santa Tecla' },
    [`${Y}-12-27`]:{ name:'Fiestas de San Juan Opico', location:'San Juan Opico' },
    [`${Y}-12-31`]:{ name:'Fin de A√±o', location:'General' }
  };
}

/* Carga cat√°logo completo 2023-2027 */
function loadDefaultHolidaysFull(){
  const years = [2023,2024,2025,2026,2027];
  years.forEach(Y=>{
    const cat = defaultHolidayCatalogForYear(Y);
    Object.keys(cat).forEach(k=>{
      // soportar multi-localidad con sufijos #2, #3 => se duplican en keys "reales" (misma fecha) como arrays
      if(k.includes('#')){
        const base = k.split('#')[0];
        if(!db.holidays[base]) db.holidays[base] = { name: cat[k].name, location: cat[k].location, extras: [] };
        if(!db.holidays[base].extras) db.holidays[base].extras = [];
        db.holidays[base].extras.push({ name: cat[k].name, location: cat[k].location });
      }else{
        if(!db.holidays[k]) db.holidays[k] = { name: cat[k].name, location: cat[k].location, extras: [] };
      }
    });
  });

  // asegurar localidades (incluye las del cat√°logo)
  if(!db.localities || !Array.isArray(db.localities)) db.localities=['General','San Salvador'];
  const must = ['General','San Salvador','Cojutepeque','Lourdes, Col√≥n','La Libertad','Quezaltepeque','Rosario de la Paz','Zacatecoluca','San Vicente','Santa Tecla','San Juan Opico'];
  must.forEach(l=>{
    if(!db.localities.some(x=>String(x).trim().toUpperCase()===l.toUpperCase())) db.localities.push(l);
  });
  // unique
  db.localities = Array.from(new Set(db.localities.map(x=>String(x).trim()).filter(Boolean)));
  saveDB();
}

function restoreDefaultHolidays(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  if(!confirm("¬øRestaurar el cat√°logo de asuetos (2023-2027)? Se conservar√°n los existentes (no se borran).")) return;
  loadDefaultHolidaysFull();
  refreshHolidayLocationSelects();
  renderHolidays();
  render();
  alert("Cat√°logo restaurado.");
}

/* =========================================================
   Shifts management helpers
========================================================= */
function ensureShiftExistsForUser(userKey, shiftDef){
  const user = db.users[userKey];
  if(!user) return;
  if(!user.config[shiftDef.key]){
    user.config[shiftDef.key] = { label: shiftDef.label, color: shiftDef.color||'gris', cat: shiftDef.cat||'otro', in: shiftDef.in||'00:00', out: shiftDef.out||'00:00' };
  }
}

function ensureImportBaseShiftsForUser(userKey){
  Object.keys(IMPORT_ABSENCE_MAP).forEach(k => ensureShiftExistsForUser(userKey, IMPORT_ABSENCE_MAP[k]));
  Object.keys(IMPORT_SHIFT_CODE_MAP).forEach(k => ensureShiftExistsForUser(userKey, IMPORT_SHIFT_CODE_MAP[k]));
}

function ensureUserExists(nameUpper){
  const name = String(nameUpper||'').trim().toUpperCase();
  if(!name) return null;
  if(!db.users[name]){
    db.users[name] = JSON.parse(JSON.stringify(db.users['ADMIN']));
    db.users[name].pin = '0000';
    db.users[name].editLocked = false; // default desbloqueado
    db.users[name].data = {};
    db.users[name].locality = 'San Salvador';
    ensureImportBaseShiftsForUser(name);
  }
  return name;
}

/* =========================================================
   Show basic/all shifts toggles
========================================================= */
function toggleShowAllShiftsModal(){
  db.showAllShiftsModal = !db.showAllShiftsModal;
  saveDB();
  document.getElementById('lblShowAllModal').textContent = db.showAllShiftsModal ? 'Mostrar todos' : 'Mostrar solo b√°sicos';
  refreshShiftButtons();
}
function toggleShowAllShiftsSettings(){
  db.showAllShiftsSettings = !db.showAllShiftsSettings;
  saveDB();
  document.getElementById('lblShowAllSettings').textContent = db.showAllShiftsSettings ? 'Mostrar todos' : 'Mostrar solo b√°sicos';
  renderSettings();
}
function toggleShowAllShiftsSettingsInitLabel(){
  document.getElementById('lblShowAllSettings').textContent = db.showAllShiftsSettings ? 'Mostrar todos' : 'Mostrar solo b√°sicos';
}
function toggleShowAllShiftsModalInitLabel(){
  document.getElementById('lblShowAllModal').textContent = db.showAllShiftsModal ? 'Mostrar todos' : 'Mostrar solo b√°sicos';
}

function getShiftIdsForUI(userConfig){
  const all = Object.keys(userConfig);
  if(db.showAllShiftsModal || db.showAllShiftsSettings) return all.sort();
  // basic first, then any that are used in current month (so no ‚Äúpierdes‚Äù turnos)
  const used = new Set();
  const y=current.getFullYear(), m1=current.getMonth()+1;
  const u=db.users[db.current];
  Object.keys(u.data).forEach(k=>{
    if(!k.startsWith(`${y}-${m1}-`)) return;
    const d=u.data[k];
    if(d.mode==='mixto'){ used.add(d.t); used.add(d.b); }
    else used.add(d.s);
  });
  const basic = [...BASIC_SHIFT_IDS].filter(x=>userConfig[x]);
  const extra = all.filter(x=>!basic.includes(x) && used.has(x)).sort();
  return [...basic, ...extra];
}

/* =========================================================
   Standard note generator
========================================================= */
function stdNoteFromTimes(inT, outT, fallbackLabel){
  if(inT && outT && !(inT==='00:00'&&outT==='00:00')) return `${inT}-${outT}`;
  return (fallbackLabel||'').toUpperCase();
}

/* =========================================================
   UI Init
========================================================= */
function init(){
  initSelectors();
  loadDefaultHolidaysFull();     // cat√°logo completo
  ensureImportBaseShiftsForUser('ADMIN');
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  toggleShowAllShiftsSettingsInitLabel();
  toggleShowAllShiftsModalInitLabel();
  render();
  updateUIEditMode();
}

function initSelectors(){
  const mSel = document.getElementById('selectMonth');
  const ySel = document.getElementById('selectYear');
  const iMonth = document.getElementById('importMonth');
  const iYear = document.getElementById('importYear');
  const eMonth = document.getElementById('exportMonth');
  const eYear = document.getElementById('exportYear');

  [mSel,iMonth,eMonth].forEach(sel=>{
    sel.innerHTML='';
    MONTHS.forEach((m,i)=> sel.innerHTML += `<option value="${i}">${m}</option>`);
  });

  [ySel,iYear,eYear].forEach(sel=>{
    sel.innerHTML='';
    for(let y=2023;y<=2027;y++){
      sel.innerHTML += `<option value="${y}" ${y===new Date().getFullYear()?'selected':''}>${y}</option>`;
    }
  });
}

/* =========================================================
   Month display + navigation
========================================================= */
function updateMonthDisplay(){
  const y=current.getFullYear();
  const m=current.getMonth();
  document.getElementById('currentMonthDisplay').textContent = `${MONTHS[m]} ${y}`;
  document.getElementById('selectMonth').value = m;
  document.getElementById('selectYear').value = y;
}
function changeMonth(v){ current.setMonth(current.getMonth()+v); updateMonthDisplay(); render(); }
function jumpToDate(){
  current.setMonth(parseInt(document.getElementById('selectMonth').value));
  current.setFullYear(parseInt(document.getElementById('selectYear').value));
  updateMonthDisplay(); render();
}
function goToday(){ current = new Date(); updateMonthDisplay(); render(); }

/* =========================================================
   View switching
========================================================= */
function showView(v){
  document.querySelectorAll('.view-section').forEach(s=>s.classList.remove('view-active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('tab-active'));
  document.getElementById('view-'+v).classList.add('view-active');
  document.getElementById('tab-'+v).classList.add('tab-active');

  if(v==='settings'){
    updateUIEditMode();
    if(isEditMode()) showConfigTab('turnos');
  }
  if(v==='summary'){
    calcSummary(); // asegurar que se actualice al entrar
  }
}

function showConfigTab(tab){
  document.querySelectorAll('.config-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(`config-${tab}`).classList.add('active');

  document.querySelectorAll('.config-tab-content').forEach(c=>c.classList.add('hidden'));
  document.getElementById(`tab-${tab}`).classList.remove('hidden');

  if(tab==='turnos'){ renderSettings(); }
  if(tab==='nuevo'){ loadCategoriesSelect(); }
  if(tab==='categorias'){ renderCategories(); }
  if(tab==='localidades'){ renderLocalities(); }
  if(tab==='asuetos'){ refreshHolidayLocationSelects(); renderHolidays(); }
}

/* =========================================================
   Edit mode + PIN rules
   - Admin universal pin desbloquea cualquiera.
   - El pin de un perfil NO desbloquea ADMIN.
========================================================= */
function updateUIEditMode(){
  const configContent = document.getElementById('config-content');
  const lockedMessage = document.getElementById('settings-locked');

  if(isEditMode()){
    configContent.classList.remove('hidden');
    lockedMessage.classList.add('hidden');
    document.getElementById('editStatus').innerText = "MODO EDICI√ìN ACTIVADO";
    document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-emerald-400";
    const btn = document.getElementById('unlockBtn');
    if(btn){
      btn.innerText = "üîí Bloquear";
      btn.className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
    }
    const btnM = document.getElementById('unlockBtnM');
    if(btnM){
      btnM.innerText = "üîí";
      btnM.className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
    }
  } else {
    configContent.classList.add('hidden');
    lockedMessage.classList.remove('hidden');
    document.getElementById('editStatus').innerText = "MODO VISTA";
    document.getElementById('editStatus').className = "text-[10px] font-black uppercase text-gray-400";
    const btn = document.getElementById('unlockBtn');
    if(btn){
      btn.innerText = "üîì Editar";
      btn.className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
    }
    const btnM = document.getElementById('unlockBtnM');
    if(btnM){
      btnM.innerText = "üîì";
      btnM.className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
    }
  }
}

function canUnlockWithPin(userKey, pin){
  const user = db.users[userKey];
  if(!user) return false;

  // Admin universal pin siempre funciona
  if(pin === ADMIN_UNIVERSAL_PIN) return true;

  // Si el perfil objetivo es ADMIN, solo ADMIN.pin o universal
  if(userKey === 'ADMIN'){
    return pin === (db.users['ADMIN'].pin || '');
  }

  // Para cualquier otro perfil: pin propio o universal
  return pin === (user.pin || '');
}

function toggleEditMode(){
  const userKey = db.current;
  const user = db.users[userKey];
  if(!user) return;

  if(isEditMode()){
    const p = prompt("Ingresa PIN para bloquear la edici√≥n:");
    if(!canUnlockWithPin(userKey, p)) return alert("PIN incorrecto");
    user.editLocked = true;
    saveDB();
    alert("Edici√≥n bloqueada");
  } else {
    const p = prompt("Ingresa PIN para editar:");
    if(!canUnlockWithPin(userKey, p)) return alert("PIN incorrecto");
    user.editLocked = false;
    saveDB();
    alert("Edici√≥n activada");
  }
  updateUIEditMode();
}

/* =========================================================
   Users dropdown + initial
========================================================= */
function updateUserDropdown(){
  const select = document.getElementById('userSelect');
  select.innerHTML = Object.keys(db.users).sort().map(u => `<option value="${u}" ${u===db.current?'selected':''}>${u}</option>`).join('');
}
function updateUserInitial(){ document.getElementById('userInitial').textContent = db.current.charAt(0); }
function switchUser(){
  db.current = document.getElementById('userSelect').value;
  updateUserInitial();
  render();
  updateUIEditMode();
}

/* =========================================================
   Calendar render
========================================================= */
function render(){
  const grid=document.getElementById('calendar');
  grid.innerHTML='';

  const y=current.getFullYear();
  const m=current.getMonth();
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const today = new Date();
  const todayKey = dayKey(today.getFullYear(), today.getMonth()+1, today.getDate());

  const firstDay = new Date(y,m,1).getDay();
  const firstDayMonday = firstDay===0?6:firstDay-1;
  const lastDate = new Date(y,m+1,0).getDate();
  const prevLastDate = new Date(y,m,0).getDate();

  // prev filler
  for(let i=firstDayMonday;i>0;i--){
    const prevDay=prevLastDate-i+1;
    const prevMonth = m===0?12:m;
    const prevYear = m===0?y-1:y;
    const key = dayKey(prevYear, prevMonth, prevDay);
    const info=user.data[key];

    const cell=document.createElement('div');
    cell.className='day-cell day-off-month';
    if(info){
      if(info.mode==='mixto'){
        cell.innerHTML = `
          <div class="shift-label bg-${SHIFTS[info.t]?.color||'L'}">${SHIFTS[info.t]?.label||'L'}</div>
          <div class="shift-label bg-${SHIFTS[info.b]?.color||'L'}">${SHIFTS[info.b]?.label||'L'}</div>`;
      } else {
        const label = info.s==='L'?'L':(SHIFTS[info.s]?.label||info.s||'L');
        cell.innerHTML = `<div class="shift-label bg-${SHIFTS[info.s]?.color||'L'}">${label}</div>`;
      }
    }
    const h = getHolidayForDate(key);
    if(h && holidayApplies(h.location, user.locality)) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
    cell.innerHTML += `<span class="day-number">${prevDay}</span>`;

    if(info){
      if(info.mode==='mixto'){
        if(info.nt) cell.innerHTML += `<div class="note-top">${escapeHTML(info.nt)}</div>`;
        if(info.nb) cell.innerHTML += `<div class="note-bottom">${escapeHTML(info.nb)}</div>`;
      } else {
        if(info.n) cell.innerHTML += `<div class="note-text">${escapeHTML(info.n)}</div>`;
      }
    }
    cell.onclick=()=>openDay(key, info || {mode:'simple', s:'L', n:'', nAuto:true});
    grid.appendChild(cell);
  }

  // month days
  for(let d=1; d<=lastDate; d++){
    const key=dayKey(y,m+1,d);
    const info=user.data[key] || {mode:'simple', s:'L', n:'', nAuto:true};
    const cell=document.createElement('div');

    let classes='day-cell';
    const dow=new Date(y,m,d).getDay();
    if(dow===0 || dow===6) classes+=' weekend';
    if(key===todayKey) classes+=' today';
    cell.className=classes;

    if(info.mode==='mixto'){
      cell.innerHTML=`
        <div class="shift-label bg-${SHIFTS[info.t]?.color||'L'}">${SHIFTS[info.t]?.label||'L'}</div>
        <div class="shift-label bg-${SHIFTS[info.b]?.color||'L'}">${SHIFTS[info.b]?.label||'L'}</div>`;
    } else {
      const label = info.s==='L'?'L':(SHIFTS[info.s]?.label||info.s||'L');
      cell.innerHTML = `<div class="shift-label bg-${SHIFTS[info.s]?.color||'L'}">${label}</div>`;
    }

    const h = getHolidayForDate(key);
    if(h && holidayApplies(h.location, user.locality)) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
    cell.innerHTML += `<span class="day-number">${d}</span>`;

    // notes
    if(info.mode==='mixto'){
      if(info.nt) cell.innerHTML += `<div class="note-top">${escapeHTML(info.nt)}</div>`;
      if(info.nb) cell.innerHTML += `<div class="note-bottom">${escapeHTML(info.nb)}</div>`;
    } else {
      if(info.n) cell.innerHTML += `<div class="note-text">${escapeHTML(info.n)}</div>`;
    }

    cell.onclick=()=>{
      if(!isEditMode()) return alert("Activa modo edici√≥n para editar.");
      openDay(key, info);
    };

    grid.appendChild(cell);
  }

  // next filler
  const total = firstDayMonday + lastDate;
  for(let i=1; i<= (42-total); i++){
    const nextMonth = m===11?1:m+2;
    const nextYear = m===11?y+1:y;
    const key = dayKey(nextYear, nextMonth, i);

    const cell=document.createElement('div');
    cell.className='day-cell day-off-month';
    const h = getHolidayForDate(key);
    if(h && holidayApplies(h.location, user.locality)) cell.innerHTML += `<div class="holiday-indicator">A</div>`;
    cell.innerHTML += `<span class="day-number">${i}</span>`;
    grid.appendChild(cell);
  }

  calcSummary();
}

/* =========================================================
   Modal day edit
========================================================= */
function openDay(key, info){
  activeKey = key;

  const user=db.users[db.current];
  const SHIFTS=user.config;

  // info normalization
  mode = info.mode || 'simple';
  selS = info.s || 'Ma√±ana';
  selT = info.t || 'Ma√±ana';
  selB = info.b || 'Tarde';

  // title
  const [yy,mm,dd]=key.split('-');
  document.getElementById('modalDate').textContent = `${dd} de ${MONTHS[parseInt(mm)-1]} de ${yy}`;

  // holiday detail (visible en modal)
  const h = getHolidayForDate(key);
  if(h){
    // si hay extras (multi-localidad), mostrarlas
    const raw = db.holidays[key];
    let extraTxt = '';
    if(raw && Array.isArray(raw.extras) && raw.extras.length){
      const extras = raw.extras.map(x=>`${x.name} ‚Ä¢ ${x.location}`).join(' | ');
      extraTxt = ` | Otros: ${extras}`;
    }
    document.getElementById('modalHolidayInfo').textContent = `üéâ ASUETO: ${h.name} ‚Ä¢ Localidad: ${h.location}${extraTxt}`;
  } else {
    document.getElementById('modalHolidayInfo').textContent = '';
  }

  // reset auto-note flags based on stored flags
  noteAutoSimple = (info.nAuto !== false);
  noteAutoTop = (info.ntAuto !== false);
  noteAutoBottom = (info.nbAuto !== false);

  // bind note manual-change => desactiva auto
  const notaEl = document.getElementById('nota');
  const notaTopEl = document.getElementById('notaTop');
  const notaBottomEl = document.getElementById('notaBottom');

  notaEl.oninput = ()=>{ noteAutoSimple = false; };
  notaTopEl.oninput = ()=>{ noteAutoTop = false; };
  notaBottomEl.oninput = ()=>{ noteAutoBottom = false; };

  if(mode==='simple'){
    document.getElementById('tIn').value = info.tIn || (SHIFTS[selS]?.in || '00:00');
    document.getElementById('tOut').value = info.tOut || (SHIFTS[selS]?.out || '00:00');
    document.getElementById('tHrs').value = (info.h ?? calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value)).toFixed(1);

    document.getElementById('time-simple').classList.remove('hidden');
    document.getElementById('time-mixto').classList.add('hidden');

    // note
    if(String(info.n||'').trim()){
      document.getElementById('nota').value = info.n;
    } else {
      const std = stdNoteFromTimes(document.getElementById('tIn').value, document.getElementById('tOut').value, SHIFTS[selS]?.label||selS);
      document.getElementById('nota').value = std;
      noteAutoSimple = true;
    }
  } else {
    document.getElementById('tInTop').value = info.tInTop || (SHIFTS[selT]?.in || '00:00');
    document.getElementById('tOutTop').value = info.tOutTop || (SHIFTS[selT]?.out || '00:00');
    document.getElementById('tInBottom').value = info.tInBottom || (SHIFTS[selB]?.in || '00:00');
    document.getElementById('tOutBottom').value = info.tOutBottom || (SHIFTS[selB]?.out || '00:00');

    const hrsTop = info.hrsTop ?? calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
    const hrsBottom = info.hrsBottom ?? calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);

    document.getElementById('tHrsTop').value = Number(hrsTop).toFixed(1);
    document.getElementById('tHrsBottom').value = Number(hrsBottom).toFixed(1);
    document.getElementById('tHrsMixto').value = Number(hrsTop+hrsBottom).toFixed(1);

    document.getElementById('time-simple').classList.add('hidden');
    document.getElementById('time-mixto').classList.remove('hidden');

    // notes top/bottom
    if(String(info.nt||'').trim()){
      document.getElementById('notaTop').value = info.nt;
    } else {
      document.getElementById('notaTop').value = stdNoteFromTimes(document.getElementById('tInTop').value, document.getElementById('tOutTop').value, SHIFTS[selT]?.label||selT);
      noteAutoTop = true;
    }

    if(String(info.nb||'').trim()){
      document.getElementById('notaBottom').value = info.nb;
    } else {
      document.getElementById('notaBottom').value = stdNoteFromTimes(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value, SHIFTS[selB]?.label||selB);
      noteAutoBottom = true;
    }
  }

  setMode(mode);
  refreshShiftButtons();
  document.getElementById('modal').classList.add('active');
}

function closeModal(){ document.getElementById('modal').classList.remove('active'); }

function setMode(m){
  mode=m;
  document.getElementById('m-s').className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m==='simple'?'bg-white shadow-md text-blue-600':'text-gray-400'}`;
  document.getElementById('m-m').className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m==='mixto'?'bg-white shadow-md text-blue-600':'text-gray-400'}`;
  document.getElementById('sec-simple').classList.toggle('hidden', m!=='simple');
  document.getElementById('sec-mixto').classList.toggle('hidden', m!=='mixto');

  // mostrar el panel correcto
  if(m==='simple'){
    document.getElementById('time-simple').classList.remove('hidden');
    document.getElementById('time-mixto').classList.add('hidden');
  }else{
    document.getElementById('time-simple').classList.add('hidden');
    document.getElementById('time-mixto').classList.remove('hidden');
  }
}

/* Auto note updates */
function autoNoteUpdateSimple(){
  if(!noteAutoSimple) return;
  const inT = document.getElementById('tIn').value;
  const outT = document.getElementById('tOut').value;
  const user=db.users[db.current];
  const sh=user.config[selS];
  document.getElementById('nota').value = stdNoteFromTimes(inT, outT, (sh?.label||selS));
}
function autoNoteUpdateMixto(part){
  if(part==='t' && !noteAutoTop) return;
  if(part==='b' && !noteAutoBottom) return;

  const user=db.users[db.current];
  if(part==='t'){
    const inT = document.getElementById('tInTop').value;
    const outT = document.getElementById('tOutTop').value;
    const sh=user.config[selT];
    document.getElementById('notaTop').value = stdNoteFromTimes(inT, outT, (sh?.label||selT));
  }else{
    const inT = document.getElementById('tInBottom').value;
    const outT = document.getElementById('tOutBottom').value;
    const sh=user.config[selB];
    document.getElementById('notaBottom').value = stdNoteFromTimes(inT, outT, (sh?.label||selB));
  }
}

function refreshShiftButtons(){
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const ids = getShiftIdsForUI(SHIFTS);

  const mkBtn=(k, selected)=>{
    const b=document.createElement('div');
    b.className = `shift-option ${selected?'selected':''} bg-${SHIFTS[k]?.color||'L'}`;
    b.textContent = SHIFTS[k]?.label || k;
    return b;
  };

  // SIMPLE
  const sC=document.getElementById('sec-simple');
  sC.innerHTML='';
  ids.forEach(k=>{
    const b=mkBtn(k, selS===k);
    b.onclick=()=>{
      selS=k;
      document.getElementById('tIn').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOut').value = SHIFTS[k]?.out || '00:00';
      autoCalc();

      // al seleccionar turno, SIEMPRE dejar el comentario auto (a menos que el usuario lo edit√≥ en esta sesi√≥n)
      noteAutoSimple = true;
      autoNoteUpdateSimple();

      refreshShiftButtons();
    };
    sC.appendChild(b);
  });

  // MIXTO TOP
  const tC=document.getElementById('mix-t');
  tC.innerHTML='';
  ids.forEach(k=>{
    const b=mkBtn(k, selT===k);
    b.onclick=()=>{
      selT=k;
      document.getElementById('tInTop').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOutTop').value = SHIFTS[k]?.out || '00:00';
      autoCalcMixtoTop();

      noteAutoTop = true;
      autoNoteUpdateMixto('t');

      refreshShiftButtons();
    };
    tC.appendChild(b);
  });

  // MIXTO BOTTOM
  const bC=document.getElementById('mix-b');
  bC.innerHTML='';
  ids.forEach(k=>{
    const b=mkBtn(k, selB===k);
    b.onclick=()=>{
      selB=k;
      document.getElementById('tInBottom').value = SHIFTS[k]?.in || '00:00';
      document.getElementById('tOutBottom').value = SHIFTS[k]?.out || '00:00';
      autoCalcMixtoBottom();

      noteAutoBottom = true;
      autoNoteUpdateMixto('b');

      refreshShiftButtons();
    };
    bC.appendChild(b);
  });
}

/* Hours calc */
function autoCalc(){
  const hrs=calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value);
  document.getElementById('tHrs').value = hrs.toFixed(1);
}
function manualCalc(){
  const v=parseFloat(document.getElementById('tHrs').value)||0;
  document.getElementById('tHrs').value=v.toFixed(1);
}
function autoCalcMixtoTop(){
  const hrs=calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
  document.getElementById('tHrsTop').value = hrs.toFixed(1);
  updateMixtoTotal();
}
function manualCalcMixtoTop(){
  const v=parseFloat(document.getElementById('tHrsTop').value)||0;
  document.getElementById('tHrsTop').value=v.toFixed(1);
  updateMixtoTotal();
}
function autoCalcMixtoBottom(){
  const hrs=calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);
  document.getElementById('tHrsBottom').value = hrs.toFixed(1);
  updateMixtoTotal();
}
function manualCalcMixtoBottom(){
  const v=parseFloat(document.getElementById('tHrsBottom').value)||0;
  document.getElementById('tHrsBottom').value=v.toFixed(1);
  updateMixtoTotal();
}
function updateMixtoTotal(){
  const t=parseFloat(document.getElementById('tHrsTop').value)||0;
  const b=parseFloat(document.getElementById('tHrsBottom').value)||0;
  document.getElementById('tHrsMixto').value=(t+b).toFixed(1);
}

function saveDay(){
  const user=db.users[db.current];
  const data = { mode, s:selS, t:selT, b:selB };

  if(mode==='simple'){
    data.tIn = document.getElementById('tIn').value;
    data.tOut = document.getElementById('tOut').value;
    data.h = parseFloat(document.getElementById('tHrs').value)||0;

    data.n = document.getElementById('nota').value;
    data.nAuto = noteAutoSimple;

    // si qued√≥ vac√≠o, reponer est√°ndar
    if(!String(data.n||'').trim()){
      data.n = stdNoteFromTimes(data.tIn, data.tOut, (user.config[selS]?.label||selS));
      data.nAuto = true;
    }
  } else {
    data.tInTop = document.getElementById('tInTop').value;
    data.tOutTop = document.getElementById('tOutTop').value;
    data.tInBottom = document.getElementById('tInBottom').value;
    data.tOutBottom = document.getElementById('tOutBottom').value;

    data.hrsTop = parseFloat(document.getElementById('tHrsTop').value)||0;
    data.hrsBottom = parseFloat(document.getElementById('tHrsBottom').value)||0;
    data.h = parseFloat(document.getElementById('tHrsMixto').value)||0;

    data.nt = document.getElementById('notaTop').value;
    data.nb = document.getElementById('notaBottom').value;
    data.ntAuto = noteAutoTop;
    data.nbAuto = noteAutoBottom;

    if(!String(data.nt||'').trim()){
      data.nt = stdNoteFromTimes(data.tInTop, data.tOutTop, (user.config[selT]?.label||selT));
      data.ntAuto = true;
    }
    if(!String(data.nb||'').trim()){
      data.nb = stdNoteFromTimes(data.tInBottom, data.tOutBottom, (user.config[selB]?.label||selB));
      data.nbAuto = true;
    }
  }

  user.data[activeKey]=data;
  saveDB();
  render();
  closeModal();
}

/* =========================================================
   Summary (DIN√ÅMICO por categor√≠as)
========================================================= */
function calcSummary(){
  const y=current.getFullYear();
  const m0=current.getMonth();
  const m1=m0+1;
  const user=db.users[db.current];
  const SHIFTS=user.config;

  const daysInMonth = new Date(y,m0+1,0).getDate();

  // Contadores generales
  let workedDays=0, weekendDays=0, freeDays=0, vacDays=0, faltaDays=0, holidayWorked=0;
  const applicableHolidays = countApplicableHolidaysInMonth(y,m0,user.locality);

  // Por categor√≠a
  const catAgg = {}; // cid -> {hrs, units}
  Object.keys(db.categories).forEach(cid=> catAgg[cid]={hrs:0, units:0});

  // Iniciales
  freeDays = 0;

  for(let d=1; d<=daysInMonth; d++){
    const key = dayKey(y,m1,d);
    const dow = new Date(y,m0,d).getDay();
    if(dow===0 || dow===6) weekendDays++;

    const entry = user.data[key];
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);

    if(!entry){
      // d√≠a sin registro => se considera Libre (para tu m√©trica general)
      freeDays++;
      continue;
    }

    if(entry.mode==='mixto'){
      // TOP
      const topId = entry.t;
      const topCat = SHIFTS[topId]?.cat || 'otro';
      const topHrs = (entry.hrsTop ?? calculateHours(entry.tInTop||SHIFTS[topId]?.in, entry.tOutTop||SHIFTS[topId]?.out)) || 0;
      catAgg[topCat] = catAgg[topCat] || {hrs:0, units:0};
      catAgg[topCat].hrs += topHrs;
      catAgg[topCat].units += 1;

      // BOTTOM
      const botId = entry.b;
      const botCat = SHIFTS[botId]?.cat || 'otro';
      const botHrs = (entry.hrsBottom ?? calculateHours(entry.tInBottom||SHIFTS[botId]?.in, entry.tOutBottom||SHIFTS[botId]?.out)) || 0;
      catAgg[botCat] = catAgg[botCat] || {hrs:0, units:0};
      catAgg[botCat].hrs += botHrs;
      catAgg[botCat].units += 1;

      // Workdays: si cualquiera de las dos categor√≠as cuenta como trabajo
      const topWork = !!db.categories[topCat]?.countsAsWork;
      const botWork = !!db.categories[botCat]?.countsAsWork;
      if(topWork || botWork) workedDays++;

      // Holiday worked
      if(isHoliday && (topWork || botWork)) holidayWorked++;

      // Vac/falta/free: sumar si aplica por cada mitad
      if(topCat==='off' && topId==='Vacaciones') vacDays++;
      if(botCat==='off' && botId==='Vacaciones') vacDays++;
      if(topCat==='falta') faltaDays++;
      if(botCat==='falta') faltaDays++;
      if(topCat==='off' && topId==='L') freeDays++;
      if(botCat==='off' && botId==='L') freeDays++;

    } else {
      const sid = entry.s;
      const cat = SHIFTS[sid]?.cat || 'otro';
      const hrs = (entry.h ?? calculateHours(entry.tIn||SHIFTS[sid]?.in, entry.tOut||SHIFTS[sid]?.out)) || 0;
      catAgg[cat] = catAgg[cat] || {hrs:0, units:0};
      catAgg[cat].hrs += hrs;
      catAgg[cat].units += 1;

      const isWork = !!db.categories[cat]?.countsAsWork;
      if(isWork) workedDays++;
      if(isHoliday && isWork) holidayWorked++;

      if(cat==='off' && sid==='Vacaciones') vacDays++;
      if(cat==='off' && sid==='L') freeDays++;
      if(cat==='falta') faltaDays++;
    }
  }

  // Total hrs trabajo para promedio (sumar solo categor√≠as work)
  let totalWorkHrs = 0;
  Object.keys(catAgg).forEach(cid=>{
    if(db.categories[cid]?.countsAsWork) totalWorkHrs += (catAgg[cid]?.hrs||0);
  });
  const avg = workedDays>0 ? (totalWorkHrs/workedDays) : 0;

  // UI
  document.getElementById('profile-loc').textContent = user.locality || 'San Salvador';
  document.getElementById('worked-days').textContent = workedDays;
  document.getElementById('weekend-days').textContent = weekendDays;
  document.getElementById('free-days').textContent = freeDays;
  document.getElementById('vac-days').textContent = vacDays;
  document.getElementById('falta-days').textContent = faltaDays;
  document.getElementById('holiday-worked').textContent = holidayWorked;
  document.getElementById('total-holidays').textContent = applicableHolidays;
  document.getElementById('avg-hours').textContent = `${avg.toFixed(1)}h`;
  document.getElementById('total-days').textContent = daysInMonth;
  document.getElementById('summary-month').textContent = `${MONTHS[m0]} ${y}`;

  // Cards din√°micas: mostrar categor√≠as con hrs>0 o units>0 (y siempre off/falta si hay)
  const cards = [];
  Object.keys(db.categories).forEach(cid=>{
    const meta = db.categories[cid];
    const a = catAgg[cid] || {hrs:0, units:0};
    if(a.hrs>0 || a.units>0 || cid==='off' || cid==='falta'){
      cards.push({cid, name:meta.name, icon:meta.icon, hrs:a.hrs, units:a.units, work:!!meta.countsAsWork});
    }
  });

  // ordenar: primero las de trabajo con m√°s horas, luego off/falta
  cards.sort((A,B)=>{
    const aw=A.work?1:0, bw=B.work?1:0;
    if(aw!==bw) return bw-aw;
    return (B.hrs||0)-(A.hrs||0);
  });

  const container = document.getElementById('summary-cards');
  container.innerHTML = cards.map(c=>{
    const badge = c.work ? `<span class="text-[10px] font-black bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full">Horas</span>`
                         : `<span class="text-[10px] font-black bg-gray-100 text-gray-700 px-2 py-1 rounded-full">No labor</span>`;
    const leftBorder = c.work ? 'border-emerald-400' : (c.cid==='falta' ? 'border-amber-500' : 'border-gray-300');
    return `
      <div class="bg-white p-4 rounded-3xl shadow-sm border-l-[10px] ${leftBorder}">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-400 uppercase">${escapeHTML(c.icon)} ${escapeHTML(c.name)}</p>
          ${badge}
        </div>
        <div class="flex items-end justify-between">
          <h2 class="text-3xl md:text-4xl font-black text-gray-900 tracking-tighter">${(c.hrs||0).toFixed(1)} HRS</h2>
          <div class="text-[10px] font-bold text-gray-500">${c.units||0} registro(s)</div>
        </div>
      </div>
    `;
  }).join('');
}

/* =========================================================
   Turnos settings + propagation
========================================================= */
function renderSettings(){
  const container=document.getElementById('settings-container');
  container.innerHTML='';
  const user=db.users[db.current];
  const SHIFTS=user.config;

  // lista: b√°sicos primero, luego dem√°s
  const idsAll = Object.keys(SHIFTS).sort();
  const ids = db.showAllShiftsSettings ? idsAll : [...BASIC_SHIFT_IDS.filter(x=>SHIFTS[x]), ...idsAll.filter(x=>!BASIC_SHIFT_IDS.includes(x))];

  ids.forEach(id=>{
    const conf=SHIFTS[id];
    container.innerHTML += `
      <div class="flex flex-col md:flex-row items-start gap-3 bg-gradient-to-r from-gray-50 to-white p-4 rounded-2xl border border-gray-200">
        <div class="w-10 h-10 rounded-full bg-${conf.color} border-2 border-white shadow-sm flex items-center justify-center">
          <span class="text-[10px] font-black text-gray-800">${escapeHTML((conf.label||id).charAt(0))}</span>
        </div>

        <div class="flex-1">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</p>
              <input id="set-label-${cssSafe(id)}" value="${escapeHTML(conf.label||id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Categor√≠a</p>
              <select id="set-cat-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
                ${Object.keys(db.categories).map(cid=>{
                  const c=db.categories[cid];
                  return `<option value="${cid}" ${conf.cat===cid?'selected':''}>${escapeHTML(c.icon)} ${escapeHTML(c.name)}</option>`;
                }).join('')}
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Color</p>
              <select id="set-color-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
                ${['Ma√±ana','Tarde','CENA','16hrs','Cumplea√±os','L','Vacaciones','azul','rojo','verde','naranja','rosa','cian','morado','lima','ambar','teal','indigo','gris'].map(x=>`<option value="${x}" ${conf.color===x?'selected':''}>${x}</option>`).join('')}
              </select>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Entrada</p>
              <input type="time" id="set-in-${cssSafe(id)}" value="${conf.in||'00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Salida</p>
              <input type="time" id="set-out-${cssSafe(id)}" value="${conf.out||'00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
          </div>

          <div class="mt-2 text-[10px] font-bold text-gray-600">
            Nota sugerida:
            <span class="text-gray-900 font-black">${stdNoteFromTimes(conf.in, conf.out, (conf.label||id))}</span>
          </div>
        </div>

        <div class="flex gap-2">
          <button onclick="deleteShift('${escapeAttr(id)}')" class="p-2 text-red-600 hover:text-red-800 font-black" title="Eliminar turno">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });

  loadCategoriesSelect();
}

function saveShiftSettings(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const user=db.users[db.current];
  const SHIFTS=user.config;
  const propagate = document.getElementById('propagateShiftEdits').checked;

  const old = JSON.parse(JSON.stringify(SHIFTS));

  Object.keys(SHIFTS).forEach(id=>{
    const key = cssSafe(id);
    const label = document.getElementById(`set-label-${key}`)?.value?.trim() || id;
    const cat = document.getElementById(`set-cat-${key}`)?.value || SHIFTS[id].cat;
    const color = document.getElementById(`set-color-${key}`)?.value || SHIFTS[id].color;
    const inT = document.getElementById(`set-in-${key}`)?.value || SHIFTS[id].in || '00:00';
    const outT = document.getElementById(`set-out-${key}`)?.value || SHIFTS[id].out || '00:00';

    SHIFTS[id].label = label;
    SHIFTS[id].cat = cat;
    SHIFTS[id].color = color;
    SHIFTS[id].in = inT;
    SHIFTS[id].out = outT;
  });

  if(propagate){
    const y=current.getFullYear();
    const m1=current.getMonth()+1;

    Object.keys(user.data).forEach(k=>{
      if(!k.startsWith(`${y}-${m1}-`)) return;
      const d = user.data[k];

      if(d.mode==='simple'){
        const sid = d.s;
        if(!sid || !SHIFTS[sid]) return;
        const was = old[sid];
        const now = SHIFTS[sid];

        // actualizar horas guardadas siempre que cambien los tiempos
        if(was && (was.in!==now.in || was.out!==now.out)){
          d.tIn = now.in; d.tOut = now.out; d.h = calculateHours(now.in, now.out);
          const oldStd = stdNoteFromTimes(was.in, was.out, (was.label||sid));
          const newStd = stdNoteFromTimes(now.in, now.out, (now.label||sid));
          const wasNote = String(d.n||'').trim();
          if(d.nAuto !== false && (!wasNote || wasNote===oldStd)){
            d.n = newStd;
            d.nAuto = true;
          }
        }
      } else if(d.mode==='mixto'){
        const applyPart = (partKey, inField, outField, hrsField, noteField, noteAutoField)=>{
          const sid = d[partKey];
          if(!sid || !SHIFTS[sid]) return;
          const was=old[sid], now=SHIFTS[sid];
          if(was && (was.in!==now.in || was.out!==now.out)){
            d[inField]=now.in; d[outField]=now.out;
            d[hrsField]=calculateHours(now.in, now.out);

            const oldStd = stdNoteFromTimes(was.in, was.out, (was.label||sid));
            const newStd = stdNoteFromTimes(now.in, now.out, (now.label||sid));
            const wasNote = String(d[noteField]||'').trim();

            if(d[noteAutoField] !== false && (!wasNote || wasNote===oldStd)){
              d[noteField] = newStd;
              d[noteAutoField] = true;
            }
          }
        };

        applyPart('t','tInTop','tOutTop','hrsTop','nt','ntAuto');
        applyPart('b','tInBottom','tOutBottom','hrsBottom','nb','nbAuto');
        d.h = (parseFloat(d.hrsTop)||0)+(parseFloat(d.hrsBottom)||0);
      }
    });
  }

  saveDB();
  render();
  alert("Turnos actualizados.");
}

function deleteShift(id){
  const user=db.users[db.current];
  // permitir eliminar incluso b√°sicos (seg√∫n tu petici√≥n), excepto si est√° en uso
  const used = Object.values(user.data).some(d=>{
    if(d.mode==='mixto') return d.t===id || d.b===id;
    return d.s===id;
  });
  if(used) return alert("No se puede eliminar: el turno est√° usado en el calendario del perfil.");

  if(!confirm(`¬øEliminar turno "${id}"?`)) return;
  delete user.config[id];
  saveDB();
  renderSettings();
  render();
}

/* =========================================================
   New shift
========================================================= */
function selectColor(color, ev){
  selectedColor=color;
  document.getElementById('newShiftColor').value=color;
  document.querySelectorAll('.color-option').forEach(o=>o.classList.remove('selected'));
  if(ev?.target) ev.target.classList.add('selected');
}
function loadCategoriesSelect(){
  const select=document.getElementById('newShiftCat');
  if(!select) return;
  select.innerHTML = Object.keys(db.categories).map(cid=>{
    const c=db.categories[cid];
    return `<option value="${cid}">${escapeHTML(c.icon)} ${escapeHTML(c.name)}</option>`;
  }).join('');
}
function addNewShift(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const name=document.getElementById('newShiftName').value.trim();
  const color=document.getElementById('newShiftColor').value;
  const cat=document.getElementById('newShiftCat').value;
  const inT=document.getElementById('newShiftIn').value||'00:00';
  const outT=document.getElementById('newShiftOut').value||'00:00';

  if(!name) return alert("Nombre requerido.");
  const key = name.replace(/\s+/g,'_');
  const user=db.users[db.current];
  if(user.config[key]) return alert("Ya existe un turno con ese nombre (ID).");

  user.config[key]={ label:name, color, cat, in:inT, out:outT };
  saveDB();
  renderSettings();
  render();
  document.getElementById('newShiftName').value='';
  document.getElementById('newShiftIn').value='';
  document.getElementById('newShiftOut').value='';
  alert("Turno agregado.");
}

/* =========================================================
   Categories: editable (all)
========================================================= */
function renderCategories(){
  const container=document.getElementById('categories-container');
  container.innerHTML='';

  const ids=Object.keys(db.categories).sort((a,b)=>db.categories[a].name.localeCompare(db.categories[b].name));
  ids.forEach(cid=>{
    const c=db.categories[cid];
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-lg">${escapeHTML(c.icon||'üîß')}</div>
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="cat-name-${cid}" value="${escapeHTML(c.name||'')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Icono</div>
            <input id="cat-icon-${cid}" value="${escapeHTML(c.icon||'')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" maxlength="4"/>
          </div>
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Cuenta como trabajo</div>
            <select id="cat-work-${cid}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
              <option value="1" ${c.countsAsWork?'selected':''}>S√≠</option>
              <option value="0" ${!c.countsAsWork?'selected':''}>No</option>
            </select>
          </div>
          <div class="md:col-span-2 text-[10px] font-bold text-gray-500">
            ID: <span class="font-black text-gray-800">${cid}</span>
          </div>
        </div>
        <button onclick="deleteCategory('${cid}')" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>
      </div>
    `;
  });
}

function addNewCategory(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const name=document.getElementById('newCategoryName').value.trim();
  const icon=document.getElementById('newCategoryIcon').value.trim() || 'üîß';
  if(!name) return alert("Nombre requerido.");

  const cid = name.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  if(!cid) return alert("Nombre inv√°lido para ID.");
  if(db.categories[cid]) return alert("Ya existe una categor√≠a con ese ID.");

  db.categories[cid]={ name, icon, countsAsWork:true };
  saveDB();
  document.getElementById('newCategoryName').value='';
  document.getElementById('newCategoryIcon').value='';
  renderCategories();
  loadCategoriesSelect();
  renderSettings();
  render();
  alert("Categor√≠a agregada.");
}

function deleteCategory(cid){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  if(!confirm(`¬øEliminar categor√≠a "${db.categories[cid]?.name||cid}"?`)) return;

  // impedir eliminar si usada por turnos
  const used = Object.values(db.users).some(u=> Object.values(u.config).some(s=>s.cat===cid));
  if(used) return alert("No se puede eliminar: hay turnos usando esta categor√≠a.");

  delete db.categories[cid];
  saveDB();
  renderCategories();
  loadCategoriesSelect();
  renderSettings();
  render();
}

function saveCategories(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  Object.keys(db.categories).forEach(cid=>{
    const name = document.getElementById(`cat-name-${cid}`)?.value?.trim();
    const icon = document.getElementById(`cat-icon-${cid}`)?.value?.trim();
    const work = document.getElementById(`cat-work-${cid}`)?.value;
    if(name) db.categories[cid].name=name;
    if(icon) db.categories[cid].icon=icon;
    db.categories[cid].countsAsWork = (work==='1');
  });
  saveDB();
  renderCategories();
  loadCategoriesSelect();
  renderSettings();
  render();
  alert("Categor√≠as actualizadas.");
}

/* =========================================================
   Localities
========================================================= */
function renderLocalities(){
  const container=document.getElementById('localities-container');
  container.innerHTML='';

  db.localities = Array.from(new Set(db.localities.map(x=>String(x).trim()).filter(Boolean)));
  if(!db.localities.some(x=>x.toUpperCase()==='GENERAL')) db.localities.unshift('General');

  db.localities.forEach((loc, idx)=>{
    const isGeneral = loc.trim().toUpperCase()==='GENERAL';
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center font-black text-sky-700">üìç</div>
        <div class="flex-1">
          <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
          <input id="loc-${idx}" value="${escapeHTML(loc)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${isGeneral?'disabled':''}/>
          <div class="text-[10px] font-bold text-gray-500 mt-1">${isGeneral?'Reservado.':''}</div>
        </div>
        ${isGeneral? `<span class="text-[9px] font-black text-gray-400">Bloqueado</span>` : `<button onclick="deleteLocality(${idx})" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>`}
      </div>
    `;
  });

  refreshHolidayLocationSelects();
  refreshProfileLocationSelects();
}

function addLocality(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const name=document.getElementById('newLocalityName').value.trim();
  if(!name) return alert("Nombre requerido.");
  if(name.toUpperCase()==='GENERAL') return alert("‚ÄúGeneral‚Äù es reservado.");
  if(db.localities.some(x=>x.trim().toUpperCase()===name.trim().toUpperCase())) return alert("Ya existe esa localidad.");

  db.localities.push(name);
  document.getElementById('newLocalityName').value='';
  saveDB();
  renderLocalities();
  alert("Localidad agregada.");
}

function deleteLocality(idx){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const loc=db.localities[idx];
  if(!loc || loc.toUpperCase()==='GENERAL') return;

  const usedUser = Object.values(db.users).some(u => (u.locality||'').trim().toUpperCase() === loc.trim().toUpperCase());
  const usedHoliday = Object.values(db.holidays).some(h => (h.location||'').trim().toUpperCase() === loc.trim().toUpperCase());
  if(usedUser || usedHoliday) return alert("No se puede eliminar: est√° en uso por perfiles o asuetos.");

  if(!confirm(`¬øEliminar localidad "${loc}"?`)) return;

  db.localities.splice(idx,1);
  saveDB();
  renderLocalities();
}

function saveLocalities(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");

  const oldList = [...db.localities];
  const newList = [];

  for(let i=0;i<oldList.length;i++){
    const oldLoc = oldList[i];
    const isGeneral = oldLoc.trim().toUpperCase()==='GENERAL';
    if(isGeneral){ newList.push('General'); continue; }
    const v = document.getElementById(`loc-${i}`)?.value?.trim();
    if(!v) continue;
    if(v.toUpperCase()==='GENERAL') continue;
    newList.push(v);
  }

  if(!newList.some(x=>x.toUpperCase()==='GENERAL')) newList.unshift('General');

  const renamePairs = [];
  for(let i=0;i<oldList.length;i++){
    const a=String(oldList[i]||'').trim();
    const b=(document.getElementById(`loc-${i}`)?.value||a).trim();
    if(a && b && a.toUpperCase()!=='GENERAL' && a.toUpperCase()!==b.toUpperCase()){
      renamePairs.push([a,b]);
    }
  }

  db.localities = Array.from(new Set(newList.map(x=>String(x).trim()).filter(Boolean)));

  renamePairs.forEach(([from,to])=>{
    Object.values(db.users).forEach(u=>{
      if((u.locality||'').trim().toUpperCase()===from.trim().toUpperCase()) u.locality=to;
    });
    Object.keys(db.holidays).forEach(k=>{
      const h=db.holidays[k];
      if((h.location||'').trim().toUpperCase()===from.trim().toUpperCase()) h.location=to;
      if(Array.isArray(h.extras)){
        h.extras.forEach(e=>{
          if((e.location||'').trim().toUpperCase()===from.trim().toUpperCase()) e.location=to;
        });
      }
    });
  });

  saveDB();
  renderLocalities();
  renderHolidays();
  renderProfilesList();
  render();
  alert("Localidades actualizadas.");
}

function refreshHolidayLocationSelects(){
  const sel=document.getElementById('newHolidayLocation');
  if(sel){
    sel.innerHTML = db.localities.map(l=>`<option value="${escapeAttr(l)}">${escapeHTML(l)}</option>`).join('');
    if(db.localities.some(x=>x.toUpperCase()==='SAN SALVADOR')) sel.value='San Salvador';
  }
}

function refreshProfileLocationSelects(){
  const createLoc=document.getElementById('createLoc');
  if(createLoc){
    createLoc.innerHTML = db.localities.filter(l=>l.toUpperCase()!=='GENERAL').map(l=>`<option value="${escapeAttr(l)}">${escapeHTML(l)}</option>`).join('');
    createLoc.value='San Salvador';
  }
}

/* =========================================================
   Holidays: editable + deletable
========================================================= */
function renderHolidays(){
  const container=document.getElementById('holidays-container');
  container.innerHTML='';

  const keys = Object.keys(db.holidays).sort((a,b)=> new Date(a) - new Date(b));
  if(keys.length===0){
    container.innerHTML = `<div class="p-8 text-center text-gray-400 font-bold">No hay asuetos.</div>`;
    return;
  }

  keys.forEach(k=>{
    const h=db.holidays[k];
    const [y,m,d]=k.split('-');
    const extras = Array.isArray(h.extras) && h.extras.length
      ? `<div class="mt-2 text-[10px] font-bold text-gray-500">Extras: ${h.extras.map(e=>`${escapeHTML(e.location)}`).join(', ')}</div>`
      : '';

    container.innerHTML += `
      <div class="p-4 border-b border-gray-100">
        <div class="flex items-center justify-between gap-2">
          <div class="font-black text-gray-900 text-[12px]">${escapeHTML(h.name||'Asueto')}</div>
          <button onclick="deleteHoliday('${escapeAttr(k)}')" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Fecha</div>
            <input id="h-date-${cssSafe(k)}" type="date" value="${toISODate(y,m,d)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="h-name-${cssSafe(k)}" value="${escapeHTML(h.name||'')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="h-loc-${cssSafe(k)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
              ${db.localities.map(l=>`<option value="${escapeAttr(l)}" ${(h.location||'General')===l?'selected':''}>${escapeHTML(l)}</option>`).join('')}
            </select>
            ${extras}
          </div>
        </div>
      </div>
    `;
  });
}

function addNewHoliday(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const dateInput=document.getElementById('newHolidayDate').value;
  const name=document.getElementById('newHolidayName').value.trim();
  const loc=document.getElementById('newHolidayLocation').value || 'General';

  if(!dateInput || !name) return alert("Fecha y nombre requeridos.");

  const dt=new Date(dateInput+'T00:00:00');
  const key=dayKey(dt.getFullYear(), dt.getMonth()+1, dt.getDate());
  db.holidays[key]={ name, location: loc, extras: [] };

  document.getElementById('newHolidayDate').value='';
  document.getElementById('newHolidayName').value='';
  saveDB();
  renderHolidays();
  render();
  alert("Asueto agregado.");
}

function deleteHoliday(k){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  if(!confirm(`¬øEliminar asueto ${k}?`)) return;
  delete db.holidays[k];
  saveDB();
  renderHolidays();
  render();
}

function saveHolidays(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");

  const newHolidays = {};
  const keys = Object.keys(db.holidays);

  keys.forEach(oldKey=>{
    const safe = cssSafe(oldKey);
    const dateVal = document.getElementById(`h-date-${safe}`)?.value;
    const nameVal = document.getElementById(`h-name-${safe}`)?.value?.trim();
    const locVal = document.getElementById(`h-loc-${safe}`)?.value || 'General';
    if(!dateVal || !nameVal) return;

    const dt = new Date(dateVal+'T00:00:00');
    const newKey = dayKey(dt.getFullYear(), dt.getMonth()+1, dt.getDate());

    // preservar extras si existen (si no hay choque)
    const extras = (db.holidays[oldKey] && Array.isArray(db.holidays[oldKey].extras)) ? db.holidays[oldKey].extras : [];

    newHolidays[newKey] = { name:nameVal, location: locVal, extras: extras };
  });

  db.holidays = newHolidays;
  saveDB();
  renderHolidays();
  render();
  alert("Asuetos actualizados.");
}

/* =========================================================
   PIN only
========================================================= */
function savePinOnly(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const user=db.users[db.current];
  const p=document.getElementById('changePinInput').value;
  const c=document.getElementById('confirmPinInput').value;
  if(!p || p.length!==4 || isNaN(p)) return alert("PIN inv√°lido (4 d√≠gitos).");
  if(p!==c) return alert("PIN no coincide.");
  user.pin=p;
  document.getElementById('changePinInput').value='';
  document.getElementById('confirmPinInput').value='';
  saveDB();
  alert("PIN actualizado.");
}

/* =========================================================
   Profiles modal
========================================================= */
function openProfilesModal(){
  refreshProfileLocationSelects();
  renderProfilesList();
  document.getElementById('profilesModal').classList.add('active');
}
function closeProfilesModal(){ document.getElementById('profilesModal').classList.remove('active'); }

function createProfile(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const name=document.getElementById('createName').value.trim().toUpperCase();
  const pin=document.getElementById('createPin').value.trim();
  const loc=document.getElementById('createLoc').value || 'San Salvador';

  if(!name || name.length<2) return alert("Nombre inv√°lido.");
  if(!pin || pin.length!==4 || isNaN(pin)) return alert("PIN inv√°lido.");
  if(db.users[name]) return alert("Ya existe ese perfil.");

  db.users[name] = JSON.parse(JSON.stringify(db.users['ADMIN']));
  db.users[name].pin = pin;
  db.users[name].locality = loc;
  db.users[name].data = {};
  db.users[name].editLocked = false;
  ensureImportBaseShiftsForUser(name);

  db.current = name;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  alert("Perfil creado.");
}

function renderProfilesList(){
  const box=document.getElementById('profilesList');
  box.innerHTML='';
  const keys=Object.keys(db.users).sort();

  keys.forEach(u=>{
    const user=db.users[u];
    const isCurrent = (u===db.current);
    box.innerHTML += `
      <div class="border border-gray-200 rounded-2xl p-3 ${isCurrent?'bg-blue-50 border-blue-200':''}">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="font-black text-gray-900 text-[12px]">${escapeHTML(u)} ${isCurrent?'<span class="ml-2 text-[9px] font-black text-blue-600">(Actual)</span>':''}</div>
            <div class="text-[10px] font-bold text-gray-500">Localidad: <span class="font-black text-gray-800">${escapeHTML(user.locality||'San Salvador')}</span></div>
            <div class="text-[10px] font-bold text-gray-500">Estado: <span class="font-black ${user.editLocked?'text-red-600':'text-emerald-600'}">${user.editLocked?'BLOQUEADO':'DESBLOQUEADO'}</span></div>
          </div>
          <div class="flex gap-2">
            <button onclick="setCurrentProfile('${escapeAttr(u)}')" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Usar</button>
            ${u==='ADMIN' ? '' : `<button onclick="deleteProfile('${escapeAttr(u)}')" class="px-3 py-2 rounded-xl bg-red-100 hover:bg-red-200 text-red-700 text-[10px] font-black uppercase">Eliminar</button>`}
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Renombrar perfil</div>
            <input id="p-name-${cssSafe(u)}" value="${escapeHTML(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${u==='ADMIN'?'disabled':''}/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">PIN</div>
            <input id="p-pin-${cssSafe(u)}" value="${escapeHTML(user.pin||'0000')}" maxlength="4" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="p-loc-${cssSafe(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
              ${db.localities.filter(l=>l.toUpperCase()!=='GENERAL').map(l=>`<option value="${escapeAttr(l)}" ${(user.locality||'San Salvador')===l?'selected':''}>${escapeHTML(l)}</option>`).join('')}
            </select>
          </div>
          <div class="md:col-span-3">
            <button onclick="saveProfileEdits('${escapeAttr(u)}')" class="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[11px]">
              üíæ Guardar cambios de este perfil
            </button>
          </div>
        </div>
      </div>
    `;
  });
}

function setCurrentProfile(u){
  db.current=u;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
}

function deleteProfile(u){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  if(u==='ADMIN') return;
  if(!confirm(`¬øEliminar perfil "${u}"? Se perder√° su calendario.`)) return;

  delete db.users[u];
  if(db.current===u) db.current='ADMIN';
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
}

function saveProfileEdits(u){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  const user=db.users[u];
  if(!user) return;

  const pin = document.getElementById(`p-pin-${cssSafe(u)}`)?.value?.trim();
  const loc = document.getElementById(`p-loc-${cssSafe(u)}`)?.value || 'San Salvador';

  if(!pin || pin.length!==4 || isNaN(pin)) return alert("PIN inv√°lido (4 d√≠gitos).");
  user.pin = pin;
  user.locality = loc;

  if(u!=='ADMIN'){
    const newName = document.getElementById(`p-name-${cssSafe(u)}`)?.value?.trim()?.toUpperCase();
    if(newName && newName!==u){
      if(db.users[newName]) return alert("No se puede renombrar: ya existe ese nombre.");
      db.users[newName] = user;
      delete db.users[u];
      if(db.current===u) db.current=newName;
    }
  }

  saveDB();
  updateUserDropdown();
  updateUserInitial();
  renderProfilesList();
  render();
  alert("Perfil actualizado.");
}

/* =========================================================
   Import: analyze + select users + import selected
========================================================= */
function openImportModal(){
  document.getElementById('importFile').value='';
  document.getElementById('importInfo').innerText='';
  document.getElementById('importUsersList').innerHTML = `<div class="text-gray-400 font-bold">Adjunta un Excel y presiona ‚ÄúAnalizar‚Äù.</div>`;
  importContext=null;

  document.getElementById('importMonth').value = current.getMonth();
  document.getElementById('importYear').value = current.getFullYear();
  document.getElementById('importModal').classList.add('active');
}
function closeImportModal(){ document.getElementById('importModal').classList.remove('active'); }

function detectMonthYearFromRows(rows){
  const monthsMap = {'ENERO':0,'FEBRERO':1,'MARZO':2,'ABRIL':3,'MAYO':4,'JUNIO':5,'JULIO':6,'AGOSTO':7,'SEPTIEMBRE':8,'OCTUBRE':9,'NOVIEMBRE':10,'DICIEMBRE':11};
  let foundMonth=null, foundYear=null;
  for(let r=0;r<Math.min(rows.length,60);r++){
    const row=rows[r]||[];
    for(let c=0;c<row.length;c++){
      const v=row[c]; if(!v) continue;
      const s=String(v).toUpperCase();
      Object.keys(monthsMap).forEach(mn=>{ if(s.includes(mn) && foundMonth===null) foundMonth=monthsMap[mn]; });
      const yMatch=s.match(/A√ëO\s*([0-9]{4})/);
      if(yMatch) foundYear=parseInt(yMatch[1]);
    }
  }
  return {month:foundMonth, year:foundYear};
}

function findHeaderRow(rows){
  for(let r=0;r<rows.length;r++){
    const row=rows[r]||[];
    const joined=row.map(x=>String(x||'').trim()).join(' | ').toUpperCase();
    if(joined.includes('PERSONAL') && (joined.includes('NO. EMP') || joined.includes('NO EMP') || joined.includes('NO.EMP'))){
      if(row.some(v=>String(v).trim()==='1') && row.some(v=>String(v).trim()==='2')) return r;
    }
  }
  return -1;
}

function buildDayColumnMap(headerRow){
  const map={};
  for(let c=0;c<headerRow.length;c++){
    const s=String(headerRow[c]||'').trim();
    if(/^\d+$/.test(s)){
      const d=parseInt(s);
      if(d>=1&&d<=31) map[d]=c;
    }
  }
  return map;
}

function safeNameCell(v){ return String(v||'').replace(/\s+/g,' ').trim(); }

function isLikelyDataRow(row, nameCol, empCol, dayCols){
  const name=safeNameCell(row[nameCol]).toUpperCase();
  const emp=safeNameCell(row[empCol]);
  if(!name || !emp) return false;
  if(name.includes('TOTAL POR TURNO') || name.includes('PERSONAL')) return false;
  for(const d of Object.keys(dayCols)){
    const code=normalizeCode(row[dayCols[d]]);
    if(code && code!=='X') return true;
  }
  return false;
}

async function analyzeImportFile(){
  const fileInput=document.getElementById('importFile');
  if(!fileInput.files || !fileInput.files[0]) return alert("Selecciona un archivo.");

  const data = await fileInput.files[0].arrayBuffer();
  const wb = XLSX.read(data, {type:'array'});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''});

  const detected = detectMonthYearFromRows(rows);
  const fallbackMonth = parseInt(document.getElementById('importMonth').value);
  const fallbackYear = parseInt(document.getElementById('importYear').value);
  const monthIndex0 = (detected.month ?? fallbackMonth);
  const year = (detected.year ?? fallbackYear);

  const headerIdx=findHeaderRow(rows);
  if(headerIdx<0) return alert("No pude detectar encabezados (PERSONAL / No. EMP. / d√≠as).");

  const headerRow = rows[headerIdx]||[];
  const dayCols = buildDayColumnMap(headerRow);

  let nameCol=-1, empCol=-1;
  for(let c=0;c<headerRow.length;c++){
    const s=String(headerRow[c]||'').toUpperCase().trim();
    if(s==='PERSONAL') nameCol=c;
    if(s.includes('EMP')) empCol=c;
  }
  if(nameCol<0 || empCol<0 || Object.keys(dayCols).length<10) return alert("Encabezado incompleto.");

  const usersSet=new Set();
  for(let r=headerIdx+1;r<rows.length;r++){
    const row=rows[r]||[];
    if(!isLikelyDataRow(row,nameCol,empCol,dayCols)) continue;
    usersSet.add(safeNameCell(row[nameCol]).toUpperCase());
  }

  importContext = { wb, sheetName, rows, headerIdx, nameCol, empCol, dayCols, monthIndex0, year, users: Array.from(usersSet).sort() };

  const list=document.getElementById('importUsersList');
  if(importContext.users.length===0){
    list.innerHTML = `<div class="text-gray-400 font-bold">No se detectaron usuarios en ese Excel.</div>`;
  } else {
    list.innerHTML = importContext.users.map(u=>`
      <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
        <input class="impUserChk" type="checkbox" value="${escapeAttr(u)}" checked>
        <span class="font-black text-gray-800">${escapeHTML(u)}</span>
      </label>
    `).join('');
  }

  document.getElementById('importInfo').innerText = `Detectado: ${MONTHS[monthIndex0]} ${year}. Usuarios: ${importContext.users.length}.`;
}

function selectAllImportUsers(flag){
  document.querySelectorAll('.impUserChk').forEach(ch=> ch.checked = !!flag);
}

function clearMonthForUser(userKey, year, monthIndex0){
  const user=db.users[userKey];
  const prefix = `${year}-${monthIndex0+1}-`;
  Object.keys(user.data).forEach(k=>{ if(k.startsWith(prefix)) delete user.data[k]; });
}

function setDayForUser(userKey, year, monthIndex0, day, shiftDef, importMode){
  const user=db.users[userKey];
  const key = dayKey(year, monthIndex0+1, day);

  if(importMode==='merge' && user.data[key]) return;

  ensureShiftExistsForUser(userKey, shiftDef);

  const tIn = shiftDef.in || '00:00';
  const tOut = shiftDef.out || '00:00';
  const hrs = calculateHours(tIn, tOut);
  const note = (tIn!=='00:00'||tOut!=='00:00') ? `${tIn}-${tOut}` : (shiftDef.note || shiftDef.label || shiftDef.key || '').toUpperCase();

  user.data[key] = {
    mode:'simple',
    s:shiftDef.key, t:shiftDef.key, b:shiftDef.key,
    tIn, tOut, h:hrs,
    n: note,
    nAuto: true
  };
}

function runImportSelected(){
  if(!importContext) return alert("Primero analiza el archivo.");
  const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'replace';

  const selected = Array.from(document.querySelectorAll('.impUserChk')).filter(x=>x.checked).map(x=>x.value);
  if(selected.length===0) return alert("Selecciona al menos un usuario.");

  const { rows, headerIdx, nameCol, dayCols, monthIndex0, year } = importContext;

  selected.forEach(u=> ensureUserExists(u));
  if(importMode==='replace'){
    selected.forEach(u=> clearMonthForUser(u, year, monthIndex0));
  }

  let written=0;
  for(let r=headerIdx+1;r<rows.length;r++){
    const row=rows[r]||[];
    if(!isLikelyDataRow(row,nameCol,importContext.empCol,dayCols)) continue;
    const name = safeNameCell(row[nameCol]).toUpperCase();
    if(!selected.includes(name)) continue;

    const userKey = ensureUserExists(name);
    ensureImportBaseShiftsForUser(userKey);

    for(const dStr of Object.keys(dayCols)){
      const day=parseInt(dStr);
      const code=normalizeCode(row[dayCols[dStr]]);
      if(!code || code==='X') continue;
      const def = codeToShiftDef(code);
      if(!def) continue;

      // estandar de comentario
      if(def.in && def.out && !(def.in==='00:00'&&def.out==='00:00')) def.note = `${def.in}-${def.out}`;
      else def.note = (def.note || def.label || def.key || code).toUpperCase();

      setDayForUser(userKey, year, monthIndex0, day, def, importMode);
      written++;
    }
  }

  saveDB();

  // saltar a mes importado y poner perfil actual
  db.current = selected[0];
  current = new Date(year, monthIndex0, 1);
  saveDB();

  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  render();

  document.getElementById('importInfo').innerText = `Importaci√≥n OK: perfiles ${selected.length}, celdas ${written}. (PIN por defecto: 0000)`;
  alert(`Importaci√≥n completada.\nPerfiles importados: ${selected.length}\nCeldas: ${written}\nMes: ${MONTHS[monthIndex0]} ${year}`);

  // Cerrar modal autom√°ticamente
  closeImportModal();
}

/* =========================================================
   Export
========================================================= */
function showExportModal(){
  document.getElementById('exportMonth').value = current.getMonth();
  document.getElementById('exportYear').value = current.getFullYear();
  buildExportUserList();
  document.getElementById('exportUsersBox').classList.add('hidden');

  document.querySelectorAll('input[name="exportScope"]').forEach(r=>{
    r.onchange=()=>{
      const v=document.querySelector('input[name="exportScope"]:checked').value;
      document.getElementById('exportUsersBox').classList.toggle('hidden', v!=='select');
    };
  });

  document.getElementById('exportModal').classList.add('active');
}
function closeExportModal(){ document.getElementById('exportModal').classList.remove('active'); }

function buildExportUserList(){
  const list=document.getElementById('exportUsersList');
  const users=Object.keys(db.users).sort();
  list.innerHTML = users.map(u=>`
    <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
      <input class="expUserChk" type="checkbox" value="${escapeAttr(u)}">
      <span class="font-black text-gray-800">${escapeHTML(u)}</span>
    </label>
  `).join('');
}

function selectAllExportUsers(flag){
  document.querySelectorAll('.expUserChk').forEach(ch=> ch.checked = !!flag);
}

async function exportImages(){
  const monthIndex0 = parseInt(document.getElementById('exportMonth').value);
  const year = parseInt(document.getElementById('exportYear').value);
  const scope = document.querySelector('input[name="exportScope"]:checked').value;

  let targets=[];
  if(scope==='current') targets=[db.current];
  if(scope==='all') targets=Object.keys(db.users).sort();
  if(scope==='select'){
    targets = Array.from(document.querySelectorAll('.expUserChk')).filter(x=>x.checked).map(x=>x.value);
    if(targets.length===0) return alert("Selecciona al menos un perfil.");
  }

  closeExportModal();

  const originalCurrent = db.current;
  for(const u of targets){
    db.current=u;
    updateUserInitial();
    const img = await buildExportImageForUser(u, year, monthIndex0);
    downloadDataUrl(img, `Turnos_${u}_${MONTHS[monthIndex0]}_${year}.png`);
  }

  db.current = originalCurrent;
  updateUserDropdown();
  updateUserInitial();
  render();
  alert(`Exportaci√≥n completada: ${targets.length} imagen(es).`);
}

function downloadDataUrl(dataUrl, filename){
  const a=document.createElement('a');
  a.download=filename;
  a.href=dataUrl;
  a.click();
}

async function buildExportImageForUser(userKey, year, monthIndex0){
  const user=db.users[userKey];
  const SHIFTS=user.config;

  // c√°lculo por categor√≠as (similar a resumen)
  const catAgg = {};
  Object.keys(db.categories).forEach(cid=> catAgg[cid]={hrs:0, units:0});
  let workedDays=0, holidayWorked=0, freeDays=0, vacDays=0, faltaDays=0, weekendDays=0;

  const daysInMonth = new Date(year, monthIndex0+1, 0).getDate();
  const m1=monthIndex0+1;

  for(let d=1; d<=daysInMonth; d++){
    const key = dayKey(year, m1, d);
    const dow = new Date(year, monthIndex0, d).getDay();
    if(dow===0 || dow===6) weekendDays++;

    const entry = user.data[key];
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);

    if(!entry){ freeDays++; continue; }

    if(entry.mode==='mixto'){
      const topId=entry.t, botId=entry.b;
      const topCat=SHIFTS[topId]?.cat || 'otro';
      const botCat=SHIFTS[botId]?.cat || 'otro';
      const topHrs=(entry.hrsTop ?? calculateHours(entry.tInTop||SHIFTS[topId]?.in, entry.tOutTop||SHIFTS[topId]?.out))||0;
      const botHrs=(entry.hrsBottom ?? calculateHours(entry.tInBottom||SHIFTS[botId]?.in, entry.tOutBottom||SHIFTS[botId]?.out))||0;

      catAgg[topCat].hrs+=topHrs; catAgg[topCat].units+=1;
      catAgg[botCat].hrs+=botHrs; catAgg[botCat].units+=1;

      const topWork=!!db.categories[topCat]?.countsAsWork;
      const botWork=!!db.categories[botCat]?.countsAsWork;
      if(topWork||botWork) workedDays++;
      if(isHoliday && (topWork||botWork)) holidayWorked++;

      if(topCat==='off' && topId==='Vacaciones') vacDays++;
      if(botCat==='off' && botId==='Vacaciones') vacDays++;
      if(topCat==='falta') faltaDays++;
      if(botCat==='falta') faltaDays++;
      if(topCat==='off' && topId==='L') freeDays++;
      if(botCat==='off' && botId==='L') freeDays++;
    }else{
      const sid=entry.s;
      const cat=SHIFTS[sid]?.cat || 'otro';
      const hrs=(entry.h ?? calculateHours(entry.tIn||SHIFTS[sid]?.in, entry.tOut||SHIFTS[sid]?.out))||0;
      catAgg[cat].hrs+=hrs; catAgg[cat].units+=1;

      const isWork=!!db.categories[cat]?.countsAsWork;
      if(isWork) workedDays++;
      if(isHoliday && isWork) holidayWorked++;

      if(cat==='off' && sid==='Vacaciones') vacDays++;
      if(cat==='off' && sid==='L') freeDays++;
      if(cat==='falta') faltaDays++;
    }
  }

  const applicableHolidays = countApplicableHolidaysInMonth(year, monthIndex0, user.locality);
  const todayStr = new Date().toLocaleDateString('es-ES');

  // build HTML
  const temp=document.createElement('div');
  temp.style.position='fixed';
  temp.style.left='-9999px';
  temp.style.top='-9999px';
  temp.style.width='920px';
  temp.style.background='#fff';
  temp.style.padding='24px';
  temp.style.borderRadius='18px';
  temp.style.boxShadow='0 10px 30px rgba(0,0,0,.18)';

  temp.innerHTML = buildExportHTML(userKey, user.locality, year, monthIndex0, todayStr, catAgg, workedDays, freeDays, vacDays, faltaDays, weekendDays, holidayWorked, applicableHolidays, SHIFTS, user);
  document.body.appendChild(temp);

  const canvas = await html2canvas(temp, {scale:2, backgroundColor:'#ffffff', useCORS:true, logging:false});
  const url = canvas.toDataURL('image/png');
  document.body.removeChild(temp);
  return url;
}

function buildExportHTML(userKey, locality, year, monthIndex0, todayStr, catAgg, workedDays, freeDays, vacDays, faltaDays, weekendDays, holidayWorked, applicableHolidays, SHIFTS, user){
  const monthName=MONTHS[monthIndex0];
  const daysOfWeek=['LUN','MAR','MI√â','JUE','VIE','S√ÅB','DOM'];
  const firstDay = new Date(year, monthIndex0, 1).getDay();
  const firstDayMonday = firstDay===0?6:firstDay-1;
  const lastDate = new Date(year, monthIndex0+1, 0).getDate();
  const prevLastDate = new Date(year, monthIndex0, 0).getDate();

  // categor√≠as de trabajo ordenadas por horas
  const workCats = Object.keys(db.categories)
    .filter(cid=>db.categories[cid].countsAsWork)
    .map(cid=>({cid, ...db.categories[cid], hrs:(catAgg[cid]?.hrs||0)}))
    .sort((a,b)=>b.hrs-a.hrs)
    .slice(0,5);

  const catLine = workCats.map(c=>`${escapeHTML(c.icon)} ${escapeHTML(c.name)}: ${(c.hrs||0).toFixed(1)}h`).join(' ‚Ä¢ ');

  let html = `
    <div style="font-family:system-ui,-apple-system,sans-serif;">
      <div style="text-align:center;margin-bottom:18px;padding-bottom:14px;border-bottom:2px solid #e5e7eb;">
        <div style="font-size:30px;font-weight:900;color:#0f172a;">${escapeHTML(userKey)} - ${monthName} ${year}</div>
        <div style="font-size:12px;color:#64748b;font-weight:800;">Localidad: ${escapeHTML(locality||'San Salvador')} ‚Ä¢ Generado: ${todayStr}</div>
        <div style="font-size:11px;color:#0f172a;font-weight:900;margin-top:6px;">${catLine || ''}</div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:16px;background:linear-gradient(to right,#f0f9ff,#fefce8);padding:14px;border-radius:14px;">
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">D√çAS TRAB.</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${workedDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">LIBRES</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${freeDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">VAC</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${vacDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">FALTAS</div>
          <div style="font-size:20px;font-weight:900;color:#b45309;">${faltaDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">FINES</div>
          <div style="font-size:20px;font-weight:900;color:#0f172a;">${weekendDays}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">ASUETOS</div>
          <div style="font-size:20px;font-weight:900;color:#dc2626;">${applicableHolidays} / Trab. ${holidayWorked}</div>
        </div>
      </div>

      <div style="margin-bottom:14px;">
        <div style="font-size:14px;font-weight:900;color:#334155;margin-bottom:10px;text-align:center;">CALENDARIO</div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;background:#e5e7eb;border:1px solid #e5e7eb;">
          ${daysOfWeek.map((d)=>{
            const c = (d==='DOM') ? '#ef4444' : (d==='S√ÅB' ? '#3b82f6' : '#64748b');
            return `<div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:11px;color:${c};">${d}</div>`;
          }).join('')}
  `;

  for(let i=firstDayMonday;i>0;i--){
    const prevDay=prevLastDate-i+1;
    html += `<div style="background:#f9fafb;height:82px;position:relative;opacity:.3;"><span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;color:#374151;">${prevDay}</span></div>`;
  }

  for(let d=1; d<=lastDate; d++){
    const key = dayKey(year, monthIndex0+1, d);
    const info = user.data[key] || {mode:'simple', s:'L'};
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);

    if(info.mode==='mixto'){
      const topC = SHIFTS[info.t]?.color || 'L';
      const botC = SHIFTS[info.b]?.color || 'L';
      const topL = SHIFTS[info.t]?.label || 'L';
      const botL = SHIFTS[info.b]?.label || 'L';
      const nt = info.nt ? escapeHTML(info.nt) : '';
      const nb = info.nb ? escapeHTML(info.nb) : '';

      html += `
        <div style="height:82px;position:relative;">
          <div style="height:50%;background:${getColorValue(topC)};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;text-transform:uppercase;border-bottom:1px solid rgba(0,0,0,.1);position:relative;">
            ${escapeHTML(topL)}
            ${nt?`<div style="position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:92%;text-align:center;font-size:8px;font-weight:900;background:rgba(255,255,255,.70);border:1px solid rgba(0,0,0,.08);border-radius:6px;padding:1px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${nt}</div>`:''}
          </div>
          <div style="height:50%;background:${getColorValue(botC)};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;text-transform:uppercase;position:relative;">
            ${escapeHTML(botL)}
            ${nb?`<div style="position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:92%;text-align:center;font-size:8px;font-weight:900;background:rgba(255,255,255,.70);border:1px solid rgba(0,0,0,.08);border-radius:6px;padding:1px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${nb}</div>`:''}
          </div>
          <span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;color:#374151;">${d}</span>
          ${isHoliday?`<span style="position:absolute;top:0;left:0;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,.9);padding:1px 4px;border-bottom-right-radius:8px;">A</span>`:''}
        </div>
      `;
    } else {
      const c = SHIFTS[info.s]?.color || 'L';
      const l = SHIFTS[info.s]?.label || 'L';
      const n = info.n ? escapeHTML(info.n) : '';
      html += `
        <div style="height:82px;position:relative;background:${getColorValue(c)};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;text-transform:uppercase;">
          ${escapeHTML(l)}
          <span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;color:#374151;">${d}</span>
          ${isHoliday?`<span style="position:absolute;top:0;left:0;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,.9);padding:1px 4px;border-bottom-right-radius:8px;">A</span>`:''}
          ${n?`<div style="position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:92%;text-align:center;font-size:8px;font-weight:900;background:rgba(255,255,255,.70);border:1px solid rgba(0,0,0,.08);border-radius:6px;padding:1px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${n}</div>`:''}
        </div>
      `;
    }
  }

  const total = firstDayMonday + lastDate;
  for(let i=1;i<=(42-total);i++){
    html += `<div style="background:#f9fafb;height:82px;position:relative;opacity:.3;"><span style="position:absolute;top:0;right:0;font-size:11px;font-weight:900;padding:2px 6px;background:rgba(255,255,255,.9);border-bottom-left-radius:8px;color:#374151;">${i}</span></div>`;
  }

  html += `
        </div>
      </div>

      <div style="margin-top:16px;border-top:2px solid #e5e7eb;padding-top:12px;">
        <div style="font-size:12px;font-weight:900;color:#334155;margin-bottom:8px;">LEYENDA (Turnos b√°sicos)</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
          ${BASIC_SHIFT_IDS.filter(k=>SHIFTS[k]).map(k=>{
            const sh=SHIFTS[k];
            return `
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:14px;height:14px;border-radius:4px;background:${getColorValue(sh.color)};border:1px solid #d1d5db;"></div>
                <div style="font-size:10px;font-weight:800;color:#334155;">${escapeHTML(sh.label||k)}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
  return html;
}

/* =========================================================
   Export scope user list box toggle
========================================================= */
function showExportUsersIfNeeded(){
  const v=document.querySelector('input[name="exportScope"]:checked').value;
  document.getElementById('exportUsersBox').classList.toggle('hidden', v!=='select');
}

/* =========================================================
   Start
========================================================= */
document.addEventListener('DOMContentLoaded', ()=>{
  init();
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.name==='exportScope') showExportUsersIfNeeded();
  });
});
</script>

</body>
</html>

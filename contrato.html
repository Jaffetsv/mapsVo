<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <title>Shifter Pro v23 - Calendario de Turnos</title>
  
  <!-- CDNs con fallback -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Fallback si tailwind no carga
    if (typeof tailwind === 'undefined') {
      console.log('Tailwind CDN no carg√≥, usando estilos inline');
      document.write('<style>' + 
        'body { font-family: system-ui, -apple-system, sans-serif; }' +
        '.hidden { display: none !important; }' +
        '.grid { display: grid; }' +
        '.flex { display: flex; }' +
        '.block { display: block !important; }' +
        '</style>');
    }
  </script>
  
  <!-- Scripts con atributos async/defer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  
  <style>
    /* Estilos cr√≠ticos inline para evitar problemas de carga */
    :root {
      --blue-600: #2563eb;
      --gray-100: #f3f4f6;
      --white: #ffffff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: var(--gray-100);
      color: #111827;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Grid del calendario */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border: 1px solid #e5e7eb;
      width: 100%;
    }
    
    /* Celdas de d√≠a */
    .day-cell {
      background: var(--white);
      min-height: 120px;
      position: relative;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.15s;
    }
    
    @media (max-width: 640px) {
      .day-cell {
        min-height: 90px;
      }
    }
    
    .day-cell:active {
      transform: scale(0.98);
    }
    
    .day-number {
      font-size: 11px;
      font-weight: 900;
      padding: 2px 6px;
      position: absolute;
      top: 0;
      right: 0;
      z-index: 20;
      color: #374151;
      background: rgba(255, 255, 255, 0.9);
      border-bottom-left-radius: 8px;
    }
    
    .day-off-month {
      background: #f9fafb !important;
      opacity: 0.5;
    }
    
    .today {
      border: 2px solid var(--blue-600) !important;
    }
    
    .weekend {
      background: #f8fafc !important;
    }
    
    /* Colores de turnos - Nombres en espa√±ol */
    .bg-Ma√±ana { background: #ffff00 !important; }
    .bg-Tarde { background: #fbcfe8 !important; }
    .bg-CENA { background: #d8b4fe !important; }
    .bg-16hrs { background: #bef264 !important; }
    .bg-L { background: var(--white) !important; border: 1px solid #e5e7eb; }
    .bg-Vacaciones { background: #fed7aa !important; }
    .bg-Cumplea√±os { background: #f9a8d4 !important; }
    .bg-Ausencia { background: #d1d5db !important; }
    .bg-azul { background: #93c5fd !important; }
    .bg-rojo { background: #fca5a5 !important; }
    .bg-verde { background: #86efac !important; }
    .bg-naranja { background: #fdba74 !important; }
    .bg-rosa { background: #f9a8d4 !important; }
    .bg-cian { background: #67e8f9 !important; }
    .bg-morado { background: #d8b4fe !important; }
    .bg-lima { background: #d9f99d !important; }
    .bg-ambar { background: #fcd34d !important; }
    .bg-teal { background: #5eead4 !important; }
    .bg-indigo { background: #a5b4fc !important; }
    .bg-gris { background: #d1d5db !important; }
    
    /* Etiqueta de turno */
    .shift-label {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      text-align: center;
      line-height: 1.1;
      padding: 4px;
      color: rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }
    
    @media (max-width: 640px) {
      .shift-label {
        font-size: 9px;
        padding: 2px;
      }
    }
    
    /* Texto de nota - AUMENTADO para mejor visibilidad */
    .note-text {
      font-size: 10px;
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      padding: 2px 4px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    @media (max-width: 640px) {
      .note-text {
        font-size: 8px;
        bottom: 2px;
        width: 95%;
        padding: 1px 3px;
      }
    }
    
    /* Notas para mixto - MEJORADO */
    .mixto-top-note {
      font-size: 8px;
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      padding: 1px 3px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    .mixto-bottom-note {
      font-size: 8px;
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      padding: 1px 3px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    /* Indicador de asueto */
    .holiday-indicator {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 8px;
      font-weight: 900;
      color: #dc2626;
      background: rgba(254, 226, 226, 0.9);
      padding: 1px 4px;
      border-bottom-right-radius: 8px;
      z-index: 20;
    }
    
    /* Modales y vistas */
    .view-section {
      display: none;
    }
    
    .view-active {
      display: block !important;
    }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 15px;
      backdrop-filter: blur(4px);
    }
    
    .modal.active {
      display: flex;
    }
    
    /* Tabs */
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 14px;
      font-weight: 900;
      font-size: 11px;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
      background: var(--white);
      border: none;
      cursor: pointer;
    }
    
    .tab-active {
      border-bottom-color: var(--blue-600);
      color: var(--blue-600);
      background: #f8fafc;
    }
    
    /* Inputs y selects */
    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      font-weight: 800;
      font-size: 13px;
      outline: none;
      transition: 0.15s;
      width: 100%;
    }
    
    select:focus, input:focus, textarea:focus {
      border-color: var(--blue-600);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }
    
    /* Opciones de turno */
    .shift-option {
      transition: 0.15s;
      border-width: 2px;
      border-color: transparent;
      padding: 12px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      text-align: center;
    }
    
    .shift-option.selected {
      border-color: var(--blue-600) !important;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.22);
      transform: translateY(-1px);
    }
    
    /* Config tabs - FIXED: Ahora se desplazar√°n */
    .config-tabs-container {
      display: flex;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      position: sticky;
      top: 144px; /* Altura del header */
      z-index: 30;
    }
    
    @media (max-width: 768px) {
      .config-tabs-container {
        top: 144px;
      }
    }
    
    .config-tab {
      flex: 0 0 auto;
      text-align: center;
      padding: 12px 16px;
      font-weight: 900;
      font-size: 10px;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
      color: #9ca3af;
      background: none;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      min-width: 100px;
    }
    
    .config-tab.active {
      border-bottom-color: var(--blue-600);
      color: var(--blue-600);
      background: #ffffff;
    }
    
    /* Color options */
    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: 0.15s;
    }
    
    .color-option.selected {
      border-color: #000;
      transform: scale(1.08);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.18);
    }
    
    /* Utilitarios */
    .hidden {
      display: none !important;
    }
    
    .block {
      display: block !important;
    }
    
    .flex {
      display: flex !important;
    }
    
    .grid {
      display: grid !important;
    }
    
    /* Clases para colores de fondo Tailwind-ish */
    .bg-white { background: var(--white) !important; }
    .bg-gray-50 { background: #f9fafb !important; }
    .bg-gray-100 { background: #f3f4f6 !important; }
    .bg-blue-600 { background: var(--blue-600) !important; }
    .bg-emerald-600 { background: #059669 !important; }
    .bg-sky-600 { background: #0284c7 !important; }
    .text-white { color: var(--white) !important; }
    .text-gray-400 { color: #9ca3af !important; }
    .text-emerald-400 { color: #34d399 !important; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
      }
      
      .tab-btn {
        padding: 10px 5px;
        font-size: 10px;
      }
      
      .config-tab {
        padding: 10px 12px;
        font-size: 9px;
        min-width: 90px;
      }
      
      .config-tabs-container {
        top: 144px;
      }
    }
    
    @media (max-width: 640px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5px;
      }
      
      .day-cell {
        min-height: 80px;
      }
      
      .config-tab {
        padding: 10px 8px;
        font-size: 8px;
        min-width: 80px;
      }
    }
    
    /* Estilos espec√≠ficos para exportaci√≥n */
    .export-calendar-cell {
      background: #ffffff;
      min-height: 100px;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .export-note-text {
      font-size: 9px;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 85%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 4px;
      padding: 2px 4px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      overflow: visible;
      text-overflow: unset;
      z-index: 10;
      max-height: 20px;
    }
  </style>
</head>

<body class="bg-gray-100">
<!-- Top bar -->
<div class="bg-[#1e293b] text-white p-3 md:p-4 sticky top-0 z-50 shadow-lg">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-3 md:mb-4">
    <div class="flex items-center gap-3 w-full md:w-auto">
      <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-black text-sm flex-shrink-0">
        <span id="userInitial">A</span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex flex-col md:flex-row md:items-center gap-2">
          <select id="userSelect" onchange="switchUser()" class="w-full md:w-auto bg-white/15 text-white border-white/25 rounded-xl px-3 py-2 text-[11px] font-bold"></select>
          <button onclick="openProfilesModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap">üë§ Perfiles</button>
        </div>
        <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400 mt-1">Modo Vista</p>
      </div>
    </div>
    <div class="flex gap-2 w-full md:w-auto justify-end">
      <button onclick="openImportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">üì• Importar</button>
      <button onclick="showExportModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">üìã Exportar</button>
      <button id="unlockBtn" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">üîí Bloquear</button>
    </div>
  </div>

  <!-- Month/year -->
  <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-2xl p-2 shadow-inner">
    <button onclick="changeMonth(-1)" class="p-2 md:p-3 hover:bg-white/10 rounded-full transition-colors flex-shrink-0">
      <span class="text-xl font-bold">‚Äπ</span>
    </button>

    <div class="flex flex-col items-center flex-1 mx-2">
      <div id="currentMonthDisplay" class="text-lg md:text-xl font-black text-white text-center mb-1">Febrero 2026</div>
      <div class="flex gap-2 md:gap-3 items-center opacity-90">
        <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer w-24 md:w-auto"></select>
        <span class="text-white font-bold">/</span>
        <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-sm font-bold text-white text-center appearance-none cursor-pointer w-20 md:w-auto"></select>
      </div>
      <div class="flex gap-2 mt-2">
        <button onclick="goToday()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-[10px] font-black uppercase transition-colors">Hoy</button>
      </div>
    </div>

    <button onclick="changeMonth(1)" class="p-2 md:p-3 hover:bg-white/10 rounded-full transition-colors flex-shrink-0">
      <span class="text-xl font-bold">‚Ä∫</span>
    </button>
  </div>
</div>

<!-- Tabs -->
<div class="flex bg-white shadow-sm sticky top-[144px] md:top-[160px] z-40 border-b">
  <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">üìÖ Calendario</button>
  <button onclick="showView('summary')" id="tab-summary" class="tab-btn">üìä Resumen</button>
  <button onclick="showView('settings')" id="tab-settings" class="tab-btn">‚öôÔ∏è Ajustes</button>
</div>

<!-- Calendar -->
<div id="view-calendar" class="view-section view-active">
  <div class="grid grid-cols-7 text-center text-[11px] font-black py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b">
    <div class="text-blue-600 font-black">LUN</div>
    <div>MAR</div>
    <div>MI√â</div>
    <div>JUE</div>
    <div>VIE</div>
    <div class="text-blue-600 font-black">S√ÅB</div>
    <div class="text-red-600 font-black">DOM</div>
  </div>
  <div id="calendar" class="calendar-grid"></div>
</div>

<!-- Summary -->
<div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen">
  <div class="space-y-4 md:space-y-6">
    <div id="summary-categories" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
      <!-- Las categor√≠as se generar√°n din√°micamente aqu√≠ -->
    </div>

    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-4 md:p-6 rounded-3xl text-white text-center shadow-xl">
      <p class="text-xs font-black uppercase opacity-90 mb-2">D√≠as de Descanso</p>
      <h2 id="total-off" class="text-4xl md:text-5xl font-black mb-3">0</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-[10px] font-black">
        <div class="bg-white/20 p-2 rounded-xl"><div>Libres</div><div id="free-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Vacaciones</div><div id="vac-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Fines</div><div id="weekend-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Asuetos Trab.</div><div id="holiday-worked" class="text-lg font-black">0</div></div>
      </div>
      <p class="text-[10px] mt-3 font-bold opacity-90">
        * Asueto laborado solo cuenta si aplica a la localidad del perfil.
      </p>
    </div>

    <div class="bg-white p-4 rounded-3xl shadow-sm">
      <h3 class="text-[12px] font-black text-gray-600 uppercase mb-3">üìà Resumen del Mes</h3>
      <div class="space-y-2">
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Localidad perfil:</span><span id="profile-loc" class="font-black text-gray-900">San Salvador</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">D√≠as trabajados:</span><span id="worked-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Promedio diario:</span><span id="avg-hours" class="font-black text-gray-900">0.0h</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Total d√≠as mes:</span><span id="total-days" class="font-black text-gray-900">30</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Asuetos en mes:</span><span id="total-holidays" class="font-black text-red-600">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Settings -->
<div id="view-settings" class="view-section bg-white min-h-screen">
  <!-- CORREGIDO: Ahora los tabs est√°n en un contenedor con scroll -->
  <div class="config-tabs-container">
    <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active whitespace-nowrap">üé® Turnos</button>
    <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab whitespace-nowrap">‚ûï Nuevo</button>
    <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab whitespace-nowrap">üè∑Ô∏è Categor√≠as</button>
    <button onclick="showConfigTab('localidades')" id="config-localidades" class="config-tab whitespace-nowrap">üìç Localidades</button>
    <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab whitespace-nowrap">üéâ Asuetos</button>
    <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab whitespace-nowrap">üîí Seguridad</button>
  </div>

  <div id="config-content" class="p-4 md:p-6">
    <!-- Turnos -->
    <div id="tab-turnos" class="config-tab-content block">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üé® Configurar Turnos</h3>
        <button onclick="saveShiftSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-blue-50 border border-blue-100 rounded-2xl p-3 text-[11px] font-bold text-blue-900 mb-4">
        Al guardar: actualiza turnos y puede propagar horas/comentarios en el calendario del perfil.
        <div class="mt-2 flex items-center gap-2">
          <input type="checkbox" id="propagateShiftEdits" checked>
          <label for="propagateShiftEdits" class="font-black text-[10px] uppercase text-blue-900">Propagar a calendario (este perfil)</label>
        </div>
      </div>

      <div id="settings-container" class="space-y-3"></div>
    </div>

    <!-- Nuevo turno -->
    <div id="tab-nuevo" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">‚ûï Agregar Nuevo Turno</h3>
      <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-100 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Turno</label>
            <input type="text" id="newShiftName" placeholder="Ej: Noche" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Categor√≠a</label>
            <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
          </div>
        </div>

        <div class="mb-4">
          <label class="text-[11px] font-bold text-gray-600 block mb-2">Color</label>
          <div class="grid grid-cols-5 md:grid-cols-6 gap-2 p-3 bg-white rounded-xl">
            <div class="color-option bg-Ma√±ana" onclick="selectColor('Ma√±ana', event)"></div>
            <div class="color-option bg-Tarde" onclick="selectColor('Tarde', event)"></div>
            <div class="color-option bg-CENA" onclick="selectColor('CENA', event)"></div>
            <div class="color-option bg-16hrs" onclick="selectColor('16hrs', event)"></div>
            <div class="color-option bg-Vacaciones" onclick="selectColor('Vacaciones', event)"></div>
            <div class="color-option bg-Cumplea√±os" onclick="selectColor('Cumplea√±os', event)"></div>
            <div class="color-option bg-Ausencia" onclick="selectColor('Ausencia', event)"></div>
            <div class="color-option bg-L" onclick="selectColor('L', event)"></div>
            <div class="color-option bg-azul" onclick="selectColor('azul', event)"></div>
            <div class="color-option bg-rojo" onclick="selectColor('rojo', event)"></div>
          </div>
          <input type="hidden" id="newShiftColor" value="Ma√±ana">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Entrada</label>
            <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Salida</label>
            <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
        </div>

        <button onclick="addNewShift()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600">
          ‚ûï Agregar Turno
        </button>
      </div>
    </div>

    <!-- Categor√≠as -->
    <div id="tab-categorias" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üè∑Ô∏è Categor√≠as</h3>
        <button onclick="saveCategories()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-3xl border border-green-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva Categor√≠a</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newCategoryName" placeholder="Ej: Guardia" class="w-full bg-white border-green-200 focus:border-green-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Icono</label>
            <select id="newCategoryIcon" class="w-full bg-white border-green-200 focus:border-green-400">
              <option value="üè•">üè•</option><option value="üåô">üåô</option><option value="üò¥">üò¥</option><option value="üìã">üìã</option>
              <option value="üõ°Ô∏è">üõ°Ô∏è</option><option value="‚≠ê">‚≠ê</option><option value="üîß">üîß</option><option value="üöë">üöë</option>
              <option value="üíä">üíä</option><option value="ü©∫">ü©∫</option><option value="üè®">üè®</option><option value="üìå">üìå</option>
              <option value="üéÇ">üéÇ</option><option value="‚ùå">‚ùå</option>
            </select>
          </div>
        </div>
        <button onclick="addNewCategory()" class="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600">
          ‚ûï Agregar Categor√≠a
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Categor√≠as Existentes (editables)</h4>
        <div id="categories-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Localidades -->
    <div id="tab-localidades" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üìç Localidades</h3>
        <button onclick="saveLocalities()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-sky-50 to-blue-50 p-4 rounded-3xl border border-sky-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Localidad</h4>
        <div class="flex flex-col md:flex-row gap-3">
          <input type="text" id="newLocalityName" placeholder="Ej: Santa Ana" class="flex-1 bg-white border-sky-200 focus:border-sky-400">
          <button onclick="addLocality()" class="px-5 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px] whitespace-nowrap">‚ûï Agregar</button>
        </div>
        <p class="text-[10px] mt-2 font-bold text-gray-500">* "General" se reserva para asuetos v√°lidos para todos.</p>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Lista de Localidades (editables)</h4>
        <div id="localities-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Asuetos -->
    <div id="tab-asuetos" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üéâ Asuetos</h3>
        <button onclick="saveHolidays()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-3xl border border-pink-100 mb-6">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nuevo Asueto</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Fecha</label>
            <input type="date" id="newHolidayDate" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
          <div class="md:col-span-2">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newHolidayName" placeholder="Ej: D√≠a de la Independencia" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="newHolidayLocation" class="w-full bg-white border-pink-200 focus:border-pink-400"></select>
          </div>
          <div class="bg-white rounded-2xl border border-pink-200 p-3 text-[10px] font-bold text-gray-600 flex items-center">
            Si quieres asueto para todos: selecciona <span class="mx-1 font-black text-red-600">General</span>.
          </div>
        </div>

        <button onclick="addNewHoliday()" class="w-full p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600">
          ‚ûï Agregar Asueto
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Asuetos (editables)</h4>
        <div id="holidays-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Seguridad -->
    <div id="tab-seguridad" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üîí Seguridad (PIN del perfil actual)</h3>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-3xl border border-blue-100">
        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Cambiar PIN (4 d√≠gitos)</label>
            <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Confirmar PIN</label>
            <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>

          <button onclick="savePinOnly()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-3xl font-black uppercase shadow-xl hover:from-blue-700 hover:to-indigo-700">
            üíæ Guardar PIN
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="settings-locked" class="p-6 md:p-8 text-center hidden">
    <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
      <span class="text-2xl md:text-3xl">üîí</span>
    </div>
    <h3 class="text-base md:text-lg font-black text-gray-600 mb-2">Configuraci√≥n Bloqueada</h3>
    <p class="text-sm text-gray-500 mb-6">Activa el modo edici√≥n para acceder</p>
    <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-black">üîì Activar Edici√≥n</button>
  </div>
</div>

<!-- Modal d√≠a -->
<div id="modal" class="modal">
  <div class="bg-white w-full max-w-md md:max-w-lg rounded-3xl md:rounded-[40px] overflow-hidden shadow-2xl border border-gray-100 mx-2">
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-4 md:py-5 font-black text-sm uppercase tracking-widest">
      <div>üìÖ Configurar D√≠a</div>
      <div id="modalDate" class="text-[10px] font-normal opacity-90 mt-1"></div>
    </div>
    <div class="p-4 md:p-6 overflow-y-auto max-h-[80vh]">
      <!-- Holiday info -->
      <div id="holidayInfo" class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-500 p-3 rounded-lg mb-4 hidden">
        <div class="flex items-center gap-2">
          <span class="text-yellow-600 text-lg">üéâ</span>
          <div class="flex-1">
            <div id="holidayName" class="text-[12px] font-black text-yellow-800"></div>
            <div id="holidayLocation" class="text-[10px] font-bold text-yellow-600"></div>
          </div>
        </div>
      </div>
      
      <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-4 md:mb-6">
        <button onclick="setMode('simple')" id="m-s" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Simple</button>
        <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Mixto</button>
      </div>

      <div id="sec-simple" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4 md:mb-6"></div>

      <div id="sec-mixto" class="hidden space-y-4 mb-4 md:mb-6">
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl md:rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Superior</p>
          <div id="mix-t" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
        </div>
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl md:rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Inferior</p>
          <div id="mix-b" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
        </div>
      </div>

      <!-- Horario SIMPLE -->
      <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-blue-100 mb-4 md:mb-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
          <span class="text-[11px] font-black uppercase text-blue-900">‚è∞ Horario:</span>
          <div class="flex items-center gap-2">
            <input type="time" id="tIn" onchange="autoCalc(); maybeAutoNoteSimple();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">‚Üí</span>
            <input type="time" id="tOut" onchange="autoCalc(); maybeAutoNoteSimple();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-blue-200 pt-3 gap-2">
          <span class="text-[11px] font-black uppercase text-blue-900">üìä Total Horas:</span>
          <input type="number" id="tHrs" onchange="manualCalc()" class="w-full md:w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
        </div>
      </div>

      <!-- Horario MIXTO -->
      <div id="time-mixto" class="hidden space-y-4 mb-4 md:mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-blue-100">
          <p class="text-[11px] font-black uppercase text-blue-900 text-center">‚è∞ Horario Superior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">‚Üí</span>
            <input type="time" id="tOutTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-blue-200 pt-3 gap-2">
            <span class="text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
            <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-full md:w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-purple-100">
          <p class="text-[11px] font-black uppercase text-purple-900 text-center">‚è∞ Horario Inferior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-purple-200 focus:border-purple-400">
            <span class="font-black text-purple-300">‚Üí</span>
            <input type="time" id="tOutBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-purple-200 focus:border-purple-400">
          </div>
          <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-purple-200 pt-3 gap-2">
            <span class="text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
            <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-full md:w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200" step="0.5">
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-[20px] border border-emerald-100 gap-2">
          <span class="text-[11px] font-black uppercase text-emerald-900">üìä Total Horas:</span>
          <input type="number" id="tHrsMixto" class="w-full md:w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200" step="0.5" readonly>
        </div>
        
        <!-- Comentarios separados para mixto -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <p class="text-[10px] font-black text-gray-400 uppercase mb-2">üìù Comentario Superior</p>
            <textarea id="notaTop" placeholder="Ej: 06:00-14:00" class="w-full p-3 bg-gray-100 border-none rounded-[16px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <p class="text-[10px] font-black text-gray-400 uppercase mb-2">üìù Comentario Inferior</p>
            <textarea id="notaBottom" placeholder="Ej: 14:00-22:00" class="w-full p-3 bg-gray-100 border-none rounded-[16px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>
      </div>

      <!-- Comentario SIMPLE -->
      <div id="note-simple" class="mt-4 md:mt-6">
        <p class="text-[10px] font-black text-gray-400 uppercase mb-2">üìù Comentario (editable)</p>
        <textarea id="nota" placeholder="Ej: 06:00-14:00 | Doble turno | etc." class="w-full p-4 bg-gray-100 border-none rounded-2xl md:rounded-[24px] text-sm font-bold h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="flex flex-col md:flex-row gap-3 md:gap-4 mt-6 md:mt-8">
        <button onclick="closeModal()" class="flex-1 p-3 md:p-4 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-2xl md:rounded-3xl font-black text-[11px] uppercase">‚ùå Cancelar</button>
        <button onclick="saveDay()" class="flex-1 p-3 md:p-4 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-2xl md:rounded-3xl font-black text-[11px] uppercase shadow-lg">‚úÖ Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Import -->
<div id="importModal" class="modal">
  <div class="bg-white w-full max-w-2xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">üì•</span>
    </div>
    <h3 class="font-black text-center uppercase text-base md:text-lg mb-2">Importar Excel</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Detecta usuarios y permite seleccionar cu√°les importar.
    </p>

    <div class="space-y-4">
      <div>
        <label class="text-[12px] font-bold text-gray-600 block mb-2">Archivo Excel (.xlsx)</label>
        <input type="file" id="importFile" accept=".xlsx,.xls" class="w-full bg-gray-50 border-gray-200">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes (si no detecta)</label>
          <select id="importMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">A√±o (si no detecta)</label>
          <select id="importYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Modo</p>
        <div class="flex flex-col md:flex-row gap-3">
          <label class="flex items-center gap-2 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="replace" checked> Reemplazar mes
          </label>
          <label class="flex items-center gap-2 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="merge"> Combinar (solo d√≠as vac√≠os)
          </label>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-2xl p-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-2 gap-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Usuarios detectados</p>
          <div class="flex gap-2">
            <button onclick="selectAllImportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllImportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="importUsersList" class="max-h-[180px] md:max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700">
          <div class="text-gray-400 font-bold">Adjunta un Excel y presiona "Analizar".</div>
        </div>

        <div class="mt-3 flex flex-col md:flex-row gap-2">
          <button onclick="analyzeImportFile()" class="flex-1 p-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">
            üîé Analizar
          </button>
          <button onclick="runImportSelected()" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black uppercase text-[11px]">
            üöÄ Importar Seleccionados
          </button>
          <button onclick="closeImportModalAndRefresh()" class="flex-1 p-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black uppercase text-[11px]">
            ‚úÖ Terminar y Volver
          </button>
        </div>

        <div id="importInfo" class="mt-3 text-[11px] font-bold text-center text-gray-600"></div>
      </div>

      <button onclick="closeImportModal()" class="w-full mt-2 p-3 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Export -->
<div id="exportModal" class="modal">
  <div class="bg-white w-full max-w-xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">üìã</span>
    </div>
    <h3 class="font-black text-center uppercase text-base md:text-lg mb-2">Exportar</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Puedes exportar uno, varios o todos. Si es "todos", se genera 1 imagen por perfil.
    </p>

    <div class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes</label>
          <select id="exportMonth" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">A√±o</label>
          <select id="exportYear" class="w-full bg-gray-50 border-gray-200"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Qu√© exportar</p>
        <div class="space-y-2 text-[11px] font-bold text-gray-700">
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="current" checked> Perfil actual</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="select"> Seleccionar perfiles</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="all"> Todos los perfiles</label>
        </div>
      </div>

      <div id="exportUsersBox" class="bg-white border border-gray-200 rounded-2xl p-4 hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-2 gap-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Seleccionar perfiles</p>
          <div class="flex gap-2">
            <button onclick="selectAllExportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllExportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="exportUsersList" class="max-h-[180px] md:max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700"></div>
      </div>

      <button onclick="exportImages()" class="w-full p-3 md:p-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-2xl md:rounded-3xl font-black uppercase shadow-xl hover:from-emerald-700 hover:to-teal-700">
        üñºÔ∏è Exportar im√°genes
      </button>

      <button onclick="closeExportModal()" class="w-full mt-2 p-3 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Profiles -->
<div id="profilesModal" class="modal">
  <div class="bg-white w-full max-w-3xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-3">
      <div>
        <h3 class="font-black uppercase text-base md:text-lg">üë§ Gesti√≥n de Perfiles</h3>
        <p class="text-[11px] text-gray-500 font-bold">Crear, editar, asignar localidad o eliminar perfiles.</p>
      </div>
      <button onclick="closeProfilesModal()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase whitespace-nowrap">Cerrar</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-3xl p-4">
        <h4 class="text-[12px] font-black text-gray-700 uppercase mb-3">‚ûï Crear perfil</h4>
        <div class="space-y-3">
          <input id="createName" type="text" placeholder="Nombre completo" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <input id="createPin" type="password" placeholder="PIN (4 d√≠gitos)" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="createLoc" class="w-full bg-white border-blue-200 focus:border-blue-400"></select>
          </div>
          <button onclick="createProfile()" class="w-full p-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-[11px]">
            Crear
          </button>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-3xl p-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-2">
          <h4 class="text-[12px] font-black text-gray-700 uppercase">Perfiles existentes</h4>
          <button onclick="renderProfilesList()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase whitespace-nowrap">Actualizar</button>
        </div>
        <div id="profilesList" class="max-h-[300px] md:max-h-[360px] overflow-y-auto space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
// =========================================================
// DB v23 - Versi√≥n completa y corregida
// =========================================================
const ADMIN_UNIVERSAL_PIN = '120720';

// Intentar cargar DB existente o crear nueva
let db;
try {
  const saved = localStorage.getItem('shifter_v23');
  if (saved) {
    db = JSON.parse(saved);
  } else {
    // Intentar migrar de versi√≥n anterior
    const savedOld = localStorage.getItem('shifter_v22') || localStorage.getItem('shifter_v21') || localStorage.getItem('shifter_v20');
    if (savedOld) {
      db = JSON.parse(savedOld);
      db.version = 23;
    } else {
      db = createDefaultDB();
    }
  }
} catch (e) {
  console.log('Error cargando DB, creando nueva:', e);
  db = createDefaultDB();
}

function createDefaultDB() {
  return {
    version: 23,
    current: 'ADMIN',
    localities: ['General','San Salvador','Cojutepeque','Lourdes, Col√≥n','La Libertad','Quezaltepeque','Rosario de la Paz','Zacatecoluca','San Vicente','Santa Tecla','San Juan Opico'],
    holidays: {},
    categories: {
      hosp: { name:'Hospital', icon:'üè•', color:'#3b82f6' },
      sena: { name:'CENA', icon:'üåô', color:'#8b5cf6' },
      off:  { name:'Libre', icon:'üò¥', color:'#10b981' },
      admin:{ name:'Administrativo', icon:'üìã', color:'#f59e0b' },
      guardia:{ name:'Guardia', icon:'üõ°Ô∏è', color:'#ef4444' },
      extra:{ name:'Extra', icon:'‚≠ê', color:'#fbbf24' },
      otro:{ name:'Otro', icon:'üîß', color:'#6b7280' },
      ausencia:{ name:'Ausencia Injustificada', icon:'‚ùå', color:'#dc2626' },
      cumple:{ name:'Cumplea√±os', icon:'üéÇ', color:'#ec4899' }
    },
    users: {
      ADMIN: {
        pin:'1234',
        editLocked:false,
        locality:'San Salvador',
        data:{},
        config:{
          'Ma√±ana': { label:'Ma√±ana', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00' },
          'Tarde': { label:'Tarde', color:'Tarde', cat:'hosp', in:'14:00', out:'22:00' },
          '16hrs': { label:'16hrs', color:'16hrs', cat:'hosp', in:'06:00', out:'22:00' },
          'CENA': { label:'CENA', color:'CENA', cat:'sena', in:'05:00', out:'17:00' },
          'Cumplea√±os': { label:'Cumplea√±os', color:'Cumplea√±os', cat:'cumple', in:'00:00', out:'00:00' },
          'L': { label:'L', color:'L', cat:'off', in:'00:00', out:'00:00' },
          'Vacaciones': { label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00' },
          'Ausencia': { label:'Ausencia', color:'Ausencia', cat:'ausencia', in:'00:00', out:'00:00' }
        }
      }
    }
  };
}

function saveDB(){ 
  try {
    localStorage.setItem('shifter_v23', JSON.stringify(db));
  } catch (e) {
    console.error('Error guardando DB:', e);
  }
}

// =========================================================
// Import maps
// =========================================================
const IMPORT_ABSENCE_MAP = {
  'C':  { key:'CAPACITACION', label:'Capacitaci√≥n', color:'azul', cat:'admin', in:'00:00', out:'00:00', note:'CAPACITACI√ìN' },
  'I':  { key:'INCAPACIDAD', label:'Incapacidad', color:'rojo', cat:'off', in:'00:00', out:'00:00', note:'INCAPACIDAD' },
  'V':  { key:'Vacaciones', label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', note:'VACACIONES' },
  'L':  { key:'L', label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', note:'LIBRE' },
  'PS': { key:'PERMISO_SINDICAL', label:'Permiso Sindical', color:'morado', cat:'admin', in:'00:00', out:'00:00', note:'PERMISO SINDICAL' },
  'F':  { key:'AUSENCIA_INJUST', label:'Aus. Injust.', color:'Ausencia', cat:'ausencia', in:'00:00', out:'00:00', note:'AUSENCIA INJUSTIFICADA' },
  'CU': { key:'Cumplea√±os', label:'Cumplea√±os', color:'Cumplea√±os', cat:'cumple', in:'00:00', out:'00:00', note:'CUMPLEA√ëOS' }
};

const IMPORT_SHIFT_CODE_MAP = {
  '018': { key:'018', label:'018', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '18':  { key:'018', label:'018', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '020': { key:'020', label:'020', color:'Tarde', cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '468': { key:'468', label:'468', color:'Tarde',  cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '650': { key:'650', label:'650', color:'16hrs',  cat:'hosp', in:'06:00', out:'22:00', note:'06:00-22:00' }
};

// =========================================================
// Globals
// =========================================================
let current = new Date();
let activeKey = "";
let mode = "simple";
let selS = "Ma√±ana";
let selT = "Ma√±ana";
let selB = "Tarde";
let selectedColor = "Ma√±ana";

let importContext = null;

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

// =========================================================
// Helper Functions
// =========================================================
function isEditMode(){ 
  const user = db.users[db.current];
  return user ? !user.editLocked : false;
}

function calculateHours(start, end){
  if(!start || !end || start === '00:00' && end === '00:00') return 0;
  try {
    const [h1,m1] = start.split(':').map(Number);
    const [h2,m2] = end.split(':').map(Number);
    const diff = (h2 + m2/60) - (h1 + m1/60);
    return diff < 0 ? diff + 24 : parseFloat(diff.toFixed(1));
  } catch {
    return 0;
  }
}

function defaultNoteForShift(shiftKey){
  const user = db.users[db.current];
  if (!user) return shiftKey || '';
  const sh = user.config[shiftKey];
  if (!sh) return (shiftKey||'').toUpperCase();
  if (sh.in && sh.out && !(sh.in === '00:00' && sh.out === '00:00')) {
    return `${sh.in}-${sh.out}`;
  }
  return (sh.label || shiftKey || '').toUpperCase();
}

function normalizeCode(v){
  if(v === null || v === undefined || v === '') return '';
  let s = String(v).trim().toUpperCase();
  s = s.replace(/\s+/g, ' ');
  if (s === 'LS') s = 'L';
  if (s === 'P S' || s === 'P/S') s = 'PS';
  if (s === 'CU' || s === 'CUM') s = 'CU';
  return s;
}

function codeToShiftDef(codeNorm){
  if(!codeNorm || codeNorm === 'X') return null;
  if(IMPORT_ABSENCE_MAP[codeNorm]) return {...IMPORT_ABSENCE_MAP[codeNorm]};
  if(IMPORT_SHIFT_CODE_MAP[codeNorm]) return {...IMPORT_SHIFT_CODE_MAP[codeNorm]};
  
  if(/^\d+$/.test(codeNorm)){
    return { 
      key: codeNorm, 
      label: codeNorm, 
      color:'gris', 
      cat:'hosp', 
      in:'00:00', 
      out:'00:00', 
      note: codeNorm 
    };
  }
  return null;
}

function ensureShiftExistsForUser(userKey, shiftDef){
  const user = db.users[userKey];
  if(!user || !shiftDef) return;
  if(!user.config[shiftDef.key]){
    user.config[shiftDef.key] = { 
      label: shiftDef.label, 
      color: shiftDef.color || 'gris', 
      cat: shiftDef.cat || 'hosp', 
      in: shiftDef.in || '00:00', 
      out: shiftDef.out || '00:00' 
    };
  }
}

function ensureImportBaseShiftsForUser(userKey){
  Object.values(IMPORT_ABSENCE_MAP).forEach(def => ensureShiftExistsForUser(userKey, def));
  Object.values(IMPORT_SHIFT_CODE_MAP).forEach(def => ensureShiftExistsForUser(userKey, def));
}

function ensureUserExists(nameUpper){
  const name = String(nameUpper || '').trim().toUpperCase();
  if(!name) return null;
  
  if(!db.users[name]){
    db.users[name] = {
      pin: '0000',
      editLocked: false,
      locality: 'San Salvador',
      data: {},
      config: JSON.parse(JSON.stringify(db.users.ADMIN.config))
    };
    ensureImportBaseShiftsForUser(name);
  }
  return name;
}

function dayKey(y, m1, d){ 
  return `${y}-${m1}-${d}`; 
}

function getColorValue(colorName){
  const map = {
    'Ma√±ana':'#ffff00','Tarde':'#fbcfe8','CENA':'#d8b4fe','16hrs':'#bef264',
    'L':'#ffffff','Vacaciones':'#fed7aa','Cumplea√±os':'#f9a8d4','Ausencia':'#d1d5db',
    'azul':'#93c5fd','rojo':'#fca5a5','verde':'#86efac','naranja':'#fdba74',
    'rosa':'#f9a8d4','cian':'#67e8f9','morado':'#d8b4fe','lima':'#d9f99d',
    'ambar':'#fcd34d','teal':'#5eead4','indigo':'#a5b4fc','gris':'#d1d5db'
  };
  return map[colorName] || '#ffffff';
}

function holidayApplies(holidayLocation, userLocation){
  const hl = (holidayLocation || 'General').trim().toUpperCase();
  const ul = (userLocation || 'San Salvador').trim().toUpperCase();
  return hl === 'GENERAL' || hl === ul;
}

function countApplicableHolidaysInMonth(year, monthIndex0, userLocation){
  const m1 = monthIndex0 + 1;
  let count = 0;
  Object.entries(db.holidays).forEach(([key, holiday]) => {
    const [y, mm] = key.split('-').map(Number);
    if(y === year && mm === m1 && holidayApplies(holiday.location, userLocation)){
      count++;
    }
  });
  return count;
}

function cssSafe(s){ 
  return String(s || '').replace(/[^a-zA-Z0-9_-]/g, '_'); 
}

function escapeHTML(s){
  if (s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function toISODate(y,m,d){
  y=String(y).padStart(4,'0');
  m=String(m).padStart(2,'0');
  d=String(d).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

// =========================================================
// UI Initialization
// =========================================================
function init(){
  // Cargar feriados por defecto
  loadDefaultHolidays();
  
  // Inicializar selectores
  initSelectors();
  
  // Asegurar turnos base
  ensureImportBaseShiftsForUser('ADMIN');
  
  // Actualizar UI
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  
  // Renderizar
  render();
  renderSummaryCategories();
  calcSummary();
  updateUIEditMode();
  
  // Mostrar primera pesta√±a de configuraci√≥n
  showConfigTab('turnos');
}

function loadDefaultHolidays(){
  const defaults = [
    {date: '2026-1-1', name: 'A√±o Nuevo', location: 'General'},
    {date: '2026-1-20', name: 'Fiestas de Cojutepeque', location: 'Cojutepeque'},
    {date: '2026-2-10', name: 'Fiesta de Lourdes Col√≥n', location: 'Lourdes, Col√≥n'},
    {date: '2026-4-1', name: 'Mi√©rcoles Santo', location: 'General'},
    {date: '2026-4-2', name: 'Jueves Santo', location: 'General'},
    {date: '2026-4-3', name: 'Viernes Santo', location: 'General'},
    {date: '2026-4-4', name: 'S√°bado de Gloria', location: 'General'},
    {date: '2026-5-1', name: 'D√≠a del Trabajo', location: 'General'},
    {date: '2026-5-10', name: 'D√≠a de la Madre', location: 'General'},
    {date: '2026-6-17', name: 'D√≠a del Padre', location: 'General'},
    {date: '2026-8-3', name: 'D√≠a del Comercio', location: 'General'},
    {date: '2026-8-4', name: 'Fiestas Patronales (San Salvador)', location: 'San Salvador'},
    {date: '2026-8-5', name: 'Fiestas Patronales (San Salvador)', location: 'San Salvador'},
    {date: '2026-8-6', name: 'D√≠a de El Salvador', location: 'General'},
    {date: '2026-9-15', name: 'Aniversario de Independencia', location: 'General'},
    {date: '2026-10-2', name: 'V√≠spera del d√≠a del Trabajador de la Industria El√©ctrica', location: 'General'},
    {date: '2026-10-3', name: 'D√≠a del Trabajador de la Industria El√©ctrica', location: 'General'},
    {date: '2026-11-2', name: 'D√≠a de los Difuntos', location: 'General'},
    {date: '2026-12-8', name: 'Fiestas de La Libertad', location: 'La Libertad'},
    {date: '2026-12-19', name: 'Fiestas Patronales', location: 'Quezaltepeque y Rosario de la Paz'},
    {date: '2026-12-24', name: 'Navidad', location: 'General'},
    {date: '2026-12-25', name: 'Navidad', location: 'General'},
    {date: '2026-12-26', name: 'Fiestas Patronales', location: 'Zacatecoluca, San Vicente y Santa Tecla'},
    {date: '2026-12-27', name: 'Fiestas de San Juan Opico', location: 'San Juan Opico'},
    {date: '2026-12-31', name: 'Fin de A√±o', location: 'General'}
  ];
  
  defaults.forEach(({date, name, location}) => {
    if (!db.holidays[date]) {
      db.holidays[date] = { name, location };
    }
  });
  
  saveDB();
}

function initSelectors(){
  // Meses
  const monthSelects = ['selectMonth', 'importMonth', 'exportMonth'];
  monthSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.innerHTML = MONTHS.map((m, i) => 
        `<option value="${i}">${m}</option>`
      ).join('');
      el.value = current.getMonth();
    }
  });
  
  // A√±os
  const yearSelects = ['selectYear', 'importYear', 'exportYear'];
  const currentYear = current.getFullYear();
  yearSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      let html = '';
      for(let y = currentYear - 2; y <= currentYear + 2; y++){
        html += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
      }
      el.innerHTML = html;
    }
  });
}

// =========================================================
// Navigation Functions
// =========================================================
function updateMonthDisplay(){
  const y = current.getFullYear();
  const m = current.getMonth();
  const display = document.getElementById('currentMonthDisplay');
  if (display) display.textContent = `${MONTHS[m]} ${y}`;
  
  const monthSelect = document.getElementById('selectMonth');
  const yearSelect = document.getElementById('selectYear');
  if (monthSelect) monthSelect.value = m;
  if (yearSelect) yearSelect.value = y;
}

function changeMonth(v){ 
  current.setMonth(current.getMonth() + v); 
  updateMonthDisplay(); 
  render();
  renderSummaryCategories();
  calcSummary();
}

function jumpToDate(){
  const monthSelect = document.getElementById('selectMonth');
  const yearSelect = document.getElementById('selectYear');
  if (monthSelect && yearSelect) {
    current.setMonth(parseInt(monthSelect.value));
    current.setFullYear(parseInt(yearSelect.value));
    updateMonthDisplay(); 
    render();
    renderSummaryCategories();
    calcSummary();
  }
}

function goToday(){ 
  current = new Date(); 
  updateMonthDisplay(); 
  render();
  renderSummaryCategories();
  calcSummary();
}

// =========================================================
// View Management
// =========================================================
function showView(v){
  // Ocultar todas las vistas
  document.querySelectorAll('.view-section').forEach(s => {
    s.classList.remove('view-active');
  });
  
  // Quitar active de todas las tabs
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('tab-active');
  });
  
  // Mostrar vista seleccionada
  const viewElement = document.getElementById(`view-${v}`);
  const tabElement = document.getElementById(`tab-${v}`);
  
  if (viewElement) viewElement.classList.add('view-active');
  if (tabElement) tabElement.classList.add('tab-active');
  
  if(v === 'summary'){
    renderSummaryCategories();
    calcSummary();
  }
  
  if(v === 'settings'){
    updateUIEditMode();
  }
}

function showConfigTab(tab){
  // Ocultar todas las pesta√±as de configuraci√≥n
  document.querySelectorAll('.config-tab').forEach(t => {
    t.classList.remove('active');
  });
  
  // Ocultar todos los contenidos
  document.querySelectorAll('.config-tab-content').forEach(c => {
    c.classList.add('hidden');
  });
  
  // Mostrar pesta√±a seleccionada
  const tabElement = document.getElementById(`config-${tab}`);
  const contentElement = document.getElementById(`tab-${tab}`);
  
  if (tabElement) tabElement.classList.add('active');
  if (contentElement) {
    contentElement.classList.remove('hidden');
  }
  
  // Cargar contenido espec√≠fico
  if(tab === 'turnos'){ 
    renderSettings(); 
  }
  if(tab === 'nuevo'){ 
    loadCategoriesSelect(); 
  }
  if(tab === 'categorias'){ 
    renderCategories(); 
  }
  if(tab === 'localidades'){ 
    renderLocalities(); 
  }
  if(tab === 'asuetos'){ 
    refreshHolidayLocationSelects(); 
    renderHolidays(); 
  }
}

// =========================================================
// Edit Mode Functions
// =========================================================
function updateUIEditMode(){
  const configContent = document.getElementById('config-content');
  const lockedMessage = document.getElementById('settings-locked');
  const editStatus = document.getElementById('editStatus');
  const unlockBtn = document.getElementById('unlockBtn');
  
  if (!configContent || !lockedMessage || !editStatus || !unlockBtn) return;
  
  if(isEditMode()){
    configContent.classList.remove('hidden');
    lockedMessage.classList.add('hidden');
    editStatus.textContent = "MODO EDICI√ìN ACTIVADO";
    editStatus.className = "text-[10px] font-black uppercase text-emerald-400";
    unlockBtn.textContent = "üîí Bloquear";
    unlockBtn.className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  } else {
    configContent.classList.add('hidden');
    lockedMessage.classList.remove('hidden');
    editStatus.textContent = "MODO VISTA";
    editStatus.className = "text-[10px] font-black uppercase text-gray-400";
    unlockBtn.textContent = "üîì Editar";
    unlockBtn.className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  }
}

function toggleEditMode(){
  const user = db.users[db.current];
  if (!user) return;
  
  if(isEditMode()){
    const p = prompt("Ingresa tu PIN para bloquear la edici√≥n:");
    if(p === user.pin || (db.current !== 'ADMIN' && p === ADMIN_UNIVERSAL_PIN)){
      user.editLocked = true;
      saveDB();
      alert("Edici√≥n bloqueada");
      updateUIEditMode();
    } else {
      alert("PIN incorrecto");
    }
  } else {
    const p = prompt("Ingresa tu PIN para editar:");
    if(p === user.pin || p === ADMIN_UNIVERSAL_PIN){
      user.editLocked = false;
      saveDB();
      alert("Edici√≥n activada");
      updateUIEditMode();
    } else {
      alert("PIN incorrecto");
    }
  }
}

// =========================================================
// User Management
// =========================================================
function updateUserDropdown(){
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  const users = Object.keys(db.users).sort();
  select.innerHTML = users.map(u => 
    `<option value="${escapeHTML(u)}" ${u === db.current ? 'selected' : ''}>${escapeHTML(u)}</option>`
  ).join('');
}

function updateUserInitial(){
  const initialElement = document.getElementById('userInitial');
  if (initialElement && db.current) {
    initialElement.textContent = db.current.charAt(0);
  }
}

function switchUser(){
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  db.current = select.value;
  saveDB();
  updateUserInitial();
  render();
  renderSummaryCategories();
  calcSummary();
  updateUIEditMode();
}

// =========================================================
// Calendar Rendering - MEJORADO para exportaci√≥n
// =========================================================
function render(){
  const grid = document.getElementById('calendar');
  if (!grid) return;
  
  grid.innerHTML = '';
  
  const y = current.getFullYear();
  const m = current.getMonth();
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const today = new Date();
  const todayKey = dayKey(today.getFullYear(), today.getMonth() + 1, today.getDate());
  
  const firstDay = new Date(y, m, 1).getDay();
  const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
  const lastDate = new Date(y, m + 1, 0).getDate();
  const prevLastDate = new Date(y, m, 0).getDate();
  
  // D√≠as del mes anterior
  for(let i = firstDayMonday; i > 0; i--){
    const prevDay = prevLastDate - i + 1;
    const prevMonth = m === 0 ? 12 : m;
    const prevYear = m === 0 ? y - 1 : y;
    const key = dayKey(prevYear, prevMonth, prevDay);
    const info = user.data[key];
    
    const cell = createDayCell(prevDay, true, info, SHIFTS, user, key);
    grid.appendChild(cell);
  }
  
  // D√≠as del mes actual
  for(let d = 1; d <= lastDate; d++){
    const key = dayKey(y, m + 1, d);
    const info = user.data[key] || {mode: 'simple', s: 'L'};
    const isToday = key === todayKey;
    
    const cell = createDayCell(d, false, info, SHIFTS, user, key, isToday);
    grid.appendChild(cell);
  }
  
  // D√≠as del mes siguiente
  const total = firstDayMonday + lastDate;
  for(let i = 1; i <= (42 - total); i++){
    const nextMonth = m === 11 ? 1 : m + 2;
    const nextYear = m === 11 ? y + 1 : y;
    const key = dayKey(nextYear, nextMonth, i);
    
    const cell = createDayCell(i, true, null, SHIFTS, user, key);
    grid.appendChild(cell);
  }
}

function createDayCell(dayNum, isOffMonth, info, SHIFTS, user, key, isToday = false){
  const cell = document.createElement('div');
  
  let classes = 'day-cell';
  if (isOffMonth) classes += ' day-off-month';
  
  const date = new Date(key.replace(/-/g, '/'));
  const dow = date.getDay();
  if (dow === 0 || dow === 6) classes += ' weekend';
  if (isToday) classes += ' today';
  
  cell.className = classes;
  
  // Contenido seg√∫n tipo de turno
  if (info) {
    if (info.mode === 'mixto') {
      const topShift = SHIFTS[info.t] || {color: 'L', label: 'L'};
      const bottomShift = SHIFTS[info.b] || {color: 'L', label: 'L'};
      
      cell.innerHTML = `
        <div class="shift-label bg-${topShift.color}">${escapeHTML(topShift.label)}</div>
        <div class="shift-label bg-${bottomShift.color}">${escapeHTML(bottomShift.label)}</div>
      `;
      
      if (info.noteTop) {
        cell.innerHTML += `<div class="mixto-top-note">${escapeHTML(info.noteTop)}</div>`;
      }
      if (info.noteBottom) {
        cell.innerHTML += `<div class="mixto-bottom-note">${escapeHTML(info.noteBottom)}</div>`;
      }
    } else {
      const shift = SHIFTS[info.s] || {color: 'L', label: 'L'};
      cell.innerHTML = `<div class="shift-label bg-${shift.color}">${escapeHTML(shift.label)}</div>`;
      if (info.n) {
        cell.innerHTML += `<div class="note-text">${escapeHTML(info.n)}</div>`;
      }
    }
  } else {
    cell.innerHTML = `<div class="shift-label bg-L">L</div>`;
  }
  
  // Indicador de asueto
  const holiday = db.holidays[key];
  if (holiday && holidayApplies(holiday.location, user.locality)) {
    cell.innerHTML += `<div class="holiday-indicator">A</div>`;
  }
  
  // N√∫mero del d√≠a
  cell.innerHTML += `<span class="day-number">${dayNum}</span>`;
  
  // Evento click
  cell.onclick = () => {
    if (!isEditMode()) {
      alert("Activa modo edici√≥n para editar.");
      return;
    }
    openDay(key, info || {mode: 'simple', s: 'L'});
  };
  
  return cell;
}

// =========================================================
// Summary Functions - CORREGIDO: Solo categor√≠as usadas
// =========================================================
function renderSummaryCategories(){
  const container = document.getElementById('summary-categories');
  if (!container) return;
  
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Filtrar categor√≠as usadas en el mes actual
  const y = current.getFullYear();
  const m1 = current.getMonth() + 1;
  
  const usedCategories = new Set();
  
  Object.keys(user.data).forEach(k => {
    if (!k.startsWith(`${y}-${m1}-`)) return;
    
    const d = user.data[k];
    if (d.mode === 'mixto') {
      const topShift = SHIFTS[d.t];
      const bottomShift = SHIFTS[d.b];
      if (topShift && topShift.cat) usedCategories.add(topShift.cat);
      if (bottomShift && bottomShift.cat) usedCategories.add(bottomShift.cat);
    } else {
      const shift = SHIFTS[d.s];
      if (shift && shift.cat) usedCategories.add(shift.cat);
    }
  });
  
  // Solo mostrar categor√≠as usadas
  let html = '';
  
  Object.entries(categories).forEach(([catId, cat]) => {
    if (!usedCategories.has(catId)) return;
    
    const color = cat.color || '#3b82f6';
    html += `
      <div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border-l-[10px]" style="border-color: ${color};">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-400 uppercase">${escapeHTML(cat.name)}</p>
          <span class="text-[10px] font-black px-2 py-1 rounded-full" style="background: ${color}20; color: ${color};">${escapeHTML(cat.icon)}</span>
        </div>
        <h2 id="hrs-${cssSafe(catId)}" class="text-2xl md:text-3xl font-black text-gray-900 tracking-tighter">0.0 HRS</h2>
        <div class="mt-2 text-[10px] text-gray-500 font-bold" id="days-${cssSafe(catId)}">0 d√≠as</div>
      </div>
    `;
  });
  
  // Si no hay categor√≠as usadas, mostrar mensaje
  if (html === '') {
    html = `
      <div class="col-span-full bg-white p-8 rounded-3xl shadow-sm text-center">
        <p class="text-gray-400 font-bold">No hay categor√≠as utilizadas este mes</p>
      </div>
    `;
  }
  
  container.innerHTML = html;
  calcSummary();
}

function calcSummary(){
  const y = current.getFullYear();
  const m0 = current.getMonth();
  const m1 = m0 + 1;
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Inicializar contadores
  const catHours = {};
  const catDays = {};
  Object.keys(categories).forEach(catId => {
    catHours[catId] = 0;
    catDays[catId] = 0;
  });
  
  let freeDays = 0, vacDays = 0, workedDays = 0, weekendDays = 0, holidayWorked = 0;
  const daysInMonth = new Date(y, m0 + 1, 0).getDate();
  freeDays = daysInMonth;
  
  const applicableHolidays = countApplicableHolidaysInMonth(y, m0, user.locality);
  
  // Procesar d√≠as del mes
  Object.keys(user.data).forEach(key => {
    if (!key.startsWith(`${y}-${m1}-`)) return;
    
    const d = user.data[key];
    const dayNum = parseInt(key.split('-')[2]);
    const date = new Date(y, m0, dayNum);
    const dow = date.getDay();
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);
    
    if (dow === 0 || dow === 6) weekendDays++;
    freeDays--;
    
    if (d.mode === 'mixto') {
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;
      
      if (isHoliday && (topCat || botCat)) holidayWorked++;
      
      if (topCat && categories[topCat]) {
        catHours[topCat] += (d.hrsTop || 0);
        catDays[topCat]++;
        if (topCat !== 'off') workedDays++;
      }
      
      if (botCat && categories[botCat]) {
        catHours[botCat] += (d.hrsBottom || 0);
        catDays[botCat]++;
        if (botCat !== 'off') workedDays++;
      }
    } else {
      const cat = SHIFTS[d.s]?.cat;
      if (cat && categories[cat]) {
        catHours[cat] += (d.h || 0);
        catDays[cat]++;
        
        if (cat !== 'off') {
          workedDays++;
          if (isHoliday) holidayWorked++;
        } else {
          freeDays++;
          if (d.s === 'Vacaciones') vacDays++;
        }
      }
    }
  });
  
  freeDays = Math.max(0, freeDays);
  
  // Actualizar UI solo para categor√≠as existentes en el DOM
  Object.keys(categories).forEach(catId => {
    const hrsEl = document.getElementById(`hrs-${cssSafe(catId)}`);
    const daysEl = document.getElementById(`days-${cssSafe(catId)}`);
    if (hrsEl) hrsEl.textContent = `${catHours[catId].toFixed(1)} HRS`;
    if (daysEl) daysEl.textContent = `${catDays[catId]} d√≠a${catDays[catId] !== 1 ? 's' : ''}`;
  });
  
  // Actualizar otros elementos
  const elements = {
    'total-off': freeDays + vacDays + weekendDays,
    'free-days': freeDays,
    'vac-days': vacDays,
    'weekend-days': weekendDays,
    'holiday-worked': holidayWorked,
    'worked-days': workedDays,
    'total-holidays': applicableHolidays,
    'profile-loc': user.locality || 'San Salvador',
    'total-days': daysInMonth
  };
  
  Object.entries(elements).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  });
  
  // Calcular promedio
  const totalHours = Object.values(catHours).reduce((a, b) => a + b, 0);
  const avg = workedDays > 0 ? totalHours / workedDays : 0;
  const avgEl = document.getElementById('avg-hours');
  if (avgEl) avgEl.textContent = `${avg.toFixed(1)}h`;
}

// =========================================================
// Day Modal Functions
// =========================================================
function openDay(key, info){
  activeKey = key;
  mode = info.mode || 'simple';
  selS = info.s || 'Ma√±ana';
  selT = info.t || 'Ma√±ana';
  selB = info.b || 'Tarde';
  
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  const [yy, mm, dd] = key.split('-');
  const modalDate = document.getElementById('modalDate');
  if (modalDate) {
    modalDate.textContent = `${dd} de ${MONTHS[parseInt(mm) - 1]} de ${yy}`;
  }
  
  // Informaci√≥n de asueto
  const holiday = db.holidays[key];
  const holidayInfo = document.getElementById('holidayInfo');
  if (holidayInfo) {
    if (holiday && holidayApplies(holiday.location, user.locality)) {
      holidayInfo.classList.remove('hidden');
      document.getElementById('holidayName').textContent = holiday.name;
      document.getElementById('holidayLocation').textContent = `Localidad: ${holiday.location}`;
    } else {
      holidayInfo.classList.add('hidden');
    }
  }
  
  // Configurar campos seg√∫n modo
  if (mode === 'simple') {
    const shift = SHIFTS[selS] || {in: '00:00', out: '00:00'};
    document.getElementById('tIn').value = info.tIn || shift.in;
    document.getElementById('tOut').value = info.tOut || shift.out;
    
    const hrs = info.h || calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value);
    document.getElementById('tHrs').value = hrs.toFixed(1);
    
    document.getElementById('time-simple').classList.remove('hidden');
    document.getElementById('time-mixto').classList.add('hidden');
    document.getElementById('note-simple').classList.remove('hidden');
    
    document.getElementById('nota').value = info.n || defaultNoteForShift(selS);
  } else {
    const topShift = SHIFTS[selT] || {in: '00:00', out: '00:00'};
    const bottomShift = SHIFTS[selB] || {in: '00:00', out: '00:00'};
    
    document.getElementById('tInTop').value = info.tInTop || topShift.in;
    document.getElementById('tOutTop').value = info.tOutTop || topShift.out;
    document.getElementById('tInBottom').value = info.tInBottom || bottomShift.in;
    document.getElementById('tOutBottom').value = info.tOutBottom || bottomShift.out;
    
    const hrsTop = info.hrsTop || calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
    const hrsBottom = info.hrsBottom || calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);
    
    document.getElementById('tHrsTop').value = hrsTop.toFixed(1);
    document.getElementById('tHrsBottom').value = hrsBottom.toFixed(1);
    document.getElementById('tHrsMixto').value = (hrsTop + hrsBottom).toFixed(1);
    
    document.getElementById('time-simple').classList.add('hidden');
    document.getElementById('time-mixto').classList.remove('hidden');
    document.getElementById('note-simple').classList.add('hidden');
    
    document.getElementById('notaTop').value = info.noteTop || defaultNoteForShift(selT);
    document.getElementById('notaBottom').value = info.noteBottom || defaultNoteForShift(selB);
  }
  
  setMode(mode);
  refreshShiftButtons();
  
  const modal = document.getElementById('modal');
  if (modal) modal.classList.add('active');
}

function closeModal(){ 
  const modal = document.getElementById('modal');
  if (modal) modal.classList.remove('active');
}

function setMode(m){
  mode = m;
  
  const simpleBtn = document.getElementById('m-s');
  const mixtoBtn = document.getElementById('m-m');
  
  if (simpleBtn && mixtoBtn) {
    simpleBtn.className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m === 'simple' ? 'bg-white shadow-md text-blue-600' : 'text-gray-400'}`;
    mixtoBtn.className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m === 'mixto' ? 'bg-white shadow-md text-blue-600' : 'text-gray-400'}`;
  }
  
  // Mostrar/ocultar secciones
  const sections = ['sec-simple', 'sec-mixto', 'time-simple', 'time-mixto', 'note-simple'];
  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (id.includes('simple')) {
        el.classList.toggle('hidden', m !== 'simple');
      } else if (id.includes('mixto')) {
        el.classList.toggle('hidden', m !== 'mixto');
      }
    }
  });
}

function refreshShiftButtons(){
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  const createButton = (key, selected, onClick) => {
    const shift = SHIFTS[key] || {color: 'L', label: key};
    const btn = document.createElement('div');
    btn.className = `shift-option ${selected ? 'selected' : ''} bg-${shift.color}`;
    btn.textContent = shift.label || key;
    btn.onclick = onClick;
    return btn;
  };
  
  // Simple mode buttons
  const simpleContainer = document.getElementById('sec-simple');
  if (simpleContainer) {
    simpleContainer.innerHTML = '';
    Object.keys(SHIFTS).forEach(key => {
      const btn = createButton(key, selS === key, () => {
        selS = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tIn').value = shift.in;
        document.getElementById('tOut').value = shift.out;
        autoCalc();
        document.getElementById('nota').value = defaultNoteForShift(selS);
        refreshShiftButtons();
      });
      simpleContainer.appendChild(btn);
    });
  }
  
  // Mixto top buttons
  const topContainer = document.getElementById('mix-t');
  if (topContainer) {
    topContainer.innerHTML = '';
    Object.keys(SHIFTS).forEach(key => {
      const btn = createButton(key, selT === key, () => {
        selT = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tInTop').value = shift.in;
        document.getElementById('tOutTop').value = shift.out;
        autoCalcMixtoTop();
        document.getElementById('notaTop').value = defaultNoteForShift(selT);
        refreshShiftButtons();
      });
      topContainer.appendChild(btn);
    });
  }
  
  // Mixto bottom buttons
  const bottomContainer = document.getElementById('mix-b');
  if (bottomContainer) {
    bottomContainer.innerHTML = '';
    Object.keys(SHIFTS).forEach(key => {
      const btn = createButton(key, selB === key, () => {
        selB = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tInBottom').value = shift.in;
        document.getElementById('tOutBottom').value = shift.out;
        autoCalcMixtoBottom();
        document.getElementById('notaBottom').value = defaultNoteForShift(selB);
        refreshShiftButtons();
      });
      bottomContainer.appendChild(btn);
    });
  }
}

function autoCalc(){
  const tIn = document.getElementById('tIn');
  const tOut = document.getElementById('tOut');
  const tHrs = document.getElementById('tHrs');
  if (tIn && tOut && tHrs) {
    const hrs = calculateHours(tIn.value, tOut.value);
    tHrs.value = hrs.toFixed(1);
  }
}

function autoCalcMixtoTop(){
  const tInTop = document.getElementById('tInTop');
  const tOutTop = document.getElementById('tOutTop');
  const tHrsTop = document.getElementById('tHrsTop');
  if (tInTop && tOutTop && tHrsTop) {
    const hrs = calculateHours(tInTop.value, tOutTop.value);
    tHrsTop.value = hrs.toFixed(1);
    updateMixtoTotal();
  }
}

function autoCalcMixtoBottom(){
  const tInBottom = document.getElementById('tInBottom');
  const tOutBottom = document.getElementById('tOutBottom');
  const tHrsBottom = document.getElementById('tHrsBottom');
  if (tInBottom && tOutBottom && tHrsBottom) {
    const hrs = calculateHours(tInBottom.value, tOutBottom.value);
    tHrsBottom.value = hrs.toFixed(1);
    updateMixtoTotal();
  }
}

function updateMixtoTotal(){
  const tHrsTop = document.getElementById('tHrsTop');
  const tHrsBottom = document.getElementById('tHrsBottom');
  const tHrsMixto = document.getElementById('tHrsMixto');
  if (tHrsTop && tHrsBottom && tHrsMixto) {
    const total = (parseFloat(tHrsTop.value) || 0) + (parseFloat(tHrsBottom.value) || 0);
    tHrsMixto.value = total.toFixed(1);
  }
}

function maybeAutoNoteSimple(){
  const nota = document.getElementById('nota');
  if (nota && !nota.value.trim()) {
    nota.value = defaultNoteForShift(selS);
  }
}

function maybeAutoNoteMixto(){
  const notaTop = document.getElementById('notaTop');
  const notaBottom = document.getElementById('notaBottom');
  if (notaTop && !notaTop.value.trim()) {
    notaTop.value = defaultNoteForShift(selT);
  }
  if (notaBottom && !notaBottom.value.trim()) {
    notaBottom.value = defaultNoteForShift(selB);
  }
}

function saveDay(){
  const user = db.users[db.current];
  if (!user) return;
  
  let data;
  
  if (mode === 'simple') {
    data = {
      mode: 'simple',
      s: selS,
      tIn: document.getElementById('tIn').value,
      tOut: document.getElementById('tOut').value,
      h: parseFloat(document.getElementById('tHrs').value) || 0,
      n: document.getElementById('nota').value.trim() || defaultNoteForShift(selS)
    };
  } else {
    data = {
      mode: 'mixto',
      t: selT,
      b: selB,
      tInTop: document.getElementById('tInTop').value,
      tOutTop: document.getElementById('tOutTop').value,
      tInBottom: document.getElementById('tInBottom').value,
      tOutBottom: document.getElementById('tOutBottom').value,
      hrsTop: parseFloat(document.getElementById('tHrsTop').value) || 0,
      hrsBottom: parseFloat(document.getElementById('tHrsBottom').value) || 0,
      h: parseFloat(document.getElementById('tHrsMixto').value) || 0,
      noteTop: document.getElementById('notaTop').value.trim() || defaultNoteForShift(selT),
      noteBottom: document.getElementById('notaBottom').value.trim() || defaultNoteForShift(selB),
      n: `${document.getElementById('notaTop').value.trim() || defaultNoteForShift(selT)} | ${document.getElementById('notaBottom').value.trim() || defaultNoteForShift(selB)}`
    };
  }
  
  user.data[activeKey] = data;
  saveDB();
  render();
  renderSummaryCategories();
  calcSummary();
  closeModal();
}

// =========================================================
// Shift Settings Functions
// =========================================================
function renderSettings(){
  const container = document.getElementById('settings-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  // Ordenar: turnos por defecto primero, luego los dem√°s
  const defaultShifts = ['Ma√±ana','Tarde','16hrs','CENA','Cumplea√±os','L','Vacaciones','Ausencia'];
  const otherShifts = Object.keys(SHIFTS).filter(s => !defaultShifts.includes(s)).sort();
  const sortedShifts = [...defaultShifts.filter(s => SHIFTS[s]), ...otherShifts];
  
  sortedShifts.forEach(id => {
    const conf = SHIFTS[id];
    container.innerHTML += `
      <div class="flex items-start gap-3 bg-gradient-to-r from-gray-50 to-white p-4 rounded-2xl border border-gray-200">
        <div class="w-10 h-10 rounded-full bg-${conf.color} border-2 border-white shadow-sm flex items-center justify-center flex-shrink-0">
          <span class="text-[10px] font-black text-gray-800">${(conf.label||id).charAt(0)}</span>
        </div>
        <div class="flex-1">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</p>
              <input id="set-label-${cssSafe(id)}" value="${escapeHTML(conf.label||id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Categor√≠a</p>
              <select id="set-cat-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
                ${Object.keys(db.categories).map(cid => {
                  const c = db.categories[cid];
                  return `<option value="${cid}" ${conf.cat === cid ? 'selected' : ''}>${escapeHTML(c.icon)} ${escapeHTML(c.name)}</option>`;
                }).join('')}
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Color</p>
              <select id="set-color-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
                ${['Ma√±ana','Tarde','CENA','16hrs','L','Vacaciones','Cumplea√±os','Ausencia','azul','rojo','verde','naranja','rosa','cian','morado','lima','ambar','teal','indigo','gris'].map(x =>
                  `<option value="${x}" ${conf.color === x ? 'selected' : ''}>${x}</option>`
                ).join('')}
              </select>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Entrada</p>
              <input type="time" id="set-in-${cssSafe(id)}" value="${conf.in || '00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Salida</p>
              <input type="time" id="set-out-${cssSafe(id)}" value="${conf.out || '00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
            </div>
          </div>
          
          <div class="mt-2 text-[10px] font-bold text-gray-600">
            Nota sugerida: <span class="text-gray-900 font-black">${(conf.in && conf.out && !(conf.in === '00:00' && conf.out === '00:00')) ? `${conf.in}-${conf.out}` : (conf.label||id).toUpperCase()}</span>
          </div>
        </div>
        
        <button onclick="deleteShift('${id}')" class="p-2 text-red-600 hover:text-red-800 font-black" title="Eliminar turno">üóëÔ∏è</button>
      </div>
    `;
  });
  
  loadCategoriesSelect();
}

function saveShiftSettings(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  const propagate = document.getElementById('propagateShiftEdits').checked;
  const oldConfig = JSON.parse(JSON.stringify(SHIFTS));
  
  Object.keys(SHIFTS).forEach(id => {
    const safeId = cssSafe(id);
    const label = document.getElementById(`set-label-${safeId}`)?.value?.trim() || id;
    const cat = document.getElementById(`set-cat-${safeId}`)?.value || SHIFTS[id].cat;
    const color = document.getElementById(`set-color-${safeId}`)?.value || SHIFTS[id].color;
    const inTime = document.getElementById(`set-in-${safeId}`)?.value || SHIFTS[id].in || '00:00';
    const outTime = document.getElementById(`set-out-${safeId}`)?.value || SHIFTS[id].out || '00:00';
    
    SHIFTS[id].label = label;
    SHIFTS[id].cat = cat;
    SHIFTS[id].color = color;
    SHIFTS[id].in = inTime;
    SHIFTS[id].out = outTime;
  });
  
  if(propagate){
    const y = current.getFullYear();
    const m1 = current.getMonth() + 1;
    
    Object.keys(user.data).forEach(k => {
      if(!k.startsWith(`${y}-${m1}-`)) return;
      const d = user.data[k];
      
      if(d.mode === 'simple'){
        const sid = d.s;
        if(!sid || !SHIFTS[sid]) return;
        const was = oldConfig[sid];
        const now = SHIFTS[sid];
        
        if(was && (was.in !== now.in || was.out !== now.out)){
          d.tIn = now.in;
          d.tOut = now.out;
          d.h = calculateHours(now.in, now.out);
          
          const wasNote = String(d.n || '').trim();
          const oldStd = (was.in && was.out && !(was.in === '00:00' && was.out === '00:00')) ? 
            `${was.in}-${was.out}` : (was.label || sid).toUpperCase();
          const newStd = (now.in && now.out && !(now.in === '00:00' && now.out === '00:00')) ? 
            `${now.in}-${now.out}` : (now.label || sid).toUpperCase();
          
          if(!wasNote || wasNote === oldStd) d.n = newStd;
        }
      } else if(d.mode === 'mixto'){
        const applyPart = (partKey, inField, outField, hrsField, noteField) => {
          const sid = d[partKey];
          if(!sid || !SHIFTS[sid]) return;
          const was = oldConfig[sid];
          const now = SHIFTS[sid];
          
          if(was && (was.in !== now.in || was.out !== now.out)){
            d[inField] = now.in;
            d[outField] = now.out;
            d[hrsField] = calculateHours(now.in, now.out);
            
            const oldStd = (was.in && was.out && !(was.in === '00:00' && was.out === '00:00')) ? 
              `${was.in}-${was.out}` : (was.label || sid).toUpperCase();
            const newStd = (now.in && now.out && !(now.in === '00:00' && now.out === '00:00')) ? 
              `${now.in}-${now.out}` : (now.label || sid).toUpperCase();
            
            if(!d[noteField] || d[noteField] === oldStd) d[noteField] = newStd;
          }
        };
        
        applyPart('t', 'tInTop', 'tOutTop', 'hrsTop', 'noteTop');
        applyPart('b', 'tInBottom', 'tOutBottom', 'hrsBottom', 'noteBottom');
        
        d.h = (parseFloat(d.hrsTop) || 0) + (parseFloat(d.hrsBottom) || 0);
        d.n = `${d.noteTop || ''} | ${d.noteBottom || ''}`.trim();
      }
    });
  }
  
  saveDB();
  render();
  renderSummaryCategories();
  calcSummary();
  alert("Turnos actualizados.");
}

function deleteShift(id){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  // No permitir eliminar turnos base importantes
  const protectedShifts = ['L','Vacaciones','Ausencia','Cumplea√±os'];
  if(protectedShifts.includes(id)) return alert("No se puede eliminar este turno base.");
  
  const user = db.users[db.current];
  if (!user) return;
  
  // Verificar si el turno est√° en uso
  const used = Object.values(user.data).some(d => {
    if(d.mode === 'mixto') return d.t === id || d.b === id;
    return d.s === id;
  });
  
  if(used) return alert("No se puede eliminar: el turno est√° usado en el calendario del perfil.");
  
  if(!confirm(`¬øEliminar turno "${id}"?`)) return;
  
  delete user.config[id];
  saveDB();
  renderSettings();
  render();
  renderSummaryCategories();
  calcSummary();
}

// =========================================================
// New Shift Functions
// =========================================================
function selectColor(color, ev){
  selectedColor = color;
  document.getElementById('newShiftColor').value = color;
  document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
  if(ev && ev.target) ev.target.classList.add('selected');
}

function loadCategoriesSelect(){
  const select = document.getElementById('newShiftCat');
  if (!select) return;
  
  select.innerHTML = Object.keys(db.categories).map(cid => {
    const c = db.categories[cid];
    return `<option value="${cid}">${escapeHTML(c.icon)} ${escapeHTML(c.name)}</option>`;
  }).join('');
}

function addNewShift(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const name = document.getElementById('newShiftName').value.trim();
  const color = document.getElementById('newShiftColor').value;
  const cat = document.getElementById('newShiftCat').value;
  const inTime = document.getElementById('newShiftIn').value || '00:00';
  const outTime = document.getElementById('newShiftOut').value || '00:00';
  
  if(!name) return alert("Nombre requerido.");
  
  const key = name.replace(/\s+/g, '_').toUpperCase();
  const user = db.users[db.current];
  if (!user) return;
  
  if(user.config[key]) return alert("Ya existe un turno con ese nombre (ID).");
  
  user.config[key] = {
    label: name,
    color: color,
    cat: cat,
    in: inTime,
    out: outTime
  };
  
  saveDB();
  renderSettings();
  render();
  
  // Limpiar formulario
  document.getElementById('newShiftName').value = '';
  document.getElementById('newShiftIn').value = '';
  document.getElementById('newShiftOut').value = '';
  
  alert("Turno agregado.");
}

// =========================================================
// Categories Functions
// =========================================================
function renderCategories(){
  const container = document.getElementById('categories-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  const ids = Object.keys(db.categories).sort((a, b) => 
    db.categories[a].name.localeCompare(db.categories[b].name)
  );
  
  ids.forEach(cid => {
    const c = db.categories[cid];
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg" style="background: ${c.color || '#3b82f6'}20; color: ${c.color || '#3b82f6'};">
          ${escapeHTML(c.icon)}
        </div>
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="cat-name-${cid}" value="${escapeHTML(c.name)}" class="w-full bg-white border-blue-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Icono</div>
            <input id="cat-icon-${cid}" value="${escapeHTML(c.icon)}" class="w-full bg-white border-blue-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Color</div>
            <input type="color" id="cat-color-${cid}" value="${c.color || '#3b82f6'}" class="w-full h-10 bg-white border-blue-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-2 text-[10px] font-bold text-gray-500">
            ID: <span class="font-black text-gray-800">${cid}</span>
          </div>
        </div>
        <button onclick="deleteCategory('${cid}')" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>
      </div>
    `;
  });
}

function addNewCategory(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const name = document.getElementById('newCategoryName').value.trim();
  const icon = document.getElementById('newCategoryIcon').value;
  
  if(!name) return alert("Nombre requerido.");
  
  const cid = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
  if(db.categories[cid]) return alert("Ya existe una categor√≠a con ese ID.");
  
  db.categories[cid] = {
    name: name,
    icon: icon,
    color: '#6b7280'
  };
  
  saveDB();
  document.getElementById('newCategoryName').value = '';
  renderCategories();
  renderSummaryCategories();
  loadCategoriesSelect();
  alert("Categor√≠a agregada.");
}

function deleteCategory(cid){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  // Verificar si la categor√≠a est√° en uso
  const used = Object.values(db.users).some(u => 
    Object.values(u.config).some(s => s.cat === cid)
  );
  
  if(used) return alert("No se puede eliminar: hay turnos usando esta categor√≠a.");
  
  if(!confirm(`¬øEliminar categor√≠a "${db.categories[cid].name}"?`)) return;
  
  delete db.categories[cid];
  saveDB();
  renderCategories();
  renderSummaryCategories();
  loadCategoriesSelect();
  alert("Categor√≠a eliminada.");
}

function saveCategories(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  Object.keys(db.categories).forEach(cid => {
    const name = document.getElementById(`cat-name-${cid}`)?.value?.trim();
    const icon = document.getElementById(`cat-icon-${cid}`)?.value?.trim();
    const color = document.getElementById(`cat-color-${cid}`)?.value;
    
    if(name) db.categories[cid].name = name;
    if(icon) db.categories[cid].icon = icon;
    if(color) db.categories[cid].color = color;
  });
  
  saveDB();
  renderCategories();
  renderSummaryCategories();
  loadCategoriesSelect();
  renderSettings();
  render();
  alert("Categor√≠as actualizadas.");
}

// =========================================================
// Localities Functions
// =========================================================
function renderLocalities(){
  const container = document.getElementById('localities-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  // Asegurar que "General" existe y es √∫nico
  db.localities = Array.from(new Set(db.localities.map(x => String(x).trim()).filter(Boolean)));
  if(!db.localities.some(x => x.toUpperCase() === 'GENERAL')) {
    db.localities.unshift('General');
  }
  
  db.localities.forEach((loc, idx) => {
    const isGeneral = loc.trim().toUpperCase() === 'GENERAL';
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center font-black text-sky-700 flex-shrink-0">
          üìç
        </div>
        <div class="flex-1">
          <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
          <input id="loc-${idx}" value="${escapeHTML(loc)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${isGeneral ? 'disabled' : ''}/>
          <div class="text-[10px] font-bold text-gray-500 mt-1">${isGeneral ? 'Reservado para asuetos generales.' : ''}</div>
        </div>
        ${isGeneral ? 
          `<span class="text-[9px] font-black text-gray-400">Bloqueado</span>` : 
          `<button onclick="deleteLocality(${idx})" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>`
        }
      </div>
    `;
  });
  
  refreshHolidayLocationSelects();
  refreshProfileLocationSelects();
}

function addLocality(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const name = document.getElementById('newLocalityName').value.trim();
  if(!name) return alert("Nombre requerido.");
  if(name.toUpperCase() === 'GENERAL') return alert('"General" es reservado.');
  
  if(db.localities.some(x => x.trim().toUpperCase() === name.trim().toUpperCase())) {
    return alert("Ya existe esa localidad.");
  }
  
  db.localities.push(name);
  document.getElementById('newLocalityName').value = '';
  saveDB();
  renderLocalities();
  alert("Localidad agregada.");
}

function deleteLocality(idx){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const loc = db.localities[idx];
  if(!loc || loc.toUpperCase() === 'GENERAL') return;
  
  // Verificar si la localidad est√° en uso
  const usedUser = Object.values(db.users).some(u => 
    (u.locality || '').trim().toUpperCase() === loc.trim().toUpperCase()
  );
  
  const usedHoliday = Object.values(db.holidays).some(h => 
    (h.location || '').trim().toUpperCase() === loc.trim().toUpperCase()
  );
  
  if(usedUser || usedHoliday) {
    return alert("No se puede eliminar: est√° en uso por perfiles o asuetos. Cambia primero esas referencias.");
  }
  
  if(!confirm(`¬øEliminar localidad "${loc}"?`)) return;
  
  db.localities.splice(idx, 1);
  saveDB();
  renderLocalities();
}

function saveLocalities(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const oldList = [...db.localities];
  const newList = [];
  
  for(let i = 0; i < oldList.length; i++){
    const oldLoc = oldList[i];
    const isGeneral = oldLoc.trim().toUpperCase() === 'GENERAL';
    if(isGeneral){
      newList.push('General');
      continue;
    }
    
    const v = document.getElementById(`loc-${i}`)?.value?.trim();
    if(!v) continue;
    if(v.toUpperCase() === 'GENERAL') continue;
    newList.push(v);
  }
  
  // Asegurar que "General" est√° primero
  if(!newList.some(x => x.toUpperCase() === 'GENERAL')) {
    newList.unshift('General');
  }
  
  // Encontrar cambios de nombre
  const renamePairs = [];
  for(let i = 0; i < oldList.length; i++){
    const a = String(oldList[i] || '').trim();
    const b = (document.getElementById(`loc-${i}`)?.value || a).trim();
    if(a && b && a.toUpperCase() !== 'GENERAL' && a.toUpperCase() !== b.toUpperCase()){
      renamePairs.push([a, b]);
    }
  }
  
  db.localities = Array.from(new Set(newList.map(x => String(x).trim()).filter(Boolean)));
  
  // Aplicar cambios de nombre
  renamePairs.forEach(([from, to]) => {
    // Actualizar usuarios
    Object.values(db.users).forEach(u => {
      if((u.locality || '').trim().toUpperCase() === from.trim().toUpperCase()) {
        u.locality = to;
      }
    });
    
    // Actualizar asuetos
    Object.keys(db.holidays).forEach(k => {
      const h = db.holidays[k];
      if((h.location || '').trim().toUpperCase() === from.trim().toUpperCase()) {
        h.location = to;
      }
    });
  });
  
  saveDB();
  renderLocalities();
  renderHolidays();
  renderProfilesList();
  render();
  alert("Localidades actualizadas.");
}

function refreshHolidayLocationSelects(){
  const select = document.getElementById('newHolidayLocation');
  if (select) {
    select.innerHTML = db.localities.map(l => 
      `<option value="${escapeHTML(l)}" ${l.toUpperCase() === 'GENERAL' ? 'selected' : ''}>${escapeHTML(l)}</option>`
    ).join('');
  }
}

function refreshProfileLocationSelects(){
  const createLoc = document.getElementById('createLoc');
  if (createLoc) {
    createLoc.innerHTML = db.localities
      .filter(l => l.toUpperCase() !== 'GENERAL')
      .map(l => `<option value="${escapeHTML(l)}" ${l === 'San Salvador' ? 'selected' : ''}>${escapeHTML(l)}</option>`)
      .join('');
  }
}

// =========================================================
// Holidays Functions
// =========================================================
function renderHolidays(){
  const container = document.getElementById('holidays-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  const keys = Object.keys(db.holidays).sort((a, b) => new Date(a) - new Date(b));
  
  if(keys.length === 0){
    container.innerHTML = `
      <div class="p-8 text-center text-gray-400 font-bold">
        No hay asuetos configurados.
      </div>
    `;
    return;
  }
  
  keys.forEach(k => {
    const h = db.holidays[k];
    const [y, m, d] = k.split('-');
    
    container.innerHTML += `
      <div class="p-4 border-b border-gray-100">
        <div class="flex items-center justify-between gap-2">
          <div class="font-black text-gray-900 text-[12px]">${escapeHTML(h.name || 'Asueto')}</div>
          <button onclick="deleteHoliday('${k}')" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Fecha</div>
            <input id="h-date-${cssSafe(k)}" type="date" value="${toISODate(y, m, d)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="h-name-${cssSafe(k)}" value="${escapeHTML(h.name || '')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="h-loc-${cssSafe(k)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl">
              ${db.localities.map(l => 
                `<option value="${escapeHTML(l)}" ${(h.location || 'General') === l ? 'selected' : ''}>${escapeHTML(l)}</option>`
              ).join('')}
            </select>
          </div>
        </div>
      </div>
    `;
  });
}

function addNewHoliday(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const dateInput = document.getElementById('newHolidayDate').value;
  const name = document.getElementById('newHolidayName').value.trim();
  const loc = document.getElementById('newHolidayLocation').value || 'General';
  
  if(!dateInput || !name) return alert("Fecha y nombre requeridos.");
  
  const dt = new Date(dateInput + 'T00:00:00');
  const key = dayKey(dt.getFullYear(), dt.getMonth() + 1, dt.getDate());
  
  db.holidays[key] = {
    name: name,
    location: loc
  };
  
  document.getElementById('newHolidayDate').value = '';
  document.getElementById('newHolidayName').value = '';
  saveDB();
  renderHolidays();
  render();
  alert("Asueto agregado.");
}

function deleteHoliday(k){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  if(!confirm(`¬øEliminar asueto del ${k}?`)) return;
  
  delete db.holidays[k];
  saveDB();
  renderHolidays();
  render();
  alert("Asueto eliminado.");
}

function saveHolidays(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const newHolidays = {};
  const keys = Object.keys(db.holidays);
  
  keys.forEach(oldKey => {
    const safeKey = cssSafe(oldKey);
    const dateVal = document.getElementById(`h-date-${safeKey}`)?.value;
    const nameVal = document.getElementById(`h-name-${safeKey}`)?.value?.trim();
    const locVal = document.getElementById(`h-loc-${safeKey}`)?.value || 'General';
    
    if(!dateVal || !nameVal) return;
    
    const dt = new Date(dateVal + 'T00:00:00');
    const newKey = dayKey(dt.getFullYear(), dt.getMonth() + 1, dt.getDate());
    
    newHolidays[newKey] = {
      name: nameVal,
      location: locVal
    };
  });
  
  db.holidays = newHolidays;
  saveDB();
  renderHolidays();
  render();
  alert("Asuetos actualizados.");
}

// =========================================================
// PIN Functions
// =========================================================
function savePinOnly(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const user = db.users[db.current];
  if (!user) return;
  
  const p = document.getElementById('changePinInput').value;
  const c = document.getElementById('confirmPinInput').value;
  
  if(!p || p.length !== 4 || isNaN(p)) return alert("PIN inv√°lido (debe ser 4 d√≠gitos).");
  if(p !== c) return alert("PIN no coincide.");
  
  user.pin = p;
  document.getElementById('changePinInput').value = '';
  document.getElementById('confirmPinInput').value = '';
  saveDB();
  alert("PIN actualizado.");
}

// =========================================================
// Profiles Modal Functions - CORREGIDO: Nombres visibles
// =========================================================
function openProfilesModal(){
  refreshProfileLocationSelects();
  renderProfilesList();
  
  const modal = document.getElementById('profilesModal');
  if (modal) modal.classList.add('active');
}

function closeProfilesModal(){
  const modal = document.getElementById('profilesModal');
  if (modal) modal.classList.remove('active');
}

function createProfile(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const name = document.getElementById('createName').value.trim().toUpperCase();
  const pin = document.getElementById('createPin').value.trim();
  const loc = document.getElementById('createLoc').value || 'San Salvador';
  
  if(!name || name.length < 2) return alert("Nombre inv√°lido.");
  if(!pin || pin.length !== 4 || isNaN(pin)) return alert("PIN inv√°lido (debe ser 4 d√≠gitos).");
  if(db.users[name]) return alert("Ya existe ese perfil.");
  
  db.users[name] = {
    pin: pin,
    editLocked: false,
    locality: loc,
    data: {},
    config: JSON.parse(JSON.stringify(db.users.ADMIN.config))
  };
  
  ensureImportBaseShiftsForUser(name);
  
  db.current = name;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  
  document.getElementById('createName').value = '';
  document.getElementById('createPin').value = '';
  
  alert("Perfil creado.");
}

function renderProfilesList(){
  const container = document.getElementById('profilesList');
  if (!container) return;
  
  container.innerHTML = '';
  
  const keys = Object.keys(db.users).sort();
  
  // Asegurar que todos los perfiles tienen nombres visibles
  keys.forEach(u => {
    const user = db.users[u];
    const isCurrent = (u === db.current);
    
    // FIX: Hacer que el nombre sea siempre visible
    container.innerHTML += `
      <div class="border border-gray-200 rounded-2xl p-3 ${isCurrent ? 'bg-blue-50 border-blue-200' : 'bg-white'}" style="display: block !important;">
        <div class="flex items-center justify-between gap-2 mb-2">
          <div class="flex-1 min-w-0">
            <div class="font-black text-gray-900 text-[12px] truncate" style="display: block !important; visibility: visible !important;">
              ${escapeHTML(u)} ${isCurrent ? '<span class="ml-2 text-[9px] font-black text-blue-600">(Actual)</span>' : ''}
            </div>
            <div class="text-[10px] font-bold text-gray-500 truncate">
              Localidad: <span class="font-black text-gray-800">${escapeHTML(user.locality || 'San Salvador')}</span>
            </div>
          </div>
          <div class="flex gap-2 flex-shrink-0">
            <button onclick="setCurrentProfile('${u}')" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase whitespace-nowrap">
              Usar
            </button>
            ${u === 'ADMIN' ? '' : `
              <button onclick="deleteProfile('${u}')" class="px-3 py-2 rounded-xl bg-red-100 hover:bg-red-200 text-red-700 text-[10px] font-black uppercase whitespace-nowrap">
                Eliminar
              </button>
            `}
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Renombrar perfil</div>
            <input id="p-name-${cssSafe(u)}" value="${escapeHTML(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" ${u === 'ADMIN' ? 'disabled' : ''} style="display: block !important;"/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">PIN</div>
            <input id="p-pin-${cssSafe(u)}" value="${escapeHTML(user.pin || '0000')}" maxlength="4" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" style="display: block !important;"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="p-loc-${cssSafe(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl" style="display: block !important;">
              ${db.localities
                .filter(l => l.toUpperCase() !== 'GENERAL')
                .map(l => `<option value="${escapeHTML(l)}" ${(user.locality || 'San Salvador') === l ? 'selected' : ''}>${escapeHTML(l)}</option>`)
                .join('')}
            </select>
          </div>
          <div class="md:col-span-3">
            <button onclick="saveProfileEdits('${u}')" class="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[11px] whitespace-nowrap" style="display: block !important;">
              üíæ Guardar cambios
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  // FIX: Forzar que los elementos sean visibles
  setTimeout(() => {
    container.querySelectorAll('div, input, select, button').forEach(el => {
      el.style.display = 'block';
      el.style.visibility = 'visible';
      el.style.opacity = '1';
    });
  }, 10);
}

function setCurrentProfile(u){
  db.current = u;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  closeProfilesModal();
}

function deleteProfile(u){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  if(u === 'ADMIN') return alert("No se puede eliminar el perfil ADMIN.");
  
  if(!confirm(`¬øEliminar perfil "${u}"? Se perder√° su calendario.`)) return;
  
  delete db.users[u];
  if(db.current === u) db.current = 'ADMIN';
  
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  alert("Perfil eliminado.");
}

function saveProfileEdits(u){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const user = db.users[u];
  if (!user) return;
  
  const pin = document.getElementById(`p-pin-${cssSafe(u)}`)?.value?.trim();
  const loc = document.getElementById(`p-loc-${cssSafe(u)}`)?.value || 'San Salvador';
  
  if(!pin || pin.length !== 4 || isNaN(pin)) return alert("PIN inv√°lido (4 d√≠gitos).");
  
  user.pin = pin;
  user.locality = loc;
  
  if(u !== 'ADMIN'){
    const newName = document.getElementById(`p-name-${cssSafe(u)}`)?.value?.trim()?.toUpperCase();
    if(newName && newName !== u){
      if(db.users[newName]) return alert("No se puede renombrar: ya existe ese nombre.");
      
      db.users[newName] = user;
      delete db.users[u];
      
      if(db.current === u) db.current = newName;
    }
  }
  
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  renderProfilesList();
  render();
  alert("Perfil actualizado.");
}

// =========================================================
// Import Functions
// =========================================================
function openImportModal(){
  document.getElementById('importFile').value = '';
  document.getElementById('importInfo').innerText = '';
  document.getElementById('importUsersList').innerHTML = `
    <div class="text-gray-400 font-bold">Adjunta un Excel y presiona "Analizar".</div>
  `;
  
  importContext = null;
  
  const importMonth = document.getElementById('importMonth');
  const importYear = document.getElementById('importYear');
  if (importMonth) importMonth.value = current.getMonth();
  if (importYear) importYear.value = current.getFullYear();
  
  const modal = document.getElementById('importModal');
  if (modal) modal.classList.add('active');
}

function closeImportModal(){
  const modal = document.getElementById('importModal');
  if (modal) modal.classList.remove('active');
}

function closeImportModalAndRefresh(){
  closeImportModal();
  render();
  renderSummaryCategories();
  calcSummary();
}

function selectAllImportUsers(flag){
  document.querySelectorAll('.impUserChk').forEach(ch => {
    ch.checked = flag;
  });
}

async function analyzeImportFile(){
  const fileInput = document.getElementById('importFile');
  if(!fileInput.files || !fileInput.files[0]) {
    return alert("Selecciona un archivo Excel.");
  }
  
  try {
    const data = await fileInput.files[0].arrayBuffer();
    const wb = XLSX.read(data, { type: 'array' });
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' });
    
    // Detectar mes y a√±o
    const detected = detectMonthYearFromRows(rows);
    const fallbackMonth = parseInt(document.getElementById('importMonth').value);
    const fallbackYear = parseInt(document.getElementById('importYear').value);
    const monthIndex0 = (detected.month ?? fallbackMonth);
    const year = (detected.year ?? fallbackYear);
    
    // Encontrar fila de encabezado
    const headerIdx = findHeaderRow(rows);
    if(headerIdx < 0) return alert("No se pudo detectar la estructura del Excel.");
    
    const headerRow = rows[headerIdx] || [];
    const dayCols = buildDayColumnMap(headerRow);
    
    // Encontrar columnas de nombre y n√∫mero de empleado
    let nameCol = -1, empCol = -1;
    for(let c = 0; c < headerRow.length; c++){
      const s = String(headerRow[c] || '').toUpperCase().trim();
      if(s.includes('PERSONAL') || s.includes('NOMBRE')) nameCol = c;
      if(s.includes('EMP') || s.includes('N√öMERO')) empCol = c;
    }
    
    if(nameCol < 0 || empCol < 0 || Object.keys(dayCols).length < 10) {
      return alert("Encabezado incompleto o formato no reconocido.");
    }
    
    // Extraer usuarios
    const usersSet = new Set();
    for(let r = headerIdx + 1; r < rows.length; r++){
      const row = rows[r] || [];
      if(!isLikelyDataRow(row, nameCol, empCol, dayCols)) continue;
      
      const name = safeNameCell(row[nameCol]).toUpperCase();
      if(name) usersSet.add(name);
    }
    
    importContext = {
      wb, sheetName, rows, headerIdx, nameCol, empCol, dayCols, monthIndex0, year,
      users: Array.from(usersSet).sort()
    };
    
    // Mostrar lista de usuarios
    const list = document.getElementById('importUsersList');
    if(importContext.users.length === 0){
      list.innerHTML = `<div class="text-gray-400 font-bold">No se detectaron usuarios.</div>`;
    } else {
      list.innerHTML = importContext.users.map(u => `
        <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
          <input class="impUserChk" type="checkbox" value="${escapeHTML(u)}" checked>
          <span class="font-black text-gray-800">${escapeHTML(u)}</span>
        </label>
      `).join('');
    }
    
    document.getElementById('importInfo').innerText = 
      `Detectado: ${MONTHS[monthIndex0]} ${year}. Usuarios: ${importContext.users.length}.`;
      
  } catch (error) {
    console.error('Error analizando archivo:', error);
    alert(`Error al analizar el archivo: ${error.message}`);
  }
}

function detectMonthYearFromRows(rows){
  const monthsMap = {
    'ENERO':0,'FEBRERO':1,'MARZO':2,'ABRIL':3,'MAYO':4,'JUNIO':5,
    'JULIO':6,'AGOSTO':7,'SEPTIEMBRE':8,'OCTUBRE':9,'NOVIEMBRE':10,'DICIEMBRE':11
  };
  
  let foundMonth = null, foundYear = null;
  
  for(let r = 0; r < Math.min(rows.length, 50); r++){
    const row = rows[r] || [];
    for(let c = 0; c < row.length; c++){
      const v = row[c];
      if(!v) continue;
      
      const s = String(v).toUpperCase();
      
      // Buscar mes
      Object.keys(monthsMap).forEach(mn => {
        if(s.includes(mn) && foundMonth === null) foundMonth = monthsMap[mn];
      });
      
      // Buscar a√±o
      const yMatch = s.match(/A√ëO\s*([0-9]{4})/);
      if(yMatch) foundYear = parseInt(yMatch[1]);
      
      const yMatch2 = s.match(/(20\d{2})/);
      if(yMatch2 && !foundYear) foundYear = parseInt(yMatch2[1]);
    }
  }
  
  return { month: foundMonth, year: foundYear };
}

function findHeaderRow(rows){
  for(let r = 0; r < rows.length; r++){
    const row = rows[r] || [];
    const joined = row.map(x => String(x || '').trim()).join(' | ').toUpperCase();
    
    if(joined.includes('PERSONAL') && (joined.includes('NO. EMP') || joined.includes('NO EMP') || joined.includes('NO.EMP'))){
      if(row.some(v => String(v).trim() === '1') && row.some(v => String(v).trim() === '2')) {
        return r;
      }
    }
  }
  return -1;
}

function buildDayColumnMap(headerRow){
  const map = {};
  for(let c = 0; c < headerRow.length; c++){
    const s = String(headerRow[c] || '').trim();
    if(/^\d+$/.test(s)){
      const d = parseInt(s);
      if(d >= 1 && d <= 31) map[d] = c;
    }
  }
  return map;
}

function safeNameCell(v){
  return String(v || '').replace(/\s+/g, ' ').trim();
}

function isLikelyDataRow(row, nameCol, empCol, dayCols){
  const name = safeNameCell(row[nameCol]).toUpperCase();
  const emp = safeNameCell(row[empCol]);
  
  if(!name || !emp) return false;
  if(name.includes('TOTAL') || name.includes('PERSONAL')) return false;
  
  // Verificar si tiene alg√∫n c√≥digo en las columnas de d√≠a
  for(const d of Object.keys(dayCols)){
    const code = normalizeCode(row[dayCols[d]]);
    if(code && code !== 'X') return true;
  }
  
  return false;
}

function runImportSelected(){
  if(!importContext) return alert("Primero analiza el archivo.");
  
  const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'replace';
  const selected = Array.from(document.querySelectorAll('.impUserChk'))
    .filter(x => x.checked)
    .map(x => x.value);
  
  if(selected.length === 0) return alert("Selecciona al menos un usuario.");
  
  const { rows, headerIdx, nameCol, empCol, dayCols, monthIndex0, year } = importContext;
  
  // Asegurar que los usuarios existen
  selected.forEach(u => ensureUserExists(u));
  
  // Limpiar mes si es modo reemplazar
  if(importMode === 'replace'){
    selected.forEach(u => {
      const user = db.users[u];
      if (!user) return;
      
      const prefix = `${year}-${monthIndex0 + 1}-`;
      Object.keys(user.data).forEach(k => {
        if(k.startsWith(prefix)) delete user.data[k];
      });
    });
  }
  
  let written = 0;
  
  // Procesar filas
  for(let r = headerIdx + 1; r < rows.length; r++){
    const row = rows[r] || [];
    if(!isLikelyDataRow(row, nameCol, empCol, dayCols)) continue;
    
    const name = safeNameCell(row[nameCol]).toUpperCase();
    if(!selected.includes(name)) continue;
    
    const userKey = ensureUserExists(name);
    const user = db.users[userKey];
    if (!user) continue;
    
    ensureImportBaseShiftsForUser(userKey);
    
    // Procesar cada d√≠a
    for(const dStr of Object.keys(dayCols)){
      const day = parseInt(dStr);
      const code = normalizeCode(row[dayCols[dStr]]);
      if(!code || code === 'X') continue;
      
      const def = codeToShiftDef(code);
      if(!def) continue;
      
      const key = dayKey(year, monthIndex0 + 1, day);
      
      // Saltar si es modo merge y ya existe
      if(importMode === 'merge' && user.data[key]) continue;
      
      // Crear entrada
      const tIn = def.in || '00:00';
      const tOut = def.out || '00:00';
      const hrs = calculateHours(tIn, tOut);
      const note = def.note || ((tIn !== '00:00' || tOut !== '00:00') ? `${tIn}-${tOut}` : (def.label || def.key).toUpperCase());
      
      user.data[key] = {
        mode: 'simple',
        s: def.key,
        tIn: tIn,
        tOut: tOut,
        h: hrs,
        n: note
      };
      
      written++;
    }
  }
  
  saveDB();
  
  // Cambiar al primer usuario importado
  db.current = selected[0];
  current = new Date(year, monthIndex0, 1);
  saveDB();
  
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  render();
  renderSummaryCategories();
  calcSummary();
  
  document.getElementById('importInfo').innerHTML = `
    <div class="text-green-600 font-bold">
      Importaci√≥n completada!<br>
      Perfiles: ${selected.length} | Celdas: ${written}<br>
      Mes: ${MONTHS[monthIndex0]} ${year}<br>
      <button onclick="closeImportModalAndRefresh()" class="mt-2 px-4 py-2 bg-emerald-600 text-white rounded-xl font-black text-[10px]">
        ‚úÖ Cerrar y ver calendario
      </button>
    </div>
  `;
}

// =========================================================
// Export Functions - MEJORADAS para mostrar comentarios completos
// =========================================================
function showExportModal(){
  const exportMonth = document.getElementById('exportMonth');
  const exportYear = document.getElementById('exportYear');
  if (exportMonth) exportMonth.value = current.getMonth();
  if (exportYear) exportYear.value = current.getFullYear();
  
  buildExportUserList();
  document.getElementById('exportUsersBox').classList.add('hidden');
  
  // Configurar evento para mostrar/ocultar selector de usuarios
  document.querySelectorAll('input[name="exportScope"]').forEach(r => {
    r.onchange = () => {
      const v = document.querySelector('input[name="exportScope"]:checked')?.value;
      document.getElementById('exportUsersBox').classList.toggle('hidden', v !== 'select');
    };
  });
  
  const modal = document.getElementById('exportModal');
  if (modal) modal.classList.add('active');
}

function closeExportModal(){
  const modal = document.getElementById('exportModal');
  if (modal) modal.classList.remove('active');
}

function buildExportUserList(){
  const list = document.getElementById('exportUsersList');
  if (!list) return;
  
  const users = Object.keys(db.users).sort();
  list.innerHTML = users.map(u => `
    <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
      <input class="expUserChk" type="checkbox" value="${escapeHTML(u)}">
      <span class="font-black text-gray-800">${escapeHTML(u)}</span>
    </label>
  `).join('');
}

function selectAllExportUsers(flag){
  document.querySelectorAll('.expUserChk').forEach(ch => {
    ch.checked = flag;
  });
}

async function exportImages(){
  const monthIndex0 = parseInt(document.getElementById('exportMonth').value);
  const year = parseInt(document.getElementById('exportYear').value);
  const scope = document.querySelector('input[name="exportScope"]:checked')?.value || 'current';
  
  let targets = [];
  
  if(scope === 'current') targets = [db.current];
  else if(scope === 'all') targets = Object.keys(db.users).sort();
  else if(scope === 'select'){
    targets = Array.from(document.querySelectorAll('.expUserChk'))
      .filter(x => x.checked)
      .map(x => x.value);
    
    if(targets.length === 0) return alert("Selecciona al menos un perfil.");
  }
  
  closeExportModal();
  
  const originalCurrent = db.current;
  let exported = 0;
  
  for(const u of targets){
    try {
      db.current = u;
      updateUserInitial();
      
      const img = await buildExportImageForUser(u, year, monthIndex0);
      downloadDataUrl(img, `Turnos_${u}_${MONTHS[monthIndex0]}_${year}.png`);
      exported++;
      
      // Peque√±a pausa para evitar sobrecarga
      await new Promise(resolve => setTimeout(resolve, 100));
    } catch (error) {
      console.error(`Error exportando ${u}:`, error);
    }
  }
  
  // Restaurar usuario original
  db.current = originalCurrent;
  updateUserDropdown();
  updateUserInitial();
  render();
  
  if(exported > 0){
    alert(`Exportaci√≥n completada: ${exported} imagen(es) descargada(s).`);
  }
}

function downloadDataUrl(dataUrl, filename){
  const a = document.createElement('a');
  a.download = filename;
  a.href = dataUrl;
  a.click();
}

async function buildExportImageForUser(userKey, year, monthIndex0){
  const user = db.users[userKey];
  if (!user) throw new Error(`Usuario ${userKey} no encontrado`);
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Calcular estad√≠sticas
  const catHours = {};
  const catDays = {};
  Object.keys(categories).forEach(catId => {
    catHours[catId] = 0;
    catDays[catId] = 0;
  });
  
  let freeDays = 0, vacDays = 0, weekendDays = 0, holidayWorked = 0;
  const daysInMonth = new Date(year, monthIndex0 + 1, 0).getDate();
  freeDays = daysInMonth;
  
  const m1 = monthIndex0 + 1;
  const todayStr = new Date().toLocaleDateString('es-ES');
  
  Object.keys(user.data).forEach(k => {
    if(!k.startsWith(`${year}-${m1}-`)) return;
    
    const d = user.data[k];
    const dayNum = parseInt(k.split('-')[2]);
    const date = new Date(year, monthIndex0, dayNum);
    const dow = date.getDay();
    const isHoliday = db.holidays[k] && holidayApplies(db.holidays[k].location, user.locality);
    
    if(dow === 0 || dow === 6) weekendDays++;
    freeDays--;
    
    if(d.mode === 'mixto'){
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;
      
      if(isHoliday && (topCat || botCat)) holidayWorked++;
      
      if(topCat && categories[topCat]){
        catHours[topCat] += (d.hrsTop || 0);
        catDays[topCat]++;
      }
      
      if(botCat && categories[botCat]){
        catHours[botCat] += (d.hrsBottom || 0);
        catDays[botCat]++;
      }
    } else {
      const cat = SHIFTS[d.s]?.cat;
      if(cat && categories[cat]){
        catHours[cat] += (d.h || 0);
        catDays[cat]++;
        
        if(cat !== 'off'){
          if(isHoliday) holidayWorked++;
        } else {
          freeDays++;
          if(d.s === 'Vacaciones') vacDays++;
        }
      }
    }
  });
  
  freeDays = Math.max(0, freeDays);
  
  // Crear elemento temporal para html2canvas - M√ÅS ESPACIO para comentarios
  const temp = document.createElement('div');
  temp.style.position = 'fixed';
  temp.style.left = '-9999px';
  temp.style.top = '-9999px';
  temp.style.width = '1000px'; // Ancho aumentado
  temp.style.background = '#ffffff';
  temp.style.padding = '25px';
  temp.style.borderRadius = '12px';
  temp.style.boxShadow = '0 10px 30px rgba(0,0,0,0.1)';
  
  // Construir HTML de exportaci√≥n - CON M√ÅS ESPACIO PARA COMENTARIOS
  temp.innerHTML = buildExportHTML(userKey, user.locality, year, monthIndex0, todayStr, catHours, catDays, freeDays, vacDays, weekendDays, holidayWorked, SHIFTS, user, categories);
  
  document.body.appendChild(temp);
  
  try {
    const canvas = await html2canvas(temp, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      logging: false,
      allowTaint: true
    });
    
    const url = canvas.toDataURL('image/png', 1.0);
    document.body.removeChild(temp);
    return url;
  } catch (error) {
    document.body.removeChild(temp);
    throw error;
  }
}

function buildExportHTML(userKey, locality, year, monthIndex0, todayStr, catHours, catDays, freeDays, vacDays, weekendDays, holidayWorked, SHIFTS, user, categories){
  const monthName = MONTHS[monthIndex0];
  
  // Calcular total de horas
  const totalHours = Object.values(catHours).reduce((a, b) => a + b, 0);
  
  // Filtrar categor√≠as con datos
  const categoriesWithData = Object.keys(categories).filter(catId => 
    catDays[catId] > 0 || catHours[catId] > 0
  );
  
  let categoriesHTML = '';
  if(categoriesWithData.length > 0) {
    categoriesHTML = `
      <div style="margin-bottom:20px;border:1px solid #e5e7eb;border-radius:12px;padding:15px;">
        <div style="font-size:14px;font-weight:900;color:#334155;margin-bottom:12px;text-align:center;">
          RESUMEN POR CATEGOR√çA
        </div>
        <div style="display:grid;grid-template-columns:repeat(${Math.min(categoriesWithData.length, 4)},1fr);gap:15px;">
          ${categoriesWithData.map(catId => {
            const cat = categories[catId];
            return `
              <div style="text-align:center;padding:10px;border:1px solid #f1f5f9;border-radius:10px;background:#f8fafc;">
                <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">
                  ${escapeHTML(cat.icon)} ${escapeHTML(cat.name)}
                </div>
                <div style="font-size:18px;font-weight:900;color:#0f172a;margin-bottom:4px;">
                  ${catHours[catId].toFixed(1)} HRS
                </div>
                <div style="font-size:10px;color:#64748b;font-weight:800;">
                  ${catDays[catId]} d√≠a${catDays[catId] !== 1 ? 's' : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }
  
  // Construir calendario para exportaci√≥n - CON CELDAS M√ÅS ALTAS
  let calendarHTML = '';
  const firstDay = new Date(year, monthIndex0, 1).getDay();
  const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
  const lastDate = new Date(year, monthIndex0 + 1, 0).getDate();
  
  // D√≠as del mes anterior
  for(let i = 0; i < firstDayMonday; i++){
    calendarHTML += `<div style="height:100px;background:#f9fafb;opacity:0.3;"></div>`;
  }
  
  // D√≠as del mes actual
  for(let d = 1; d <= lastDate; d++){
    const key = dayKey(year, monthIndex0 + 1, d);
    const info = user.data[key] || {mode: 'simple', s: 'L'};
    const holiday = db.holidays[key];
    const isHoliday = holiday && holidayApplies(holiday.location, user.locality);
    
    let dayHTML = '';
    if(info.mode === 'mixto'){
      const topShift = SHIFTS[info.t] || {color: 'L', label: 'L'};
      const bottomShift = SHIFTS[info.b] || {color: 'L', label: 'L'};
      
      dayHTML = `
        <div style="height:100px;position:relative;border:1px solid #e5e7eb;">
          <div style="height:50%;background:${getColorValue(topShift.color)};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;border-bottom:1px solid rgba(0,0,0,0.1);">
            ${escapeHTML(topShift.label)}
          </div>
          <div style="height:50%;background:${getColorValue(bottomShift.color)};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;">
            ${escapeHTML(bottomShift.label)}
          </div>
          <div style="position:absolute;top:2px;right:2px;font-size:10px;font-weight:900;background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:4px;">
            ${d}
          </div>
          ${isHoliday ? `<div style="position:absolute;top:2px;left:2px;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,0.9);padding:1px 4px;border-radius:4px;">A</div>` : ''}
          ${info.noteTop ? `<div style="position:absolute;top:25%;left:50%;transform:translateX(-50%);font-size:8px;font-weight:900;background:rgba(255,255,255,0.95);padding:2px 5px;border-radius:3px;white-space:nowrap;max-width:90%;overflow:visible;">
            ${escapeHTML(info.noteTop)}
          </div>` : ''}
          ${info.noteBottom ? `<div style="position:absolute;bottom:10%;left:50%;transform:translateX(-50%);font-size:8px;font-weight:900;background:rgba(255,255,255,0.95);padding:2px 5px;border-radius:3px;white-space:nowrap;max-width:90%;overflow:visible;">
            ${escapeHTML(info.noteBottom)}
          </div>` : ''}
        </div>
      `;
    } else {
      const shift = SHIFTS[info.s] || {color: 'L', label: 'L'};
      dayHTML = `
        <div style="height:100px;background:${getColorValue(shift.color)};position:relative;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;border:1px solid #e5e7eb;">
          ${escapeHTML(shift.label)}
          <div style="position:absolute;top:2px;right:2px;font-size:10px;font-weight:900;background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:4px;">
            ${d}
          </div>
          ${isHoliday ? `<div style="position:absolute;top:2px;left:2px;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,0.9);padding:1px 4px;border-radius:4px;">A</div>` : ''}
          ${info.n ? `<div style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:900;background:rgba(255,255,255,0.95);padding:3px 6px;border-radius:4px;white-space:nowrap;max-width:90%;overflow:visible;border:1px solid rgba(0,0,0,0.1);">
            ${escapeHTML(info.n)}
          </div>` : ''}
        </div>
      `;
    }
    
    calendarHTML += dayHTML;
  }
  
  // Turnos usados en el mes
  const usedShifts = Object.keys(SHIFTS)
    .filter(k => {
      const prefix = `${year}-${monthIndex0 + 1}-`;
      return Object.keys(user.data).some(key => 
        key.startsWith(prefix) && 
        (user.data[key].s === k || user.data[key].t === k || user.data[key].b === k)
      );
    });
  
  let legendHTML = '';
  if(usedShifts.length > 0){
    legendHTML = `
      <div style="margin-top:20px;border-top:2px solid #e5e7eb;padding-top:15px;">
        <div style="font-size:12px;font-weight:900;color:#334155;margin-bottom:10px;">LEYENDA DE TURNOS</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
          ${usedShifts.slice(0, 15).map(k => {
            const sh = SHIFTS[k];
            const schedule = (sh.in && sh.out && !(sh.in === '00:00' && sh.out === '00:00')) ? 
              `${sh.in}-${sh.out}` : 'Sin horario';
            return `
              <div style="display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #f1f5f9;border-radius:8px;">
                <div style="width:15px;height:15px;border-radius:4px;background:${getColorValue(sh.color)};border:1px solid #d1d5db;"></div>
                <div style="flex:1;">
                  <div style="font-size:10px;font-weight:900;color:#334155;">${escapeHTML(sh.label || k)}</div>
                  <div style="font-size:9px;color:#64748b;">${schedule}</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }
  
  return `
    <div style="font-family:system-ui,-apple-system,sans-serif;color:#0f172a;">
      <!-- Encabezado -->
      <div style="text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e5e7eb;">
        <div style="font-size:32px;font-weight:900;color:#0f172a;margin-bottom:5px;">
          ${escapeHTML(userKey)} - ${monthName} ${year}
        </div>
        <div style="font-size:13px;color:#64748b;font-weight:800;margin-bottom:8px;">
          Localidad: ${escapeHTML(locality || 'San Salvador')} ‚Ä¢ Generado: ${todayStr}
        </div>
        <div style="font-size:11px;color:#3b82f6;font-weight:900;background:#f0f9ff;padding:8px 15px;border-radius:20px;display:inline-block;">
          Total horas: ${totalHours.toFixed(1)} HRS
        </div>
      </div>
      
      <!-- Calendario (M√ÅS ESPACIO) -->
      <div style="margin-bottom:25px;">
        <div style="font-size:16px;font-weight:900;color:#334155;margin-bottom:12px;text-align:center;">
          CALENDARIO - ${monthName} ${year}
        </div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e5e7eb;border:1px solid #e5e7eb;">
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#3b82f6;">LUN</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#64748b;">MAR</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#64748b;">MI√â</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#64748b;">JUE</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#64748b;">VIE</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#3b82f6;">S√ÅB</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#ef4444;">DOM</div>
          ${calendarHTML}
        </div>
      </div>
      
      <!-- Estad√≠sticas -->
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
        <div style="background:#f0f9ff;padding:15px;border-radius:12px;border:1px solid #bae6fd;">
          <div style="font-size:12px;font-weight:900;color:#0369a1;margin-bottom:10px;">üìä ESTAD√çSTICAS</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">D√≠as trabajados</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${(lastDate - freeDays - vacDays - weekendDays)}</div>
            </div>
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">D√≠as libres</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${freeDays}</div>
            </div>
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">Vacaciones</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${vacDays}</div>
            </div>
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">Fines de semana</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${weekendDays}</div>
            </div>
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">Asuetos trabajados</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${holidayWorked}</div>
            </div>
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">Total d√≠as mes</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${lastDate}</div>
            </div>
          </div>
        </div>
        
        <div style="background:#f0f9ff;padding:15px;border-radius:12px;border:1px solid #bae6fd;">
          <div style="font-size:12px;font-weight:900;color:#0369a1;margin-bottom:10px;">üìà RESUMEN</div>
          <div style="font-size:11px;color:#64748b;font-weight:800;margin-bottom:8px;">
            Total horas trabajadas: <span style="font-weight:900;color:#0f172a;font-size:14px;">${totalHours.toFixed(1)} HRS</span>
          </div>
          <div style="font-size:11px;color:#64748b;font-weight:800;margin-bottom:8px;">
            Promedio diario: <span style="font-weight:900;color:#0f172a;font-size:14px;">${(lastDate - freeDays - vacDays - weekendDays) > 0 ? (totalHours / (lastDate - freeDays - vacDays - weekendDays)).toFixed(1) : '0.0'} HRS/d√≠a</span>
          </div>
          <div style="font-size:11px;color:#64748b;font-weight:800;">
            Localidad perfil: <span style="font-weight:900;color:#0f172a;font-size:14px;">${escapeHTML(locality || 'San Salvador')}</span>
          </div>
        </div>
      </div>
      
      <!-- Categor√≠as (SOLO SI HAY DATOS) -->
      ${categoriesHTML}
      
      <!-- Leyenda (SOLO SI HAY TURNOS USADOS) -->
      ${legendHTML}
      
      <!-- Pie de p√°gina -->
      <div style="margin-top:25px;border-top:1px solid #e5e7eb;padding-top:15px;text-align:center;">
        <div style="font-size:10px;color:#94a3b8;font-weight:800;">
          Generado con Shifter Pro v23 ‚Ä¢ ${escapeHTML(userKey)} ‚Ä¢ ${monthName} ${year}
        </div>
      </div>
    </div>
  `;
}

// =========================================================
// Initialize App
// =========================================================
document.addEventListener('DOMContentLoaded', () => {
  init();
  
  // Configurar eventos de export scope
  document.addEventListener('change', (e) => {
    if(e.target && e.target.name === 'exportScope') {
      const v = document.querySelector('input[name="exportScope"]:checked')?.value;
      const exportUsersBox = document.getElementById('exportUsersBox');
      if (exportUsersBox) {
        exportUsersBox.classList.toggle('hidden', v !== 'select');
      }
    }
  });
});
</script>

</body>
</html>

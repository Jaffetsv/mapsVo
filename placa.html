<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Shifter Pro v23 - Calendario de Turnos</title>
  
  <!-- CDNs con fallback -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Fallback si tailwind no carga
    if (typeof tailwind === 'undefined') {
      console.log('Tailwind CDN no carg√≥, usando estilos inline');
      document.write('<style>' + 
        'body { font-family: system-ui, -apple-system, sans-serif; }' +
        '.hidden { display: none !important; }' +
        '.grid { display: grid; }' +
        '.flex { display: flex; }' +
        '.block { display: block !important; }' +
        '</style>');
    }
  </script>
  
  <!-- Scripts con atributos async/defer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  
  <style>
    /* Estilos cr√≠ticos inline para evitar problemas de carga */
    :root {
      --blue-600: #2563eb;
      --gray-100: #f3f4f6;
      --white: #ffffff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; /* Mejora interactividad t√°ctil */
    }
    
    body {
      background: var(--gray-100);
      color: #111827;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Grid del calendario */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border: 1px solid #e5e7eb;
      width: 100%;
    }
    
    /* Celdas de d√≠a */
    .day-cell {
      background: var(--white);
      min-height: 120px;
      position: relative;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.15s;
    }
    
    @media (max-width: 640px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5px;
      }
      
      .day-cell {
        min-height: 90px;
      }
    }
    
    .day-cell:active {
      transform: scale(0.98);
    }
    
    .day-number {
      font-size: 11px;
      font-weight: 900;
      padding: 2px 6px;
      position: absolute;
      top: 0;
      right: 0;
      z-index: 20;
      color: #374151;
      background: rgba(255, 255, 255, 0.9);
      border-bottom-left-radius: 8px;
    }
    
    .day-off-month {
      background: #f9fafb !important;
      opacity: 0.5;
    }
    
    .today {
      border: 2px solid var(--blue-600) !important;
    }
    
    .weekend {
      background: #f8fafc !important;
    }
    
    /* Colores de turnos - Nombres en espa√±ol */
    .bg-Ma√±ana { background: #ffff00 !important; }
    .bg-Tarde { background: #fbcfe8 !important; }
    .bg-CENA { background: #d8b4fe !important; }
    .bg-16hrs { background: #bef264 !important; }
    .bg-L { background: var(--white) !important; border: 1px solid #e5e7eb; }
    .bg-Vacaciones { background: #fed7aa !important; }
    .bg-Cumplea√±os { background: #f9a8d4 !important; }
    .bg-Ausencia { background: #d1d5db !important; }
    .bg-azul { background: #93c5fd !important; }
    .bg-rojo { background: #fca5a5 !important; }
    .bg-verde { background: #86efac !important; }
    .bg-naranja { background: #fdba74 !important; }
    .bg-rosa { background: #f9a8d4 !important; }
    .bg-cian { background: #67e8f9 !important; }
    .bg-morado { background: #d8b4fe !important; }
    .bg-lima { background: #d9f99d !important; }
    .bg-ambar { background: #fcd34d !important; }
    .bg-teal { background: #5eead4 !important; }
    .bg-indigo { background: #a5b4fc !important; }
    .bg-gris { background: #d1d5db !important; }
    
    /* Etiqueta de turno */
    .shift-label {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      text-align: center;
      line-height: 1.1;
      padding: 4px;
      color: rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }
    
    @media (max-width: 640px) {
      .shift-label {
        font-size: 9px;
        padding: 2px;
      }
    }
    
    /* Texto de nota - AUMENTADO para mejor visibilidad */
    .note-text {
      font-size: 10px;
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      padding: 2px 4px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    @media (max-width: 640px) {
      .note-text {
        font-size: 8px;
        bottom: 2px;
        width: 95%;
        padding: 1px 3px;
      }
    }
    
    /* Notas para mixto - MEJORADO */
    .mixto-top-note {
      font-size: 8px;
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      padding: 1px 3px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    .mixto-bottom-note {
      font-size: 8px;
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      padding: 1px 3px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    /* Indicador de asueto */
    .holiday-indicator {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 8px;
      font-weight: 900;
      color: #dc2626;
      background: rgba(254, 226, 226, 0.9);
      padding: 1px 4px;
      border-bottom-right-radius: 8px;
      z-index: 20;
    }
    
    /* Modales y vistas */
    .view-section {
      display: none;
    }
    
    .view-active {
      display: block !important;
    }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 15px;
      backdrop-filter: blur(4px);
    }
    
    .modal.active {
      display: flex;
    }
    
    /* Tabs - Mejorado para m√≥viles */
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 12px 8px;
      font-weight: 900;
      font-size: 11px;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
      background: var(--white);
      border: none;
      cursor: pointer;
      min-width: 0; /* Permite que se comprima en m√≥viles */
    }
    
    @media (max-width: 640px) {
      .tab-btn {
        padding: 10px 5px;
        font-size: 10px;
      }
    }
    
    .tab-active {
      border-bottom-color: var(--blue-600);
      color: var(--blue-600);
      background: #f8fafc;
    }
    
    /* Inputs y selects - Mejorados para m√≥viles */
    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      font-weight: 800;
      font-size: 16px; /* Aumentado para m√≥viles */
      outline: none;
      transition: 0.15s;
      width: 100%;
      -webkit-appearance: none; /* Elimina estilos nativos iOS */
      min-height: 48px; /* Tama√±o m√≠nimo t√°ctil */
    }
    
    @media (max-width: 640px) {
      select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea {
        font-size: 16px;
        padding: 14px;
        min-height: 52px;
      }
      
      input[type="time"] {
        /* Mejorar selector de hora en m√≥viles */
        font-size: 16px;
      }
    }
    
    select:focus, input:focus, textarea:focus {
      border-color: var(--blue-600);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }
    
    /* Botones - Mejorados para m√≥viles */
    button {
      min-height: 44px; /* Tama√±o m√≠nimo t√°ctil recomendado por Apple */
      min-width: 44px; /* Tama√±o m√≠nimo t√°ctil */
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 700;
    }
    
    @media (max-width: 640px) {
      button {
        padding: 14px 12px;
        font-size: 13px;
        min-height: 48px;
      }
    }
    
    /* Opciones de turno */
    .shift-option {
      transition: 0.15s;
      border-width: 2px;
      border-color: transparent;
      padding: 12px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      text-align: center;
      min-height: 60px; /* M√°s grande para t√°ctil */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    @media (max-width: 640px) {
      .shift-option {
        min-height: 50px;
        font-size: 9px;
        padding: 8px 4px;
      }
    }
    
    .shift-option.selected {
      border-color: var(--blue-600) !important;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.22);
      transform: translateY(-1px);
    }
    
    /* Config tabs - Mejorado para scroll t√°ctil */
    .config-tabs-container {
      display: flex;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      position: sticky;
      top: 124px; /* REDUCIDO de 144px a 124px */
      z-index: 30;
      scrollbar-width: none; /* Firefox */
    }
    
    .config-tabs-container::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
    }
    
    @media (max-width: 768px) {
      .config-tabs-container {
        top: 124px; /* REDUCIDO de 144px a 124px */
      }
    }
    
    .config-tab {
      flex: 0 0 auto;
      text-align: center;
      padding: 14px 16px;
      font-weight: 900;
      font-size: 11px;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
      color: #9ca3af;
      background: none;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      min-width: 100px;
      min-height: 48px;
    }
    
    @media (max-width: 640px) {
      .config-tab {
        padding: 12px 14px;
        font-size: 10px;
        min-width: 90px;
        min-height: 44px;
      }
    }
    
    .config-tab.active {
      border-bottom-color: var(--blue-600);
      color: var(--blue-600);
      background: #ffffff;
    }
    
    /* Color options - M√°s grandes para t√°ctil */
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: 0.15s;
    }
    
    @media (max-width: 640px) {
      .color-option {
        width: 36px;
        height: 36px;
      }
    }
    
    .color-option.selected {
      border-color: #000;
      transform: scale(1.08);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.18);
    }
    
    /* Utilitarios */
    .hidden {
      display: none !important;
    }
    
    .block {
      display: block !important;
    }
    
    .flex {
      display: flex !important;
    }
    
    .grid {
      display: grid !important;
    }
    
    /* Clases para colores de fondo Tailwind-ish */
    .bg-white { background: var(--white) !important; }
    .bg-gray-50 { background: #f9fafb !important; }
    .bg-gray-100 { background: #f3f4f6 !important; }
    .bg-blue-600 { background: var(--blue-600) !important; }
    .bg-emerald-600 { background: #059669 !important; }
    .bg-sky-600 { background: #0284c7 !important; }
    .text-white { color: var(--white) !important; }
    .text-gray-400 { color: #9ca3af !important; }
    .text-emerald-400 { color: #34d399 !important; }
    
    /* Responsive mejorado */
    @media (max-width: 768px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
      }
      
      .tab-btn {
        padding: 12px 6px;
        font-size: 11px;
      }
      
      .config-tab {
        padding: 12px 14px;
        font-size: 10px;
        min-width: 95px;
      }
      
      .config-tabs-container {
        top: 124px; /* REDUCIDO de 144px a 124px */
      }
    }
    
    @media (max-width: 640px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5px;
      }
      
      .day-cell {
        min-height: 85px;
      }
      
      .config-tab {
        padding: 10px 12px;
        font-size: 9px;
        min-width: 85px;
      }
    }
    
    @media (max-width: 380px) {
      .day-cell {
        min-height: 75px;
      }
      
      .shift-label {
        font-size: 8px;
      }
      
      .config-tab {
        min-width: 80px;
        padding: 10px 8px;
        font-size: 8px;
      }
    }
    
    /* Estilos espec√≠ficos para exportaci√≥n - SIN LEYENDA */
    .export-calendar-cell {
      background: #ffffff;
      min-height: 100px;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .export-note-text {
      font-size: 9px;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 85%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 4px;
      padding: 2px 4px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      overflow: visible;
      text-overflow: unset;
      z-index: 10;
      max-height: 20px;
    }
    
    /* Men√∫ hamburguesa para botones */
    .hamburger-menu {
      display: none;
    }
    
    @media (max-width: 768px) {
      .hamburger-menu {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.15);
        cursor: pointer;
        flex-shrink: 0;
      }
      
      .hamburger-menu span {
        display: block;
        width: 20px;
        height: 2px;
        background: white;
        position: relative;
        transition: all 0.3s;
      }
      
      .hamburger-menu span::before,
      .hamburger-menu span::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 2px;
        background: white;
        left: 0;
        transition: all 0.3s;
      }
      
      .hamburger-menu span::before {
        top: -6px;
      }
      
      .hamburger-menu span::after {
        top: 6px;
      }
      
      .hamburger-menu.active span {
        background: transparent;
      }
      
      .hamburger-menu.active span::before {
        transform: rotate(45deg);
        top: 0;
      }
      
      .hamburger-menu.active span::after {
        transform: rotate(-45deg);
        top: 0;
      }
      
      /* Panel de botones desplegable */
      .mobile-buttons-panel {
        position: fixed;
        top: 0;
        right: -300px;
        width: 280px;
        height: 100vh;
        background: #1e293b;
        z-index: 2000;
        transition: right 0.3s ease;
        padding: 80px 20px 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
      }
      
      .mobile-buttons-panel.active {
        right: 0;
      }
      
      .mobile-buttons-panel button {
        width: 100%;
        justify-content: flex-start;
        padding: 16px;
        border-radius: 12px;
        text-align: left;
        font-size: 14px;
        font-weight: 800;
      }
      
      .mobile-buttons-panel .panel-header {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .mobile-buttons-panel .panel-header h3 {
        color: white;
        font-size: 18px;
        font-weight: 900;
      }
      
      .mobile-buttons-panel .close-panel {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: white;
        font-size: 24px;
        cursor: pointer;
      }
      
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1999;
        backdrop-filter: blur(3px);
      }
      
      .overlay.active {
        display: block;
      }
      
      /* Ocultar botones normales en m√≥viles */
      .top-bar-buttons {
        display: none;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-buttons-panel,
      .hamburger-menu,
      .overlay {
        display: none !important;
      }
      
      .top-bar-buttons {
        display: flex;
      }
    }
    
    /* Mejorar scroll en m√≥viles */
    .scrollable-content {
      -webkit-overflow-scrolling: touch;
    }
    
    /* Prevenir zoom en inputs en iOS */
    @media (max-width: 640px) {
      input[type="text"],
      input[type="number"],
      input[type="time"],
      input[type="date"],
      select,
      textarea {
        font-size: 16px !important; /* Previene zoom en iOS */
      }
    }
  </style>
</head>

<body class="bg-gray-100">
<!-- Overlay para men√∫ m√≥vil -->
<div class="overlay" onclick="closeMobilePanel()"></div>

<!-- Panel de botones m√≥vil -->
<div class="mobile-buttons-panel" id="mobileButtonsPanel">
  <div class="panel-header">
    <h3>Acciones</h3>
    <div class="close-panel" onclick="closeMobilePanel()">√ó</div>
  </div>
  
  <button onclick="openProfilesModal(); closeMobilePanel()" class="bg-white/15 hover:bg-white/25 text-white">
    üë§ Perfiles
  </button>
  
  <button onclick="openImportModal(); closeMobilePanel()" class="bg-sky-600 hover:bg-sky-700 text-white">
    üì• Importar
  </button>
  
  <button onclick="showExportModal(); closeMobilePanel()" class="bg-white/15 hover:bg-white/25 text-white">
    üìã Exportar
  </button>
  
  <button id="mobileUnlockBtn" onclick="toggleEditMode(); closeMobilePanel()" class="bg-emerald-600 hover:bg-emerald-700 text-white">
    üîí Bloquear
  </button>
  
  <button onclick="showView('summary'); closeMobilePanel()" class="bg-white/10 hover:bg-white/20 text-white">
    üìä Resumen
  </button>
  
  <button onclick="showView('calendar'); closeMobilePanel()" class="bg-white/10 hover:bg-white/20 text-white">
    üìÖ Calendario
  </button>
  
  <button onclick="showView('settings'); closeMobilePanel()" class="bg-white/10 hover:bg-white/20 text-white">
    ‚öôÔ∏è Ajustes
  </button>
  
  <button onclick="goToday(); closeMobilePanel()" class="bg-white/20 hover:bg-white/30 text-white">
    üè† Hoy
  </button>
</div>

<!-- Top bar - COMPACTADO -->
<div class="bg-[#1e293b] text-white p-3 md:p-4 sticky top-0 z-50 shadow-lg">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-2 md:mb-3"> <!-- REDUCIDO mb-3 a mb-2 -->
    <div class="flex items-center gap-3 w-full md:w-auto">
      <div class="w-8 h-8 md:w-8 md:h-8 rounded-full bg-blue-500 flex items-center justify-center font-black text-sm flex-shrink-0">
        <span id="userInitial" class="text-sm">A</span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex flex-col md:flex-row md:items-center gap-2">
          <select id="userSelect" onchange="switchUser()" class="w-full md:w-auto bg-white/15 text-white border-white/25 rounded-xl px-3 py-2 text-[11px] font-bold"></select>
          <!-- Men√∫ hamburguesa para m√≥viles -->
          <div class="hamburger-menu" onclick="toggleMobilePanel()">
            <span></span>
          </div>
        </div>
        <p id="editStatus" class="text-[10px] font-black uppercase tracking-widest text-gray-400 mt-1">Modo Vista</p>
      </div>
    </div>
    
    <!-- Botones para desktop - ocultos en m√≥viles -->
    <div class="top-bar-buttons flex gap-2 w-full md:w-auto justify-end">
      <button onclick="openImportModal()" class="bg-sky-600 hover:bg-sky-700 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">üì• Importar</button>
      <button onclick="showExportModal()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">üìã Exportar</button>
      <button id="unlockBtn" onclick="toggleEditMode()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors whitespace-nowrap flex-1 md:flex-none">üîí Bloquear</button>
    </div>
  </div>

  <!-- Month/year - COMPACTADO -->
  <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-xl p-2 md:p-3 shadow-inner"> <!-- REDUCIDO rounded-2xl a rounded-xl, p-3 a p-2 -->
    <button onclick="changeMonth(-1)" class="p-2 md:p-2 hover:bg-white/10 rounded-full transition-colors flex-shrink-0"> <!-- REDUCIDO p-3 a p-2 -->
      <span class="text-xl md:text-xl font-bold">‚Äπ</span>
    </button>

    <div class="flex flex-col items-center flex-1 mx-2 md:mx-3">
      <div id="currentMonthDisplay" class="text-base md:text-lg font-black text-white text-center mb-1"> <!-- REDUCIDO text-lg a text-base -->
        Febrero 2026
      </div>
      <div class="flex gap-2 md:gap-2 items-center opacity-90">
        <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-xs md:text-sm font-bold text-white text-center appearance-none cursor-pointer w-20 md:w-24"></select> <!-- REDUCIDO w-24 a w-20 -->
        <span class="text-white font-bold">/</span>
        <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-xs md:text-sm font-bold text-white text-center appearance-none cursor-pointer w-16 md:w-20"></select> <!-- REDUCIDO w-20 a w-16 -->
      </div>
      <div class="flex gap-1 mt-2"> <!-- REDUCIDO mt-3 a mt-2 -->
        <button onclick="goToday()" class="px-2 py-1 md:px-3 md:py-1 bg-white/20 hover:bg-white/30 rounded-full text-[9px] md:text-[10px] font-black uppercase transition-colors"> <!-- REDUCIDO px-3 a px-2 -->
          Hoy
        </button>
        <button onclick="showView('summary')" class="px-2 py-1 md:px-3 md:py-1 bg-white/10 hover:bg-white/20 rounded-full text-[9px] md:text-[10px] font-black uppercase transition-colors hidden md:block"> <!-- REDUCIDO px-3 a px-2 -->
          Resumen
        </button>
      </div>
    </div>

    <button onclick="changeMonth(1)" class="p-2 md:p-2 hover:bg-white/10 rounded-full transition-colors flex-shrink-0"> <!-- REDUCIDO p-3 a p-2 -->
      <span class="text-xl md:text-xl font-bold">‚Ä∫</span>
    </button>
  </div>
</div>

<!-- Tabs - POSICI√ìN AJUSTADA (top m√°s bajo debido a header m√°s compacto) -->
<div class="flex bg-white shadow-sm sticky top-[116px] md:top-[124px] z-40 border-b"> <!-- AJUSTADO top de [144px] a [116px] -->
  <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">üìÖ Calendario</button>
  <button onclick="showView('summary')" id="tab-summary" class="tab-btn">üìä Resumen</button>
  <button onclick="showView('settings')" id="tab-settings" class="tab-btn">‚öôÔ∏è Ajustes</button>
</div>

<!-- Calendar -->
<div id="view-calendar" class="view-section view-active">
  <div class="grid grid-cols-7 text-center text-[11px] font-black py-2 md:py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b"> <!-- REDUCIDO py-3 a py-2 -->
    <div class="text-blue-600 font-black">LUN</div>
    <div>MAR</div>
    <div>MI√â</div>
    <div>JUE</div>
    <div>VIE</div>
    <div class="text-blue-600 font-black">S√ÅB</div>
    <div class="text-red-600 font-black">DOM</div>
  </div>
  <div id="calendar" class="calendar-grid"></div>
</div>

<!-- Summary - COMPACTADO -->
<div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen scrollable-content">
  <div class="space-y-4 md:space-y-6">
    <div id="summary-categories" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4"> <!-- REDUCIDO gap-4 a gap-3 -->
      <!-- Las categor√≠as se generar√°n din√°micamente aqu√≠ -->
    </div>

    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-4 md:p-5 rounded-3xl text-white text-center shadow-xl"> <!-- REDUCIDO p-5 a p-4 -->
      <p class="text-xs font-black uppercase opacity-90 mb-2">D√≠as de Descanso</p>
      <h2 id="total-off" class="text-4xl md:text-4xl font-black mb-3">0</h2> <!-- REDUCIDO text-5xl a text-4xl -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-[10px] font-black">
        <div class="bg-white/20 p-2 rounded-xl"><div>Libres</div><div id="free-days" class="text-lg font-black">0</div></div> <!-- REDUCIDO p-3 a p-2 -->
        <div class="bg-white/20 p-2 rounded-xl"><div>Vacaciones</div><div id="vac-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Fines</div><div id="weekend-days" class="text-lg font-black">0</div></div>
        <div class="bg-white/20 p-2 rounded-xl"><div>Asuetos Trab.</div><div id="holiday-worked" class="text-lg font-black">0</div></div>
      </div>
      <p class="text-[10px] mt-3 font-bold opacity-90">
        * Asueto laborado solo cuenta si aplica a la localidad del perfil.
      </p>
    </div>

    <div class="bg-white p-4 rounded-3xl shadow-sm"> <!-- REDUCIDO p-5 a p-4 -->
      <h3 class="text-[12px] font-black text-gray-600 uppercase mb-3">üìà Resumen del Mes</h3>
      <div class="space-y-2">
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Localidad perfil:</span><span id="profile-loc" class="font-black text-gray-900">San Salvador</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">D√≠as trabajados:</span><span id="worked-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Promedio diario:</span><span id="avg-hours" class="font-black text-gray-900">0.0h</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Total d√≠as mes:</span><span id="total-days" class="font-black text-gray-900">30</span></div>
        <div class="flex justify-between"><span class="text-[11px] font-bold text-gray-500">Asuetos en mes:</span><span id="total-holidays" class="font-black text-red-600">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Settings - AJUSTADO para nueva altura de header -->
<div id="view-settings" class="view-section bg-white min-h-screen">
  <div class="config-tabs-container">
    <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active whitespace-nowrap">üé® Turnos</button>
    <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab whitespace-nowrap">‚ûï Nuevo</button>
    <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab whitespace-nowrap">üè∑Ô∏è Categor√≠as</button>
    <button onclick="showConfigTab('localidades')" id="config-localidades" class="config-tab whitespace-nowrap">üìç Localidades</button>
    <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab whitespace-nowrap">üéâ Asuetos</button>
    <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab whitespace-nowrap">üîí Seguridad</button>
  </div>

  <div id="config-content" class="p-4 md:p-6 scrollable-content">
    <!-- Contenido de configuraci√≥n (igual que antes) -->
    <!-- Turnos -->
    <div id="tab-turnos" class="config-tab-content block">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üé® Configurar Turnos</h3>
        <button onclick="saveShiftSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-blue-50 border border-blue-100 rounded-2xl p-3 text-[11px] font-bold text-blue-900 mb-4">
        Al guardar: actualiza turnos y puede propagar horas/comentarios en el calendario del perfil.
        <div class="mt-2 flex items-center gap-2">
          <input type="checkbox" id="propagateShiftEdits" checked>
          <label for="propagateShiftEdits" class="font-black text-[10px] uppercase text-blue-900">Propagar a calendario (este perfil)</label>
        </div>
      </div>

      <div id="settings-container" class="space-y-3"></div>
    </div>

    <!-- Nuevo turno -->
    <div id="tab-nuevo" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">‚ûï Agregar Nuevo Turno</h3>
      <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-100 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Turno</label>
            <input type="text" id="newShiftName" placeholder="Ej: Noche" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Categor√≠a</label>
            <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
          </div>
        </div>

        <div class="mb-4">
          <label class="text-[11px] font-bold text-gray-600 block mb-2">Color</label>
          <div class="grid grid-cols-5 md:grid-cols-6 gap-2 p-3 bg-white rounded-xl">
            <div class="color-option bg-Ma√±ana" onclick="selectColor('Ma√±ana', event)"></div>
            <div class="color-option bg-Tarde" onclick="selectColor('Tarde', event)"></div>
            <div class="color-option bg-CENA" onclick="selectColor('CENA', event)"></div>
            <div class="color-option bg-16hrs" onclick="selectColor('16hrs', event)"></div>
            <div class="color-option bg-Vacaciones" onclick="selectColor('Vacaciones', event)"></div>
            <div class="color-option bg-Cumplea√±os" onclick="selectColor('Cumplea√±os', event)"></div>
            <div class="color-option bg-Ausencia" onclick="selectColor('Ausencia', event)"></div>
            <div class="color-option bg-L" onclick="selectColor('L', event)"></div>
            <div class="color-option bg-azul" onclick="selectColor('azul', event)"></div>
            <div class="color-option bg-rojo" onclick="selectColor('rojo', event)"></div>
          </div>
          <input type="hidden" id="newShiftColor" value="Ma√±ana">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Entrada</label>
            <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Salida</label>
            <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
        </div>

        <button onclick="addNewShift()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600">
          ‚ûï Agregar Turno
        </button>
      </div>
    </div>

    <!-- Categor√≠as -->
    <div id="tab-categorias" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üè∑Ô∏è Categor√≠as</h3>
        <button onclick="saveCategories()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-3xl border border-green-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva Categor√≠a</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newCategoryName" placeholder="Ej: Guardia" class="w-full bg-white border-green-200 focus:border-green-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Icono</label>
            <select id="newCategoryIcon" class="w-full bg-white border-green-200 focus:border-green-400">
              <option value="üè•">üè•</option><option value="üåô">üåô</option><option value="üò¥">üò¥</option><option value="üìã">üìã</option>
              <option value="üõ°Ô∏è">üõ°Ô∏è</option><option value="‚≠ê">‚≠ê</option><option value="üîß">üîß</option><option value="üöë">üöë</option>
              <option value="üíä">üíä</option><option value="ü©∫">ü©∫</option><option value="üè®">üè®</option><option value="üìå">üìå</option>
              <option value="üéÇ">üéÇ</option><option value="‚ùå">‚ùå</option>
            </select>
          </div>
        </div>
        <button onclick="addNewCategory()" class="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600">
          ‚ûï Agregar Categor√≠a
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Categor√≠as Existentes (editables)</h4>
        <div id="categories-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Localidades -->
    <div id="tab-localidades" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üìç Localidades</h3>
        <button onclick="saveLocalities()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-sky-50 to-blue-50 p-4 rounded-3xl border border-sky-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Localidad</h4>
        <div class="flex flex-col md:flex-row gap-3">
          <input type="text" id="newLocalityName" placeholder="Ej: Santa Ana" class="flex-1 bg-white border-sky-200 focus:border-sky-400">
          <button onclick="addLocality()" class="px-5 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px] whitespace-nowrap">‚ûï Agregar</button>
        </div>
        <p class="text-[10px] mt-2 font-bold text-gray-500">* "General" se reserva para asuetos v√°lidos para todos.</p>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Lista de Localidades (editables)</h4>
        <div id="localities-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Asuetos -->
    <div id="tab-asuetos" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üéâ Asuetos</h3>
        <button onclick="saveHolidays()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-3xl border border-pink-100 mb-6">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nuevo Asueto</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Fecha</label>
            <input type="date" id="newHolidayDate" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
          <div class="md:col-span-2">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newHolidayName" placeholder="Ej: D√≠a de la Independencia" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="newHolidayLocation" class="w-full bg-white border-pink-200 focus:border-pink-400"></select>
          </div>
          <div class="bg-white rounded-2xl border border-pink-200 p-3 text-[10px] font-bold text-gray-600 flex items-center">
            Si quieres asueto para todos: selecciona <span class="mx-1 font-black text-red-600">General</span>.
          </div>
        </div>

        <button onclick="addNewHoliday()" class="w-full p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600">
          ‚ûï Agregar Asueto
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Asuetos (editables)</h4>
        <div id="holidays-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Seguridad -->
    <div id="tab-seguridad" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üîí Seguridad (PIN del perfil actual)</h3>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-3xl border border-blue-100">
        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Cambiar PIN (4 d√≠gitos)</label>
            <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Confirmar PIN</label>
            <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>

          <button onclick="savePinOnly()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-3xl font-black uppercase shadow-xl hover:from-blue-700 hover:to-indigo-700">
            üíæ Guardar PIN
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="settings-locked" class="p-6 md:p-8 text-center hidden">
    <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
      <span class="text-2xl md:text-3xl">üîí</span>
    </div>
    <h3 class="text-base md:text-lg font-black text-gray-600 mb-2">Configuraci√≥n Bloqueada</h3>
    <p class="text-sm text-gray-500 mb-6">Activa el modo edici√≥n para acceder</p>
    <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-black">üîì Activar Edici√≥n</button>
  </div>
</div>

<!-- Modal d√≠a -->
<div id="modal" class="modal">
  <div class="bg-white w-full max-w-md md:max-w-lg rounded-3xl md:rounded-[40px] overflow-hidden shadow-2xl border border-gray-100 mx-2 max-h-[90vh] overflow-y-auto">
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-5 md:py-5 font-black text-base md:text-sm uppercase tracking-widest sticky top-0 z-10">
      <div>üìÖ Configurar D√≠a</div>
      <div id="modalDate" class="text-[12px] md:text-[10px] font-normal opacity-90 mt-1"></div>
    </div>
    <div class="p-5 md:p-6">
      <!-- Holiday info -->
      <div id="holidayInfo" class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-500 p-4 md:p-3 rounded-lg mb-5 md:mb-4 hidden">
        <div class="flex items-center gap-3 md:gap-2">
          <span class="text-yellow-600 text-xl md:text-lg">üéâ</span>
          <div class="flex-1">
            <div id="holidayName" class="text-[14px] md:text-[12px] font-black text-yellow-800"></div>
            <div id="holidayLocation" class="text-[12px] md:text-[10px] font-bold text-yellow-600"></div>
          </div>
        </div>
      </div>
      
      <div class="flex bg-gray-100 p-2 md:p-1.5 rounded-2xl mb-5 md:mb-6">
        <button onclick="setMode('simple')" id="m-s" class="flex-1 py-4 md:py-3 rounded-xl font-black text-[13px] md:text-[11px] uppercase transition-all">Simple</button>
        <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-4 md:py-3 rounded-xl font-black text-[13px] md:text-[11px] uppercase transition-all">Mixto</button>
      </div>

      <div id="sec-simple" class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-2 mb-5 md:mb-4"></div>

      <div id="sec-mixto" class="hidden space-y-5 md:space-y-4 mb-5 md:mb-6">
        <div class="p-5 md:p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl md:rounded-[24px] border border-gray-200">
          <p class="text-[12px] md:text-[10px] font-black text-gray-400 uppercase mb-4 md:mb-3 text-center">Parte Superior</p>
          <div id="mix-t" class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-2"></div>
        </div>
        <div class="p-5 md:p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl md:rounded-[24px] border border-gray-200">
          <p class="text-[12px] md:text-[10px] font-black text-gray-400 uppercase mb-4 md:mb-3 text-center">Parte Inferior</p>
          <div id="mix-b" class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-2"></div>
        </div>
      </div>

      <!-- Horario SIMPLE -->
      <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 md:p-5 rounded-2xl md:rounded-[24px] space-y-5 md:space-y-4 border border-blue-100 mb-5 md:mb-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 md:gap-3">
          <span class="text-[13px] md:text-[11px] font-black uppercase text-blue-900">‚è∞ Horario:</span>
          <div class="flex items-center gap-3 md:gap-2">
            <input type="time" id="tIn" onchange="autoCalc(); maybeAutoNoteSimple();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400 p-3 md:p-3">
            <span class="font-black text-blue-300 text-xl">‚Üí</span>
            <input type="time" id="tOut" onchange="autoCalc(); maybeAutoNoteSimple();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400 p-3 md:p-3">
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-blue-200 pt-4 md:pt-3 gap-3 md:gap-2">
          <span class="text-[13px] md:text-[11px] font-black uppercase text-blue-900">üìä Total Horas:</span>
          <input type="number" id="tHrs" onchange="manualCalc()" class="w-full md:w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200 p-3 md:p-3" step="0.5">
        </div>
      </div>

      <!-- Horario MIXTO -->
      <div id="time-mixto" class="hidden space-y-5 md:space-y-4 mb-5 md:mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 md:p-5 rounded-2xl md:rounded-[24px] space-y-5 md:space-y-4 border border-blue-100">
          <p class="text-[13px] md:text-[11px] font-black uppercase text-blue-900 text-center">‚è∞ Horario Superior</p>
          <div class="flex items-center gap-3 md:gap-2 justify-center">
            <input type="time" id="tInTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400 p-3 md:p-3">
            <span class="font-black text-blue-300 text-xl">‚Üí</span>
            <input type="time" id="tOutTop" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400 p-3 md:p-3">
          </div>
          <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-blue-200 pt-4 md:pt-3 gap-3 md:gap-2">
            <span class="text-[13px] md:text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
            <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-full md:w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200 p-3 md:p-3" step="0.5">
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-5 md:p-5 rounded-2xl md:rounded-[24px] space-y-5 md:space-y-4 border border-purple-100">
          <p class="text-[13px] md:text-[11px] font-black uppercase text-purple-900 text-center">‚è∞ Horario Inferior</p>
          <div class="flex items-center gap-3 md:gap-2 justify-center">
            <input type="time" id="tInBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-purple-200 focus:border-purple-400 p-3 md:p-3">
            <span class="font-black text-purple-300 text-xl">‚Üí</span>
            <input type="time" id="tOutBottom" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-purple-200 focus:border-purple-400 p-3 md:p-3">
          </div>
          <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-purple-200 pt-4 md:pt-3 gap-3 md:gap-2">
            <span class="text-[13px] md:text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
            <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-full md:w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200 p-3 md:p-3" step="0.5">
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-5 md:p-4 rounded-[20px] border border-emerald-100 gap-3 md:gap-2">
          <span class="text-[13px] md:text-[11px] font-black uppercase text-emerald-900">üìä Total Horas:</span>
          <input type="number" id="tHrsMixto" class="w-full md:w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200 p-3 md:p-3" step="0.5" readonly>
        </div>
        
        <!-- Comentarios separados para mixto -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-3">
          <div>
            <p class="text-[12px] md:text-[10px] font-black text-gray-400 uppercase mb-3 md:mb-2">üìù Comentario Superior</p>
            <textarea id="notaTop" placeholder="Ej: 06:00-14:00" class="w-full p-4 md:p-3 bg-gray-100 border-none rounded-[16px] text-base md:text-sm font-bold h-24 md:h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <p class="text-[12px] md:text-[10px] font-black text-gray-400 uppercase mb-3 md:mb-2">üìù Comentario Inferior</p>
            <textarea id="notaBottom" placeholder="Ej: 14:00-22:00" class="w-full p-4 md:p-3 bg-gray-100 border-none rounded-[16px] text-base md:text-sm font-bold h-24 md:h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>
      </div>

      <!-- Comentario SIMPLE -->
      <div id="note-simple" class="mt-5 md:mt-6">
        <p class="text-[12px] md:text-[10px] font-black text-gray-400 uppercase mb-3 md:mb-2">üìù Comentario (editable)</p>
        <textarea id="nota" placeholder="Ej: 06:00-14:00 | Doble turno | etc." class="w-full p-5 md:p-4 bg-gray-100 border-none rounded-2xl md:rounded-[24px] text-base md:text-sm font-bold h-24 md:h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="flex flex-col md:flex-row gap-4 md:gap-4 mt-8 md:mt-8">
        <button onclick="closeModal()" class="flex-1 p-4 md:p-4 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-2xl md:rounded-3xl font-black text-[13px] md:text-[11px] uppercase">‚ùå Cancelar</button>
        <button onclick="saveDay()" class="flex-1 p-4 md:p-4 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-2xl md:rounded-3xl font-black text-[13px] md:text-[11px] uppercase shadow-lg">‚úÖ Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Import -->
<div id="importModal" class="modal">
  <div class="bg-white w-full max-w-2xl rounded-3xl md:rounded-[40px] p-5 md:p-6 lg:p-8 shadow-2xl mx-2 max-h-[90vh] overflow-y-auto">
    <div class="w-16 h-16 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-5 md:mb-4 flex items-center justify-center">
      <span class="text-white text-3xl md:text-2xl font-black">üì•</span>
    </div>
    <h3 class="font-black text-center uppercase text-lg md:text-lg mb-3 md:mb-2">Importar Excel</h3>
    <p class="text-[13px] md:text-[11px] text-gray-500 font-bold text-center mb-7 md:mb-6">
      Detecta usuarios y permite seleccionar cu√°les importar.
    </p>

    <div class="space-y-5 md:space-y-4">
      <div>
        <label class="text-[14px] md:text-[12px] font-bold text-gray-600 block mb-3 md:mb-2">Archivo Excel (.xlsx)</label>
        <input type="file" id="importFile" accept=".xlsx,.xls" class="w-full bg-gray-50 border-gray-200 p-4 md:p-3">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-3">
        <div>
          <label class="text-[14px] md:text-[12px] font-bold text-gray-600 block mb-3 md:mb-2">Mes (si no detecta)</label>
          <select id="importMonth" class="w-full bg-gray-50 border-gray-200 p-4 md:p-3"></select>
        </div>
        <div>
          <label class="text-[14px] md:text-[12px] font-bold text-gray-600 block mb-3 md:mb-2">A√±o (si no detecta)</label>
          <select id="importYear" class="w-full bg-gray-50 border-gray-200 p-4 md:p-3"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-5 md:p-4">
        <p class="text-[13px] md:text-[11px] font-black text-gray-600 uppercase mb-3 md:mb-2">Modo</p>
        <div class="flex flex-col md:flex-row gap-4 md:gap-3">
          <label class="flex items-center gap-3 md:gap-2 cursor-pointer text-[13px] md:text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="replace" checked class="w-5 h-5"> Reemplazar mes
          </label>
          <label class="flex items-center gap-3 md:gap-2 cursor-pointer text-[13px] md:text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="merge" class="w-5 h-5"> Combinar (solo d√≠as vac√≠os)
          </label>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-2xl p-5 md:p-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-3 md:mb-2 gap-3 md:gap-2">
          <p class="text-[13px] md:text-[11px] font-black text-gray-600 uppercase">Usuarios detectados</p>
          <div class="flex gap-3 md:gap-2">
            <button onclick="selectAllImportUsers(true)" class="px-4 py-3 md:px-3 md:py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[12px] md:text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllImportUsers(false)" class="px-4 py-3 md:px-3 md:py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[12px] md:text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="importUsersList" class="max-h-[200px] md:max-h-[180px] overflow-y-auto space-y-3 md:space-y-2 text-[13px] md:text-[11px] font-bold text-gray-700">
          <div class="text-gray-400 font-bold">Adjunta un Excel y presiona "Analizar".</div>
        </div>

        <div class="mt-4 md:mt-3 flex flex-col md:flex-row gap-3 md:gap-2">
          <button onclick="analyzeImportFile()" class="flex-1 p-4 md:p-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[13px] md:text-[11px]">
            üîé Analizar
          </button>
          <button onclick="runImportSelected()" class="flex-1 p-4 md:p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black uppercase text-[13px] md:text-[11px]">
            üöÄ Importar Seleccionados
          </button>
          <button onclick="closeImportModalAndRefresh()" class="flex-1 p-4 md:p-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black uppercase text-[13px] md:text-[11px]">
            ‚úÖ Terminar y Volver
          </button>
        </div>

        <div id="importInfo" class="mt-4 md:mt-3 text-[13px] md:text-[11px] font-bold text-center text-gray-600"></div>
      </div>

      <button onclick="closeImportModal()" class="w-full mt-3 md:mt-2 p-4 md:p-3 text-gray-400 font-bold uppercase text-[12px] md:text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Export -->
<div id="exportModal" class="modal">
  <div class="bg-white w-full max-w-xl rounded-3xl md:rounded-[40px] p-5 md:p-6 lg:p-8 shadow-2xl mx-2 max-h-[90vh] overflow-y-auto">
    <div class="w-16 h-16 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 mx-auto mb-5 md:mb-4 flex items-center justify-center">
      <span class="text-white text-3xl md:text-2xl font-black">üìã</span>
    </div>
    <h3 class="font-black text-center uppercase text-lg md:text-lg mb-3 md:mb-2">Exportar</h3>
    <p class="text-[13px] md:text-[11px] text-gray-500 font-bold text-center mb-7 md:mb-6">
      Puedes exportar uno, varios o todos. Si es "todos", se genera 1 imagen por perfil.
    </p>

    <div class="space-y-5 md:space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-3">
        <div>
          <label class="text-[14px] md:text-[12px] font-bold text-gray-600 block mb-3 md:mb-2">Mes</label>
          <select id="exportMonth" class="w-full bg-gray-50 border-gray-200 p-4 md:p-3"></select>
        </div>
        <div>
          <label class="text-[14px] md:text-[12px] font-bold text-gray-600 block mb-3 md:mb-2">A√±o</label>
          <select id="exportYear" class="w-full bg-gray-50 border-gray-200 p-4 md:p-3"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-5 md:p-4">
        <p class="text-[13px] md:text-[11px] font-black text-gray-600 uppercase mb-3 md:mb-2">Qu√© exportar</p>
        <div class="space-y-3 md:space-y-2 text-[13px] md:text-[11px] font-bold text-gray-700">
          <label class="flex items-center gap-3 md:gap-2 cursor-pointer"><input type="radio" name="exportScope" value="current" checked class="w-5 h-5"> Perfil actual</label>
          <label class="flex items-center gap-3 md:gap-2 cursor-pointer"><input type="radio" name="exportScope" value="select" class="w-5 h-5"> Seleccionar perfiles</label>
          <label class="flex items-center gap-3 md:gap-2 cursor-pointer"><input type="radio" name="exportScope" value="all" class="w-5 h-5"> Todos los perfiles</label>
        </div>
      </div>

      <div id="exportUsersBox" class="bg-white border border-gray-200 rounded-2xl p-5 md:p-4 hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-3 md:mb-2 gap-3 md:gap-2">
          <p class="text-[13px] md:text-[11px] font-black text-gray-600 uppercase">Seleccionar perfiles</p>
          <div class="flex gap-3 md:gap-2">
            <button onclick="selectAllExportUsers(true)" class="px-4 py-3 md:px-3 md:py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[12px] md:text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllExportUsers(false)" class="px-4 py-3 md:px-3 md:py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[12px] md:text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="exportUsersList" class="max-h-[200px] md:max-h-[180px] overflow-y-auto space-y-3 md:space-y-2 text-[13px] md:text-[11px] font-bold text-gray-700"></div>
      </div>

      <button onclick="exportImages()" class="w-full p-5 md:p-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-2xl md:rounded-3xl font-black uppercase shadow-xl hover:from-emerald-700 hover:to-teal-700">
        üñºÔ∏è Exportar im√°genes
      </button>

      <button onclick="closeExportModal()" class="w-full mt-3 md:mt-2 p-4 md:p-3 text-gray-400 font-bold uppercase text-[12px] md:text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Profiles -->
<div id="profilesModal" class="modal">
  <div class="bg-white w-full max-w-3xl rounded-3xl md:rounded-[40px] p-5 md:p-6 lg:p-8 shadow-2xl mx-2 max-h-[90vh] overflow-y-auto">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-5 md:mb-4 gap-4 md:gap-3">
      <div>
        <h3 class="font-black uppercase text-lg md:text-base">üë§ Gesti√≥n de Perfiles</h3>
        <p class="text-[13px] md:text-[11px] text-gray-500 font-bold">Crear, editar, asignar localidad o eliminar perfiles.</p>
      </div>
      <button onclick="closeProfilesModal()" class="px-4 py-3 md:px-3 md:py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[12px] md:text-[10px] font-black uppercase whitespace-nowrap">Cerrar</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-4">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-3xl p-5 md:p-4">
        <h4 class="text-[14px] md:text-[12px] font-black text-gray-700 uppercase mb-4 md:mb-3">‚ûï Crear perfil</h4>
        <div class="space-y-4 md:space-y-3">
          <input id="createName" type="text" placeholder="Nombre completo" class="w-full bg-white border-blue-200 focus:border-blue-400 p-4 md:p-3">
          <input id="createPin" type="password" placeholder="PIN (4 d√≠gitos)" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400 p-4 md:p-3">
          <div>
            <label class="text-[13px] md:text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="createLoc" class="w-full bg-white border-blue-200 focus:border-blue-400 p-4 md:p-3"></select>
          </div>
          <button onclick="createProfile()" class="w-full p-4 md:p-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-[13px] md:text-[11px]">
            Crear
          </button>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-3xl p-5 md:p-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 md:mb-3 gap-3 md:gap-2">
          <h4 class="text-[14px] md:text-[12px] font-black text-gray-700 uppercase">Perfiles existentes</h4>
          <button onclick="renderProfilesList()" class="px-4 py-3 md:px-3 md:py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[12px] md:text-[10px] font-black uppercase whitespace-nowrap">Actualizar</button>
        </div>
        <div id="profilesList" class="max-h-[300px] md:max-h-[360px] overflow-y-auto space-y-3 md:space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
// =========================================================
// Funciones para el men√∫ hamburguesa m√≥vil
// =========================================================

function toggleMobilePanel() {
  const panel = document.getElementById('mobileButtonsPanel');
  const hamburger = document.querySelector('.hamburger-menu');
  const overlay = document.querySelector('.overlay');
  
  panel.classList.toggle('active');
  hamburger.classList.toggle('active');
  overlay.classList.toggle('active');
  
  // Prevenir scroll del body cuando el panel est√° abierto
  document.body.style.overflow = panel.classList.contains('active') ? 'hidden' : '';
}

function closeMobilePanel() {
  const panel = document.getElementById('mobileButtonsPanel');
  const hamburger = document.querySelector('.hamburger-menu');
  const overlay = document.querySelector('.overlay');
  
  panel.classList.remove('active');
  hamburger.classList.remove('active');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
}

// Actualizar bot√≥n de bloqueo en el panel m√≥vil
function updateMobileEditButton() {
  const mobileUnlockBtn = document.getElementById('mobileUnlockBtn');
  const unlockBtn = document.getElementById('unlockBtn');
  
  if (mobileUnlockBtn && unlockBtn) {
    mobileUnlockBtn.textContent = unlockBtn.textContent;
    mobileUnlockBtn.className = unlockBtn.className.replace('top-bar-buttons ', '') + ' text-white';
  }
}

// =========================================================
// DB v23 - Versi√≥n completa y corregida
// CON MODIFICACI√ìN: Quitar leyenda de turnos en exportaci√≥n
// =========================================================
const ADMIN_UNIVERSAL_PIN = '120720';

// Intentar cargar DB existente o crear nueva
let db;
try {
  const saved = localStorage.getItem('shifter_v23');
  if (saved) {
    db = JSON.parse(saved);
  } else {
    // Intentar migrar de versi√≥n anterior
    const savedOld = localStorage.getItem('shifter_v22') || localStorage.getItem('shifter_v21') || localStorage.getItem('shifter_v20');
    if (savedOld) {
      db = JSON.parse(savedOld);
      db.version = 23;
    } else {
      db = createDefaultDB();
    }
  }
} catch (e) {
  console.log('Error cargando DB, creando nueva:', e);
  db = createDefaultDB();
}

function createDefaultDB() {
  return {
    version: 23,
    current: 'ADMIN',
    localities: ['General','San Salvador','Cojutepeque','Lourdes, Col√≥n','La Libertad','Quezaltepeque','Rosario de la Paz','Zacatecoluca','San Vicente','Santa Tecla','San Juan Opico'],
    holidays: {},
    categories: {
      hosp: { name:'Hospital', icon:'üè•', color:'#3b82f6' },
      sena: { name:'CENA', icon:'üåô', color:'#8b5cf6' },
      off:  { name:'Libre', icon:'üò¥', color:'#10b981' },
      admin:{ name:'Administrativo', icon:'üìã', color:'#f59e0b' },
      guardia:{ name:'Guardia', icon:'üõ°Ô∏è', color:'#ef4444' },
      extra:{ name:'Extra', icon:'‚≠ê', color:'#fbbf24' },
      otro:{ name:'Otro', icon:'üîß', color:'#6b7280' },
      ausencia:{ name:'Ausencia Injustificada', icon:'‚ùå', color:'#dc2626' },
      cumple:{ name:'Cumplea√±os', icon:'üéÇ', color:'#ec4899' }
    },
    users: {
      ADMIN: {
        pin:'1234',
        editLocked:false,
        locality:'San Salvador',
        data:{},
        config:{
          'Ma√±ana': { label:'Ma√±ana', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00' },
          'Tarde': { label:'Tarde', color:'Tarde', cat:'hosp', in:'14:00', out:'22:00' },
          '16hrs': { label:'16hrs', color:'16hrs', cat:'hosp', in:'06:00', out:'22:00' },
          'CENA': { label:'CENA', color:'CENA', cat:'sena', in:'05:00', out:'17:00' },
          'Cumplea√±os': { label:'Cumplea√±os', color:'Cumplea√±os', cat:'cumple', in:'00:00', out:'00:00' },
          'L': { label:'L', color:'L', cat:'off', in:'00:00', out:'00:00' },
          'Vacaciones': { label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00' },
          'Ausencia': { label:'Ausencia', color:'Ausencia', cat:'ausencia', in:'00:00', out:'00:00' }
        }
      }
    }
  };
}

function saveDB(){ 
  try {
    localStorage.setItem('shifter_v23', JSON.stringify(db));
  } catch (e) {
    console.error('Error guardando DB:', e);
  }
}

// =========================================================
// Import maps
// =========================================================
const IMPORT_ABSENCE_MAP = {
  'C':  { key:'CAPACITACION', label:'Capacitaci√≥n', color:'azul', cat:'admin', in:'00:00', out:'00:00', note:'CAPACITACI√ìN' },
  'I':  { key:'INCAPACIDAD', label:'Incapacidad', color:'rojo', cat:'off', in:'00:00', out:'00:00', note:'INCAPACIDAD' },
  'V':  { key:'Vacaciones', label:'Vacaciones', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', note:'VACACIONES' },
  'L':  { key:'L', label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', note:'LIBRE' },
  'PS': { key:'PERMISO_SINDICAL', label:'Permiso Sindical', color:'morado', cat:'admin', in:'00:00', out:'00:00', note:'PERMISO SINDICAL' },
  'F':  { key:'AUSENCIA_INJUST', label:'Aus. Injust.', color:'Ausencia', cat:'ausencia', in:'00:00', out:'00:00', note:'AUSENCIA INJUSTIFICADA' },
  'CU': { key:'Cumplea√±os', label:'Cumplea√±os', color:'Cumplea√±os', cat:'cumple', in:'00:00', out:'00:00', note:'CUMPLEA√ëOS' }
};

const IMPORT_SHIFT_CODE_MAP = {
  '018': { key:'018', label:'018', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '18':  { key:'018', label:'018', color:'Ma√±ana', cat:'hosp', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '020': { key:'020', label:'020', color:'Tarde', cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '468': { key:'468', label:'468', color:'Tarde',  cat:'hosp', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '650': { key:'650', label:'650', color:'16hrs',  cat:'hosp', in:'06:00', out:'22:00', note:'06:00-22:00' }
};

// =========================================================
// Globals
// =========================================================
let current = new Date();
let activeKey = "";
let mode = "simple";
let selS = "Ma√±ana";
let selT = "Ma√±ana";
let selB = "Tarde";
let selectedColor = "Ma√±ana";

let importContext = null;

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

// =========================================================
// Helper Functions
// =========================================================
function isEditMode(){ 
  const user = db.users[db.current];
  return user ? !user.editLocked : false;
}

function calculateHours(start, end){
  if(!start || !end || start === '00:00' && end === '00:00') return 0;
  try {
    const [h1,m1] = start.split(':').map(Number);
    const [h2,m2] = end.split(':').map(Number);
    const diff = (h2 + m2/60) - (h1 + m1/60);
    return diff < 0 ? diff + 24 : parseFloat(diff.toFixed(1));
  } catch {
    return 0;
  }
}

function defaultNoteForShift(shiftKey){
  const user = db.users[db.current];
  if (!user) return shiftKey || '';
  const sh = user.config[shiftKey];
  if (!sh) return (shiftKey||'').toUpperCase();
  if (sh.in && sh.out && !(sh.in === '00:00' && sh.out === '00:00')) {
    return `${sh.in}-${sh.out}`;
  }
  return (sh.label || shiftKey || '').toUpperCase();
}

function normalizeCode(v){
  if(v === null || v === undefined || v === '') return '';
  let s = String(v).trim().toUpperCase();
  s = s.replace(/\s+/g, ' ');
  if (s === 'LS') s = 'L';
  if (s === 'P S' || s === 'P/S') s = 'PS';
  if (s === 'CU' || s === 'CUM') s = 'CU';
  return s;
}

function codeToShiftDef(codeNorm){
  if(!codeNorm || codeNorm === 'X') return null;
  if(IMPORT_ABSENCE_MAP[codeNorm]) return {...IMPORT_ABSENCE_MAP[codeNorm]};
  if(IMPORT_SHIFT_CODE_MAP[codeNorm]) return {...IMPORT_SHIFT_CODE_MAP[codeNorm]};
  
  if(/^\d+$/.test(codeNorm)){
    return { 
      key: codeNorm, 
      label: codeNorm, 
      color:'gris', 
      cat:'hosp', 
      in:'00:00', 
      out:'00:00', 
      note: codeNorm 
    };
  }
  return null;
}

function ensureShiftExistsForUser(userKey, shiftDef){
  const user = db.users[userKey];
  if(!user || !shiftDef) return;
  if(!user.config[shiftDef.key]){
    user.config[shiftDef.key] = { 
      label: shiftDef.label, 
      color: shiftDef.color || 'gris', 
      cat: shiftDef.cat || 'hosp', 
      in: shiftDef.in || '00:00', 
      out: shiftDef.out || '00:00' 
    };
  }
}

function ensureImportBaseShiftsForUser(userKey){
  Object.values(IMPORT_ABSENCE_MAP).forEach(def => ensureShiftExistsForUser(userKey, def));
  Object.values(IMPORT_SHIFT_CODE_MAP).forEach(def => ensureShiftExistsForUser(userKey, def));
}

function ensureUserExists(nameUpper){
  const name = String(nameUpper || '').trim().toUpperCase();
  if(!name) return null;
  
  if(!db.users[name]){
    db.users[name] = {
      pin: '0000',
      editLocked: false,
      locality: 'San Salvador',
      data: {},
      config: JSON.parse(JSON.stringify(db.users.ADMIN.config))
    };
    ensureImportBaseShiftsForUser(name);
  }
  return name;
}

function dayKey(y, m1, d){ 
  return `${y}-${m1}-${d}`; 
}

function getColorValue(colorName){
  const map = {
    'Ma√±ana':'#ffff00','Tarde':'#fbcfe8','CENA':'#d8b4fe','16hrs':'#bef264',
    'L':'#ffffff','Vacaciones':'#fed7aa','Cumplea√±os':'#f9a8d4','Ausencia':'#d1d5db',
    'azul':'#93c5fd','rojo':'#fca5a5','verde':'#86efac','naranja':'#fdba74',
    'rosa':'#f9a8d4','cian':'#67e8f9','morado':'#d8b4fe','lima':'#d9f99d',
    'ambar':'#fcd34d','teal':'#5eead4','indigo':'#a5b4fc','gris':'#d1d5db'
  };
  return map[colorName] || '#ffffff';
}

function holidayApplies(holidayLocation, userLocation){
  const hl = (holidayLocation || 'General').trim().toUpperCase();
  const ul = (userLocation || 'San Salvador').trim().toUpperCase();
  return hl === 'GENERAL' || hl === ul;
}

function countApplicableHolidaysInMonth(year, monthIndex0, userLocation){
  const m1 = monthIndex0 + 1;
  let count = 0;
  Object.entries(db.holidays).forEach(([key, holiday]) => {
    const [y, mm] = key.split('-').map(Number);
    if(y === year && mm === m1 && holidayApplies(holiday.location, userLocation)){
      count++;
    }
  });
  return count;
}

function cssSafe(s){ 
  return String(s || '').replace(/[^a-zA-Z0-9_-]/g, '_'); 
}

function escapeHTML(s){
  if (s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function toISODate(y,m,d){
  y=String(y).padStart(4,'0');
  m=String(m).padStart(2,'0');
  d=String(d).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

// =========================================================
// UI Initialization
// =========================================================
function init(){
  // Cargar feriados por defecto
  loadDefaultHolidays();
  
  // Inicializar selectores
  initSelectors();
  
  // Asegurar turnos base
  ensureImportBaseShiftsForUser('ADMIN');
  
  // Actualizar UI
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  
  // Renderizar
  render();
  renderSummaryCategories();
  calcSummary();
  updateUIEditMode();
  updateMobileEditButton(); // Actualizar bot√≥n m√≥vil
  
  // Mostrar primera pesta√±a de configuraci√≥n
  showConfigTab('turnos');
  
  // Configurar eventos t√°ctiles mejorados
  setupTouchEvents();
  
  // Cerrar panel m√≥vil al hacer clic fuera
  document.addEventListener('click', (e) => {
    const panel = document.getElementById('mobileButtonsPanel');
    const hamburger = document.querySelector('.hamburger-menu');
    
    if (panel && panel.classList.contains('active') && 
        !panel.contains(e.target) && 
        !hamburger.contains(e.target)) {
      closeMobilePanel();
    }
  });
}

function loadDefaultHolidays(){
  const defaults = [
    {date: '2026-1-1', name: 'A√±o Nuevo', location: 'General'},
    {date: '2026-1-20', name: 'Fiestas de Cojutepeque', location: 'Cojutepeque'},
    {date: '2026-2-10', name: 'Fiesta de Lourdes Col√≥n', location: 'Lourdes, Col√≥n'},
    {date: '2026-4-1', name: 'Mi√©rcoles Santo', location: 'General'},
    {date: '2026-4-2', name: 'Jueves Santo', location: 'General'},
    {date: '2026-4-3', name: 'Viernes Santo', location: 'General'},
    {date: '2026-4-4', name: 'S√°bado de Gloria', location: 'General'},
    {date: '2026-5-1', name: 'D√≠a del Trabajo', location: 'General'},
    {date: '2026-5-10', name: 'D√≠a de la Madre', location: 'General'},
    {date: '2026-6-17', name: 'D√≠a del Padre', location: 'General'},
    {date: '2026-8-3', name: 'D√≠a del Comercio', location: 'General'},
    {date: '2026-8-4', name: 'Fiestas Patronales (San Salvador)', location: 'San Salvador'},
    {date: '2026-8-5', name: 'Fiestas Patronales (San Salvador)', location: 'San Salvador'},
    {date: '2026-8-6', name: 'D√≠a de El Salvador', location: 'General'},
    {date: '2026-9-15', name: 'Aniversario de Independencia', location: 'General'},
    {date: '2026-10-2', name: 'V√≠spera del d√≠a del Trabajador de la Industria El√©ctrica', location: 'General'},
    {date: '2026-10-3', name: 'D√≠a del Trabajador de la Industria El√©ctrica', location: 'General'},
    {date: '2026-11-2', name: 'D√≠a de los Difuntos', location: 'General'},
    {date: '2026-12-8', name: 'Fiestas de La Libertad', location: 'La Libertad'},
    {date: '2026-12-19', name: 'Fiestas Patronales', location: 'Quezaltepeque y Rosario de la Paz'},
    {date: '2026-12-24', name: 'Navidad', location: 'General'},
    {date: '2026-12-25', name: 'Navidad', location: 'General'},
    {date: '2026-12-26', name: 'Fiestas Patronales', location: 'Zacatecoluca, San Vicente y Santa Tecla'},
    {date: '2026-12-27', name: 'Fiestas de San Juan Opico', location: 'San Juan Opico'},
    {date: '2026-12-31', name: 'Fin de A√±o', location: 'General'}
  ];
  
  defaults.forEach(({date, name, location}) => {
    if (!db.holidays[date]) {
      db.holidays[date] = { name, location };
    }
  });
  
  saveDB();
}

function initSelectors(){
  // Meses
  const monthSelects = ['selectMonth', 'importMonth', 'exportMonth'];
  monthSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.innerHTML = MONTHS.map((m, i) => 
        `<option value="${i}">${m}</option>`
      ).join('');
      el.value = current.getMonth();
    }
  });
  
  // A√±os
  const yearSelects = ['selectYear', 'importYear', 'exportYear'];
  const currentYear = current.getFullYear();
  yearSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      let html = '';
      for(let y = currentYear - 2; y <= currentYear + 2; y++){
        html += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
      }
      el.innerHTML = html;
    }
  });
}

// =========================================================
// Touch Events Setup
// =========================================================
function setupTouchEvents(){
  // Prevenir zoom en inputs en dispositivos m√≥viles
  document.addEventListener('touchstart', function(e) {
    if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
      // Permitir solo para estos elementos
    }
  }, { passive: true });
  
  // Mejorar scroll en m√≥viles
  document.addEventListener('touchmove', function(e) {
    // Permitir scroll normal
  }, { passive: true });
  
  // A√±adir soporte para gestos de deslizamiento en calendario
  let startX = 0;
  let startY = 0;
  
  document.addEventListener('touchstart', function(e) {
    if(e.touches.length === 1) {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    }
  }, { passive: true });
  
  document.addEventListener('touchend', function(e) {
    if(!startX || !startY || e.changedTouches.length !== 1) return;
    
    const endX = e.changedTouches[0].clientX;
    const endY = e.changedTouches[0].clientY;
    
    const diffX = endX - startX;
    const diffY = endY - startY;
    
    // Solo considerar si es principalmente horizontal
    if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
      // Deslizamiento izquierda/derecha para cambiar mes
      if(diffX > 0) {
        // Deslizamiento a la derecha = mes anterior
        changeMonth(-1);
      } else {
        // Deslizamiento a la izquierda = mes siguiente
        changeMonth(1);
      }
    }
    
    startX = 0;
    startY = 0;
  }, { passive: true });
}

// =========================================================
// Navigation Functions
// =========================================================
function updateMonthDisplay(){
  const y = current.getFullYear();
  const m = current.getMonth();
  const display = document.getElementById('currentMonthDisplay');
  if (display) display.textContent = `${MONTHS[m]} ${y}`;
  
  const monthSelect = document.getElementById('selectMonth');
  const yearSelect = document.getElementById('selectYear');
  if (monthSelect) monthSelect.value = m;
  if (yearSelect) yearSelect.value = y;
}

function changeMonth(v){ 
  current.setMonth(current.getMonth() + v); 
  updateMonthDisplay(); 
  render();
  renderSummaryCategories();
  calcSummary();
}

function jumpToDate(){
  const monthSelect = document.getElementById('selectMonth');
  const yearSelect = document.getElementById('selectYear');
  if (monthSelect && yearSelect) {
    current.setMonth(parseInt(monthSelect.value));
    current.setFullYear(parseInt(yearSelect.value));
    updateMonthDisplay(); 
    render();
    renderSummaryCategories();
    calcSummary();
  }
}

function goToday(){ 
  current = new Date(); 
  updateMonthDisplay(); 
  render();
  renderSummaryCategories();
  calcSummary();
  closeMobilePanel(); // Cerrar panel si est√° abierto
}

// =========================================================
// View Management
// =========================================================
function showView(v){
  // Ocultar todas las vistas
  document.querySelectorAll('.view-section').forEach(s => {
    s.classList.remove('view-active');
  });
  
  // Quitar active de todas las tabs
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('tab-active');
  });
  
  // Mostrar vista seleccionada
  const viewElement = document.getElementById(`view-${v}`);
  const tabElement = document.getElementById(`tab-${v}`);
  
  if (viewElement) viewElement.classList.add('view-active');
  if (tabElement) tabElement.classList.add('tab-active');
  
  if(v === 'summary'){
    renderSummaryCategories();
    calcSummary();
  }
  
  if(v === 'settings'){
    updateUIEditMode();
  }
  
  // Scroll al inicio en m√≥viles
  if(window.innerWidth < 768) {
    window.scrollTo(0, 0);
  }
  
  closeMobilePanel(); // Cerrar panel m√≥vil al cambiar vista
}

function showConfigTab(tab){
  // Ocultar todas las pesta√±as de configuraci√≥n
  document.querySelectorAll('.config-tab').forEach(t => {
    t.classList.remove('active');
  });
  
  // Ocultar todos los contenidos
  document.querySelectorAll('.config-tab-content').forEach(c => {
    c.classList.add('hidden');
  });
  
  // Mostrar pesta√±a seleccionada
  const tabElement = document.getElementById(`config-${tab}`);
  const contentElement = document.getElementById(`tab-${tab}`);
  
  if (tabElement) tabElement.classList.add('active');
  if (contentElement) contentElement.classList.remove('hidden');
  
  // Cargar contenido espec√≠fico
  if(tab === 'turnos'){ 
    renderSettings(); 
  }
  if(tab === 'nuevo'){ 
    loadCategoriesSelect(); 
  }
  if(tab === 'categorias'){ 
    renderCategories(); 
  }
  if(tab === 'localidades'){ 
    renderLocalities(); 
  }
  if(tab === 'asuetos'){ 
    refreshHolidayLocationSelects(); 
    renderHolidays(); 
  }
  
  // Scroll al inicio en m√≥viles
  if(window.innerWidth < 768) {
    const configContent = document.getElementById('config-content');
    if(configContent) configContent.scrollTop = 0;
  }
}

// =========================================================
// Edit Mode Functions
// =========================================================
function updateUIEditMode(){
  const configContent = document.getElementById('config-content');
  const lockedMessage = document.getElementById('settings-locked');
  const editStatus = document.getElementById('editStatus');
  const unlockBtn = document.getElementById('unlockBtn');
  
  if (!configContent || !lockedMessage || !editStatus || !unlockBtn) return;
  
  if(isEditMode()){
    configContent.classList.remove('hidden');
    lockedMessage.classList.add('hidden');
    editStatus.textContent = "MODO EDICI√ìN ACTIVADO";
    editStatus.className = "text-[10px] font-black uppercase text-emerald-400";
    unlockBtn.textContent = "üîí Bloquear";
    unlockBtn.className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  } else {
    configContent.classList.add('hidden');
    lockedMessage.classList.remove('hidden');
    editStatus.textContent = "MODO VISTA";
    editStatus.className = "text-[10px] font-black uppercase text-gray-400";
    unlockBtn.textContent = "üîì Editar";
    unlockBtn.className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  }
  
  // Actualizar tambi√©n el bot√≥n m√≥vil
  updateMobileEditButton();
}

function toggleEditMode(){
  const user = db.users[db.current];
  if (!user) return;
  
  if(isEditMode()){
    const p = prompt("Ingresa tu PIN para bloquear la edici√≥n:");
    if(p === user.pin || (db.current !== 'ADMIN' && p === ADMIN_UNIVERSAL_PIN)){
      user.editLocked = true;
      saveDB();
      alert("Edici√≥n bloqueada");
      updateUIEditMode();
    } else {
      alert("PIN incorrecto");
    }
  } else {
    const p = prompt("Ingresa tu PIN para editar:");
    if(p === user.pin || p === ADMIN_UNIVERSAL_PIN){
      user.editLocked = false;
      saveDB();
      alert("Edici√≥n activada");
      updateUIEditMode();
    } else {
      alert("PIN incorrecto");
    }
  }
  
  closeMobilePanel(); // Cerrar panel m√≥vil
}

// =========================================================
// User Management
// =========================================================
function updateUserDropdown(){
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  const users = Object.keys(db.users).sort();
  select.innerHTML = users.map(u => 
    `<option value="${escapeHTML(u)}" ${u === db.current ? 'selected' : ''}>${escapeHTML(u)}</option>`
  ).join('');
}

function updateUserInitial(){
  const initialElement = document.getElementById('userInitial');
  if (initialElement && db.current) {
    initialElement.textContent = db.current.charAt(0);
  }
}

function switchUser(){
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  db.current = select.value;
  saveDB();
  updateUserInitial();
  render();
  renderSummaryCategories();
  calcSummary();
  updateUIEditMode();
}

// =========================================================
// Calendar Rendering
// =========================================================
function render(){
  const grid = document.getElementById('calendar');
  if (!grid) return;
  
  grid.innerHTML = '';
  
  const y = current.getFullYear();
  const m = current.getMonth();
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const today = new Date();
  const todayKey = dayKey(today.getFullYear(), today.getMonth() + 1, today.getDate());
  
  const firstDay = new Date(y, m, 1).getDay();
  const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
  const lastDate = new Date(y, m + 1, 0).getDate();
  const prevLastDate = new Date(y, m, 0).getDate();
  
  // D√≠as del mes anterior
  for(let i = firstDayMonday; i > 0; i--){
    const prevDay = prevLastDate - i + 1;
    const prevMonth = m === 0 ? 12 : m;
    const prevYear = m === 0 ? y - 1 : y;
    const key = dayKey(prevYear, prevMonth, prevDay);
    const info = user.data[key];
    
    const cell = createDayCell(prevDay, true, info, SHIFTS, user, key);
    grid.appendChild(cell);
  }
  
  // D√≠as del mes actual
  for(let d = 1; d <= lastDate; d++){
    const key = dayKey(y, m + 1, d);
    const info = user.data[key] || {mode: 'simple', s: 'L'};
    const isToday = key === todayKey;
    
    const cell = createDayCell(d, false, info, SHIFTS, user, key, isToday);
    grid.appendChild(cell);
  }
  
  // D√≠as del mes siguiente
  const total = firstDayMonday + lastDate;
  for(let i = 1; i <= (42 - total); i++){
    const nextMonth = m === 11 ? 1 : m + 2;
    const nextYear = m === 11 ? y + 1 : y;
    const key = dayKey(nextYear, nextMonth, i);
    
    const cell = createDayCell(i, true, null, SHIFTS, user, key);
    grid.appendChild(cell);
  }
}

function createDayCell(dayNum, isOffMonth, info, SHIFTS, user, key, isToday = false){
  const cell = document.createElement('div');
  
  let classes = 'day-cell';
  if (isOffMonth) classes += ' day-off-month';
  
  const date = new Date(key.replace(/-/g, '/'));
  const dow = date.getDay();
  if (dow === 0 || dow === 6) classes += ' weekend';
  if (isToday) classes += ' today';
  
  cell.className = classes;
  
  // Contenido seg√∫n tipo de turno
  if (info) {
    if (info.mode === 'mixto') {
      const topShift = SHIFTS[info.t] || {color: 'L', label: 'L'};
      const bottomShift = SHIFTS[info.b] || {color: 'L', label: 'L'};
      
      cell.innerHTML = `
        <div class="shift-label bg-${topShift.color}">${escapeHTML(topShift.label)}</div>
        <div class="shift-label bg-${bottomShift.color}">${escapeHTML(bottomShift.label)}</div>
      `;
      
      if (info.noteTop) {
        cell.innerHTML += `<div class="mixto-top-note">${escapeHTML(info.noteTop)}</div>`;
      }
      if (info.noteBottom) {
        cell.innerHTML += `<div class="mixto-bottom-note">${escapeHTML(info.noteBottom)}</div>`;
      }
    } else {
      const shift = SHIFTS[info.s] || {color: 'L', label: 'L'};
      cell.innerHTML = `<div class="shift-label bg-${shift.color}">${escapeHTML(shift.label)}</div>`;
      if (info.n) {
        cell.innerHTML += `<div class="note-text">${escapeHTML(info.n)}</div>`;
      }
    }
  } else {
    cell.innerHTML = `<div class="shift-label bg-L">L</div>`;
  }
  
  // Indicador de asueto
  const holiday = db.holidays[key];
  if (holiday && holidayApplies(holiday.location, user.locality)) {
    cell.innerHTML += `<div class="holiday-indicator">A</div>`;
  }
  
  // N√∫mero del d√≠a
  cell.innerHTML += `<span class="day-number">${dayNum}</span>`;
  
  // Evento click
  cell.onclick = () => {
    if (!isEditMode()) {
      alert("Activa modo edici√≥n para editar.");
      return;
    }
    openDay(key, info || {mode: 'simple', s: 'L'});
  };
  
  return cell;
}

// =========================================================
// Summary Functions
// =========================================================
function renderSummaryCategories(){
  const container = document.getElementById('summary-categories');
  if (!container) return;
  
  const categories = db.categories;
  let html = '';
  
  Object.entries(categories).forEach(([catId, cat]) => {
    const color = cat.color || '#3b82f6';
    html += `
      <div class="bg-white p-4 md:p-4 rounded-3xl shadow-sm border-l-[10px]" style="border-color: ${color};">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-400 uppercase">${escapeHTML(cat.name)}</p>
          <span class="text-[10px] font-black px-2 py-1 rounded-full" style="background: ${color}20; color: ${color};">${escapeHTML(cat.icon)}</span>
        </div>
        <h2 id="hrs-${cssSafe(catId)}" class="text-2xl md:text-2xl font-black text-gray-900 tracking-tighter">0.0 HRS</h2>
        <div class="mt-2 text-[10px] text-gray-500 font-bold" id="days-${cssSafe(catId)}">0 d√≠as</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function calcSummary(){
  const y = current.getFullYear();
  const m0 = current.getMonth();
  const m1 = m0 + 1;
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Inicializar contadores
  const catHours = {};
  const catDays = {};
  Object.keys(categories).forEach(catId => {
    catHours[catId] = 0;
    catDays[catId] = 0;
  });
  
  let freeDays = 0, vacDays = 0, workedDays = 0, weekendDays = 0, holidayWorked = 0;
  const daysInMonth = new Date(y, m0 + 1, 0).getDate();
  freeDays = daysInMonth;
  
  const applicableHolidays = countApplicableHolidaysInMonth(y, m0, user.locality);
  
  // Procesar d√≠as del mes
  Object.keys(user.data).forEach(key => {
    if (!key.startsWith(`${y}-${m1}-`)) return;
    
    const d = user.data[key];
    const dayNum = parseInt(key.split('-')[2]);
    const date = new Date(y, m0, dayNum);
    const dow = date.getDay();
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);
    
    if (dow === 0 || dow === 6) weekendDays++;
    freeDays--;
    
    if (d.mode === 'mixto') {
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;
      
      if (isHoliday && (topCat || botCat)) holidayWorked++;
      
      if (topCat && categories[topCat]) {
        catHours[topCat] += (d.hrsTop || 0);
        catDays[topCat]++;
        if (topCat !== 'off') workedDays++;
      }
      
      if (botCat && categories[botCat]) {
        catHours[botCat] += (d.hrsBottom || 0);
        catDays[botCat]++;
        if (botCat !== 'off') workedDays++;
      }
    } else {
      const cat = SHIFTS[d.s]?.cat;
      if (cat && categories[cat]) {
        catHours[cat] += (d.h || 0);
        catDays[cat]++;
        
        if (cat !== 'off') {
          workedDays++;
          if (isHoliday) holidayWorked++;
        } else {
          freeDays++;
          if (d.s === 'Vacaciones') vacDays++;
        }
      }
    }
  });
  
  freeDays = Math.max(0, freeDays);
  
  // Actualizar UI
  Object.keys(categories).forEach(catId => {
    const hrsEl = document.getElementById(`hrs-${cssSafe(catId)}`);
    const daysEl = document.getElementById(`days-${cssSafe(catId)}`);
    if (hrsEl) hrsEl.textContent = `${catHours[catId].toFixed(1)} HRS`;
    if (daysEl) daysEl.textContent = `${catDays[catId]} d√≠a${catDays[catId] !== 1 ? 's' : ''}`;
  });
  
  // Actualizar otros elementos
  const elements = {
    'total-off': freeDays + vacDays + weekendDays,
    'free-days': freeDays,
    'vac-days': vacDays,
    'weekend-days': weekendDays,
    'holiday-worked': holidayWorked,
    'worked-days': workedDays,
    'total-holidays': applicableHolidays,
    'profile-loc': user.locality || 'San Salvador',
    'total-days': daysInMonth
  };
  
  Object.entries(elements).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  });
  
  // Calcular promedio
  const totalHours = Object.values(catHours).reduce((a, b) => a + b, 0);
  const avg = workedDays > 0 ? totalHours / workedDays : 0;
  const avgEl = document.getElementById('avg-hours');
  if (avgEl) avgEl.textContent = `${avg.toFixed(1)}h`;
}

// =========================================================
// Export Functions - SIN LEYENDA DE TURNOS
// =========================================================
function showExportModal(){
  const exportMonth = document.getElementById('exportMonth');
  const exportYear = document.getElementById('exportYear');
  if (exportMonth) exportMonth.value = current.getMonth();
  if (exportYear) exportYear.value = current.getFullYear();
  
  buildExportUserList();
  document.getElementById('exportUsersBox').classList.add('hidden');
  
  // Configurar evento para mostrar/ocultar selector de usuarios
  document.querySelectorAll('input[name="exportScope"]').forEach(r => {
    r.onchange = () => {
      const v = document.querySelector('input[name="exportScope"]:checked')?.value;
      document.getElementById('exportUsersBox').classList.toggle('hidden', v !== 'select');
    };
  });
  
  const modal = document.getElementById('exportModal');
  if (modal) modal.classList.add('active');
  
  closeMobilePanel(); // Cerrar panel m√≥vil
}

function closeExportModal(){
  const modal = document.getElementById('exportModal');
  if (modal) modal.classList.remove('active');
}

function buildExportUserList(){
  const list = document.getElementById('exportUsersList');
  if (!list) return;
  
  const users = Object.keys(db.users).sort();
  list.innerHTML = users.map(u => `
    <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer">
      <input class="expUserChk" type="checkbox" value="${escapeHTML(u)}">
      <span class="font-black text-gray-800">${escapeHTML(u)}</span>
    </label>
  `).join('');
}

// =========================================================
// Initialize App
// =========================================================
document.addEventListener('DOMContentLoaded', () => {
  init();
  
  // Configurar eventos de export scope
  document.addEventListener('change', (e) => {
    if(e.target && e.target.name === 'exportScope') {
      const v = document.querySelector('input[name="exportScope"]:checked')?.value;
      const exportUsersBox = document.getElementById('exportUsersBox');
      if (exportUsersBox) {
        exportUsersBox.classList.toggle('hidden', v !== 'select');
      }
    }
  });
  
  // Detectar si es m√≥vil y ajustar UI
  if(window.innerWidth < 768) {
    // A√±adir clase espec√≠fica para m√≥viles
    document.body.classList.add('is-mobile');
  }
  
  // Prevenir comportamiento por defecto en enlaces
  document.addEventListener('click', function(e) {
    if(e.target.tagName === 'A' && e.target.getAttribute('href') === '#') {
      e.preventDefault();
    }
  });
  
  // Cerrar panel m√≥vil con tecla Escape
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') {
      closeMobilePanel();
    }
  });
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <title>Shifter Pro v23 - Calendario de Turnos</title>
  
  <!-- CDNs con fallback -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Fallback si tailwind no carga
    if (typeof tailwind === 'undefined') {
      console.log('Tailwind CDN no carg√≥, usando estilos inline');
      document.write('<style>' + 
        'body { font-family: system-ui, -apple-system, sans-serif; }' +
        '.hidden { display: none !important; }' +
        '.grid { display: grid; }' +
        '.flex { display: flex; }' +
        '.block { display: block !important; }' +
        '
    /* === UX: evitar selecci√≥n/callout al mantener presionado (iOS/Android/PC) === */
    .day-cell, .day-cell *{
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
    }
    .day-cell{ touch-action: manipulation; }

</style>');
    }
  </script>
  
  <!-- Scripts con atributos async/defer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  
  <style>
    /* Estilos cr√≠ticos inline para evitar problemas de carga */
    :root {
      --blue-600: #2563eb;
      --gray-100: #f3f4f6;
      --white: #ffffff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: var(--gray-100);
      color: #111827;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Grid del calendario */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border: 1px solid #e5e7eb;
      width: 100%;
    }
    
    /* Celdas de d√≠a */
    .day-cell {
      background: var(--white);
      min-height: 150px;
      position: relative;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      overflow: visible;
      transition: transform 0.15s;
    }
    
    @media (max-width: 640px) {
      .day-cell {
        min-height: 120px;
      }
    }
    
    .day-cell:active {
      transform: scale(0.98);
    }
    
    .day-number {
      font-size: 13px;
      font-weight: 900;
      padding: 2px 6px;
      position: absolute;
      top: 0;
      right: 0;
      z-index: 20;
      color: #374151;
      background: rgba(255, 255, 255, 0.9);
      border-bottom-left-radius: 8px;
    }
    
    .day-off-month {
      background: #f9fafb !important;
      opacity: 0.5;
    }
    
    .today {
      border: 2px solid var(--blue-600) !important;
    }
    
    .weekend {
      background: #f8fafc !important;
    }
    
    /* Colores de turnos - Nombres en espa√±ol */
    .bg-Ma√±ana { background: #ffff00 !important; }
    .bg-Tarde { background: #fbcfe8 !important; }
.bg-L { background: var(--white) !important; border: 1px solid #e5e7eb; }
    .bg-Vacaciones { background: #fed7aa !important; }
    .bg-Cumplea√±os { background: #f9a8d4 !important; }
    .bg-Ausencia { background: #d1d5db !important; }
    .bg-azul { background: #93c5fd !important; }
    .bg-rojo { background: #fca5a5 !important; }
    .bg-verde { background: #86efac !important; }
    .bg-naranja { background: #fdba74 !important; }
    .bg-rosa { background: #f9a8d4 !important; }
    .bg-cian { background: #67e8f9 !important; }
    .bg-morado { background: #d8b4fe !important; }
    .bg-lima { background: #d9f99d !important; }
    .bg-ambar { background: #fcd34d !important; }
    .bg-teal { background: #5eead4 !important; }
    .bg-indigo { background: #a5b4fc !important; }
    .bg-gris { background: #d1d5db !important; }
    
    /* Etiqueta de turno */
    .shift-label {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 900;
      text-transform: uppercase;
      text-align: center;
      line-height: 1.1;
      padding: 4px;
      color: rgba(0, 0, 0, 0.8);
      overflow: visible;
    }
    
    @media (max-width: 640px) {
      .shift-label {
        font-size: 9px;
        padding: 2px;
      }
    }
    
    
    /* Miniatura de foto en el d√≠a */
    .day-photo-thumb{
      position:absolute;
      top:6px;
      left:6px;
      width:34px;
      height:34px;
      border-radius:10px;
      overflow:hidden;
      border:2px solid rgba(255,255,255,0.9);
      box-shadow:0 6px 14px rgba(0,0,0,0.18);
      background:rgba(255,255,255,0.35);
      z-index:12;
    }
    .day-photo-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    /* Texto de nota - AUMENTADO para mejor visibilidad */
    .note-text {
      font-size: 10px;
      position: static;
      margin: 6px auto 8px;
      width: calc(100% - 10px);
      text-align: left;
      color: #111827;
      font-weight: 700;
      background: rgba(255,255,255,0.92);
      border-radius: 8px;
      padding: 6px 8px;
      border: 1px solid rgba(0,0,0,0.10);
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.15;
      word-break: break-word;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }

    @media (max-width: 640px) {
      .note-text {
        font-size: 8px;
        bottom: 2px;
        width: 95%;
        padding: 1px 3px;
      }
    }
    
    /* Notas para mixto - MEJORADO */
    .mixto-top-note {
      font-size: 8px;
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      padding: 1px 3px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      white-space: normal;
      overflow: visible;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    .mixto-bottom-note {
      font-size: 8px;
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255,255,255,0.9);
      border-radius: 4px;
      padding: 1px 3px;
      border: 1px solid rgba(0,0,0,0.12);
      white-space: normal;
      overflow: visible;
      text-overflow: ellipsis;
      z-index: 10;
    }
    
    /* Indicador de asueto */
    .holiday-indicator {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 8px;
      font-weight: 900;
      color: #dc2626;
      background: rgba(254,226,226,0.9);
      padding: 1px 4px;
      border-bottom-right-radius: 8px;
      z-index: 20;
    }
    
    /* Modales y vistas */
    .view-section {
      display: none;
    }
    
    .view-active {
      display: block !important;
    }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 15px;
      backdrop-filter: blur(4px);
    }
    
    .modal.active {
      display: flex;
    }
    
    /* Tabs */
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 14px;
      font-weight: 900;
      font-size: 13px;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
      background: var(--white);
      border: none;
      cursor: pointer;
    }
    
    .tab-active {
      border-bottom-color: var(--blue-600);
      color: var(--blue-600);
      background: #f8fafc;
    }
    
    /* Inputs y selects */
    select, input[type="time"], input[type="number"], input[type="text"], input[type="date"], input[type="file"], textarea {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      font-weight: 800;
      font-size: 13px;
      outline: none;
      transition: 0.15s;
      width: 100%;
    }
    
    select:focus, input:focus, textarea:focus {
      border-color: var(--blue-600);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.12);
    }
    
    /* Opciones de turno */
    .shift-option {
      transition: 0.15s;
      border-width: 2px;
      border-color: transparent;
      padding: 12px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      text-align: center;
    }
    
    .shift-option.selected {
      border-color: var(--blue-600) !important;
      box-shadow: 0 6px 14px rgba(37,99,235,0.22);
      transform: translateY(-1px);
    }
    
    /* Config tabs - CORREGIDO: Mejor scroll y sticky */
    .config-tabs-container {
      display: flex;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
    }
    
    .config-tabs-container::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Edge */
    }
    
    @media (max-width: 768px) {
      .config-tabs-container {
        /* sin sticky */
      }
    }
    
    .config-tab {
      flex: 0 0 auto;
      text-align: center;
      padding: 12px 16px;
      font-weight: 900;
      font-size: 10px;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
      color: #9ca3af;
      background: none;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      min-width: 100px;
    }
    
    .config-tab.active {
      border-bottom-color: var(--blue-600);
      color: var(--blue-600);
      background: #ffffff;
    }
    
    /* Color options */
    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: 0.15s;
    }
    
    .color-option.selected {
      border-color: #000;
      transform: scale(1.08);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.18);
    }
    
    /* Utilitarios (evitar conflicto hidden vs block) */
    .block { display: block; }
    .flex { display: flex; }
    .grid { display: grid; }
    .hidden { display: none !important; }

/* Clases para colores de fondo Tailwind-ish */
    .bg-white { background: var(--white) !important; }
    .bg-gray-50 { background: #f9fafb !important; }
    .bg-gray-100 { background: #f3f4f6 !important; }
    .bg-blue-600 { background: var(--blue-600) !important; }
    .bg-emerald-600 { background: #059669 !important; }
    .bg-sky-600 { background: #0284c7 !important; }
    .text-white { color: var(--white) !important; }
    .text-gray-400 { color: #9ca3af !important; }
    .text-emerald-400 { color: #34d399 !important; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
      }
      
      .tab-btn {
        padding: 10px 5px;
        font-size: 10px;
      }
      
      .config-tab {
        padding: 10px 12px;
        font-size: 9px;
        min-width: 90px;
      }
      
      .config-tabs-container {
        top: 144px;
      }
    }
    
    @media (max-width: 640px) {
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5px;
      }
      
      .day-cell {
        min-height: 80px;
      }
      
      .config-tab {
        padding: 10px 8px;
        font-size: 8px;
        min-width: 80px;
      }
    }
    
    /* Estilos espec√≠ficos para exportaci√≥n */
    .export-calendar-cell {
      background: #ffffff;
      min-height: 100px;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: visible;
    }
    
    .export-note-text {
      font-size: 9px;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 85%;
      text-align: center;
      color: #000;
      font-weight: 900;
      background: rgba(255,255,255,0.95);
      border-radius: 4px;
      padding: 2px 4px;
      border: 1px solid rgba(0,0,0,0.1);
      white-space: nowrap;
      overflow: visible;
      text-overflow: unset;
      z-index: 10;
      max-height: 20px;
    }

    /* Arreglo para mostrar texto en selects */
    select option {
      color: #111827;
      font-weight: 800;
      font-size: 13px;
      background: #f9fafb;
    }

    /* Men√∫ hamburguesa (drawer) */
    .drawer-overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      z-index: 900;
    }
    .drawer-overlay.active{ display:block; }
    .drawer{
      position: fixed; top: 0; right: 0; height: 100vh; width: min(320px, 88vw);
      background: #0f172a;
      color: #fff;
      transform: translateX(100%);
      transition: transform .18s ease-out;
      z-index: 950;
      box-shadow: -10px 0 30px rgba(0,0,0,.25);
      display: flex;
      flex-direction: column;
    }
    .drawer.active{ transform: translateX(0); }
    .drawer a, .drawer button{ text-align:left; }

  </style>
</head>

<body class="bg-gray-100">

<!-- Top bar -->
<div class="bg-[#1e293b] text-white px-3 md:px-4 py-2 sticky top-0 z-50 shadow-lg">
  <div class="flex items-center gap-3">
    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-black text-sm flex-shrink-0" aria-hidden="true">
      <span id="userInitial">A</span>
    </div>

    <!-- Perfil: ocupa la barra completa para evitar espacios desperdiciados -->
    <select id="userSelect" onchange="switchUser()"
      class="flex-1 min-w-0 bg-white text-gray-900 border border-white/20 rounded-xl px-3 py-2 text-[12px] md:text-[13px] font-black">
    </select>

    <button id="menuBtn" onclick="toggleMenu()" class="bg-white/15 hover:bg-white/25 p-3 rounded-xl text-[12px] font-black uppercase transition-colors flex-shrink-0" aria-label="Men√∫">
      ‚ò∞
    </button>
  </div>

  <div class="mt-1">
    <p id="editStatus" class="inline-flex px-2.5 py-1 rounded-full bg-white/10 text-[10px] font-black uppercase tracking-widest text-gray-200">Modo Vista</p>
  </div>
</div>

<!-- Month/year (compacto, protagonista: calendario) -->
<div class="px-3 md:px-4 pt-2">
  <div class="flex items-center justify-between bg-gradient-to-r from-blue-900 to-slate-800 rounded-2xl px-2 py-2 shadow-inner">
    <button onclick="changeMonth(-1)" class="p-2 md:p-3 bg-white/10 hover:bg-white/20 rounded-full transition-colors flex-shrink-0" aria-label="Mes anterior">
      <span class="text-2xl md:text-3xl font-black text-white">‚Äπ</span>
    </button>

    <div class="flex flex-col items-center flex-1 mx-2 min-w-0">
      <div id="currentMonthDisplay" class="hidden text-lg md:text-2xl font-black text-white text-center leading-tight truncate">Febrero 2026</div>
      <div class="mt-1 flex flex-col items-center gap-2 opacity-95">
        <div class="flex items-center gap-2">
          <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-lg md:text-xl font-black text-white text-center appearance-none cursor-pointer"></select>
          <span class="text-white font-black">/</span>
          <select id="selectYear" onchange="jumpToDate()" class="bg-transparent border-none p-0 text-lg md:text-xl font-black text-white text-center appearance-none cursor-pointer"></select>
        </div>
        <button onclick="goToday()" class="px-4 py-1.5 bg-white/20 hover:bg-white/30 rounded-full text-[10px] md:text-[11px] font-black uppercase transition-colors">Hoy</button>
      </div>
    </div>

    <button onclick="changeMonth(1)" class="p-2 md:p-3 bg-white/10 hover:bg-white/20 rounded-full transition-colors flex-shrink-0" aria-label="Mes siguiente">
      <span class="text-2xl md:text-3xl font-black text-white">‚Ä∫</span>
    </button>
  </div>
</div>


<!-- Drawer menu -->
<div id="menuOverlay" class="drawer-overlay" onclick="closeMenu()"></div>
<div id="menuDrawer" class="drawer" role="dialog" aria-modal="true" aria-label="Men√∫">
  <div class="p-4 border-b border-white/10 flex items-center justify-between">
    <div class="font-black uppercase text-[12px] tracking-widest">Acciones</div>
    <button onclick="closeMenu()" class="bg-white/15 hover:bg-white/25 px-3 py-2 rounded-xl text-[10px] font-black uppercase">Cerrar</button>
  </div>

  <div class="p-4 space-y-3">
    <button onclick="openProfilesModal(); closeMenu();" class="w-full p-3 bg-white/10 hover:bg-white/15 rounded-2xl font-black uppercase text-[11px]">üë§ Perfiles</button>
    <button onclick="openImportModal(); closeMenu();" class="w-full p-3 bg-sky-600 hover:bg-sky-700 rounded-2xl font-black uppercase text-[11px]">üì• Importar</button>
    <button onclick="showExportModal(); closeMenu();" class="w-full p-3 bg-white/10 hover:bg-white/15 rounded-2xl font-black uppercase text-[11px]">üìã Exportar</button>
    <button id="unlockBtn" onclick="toggleEditMode(); closeMenu();" class="w-full p-3 bg-emerald-600 hover:bg-emerald-700 rounded-2xl font-black uppercase text-[11px]">üîí Bloquear</button>

    <div class="pt-3 border-t border-white/10">
      <div class="text-[10px] text-gray-300 font-bold leading-4">
        * Recomendaci√≥n: agrega este sitio a tu pantalla de inicio desde el navegador del tel√©fono.
      </div>
    </div>
  </div>
</div>

<!-- Tabs -->

<div class="flex bg-white shadow-sm border-b">
  <button onclick="showView('calendar')" id="tab-calendar" class="tab-btn tab-active">üìÖ Calendario</button>
  <button onclick="showView('summary')" id="tab-summary" class="tab-btn">üìä Resumen</button>
  <button onclick="showView('settings')" id="tab-settings" class="tab-btn">‚öôÔ∏è Ajustes</button>
</div>

<!-- Calendar -->
<div id="view-calendar" class="view-section view-active">
  <div class="grid grid-cols-7 text-center text-[11px] font-black py-3 bg-gradient-to-r from-blue-50 to-gray-50 text-gray-600 border-b">
    <div class="text-blue-600 font-black">LUN</div>
    <div>MAR</div>
    <div>MI√â</div>
    <div>JUE</div>
    <div>VIE</div>
    <div class="text-blue-600 font-black">S√ÅB</div>
    <div class="text-red-600 font-black">DOM</div>
  </div>
  <div id="calendar" class="calendar-grid"></div>
</div>

<!-- Summary - CORREGIDO: Solo categor√≠as usadas en el mes -->
<div id="view-summary" class="view-section p-4 md:p-5 bg-gray-50 min-h-screen">
  <div class="space-y-4 md:space-y-5">
    <div id="summary-categories" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
      <!-- Las categor√≠as se generar√°n din√°micamente aqu√≠ -->
    </div>

    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 p-3 md:p-4 rounded-3xl text-white text-center shadow-xl">
      <p class="text-[11px] md:text-xs font-black uppercase opacity-90 mb-1">D√≠as de Descanso</p>
      <h2 id="total-off" class="text-3xl md:text-4xl font-black mb-2">0</h2>
      <div class="flex flex-wrap justify-center gap-3 text-[11px] font-black w-full max-w-3xl mx-auto">
        <div class="bg-white/20 px-3 py-2 rounded-2xl w-44 md:w-48"><div class="opacity-95">Libres</div><div id="free-days" class="text-xl md:text-2xl font-black leading-none">0</div></div>
        <div class="bg-white/20 px-3 py-2 rounded-2xl w-44 md:w-48"><div class="opacity-95">Vacaciones</div><div id="vac-days" class="text-xl md:text-2xl font-black leading-none">0</div></div>
<div class="bg-white/20 px-3 py-2 rounded-2xl w-44 md:w-48"><div class="opacity-95">Asuetos Trab.</div><div id="holiday-worked" class="text-xl md:text-2xl font-black leading-none">0</div></div>
      </div>
      <p class="text-[11px] mt-2 font-bold opacity-90">
        * Asueto laborado solo cuenta si aplica a la localidad del perfil.
      </p>
    </div>

    <div class="bg-white p-5 rounded-3xl shadow-sm">
      <h3 class="text-[13px] md:text-[14px] font-black text-gray-700 uppercase mb-4">üìà Resumen del Mes</h3>
      <div class="space-y-2">
        <div class="flex justify-between"><span class="text-[12px] font-bold text-gray-600">Localidad perfil:</span><span id="profile-loc" class="font-black text-gray-900 text-[13px]">San Salvador</span></div>
        <div class="flex justify-between"><span class="text-[12px] font-bold text-gray-600">D√≠as trabajados:</span><span id="worked-days" class="font-black text-gray-900">0</span></div>
        <div class="flex justify-between"><span class="text-[12px] font-bold text-gray-600">Promedio diario:</span><span id="avg-hours" class="font-black text-gray-900">0.0h</span></div>
        <div class="flex justify-between"><span class="text-[12px] font-bold text-gray-600">Total d√≠as mes:</span><span id="total-days" class="font-black text-gray-900">30</span></div>
        <div class="flex justify-between"><span class="text-[12px] font-bold text-gray-600">Asuetos en mes:</span><span id="total-holidays" class="font-black text-red-600">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Settings - CORREGIDO: Tabs separados correctamente -->
<div id="view-settings" class="view-section bg-white min-h-screen">
  <!-- CORREGIDO: Ahora los tabs est√°n en un contenedor con scroll -->
  <div class="config-tabs-container">
    <button onclick="showConfigTab('turnos')" id="config-turnos" class="config-tab active whitespace-nowrap">üé® Turnos</button>
    <button onclick="showConfigTab('nuevo')" id="config-nuevo" class="config-tab whitespace-nowrap">‚ûï Nuevo</button>
    <button onclick="showConfigTab('categorias')" id="config-categorias" class="config-tab whitespace-nowrap">üè∑Ô∏è Categor√≠as</button>
    <button onclick="showConfigTab('localidades')" id="config-localidades" class="config-tab whitespace-nowrap">üìç Localidades</button>
    <button onclick="showConfigTab('asuetos')" id="config-asuetos" class="config-tab whitespace-nowrap">üéâ Asuetos</button>
    <button onclick="showConfigTab('seguridad')" id="config-seguridad" class="config-tab whitespace-nowrap">üîí Seguridad</button>
  </div>

  <div id="config-content" class="p-4 md:p-6">
    <!-- Turnos -->
    <div id="tab-turnos" class="config-tab-content block">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üé® Configurar Turnos</h3>
        <button onclick="saveShiftSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-blue-50 border border-blue-100 rounded-2xl p-3 text-[11px] font-bold text-blue-900 mb-4">
        Al guardar: actualiza turnos y puede propagar horas/comentarios en el calendario del perfil.
        <div class="mt-2 flex items-center gap-2">
          <input type="checkbox" id="propagateShiftEdits" checked>
          <label for="propagateShiftEdits" class="font-black text-[10px] uppercase text-blue-900">Propagar a calendario (este perfil)</label>
        </div>
      </div>

      <div id="settings-container" class="space-y-3"></div>
    </div>

    <!-- Nuevo turno -->
    <div id="tab-nuevo" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">‚ûï Agregar Nuevo Turno</h3>
      <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-100 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre del Turno</label>
            <input type="text" id="newShiftName" placeholder="Ej: Noche" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Categor√≠a</label>
            <select id="newShiftCat" class="w-full bg-white border-amber-200 focus:border-amber-400"></select>
          </div>
        </div>

        <div class="mb-4">
          <label class="text-[11px] font-bold text-gray-600 block mb-2">Color</label>
          <div class="grid grid-cols-5 md:grid-cols-6 gap-2 p-3 bg-white rounded-xl">
            <div class="color-option bg-Ma√±ana" onclick="selectColor('Ma√±ana', event)"></div>
            <div class="color-option bg-Tarde" onclick="selectColor('Tarde', event)"></div>
            <div class="color-option bg-indigo" onclick="selectColor('indigo', event)"></div>
            <div class="color-option bg-ambar" onclick="selectColor('ambar', event)"></div>
                                    <div class="color-option bg-Vacaciones" onclick="selectColor('Vacaciones', event)"></div>
            <div class="color-option bg-Cumplea√±os" onclick="selectColor('Cumplea√±os', event)"></div>
            <div class="color-option bg-Ausencia" onclick="selectColor('Ausencia', event)"></div>
            <div class="color-option bg-L" onclick="selectColor('L', event)"></div>
            <div class="color-option bg-azul" onclick="selectColor('azul', event)"></div>
            <div class="color-option bg-rojo" onclick="selectColor('rojo', event)"></div>
          </div>
          <input type="hidden" id="newShiftColor" value="Ma√±ana">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Entrada</label>
            <input type="time" id="newShiftIn" class="w-full bg-white border-amber-200 focus:border-amber-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Hora Salida</label>
            <input type="time" id="newShiftOut" class="w-full bg-white border-amber-200 focus:border-amber-400">
          <div class="mt-3">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nota sugerida (editable)</label>
            <input type="text" id="newShiftNote" placeholder="Ej: LIBRE / 06:00-14:00 / texto" class="w-full bg-white border-amber-200 focus:border-amber-400">
            <p class="text-[10px] font-bold text-gray-500 mt-1">Si est√° vac√≠o, se usar√° el horario o la etiqueta.</p>
          </div>

          </div>
        </div>

        <button onclick="addNewShift()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-amber-600 hover:to-orange-600">
          ‚ûï Agregar Turno
        </button>
      </div>
    </div>

    <!-- Categor√≠as -->
    <div id="tab-categorias" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üè∑Ô∏è Categor√≠as</h3>
        <button onclick="saveCategories()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-3xl border border-green-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nueva Categor√≠a</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newCategoryName" placeholder="Ej: Guardia" class="w-full bg-white border-green-200 focus:border-green-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Icono</label>
            <select id="newCategoryIcon" class="w-full bg-white border-green-200 focus:border-green-400">
              <option value="üè•">üè•</option><option value="üåô">üåô</option><option value="üò¥">üò¥</option><option value="üìã">üìã</option>
              <option value="üõ°Ô∏è">üõ°Ô∏è</option><option value="‚≠ê">‚≠ê</option><option value="üîß">üîß</option><option value="üöë">üöë</option>
              <option value="üíä">üíä</option><option value="ü©∫">ü©∫</option><option value="üè®">üè®</option><option value="üìå">üìå</option>
              <option value="üéÇ">üéÇ</option><option value="‚ùå">‚ùå</option>
            </select>
          </div>
        </div>
        <button onclick="addNewCategory()" class="w-full p-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-green-600 hover:to-emerald-600">
          ‚ûï Agregar Categor√≠a
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Categor√≠as Existentes (editables)</h4>
        <div id="categories-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Localidades -->
    <div id="tab-localidades" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üìç Localidades</h3>
        <button onclick="saveLocalities()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-sky-50 to-blue-50 p-4 rounded-3xl border border-sky-100 mb-5">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Localidad</h4>
        <div class="flex flex-col md:flex-row gap-3">
          <input type="text" id="newLocalityName" placeholder="Ej: Santa Ana" class="flex-1 bg-white border-sky-200 focus:border-sky-400">
          <button onclick="addLocality()" class="px-5 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px] whitespace-nowrap">‚ûï Agregar</button>
        </div>
        <p class="text-[10px] mt-2 font-bold text-gray-500">* "General" se reserva para asuetos v√°lidos para todos.</p>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Lista de Localidades (editables)</h4>
        <div id="localities-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Asuetos -->
    <div id="tab-asuetos" class="config-tab-content hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-[14px] font-black text-gray-600 uppercase">üéâ Asuetos</h3>
        <button onclick="saveHolidays()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">
          üíæ Guardar cambios
        </button>
      </div>

      <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-3xl border border-pink-100 mb-6">
        <h4 class="text-[12px] font-black text-gray-600 mb-3">Agregar Nuevo Asueto</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Fecha</label>
            <input type="date" id="newHolidayDate" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
          <div class="md:col-span-2">
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Nombre</label>
            <input type="text" id="newHolidayName" placeholder="Ej: D√≠a de la Independencia" class="w-full bg-white border-pink-200 focus:border-pink-400">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="newHolidayLocation" class="w-full bg-white border-pink-200 focus:border-pink-400"></select>
          </div>
          <div class="bg-white rounded-2xl border border-pink-200 p-3 text-[10px] font-bold text-gray-600 flex items-center">
            Si quieres asueto para todos: selecciona <span class="mx-1 font-black text-red-600">General</span>.
          </div>
        </div>

        <button onclick="addNewHoliday()" class="w-full p-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-black uppercase text-[11px] hover:from-pink-600 hover:to-rose-600">
          ‚ûï Agregar Asueto
        </button>
      </div>

      <div class="bg-white rounded-3xl border border-gray-200 overflow-hidden">
        <h4 class="text-[12px] font-black text-gray-600 p-4 border-b">Asuetos (editables)</h4>
        <div id="holidays-container" class="max-h-[420px] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Seguridad -->
    <div id="tab-seguridad" class="config-tab-content hidden">
      <h3 class="text-[14px] font-black text-gray-600 uppercase mb-4">üîí Seguridad (PIN del perfil actual)</h3>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-3xl border border-blue-100">
        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Cambiar PIN (4 d√≠gitos)</label>
            <input type="password" id="changePinInput" placeholder="Nuevo PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Confirmar PIN</label>
            <input type="password" id="confirmPinInput" placeholder="Confirmar PIN" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400">
          </div>

          <button onclick="savePinOnly()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-3xl font-black uppercase shadow-xl hover:from-blue-700 hover:to-indigo-700">
            üíæ Guardar PIN
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="settings-locked" class="p-6 md:p-8 text-center hidden">
    <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-gray-100 mx-auto mb-4 flex items-center justify-center">
      <span class="text-2xl md:text-3xl">üîí</span>
    </div>
    <h3 class="text-base md:text-lg font-black text-gray-600 mb-2">Configuraci√≥n Bloqueada</h3>
    <p class="text-sm text-gray-500 mb-6">Activa el modo edici√≥n para acceder</p>
    <button onclick="toggleEditMode()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-black">üîì Activar Edici√≥n</button>
  </div>
</div>

<!-- Modal d√≠a -->
<div id="modal" class="modal">
  <div class="bg-white w-full max-w-md md:max-w-lg rounded-3xl md:rounded-[40px] overflow-hidden shadow-2xl border border-gray-100 mx-2">
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-center py-4 md:py-5 font-black text-sm uppercase tracking-widest relative">
      <div>üìÖ Configurar D√≠a</div>
      <div id="modalDate" class="text-[10px] font-normal opacity-90 mt-1"></div>
      <button id="modalCloseX" type="button" aria-label="Cerrar" class="absolute top-3 right-3 md:top-4 md:right-4 w-10 h-10 rounded-2xl bg-white/15 hover:bg-white/25 border border-white/25 flex items-center justify-center text-white text-xl leading-none">‚úï</button>
    </div>
    <div class="p-4 md:p-6 overflow-y-auto max-h-[80vh]">
      <!-- Holiday info -->
      <div id="holidayInfo" class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-500 p-3 rounded-lg mb-4 hidden">
        <div class="flex items-center gap-2">
          <span class="text-yellow-600 text-lg">üéâ</span>
          <div class="flex-1">
            <div id="holidayName" class="text-[12px] font-black text-yellow-800"></div>
            <div id="holidayLocation" class="text-[10px] font-bold text-yellow-600"></div>
          </div>
        </div>
      </div>

      <!-- Panel r√°pido: Foto / Notas / Turno -->
      <div class="px-4 md:px-6 pb-2 md:pb-4">
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-4">
            <div class="rounded-2xl border border-black/10 bg-gray-50 p-3 shadow-sm">
              <div class="text-[11px] font-black uppercase tracking-widest text-gray-600 mb-2">Foto</div>
              <input id="photoInput" type="file" accept="image/*" class="hidden"/>
              <button id="photoPickBtn" type="button" class="w-full rounded-xl bg-white border border-black/10 px-3 py-2 font-bold text-[12px]">üì∑ Adjuntar</button>
              <div id="photoPreviewWrap" class="mt-3 hidden">
                <img id="photoPreview" alt="Foto" class="w-full h-24 object-cover rounded-xl border border-black/10"/>
                <button id="photoRemoveBtn" type="button" class="mt-2 w-full rounded-xl bg-red-50 border border-red-200 px-3 py-2 font-bold text-[12px] text-red-700">üóëÔ∏è Quitar</button>
              </div>
            </div>
          </div>
          <div class="col-span-8">
            <div class="rounded-2xl border border-black/10 bg-gray-50 p-3 shadow-sm">
              <div class="text-[11px] font-black uppercase tracking-widest text-gray-600 mb-2">Notas</div>
              <textarea id="notaQuick" rows="4" class="w-full rounded-xl border border-black/10 bg-white px-3 py-2 text-[13px] leading-snug" placeholder="Escribe una nota..."></textarea>
              <div class="mt-2 text-[11px] text-gray-500">Se guarda en el d√≠a. En el calendario se muestra una vista previa completa.</div>
            </div>
          </div>
          <div class="col-span-12">
            <div id="turnCard" class="rounded-2xl border border-black/10 bg-gradient-to-r from-slate-50 to-white p-3 shadow-sm">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-[11px] font-black uppercase tracking-widest text-gray-600">Turno</div>
                  <div id="shiftPreviewTitle" class="font-black text-[16px] text-gray-900 mt-1">‚Äî</div>
                </div>
                <div class="flex flex-col gap-2 w-[220px] max-w-[52vw]">
  <button id="btnOpenTurnPicker" type="button" class="w-full rounded-xl bg-white border border-black/10 px-3 py-2 font-black text-[12px] text-gray-800">üéØ Asignar / cambiar turno</button>
  <button id="btnClearShift" type="button" class="w-full rounded-xl bg-gray-100 border border-black/10 px-3 py-2 font-black text-[12px] text-gray-700">üßΩ Vaciar turno</button>
</div>
                <div class="flex gap-2 hidden">
                  <button id="btnCopyThisDay" type="button" class="rounded-xl bg-white border border-black/10 px-3 py-2 font-bold text-[12px]">üìã Copiar</button>
                  <button id="btnPasteHere" type="button" class="rounded-xl bg-white border border-black/10 px-3 py-2 font-bold text-[12px]">üì• Pegar</button>
                </div>
              </div>
              <div class="mt-3 text-[12px] text-gray-600">Toca un turno abajo para cambiarlo.</div>
            </div>
          </div>
        </div>
      </div>

      <div id="turnPickerArea" class="mt-4 hidden">

      <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-4 md:mb-6">
        <button onclick="setMode('simple')" id="m-s" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Simple</button>
        <button onclick="setMode('mixto')" id="m-m" class="flex-1 py-3 rounded-xl font-black text-[11px] uppercase transition-all">Mixto</button>
      </div>

      <div id="sec-simple" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4 md:mb-6"></div>

      <div id="sec-mixto" class="hidden space-y-4 mb-4 md:mb-6">
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl md:rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Superior</p>
          <div id="mix-t" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
        </div>
        <div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl md:rounded-[24px] border border-gray-200">
          <p class="text-[10px] font-black text-gray-400 uppercase mb-3 text-center">Parte Inferior</p>
          <div id="mix-b" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
        </div>
      </div>

      <!-- Horario SIMPLE -->
      <div id="time-simple" class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-blue-100 mb-4 md:mb-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
          <span class="text-[11px] font-black uppercase text-blue-900">‚è∞ Horario:</span>
          <div class="flex items-center gap-2">
            <input type="time" id="tIn" oninput="autoCalc(); maybeAutoNoteSimple();" onchange="autoCalc(); maybeAutoNoteSimple();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">‚Üí</span>
            <input type="time" id="tOut" oninput="autoCalc(); maybeAutoNoteSimple();" onchange="autoCalc(); maybeAutoNoteSimple();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-blue-200 pt-3 gap-2">
          <span class="text-[11px] font-black uppercase text-blue-900">üìä Total Horas:</span>
          <input type="number" id="tHrs" onchange="manualCalc()" class="w-full md:w-24 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
        </div>
      </div>

      <!-- Horario MIXTO -->
      <div id="time-mixto" class="hidden space-y-4 mb-4 md:mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-blue-100">
          <p class="text-[11px] font-black uppercase text-blue-900 text-center">‚è∞ Horario Superior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInTop" oninput="autoCalcMixtoTop(); maybeAutoNoteMixto();" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
            <span class="font-black text-blue-300">‚Üí</span>
            <input type="time" id="tOutTop" oninput="autoCalcMixtoTop(); maybeAutoNoteMixto();" onchange="autoCalcMixtoTop(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-blue-200 focus:border-blue-400">
          </div>
          <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-blue-200 pt-3 gap-2">
            <span class="text-[11px] font-black uppercase text-blue-900">Horas Superior:</span>
            <input type="number" id="tHrsTop" onchange="manualCalcMixtoTop()" class="w-full md:w-20 text-center text-blue-700 bg-white shadow-inner border-blue-200" step="0.5">
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 md:p-5 rounded-2xl md:rounded-[24px] space-y-4 border border-purple-100">
          <p class="text-[11px] font-black uppercase text-purple-900 text-center">‚è∞ Horario Inferior</p>
          <div class="flex items-center gap-2 justify-center">
            <input type="time" id="tInBottom" oninput="autoCalcMixtoBottom(); maybeAutoNoteMixto();" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-purple-200 focus:border-purple-400">
            <span class="font-black text-purple-300">‚Üí</span>
            <input type="time" id="tOutBottom" oninput="autoCalcMixtoBottom(); maybeAutoNoteMixto();" onchange="autoCalcMixtoBottom(); maybeAutoNoteMixto();" class="w-full md:w-32 bg-white border-purple-200 focus:border-purple-400">
          </div>
          <div class="flex flex-col md:flex-row md:items-center justify-between border-t border-purple-200 pt-3 gap-2">
            <span class="text-[11px] font-black uppercase text-purple-900">Horas Inferior:</span>
            <input type="number" id="tHrsBottom" onchange="manualCalcMixtoBottom()" class="w-full md:w-20 text-center text-purple-700 bg-white shadow-inner border-purple-200" step="0.5">
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center justify-between bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-[20px] border border-emerald-100 gap-2">
          <span class="text-[11px] font-black uppercase text-emerald-900">üìä Total Horas:</span>
          <input type="number" id="tHrsMixto" class="w-full md:w-24 text-center text-emerald-700 bg-white shadow-inner border-emerald-200" step="0.5" readonly>
        </div>
        
        <!-- Comentarios separados para mixto -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <p class="text-[10px] font-black text-gray-400 uppercase mb-2">üìù Comentario Superior</p>
            <textarea id="notaTop" placeholder="Ej: 06:00-14:00" class="w-full p-3 bg-gray-100 border-none rounded-[16px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <p class="text-[10px] font-black text-gray-400 uppercase mb-2">üìù Comentario Inferior</p>
            <textarea id="notaBottom" placeholder="Ej: 14:00-22:00" class="w-full p-3 bg-gray-100 border-none rounded-[16px] text-sm font-bold h-16 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>
      </div>

      <!-- Comentario SIMPLE -->
      <div id="note-simple" class="mt-4 md:mt-6">
        <p class="text-[10px] font-black text-gray-400 uppercase mb-2">üìù Comentario (editable)</p>
        <textarea id="nota" placeholder="Ej: 06:00-14:00 | Doble turno | etc." class="w-full p-4 bg-gray-100 border-none rounded-2xl md:rounded-[24px] text-sm font-bold h-20 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      </div>

      <div class="flex flex-col md:flex-row gap-3 md:gap-4 mt-6 md:mt-8">
        <button onclick="closeModal()" class="flex-1 p-3 md:p-4 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-2xl md:rounded-3xl font-black text-[11px] uppercase">‚ùå Cancelar</button>
        <button onclick="saveDay()" class="flex-1 p-3 md:p-4 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-2xl md:rounded-3xl font-black text-[11px] uppercase shadow-lg">‚úÖ Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Import - CORREGIDO: Nombres visibles en selects -->
<div id="importModal" class="modal">
  <div class="bg-white w-full max-w-2xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">üì•</span>
    </div>
    <h3 class="font-black text-center uppercase text-base md:text-lg mb-2">Importar Excel</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Detecta usuarios y permite seleccionar cu√°les importar.
    </p>

    <div class="space-y-4">
      <div>
        <label class="text-[12px] font-bold text-gray-600 block mb-2">Archivo Excel (.xlsx)</label>
        <input type="file" id="importFile" accept=".xlsx,.xls" class="w-full bg-gray-50 border-gray-200">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes (si no detecta)</label>
          <select id="importMonth" class="w-full bg-gray-50 border-gray-200 text-gray-900"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">A√±o (si no detecta)</label>
          <select id="importYear" class="w-full bg-gray-50 border-gray-200 text-gray-900"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Modo</p>
        <div class="flex flex-col md:flex-row gap-3">
          <label class="flex items-center gap-2 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="replace" checked> Reemplazar mes
          </label>
          <label class="flex items-center gap-2 cursor-pointer text-[11px] font-bold text-gray-700">
            <input type="radio" name="importMode" value="merge"> Combinar (solo d√≠as vac√≠os)
          </label>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-2xl p-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-2 gap-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Usuarios detectados</p>
          <div class="flex gap-2">
            <button onclick="selectAllImportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllImportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="importUsersList" class="max-h-[180px] md:max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700">
          <div class="text-gray-400 font-bold">Adjunta un Excel y presiona "Analizar".</div>
        </div>

        
        <div id="importTurnsBox" class="mt-4 bg-gray-50 border border-gray-200 rounded-2xl p-4 hidden">
          <div class="flex items-center justify-between mb-2">
            <p class="text-[11px] font-black text-gray-600 uppercase">Turnos detectados (asignar categor√≠a)</p>
            <div class="text-[10px] font-bold text-gray-500">Se aplica a los turnos que NO traen categor√≠a expl√≠cita.</div>
          </div>
          <div id="importTurnsList" class="max-h-[180px] overflow-y-auto space-y-2"></div>
          <div class="mt-3 flex gap-2">
            <button onclick="applyImportCategoryToAll()" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 text-[10px] font-black uppercase">Aplicar a todos</button>
            <select id="importDefaultCategory" class="flex-1 bg-white border border-gray-200 rounded-xl p-2 text-[11px] font-bold text-gray-900"></select>
          </div>
        </div>
<div class="mt-3 flex flex-col md:flex-row gap-2">
          <button onclick="analyzeImportFile()" class="flex-1 p-3 bg-sky-600 hover:bg-sky-700 text-white rounded-2xl font-black uppercase text-[11px]">
            üîé Analizar
          </button>
          <button onclick="runImportSelected()" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black uppercase text-[11px]">
            üöÄ Importar Seleccionados
          </button>
          <button onclick="closeImportModalAndRefresh()" class="flex-1 p-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black uppercase text-[11px]">
            ‚úÖ Terminar y Volver
          </button>
        </div>

        <div id="importInfo" class="mt-3 text-[11px] font-bold text-center text-gray-600"></div>
      </div>

      <button onclick="closeImportModal()" class="w-full mt-2 p-3 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Export -->
<div id="exportModal" class="modal">
  <div class="bg-white w-full max-w-xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 mx-auto mb-4 flex items-center justify-center">
      <span class="text-white text-2xl font-black">üìã</span>
    </div>
    <h3 class="font-black text-center uppercase text-base md:text-lg mb-2">Exportar</h3>
    <p class="text-[11px] text-gray-500 font-bold text-center mb-6">
      Puedes exportar uno, varios o todos. Si es "todos", se genera 1 imagen por perfil.
    </p>

    <div class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">Mes</label>
          <select id="exportMonth" class="w-full bg-gray-50 border-gray-200 text-gray-900"></select>
        </div>
        <div>
          <label class="text-[12px] font-bold text-gray-600 block mb-2">A√±o</label>
          <select id="exportYear" class="w-full bg-gray-50 border-gray-200 text-gray-900"></select>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
        <p class="text-[11px] font-black text-gray-600 uppercase mb-2">Qu√© exportar</p>
        <div class="space-y-2 text-[11px] font-bold text-gray-700">
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="current" checked> Perfil actual</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="select"> Seleccionar perfiles</label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="exportScope" value="all"> Todos los perfiles</label>
        </div>
      </div>

      <div id="exportUsersBox" class="bg-white border border-gray-200 rounded-2xl p-4 hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-2 gap-2">
          <p class="text-[11px] font-black text-gray-600 uppercase">Seleccionar perfiles</p>
          <div class="flex gap-2">
            <button onclick="selectAllExportUsers(true)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Todos</button>
            <button onclick="selectAllExportUsers(false)" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">Ninguno</button>
          </div>
        </div>
        <div id="exportUsersList" class="max-h-[180px] md:max-h-[220px] overflow-y-auto space-y-2 text-[11px] font-bold text-gray-700"></div>
      </div>

      <button onclick="exportImages()" class="w-full p-3 md:p-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-2xl md:rounded-3xl font-black uppercase shadow-xl hover:from-emerald-700 hover:to-teal-700">
        üñºÔ∏è Exportar im√°genes
      </button>

      <button onclick="closeExportModal()" class="w-full mt-2 p-3 text-gray-400 font-bold uppercase text-[10px] hover:text-gray-600">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Profiles - CORREGIDO: Nombres visibles en selects -->
<div id="profilesModal" class="modal">
  <div class="bg-white w-full max-w-3xl rounded-3xl md:rounded-[40px] p-4 md:p-6 lg:p-8 shadow-2xl mx-2">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-3">
      <div>
        <h3 class="font-black uppercase text-base md:text-lg">üë§ Gesti√≥n de Perfiles</h3>
        <p class="text-[11px] text-gray-500 font-bold">Crear, editar, asignar localidad o eliminar perfiles.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="deleteAllProfilesExceptAdmin()" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white text-[10px] font-black uppercase whitespace-nowrap">üßπ Eliminar todos (dejar ADMIN)</button>
        <button onclick="closeProfilesModal()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase whitespace-nowrap">Cerrar</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-3xl p-4">
        <h4 class="text-[12px] font-black text-gray-700 uppercase mb-3">‚ûï Crear perfil</h4>
        <div class="space-y-3">
          <input id="createName" type="text" placeholder="Nombre completo" class="w-full bg-white border-blue-200 focus:border-blue-400 text-gray-900">
          <input id="createPin" type="password" placeholder="PIN (4 d√≠gitos)" maxlength="4" class="w-full bg-white border-blue-200 focus:border-blue-400 text-gray-900">
          <div>
            <label class="text-[11px] font-bold text-gray-600 block mb-2">Localidad</label>
            <select id="createLoc" class="w-full bg-white border-blue-200 focus:border-blue-400 text-gray-900"></select>
          </div>
          <button onclick="createProfile()" class="w-full p-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black uppercase text-[11px]">
            Crear
          </button>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-3xl p-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-2">
          <h4 class="text-[12px] font-black text-gray-700 uppercase">Perfiles existentes</h4>
          <button onclick="renderProfilesList()" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase whitespace-nowrap">Actualizar</button>
        </div>
        <div id="profilesList" class="max-h-[300px] md:max-h-[360px] overflow-y-auto space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
// =========================================================
// DB v23 - Versi√≥n completa y corregida
// =========================================================
const ADMIN_UNIVERSAL_PIN = '120720';

// Intentar cargar DB existente o crear nueva
let db;
try {
  const saved = localStorage.getItem('shifter_v23');
  if (saved) {
    db = JSON.parse(saved);
  } else {
    // Intentar migrar de versi√≥n anterior
    const savedOld = localStorage.getItem('shifter_v22') || localStorage.getItem('shifter_v21') || localStorage.getItem('shifter_v20');
    if (savedOld) {
      db = JSON.parse(savedOld);
      db.version = 23;
    } else {
      db = createDefaultDB();
    }
  }
} catch (e) {
  console.log('Error cargando DB, creando nueva:', e);
  db = createDefaultDB();
}

normalizeEnabledFlags();

function normalizeEnabledFlags(){
  try{
    if(!db || !db.users) return;
    Object.keys(db.users).forEach(u=>{
      const user = db.users[u];
      if(!user || !user.config) return;
      Object.keys(user.config).forEach(k=>{
        if(typeof user.config[k].enabled === 'undefined'){
          user.config[k].enabled = (['Ma√±ana','Tarde','16hrs','CENA','L','Vacaciones'].includes(k));
        }
        // Si alguien renombr√≥ "VACACIONES" a otro label, no afecta el key.
      });
    });
    saveDB();
  }catch(e){
    console.log('normalizeEnabledFlags error', e);
  }
}

function createDefaultDB() {
  return {
    version: 23,
    current: 'ADMIN',
    localities: ['General','San Salvador','Cojutepeque','Lourdes, Col√≥n','La Libertad','Quezaltepeque','Rosario de la Paz','Zacatecoluca','San Vicente','Santa Tecla','San Juan Opico'],
    holidays: {},
    categories: {
      work: { name:'Trabajo', icon:'üíº', color:'#2563eb' },
      office:{ name:'Oficina', icon:'üóÇÔ∏è', color:'#0ea5e9' },
      field:{ name:'Campo / Operaci√≥n', icon:'üõ†Ô∏è', color:'#f97316' },
      salud:{ name:'Salud / Hospital', icon:'üè•', color:'#3b82f6' },
      guardia:{ name:'Guardia / Turno', icon:'üõ°Ô∏è', color:'#ef4444' },
      admin:{ name:'Administrativo', icon:'üìã', color:'#f59e0b' },
      extra:{ name:'Extra', icon:'‚≠ê', color:'#fbbf24' },
      otro:{ name:'Otro', icon:'üîß', color:'#6b7280' },
      off:  { name:'Libre', icon:'üò¥', color:'#10b981' },
      ausencia:{ name:'Ausencia Injustificada', icon:'‚ùå', color:'#dc2626' },
      cumple:{ name:'Cumplea√±os', icon:'üéÇ', color:'#ec4899' }
    },
    users: {
      ADMIN: {
        pin:'1234',
        editLocked:false,
        locality:'San Salvador',
        data:{},
        config:{
          'Ma√±ana': { label:'Ma√±ana', color:'Ma√±ana', cat:'work', in:'06:00', out:'14:00', enabled:true },
          'Tarde': { label:'Tarde', color:'Tarde', cat:'work', in:'14:00', out:'22:00', enabled:true },
          'Noche': { label:'Noche', color:'indigo', cat:'work', in:'22:00', out:'06:00', enabled:true },
          'Diurno': { label:'Diurno', color:'ambar', cat:'office', in:'08:00', out:'17:00', enabled:true },
          'Cumplea√±os': { label:'Cumplea√±os', color:'Cumplea√±os', cat:'cumple', in:'00:00', out:'00:00', enabled:false },
          'L': { label:'L', note:'LIBRE', color:'L', cat:'off', in:'06:00', out:'14:00', enabled:true },
          'Vacaciones': { label:'Vac', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', enabled:true },
          'Ausencia': { label:'Ausencia', color:'Ausencia', cat:'ausencia', in:'00:00', out:'00:00', enabled:false }
        }
      }
    }
  };
}


// Asegurar consistencia: el turno L siempre debe tener nota "LIBRE" en todos los perfiles
try{
  Object.values((db && db.users) ? db.users : {}).forEach(u=>{
    if(!u) return;
    if(!u.config) u.config = {};
    if(!u.config.L) u.config.L = { label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', enabled:true };
    u.config.L.note = 'LIBRE';
    u.config.L.in = '06:00';
    u.config.L.out = '14:00';
  });

// Limpieza: eliminar turnos/categor√≠as espec√≠ficos (CENA, 16hrs) para generalizar la app.
// Si exist√≠an en datos hist√≥ricos, se convierten a LIBRE (L).
try{
  Object.values((db && db.users) ? db.users : {}).forEach(u=>{
    if(!u) return;
    if(!u.config) u.config = {};
    // eliminar definiciones
    if(u.config['CENA']) delete u.config['CENA'];
    if(u.config['16hrs']) delete u.config['16hrs'];
    // migrar d√≠as guardados
    if(u.data){
      Object.keys(u.data).forEach(k=>{
        const d = u.data[k];
        if(!d) return;
        if(d.mode === 'simple'){
          if(d.s === 'CENA' || d.s === '16hrs'){
            d.s = 'L';
            d.tIn = '06:00'; d.tOut = '14:00';
            d.h = 8;
            d.n = d.n && d.n.trim() ? d.n : 'LIBRE';
          }
        } else if(d.mode === 'mixto'){
          let changed=false;
          if(d.t === 'CENA' || d.t === '16hrs'){ d.t='L'; changed=true; }
          if(d.b === 'CENA' || d.b === '16hrs'){ d.b='L'; changed=true; }
          if(changed){
            // mantener notas si existen; si no, poner LIBRE
            d.noteTop = d.noteTop && d.noteTop.trim() ? d.noteTop : 'LIBRE';
            d.noteBottom = d.noteBottom && d.noteBottom.trim() ? d.noteBottom : 'LIBRE';
            d.n = `${d.noteTop} | ${d.noteBottom}`;
          }
        }
      });
    }
  });

  // eliminar categor√≠a 'CENA' si exist√≠a
  if(db && db.categories){
    if(db.categories.sena) delete db.categories.sena;
  }
}catch(e){}


}catch(e){}

function saveDB(){ 
  try {
    localStorage.setItem('shifter_v23', JSON.stringify(db));
  } catch (e) {
    console.error('Error guardando DB:', e);
  }
}

// =========================================================
// Import maps
// =========================================================
const IMPORT_ABSENCE_MAP = {
  'C':  { key:'CAPACITACION', label:'Capacitaci√≥n', color:'azul', cat:'admin', in:'00:00', out:'00:00', note:'CAPACITACI√ìN' },
  'I':  { key:'INCAPACIDAD', label:'Incapacidad', color:'rojo', cat:'off', in:'00:00', out:'00:00', note:'INCAPACIDAD' },
  'V':  { key:'Vacaciones', label:'Vac', color:'Vacaciones', cat:'off', in:'00:00', out:'00:00', enabled:true, note:'VACACIONES' },
  'L':  { key:'L', label:'L', color:'L', cat:'off', in:'00:00', out:'00:00', enabled:true, note:'LIBRE' },
  'PS': { key:'PERMISO_SINDICAL', label:'Permiso Sindical', color:'morado', cat:'admin', in:'00:00', out:'00:00', note:'PERMISO SINDICAL' },
  'F':  { key:'AUSENCIA_INJUST', label:'Aus. Injust.', color:'Ausencia', cat:'ausencia', in:'00:00', out:'00:00', note:'AUSENCIA INJUSTIFICADA' },
  'CU': { key:'Cumplea√±os', label:'Cumplea√±os', color:'Cumplea√±os', cat:'cumple', in:'00:00', out:'00:00', enabled:false, note:'CUMPLEA√ëOS' }
};

const IMPORT_SHIFT_CODE_MAP = {
  '018': { key:'018', label:'018', color:'Ma√±ana', cat:'salud', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '18':  { key:'018', label:'018', color:'Ma√±ana', cat:'salud', in:'06:00', out:'14:00', note:'06:00-14:00' },
  '020': { key:'020', label:'020', color:'Tarde', cat:'salud', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '468': { key:'468', label:'468', color:'Tarde',  cat:'salud', in:'14:00', out:'22:00', note:'14:00-22:00' },
  '650': { key:'650', label:'650', color:'16hrs',  cat:'salud', in:'06:00', out:'22:00', note:'06:00-22:00' }
};

// =========================================================
// Globals
// =========================================================
let current = new Date();
let activeKey = "";
let mode = "simple";
let selS = "Ma√±ana";
let selT = "L";
let selB = "L";
let selectedColor = "Ma√±ana";

let importContext = null;

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const ALWAYS_VISIBLE_SHIFTS = ['Ma√±ana','Tarde','16hrs','CENA','L','Vacaciones'];


// =========================================================
// Helper Functions
// =========================================================
function isEditMode(){ 
  const user = db.users[db.current];
  return user ? !user.editLocked : false;
}

function isAdminUser(){
  return db && db.current === 'ADMIN';
}

function calculateHours(start, end){
  if(!start || !end || start === '00:00' && end === '00:00') return 0;
  try {
    const [h1,m1] = start.split(':').map(Number);
    const [h2,m2] = end.split(':').map(Number);
    const diff = (h2 + m2/60) - (h1 + m1/60);
    return diff < 0 ? diff + 24 : parseFloat(diff.toFixed(1));
  } catch {
    return 0;
  }
}

function defaultNoteForShift(shiftKey){
  const user = db.users[db.current];
  if (!user) return shiftKey || '';
  const sh = user.config[shiftKey];
  if (!sh) return (shiftKey||'').toUpperCase();

  // Prioridad: nota sugerida configurable (ej. L => LIBRE)
  const note = (sh.note || '').toString().trim();
  if (note) return note;

  // Si hay horario v√°lido -> sugerir HH:MM-HH:MM
  if (sh.in && sh.out && !(sh.in === '00:00' && sh.out === '00:00')) {
    return `${sh.in}-${sh.out}`;
  }

  // Fallback: etiqueta/clave en may√∫sculas
  return (sh.label || shiftKey || '').toUpperCase();
}

// =========================================================
// Default day builder: si no hay turno asignado -> se asume LIBRE (L) con horas del turno L
// =========================================================
function buildDefaultSimpleDay(user, shiftKey){
  const SHIFTS = (user && user.config) ? user.config : {};
  const sk = shiftKey || 'L';
  const def = SHIFTS[sk] || {};
  const tIn = def.in || '00:00';
  const tOut = def.out || '00:00';
  const hrs = calculateHours(tIn, tOut);
  const note = (def.note && String(def.note).trim()) ? String(def.note).trim()
              : defaultNoteForShift(sk) || ((tIn !== '00:00' || tOut !== '00:00') ? `${tIn}-${tOut}` : String(sk).toUpperCase());
  return { mode:'simple', s: sk, tIn, tOut, h: hrs, n: note };
}



// ====== Helpers: prioridad de edici√≥n (nota vs horario) ======
function _pad2(n){
  // Importante: NO usar (n||'') porque 0 se convierte en '' y se pierde el '00'
  // Aqu√≠ preservamos ceros y estandarizamos a 2 d√≠gitos.
  n = String(n).trim();
  return n.length === 1 ? ('0' + n) : n;
}
function normalizeHHMM(t){
  if (!t) return '';
  const m = String(t).trim().match(/^(\d{1,2}):(\d{2})$/);
  if (!m) return '';
  let hh = Math.min(23, Math.max(0, parseInt(m[1],10)));
  let mm = Math.min(59, Math.max(0, parseInt(m[2],10)));
  return _pad2(hh)+':'+_pad2(mm);
}
function parseTimeRangeFromNote(note){
  if (!note) return null;
  const s = String(note);
  const m = s.match(/(\d{1,2}):(\d{2})\s*[-‚Äì]\s*(\d{1,2}):(\d{2})/);
  if (!m) return null;
  const tIn = normalizeHHMM(m[1]+':'+m[2]);
  const tOut = normalizeHHMM(m[3]+':'+m[4]);
  if (!tIn || !tOut) return null;
  return {in:tIn, out:tOut};
}
function makeTimeNote(tIn, tOut){
  const a = normalizeHHMM(tIn), b = normalizeHHMM(tOut);
  if (!a || !b) return '';
  return `${a}-${b}`;
}
// Guarda el "√∫ltimo auto" para no pisar edici√≥n manual
let _autoNoteSimple = '';
let _autoNoteTop = '';
let _autoNoteBottom = '';

function bindAutoNoteSyncSimple(){
  const tInEl = document.getElementById('tIn');
  const tOutEl = document.getElementById('tOut');
  const noteEl = document.getElementById('nota');
  if (!tInEl || !tOutEl || !noteEl) return;

  const sync = () => {
    const note = (noteEl.value||'').trim();
    const def = defaultNoteForShift(selS);
    const auto = makeTimeNote(tInEl.value, tOutEl.value);
    // Si est√° vac√≠o o era default/auto previo => actualizar
    if (!note || note === def || note === _autoNoteSimple) {
      if (auto) {
        noteEl.value = auto;
        _autoNoteSimple = auto;
        // reflejar en nota r√°pida si existe
        const nq = document.getElementById('notaQuick');
        if (nq && (nq.value||'').trim() === '' ) nq.value = auto;
      }
    }
  };

  tInEl.addEventListener('input', sync);
  tOutEl.addEventListener('input', sync);
}

function bindAutoNoteSyncMixto(){
  const tInTop = document.getElementById('tInTop');
  const tOutTop = document.getElementById('tOutTop');
  const tInBottom = document.getElementById('tInBottom');
  const tOutBottom = document.getElementById('tOutBottom');
  const nTop = document.getElementById('notaTop');
  const nBottom = document.getElementById('notaBottom');
  if (!tInTop || !tOutTop || !tInBottom || !tOutBottom || !nTop || !nBottom) return;

  const syncTop = () => {
    const note = (nTop.value||'').trim();
    const def = defaultNoteForShift(selT);
    const auto = makeTimeNote(tInTop.value, tOutTop.value);
    if (!note || note === def || note === _autoNoteTop) {
      if (auto) { nTop.value = auto; _autoNoteTop = auto; }
    }
  };
  const syncBottom = () => {
    const note = (nBottom.value||'').trim();
    const def = defaultNoteForShift(selB);
    const auto = makeTimeNote(tInBottom.value, tOutBottom.value);
    if (!note || note === def || note === _autoNoteBottom) {
      if (auto) { nBottom.value = auto; _autoNoteBottom = auto; }
    }
  };

  tInTop.addEventListener('input', syncTop);
  tOutTop.addEventListener('input', syncTop);
  tInBottom.addEventListener('input', syncBottom);
  tOutBottom.addEventListener('input', syncBottom);

  // En algunos navegadores el selector de hora dispara 'change' y no 'input'
  tInTop.addEventListener('change', syncTop);
  tOutTop.addEventListener('change', syncTop);
  tInBottom.addEventListener('change', syncBottom);
  tOutBottom.addEventListener('change', syncBottom);

  // Sincronizar una vez al enlazar (para que quede el autoNote* en estado consistente)
  syncTop();
  syncBottom();
}


function normalizeCode(v){
  if(v === null || v === undefined || v === '') return '';
  let s = String(v).trim().toUpperCase();
  s = s.replace(/\s+/g, ' ');
  if (s === 'LS') s = 'L';
  if (s === 'P S' || s === 'P/S') s = 'PS';
  if (s === 'CU' || s === 'CUM') s = 'CU';
  return s;
}


function isLikelyDataRow(row, nameCol, empCol, dayCols){
  try{
    if(!row || !Array.isArray(row)) return false;

    const nameRaw = row[nameCol];
    const name = (typeof safeNameCell === 'function') ? safeNameCell(nameRaw) : String(nameRaw ?? '').trim();
    const emp  = (empCol != null) ? String(row[empCol] ?? '').trim() : '';

    // Conteo de celdas de d√≠a con contenido (turno/ausencia)
    const dayKeys = Object.keys(dayCols || {});
    let filled = 0;
    for(const d of dayKeys){
      const v = (typeof normalizeCode === 'function') ? normalizeCode(row[dayCols[d]]) : String(row[dayCols[d]] ?? '').trim();
      if(v) filled++;
    }

    // Debe tener identificador (nombre o No. emp) y al menos 1 d√≠a con contenido
    if(!name && !emp) return false;
    if(filled < 1) return false;

    // Filtrar filas t√≠picas no-datos
    const n = String(name || '').toUpperCase().trim();
    const banned = new Set(['TOTAL','TOTALES','OBSERVACIONES','NOTAS','RESUMEN','PERSONAL','NOMBRE','EMPLEADO','NO.','NO EMP','NO. EMP','No. EMP.']);
    if(banned.has(n)) return false;

    return true;
  }catch(_e){
    return false;
  }
}

function codeToShiftDef(codeNorm){
  if(!codeNorm || codeNorm === 'X') return null;

  // Ausencias/estatus (no requieren categor√≠a)
  if(IMPORT_ABSENCE_MAP[codeNorm]) return {...IMPORT_ABSENCE_MAP[codeNorm]};

  // Turnos conocidos (si existen en el mapa)
  if(IMPORT_SHIFT_CODE_MAP[codeNorm]) return {...IMPORT_SHIFT_CODE_MAP[codeNorm]};

  // Turnos gen√©ricos detectados (num√©ricos o alfanum√©ricos cortos)
  // Nota: el horario/categor√≠a se puede ajustar v√≠a mapeo de importaci√≥n o luego en Ajustes.
  if(/^[A-Z0-9]{1,12}$/.test(codeNorm)){
    return { 
      key: codeNorm, 
      label: codeNorm, 
      color:'gris', 
      cat:'work', 
      in:'00:00', 
      out:'00:00', 
      note: codeNorm 
    };
  }
  return null;
}


function ensureShiftExistsForUser(userKey, shiftDef, enableNow=false){
  const user = db.users[userKey];
  if(!user || !shiftDef) return;
  if(!user.config[shiftDef.key]){
    user.config[shiftDef.key] = { label: shiftDef.label, color: shiftDef.color || 'gris', cat: shiftDef.cat || 'hosp', in: shiftDef.in || '00:00', out: shiftDef.out || '00:00', enabled: !!enableNow };
  }
  if(enableNow && user.config[shiftDef.key]) user.config[shiftDef.key].enabled = true;

}function ensureImportBaseShiftsForUser(userKey){
  Object.values(IMPORT_ABSENCE_MAP).forEach(def => ensureShiftExistsForUser(userKey, def, false));
  Object.values(IMPORT_SHIFT_CODE_MAP).forEach(def => ensureShiftExistsForUser(userKey, def, false));
}

function ensureUserExists(nameUpper){
  const name = String(nameUpper || '').trim().toUpperCase();
  if(!name) return null;
  
  if(!db.users[name]){
    db.users[name] = {
      pin: '0000',
      editLocked: false,
      locality: 'San Salvador',
      data: {},
      config: JSON.parse(JSON.stringify(db.users.ADMIN.config))
    };
    ensureImportBaseShiftsForUser(name);
  }
  return name;
}

function dayKey(y, m1, d){ 
  return `${y}-${m1}-${d}`; 
}

function getColorValue(colorName){
  const map = {
    'Ma√±ana':'#ffff00','Tarde':'#fbcfe8','CENA':'#d8b4fe','16hrs':'#bef264',
    'L':'#ffffff','Vacaciones':'#fed7aa','Cumplea√±os':'#f9a8d4','Ausencia':'#d1d5db',
    'azul':'#93c5fd','rojo':'#fca5a5','verde':'#86efac','naranja':'#fdba74',
    'rosa':'#f9a8d4','cian':'#67e8f9','morado':'#d8b4fe','lima':'#d9f99d',
    'ambar':'#fcd34d','teal':'#5eead4','indigo':'#a5b4fc','gris':'#d1d5db'
  };
  return map[colorName] || '#ffffff';
}

function holidayApplies(holidayLocation, userLocation){
  const hl = (holidayLocation || 'General').trim().toUpperCase();
  const ul = (userLocation || 'San Salvador').trim().toUpperCase();
  return hl === 'GENERAL' || hl === ul;
}

function countApplicableHolidaysInMonth(year, monthIndex0, userLocation){
  const m1 = monthIndex0 + 1;
  let count = 0;
  Object.entries(db.holidays).forEach(([key, holiday]) => {
    const [y, mm] = key.split('-').map(Number);
    if(y === year && mm === m1 && holidayApplies(holiday.location, userLocation)){
      count++;
    }
  });
  return count;
}

function cssSafe(s){ 
  return String(s || '').replace(/[^a-zA-Z0-9_-]/g, '_'); 
}

function escapeHTML(s){
  if (s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// =========================================================
// Colores de turnos (para selector y personalizaci√≥n)
// =========================================================
const SHIFT_COLOR_HEX = {
  'Ma√±ana':'#ffff00',
  'Tarde':'#fbcfe8',
  'CENA':'#d8b4fe',
  '16hrs':'#bef264',
  'L':'#ffffff',
  'Vacaciones':'#fed7aa',
  'Cumplea√±os':'#f9a8d4',
  'Ausencia':'#d1d5db',
  'azul':'#93c5fd',
  'rojo':'#fca5a5',
  'verde':'#86efac',
  'naranja':'#fdba74',
  'rosa':'#fda4af',
  'cian':'#67e8f9',
  'morado':'#c4b5fd',
  'lima':'#a3e635',
  'ambar':'#fcd34d',
  'teal':'#5eead4',
  'indigo':'#a5b4fc',
  'gris':'#d1d5db'
};

function shiftBgClass(color){
  return (typeof color === 'string' && color.startsWith('#')) ? '' : `bg-${color}`;
}
function shiftBgStyle(color){
  return (typeof color === 'string' && color.startsWith('#')) ? `background:${color} !important;` : '';
}
function shiftToHex(color){
  if (!color) return '#ffffff';
  if (typeof color === 'string' && color.startsWith('#')) return color;
  return SHIFT_COLOR_HEX[color] || '#ffffff';
}
function syncShiftColorPicker(id){
  const safeId = cssSafe(id);
  const sel = document.getElementById(`set-color-${safeId}`);
  const pick = document.getElementById(`set-colorpick-${safeId}`);
  if(!sel || !pick) return;
  if(sel.value === '__custom__'){
    // no forzar
    return;
  }
  pick.value = shiftToHex(sel.value);
}

function toISODate(y,m,d){
  y=String(y).padStart(4,'0');
  m=String(m).padStart(2,'0');
  d=String(d).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

// =========================================================
// UI Initialization - CORREGIDO: Color de texto en selects
// =========================================================
function init(){
  // Cargar feriados por defecto
  loadDefaultHolidays();
  
  // Inicializar selectores
  initSelectors();
  
  // Asegurar turnos base
  ensureImportBaseShiftsForUser('ADMIN');
  
  // Actualizar UI
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  
  // Renderizar
  render();
  renderSummaryCategories();
  calcSummary();
  updateUIEditMode();
  
  // Mostrar primera pesta√±a de configuraci√≥n
  showConfigTab('turnos');
}

function loadDefaultHolidays(){
  const defaults = [
    {date: '2026-1-1', name: 'A√±o Nuevo', location: 'General'},
    {date: '2026-1-20', name: 'Fiestas de Cojutepeque', location: 'Cojutepeque'},
    {date: '2026-2-10', name: 'Fiesta de Lourdes Col√≥n', location: 'Lourdes, Col√≥n'},
    {date: '2026-4-1', name: 'Mi√©rcoles Santo', location: 'General'},
    {date: '2026-4-2', name: 'Jueves Santo', location: 'General'},
    {date: '2026-4-3', name: 'Viernes Santo', location: 'General'},
    {date: '2026-4-4', name: 'S√°bado de Gloria', location: 'General'},
    {date: '2026-5-1', name: 'D√≠a del Trabajo', location: 'General'},
    {date: '2026-5-10', name: 'D√≠a de la Madre', location: 'General'},
    {date: '2026-6-17', name: 'D√≠a del Padre', location: 'General'},
    {date: '2026-8-3', name: 'D√≠a del Comercio', location: 'General'},
    {date: '2026-8-4', name: 'Fiestas Patronales (San Salvador)', location: 'San Salvador'},
    {date: '2026-8-5', name: 'Fiestas Patronales (San Salvador)', location: 'San Salvador'},
    {date: '2026-8-6', name: 'D√≠a de El Salvador', location: 'General'},
    {date: '2026-9-15', name: 'Aniversario de Independencia', location: 'General'},
    {date: '2026-10-2', name: 'V√≠spera del d√≠a del Trabajador de la Industria El√©ctrica', location: 'General'},
    {date: '2026-10-3', name: 'D√≠a del Trabajador de la Industria El√©ctrica', location: 'General'},
    {date: '2026-11-2', name: 'D√≠a de los Difuntos', location: 'General'},
    {date: '2026-12-8', name: 'Fiestas de La Libertad', location: 'La Libertad'},
    {date: '2026-12-19', name: 'Fiestas Patronales', location: 'Quezaltepeque y Rosario de la Paz'},
    {date: '2026-12-24', name: 'Navidad', location: 'General'},
    {date: '2026-12-25', name: 'Navidad', location: 'General'},
    {date: '2026-12-26', name: 'Fiestas Patronales', location: 'Zacatecoluca, San Vicente y Santa Tecla'},
    {date: '2026-12-27', name: 'Fiestas de San Juan Opico', location: 'San Juan Opico'},
    {date: '2026-12-31', name: 'Fin de A√±o', location: 'General'}
  ];
  
  defaults.forEach(({date, name, location}) => {
    if (!db.holidays[date]) {
      db.holidays[date] = { name, location };
    }
  });
  
  saveDB();
}

function initSelectors(){
  // Meses - CORREGIDO: Color de texto
  const monthSelects = ['selectMonth', 'importMonth', 'exportMonth'];
  monthSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.innerHTML = MONTHS.map((m, i) => 
        `<option value="${i}" style="color: #111827; font-weight: 800;">${m}</option>`
      ).join('');
      el.value = current.getMonth();
    }
  });
  
  // A√±os - CORREGIDO: Color de texto
  const yearSelects = ['selectYear', 'importYear', 'exportYear'];
  const currentYear = current.getFullYear();
  yearSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      let html = '';
      const MIN_YEAR = 2020;
      const MAX_YEAR = 2035;
      const startY = Math.min(currentYear - 5, MIN_YEAR);
      for(let y = startY; y <= MAX_YEAR; y++){
        html += `<option value="${y}" ${y === currentYear ? 'selected' : ''} style="color: #111827; font-weight: 800;">${y}</option>`;
      }
      el.innerHTML = html;
    }
  });
}

// =========================================================
// Navigation Functions
// =========================================================
function updateMonthDisplay(){
  const y = current.getFullYear();
  const m = current.getMonth();
  const display = document.getElementById('currentMonthDisplay');
  if (display) display.textContent = `${MONTHS[m]} ${y}`;
  
  const monthSelect = document.getElementById('selectMonth');
  const yearSelect = document.getElementById('selectYear');
  if (monthSelect) monthSelect.value = m;
  if (yearSelect) yearSelect.value = y;
}

function changeMonth(v){ 
  current.setMonth(current.getMonth() + v); 
  updateMonthDisplay(); 
  render();
  renderSummaryCategories();
  calcSummary();
}

function jumpToDate(){
  const monthSelect = document.getElementById('selectMonth');
  const yearSelect = document.getElementById('selectYear');
  if (monthSelect && yearSelect) {
    current.setMonth(parseInt(monthSelect.value));
    current.setFullYear(parseInt(yearSelect.value));
    updateMonthDisplay(); 
    render();
    renderSummaryCategories();
    calcSummary();
  }
}

function goToday(){ 
  current = new Date(); 
  updateMonthDisplay(); 
  render();
  renderSummaryCategories();
  calcSummary();
}

// =========================================================
// View Management
// =========================================================
function showView(v){
  // Ocultar todas las vistas
  document.querySelectorAll('.view-section').forEach(s => {
    s.classList.remove('view-active');
  });
  
  // Quitar active de todas las tabs
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('tab-active');
  });
  
  // Mostrar vista seleccionada
  const viewElement = document.getElementById(`view-${v}`);
  const tabElement = document.getElementById(`tab-${v}`);
  
  if (viewElement) viewElement.classList.add('view-active');
  if (tabElement) tabElement.classList.add('tab-active');
  
  if(v === 'summary'){
    renderSummaryCategories();
    calcSummary();
  }
  
  if(v === 'settings'){
    updateUIEditMode();
  }
}


// =========================================================
// Drawer Menu (hamburguesa)
// =========================================================
function openMenu(){
  const o = document.getElementById('menuOverlay');
  const d = document.getElementById('menuDrawer');
  if(o) o.classList.add('active');
  if(d) d.classList.add('active');
  // evitar scroll del body cuando el men√∫ est√° abierto
  document.body.style.overflow = 'hidden';
}
function closeMenu(){
  const o = document.getElementById('menuOverlay');
  const d = document.getElementById('menuDrawer');
  if(o) o.classList.remove('active');
  if(d) d.classList.remove('active');
  document.body.style.overflow = '';
}
function toggleMenu(){
  const d = document.getElementById('menuDrawer');
  if(d && d.classList.contains('active')) closeMenu(); else openMenu();
}
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape') closeMenu();
});

function showConfigTab(tab){
  // Ocultar todas las pesta√±as de configuraci√≥n
  document.querySelectorAll('.config-tab').forEach(t => {
    t.classList.remove('active');
  });
  
  // Ocultar todos los contenidos
  document.querySelectorAll('.config-tab-content').forEach(c => {
    c.classList.add('hidden');
  });
  
  // Mostrar pesta√±a seleccionada
  const tabElement = document.getElementById(`config-${tab}`);
  const contentElement = document.getElementById(`tab-${tab}`);
  
  if (tabElement) tabElement.classList.add('active');
  if (contentElement) contentElement.classList.remove('hidden');
  
  // Cargar contenido espec√≠fico
  if(tab === 'turnos'){ 
    renderSettings(); 
  }
  if(tab === 'nuevo'){ 
    loadCategoriesSelect(); 
  }
  if(tab === 'categorias'){ 
    renderCategories(); 
  }
  if(tab === 'localidades'){ 
    renderLocalities(); 
  }
  if(tab === 'asuetos'){ 
    refreshHolidayLocationSelects(); 
    renderHolidays(); 
  }
}

// =========================================================
// Edit Mode Functions
// =========================================================
function updateUIEditMode(){
  const configContent = document.getElementById('config-content');
  const lockedMessage = document.getElementById('settings-locked');
  const editStatus = document.getElementById('editStatus');
  const unlockBtn = document.getElementById('unlockBtn');
  
  if (!configContent || !lockedMessage || !editStatus || !unlockBtn) return;
  
  if(isEditMode()){
    configContent.classList.remove('hidden');
    lockedMessage.classList.add('hidden');
    editStatus.textContent = "MODO EDICI√ìN ACTIVADO";
    editStatus.className = "text-[10px] font-black uppercase text-emerald-400";
    unlockBtn.textContent = "üîí Bloquear";
    unlockBtn.className = "bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  } else {
    configContent.classList.add('hidden');
    lockedMessage.classList.remove('hidden');
    editStatus.textContent = "MODO VISTA";
    editStatus.className = "text-[10px] font-black uppercase text-gray-400";
    unlockBtn.textContent = "üîì Editar";
    unlockBtn.className = "bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-colors";
  }
}

function toggleEditMode(){
  const user = db.users[db.current];
  if (!user) return;
  
  if(isEditMode()){
    const p = prompt("Ingresa tu PIN para bloquear la edici√≥n:");
    if(p === user.pin || (db.current !== 'ADMIN' && p === ADMIN_UNIVERSAL_PIN)){
      user.editLocked = true;
      saveDB();
      alert("Edici√≥n bloqueada");
      updateUIEditMode();
    } else {
      alert("PIN incorrecto");
    }
  } else {
    const p = prompt("Ingresa tu PIN para editar:");
    if(p === user.pin || p === ADMIN_UNIVERSAL_PIN){
      user.editLocked = false;
      saveDB();
      alert("Edici√≥n activada");
      updateUIEditMode();
    } else {
      alert("PIN incorrecto");
    }
  }
}

// =========================================================
// User Management
// =========================================================
function updateUserDropdown(){
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  const users = Object.keys(db.users).sort();
  select.innerHTML = users.map(u => 
    `<option value="${escapeHTML(u)}" ${u === db.current ? 'selected' : ''} style="color: #111827; font-weight: 800;">${escapeHTML(u)}</option>`
  ).join('');
}

function updateUserInitial(){
  const initialElement = document.getElementById('userInitial');
  if (initialElement && db.current) {
    initialElement.textContent = db.current.charAt(0);
  }
}

function switchUser(){
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  db.current = select.value;
  saveDB();
  updateUserInitial();
  render();
  renderSummaryCategories();
  calcSummary();
  updateUIEditMode();
}

// =========================================================
// Calendar Rendering
// =========================================================
function render(){
  const grid = document.getElementById('calendar');
  if (!grid) return;
  
  grid.innerHTML = '';
  
  const y = current.getFullYear();
  const m = current.getMonth();
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const today = new Date();
  const todayKey = dayKey(today.getFullYear(), today.getMonth() + 1, today.getDate());
  
  const firstDay = new Date(y, m, 1).getDay();
  const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
  const lastDate = new Date(y, m + 1, 0).getDate();
  const prevLastDate = new Date(y, m, 0).getDate();
  
  // D√≠as del mes anterior
  for(let i = firstDayMonday; i > 0; i--){
    const prevDay = prevLastDate - i + 1;
    const prevMonth = m === 0 ? 12 : m;
    const prevYear = m === 0 ? y - 1 : y;
    const key = dayKey(prevYear, prevMonth, prevDay);
    const info = user.data[key];
    
    const cell = createDayCell(prevDay, true, info, SHIFTS, user, key);
    grid.appendChild(cell);
  }
  
  // D√≠as del mes actual
  for(let d = 1; d <= lastDate; d++){
    const key = dayKey(y, m + 1, d);
    const info = user.data[key] || buildDefaultSimpleDay(user, 'L');
    const isToday = key === todayKey;
    
    const cell = createDayCell(d, false, info, SHIFTS, user, key, isToday);
    grid.appendChild(cell);
  }
  
  // D√≠as del mes siguiente
  const total = firstDayMonday + lastDate;
  const trailing = (7 - (total % 7)) % 7;
  for(let i = 1; i <= trailing; i++){
    const nextMonth = m === 11 ? 1 : m + 2;
    const nextYear = m === 11 ? y + 1 : y;
    const key = dayKey(nextYear, nextMonth, i);
    
    const cell = createDayCell(i, true, null, SHIFTS, user, key);
    grid.appendChild(cell);
  }
}

function createDayCell(dayNum, isOffMonth, info, SHIFTS, user, key, isToday = false){
  const cell = document.createElement('div');
  let wasLongPress = false;
let suppressClickUntil = 0;
  let pressTimer = null;
  
  let classes = 'day-cell';
  if (isOffMonth) classes += ' day-off-month';
  
  const date = new Date(key.replace(/-/g, '/'));
  const dow = date.getDay();
  if (dow === 0 || dow === 6) classes += ' weekend';
  if (isToday) classes += ' today';
  
  cell.className = classes;
  
  // Contenido seg√∫n tipo de turno
  if (info) {
    if (info.mode === 'mixto') {
      const topShift = SHIFTS[info.t] || {color: 'L', label: 'L'};
      const bottomShift = SHIFTS[info.b] || {color: 'L', label: 'L'};
      
      cell.innerHTML = `
        <div class="shift-label ${shiftBgClass(topShift.color)}" style="${shiftBgStyle(topShift.color)}">${escapeHTML(topShift.label)}</div>
        <div class="shift-label ${shiftBgClass(bottomShift.color)}" style="${shiftBgStyle(bottomShift.color)}">${escapeHTML(bottomShift.label)}</div>
      `;
      
      if (info.noteTop) {
        cell.innerHTML += `<div class="mixto-top-note">${escapeHTML(info.noteTop)}</div>`;
      }
      if (info.noteBottom) {
        cell.innerHTML += `<div class="mixto-bottom-note">${escapeHTML(info.noteBottom)}</div>`;
      }
    } else {
      const shift = SHIFTS[info.s] || {color: 'L', label: 'L'};
      cell.innerHTML = `<div class="shift-label ${shiftBgClass(shift.color)}" style="${shiftBgStyle(shift.color)}">${escapeHTML(shift.label)}</div>`;
      if (info.n) {
        cell.innerHTML += `<div class="note-text">${escapeHTML(info.n)}</div>`;
      }
    }
  } else {
    cell.innerHTML = `<div class="shift-label bg-L">L</div>`;
  }
  
  // Indicador de asueto
  const holiday = db.holidays[key];
  if (holiday && holidayApplies(holiday.location, user.locality)) {
    cell.innerHTML += `<div class="holiday-indicator">A</div>`;
  }
  
  
  // Miniatura de foto
  if (info && info.photoData) {
    cell.innerHTML += `<div class="day-photo-thumb"><img src="${info.photoData}" alt="foto"/></div>`;
  }

  // N√∫mero del d√≠a
  cell.innerHTML += `<span class="day-number">${dayNum}</span>`;
  
  // Evento click
  cell.onclick = (ev) => {
    if (wasLongPress) { wasLongPress = false; return; }
    if (!isEditMode()) {
      alert("Activa modo edici√≥n para editar.");
      return;
    }
    // Si est√° activo el modo pegar, pegar sin abrir modal
    if (pasteMode && (clipboardDayData || clipboardShiftOnly)) {
      pasteTo(key);
      return;
    }
    hideDayMenu();
    openDay(key, info || {mode: 'simple', s: 'L'});
  };

  // Men√∫ acciones (PC clic derecho / Touch mantener presionado)
  cell.oncontextmenu = (ev) => {
    ev.preventDefault();
    if (!isEditMode()) return;
    wasLongPress = true;
    showDayMenu(ev.clientX, ev.clientY, key);
  };
  const startPress = (ev) => {
    if (!isEditMode()) return;
    // Solo bot√≥n primario (evita disparos por clic derecho/contextmenu)
    if (ev && ev.button !== undefined && ev.button !== 0) return;
    const pt = (ev.touches && ev.touches[0]) ? ev.touches[0] : ev;
    pressTimer = setTimeout(()=> {
      wasLongPress = true;
      showDayMenu(pt.clientX || 20, pt.clientY || 20, key);
    }, 450);
  };
  const cancelPress = () => { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } };

  // Long-press: usar *solo un* sistema de eventos para evitar dobles timers (touch + pointer)
  const supportsPointer = ('PointerEvent' in window);
  if (supportsPointer) {
    cell.addEventListener('pointerdown', (ev)=>{ startPress(ev); });
    cell.addEventListener('pointerup', cancelPress);
    cell.addEventListener('pointercancel', cancelPress);
    cell.addEventListener('pointermove', cancelPress);
  } else {
    cell.addEventListener('touchstart', startPress, {passive:true});
    cell.addEventListener('touchend', cancelPress);
    cell.addEventListener('touchmove', cancelPress);
    cell.addEventListener('mousedown', startPress);
    cell.addEventListener('mouseup', cancelPress);
    cell.addEventListener('mouseleave', cancelPress);
  }


  
  return cell;
}

// =========================================================
// Summary Functions - CORREGIDO: Solo categor√≠as usadas en el mes
// =========================================================
function renderSummaryCategories(){
  const container = document.getElementById('summary-categories');
  if (!container) return;
  
  const y = current.getFullYear();
  const m0 = current.getMonth();
  const m1 = m0 + 1;
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Determinar qu√© categor√≠as est√°n usadas en este mes (si no hay dato, se asume LIBRE)
  const usedCategories = new Set();
  const daysInMonth = new Date(y, m0 + 1, 0).getDate();
  for(let day = 1; day <= daysInMonth; day++){
    const key = dayKey(y, m1, day);
    const d = user.data[key] || buildDefaultSimpleDay(user, 'L');
    if (d.mode === 'mixto') {
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;
      if (topCat) usedCategories.add(topCat);
      if (botCat) usedCategories.add(botCat);
    } else {
      const cat = SHIFTS[d.s]?.cat;
      if (cat) usedCategories.add(cat);
    }
  }

  // Filtrar categor√≠as para mostrar solo las usadas
  const usedCatIds = Array.from(usedCategories).filter(catId => categories[catId]);
  
  // Si no hay categor√≠as usadas, mostrar un mensaje
  if (usedCatIds.length === 0) {
    container.innerHTML = `
      <div class="col-span-full bg-white p-6 rounded-3xl shadow-sm text-center">
        <p class="text-[12px] font-black text-gray-400 uppercase mb-2">üìä Resumen del Mes</p>
        <p class="text-[11px] text-gray-500">No hay datos para el mes seleccionado</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  usedCatIds.forEach((catId) => {
    const cat = categories[catId];
    if (!cat) return;
    
    const color = cat.color || '#3b82f6';
    html += `
      <div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border-l-[10px]" style="border-color: ${color};">
        <div class="flex items-center justify-between mb-2">
          <p class="text-[11px] font-black text-gray-400 uppercase">${escapeHTML(cat.name)}</p>
          <span class="text-[10px] font-black px-2 py-1 rounded-full" style="background: ${color}20; color: ${color};">${escapeHTML(cat.icon)}</span>
        </div>
        <h2 id="hrs-${cssSafe(catId)}" class="text-3xl md:text-4xl font-black text-gray-900 tracking-tighter">0.0 HRS</h2>
        <div class="mt-2 text-[10px] text-gray-500 font-bold" id="days-${cssSafe(catId)}">0 d√≠as</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  
  // Calcular y actualizar valores
  calcSummary();
}

function calcSummary(){
  const y = current.getFullYear();
  const m0 = current.getMonth();
  const m1 = m0 + 1;
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Inicializar contadores
  const catHours = {};
  const catDays = {};
  Object.keys(categories).forEach(catId => {
    catHours[catId] = 0;
    catDays[catId] = 0;
  });
  
  let freeDays = 0, vacDays = 0, workedDays = 0, holidayWorked = 0;
  const daysInMonth = new Date(y, m0 + 1, 0).getDate();
  freeDays = 0;
  
  const applicableHolidays = countApplicableHolidaysInMonth(y, m0, user.locality);
  
  // Procesar d√≠as del mes (si no hay dato, se asume LIBRE)
  for(let day = 1; day <= daysInMonth; day++){
    const key = dayKey(y, m1, day);
    const d = user.data[key] || buildDefaultSimpleDay(user, 'L');
    const date = new Date(y, m0, day);
    const dow = date.getDay();
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);
if (d.mode === 'mixto') {
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;

      if (isHoliday && (topCat || botCat)) holidayWorked++;

      if (topCat && categories[topCat]) {
        catHours[topCat] += (d.hrsTop || 0);
        catDays[topCat]++;
        if (topCat !== 'off') workedDays++;
        else {
          if ((d.t || '') === 'Vacaciones') vacDays++;
          else freeDays++;
        }
      }

      if (botCat && categories[botCat]) {
        catHours[botCat] += (d.hrsBottom || 0);
        catDays[botCat]++;
        if (botCat !== 'off') workedDays++;
        else {
          if ((d.b || '') === 'Vacaciones') vacDays++;
          else freeDays++;
        }
      }
    } else {
      const cat = SHIFTS[d.s]?.cat;
      if (cat && categories[cat]) {
        catHours[cat] += (d.h || 0);
        catDays[cat]++;

        if (cat !== 'off') {
          workedDays++;
          if (isHoliday) holidayWorked++;
        } else {
          if ((d.s || '') === 'Vacaciones') vacDays++;
          else freeDays++;
        }
      }
    }
  }

  freeDays = Math.max(0, freeDays);
  
  // Actualizar UI - solo categor√≠as usadas
  Object.keys(categories).forEach(catId => {
    const hrsEl = document.getElementById(`hrs-${cssSafe(catId)}`);
    const daysEl = document.getElementById(`days-${cssSafe(catId)}`);
    if (hrsEl) hrsEl.textContent = `${catHours[catId].toFixed(1)} HRS`;
    if (daysEl) daysEl.textContent = `${catDays[catId]} d√≠a${catDays[catId] !== 1 ? 's' : ''}`;
  });
  
  // Actualizar otros elementos
  const elements = {
    'total-off': freeDays + vacDays,
    'free-days': freeDays,
    'vac-days': vacDays,
'holiday-worked': holidayWorked,
    'worked-days': workedDays,
    'total-holidays': applicableHolidays,
    'profile-loc': user.locality || 'San Salvador',
    'total-days': daysInMonth
  };
  
  Object.entries(elements).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  });
  
  // Calcular promedio
  const totalHours = Object.values(catHours).reduce((a, b) => a + b, 0);
  const avg = workedDays > 0 ? totalHours / workedDays : 0;
  const avgEl = document.getElementById('avg-hours');
  if (avgEl) avgEl.textContent = `${avg.toFixed(1)}h`;
}

// =========================================================
// Day Modal Functions
// =========================================================
function openDay(key, info){
  activeKey = key;
  // No dejar el selector de turnos abierto por defecto
  try { if (window._setTurnArea) window._setTurnArea(false); } catch(e) {}
  activePhotoData = (info && info.photoData) ? info.photoData : "";
  mode = info.mode || 'simple';
  selS = info.s || 'Ma√±ana';
  // En mixto el default debe ser 'L' (Libre) en ambas partes
  selT = info.t || (mode === 'mixto' ? 'L' : 'Ma√±ana');
  selB = info.b || (mode === 'mixto' ? 'L' : 'Tarde');
  
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;

  // Asegurar que el turno 'L' exista; si no existe, caer al primer turno visible
  const _visibleKeys = getVisibleShiftKeys(user);
  const _fallbackKey = (_visibleKeys && _visibleKeys.length) ? _visibleKeys[0] : 'L';
  if (!_visibleKeys.includes(selS)) selS = _fallbackKey;
  if (!_visibleKeys.includes(selT)) selT = ( _visibleKeys.includes('L') ? 'L' : _fallbackKey );
  if (!_visibleKeys.includes(selB)) selB = ( _visibleKeys.includes('L') ? 'L' : _fallbackKey );

const [yy, mm, dd] = key.split('-');
  const modalDate = document.getElementById('modalDate');
  if (modalDate) {
    modalDate.textContent = `${dd} de ${MONTHS[parseInt(mm) - 1]} de ${yy}`;
  }
  
  // Informaci√≥n de asueto
  const holiday = db.holidays[key];
  const holidayInfo = document.getElementById('holidayInfo');
  if (holidayInfo) {
    if (holiday && holidayApplies(holiday.location, user.locality)) {
      holidayInfo.classList.remove('hidden');
      document.getElementById('holidayName').textContent = holiday.name;
      document.getElementById('holidayLocation').textContent = `Localidad: ${holiday.location}`;
    } else {
      holidayInfo.classList.add('hidden');
    }
  }
  
  
  // Foto preview en modal
  const prevWrap = document.getElementById('photoPreviewWrap');
  const prevImg = document.getElementById('photoPreview');
  const pickBtn = document.getElementById('photoPickBtn');
  if (prevImg) prevImg.src = activePhotoData || "";
  if (prevWrap) prevWrap.classList.toggle('hidden', !activePhotoData);

  // Nota r√°pida (UI)
  const nq = document.getElementById('notaQuick');
  if (nq) nq.value = (info && info.n) ? String(info.n) : "";

  // Preview de turno
  const sp = document.getElementById('shiftPreviewTitle');
  if (sp) {
    if (mode === 'mixto') {
      sp.textContent = `${selT} / ${selB}`;
    } else {
      sp.textContent = selS;
    }
  }

// Configurar campos seg√∫n modo
  if (mode === 'simple') {
    const shift = SHIFTS[selS] || {in: '00:00', out: '00:00'};
    document.getElementById('tIn').value = info.tIn || shift.in;
    document.getElementById('tOut').value = info.tOut || shift.out;
    
    const hrs = info.h || calculateHours(document.getElementById('tIn').value, document.getElementById('tOut').value);
    document.getElementById('tHrs').value = hrs.toFixed(1);
    
    document.getElementById('time-simple').classList.remove('hidden');
    document.getElementById('time-mixto').classList.add('hidden');
    document.getElementById('note-simple').classList.remove('hidden');
    
    document.getElementById('nota').value = info.n || defaultNoteForShift(selS);
  } else {
    const topShift = SHIFTS[selT] || {in: '00:00', out: '00:00'};
    const bottomShift = SHIFTS[selB] || {in: '00:00', out: '00:00'};
    
    document.getElementById('tInTop').value = info.tInTop || topShift.in;
    document.getElementById('tOutTop').value = info.tOutTop || topShift.out;
    document.getElementById('tInBottom').value = info.tInBottom || bottomShift.in;
    document.getElementById('tOutBottom').value = info.tOutBottom || bottomShift.out;
    
    const hrsTop = info.hrsTop || calculateHours(document.getElementById('tInTop').value, document.getElementById('tOutTop').value);
    const hrsBottom = info.hrsBottom || calculateHours(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value);
    
    document.getElementById('tHrsTop').value = hrsTop.toFixed(1);
    document.getElementById('tHrsBottom').value = hrsBottom.toFixed(1);
    document.getElementById('tHrsMixto').value = (hrsTop + hrsBottom).toFixed(1);
    
    document.getElementById('time-simple').classList.add('hidden');
    document.getElementById('time-mixto').classList.remove('hidden');
    document.getElementById('note-simple').classList.add('hidden');
    
    document.getElementById('notaTop').value = info.noteTop || defaultNoteForShift(selT);
    document.getElementById('notaBottom').value = info.noteBottom || defaultNoteForShift(selB);
  }
  

  // ====== Inicializar auto-notes para no pisar edici√≥n manual ======
  try {
    if (mode === 'simple') {
      _autoNoteSimple = makeTimeNote(document.getElementById('tIn').value, document.getElementById('tOut').value) || defaultNoteForShift(selS);
      bindAutoNoteSyncSimple();
    } else {
      _autoNoteTop = makeTimeNote(document.getElementById('tInTop').value, document.getElementById('tOutTop').value) || defaultNoteForShift(selT);
      _autoNoteBottom = makeTimeNote(document.getElementById('tInBottom').value, document.getElementById('tOutBottom').value) || defaultNoteForShift(selB);
      bindAutoNoteSyncMixto();
    }
  } catch(e) {}

  setMode(mode);
  refreshShiftButtons();
  
  const modal = document.getElementById('modal');
  if (modal) modal.classList.add('active');
}

function closeModal(){ 
  const modal = document.getElementById('modal');
  if (modal) modal.classList.remove('active');
  // Asegura que el selector de turnos no quede abierto entre d√≠as
  try { if (window._setTurnArea) window._setTurnArea(false); } catch(e) {}
}

function setMode(m){
  mode = m;

  // Si se cambia a mixto desde simple, asegurar selecci√≥n por defecto en 'L'
  try {
    const user = db.users[db.current];
    if (user && m === 'mixto') {
      const keys = getVisibleShiftKeys(user);
      const fallback = (keys && keys.length) ? keys[0] : 'L';
      // En mixto, por defecto ambas partes deben iniciar en 'L' si existe.
      selT = keys.includes('L') ? 'L' : fallback;
      selB = keys.includes('L') ? 'L' : fallback;

      const SHIFTS = user.config || {};
      const shT = SHIFTS[selT] || {in:'00:00', out:'00:00'};
      const shB = SHIFTS[selB] || {in:'00:00', out:'00:00'};

      const tInTop = document.getElementById('tInTop');
      const tOutTop = document.getElementById('tOutTop');
      const tInBottom = document.getElementById('tInBottom');
      const tOutBottom = document.getElementById('tOutBottom');

      if (tInTop && tOutTop) { tInTop.value = shT.in; tOutTop.value = shT.out; }
      if (tInBottom && tOutBottom) { tInBottom.value = shB.in; tOutBottom.value = shB.out; }

      // Nota por defecto (luego el autoupdate la ajusta si corresponde)
      const nTop = document.getElementById('notaTop');
      const nBottom = document.getElementById('notaBottom');
      if (nTop && !(nTop.value||'').trim()) nTop.value = defaultNoteForShift(selT);
      if (nBottom && !(nBottom.value||'').trim()) nBottom.value = defaultNoteForShift(selB);

      if (typeof autoCalcMixtoTop === 'function') autoCalcMixtoTop();
      if (typeof autoCalcMixtoBottom === 'function') autoCalcMixtoBottom();
    }
  } catch(e) {}

  const simpleBtn = document.getElementById('m-s');
  const mixtoBtn = document.getElementById('m-m');
  
  if (simpleBtn && mixtoBtn) {
    simpleBtn.className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m === 'simple' ? 'bg-white shadow-md text-blue-600' : 'text-gray-400'}`;
    mixtoBtn.className = `flex-1 py-3 rounded-xl font-black text-[11px] uppercase ${m === 'mixto' ? 'bg-white shadow-md text-blue-600' : 'text-gray-400'}`;
  }
  
  // Mostrar/ocultar secciones
  const sections = ['sec-simple', 'sec-mixto', 'time-simple', 'time-mixto', 'note-simple'];
  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (id.includes('simple')) {
        el.classList.toggle('hidden', m !== 'simple');
      } else if (id.includes('mixto')) {
        el.classList.toggle('hidden', m !== 'mixto');
      }
    }
  });
}

function getVisibleShiftKeys(user){
  if(!user) return [];
  const keys = Object.keys(user.config || {});
  const visible = keys.filter(k => (['Ma√±ana','Tarde','16hrs','CENA','L','Vacaciones'].includes(k)) || (user.config[k] && user.config[k].enabled));
  const extras = visible.filter(k => !(['Ma√±ana','Tarde','16hrs','CENA','L','Vacaciones'].includes(k))).sort((a,b)=>a.localeCompare(b,'es'));
  return [...ALWAYS_VISIBLE_SHIFTS.filter(k=>visible.includes(k)), ...extras];
}

function refreshShiftButtons(){
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  const createButton = (key, selected, onClick) => {
    const shift = SHIFTS[key] || {color: 'L', label: key};
    const btn = document.createElement('div');
    btn.className = `shift-option ${selected ? 'selected' : ''} ${shiftBgClass(shift.color)}`;
    btn.style.cssText = shiftBgStyle(shift.color);
    btn.textContent = shift.label || key;
    btn.onclick = onClick;
    return btn;
  };
  
  // Simple mode buttons
  const simpleContainer = document.getElementById('sec-simple');
  if (simpleContainer) {
    simpleContainer.innerHTML = '';
    getVisibleShiftKeys(user).forEach(key => {
      const btn = createButton(key, selS === key, () => {
        selS = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tIn').value = shift.in;
        document.getElementById('tOut').value = shift.out;
        autoCalc();
        document.getElementById('nota').value = defaultNoteForShift(selS);
        refreshShiftButtons();
      });
      simpleContainer.appendChild(btn);
    });
  }
  
  // Mixto top buttons
  const topContainer = document.getElementById('mix-t');
  if (topContainer) {
    topContainer.innerHTML = '';
    getVisibleShiftKeys(user).forEach(key => {
      const btn = createButton(key, selT === key, () => {
        selT = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tInTop').value = shift.in;
        document.getElementById('tOutTop').value = shift.out;
        autoCalcMixtoTop();
        document.getElementById('notaTop').value = defaultNoteForShift(selT);
        refreshShiftButtons();
      });
      topContainer.appendChild(btn);
    });
  }
  
  // Mixto bottom buttons
  const bottomContainer = document.getElementById('mix-b');
  if (bottomContainer) {
    bottomContainer.innerHTML = '';
    getVisibleShiftKeys(user).forEach(key => {
      const btn = createButton(key, selB === key, () => {
        selB = key;
        const shift = SHIFTS[key] || {in: '00:00', out: '00:00'};
        document.getElementById('tInBottom').value = shift.in;
        document.getElementById('tOutBottom').value = shift.out;
        autoCalcMixtoBottom();
        document.getElementById('notaBottom').value = defaultNoteForShift(selB);
        refreshShiftButtons();
      });
      bottomContainer.appendChild(btn);
    });
  }
}

function autoCalc(){
  const tIn = document.getElementById('tIn');
  const tOut = document.getElementById('tOut');
  const tHrs = document.getElementById('tHrs');
  if (tIn && tOut && tHrs) {
    const hrs = calculateHours(tIn.value, tOut.value);
    tHrs.value = hrs.toFixed(1);
  }
}

function autoCalcMixtoTop(){
  const tInTop = document.getElementById('tInTop');
  const tOutTop = document.getElementById('tOutTop');
  const tHrsTop = document.getElementById('tHrsTop');
  if (tInTop && tOutTop && tHrsTop) {
    const hrs = calculateHours(tInTop.value, tOutTop.value);
    tHrsTop.value = hrs.toFixed(1);
    updateMixtoTotal();
  }
}

function autoCalcMixtoBottom(){
  const tInBottom = document.getElementById('tInBottom');
  const tOutBottom = document.getElementById('tOutBottom');
  const tHrsBottom = document.getElementById('tHrsBottom');
  if (tInBottom && tOutBottom && tHrsBottom) {
    const hrs = calculateHours(tInBottom.value, tOutBottom.value);
    tHrsBottom.value = hrs.toFixed(1);
    updateMixtoTotal();
  }
}

function updateMixtoTotal(){
  const tHrsTop = document.getElementById('tHrsTop');
  const tHrsBottom = document.getElementById('tHrsBottom');
  const tHrsMixto = document.getElementById('tHrsMixto');
  if (tHrsTop && tHrsBottom && tHrsMixto) {
    const total = (parseFloat(tHrsTop.value) || 0) + (parseFloat(tHrsBottom.value) || 0);
    tHrsMixto.value = total.toFixed(1);
  }
}

function maybeAutoNoteSimple(){
  const nota = document.getElementById('nota');
  const tInEl = document.getElementById('tIn');
  const tOutEl = document.getElementById('tOut');
  if (!nota) return;

  const note = (nota.value||'').trim();
  const def = defaultNoteForShift(selS);
  const auto = (tInEl && tOutEl) ? makeTimeNote(tInEl.value, tOutEl.value) : '';

  // Prioridad: si el usuario edit√≥ (nota distinta al √∫ltimo auto o al default), NO se pisa.
  if (!note || note === def || note === _autoNoteSimple) {
    if (auto) { nota.value = auto; _autoNoteSimple = auto; }
    else if (!note && def) { nota.value = def; _autoNoteSimple = def; }
  }
}

function maybeAutoNoteMixto(){
  const tInTop = document.getElementById('tInTop');
  const tOutTop = document.getElementById('tOutTop');
  const tInBottom = document.getElementById('tInBottom');
  const tOutBottom = document.getElementById('tOutBottom');
  const notaTop = document.getElementById('notaTop');
  const notaBottom = document.getElementById('notaBottom');
  if (!notaTop || !notaBottom) return;

  const defTop = defaultNoteForShift(selT);
  const defBottom = defaultNoteForShift(selB);

  const autoTop = (tInTop && tOutTop) ? makeTimeNote(tInTop.value, tOutTop.value) : '';
  const autoBottom = (tInBottom && tOutBottom) ? makeTimeNote(tInBottom.value, tOutBottom.value) : '';

  const curTop = (notaTop.value||'').trim();
  const curBottom = (notaBottom.value||'').trim();

  // Si est√° vac√≠o / default / √∫ltimo auto => se auto-actualiza con el rango de horas actual.
  if (!curTop || curTop === defTop || curTop === _autoNoteTop) {
    if (autoTop) { notaTop.value = autoTop; _autoNoteTop = autoTop; }
    else if (!curTop && defTop) { notaTop.value = defTop; _autoNoteTop = defTop; }
  }

  if (!curBottom || curBottom === defBottom || curBottom === _autoNoteBottom) {
    if (autoBottom) { notaBottom.value = autoBottom; _autoNoteBottom = autoBottom; }
    else if (!curBottom && defBottom) { notaBottom.value = defBottom; _autoNoteBottom = defBottom; }
  }
}


// =========================================================
// Copiar / pegar (PC + Touch) + Foto + UI modal mejorada
// =========================================================
let clipboardDayData = null;      // copia completa (turno + notas + foto)
let clipboardShiftOnly = null;    // solo turno (sin nota/foto)
let pasteMode = false;
let activePhotoData = "";

function deepCopy(obj){ return obj ? JSON.parse(JSON.stringify(obj)) : obj; }

function setPasteMode(on){
  pasteMode = !!on;
  const btn = document.getElementById('actPasteMode');
  if(btn) btn.textContent = `üñ±Ô∏è Modo pegar: ${pasteMode ? 'ON' : 'OFF'}`;
  const pasteHere = document.getElementById('btnPasteHere');
  if(pasteHere) pasteHere.classList.toggle('opacity-40', !clipboardDayData && !clipboardShiftOnly);
}

function copyDay(key){
  const user = db.users[db.current]; if(!user) return;
  clipboardDayData = deepCopy(user.data[key] || null);
  clipboardShiftOnly = null;
  setPasteMode(false);
}

function copyShift(key){
  const user = db.users[db.current]; if(!user) return;
  const src = user.data[key] || null;
  if(!src){ clipboardShiftOnly = null; return; }
  // solo campos relacionados al turno + horas/notas internas
  const out = deepCopy(src);
  // conservar nota dentro del turno (n) porque forma parte del d√≠a laboral
  clipboardShiftOnly = out;
  clipboardDayData = null;
  setPasteMode(false);
}

function pasteTo(key){
  const user = db.users[db.current]; if(!user) return;
  const src = clipboardDayData || clipboardShiftOnly;
  if(!src) return;
  user.data[key] = deepCopy(src);
  saveDB(); render(); renderSummaryCategories(); calcSummary();
}

function hideDayMenu(){
  const m = document.getElementById('dayActionsMenu');
  if(m) m.classList.add('hidden');
}

let menuKey = null;
function showDayMenu(x,y,key){
  menuKey = key;
  const m = document.getElementById('dayActionsMenu');
  if(!m) return;
  // actualizar estado
  const pasteBtn = document.getElementById('actPaste');
  const pmBtn = document.getElementById('actPasteMode');
  const canPaste = !!(clipboardDayData || clipboardShiftOnly);
  if(pasteBtn) pasteBtn.classList.toggle('opacity-40', !canPaste);
  if(pmBtn) pmBtn.textContent = `üñ±Ô∏è Modo pegar: ${pasteMode ? 'ON' : 'OFF'}`;
  m.style.left = Math.min(x, window.innerWidth - 260) + 'px';
  m.style.top  = Math.min(y, window.innerHeight - 260) + 'px';
  m.classList.remove('hidden');
}

document.addEventListener('click', (e)=>{
  const m = document.getElementById('dayActionsMenu');
  if(!m) return;
  if(!m.contains(e.target)) hideDayMenu();
}, true);

document.addEventListener('scroll', ()=>hideDayMenu(), true);
window.addEventListener('resize', ()=>hideDayMenu());

document.addEventListener('DOMContentLoaded', ()=>{
  const c1 = document.getElementById('actCopyDay');
  const c2 = document.getElementById('actCopyShift');
  const p  = document.getElementById('actPaste');
  const pm = document.getElementById('actPasteMode');
  const cl = document.getElementById('actClear');

  if(c1) c1.onclick = ()=>{ if(menuKey){ copyDay(menuKey); } hideDayMenu(); };
  if(c2) c2.onclick = ()=>{ if(menuKey){ copyShift(menuKey); } hideDayMenu(); };
  if(p)  p.onclick  = ()=>{ if(menuKey){ pasteTo(menuKey); } hideDayMenu(); };
  if(pm) pm.onclick = ()=>{ setPasteMode(!pasteMode); hideDayMenu(); };
  if(cl) cl.onclick = ()=>{ clipboardDayData=null; clipboardShiftOnly=null; setPasteMode(false); hideDayMenu(); };

  // Modal: botones copiar/pegar
  const bCopy = document.getElementById('btnCopyThisDay');
  const bPaste = document.getElementById('btnPasteHere');
  if(bCopy) bCopy.onclick = ()=>{ if(activeKey) copyDay(activeKey); };
  if(bPaste) bPaste.onclick = ()=>{ if(activeKey) pasteTo(activeKey); };

    const bClear = document.getElementById('btnClearShift');
const btnOpenTurnPicker = document.getElementById('btnOpenTurnPicker');
const turnArea = document.getElementById('turnPickerArea');
let turnAreaOpen = false;
const setTurnArea = (open)=>{ turnAreaOpen = !!open; if(turnArea) turnArea.classList.toggle('hidden', !turnAreaOpen); };
// expuesto para reiniciar al cambiar de d√≠a
window._setTurnArea = setTurnArea;
// por defecto, picker cerrado para no saturar
setTurnArea(false);

if(btnOpenTurnPicker){
  btnOpenTurnPicker.addEventListener('click', (ev)=>{
    ev.preventDefault(); ev.stopPropagation();
    setTurnArea(!turnAreaOpen);
  });
}

  const modalCloseX = document.getElementById('modalCloseX') || document.getElementById('modalX');
  if(modalCloseX){ modalCloseX.onclick = ()=>{ try { if (window._setTurnArea) window._setTurnArea(false); } catch(e) {}
  closeModal(); }; }

  if (bClear) bClear.onclick = ()=>{ 
    const user = db.users[db.current];
    if (!user || !activeKey) return;

    // RESETEO A DEFAULT: el d√≠a queda expl√≠citamente como L con comentario LIBRE
    // (no se deja "sin data", para evitar inconsistencias visuales y de exportaci√≥n)
    const noteLibre = 'LIBRE';
    user.data[activeKey] = {
      mode: 'simple',
      s: 'L',
      tIn: '00:00',
      tOut: '00:00',
      h: 0,
      n: noteLibre
    };

    // Quitar foto si exist√≠a
    if (user.data[activeKey].photoData) delete user.data[activeKey].photoData;
    activePhotoData = '';

    // Persistir y resetear UI del modal
    saveDB();

    selS = 'L';
    selT = 'L';
    selB = 'L';
    mode = 'simple';

    const sp = document.getElementById('shiftPreviewTitle');
    if (sp) sp.textContent = 'L';

    const nota = document.getElementById('nota');
    if (nota) nota.value = noteLibre || 'LIBRE';
    const nq = document.getElementById('notaQuick');
    if (nq) nq.value = noteLibre || 'LIBRE';

    // Limpia horas visibles (simple)
    const tIn = document.getElementById('tIn'); 
    const tOut = document.getElementById('tOut'); 
    const tHrs = document.getElementById('tHrs');
    if (tIn) tIn.value = '00:00'; 
    if (tOut) tOut.value = '00:00'; 
    if (tHrs) tHrs.value = '0';

    // Limpia horas visibles (mixto)
    const tInTop = document.getElementById('tInTop');
    const tOutTop = document.getElementById('tOutTop');
    const tHrsTop = document.getElementById('tHrsTop');
    const tInBottom = document.getElementById('tInBottom');
    const tOutBottom = document.getElementById('tOutBottom');
    const tHrsBottom = document.getElementById('tHrsBottom');
    if (tInTop) tInTop.value = '00:00';
    if (tOutTop) tOutTop.value = '00:00';
    if (tHrsTop) tHrsTop.value = '0';
    if (tInBottom) tInBottom.value = '00:00';
    if (tOutBottom) tOutBottom.value = '00:00';
    if (tHrsBottom) tHrsBottom.value = '0';

    const noteTop = document.getElementById('noteTop');
    const noteBottom = document.getElementById('noteBottom');
    if (noteTop) noteTop.value = '';
    if (noteBottom) noteBottom.value = '';

    // Limpia preview de foto
    const prevWrap = document.getElementById('photoPreviewWrap');
    const prevImg = document.getElementById('photoPreview');
    if (prevImg) prevImg.src = "";
    if (prevWrap) prevWrap.classList.add('hidden');

    updateShiftCard(); 
    updateNotesPreview();
    render(); 
    renderSummaryCategories(); 
    calcSummary();

    try { if (window._setTurnArea) window._setTurnArea(false); } catch(e) {}

    toast('Turno vaciado (L - LIBRE)');
  };

// Modal: foto
  const inp = document.getElementById('photoInput');
  const pick = document.getElementById('photoPickBtn');
  const prevWrap = document.getElementById('photoPreviewWrap');
  const prevImg = document.getElementById('photoPreview');
  const rem = document.getElementById('photoRemoveBtn');

  if(pick && inp) pick.onclick = ()=> inp.click();
  if(inp){
    inp.onchange = ()=>{
      const f = inp.files && inp.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        activePhotoData = String(reader.result || '');
        if(prevImg) prevImg.src = activePhotoData;
        if(prevWrap) prevWrap.classList.remove('hidden');
      };
      reader.readAsDataURL(f);
    };
  }
  if(rem){
    rem.onclick = ()=>{
      activePhotoData = "";
      if(inp) inp.value = "";
      if(prevImg) prevImg.src = "";
      if(prevWrap) prevWrap.classList.add('hidden');
    };
  }

  // Modal: nota r√°pida sincroniza con nota principal
  const nq = document.getElementById('notaQuick');
  const n1 = document.getElementById('nota');
  if(nq && n1){
    const sync = ()=>{
      n1.value = nq.value;
    };
    nq.addEventListener('input', sync);
    n1.addEventListener('input', ()=>{ nq.value = n1.value; });
  }
});

function saveDay(){
  const user = db.users[db.current];
  if (!user) return;

  let data;

  if (mode === 'simple') {
    const shift = user.config[selS] || {in:'00:00', out:'00:00'};
    let tIn = document.getElementById('tIn').value;
    let tOut = document.getElementById('tOut').value;

    const noteRaw = (document.getElementById('nota').value || '').trim();
    const parsed = parseTimeRangeFromNote(noteRaw);
    if (parsed) { tIn = parsed.in; tOut = parsed.out; }

    const hrs = parseFloat(document.getElementById('tHrs').value) || 0;

    let finalNote = noteRaw;
    if (!finalNote) {
      // Si hay horario v√°lido -> reflejarlo; si no, usar default
      if (String(selS||'').toUpperCase() === 'L') {
        finalNote = defaultNoteForShift('L');
      } else {
        const auto = makeTimeNote(tIn, tOut);
        finalNote = auto || defaultNoteForShift(selS);
      }
    }

    data = {
      mode: 'simple',
      s: selS,
      tIn,
      tOut,
      h: hrs,
      n: finalNote
    };

  } else {
    const topShift = user.config[selT] || {in:'00:00', out:'00:00'};
    const bottomShift = user.config[selB] || {in:'00:00', out:'00:00'};

    let tInTop = document.getElementById('tInTop').value;
    let tOutTop = document.getElementById('tOutTop').value;
    let tInBottom = document.getElementById('tInBottom').value;
    let tOutBottom = document.getElementById('tOutBottom').value;

    const noteTopRaw = (document.getElementById('notaTop').value || '').trim();
    const noteBottomRaw = (document.getElementById('notaBottom').value || '').trim();

    const parsedTop = parseTimeRangeFromNote(noteTopRaw);
    if (parsedTop) { tInTop = parsedTop.in; tOutTop = parsedTop.out; }

    const parsedBottom = parseTimeRangeFromNote(noteBottomRaw);
    if (parsedBottom) { tInBottom = parsedBottom.in; tOutBottom = parsedBottom.out; }

    const hrsTop = parseFloat(document.getElementById('tHrsTop').value) || 0;
    const hrsBottom = parseFloat(document.getElementById('tHrsBottom').value) || 0;

    let finalTop = noteTopRaw;
    if (!finalTop) {
      const auto = makeTimeNote(tInTop, tOutTop);
      finalTop = auto || defaultNoteForShift(selT);
    }

    let finalBottom = noteBottomRaw;
    if (!finalBottom) {
      const auto = makeTimeNote(tInBottom, tOutBottom);
      finalBottom = auto || defaultNoteForShift(selB);
    }

    data = {
      mode: 'mixto',
      t: selT,
      b: selB,
      tInTop,
      tOutTop,
      tInBottom,
      tOutBottom,
      hrsTop,
      hrsBottom,
      h: parseFloat(document.getElementById('tHrsMixto').value) || (hrsTop + hrsBottom),
      noteTop: finalTop,
      noteBottom: finalBottom,
      n: `${finalTop} | ${finalBottom}`
    };
  }

  if (activePhotoData) data.photoData = activePhotoData;
  user.data[activeKey] = data;
  saveDB();
  render();
  renderSummaryCategories();
  calcSummary();
  try { if (window._setTurnArea) window._setTurnArea(false); } catch(e) {}
  closeModal();
}

// =========================================================
// Shift Settings Functions
// =========================================================
function renderSettings(){
  const container = document.getElementById('settings-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  // Ordenar: turnos por defecto primero, luego los dem√°s
  const defaultShifts = ['Ma√±ana','Tarde','16hrs','CENA','L','Vacaciones'];
  const otherShifts = Object.keys(SHIFTS).filter(s => !defaultShifts.includes(s)).sort();
  const sortedShifts = [...defaultShifts.filter(s => SHIFTS[s]), ...otherShifts];
  
  sortedShifts.forEach(id => {
    const conf = SHIFTS[id];
    container.innerHTML += `
      <div class="flex items-start gap-3 bg-gradient-to-r from-gray-50 to-white p-4 rounded-2xl border border-gray-200">
        <div class="w-10 h-10 rounded-full ${shiftBgClass(conf.color)} border-2 border-white shadow-sm flex items-center justify-center flex-shrink-0" style="${shiftBgStyle(conf.color)}">
          <span class="text-[10px] font-black text-gray-800">${(conf.label||id).charAt(0)}</span>
        </div>
        <div class="flex-1">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</p>
              <input id="set-label-${cssSafe(id)}" value="${escapeHTML(conf.label||id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
              <div class="mt-2 flex items-center gap-2">
                <input type="checkbox" id="set-vis-${cssSafe(id)}" ${ (ALWAYS_VISIBLE_SHIFTS.includes(id) || conf.enabled) ? 'checked' : '' } ${ (ALWAYS_VISIBLE_SHIFTS.includes(id) && !isAdminUser()) ? 'disabled' : '' }>
                <label for="set-vis-${cssSafe(id)}" class="text-[10px] font-black uppercase text-gray-500">Visible en selector</label>
              </div>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Categor√≠a</p>
              <select id="set-cat-${cssSafe(id)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900">
                ${Object.keys(db.categories).map(cid => {
                  const c = db.categories[cid];
                  return `<option value="${cid}" ${conf.cat === cid ? 'selected' : ''}>${escapeHTML(c.icon)} ${escapeHTML(c.name)}</option>`;
                }).join('')}
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Color</p>
              <div class="flex items-center gap-2">
              <select id="set-color-${cssSafe(id)}" onchange="syncShiftColorPicker('${id}')" class="flex-1 bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900">
                ${['Ma√±ana','Tarde','CENA','16hrs','L','Vacaciones','Cumplea√±os','Ausencia','azul','rojo','verde','naranja','rosa','cian','morado','lima','ambar','teal','indigo','gris'].map(x =>
                  `<option value="${x}" ${(!String(conf.color||'').startsWith('#') && conf.color === x) ? 'selected' : ''}>${x}</option>`
                ).join('')}
                <option value="__custom__" ${String(conf.color||'').startsWith('#') ? 'selected' : ''}>Personalizado</option>
              </select>
              <input type="color" id="set-colorpick-${cssSafe(id)}" value="${shiftToHex(conf.color)}"
                     onchange="document.getElementById('set-color-${cssSafe(id)}').value='__custom__';"
                     class="w-12 h-10 p-1 bg-white border border-gray-200 rounded-xl"/>
            </div>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Entrada</p>
              <input type="time" id="set-in-${cssSafe(id)}" value="${conf.in || '00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
            </div>
            <div>
              <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Salida</p>
              <input type="time" id="set-out-${cssSafe(id)}" value="${conf.out || '00:00'}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
            </div>
          </div>
          
          <div class="mt-2">
            <p class="text-[9px] font-black text-gray-400 uppercase mb-1">Nota sugerida (editable)</p>
            <input id="set-note-${cssSafe(id)}" value="${escapeHTML(conf.note || '')}" placeholder="Ej: LIBRE / 06:00-14:00 / texto" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
            <div class="mt-1 text-[10px] font-bold text-gray-500">
              Si est√° vac√≠o, se usar√° el horario (HH:MM-HH:MM) o la etiqueta.
            </div>
          </div>
        </div>
        
        <button onclick="deleteShift('${id}')" class="p-2 text-red-600 hover:text-red-800 font-black" title="Eliminar turno">üóëÔ∏è</button>
      </div>
    `;
  });
  
  loadCategoriesSelect();
}

function saveShiftSettings(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const user = db.users[db.current];
  if (!user) return;
  
  const SHIFTS = user.config;
  
  const propagate = document.getElementById('propagateShiftEdits').checked;
  const oldConfig = JSON.parse(JSON.stringify(SHIFTS));
  
  Object.keys(SHIFTS).forEach(id => {
    const safeId = cssSafe(id);
    const label = document.getElementById(`set-label-${safeId}`)?.value?.trim() || id;
    const cat = document.getElementById(`set-cat-${safeId}`)?.value || SHIFTS[id].cat;
    const colorSel = document.getElementById(`set-color-${safeId}`)?.value;
    const colorPick = document.getElementById(`set-colorpick-${safeId}`)?.value;
    const color = (colorSel === '__custom__' && colorPick) ? colorPick : (colorSel || SHIFTS[id].color);
    const inTime = document.getElementById(`set-in-${safeId}`)?.value || SHIFTS[id].in || '00:00';
    const outTime = document.getElementById(`set-out-${safeId}`)?.value || SHIFTS[id].out || '00:00';
    const note = document.getElementById(`set-note-${safeId}`)?.value?.toString().trim() || '';

    const vis = document.getElementById(`set-vis-${safeId}`);
    const enabled = (ALWAYS_VISIBLE_SHIFTS.includes(id) && !isAdminUser()) ? true : (!!vis && vis.checked);

    
    SHIFTS[id].label = label;
    SHIFTS[id].cat = cat;
    SHIFTS[id].color = color;
    SHIFTS[id].in = inTime;
    SHIFTS[id].out = outTime;
    SHIFTS[id].note = note;
    SHIFTS[id].enabled = enabled;
  });
  
  if(propagate){
    const y = current.getFullYear();
    const m1 = current.getMonth() + 1;
    
    Object.keys(user.data).forEach(k => {
      if(!k.startsWith(`${y}-${m1}-`)) return;
      const d = user.data[k];
      
      if(d.mode === 'simple'){
        const sid = d.s;
        if(!sid || !SHIFTS[sid]) return;
        const was = oldConfig[sid];
        const now = SHIFTS[sid];
        
        if(was && (was.in !== now.in || was.out !== now.out)){
          d.tIn = now.in;
          d.tOut = now.out;
          d.h = calculateHours(now.in, now.out);
          
          const wasNote = String(d.n || '').trim();
          const oldStd = (was.in && was.out && !(was.in === '00:00' && was.out === '00:00')) ? 
            `${was.in}-${was.out}` : (was.label || sid).toUpperCase();
          const newStd = (now.in && now.out && !(now.in === '00:00' && now.out === '00:00')) ? 
            `${now.in}-${now.out}` : (now.label || sid).toUpperCase();
          
          if(!wasNote || wasNote === oldStd) d.n = newStd;
        }
      } else if(d.mode === 'mixto'){
        const applyPart = (partKey, inField, outField, hrsField, noteField) => {
          const sid = d[partKey];
          if(!sid || !SHIFTS[sid]) return;
          const was = oldConfig[sid];
          const now = SHIFTS[sid];
          
          if(was && (was.in !== now.in || was.out !== now.out)){
            d[inField] = now.in;
            d[outField] = now.out;
            d[hrsField] = calculateHours(now.in, now.out);
            
            const oldStd = (was.in && was.out && !(was.in === '00:00' && was.out === '00:00')) ? 
              `${was.in}-${was.out}` : (was.label || sid).toUpperCase();
            const newStd = (now.in && now.out && !(now.in === '00:00' && now.out === '00:00')) ? 
              `${now.in}-${now.out}` : (now.label || sid).toUpperCase();
            
            if(!d[noteField] || d[noteField] === oldStd) d[noteField] = newStd;
          }
        };
        
        applyPart('t', 'tInTop', 'tOutTop', 'hrsTop', 'noteTop');
        applyPart('b', 'tInBottom', 'tOutBottom', 'hrsBottom', 'noteBottom');
        
        d.h = (parseFloat(d.hrsTop) || 0) + (parseFloat(d.hrsBottom) || 0);
        d.n = `${d.noteTop || ''} | ${d.noteBottom || ''}`.trim();
      }
    });
  }
  
  saveDB();
  render();
  renderSummaryCategories();
  calcSummary();
  alert("Turnos actualizados.");
}

function deleteShift(id){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  // No permitir eliminar turnos base importantes
  const protectedShifts = ['L','Vacaciones','Ausencia','Cumplea√±os'];
  if(protectedShifts.includes(id)) return alert("No se puede eliminar este turno base.");
  
  const user = db.users[db.current];
  if (!user) return;
  
  // Verificar si el turno est√° en uso
  const used = Object.values(user.data).some(d => {
    if(d.mode === 'mixto') return d.t === id || d.b === id;
    return d.s === id;
  });
  
  if(used) return alert("No se puede eliminar: el turno est√° usado en el calendario del perfil.");
  
  if(!confirm(`¬øEliminar turno "${id}"?`)) return;
  
  delete user.config[id];
  saveDB();
  renderSettings();
  render();
  renderSummaryCategories();
  calcSummary();
}

// =========================================================
// New Shift Functions
// =========================================================
function selectColor(color, ev){
  selectedColor = color;
  document.getElementById('newShiftColor').value = color;
  document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
  if(ev && ev.target) ev.target.classList.add('selected');
}

function loadCategoriesSelect(){
  const select = document.getElementById('newShiftCat');
  if (!select) return;
  
  select.innerHTML = Object.keys(db.categories).map(cid => {
    const c = db.categories[cid];
    return `<option value="${cid}" style="color: #111827; font-weight: 800;">${escapeHTML(c.icon)} ${escapeHTML(c.name)}</option>`;
  }).join('');
}

function addNewShift(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const name = document.getElementById('newShiftName').value.trim();
  const color = document.getElementById('newShiftColor').value;
  const cat = document.getElementById('newShiftCat').value;
  const inTime = document.getElementById('newShiftIn').value || '00:00';
  const outTime = document.getElementById('newShiftOut').value || '00:00';
  const note = (document.getElementById('newShiftNote')?.value || '').toString().trim();
  
  if(!name) return alert("Nombre requerido.");
  
  const key = name.replace(/\s+/g, '_').toUpperCase();
  const user = db.users[db.current];
  if (!user) return;
  
  if(user.config[key]) return alert("Ya existe un turno con ese nombre (ID).");
  
  user.config[key] = {
    label: name,
    color: color,
    cat: cat,
    in: inTime,
    out: outTime,
    note: note,
    enabled: true
  };
  
  saveDB();
  renderSettings();
  render();
  
  // Limpiar formulario
  document.getElementById('newShiftName').value = '';
  document.getElementById('newShiftIn').value = '';
  document.getElementById('newShiftOut').value = '';
  document.getElementById('newShiftNote').value = '';
  
  alert("Turno agregado.");
}

// =========================================================
// Categories Functions
// =========================================================
function renderCategories(){
  const container = document.getElementById('categories-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  const ids = Object.keys(db.categories).sort((a, b) => 
    db.categories[a].name.localeCompare(db.categories[b].name)
  );
  
  ids.forEach(cid => {
    const c = db.categories[cid];
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg" style="background: ${c.color || '#3b82f6'}20; color: ${c.color || '#3b82f6'};">
          ${escapeHTML(c.icon)}
        </div>
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="cat-name-${cid}" value="${escapeHTML(c.name)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Icono</div>
            <input id="cat-icon-${cid}" value="${escapeHTML(c.icon)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
          </div>
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Color</div>
            <input type="color" id="cat-color-${cid}" value="${c.color || '#3b82f6'}" class="w-full h-10 bg-white border-gray-200 focus:border-blue-400 rounded-xl"/>
          </div>
          <div class="md:col-span-2 text-[10px] font-bold text-gray-500">
            ID: <span class="font-black text-gray-800">${cid}</span>
          </div>
        </div>
        <button onclick="deleteCategory('${cid}')" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>
      </div>
    `;
  });
}

function addNewCategory(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const name = document.getElementById('newCategoryName').value.trim();
  const icon = document.getElementById('newCategoryIcon').value;
  
  if(!name) return alert("Nombre requerido.");
  
  const cid = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
  if(db.categories[cid]) return alert("Ya existe una categor√≠a con ese ID.");
  
  db.categories[cid] = {
    name: name,
    icon: icon,
    color: '#6b7280'
  };
  
  saveDB();
  document.getElementById('newCategoryName').value = '';
  renderCategories();
  renderSummaryCategories();
  loadCategoriesSelect();
  alert("Categor√≠a agregada.");
}

function deleteCategory(cid){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  // Verificar si la categor√≠a est√° en uso
  const used = Object.values(db.users).some(u => 
    Object.values(u.config).some(s => s.cat === cid)
  );
  
  if(used) return alert("No se puede eliminar: hay turnos usando esta categor√≠a.");
  
  if(!confirm(`¬øEliminar categor√≠a "${db.categories[cid].name}"?`)) return;
  
  delete db.categories[cid];
  saveDB();
  renderCategories();
  renderSummaryCategories();
  loadCategoriesSelect();
  alert("Categor√≠a eliminada.");
}

function saveCategories(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  Object.keys(db.categories).forEach(cid => {
    const name = document.getElementById(`cat-name-${cid}`)?.value?.trim();
    const icon = document.getElementById(`cat-icon-${cid}`)?.value?.trim();
    const color = document.getElementById(`cat-color-${cid}`)?.value;
    
    if(name) db.categories[cid].name = name;
    if(icon) db.categories[cid].icon = icon;
    if(color) db.categories[cid].color = color;
  });
  
  saveDB();
  renderCategories();
  renderSummaryCategories();
  loadCategoriesSelect();
  renderSettings();
  render();
  alert("Categor√≠as actualizadas.");
}

// =========================================================
// Localities Functions
// =========================================================
function renderLocalities(){
  const container = document.getElementById('localities-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  // Asegurar que "General" existe y es √∫nico
  db.localities = Array.from(new Set(db.localities.map(x => String(x).trim()).filter(Boolean)));
  if(!db.localities.some(x => x.toUpperCase() === 'GENERAL')) {
    db.localities.unshift('General');
  }
  
  db.localities.forEach((loc, idx) => {
    const isGeneral = loc.trim().toUpperCase() === 'GENERAL';
    container.innerHTML += `
      <div class="flex items-center gap-3 p-4 border-b border-gray-100">
        <div class="w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center font-black text-sky-700 flex-shrink-0">
          üìç
        </div>
        <div class="flex-1">
          <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
          <input id="loc-${idx}" value="${escapeHTML(loc)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900" ${isGeneral ? 'disabled' : ''}/>
          <div class="text-[10px] font-bold text-gray-500 mt-1">${isGeneral ? 'Reservado para asuetos generales.' : ''}</div>
        </div>
        ${isGeneral ? 
          `<span class="text-[9px] font-black text-gray-400">Bloqueado</span>` : 
          `<button onclick="deleteLocality(${idx})" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>`
        }
      </div>
    `;
  });
  
  refreshHolidayLocationSelects();
  refreshProfileLocationSelects();
}

function addLocality(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const name = document.getElementById('newLocalityName').value.trim();
  if(!name) return alert("Nombre requerido.");
  if(name.toUpperCase() === 'GENERAL') return alert('"General" es reservado.');
  
  if(db.localities.some(x => x.trim().toUpperCase() === name.trim().toUpperCase())) {
    return alert("Ya existe esa localidad.");
  }
  
  db.localities.push(name);
  document.getElementById('newLocalityName').value = '';
  saveDB();
  renderLocalities();
  alert("Localidad agregada.");
}

function deleteLocality(idx){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const loc = db.localities[idx];
  if(!loc || loc.toUpperCase() === 'GENERAL') return;
  
  // Verificar si la localidad est√° en uso
  const usedUser = Object.values(db.users).some(u => 
    (u.locality || '').trim().toUpperCase() === loc.trim().toUpperCase()
  );
  
  const usedHoliday = Object.values(db.holidays).some(h => 
    (h.location || '').trim().toUpperCase() === loc.trim().toUpperCase()
  );
  
  if(usedUser || usedHoliday) {
    return alert("No se puede eliminar: est√° en uso por perfiles o asuetos. Cambia primero esas referencias.");
  }
  
  if(!confirm(`¬øEliminar localidad "${loc}"?`)) return;
  
  db.localities.splice(idx, 1);
  saveDB();
  renderLocalities();
}

function saveLocalities(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const oldList = [...db.localities];
  const newList = [];
  
  for(let i = 0; i < oldList.length; i++){
    const oldLoc = oldList[i];
    const isGeneral = oldLoc.trim().toUpperCase() === 'GENERAL';
    if(isGeneral){
      newList.push('General');
      continue;
    }
    
    const v = document.getElementById(`loc-${i}`)?.value?.trim();
    if(!v) continue;
    if(v.toUpperCase() === 'GENERAL') continue;
    newList.push(v);
  }
  
  // Asegurar que "General" est√° primero
  if(!newList.some(x => x.toUpperCase() === 'GENERAL')) {
    newList.unshift('General');
  }
  
  // Encontrar cambios de nombre
  const renamePairs = [];
  for(let i = 0; i < oldList.length; i++){
    const a = String(oldList[i] || '').trim();
    const b = (document.getElementById(`loc-${i}`)?.value || a).trim();
    if(a && b && a.toUpperCase() !== 'GENERAL' && a.toUpperCase() !== b.toUpperCase()){
      renamePairs.push([a, b]);
    }
  }
  
  db.localities = Array.from(new Set(newList.map(x => String(x).trim()).filter(Boolean)));
  
  // Aplicar cambios de nombre
  renamePairs.forEach(([from, to]) => {
    // Actualizar usuarios
    Object.values(db.users).forEach(u => {
      if((u.locality || '').trim().toUpperCase() === from.trim().toUpperCase()) {
        u.locality = to;
      }
    });
    
    // Actualizar asuetos
    Object.keys(db.holidays).forEach(k => {
      const h = db.holidays[k];
      if((h.location || '').trim().toUpperCase() === from.trim().toUpperCase()) {
        h.location = to;
      }
    });
  });
  
  saveDB();
  renderLocalities();
  renderHolidays();
  renderProfilesList();
  render();
  alert("Localidades actualizadas.");
}

function refreshHolidayLocationSelects(){
  const select = document.getElementById('newHolidayLocation');
  if (select) {
    select.innerHTML = db.localities.map(l => 
      `<option value="${escapeHTML(l)}" ${l.toUpperCase() === 'GENERAL' ? 'selected' : ''} style="color: #111827; font-weight: 800;">${escapeHTML(l)}</option>`
    ).join('');
  }
}

function refreshProfileLocationSelects(){
  const createLoc = document.getElementById('createLoc');
  if (createLoc) {
    createLoc.innerHTML = db.localities
      .filter(l => l.toUpperCase() !== 'GENERAL')
      .map(l => `<option value="${escapeHTML(l)}" ${l === 'San Salvador' ? 'selected' : ''} style="color: #111827; font-weight: 800;">${escapeHTML(l)}</option>`)
      .join('');
  }
}

// =========================================================
// Holidays Functions
// =========================================================
function renderHolidays(){
  const container = document.getElementById('holidays-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  const keys = Object.keys(db.holidays).sort((a, b) => new Date(a) - new Date(b));
  
  if(keys.length === 0){
    container.innerHTML = `
      <div class="p-8 text-center text-gray-400 font-bold">
        No hay asuetos configurados.
      </div>
    `;
    return;
  }
  
  keys.forEach(k => {
    const h = db.holidays[k];
    const [y, m, d] = k.split('-');
    
    container.innerHTML += `
      <div class="p-4 border-b border-gray-100">
        <div class="flex items-center justify-between gap-2">
          <div class="font-black text-gray-900 text-[12px]">${escapeHTML(h.name || 'Asueto')}</div>
          <button onclick="deleteHoliday('${k}')" class="p-2 text-red-600 hover:text-red-800 font-black">üóëÔ∏è</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Fecha</div>
            <input id="h-date-${cssSafe(k)}" type="date" value="${toISODate(y, m, d)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
          </div>
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Nombre</div>
            <input id="h-name-${cssSafe(k)}" value="${escapeHTML(h.name || '')}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="h-loc-${cssSafe(k)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900">
              ${db.localities.map(l => 
                `<option value="${escapeHTML(l)}" ${(h.location || 'General') === l ? 'selected' : ''}>${escapeHTML(l)}</option>`
              ).join('')}
            </select>
          </div>
        </div>
      </div>
    `;
  });
}

function addNewHoliday(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const dateInput = document.getElementById('newHolidayDate').value;
  const name = document.getElementById('newHolidayName').value.trim();
  const loc = document.getElementById('newHolidayLocation').value || 'General';
  
  if(!dateInput || !name) return alert("Fecha y nombre requeridos.");
  
  const dt = new Date(dateInput + 'T00:00:00');
  const key = dayKey(dt.getFullYear(), dt.getMonth() + 1, dt.getDate());
  
  db.holidays[key] = {
    name: name,
    location: loc
  };
  
  document.getElementById('newHolidayDate').value = '';
  document.getElementById('newHolidayName').value = '';
  saveDB();
  renderHolidays();
  render();
  alert("Asueto agregado.");
}

function deleteHoliday(k){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  if(!confirm(`¬øEliminar asueto del ${k}?`)) return;
  
  delete db.holidays[k];
  saveDB();
  renderHolidays();
  render();
  alert("Asueto eliminado.");
}

function saveHolidays(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const newHolidays = {};
  const keys = Object.keys(db.holidays);
  
  keys.forEach(oldKey => {
    const safeKey = cssSafe(oldKey);
    const dateVal = document.getElementById(`h-date-${safeKey}`)?.value;
    const nameVal = document.getElementById(`h-name-${safeKey}`)?.value?.trim();
    const locVal = document.getElementById(`h-loc-${safeKey}`)?.value || 'General';
    
    if(!dateVal || !nameVal) return;
    
    const dt = new Date(dateVal + 'T00:00:00');
    const newKey = dayKey(dt.getFullYear(), dt.getMonth() + 1, dt.getDate());
    
    newHolidays[newKey] = {
      name: nameVal,
      location: locVal
    };
  });
  
  db.holidays = newHolidays;
  saveDB();
  renderHolidays();
  render();
  alert("Asuetos actualizados.");
}

// =========================================================
// PIN Functions
// =========================================================
function savePinOnly(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const user = db.users[db.current];
  if (!user) return;
  
  const p = document.getElementById('changePinInput').value;
  const c = document.getElementById('confirmPinInput').value;
  
  if(!p || p.length !== 4 || isNaN(p)) return alert("PIN inv√°lido (debe ser 4 d√≠gitos).");
  if(p !== c) return alert("PIN no coincide.");
  
  user.pin = p;
  document.getElementById('changePinInput').value = '';
  document.getElementById('confirmPinInput').value = '';
  saveDB();
  alert("PIN actualizado.");
}

// =========================================================
// Profiles Modal Functions - CORREGIDO: Nombres visibles
// =========================================================

function deleteAllProfilesExceptAdmin(){
  // Acci√≥n administrativa: requiere PIN universal o PIN de ADMIN
  const p = prompt("CONFIRMACI√ìN: Ingresa PIN de ADMIN (o PIN universal) para eliminar TODOS los perfiles y dejar solo ADMIN:");
  const adminPin = db.users?.ADMIN?.pin;
  if(p !== adminPin && p !== ADMIN_UNIVERSAL_PIN){
    return alert("PIN incorrecto. Operaci√≥n cancelada.");
  }

  if(!confirm("Esto eliminar√° TODOS los perfiles excepto ADMIN. ¬øDeseas continuar?")) return;

  const keep = 'ADMIN';
  const keys = Object.keys(db.users || {});
  keys.forEach(k => {
    if(k !== keep) delete db.users[k];
  });

  db.current = keep;
  saveDB();

  // Refrescar UI
  updateUserDropdown();
  updateUserInitial();
  render();
  renderSummaryCategories();
  calcSummary();
  renderProfilesList();

  alert("Listo: se eliminaron todos los perfiles y se dej√≥ √∫nicamente ADMIN.");
}


function openProfilesModal(){
  refreshProfileLocationSelects();
  renderProfilesList();
  
  const modal = document.getElementById('profilesModal');
  if (modal) modal.classList.add('active');
}

function closeProfilesModal(){
  const modal = document.getElementById('profilesModal');
  if (modal) modal.classList.remove('active');
}

function createProfile(){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const name = document.getElementById('createName').value.trim().toUpperCase();
  const pin = document.getElementById('createPin').value.trim();
  const loc = document.getElementById('createLoc').value || 'San Salvador';
  
  if(!name || name.length < 2) return alert("Nombre inv√°lido.");
  if(!pin || pin.length !== 4 || isNaN(pin)) return alert("PIN inv√°lido (debe ser 4 d√≠gitos).");
  if(db.users[name]) return alert("Ya existe ese perfil.");
  
  db.users[name] = {
    pin: pin,
    editLocked: false,
    locality: loc,
    data: {},
    config: JSON.parse(JSON.stringify(db.users.ADMIN.config))
  };
  
  ensureImportBaseShiftsForUser(name);
  
  db.current = name;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  
  document.getElementById('createName').value = '';
  document.getElementById('createPin').value = '';
  
  alert("Perfil creado.");
}

function renderProfilesList(){
  const container = document.getElementById('profilesList');
  if (!container) return;
  
  container.innerHTML = '';
  
  const keys = Object.keys(db.users).sort();
  
  keys.forEach(u => {
    const user = db.users[u];
    const isCurrent = (u === db.current);
    
    container.innerHTML += `
      <div class="border border-gray-200 rounded-2xl p-3 ${isCurrent ? 'bg-blue-50 border-blue-200' : ''}">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="font-black text-gray-900 text-[12px]">
              ${escapeHTML(u)} ${isCurrent ? '<span class="ml-2 text-[9px] font-black text-blue-600">(Actual)</span>' : ''}
            </div>
            <div class="text-[10px] font-bold text-gray-500">
              Localidad: <span class="font-black text-gray-800">${escapeHTML(user.locality || 'San Salvador')}</span>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="setCurrentProfile('${u}')" class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-[10px] font-black uppercase">
              Usar
            </button>
            ${u === 'ADMIN' ? '' : `
              <button onclick="deleteProfile('${u}')" class="px-3 py-2 rounded-xl bg-red-100 hover:bg-red-200 text-red-700 text-[10px] font-black uppercase">
                Eliminar
              </button>
            `}
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
          <div class="md:col-span-2">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Renombrar perfil</div>
            <input id="p-name-${cssSafe(u)}" value="${escapeHTML(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900" ${u === 'ADMIN' ? 'disabled' : ''}/>
          </div>
          <div>
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">PIN</div>
            <input id="p-pin-${cssSafe(u)}" value="${escapeHTML(user.pin || '0000')}" maxlength="4" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900"/>
          </div>
          <div class="md:col-span-3">
            <div class="text-[9px] font-black text-gray-400 uppercase mb-1">Localidad</div>
            <select id="p-loc-${cssSafe(u)}" class="w-full bg-white border-gray-200 focus:border-blue-400 rounded-xl text-gray-900">
              ${db.localities
                .filter(l => l.toUpperCase() !== 'GENERAL')
                .map(l => `<option value="${escapeHTML(l)}" ${(user.locality || 'San Salvador') === l ? 'selected' : ''}>${escapeHTML(l)}</option>`)
                .join('')}
            </select>
          </div>
          <div class="md:col-span-3">
            <button onclick="saveProfileEdits('${u}')" class="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[11px]">
              üíæ Guardar cambios de este perfil
            </button>
          </div>
        </div>
      </div>
    `;
  });
}

function setCurrentProfile(u){
  db.current = u;
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  closeProfilesModal();
}

function deleteProfile(u){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  if(u === 'ADMIN') return alert("No se puede eliminar el perfil ADMIN.");
  
  if(!confirm(`¬øEliminar perfil "${u}"? Se perder√° su calendario.`)) return;
  
  delete db.users[u];
  if(db.current === u) db.current = 'ADMIN';
  
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  render();
  renderProfilesList();
  alert("Perfil eliminado.");
}

function saveProfileEdits(u){
  if(!isEditMode()) return alert("Activa modo edici√≥n.");
  
  const user = db.users[u];
  if (!user) return;
  
  const pin = document.getElementById(`p-pin-${cssSafe(u)}`)?.value?.trim();
  const loc = document.getElementById(`p-loc-${cssSafe(u)}`)?.value || 'San Salvador';
  
  if(!pin || pin.length !== 4 || isNaN(pin)) return alert("PIN inv√°lido (4 d√≠gitos).");
  
  user.pin = pin;
  user.locality = loc;
  
  if(u !== 'ADMIN'){
    const newName = document.getElementById(`p-name-${cssSafe(u)}`)?.value?.trim()?.toUpperCase();
    if(newName && newName !== u){
      if(db.users[newName]) return alert("No se puede renombrar: ya existe ese nombre.");
      
      db.users[newName] = user;
      delete db.users[u];
      
      if(db.current === u) db.current = newName;
    }
  }
  
  saveDB();
  updateUserDropdown();
  updateUserInitial();
  renderProfilesList();
  render();
  alert("Perfil actualizado.");
}

// =========================================================
// Import Functions - CORREGIDO: Nombres visibles en lista
// =========================================================
function openImportModal(){
  document.getElementById('importFile').value = '';
  document.getElementById('importInfo').innerText = '';
  document.getElementById('importUsersList').innerHTML = `
    <div class="text-gray-400 font-bold">Adjunta un Excel y presiona "Analizar".</div>
  `;
  
  importContext = null;
  
  const importMonth = document.getElementById('importMonth');
  const importYear = document.getElementById('importYear');
  if (importMonth) importMonth.value = current.getMonth();
  if (importYear) importYear.value = current.getFullYear();
  
  const modal = document.getElementById('importModal');
  if (modal) modal.classList.add('active');
}

function closeImportModal(){
  const modal = document.getElementById('importModal');
  if (modal) modal.classList.remove('active');
}

function closeImportModalAndRefresh(){
  closeImportModal();
  render();
  renderSummaryCategories();
  calcSummary();
}

function selectAllImportUsers(flag){
  document.querySelectorAll('.impUserChk').forEach(ch => {
    ch.checked = flag;
  });
}

async function analyzeImportFile(){
  const fileInput = document.getElementById('importFile');
  if(!fileInput.files || !fileInput.files[0]) {
    return alert("Selecciona un archivo Excel.");
  }

  try {
    const data = await fileInput.files[0].arrayBuffer();
    const wb = XLSX.read(data, { type: 'array' });

    // Elegir la hoja m√°s probable (no asumir la primera)
    let best = null;
    for(const sn of wb.SheetNames){
      const ws = wb.Sheets[sn];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' });
      const headerIdx = findHeaderRow(rows);
      if(headerIdx < 0) continue;
      const headerRow = rows[headerIdx] || [];
      const dayCols = buildDayColumnMap(headerRow);
      const score = Object.keys(dayCols).length;

      // Preferir hojas con m√°s d√≠as detectados, y con keywords t√≠picas
      const joined = headerRow.map(x => String(x||'').trim()).join(' | ').toUpperCase();
      const kw = (joined.includes('PERSONAL')||joined.includes('NOMBRE')?2:0) + (joined.includes('EMP')||joined.includes('EMPLE')||joined.includes('ID')?1:0);

      const finalScore = score*10 + kw;
      if(!best || finalScore > best.finalScore){
        best = { sn, rows, headerIdx, headerRow, dayCols, finalScore };
      }
    }

    if(!best){
      return alert("No se pudo detectar una hoja v√°lida. Verifica que el archivo tenga una tabla con d√≠as (1..31 o fechas).");
    }

    const { sn: sheetName, rows, headerIdx, headerRow, dayCols } = best;

    // Detectar mes y a√±o (en esa hoja)
    const detected = detectMonthYearFromRows(rows);
    const fallbackMonth = parseInt(document.getElementById('importMonth').value);
    const fallbackYear = parseInt(document.getElementById('importYear').value);
    const monthIndex0 = (detected.month ?? fallbackMonth);
    const year = (detected.year ?? fallbackYear);

    // Detectar columnas nombre/empleado (robusto)
    const cols = inferNameEmpCols(rows, headerIdx, headerRow, dayCols);
    const nameCol = cols.nameCol;
    const empCol  = cols.empCol;

    if(nameCol < 0 || Object.keys(dayCols).length < 10) {
      return alert("Formato no reconocido: no se pudo detectar columna de nombre o suficientes d√≠as.");
    }

    // Extraer usuarios y turnos detectados
    const usersSet = new Set();
    const codesSet = new Set();

    for(let r = headerIdx + 1; r < rows.length; r++){
      const row = rows[r] || [];
      if(!isLikelyDataRow(row, nameCol, empCol, dayCols)) continue;

      const name = safeNameCell(row[nameCol]).toUpperCase();
      if(name) usersSet.add(name);

      for(const d of Object.keys(dayCols)){
        const code = normalizeCode(row[dayCols[d]]);
        if(code && code !== 'X') codesSet.add(code);
      }
    }

    // Construir mapeo categor√≠a por c√≥digo (solo para turnos, no ausencias)
    const turnCodes = Array.from(codesSet)
      .filter(c => !!codeToShiftDef(c))
      .filter(c => !IMPORT_ABSENCE_MAP[c]) // excluir L/V/... (estatus)
      .sort();

    importContext = {
      wb, sheetName, rows, headerIdx, nameCol, empCol, dayCols, monthIndex0, year,
      users: Array.from(usersSet).sort(),
      codeCatMap: {}
    };

    // Mostrar usuarios
    const list = document.getElementById('importUsersList');
    if(importContext.users.length === 0){
      list.innerHTML = `<div class="text-gray-400 font-bold">No se detectaron usuarios.</div>`;
    } else {
      list.innerHTML = importContext.users.map(u => `
        <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer" style="color: #111827;">
          <input class="impUserChk" type="checkbox" value="${escapeHTML(u)}" checked>
          <span class="font-black">${escapeHTML(u)}</span>
        </label>
      `).join('');
    }

    // Mostrar mapeo de turnos -> categor√≠a (si aplica)
    buildImportTurnsCategoryMapUI(turnCodes);

    document.getElementById('importInfo').innerText =
      `Hoja: ${sheetName} | Detectado: ${MONTHS[monthIndex0]} ${year}. Usuarios: ${importContext.users.length}. Turnos: ${turnCodes.length}.`;

  } catch (error) {
    console.error('Error analizando archivo:', error);
    alert(`Error al analizar el archivo: ${error.message}`);
  }
}



function inferNameEmpCols(rows, headerIdx, headerRow, dayCols){
  let nameCol = -1, empCol = -1;

  // 1) Por palabras clave en encabezado
  for(let c = 0; c < headerRow.length; c++){
    const s = String(headerRow[c] || '').toUpperCase().trim();
    if(nameCol < 0 && (s.includes('PERSONAL') || s.includes('NOMBRE') || s.includes('COLAB') || s.includes('EMPLEADO'))) nameCol = c;
    if(empCol  < 0 && (s.includes('NO. EMP') || s.includes('NO EMP') || s.includes('EMP') || s.includes('ID') || s.includes('CODIGO'))) empCol = c;
  }

  // 2) Inferencia si faltan
  if(nameCol < 0 || empCol < 0){
    const sampleRows = [];
    for(let r = headerIdx + 1; r < Math.min(rows.length, headerIdx + 60); r++){
      const row = rows[r] || [];
      // debe tener algo en d√≠as
      let any = false;
      for(const d of Object.keys(dayCols)){
        const code = normalizeCode(row[dayCols[d]]);
        if(code && code !== 'X') { any = true; break; }
      }
      if(any) sampleRows.push(row);
    }

    const colCount = headerRow.length;
    const stats = Array.from({length: colCount}, () => ({digits:0, text:0, filled:0, total:0, avgLen:0}));

    sampleRows.forEach(row => {
      for(let c=0;c<colCount;c++){
        const v = safeNameCell(row[c]);
        if(!v) continue;
        stats[c].filled++;
        stats[c].total++;
        stats[c].avgLen += v.length;
        if(/^[0-9]+$/.test(v)) stats[c].digits++;
        else stats[c].text++;
      }
    });

    stats.forEach(s => { if(s.filled>0) s.avgLen = s.avgLen / s.filled; });

    // empCol: la que m√°s parezca num√©rica y est√© llena
    if(empCol < 0){
      let best=-1, bestScore=-1;
      for(let c=0;c<colCount;c++){
        // evitar columnas d√≠a
        if(Object.values(dayCols).includes(c)) continue;
        const s=stats[c];
        const score = s.digits*3 + s.filled - s.text;
        if(score>bestScore){ bestScore=score; best=c; }
      }
      if(bestScore>0) empCol=best;
    }

    // nameCol: la que m√°s parezca texto largo
    if(nameCol < 0){
      let best=-1, bestScore=-1;
      for(let c=0;c<colCount;c++){
        if(Object.values(dayCols).includes(c)) continue;
        const s=stats[c];
        const score = s.text*3 + s.avgLen + s.filled;
        if(score>bestScore){ bestScore=score; best=c; }
      }
      if(bestScore>0) nameCol=best;
    }
  }

  // empCol puede ser opcional
  return { nameCol, empCol };
}

function loadImportDefaultCategorySelect(){
  const sel = document.getElementById('importDefaultCategory');
  if(!sel) return;
  sel.innerHTML = Object.keys(db.categories).map(cid => 
    `<option value="${cid}">${escapeHTML(db.categories[cid].icon || 'üè∑Ô∏è')} ${escapeHTML(db.categories[cid].name)}</option>`
  ).join('');
  if(db.categories['work']) sel.value = 'work';
}

function buildImportTurnsCategoryMapUI(turnCodes){
  const box = document.getElementById('importTurnsBox');
  const list = document.getElementById('importTurnsList');
  if(!box || !list) return;

  loadImportDefaultCategorySelect();

  if(!turnCodes || turnCodes.length === 0){
    box.classList.add('hidden');
    list.innerHTML = '';
    return;
  }

  // valor por defecto
  const defSel = document.getElementById('importDefaultCategory');
  const defaultCid = defSel ? defSel.value : 'work';

  // Inicializar mapa
  importContext.codeCatMap = importContext.codeCatMap || {};
  turnCodes.forEach(code => {
    if(!importContext.codeCatMap[code]) importContext.codeCatMap[code] = defaultCid;
  });

  list.innerHTML = turnCodes.map(code => {
    const currentCid = importContext.codeCatMap[code] || defaultCid;
    return `
      <div class="flex items-center gap-2 bg-white border border-gray-200 rounded-xl p-2">
        <div class="w-16 text-center text-[11px] font-black text-gray-800">${escapeHTML(code)}</div>
        <select class="impTurnCat flex-1 bg-gray-50 border border-gray-200 rounded-xl p-2 text-[11px] font-bold text-gray-900" data-code="${escapeHTML(code)}">
          ${Object.keys(db.categories).map(cid => `<option value="${cid}" ${cid===currentCid?'selected':''}>${escapeHTML(db.categories[cid].icon||'üè∑Ô∏è')} ${escapeHTML(db.categories[cid].name)}</option>`).join('')}
        </select>
      </div>
    `;
  }).join('');

  // handler
  Array.from(document.querySelectorAll('.impTurnCat')).forEach(sel => {
    sel.onchange = () => {
      const code = sel.getAttribute('data-code');
      importContext.codeCatMap[code] = sel.value;
    };
  });

  box.classList.remove('hidden');
}

function applyImportCategoryToAll(){
  const defSel = document.getElementById('importDefaultCategory');
  if(!defSel || !importContext) return;
  const cid = defSel.value;
  Array.from(document.querySelectorAll('.impTurnCat')).forEach(sel => {
    sel.value = cid;
    const code = sel.getAttribute('data-code');
    if(code) importContext.codeCatMap[code] = cid;
  });
}

function detectMonthYearFromRows(rows){
  const monthsMap = {
    'ENERO':0,'FEBRERO':1,'MARZO':2,'ABRIL':3,'MAYO':4,'JUNIO':5,
    'JULIO':6,'AGOSTO':7,'SEPTIEMBRE':8,'OCTUBRE':9,'NOVIEMBRE':10,'DICIEMBRE':11
  };
  
  let foundMonth = null, foundYear = null;
  
  for(let r = 0; r < Math.min(rows.length, 50); r++){
    const row = rows[r] || [];
    for(let c = 0; c < row.length; c++){
      const v = row[c];
      if(!v) continue;
      
      const s = String(v).toUpperCase();
      
      // Buscar mes
      Object.keys(monthsMap).forEach(mn => {
        if(s.includes(mn) && foundMonth === null) foundMonth = monthsMap[mn];
      });
      
      // Buscar a√±o
      const yMatch = s.match(/A√ëO\s*([0-9]{4})/);
      if(yMatch) foundYear = parseInt(yMatch[1]);
      
      const yMatch2 = s.match(/(20\d{2})/);
      if(yMatch2 && !foundYear) foundYear = parseInt(yMatch2[1]);
    }
  }
  
  return { month: foundMonth, year: foundYear };
}

function findHeaderRow(rows){
  // Busca la fila que mejor parezca encabezado:
  // - Muchos d√≠as (1..31) o fechas
  // - Palabras clave tipo PERSONAL/NOMBRE/EMPLEADO/ID
  let best = { idx: -1, score: -1 };

  for(let r = 0; r < Math.min(rows.length, 80); r++){
    const row = rows[r] || [];
    if(row.length < 5) continue;

    const headerRow = row.map(x => String(x || '').trim());
    const joined = headerRow.join(' | ').toUpperCase();

    // Conteo de columnas d√≠a
    const dayCols = buildDayColumnMap(headerRow);
    const dayCount = Object.keys(dayCols).length;

    // Palabras clave
    let kw = 0;
    if(joined.includes('PERSONAL') || joined.includes('NOMBRE')) kw += 3;
    if(joined.includes('EMPLE') || joined.includes('EMP') || joined.includes('NO. EMP') || joined.includes('ID')) kw += 2;
    if(joined.includes('TURNO') || joined.includes('HORARIO')) kw += 1;

    const score = dayCount * 5 + kw;

    if(dayCount >= 10 && score > best.score){
      best = { idx: r, score };
    }
  }

  return best.idx;
}


function buildDayColumnMap(headerRow){
  const map = {};
  for(let c = 0; c < headerRow.length; c++){
    const raw = headerRow[c];
    const s0 = String(raw || '').trim();
    if(!s0) continue;

    // Caso 1: encabezado es solo n√∫mero (1..31)
    if(/^\d+$/.test(s0)){
      const d = parseInt(s0);
      if(d >= 1 && d <= 31) map[d] = c;
      continue;
    }

    // Caso 2: encabezado contiene fecha (dd/mm/yyyy, d/m, yyyy-mm-dd, etc.)
    const s = s0.replace(/\s+/g,'');
    let m = s.match(/^([0-9]{1,2})[\/-]([0-9]{1,2})(?:[\/-]([0-9]{2,4}))?$/);
    if(m){
      const d = parseInt(m[1]);
      if(d>=1 && d<=31) { map[d]=c; continue; }
    }
    m = s.match(/^(?:20\d{2})[\/-]([0-9]{1,2})[\/-]([0-9]{1,2})$/);
    if(m){
      const d = parseInt(m[2]);
      if(d>=1 && d<=31) { map[d]=c; continue; }
    }

    // Caso 3: encabezado tipo "DIA 1", "1 (LUN)", etc.
    const m2 = s0.match(/\b([0-9]{1,2})\b/);
    if(m2){
      const d = parseInt(m2[1]);
      if(d>=1 && d<=31) map[d]=c;
    }
  }
  return map;
}


function safeNameCell(v){
  return String(v || '').replace(/\s+/g, ' ').trim();
}

async function analyzeImportFile(){
  const fileInput = document.getElementById('importFile');
  if(!fileInput.files || !fileInput.files[0]) {
    return alert("Selecciona un archivo Excel.");
  }

  try {
    const data = await fileInput.files[0].arrayBuffer();
    const wb = XLSX.read(data, { type: 'array' });

    // Elegir la hoja m√°s probable (no asumir la primera)
    let best = null;
    for(const sn of wb.SheetNames){
      const ws = wb.Sheets[sn];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' });
      const headerIdx = findHeaderRow(rows);
      if(headerIdx < 0) continue;
      const headerRow = rows[headerIdx] || [];
      const dayCols = buildDayColumnMap(headerRow);
      const score = Object.keys(dayCols).length;

      // Preferir hojas con m√°s d√≠as detectados, y con keywords t√≠picas
      const joined = headerRow.map(x => String(x||'').trim()).join(' | ').toUpperCase();
      const kw = (joined.includes('PERSONAL')||joined.includes('NOMBRE')?2:0) + (joined.includes('EMP')||joined.includes('EMPLE')||joined.includes('ID')?1:0);

      const finalScore = score*10 + kw;
      if(!best || finalScore > best.finalScore){
        best = { sn, rows, headerIdx, headerRow, dayCols, finalScore };
      }
    }

    if(!best){
      return alert("No se pudo detectar una hoja v√°lida. Verifica que el archivo tenga una tabla con d√≠as (1..31 o fechas).");
    }

    const { sn: sheetName, rows, headerIdx, headerRow, dayCols } = best;

    // Detectar mes y a√±o (en esa hoja)
    const detected = detectMonthYearFromRows(rows);
    const fallbackMonth = parseInt(document.getElementById('importMonth').value);
    const fallbackYear = parseInt(document.getElementById('importYear').value);
    const monthIndex0 = (detected.month ?? fallbackMonth);
    const year = (detected.year ?? fallbackYear);

    // Detectar columnas nombre/empleado (robusto)
    const cols = inferNameEmpCols(rows, headerIdx, headerRow, dayCols);
    const nameCol = cols.nameCol;
    const empCol  = cols.empCol;

    if(nameCol < 0 || Object.keys(dayCols).length < 10) {
      return alert("Formato no reconocido: no se pudo detectar columna de nombre o suficientes d√≠as.");
    }

    // Extraer usuarios y turnos detectados
    const usersSet = new Set();
    const codesSet = new Set();

    for(let r = headerIdx + 1; r < rows.length; r++){
      const row = rows[r] || [];
      if(!isLikelyDataRow(row, nameCol, empCol, dayCols)) continue;

      const name = safeNameCell(row[nameCol]).toUpperCase();
      if(name) usersSet.add(name);

      for(const d of Object.keys(dayCols)){
        const code = normalizeCode(row[dayCols[d]]);
        if(code && code !== 'X') codesSet.add(code);
      }
    }

    // Construir mapeo categor√≠a por c√≥digo (solo para turnos, no ausencias)
    const turnCodes = Array.from(codesSet)
      .filter(c => !!codeToShiftDef(c))
      .filter(c => !IMPORT_ABSENCE_MAP[c]) // excluir L/V/... (estatus)
      .sort();

    importContext = {
      wb, sheetName, rows, headerIdx, nameCol, empCol, dayCols, monthIndex0, year,
      users: Array.from(usersSet).sort(),
      codeCatMap: {}
    };

    // Mostrar usuarios
    const list = document.getElementById('importUsersList');
    if(importContext.users.length === 0){
      list.innerHTML = `<div class="text-gray-400 font-bold">No se detectaron usuarios.</div>`;
    } else {
      list.innerHTML = importContext.users.map(u => `
        <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer" style="color: #111827;">
          <input class="impUserChk" type="checkbox" value="${escapeHTML(u)}" checked>
          <span class="font-black">${escapeHTML(u)}</span>
        </label>
      `).join('');
    }

    // Mostrar mapeo de turnos -> categor√≠a (si aplica)
    buildImportTurnsCategoryMapUI(turnCodes);

    document.getElementById('importInfo').innerText =
      `Hoja: ${sheetName} | Detectado: ${MONTHS[monthIndex0]} ${year}. Usuarios: ${importContext.users.length}. Turnos: ${turnCodes.length}.`;

  } catch (error) {
    console.error('Error analizando archivo:', error);
    alert(`Error al analizar el archivo: ${error.message}`);
  }
}



function runImportSelected(){
  if(!importContext) return alert("Primero analiza el archivo.");
  
  const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'replace';
  const selected = Array.from(document.querySelectorAll('.impUserChk'))
    .filter(x => x.checked)
    .map(x => x.value);
  
  if(selected.length === 0) return alert("Selecciona al menos un usuario.");
  
  const { rows, headerIdx, nameCol, empCol, dayCols, monthIndex0, year } = importContext;
  
  // Asegurar que los usuarios existen
  selected.forEach(u => ensureUserExists(u));
  
  // Limpiar mes si es modo reemplazar
  if(importMode === 'replace'){
    selected.forEach(u => {
      const user = db.users[u];
      if (!user) return;
      
      const prefix = `${year}-${monthIndex0 + 1}-`;
      Object.keys(user.data).forEach(k => {
        if(k.startsWith(prefix)) delete user.data[k];
      });
    });
  }
  
  let written = 0;
  
  // Procesar filas
  for(let r = headerIdx + 1; r < rows.length; r++){
    const row = rows[r] || [];
    if(!isLikelyDataRow(row, nameCol, empCol, dayCols)) continue;
    
    const name = safeNameCell(row[nameCol]).toUpperCase();
    if(!selected.includes(name)) continue;
    
    const userKey = ensureUserExists(name);
    const user = db.users[userKey];
    if (!user) continue;
    
    ensureImportBaseShiftsForUser(userKey);
    
    // Procesar cada d√≠a
    for(const dStr of Object.keys(dayCols)){
      const day = parseInt(dStr);
      let code = normalizeCode(row[dayCols[dStr]]);
      if(!code || code === 'X') code = 'L';
      
      let def = codeToShiftDef(code);
      if(!def) continue;

      // Aplicar categor√≠a asignada en el asistente (solo para turnos, no ausencias)
      if(importContext && importContext.codeCatMap && importContext.codeCatMap[code] && !IMPORT_ABSENCE_MAP[code]){
        def.cat = importContext.codeCatMap[code];
      }
      // Asegurar que el turno exista y quede habilitado (si viene del Excel)
      ensureShiftExistsForUser(userKey, def, true);
      
      const key = dayKey(year, monthIndex0 + 1, day);
      
      // Saltar si es modo merge y ya existe
      if(importMode === 'merge' && user.data[key]) continue;
      
      // Crear entrada
      const tIn = def.in || '00:00';
      const tOut = def.out || '00:00';
      const hrs = calculateHours(tIn, tOut);
      const note = def.note || ((tIn !== '00:00' || tOut !== '00:00') ? `${tIn}-${tOut}` : (def.label || def.key).toUpperCase());
      
      user.data[key] = {
        mode: 'simple',
        s: def.key,
        tIn: tIn,
        tOut: tOut,
        h: hrs,
        n: note
      };
      
      written++;
    }
  }
  
  saveDB();
  
  // Cambiar al primer usuario importado
  db.current = selected[0];
  current = new Date(year, monthIndex0, 1);
  saveDB();
  
  updateUserDropdown();
  updateUserInitial();
  updateMonthDisplay();
  render();
  renderSummaryCategories();
  calcSummary();
  
  document.getElementById('importInfo').innerHTML = `
    <div class="text-green-600 font-bold">
      Importaci√≥n completada!<br>
      Perfiles: ${selected.length} | Celdas: ${written}<br>
      Mes: ${MONTHS[monthIndex0]} ${year}<br>
      <button onclick="closeImportModalAndRefresh()" class="mt-2 px-4 py-2 bg-emerald-600 text-white rounded-xl font-black text-[10px]">
        ‚úÖ Cerrar y ver calendario
      </button>
    </div>
  `;
}

// =========================================================
// Export Functions - CORREGIDO: Texto visible en selects
// =========================================================
function showExportModal(){
  const exportMonth = document.getElementById('exportMonth');
  const exportYear = document.getElementById('exportYear');
  if (exportMonth) exportMonth.value = current.getMonth();
  if (exportYear) exportYear.value = current.getFullYear();
  
  buildExportUserList();
  document.getElementById('exportUsersBox').classList.add('hidden');
  
  // Configurar evento para mostrar/ocultar selector de usuarios
  document.querySelectorAll('input[name="exportScope"]').forEach(r => {
    r.onchange = () => {
      const v = document.querySelector('input[name="exportScope"]:checked')?.value;
      document.getElementById('exportUsersBox').classList.toggle('hidden', v !== 'select');
    };
  });
  
  const modal = document.getElementById('exportModal');
  if (modal) modal.classList.add('active');
}

function closeExportModal(){
  const modal = document.getElementById('exportModal');
  if (modal) modal.classList.remove('active');
}

function buildExportUserList(){
  const list = document.getElementById('exportUsersList');
  if (!list) return;
  
  const users = Object.keys(db.users).sort();
  list.innerHTML = users.map(u => `
    <label class="flex items-center gap-2 p-2 rounded-xl hover:bg-gray-50 cursor-pointer" style="color: #111827;">
      <input class="expUserChk" type="checkbox" value="${escapeHTML(u)}">
      <span class="font-black">${escapeHTML(u)}</span>
    </label>
  `).join('');
}

function selectAllExportUsers(flag){
  document.querySelectorAll('.expUserChk').forEach(ch => {
    ch.checked = flag;
  });
}

async function exportImages(){
  const monthIndex0 = parseInt(document.getElementById('exportMonth').value);
  const year = parseInt(document.getElementById('exportYear').value);
  const scope = document.querySelector('input[name="exportScope"]:checked')?.value || 'current';
  
  let targets = [];
  
  if(scope === 'current') targets = [db.current];
  else if(scope === 'all') targets = Object.keys(db.users).sort();
  else if(scope === 'select'){
    targets = Array.from(document.querySelectorAll('.expUserChk'))
      .filter(x => x.checked)
      .map(x => x.value);
    
    if(targets.length === 0) return alert("Selecciona al menos un perfil.");
  }
  
  closeExportModal();
  
  const originalCurrent = db.current;
  let exported = 0;
  
  for(const u of targets){
    try {
      db.current = u;
      updateUserInitial();
      
      const img = await buildExportImageForUser(u, year, monthIndex0);
      downloadDataUrl(img, `Turnos_${u}_${MONTHS[monthIndex0]}_${year}.png`);
      exported++;
      
      // Peque√±a pausa para evitar sobrecarga
      await new Promise(resolve => setTimeout(resolve, 100));
    } catch (error) {
      console.error(`Error exportando ${u}:`, error);
    }
  }
  
  // Restaurar usuario original
  db.current = originalCurrent;
  updateUserDropdown();
  updateUserInitial();
  render();
  
  if(exported > 0){
    alert(`Exportaci√≥n completada: ${exported} imagen(es) descargada(s).`);
  }
}

function downloadDataUrl(dataUrl, filename){
  const a = document.createElement('a');
  a.download = filename;
  a.href = dataUrl;
  a.click();
}

async function buildExportImageForUser(userKey, year, monthIndex0){
  const user = db.users[userKey];
  if (!user) throw new Error(`Usuario ${userKey} no encontrado`);
  
  const SHIFTS = user.config;
  const categories = db.categories;
  
  // Calcular estad√≠sticas
  const catHours = {};
  const catDays = {};
  Object.keys(categories).forEach(catId => {
    catHours[catId] = 0;
    catDays[catId] = 0;
  });
  
  let freeDays = 0, vacDays = 0, holidayWorked = 0;
  const daysInMonth = new Date(year, monthIndex0 + 1, 0).getDate();
  freeDays = 0;
  
  const m1 = monthIndex0 + 1;
  const todayStr = new Date().toLocaleDateString('es-ES');
  
  for(let day = 1; day <= daysInMonth; day++){
    const key = dayKey(year, m1, day);
    const d = user.data[key] || buildDefaultSimpleDay(user, 'L');
    const date = new Date(year, monthIndex0, day);
    const dow = date.getDay();
    const isHoliday = db.holidays[key] && holidayApplies(db.holidays[key].location, user.locality);
if(d.mode === 'mixto'){
      const topCat = SHIFTS[d.t]?.cat;
      const botCat = SHIFTS[d.b]?.cat;

      if(isHoliday && (topCat || botCat)) holidayWorked++;

      if(topCat && categories[topCat]){
        catHours[topCat] += (d.hrsTop || 0);
        catDays[topCat]++;
        if(topCat === 'off'){
          if((d.t || '') === 'Vacaciones') vacDays++;
          else freeDays++;
        }
      }

      if(botCat && categories[botCat]){
        catHours[botCat] += (d.hrsBottom || 0);
        catDays[botCat]++;
        if(botCat === 'off'){
          if((d.b || '') === 'Vacaciones') vacDays++;
          else freeDays++;
        }
      }
    } else {
      const cat = SHIFTS[d.s]?.cat;
      if(cat && categories[cat]){
        catHours[cat] += (d.h || 0);
        catDays[cat]++;

        if(cat === 'off'){
          if((d.s || '') === 'Vacaciones') vacDays++;
          else freeDays++;
        } else {
          if(isHoliday) holidayWorked++;
        }
      }
    }
  }

  freeDays = Math.max(0, freeDays);
  
  // Crear elemento temporal para html2canvas
  const temp = document.createElement('div');
  temp.style.position = 'fixed';
  temp.style.left = '-9999px';
  temp.style.top = '-9999px';
  temp.style.width = '1000px';
  temp.style.background = '#ffffff';
  temp.style.padding = '25px';
  temp.style.borderRadius = '12px';
  temp.style.boxShadow = '0 10px 30px rgba(0,0,0,0.1)';
  
  // Construir HTML de exportaci√≥n
  temp.innerHTML = buildExportHTML(userKey, user.locality, year, monthIndex0, todayStr, catHours, catDays, freeDays, vacDays, holidayWorked, SHIFTS, user, categories);
  
  document.body.appendChild(temp);
  
  try {
    const canvas = await html2canvas(temp, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      logging: false,
      allowTaint: true
    });
    
    const url = canvas.toDataURL('image/png', 1.0);
    document.body.removeChild(temp);
    return url;
  } catch (error) {
    document.body.removeChild(temp);
    throw error;
  }
}

function buildExportHTML(userKey, locality, year, monthIndex0, todayStr, catHours, catDays, freeDays, vacDays, holidayWorked, SHIFTS, user, categories){
  const monthName = MONTHS[monthIndex0];
  
  // Calcular total de horas
  const totalHours = Object.values(catHours).reduce((a, b) => a + b, 0);
  
  // Filtrar categor√≠as con datos
  const categoriesWithData = Object.keys(categories).filter(catId => 
    catDays[catId] > 0 || catHours[catId] > 0
  );
  
  let categoriesHTML = '';
  if(categoriesWithData.length > 0) {
    categoriesHTML = `
      <div style="margin-bottom:20px;border:1px solid #e5e7eb;border-radius:12px;padding:15px;">
        <div style="font-size:14px;font-weight:900;color:#334155;margin-bottom:12px;text-align:center;">
          RESUMEN POR CATEGOR√çA
        </div>
        <div style="display:grid;grid-template-columns:repeat(${Math.min(categoriesWithData.length, 4)},1fr);gap:15px;">
          ${categoriesWithData.map(catId => {
            const cat = categories[catId];
            return `
              <div style="text-align:center;padding:10px;border:1px solid #f1f5f9;border-radius:10px;background:#f8fafc;">
                <div style="font-size:11px;font-weight:900;color:#64748b;margin-bottom:6px;">
                  ${escapeHTML(cat.icon)} ${escapeHTML(cat.name)}
                </div>
                <div style="font-size:18px;font-weight:900;color:#0f172a;margin-bottom:4px;">
                  ${catHours[catId].toFixed(1)} HRS
                </div>
                <div style="font-size:10px;color:#64748b;font-weight:800;">
                  ${catDays[catId]} d√≠a${catDays[catId] !== 1 ? 's' : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }
  
  // Construir calendario para exportaci√≥n
  let calendarHTML = '';
  const firstDay = new Date(year, monthIndex0, 1).getDay();
  const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;
  const lastDate = new Date(year, monthIndex0 + 1, 0).getDate();
  
  // D√≠as del mes anterior (se muestran atenuados, con n√∫mero y turno)
  const prevLast = new Date(year, monthIndex0, 0);
  const prevYear = prevLast.getFullYear();
  const prevMonth0 = prevLast.getMonth();
  const prevLastDay = prevLast.getDate();
  for(let i = firstDayMonday-1; i >= 0; i--){
    const dPrev = prevLastDay - i;
    const keyPrev = dayKey(prevYear, prevMonth0+1, dPrev);
    const infoPrev = (user.data && user.data[keyPrev]) ? user.data[keyPrev] : null;
    const bgPrev = infoPrev ? getColorValue(infoPrev) : '#ffffff';
    const labelPrev = infoPrev ? (infoPrev.mode==='simple' ? (infoPrev.s||'') : (infoPrev.sTop||'')) : '';
    const dayHTMLPrev = `
      <div style="height:100px;position:relative;border:1px solid #e5e7eb;background:${bgPrev};opacity:0.35;">
        <div style="position:absolute;top:6px;right:8px;font-size:14px;color:#111827;font-weight:700;">${dPrev}</div>
        ${labelPrev ? `<div style="position:absolute;left:0;right:0;top:38px;text-align:center;font-weight:900;letter-spacing:0.5px;color:#111827;">${labelPrev}</div>` : ``}
      </div>`;
    calendarHTML += dayHTMLPrev;
  }

  // D√≠as del mes actual

  for(let d = 1; d <= lastDate; d++){
    const key = dayKey(year, monthIndex0 + 1, d);
    const info = user.data[key] || buildDefaultSimpleDay(user, 'L');
    const holiday = db.holidays[key];
    const isHoliday = holiday && holidayApplies(holiday.location, user.locality);
    
    let dayHTML = '';
    if(info.mode === 'mixto'){
      const topShift = SHIFTS[info.t] || {color: 'L', label: 'L'};
      const bottomShift = SHIFTS[info.b] || {color: 'L', label: 'L'};
      
      dayHTML = `
        <div style="height:100px;position:relative;border:1px solid #e5e7eb;">
          <div style="height:50%;background:${getColorValue(topShift.color)};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;border-bottom:1px solid rgba(0,0,0,0.1);">
            ${escapeHTML(topShift.label)}
          </div>
          <div style="height:50%;background:${getColorValue(bottomShift.color)};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;">
            ${escapeHTML(bottomShift.label)}
          </div>
          <div style="position:absolute;top:2px;right:2px;font-size:10px;font-weight:900;background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:4px;">
            ${d}
          </div>
          ${isHoliday ? `<div style="position:absolute;top:2px;left:2px;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,0.9);padding:1px 4px;border-radius:4px;">A</div>` : ''}
          ${info.noteTop ? `<div style="position:absolute;top:25%;left:50%;transform:translateX(-50%);font-size:8px;font-weight:900;background:rgba(255,255,255,0.95);padding:2px 5px;border-radius:3px;white-space:nowrap;max-width:90%;overflow:visible;">
            ${escapeHTML(info.noteTop)}
          </div>` : ''}
          ${info.noteBottom ? `<div style="position:absolute;bottom:10%;left:50%;transform:translateX(-50%);font-size:8px;font-weight:900;background:rgba(255,255,255,0.95);padding:2px 5px;border-radius:3px;white-space:nowrap;max-width:90%;overflow:visible;">
            ${escapeHTML(info.noteBottom)}
          </div>` : ''}
        </div>
      `;
    } else {
      const shift = SHIFTS[info.s] || {color: 'L', label: 'L'};
      dayHTML = `
        <div style="height:100px;background:${getColorValue(shift.color)};position:relative;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;border:1px solid #e5e7eb;">
          ${escapeHTML(shift.label)}
          <div style="position:absolute;top:2px;right:2px;font-size:10px;font-weight:900;background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:4px;">
            ${d}
          </div>
          ${isHoliday ? `<div style="position:absolute;top:2px;left:2px;font-size:8px;font-weight:900;color:#dc2626;background:rgba(254,226,226,0.9);padding:1px 4px;border-radius:4px;">A</div>` : ''}
          ${info.n ? `<div style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:900;background:rgba(255,255,255,0.95);padding:3px 6px;border-radius:4px;white-space:nowrap;max-width:90%;overflow:visible;border:1px solid rgba(0,0,0,0.1);">
            ${escapeHTML(info.n)}
          </div>` : ''}
        </div>
      `;
    }
    
    calendarHTML += dayHTML;
  }
  

// D√≠as del mes siguiente (visibles en pantalla, se exportan atenuados)
  const totalCells = firstDayMonday + lastDate;
  const trailing = (7 - (totalCells % 7)) % 7;
  const nextFirst = new Date(year, monthIndex0+1, 1);
  const nextYear = nextFirst.getFullYear();
  const nextMonth0 = nextFirst.getMonth();
  for(let i=1; i<=trailing; i++){
    const keyNext = dayKey(nextYear, nextMonth0+1, i);
    const infoNext = (user.data && user.data[keyNext]) ? user.data[keyNext] : null;
    const bgNext = infoNext ? getColorValue(infoNext) : '#ffffff';
    const labelNext = infoNext ? (infoNext.mode==='simple' ? (infoNext.s||'') : (infoNext.sTop||'')) : '';
    const dayHTMLNext = `
      <div style="height:100px;position:relative;border:1px solid #e5e7eb;background:${bgNext};opacity:0.35;">
        <div style="position:absolute;top:6px;right:8px;font-size:14px;color:#111827;font-weight:700;">${i}</div>
        ${labelNext ? `<div style="position:absolute;left:0;right:0;top:38px;text-align:center;font-weight:900;letter-spacing:0.5px;color:#111827;">${labelNext}</div>` : ``}
      </div>`;
    calendarHTML += dayHTMLNext;
  }


  // Turnos usados en el mes
  const usedShifts = Object.keys(SHIFTS)
    .filter(k => {
      const prefix = `${year}-${monthIndex0 + 1}-`;
      return Object.keys(user.data).some(key => 
        key.startsWith(prefix) && 
        (user.data[key].s === k || user.data[key].t === k || user.data[key].b === k)
      );
    });
  
  let legendHTML = '';
  if(usedShifts.length > 0){
    legendHTML = `
      <div style="margin-top:20px;border-top:2px solid #e5e7eb;padding-top:15px;">
        <div style="font-size:12px;font-weight:900;color:#334155;margin-bottom:10px;">LEYENDA DE TURNOS</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
          ${usedShifts.slice(0, 15).map(k => {
            const sh = SHIFTS[k];
            const schedule = (sh.in && sh.out && !(sh.in === '00:00' && sh.out === '00:00')) ? 
              `${sh.in}-${sh.out}` : 'Sin horario';
            return `
              <div style="display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #f1f5f9;border-radius:8px;">
                <div style="width:15px;height:15px;border-radius:4px;background:${getColorValue(sh.color)};border:1px solid #d1d5db;"></div>
                <div style="flex:1;">
                  <div style="font-size:10px;font-weight:900;color:#334155;">${escapeHTML(sh.label || k)}</div>
                  <div style="font-size:9px;color:#64748b;">${schedule}</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }
  
  return `
    <div style="font-family:system-ui,-apple-system,sans-serif;color:#0f172a;">
      <!-- Encabezado -->
      <div style="text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e5e7eb;">
        <div style="font-size:32px;font-weight:900;color:#0f172a;margin-bottom:5px;">
          ${escapeHTML(userKey)} - ${monthName} ${year}
        </div>
        <div style="font-size:13px;color:#64748b;font-weight:800;margin-bottom:8px;">
          Localidad: ${escapeHTML(locality || 'San Salvador')} ‚Ä¢ Generado: ${todayStr}
        </div>
        <div style="font-size:11px;color:#3b82f6;font-weight:900;background:#f0f9ff;padding:8px 15px;border-radius:20px;display:inline-block;">
          Total horas: ${totalHours.toFixed(1)} HRS
        </div>
      </div>
      
      <!-- Calendario -->
      <div style="margin-bottom:25px;">
        <div style="font-size:16px;font-weight:900;color:#334155;margin-bottom:12px;text-align:center;">
          CALENDARIO - ${monthName} ${year}
        </div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e5e7eb;border:1px solid #e5e7eb;">
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#3b82f6;">LUN</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#64748b;">MAR</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#64748b;">MI√â</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#64748b;">JUE</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#64748b;">VIE</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#3b82f6;">S√ÅB</div>
          <div style="background:#f8fafc;padding:10px;text-align:center;font-weight:900;font-size:12px;color:#ef4444;">DOM</div>
          ${calendarHTML}
        </div>
      </div>
      
      <!-- Estad√≠sticas -->
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
        <div style="background:#f0f9ff;padding:15px;border-radius:12px;border:1px solid #bae6fd;">
          <div style="font-size:12px;font-weight:900;color:#0369a1;margin-bottom:10px;">üìä ESTAD√çSTICAS</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">D√≠as trabajados</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${(lastDate - freeDays - vacDays)}</div>
            </div>
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">D√≠as libres</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${freeDays}</div>
            </div>
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">Vacaciones</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${vacDays}</div>
            </div>
<div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">Asuetos trabajados</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${holidayWorked}</div>
            </div>
            <div>
              <div style="font-size:10px;color:#64748b;font-weight:800;">Total d√≠as mes</div>
              <div style="font-size:16px;font-weight:900;color:#0f172a;">${lastDate}</div>
            </div>
          </div>
        </div>
        
        <div style="background:#f0f9ff;padding:15px;border-radius:12px;border:1px solid #bae6fd;">
          <div style="font-size:12px;font-weight:900;color:#0369a1;margin-bottom:10px;">üìà RESUMEN</div>
          <div style="font-size:11px;color:#64748b;font-weight:800;margin-bottom:8px;">
            Total horas trabajadas: <span style="font-weight:900;color:#0f172a;font-size:14px;">${totalHours.toFixed(1)} HRS</span>
          </div>
          <div style="font-size:11px;color:#64748b;font-weight:800;margin-bottom:8px;">
            Promedio diario: <span style="font-weight:900;color:#0f172a;font-size:14px;">${(lastDate - freeDays - vacDays) > 0 ? (totalHours / (lastDate - freeDays - vacDays)).toFixed(1) : '0.0'} HRS/d√≠a</span>
          </div>
          <div style="font-size:11px;color:#64748b;font-weight:800;">
            Localidad perfil: <span style="font-weight:900;color:#0f172a;font-size:14px;">${escapeHTML(locality || 'San Salvador')}</span>
          </div>
        </div>
      </div>
      
      <!-- Categor√≠as (SOLO SI HAY DATOS) -->
      ${categoriesHTML}
      
      <!-- Leyenda (SOLO SI HAY TURNOS USADOS) -->
      ${legendHTML}
      
      <!-- Pie de p√°gina -->
      <div style="margin-top:25px;border-top:1px solid #e5e7eb;padding-top:15px;text-align:center;">
        <div style="font-size:10px;color:#94a3b8;font-weight:800;">
          Generado con Shifter Pro v23 ‚Ä¢ ${escapeHTML(userKey)} ‚Ä¢ ${monthName} ${year}
        </div>
      </div>
    </div>
  `;
}

// =========================================================
// Initialize App
// =========================================================
document.addEventListener('DOMContentLoaded', () => {
  init();
  
  // Configurar eventos de export scope
  document.addEventListener('change', (e) => {
    if(e.target && e.target.name === 'exportScope') {
      const v = document.querySelector('input[name="exportScope"]:checked')?.value;
      const exportUsersBox = document.getElementById('exportUsersBox');
      if (exportUsersBox) {
        exportUsersBox.classList.toggle('hidden', v !== 'select');
      }
    }
  });
});
</script>


<!-- Men√∫ acciones de d√≠a (copiar/pegar) -->
<div id="dayActionsMenu" class="fixed z-[9999] hidden">
  <div class="bg-white/95 backdrop-blur-md border border-black/10 rounded-2xl shadow-2xl overflow-hidden min-w-[220px]">
    <div class="px-4 py-3 font-black text-[12px] uppercase tracking-widest text-gray-700 bg-gray-50 border-b border-black/5">Acciones</div>
    <button id="actCopyDay" class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold">üìã Copiar d√≠a</button>
    <button id="actCopyShift" class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold">üìå Copiar turno</button>
    <button id="actPaste" class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold">üì• Pegar</button>
    <button id="actPasteMode" class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold">üñ±Ô∏è Modo pegar: OFF</button>
    <button id="actClear" class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold text-red-600">üßπ Limpiar portapapeles</button>
  </div>
</div>

</body>
</html>

<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>B√∫squeda por Ubicaci√≥n</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #d4eec9;
        margin: 0;
        padding: 0;
      }
      header {
        background: #d4eec9;
        color: #1d522f;
        padding: 1rem;
        text-align: center;
      }
      main {
        padding: 1rem;
      }
      #map {
        height: 500px;
        margin-top: 1rem;
      }
      input[type="text"], input[type="number"] {
        padding: 0.6rem 1rem;
        margin: 0.5rem;
        border: 2px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        width: calc(100% - 2rem);
        max-width: 400px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .boton-principal {
        display: inline-block;
        font-weight: 600;
        font-size: 1rem;
        padding: 0.8rem 1.2rem;
        margin: 0.5rem 0.5rem 1rem;
        text-decoration: none;
        border-radius: 10px;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        border: 2px solid transparent;
      }
      .boton-principal:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }
      .contrato-btn { background: #fff; border-color: #1a56db; color: #1a56db; }
      .placa-btn { background: #fff; border-color: #19703a; color: #19703a; }
      .ubicacion-btn { background: #1a56db; border-color: #1a56db; color: #fff; }
      .limpiar-btn { background: #ffffff; border-color: #ccc; color: #444; }
      .volver-btn {
        display: inline-block;
        margin-bottom: 1rem;
        padding: 0.8rem 1.2rem;
        background: #19703a;
        color: #fff;
        text-decoration: none;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      }
      .volver-btn:hover {
        background: #145d30;
        transform: translateY(-1px);
      }
      .acciones {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
    
.grupo-busqueda {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.5rem;
  margin: 1rem auto;
  max-width: 960px;
}

.grupo-busqueda input[type="number"],
.grupo-busqueda button {
  flex: 1 1 180px;
  max-width: 200px;
}

#tabla-cercanos {
  display: flex;
  justify-content: center;
  padding: 1rem;
}

#tabla-cercanos table {
  width: auto;
  max-width: 95%;
  font-size: 0.95rem;
}

.grupo-volver-limpiar {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin: 1rem auto;
}

@media screen and (max-width: 600px) {
  #tabla-cercanos table {
    font-size: 0.85rem;
    width: 100%;
    border: 1px solid #999;
  }

  #tabla-cercanos table th,
  #tabla-cercanos table td {
    padding: 6px 8px;
    border: 1px solid #999;
    text-align: left;
    word-break: break-word;
  }

  #tabla-cercanos {
    overflow-x: auto;
    padding: 0 0.5rem;
  }
}

#tabla-cercanos table {
  font-family: 'Segoe UI', sans-serif;
  border-collapse: collapse;
  margin: auto;
  width: 90%;
  font-size: 0.95rem;
  text-align: left;
  border: 1px solid #999;
}

#tabla-cercanos table th,
#tabla-cercanos table td {
  padding: 8px 10px;
  border: 1px solid #999;
  word-break: break-word;
}

#tabla-cercanos table th,
#tabla-cercanos table td {
  white-space: nowrap;
  min-width: 120px;
  max-width: 250px;
  padding: 6px 10px;
  vertical-align: middle;
}

@media screen and (max-width: 600px) {
  #tabla-cercanos table {
    font-size: 0.75rem;
    width: 98%;
    border: 1px solid #999;
  }

  #tabla-cercanos table th,
  #tabla-cercanos table td {
    padding: 4px 6px;
    border: 1px solid #999;
    text-align: left;
    white-space: nowrap;
    word-break: normal;
    min-width: auto;
  }

  #tabla-cercanos {
    overflow-x: auto;
    padding: 0;
  }
}
</style>
</head>
<body>
<div style="background:#d4eec9;text-align:center;"><img alt="DELSUR MAPS" src="logo.png" style="height:80px;margin:1rem auto;"/></div>
<header>
<h1>B√∫squeda por Ubicaci√≥n</h1>
</header>
<main>
<div class="grupo-busqueda"><input id="lat" placeholder="Latitud" step="any" type="number"/><input id="lon" placeholder="Longitud" step="any" type="number"/><button class="boton-principal ubicacion-btn" onclick="usarUbicacion()">üìç Usar mi ubicaci√≥n actual</button><button class="boton-principal ubicacion-btn" onclick="buscarCercanos()">üîé Buscar cercanos</button></div><div class="grupo-volver-limpiar"><a class="volver-btn" href="index.html">‚¨Ö Volver al inicio</a><button class="boton-principal limpiar-btn" onclick="limpiar()">üßπ Limpiar</button></div>
<div class="result" id="tabla-cercanos" style="overflow-x:auto;margin-top:1rem;"></div>
<div id="map"></div>
</main>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><script>
let map = L.map('map').setView([13.7, -89.2], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
let markerLayer = L.layerGroup().addTo(map);

let datos = [];

async function cargarDatos() {
  const response = await fetch('data.xlsx');
  const data = await response.arrayBuffer();
  const workbook = XLSX.read(data);
  const hoja = XLSX.utils.sheet_to_json(workbook.Sheets['Placas']);
  datos = hoja.map(row => ({
    clave: (row['REFERENCIA'] || row['Contrato']).toString().trim(),
    nombre: row['Referencia'] || row['REFERENCIA'],
    lat: row['Latitud'],
    lon: row['Longitud'] || row['Longuitud'],
    alimentador: row['Alimentador'] || 'N/D'
  }));
}

function usarUbicacion() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      document.getElementById("lat").value = lat;
      document.getElementById("lon").value = lon;

      const userMarker = L.marker([lat, lon], {
        icon: L.icon({
          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',
          iconSize: [30, 30],
          iconAnchor: [15, 30]
        })
      }).addTo(markerLayer).bindPopup("Tu ubicaci√≥n").openPopup();

      map.setView([lat, lon], 14);
      buscarCercanos();
    }, () => {
      alert("No se pudo obtener tu ubicaci√≥n.");
    });
  } else {
    alert("Tu navegador no soporta geolocalizaci√≥n.");
  }
}

function buscarCercanos() {
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  if (isNaN(lat) || isNaN(lon)) return alert("Ingrese coordenadas v√°lidas.");
  markerLayer.clearLayers();

  const userMarker = L.marker([lat, lon], {
    icon: L.icon({
      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    })
  }).addTo(markerLayer).bindPopup("Tu ubicaci√≥n").openPopup();

  datos.forEach(p => {
    p.distancia = Math.sqrt((p.lat - lat) ** 2 + (p.lon - lon) ** 2);
  });

  const cercanos = datos.sort((a, b) => a.distancia - b.distancia).slice(0, 10);
  mostrarTablaCercanos(cercanos, lat, lon);

  cercanos.forEach(p => {
    const gmaps = `https://www.google.com/maps?q=${p.lat},${p.lon}`;
    const waze = `https://waze.com/ul?ll=${p.lat},${p.lon}&navigate=yes`;
    const popup = `<b>${p.nombre}</b><br>${p.lat}, ${p.lon}<br>${p.alimentador}<br>
      <a href='${gmaps}' target='_blank'>üìçGoogle Maps</a> | 
      <a href='${waze}' target='_blank'>üöóWaze</a>`;
    L.marker([p.lat, p.lon]).addTo(markerLayer).bindPopup(popup);
  });
}

function mostrarTablaCercanos(cercanos, lat, lon) {
  let tablaHTML = `<div style='text-align:center;'>
    <h3 style='margin-bottom:1rem;'>10 elementos m√°s cercanos al punto ingresado</h3>
    <table border='1' cellpadding='10' style='border-collapse:collapse; margin:auto; width:90%; font-size:1rem; text-align:left;'>
      <thead><tr><th>Elemento</th><th>Alimentador</th><th>Distancia(m)</th><th>Rutas</th></tr></thead>
      <tbody>`;
  cercanos.forEach(p => {
    const distanciaM = (p.distancia * 111139).toFixed(1);
    const gmaps = `https://www.google.com/maps?q=${p.lat},${p.lon}`;
    const waze = `https://waze.com/ul?ll=${p.lat},${p.lon}&navigate=yes`;
    const links = `<a href='${gmaps}' target='_blank'>Maps</a> | <a href='${waze}' target='_blank'>Waze</a>`;
    tablaHTML += `<tr><td>${p.nombre}</td><td>${p.alimentador}</td><td>${distanciaM}</td><td>${links}</td></tr>`;
  });
  tablaHTML += "</tbody></table></div>";
  document.getElementById("tabla-cercanos").innerHTML = tablaHTML;
}

function limpiar() {
  document.getElementById('lat').value = '';
  document.getElementById('lon').value = '';
  document.getElementById('tabla-cercanos').innerHTML = '';
  if (typeof markerLayer !== 'undefined') {
    markerLayer.clearLayers();
  }
}

cargarDatos();
</script></body>
</html>
